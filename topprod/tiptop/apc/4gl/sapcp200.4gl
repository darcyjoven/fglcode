# Prog. Version..: '5.30.06-13.04.17(00010)'     #
#
# Pattern name...: sapcp200.4gl
# Descriptions...: POS上傳批處理作業
# Date & Author..: No.FUN-C50090 12/05/23 By baogc 
# Modify.........: No.FUN-C80051 12/08/13 By baogc 預設值調整
# Modify.........: No:FUN-C80045 12/08/16 By nanbing 增加ryz10控管
# Modify.........: No:FUN-C80080 12/08/23 By baogc 發票邏輯修改
# Modify.........: No:FUN-C80079 12/08/23 By baogc 券付款時,若該券未核銷則做核銷處理
# Modify.........: No:FUN-C90011 12/09/05 By baogc 訂單中預定交貨日和排定交貨日給值
# Modify.........: No:TQC-C90016 12/09/06 By yangxf 如果类型为券才给券号赋值，否者为null
# Modify.........: No:FUN-C90065 12/09/18 By baogc 邏輯調整
# Modify.........: No:FUN-CA0091 12/10/31 By baogc 效能優化
# Modify.........: No:FUN-CA0160 12/11/07 By baogc 添加卡、券上傳邏輯
# Modify.........: No:FUN-CB0025 12/11/08 By shiwuying 冲预收分摊到其他付款方式里面,rxy33=Y
# Modify.........: No:FUN-CB0103 12/11/22 By baogc POS上傳邏輯調整
# Modify.........: No:FUN-CC0082 12/12/14 By baogc 添加異店取貨邏輯
# Modify.........: No:FUN-D10023 13/01/05 By baogc 前置(訂單/出貨單)不存在時報錯
# Modify.........: No:FUN-D10060 13/01/16 By xumm 增加发送邮件功能
# Modify.........: No:FUN-D10040 13/01/18 By xumm 添加折扣券逻辑
# Modify.........: No:FUN-D10144 13/02/28 By baogc 單據日期調整
# Modify.........: No:FUN-D20096 13/02/28 By xumm 卡券稅邏輯調整
# Modify.........: No:FUN-D30061 13/03/19 By baogc POS上傳自動編號邏輯調整
# Modify.........: No:TQC-D30070 13/03/27 By pauline 資料整批上傳時,相關的單據編號抓取錯誤
# Modify.........: No:FUN-D30097 13/04/01 By Sakura 訂金退回單據優化

DATABASE ds

GLOBALS "../../config/top.global"
GLOBALS "../4gl/sapcp200.global"

DEFINE g_posdbs     LIKE ryg_file.ryg00
DEFINE g_posdbs_t   LIKE ryg_file.ryg00
DEFINE g_db_links   LIKE ryg_file.ryg02
DEFINE g_db_links_t LIKE ryg_file.ryg02
DEFINE g_sql        STRING
DEFINE g_wc         STRING
DEFINE g_ryy        RECORD LIKE ryy_file.*
DEFINE g_time       LIKE type_file.chr8    #TIME   
DEFINE g_trans_date LIKE type_file.chr8    #TIME   
DEFINE g_sucflag    LIKE type_file.num5    #整体有具體數據傳輸成功標志位
DEFINE l_sucflag    LIKE type_file.num5    #当前有具體數據傳輸成功標志位
DEFINE g_psell_way  LIKE ryz_file.ryz02    #POS銷售上傳方式 1-匯總 2-明細
DEFINE g_posstr     LIKE gat_file.gat01    #表名
DEFINE g_up_no      STRING                 #指定單號
DEFINE g_saleno     LIKE oga_file.oga01    #銷售單上傳時,若訂單單號欄位不為空，賦值于此  
DEFINE l_legal      LIKE oea_file.oealegal
DEFINE g_forupd_sql STRING
DEFINE g_flag       LIKE type_file.chr1
DEFINE g_pid        LIKE gbq_file.gbq01
DEFINE g_lockflag   LIKE type_file.chr1    #是否已经开启
DEFINE g_ndate      LIKE oea_file.oea02    #取單日期
DEFINE g_vip        LIKE type_file.chr1    #判斷是否會員
DEFINE g_oga16_set  LIKE oga_file.oga16
DEFINE g_rtz06      LIKE rtz_file.rtz06
DEFINE g_rtz07      LIKE rtz_file.rtz07
DEFINE g_sum_limit  LIKE type_file.num10 #FUN-CA0091 Add
DEFINE g_ryz03      LIKE ryz_file.ryz03  #FUN-CA0091 Add
DEFINE g_ryz04      LIKE ryz_file.ryz04  #FUN-CA0091 Add
DEFINE g_ryz05      LIKE ryz_file.ryz05  #FUN-CA0091 Add
DEFINE g_ryz06      LIKE ryz_file.ryz06  #FUN-CA0091 Add
DEFINE g_ryz07      LIKE ryz_file.ryz07  #FUN-CA0091 Add
DEFINE g_ryz09      LIKE ryz_file.ryz09  #FUN-CA0091 Add
DEFINE g_ryz10      LIKE ryz_file.ryz10  #FUN-CA0091 Add
DEFINE g_rcj05      LIKE rcj_file.rcj05  #FUN-CA0160 Add
DEFINE g_rcj06      LIKE rcj_file.rcj06  #FUN-CA0160 Add
DEFINE g_rcj07      LIKE rcj_file.rcj07  #FUN-CA0160 Add
DEFINE g_rcj08      LIKE rcj_file.rcj08  #FUN-CA0160 Add
DEFINE g_rcj12      LIKE rcj_file.rcj12  #FUN-CC0082 Add
DEFINE g_azi03      LIKE azi_file.azi03  #FUN-CC0082 Add
DEFINE g_azi04      LIKE azi_file.azi04  #FUN-CB0103 Add
#FUN-CC0082 Add Begin ---
DEFINE g_oga        RECORD LIKE oga_file.*
DEFINE g_ogb        DYNAMIC ARRAY OF RECORD LIKE ogb_file.*
DEFINE g_rvu        RECORD LIKE rvu_file.*
DEFINE g_rvv        DYNAMIC ARRAY OF RECORD LIKE rvv_file.*
#FUN-CC0082 Add End -----

FUNCTION p200(p_posstr,p_plantstr,p_posdbs,p_no,p_transnum)
DEFINE p_posstr     STRING               #指定傳輸的table
DEFINE p_plantstr   STRING               #指定機構
DEFINE p_posdbs     LIKE ryg_file.ryg00  #指定傳輸DB
DEFINE p_no         STRING               #指定單號
DEFINE p_transnum   LIKE type_file.num10 #上傳整批提交筆數 #FUN-CA0091 Add
DEFINE tok          base.StringTokenizer
DEFINE tok1         base.StringTokenizer
DEFINE tok2         base.StringTokenizer #FUN-CC0082 Add
DEFINE tok3         base.StringTokenizer #FUN-CC0082 Add
DEFINE l_sql        STRING
DEFINE l_azw01      LIKE azw_file.azw01
DEFINE l_n          LIKE type_file.num5
DEFINE l_n1         LIKE type_file.num5  #FUN-D10060 add
DEFINE l_ch_pipe    base.Channel
DEFINE l_ch_cmd     STRING
##Add By baogc Begin --- #FUN-C80045 
DEFINE l_gbq01      LIKE gbq_file.gbq01
DEFINE l_gbq10      LIKE gbq_file.gbq10
DEFINE l_count      LIKE type_file.num5
DEFINE l_pid        STRING
DEFINE l_g_plant    LIKE type_file.chr20
DEFINE lch_cmd      base.Channel
DEFINE ls_cmd       STRING
DEFINE ls_result    STRING
DEFINE ls_token     STRING
DEFINE lst_token    base.StringTokenizer
DEFINE li_i         LIKE type_file.num10
##Add By baogc End -----#FUN-C80045 
#DEFINE g_ryz10      LIKE ryz_file.ryz10   #FUN-C80045 add #FUN-CA0091 Mark
DEFINE l_plant      LIKE azw_file.azw01   #記錄當前上傳所用營運中心 #FUN-C80045 Add

   WHENEVER ERROR CONTINUE

   LET g_flag = ''
   LET g_up_no = p_no
   LET g_trans_date = YEAR(g_today) USING "&&&&",MONTH(g_today) USING "&&",DAY(g_today) USING "&&"
   LET g_saleno = ''

   SELECT DISTINCT ryz02 INTO g_psell_way FROM ryz_file
   IF cl_null(g_psell_way) THEN LET g_psell_way = '2' END IF  #暫定為空時賦值為:2-明細
  #FUN-CA0091 Mark Begin ---
  ##FUN-C80045 add sta
  #SELECT ryz10 INTO g_ryz10 FROM ryz_file
  ##FUN-C80045 add end   
  #FUN-CA0091 Add End -----

  #FUN-CA0091 Add Begin ---
   #抓取POS参数中的设定
   SELECT ryz10,ryz09,ryz07,ryz03,ryz04,ryz05,ryz06 INTO g_ryz10,g_ryz09,g_ryz07,g_ryz03,g_ryz04,g_ryz05,g_ryz06 FROM ryz_file
   #抓取理由码参数                                                                   #FUN-CA0160 Add
   SELECT rcj05,rcj06,rcj07,rcj08,rcj12 INTO g_rcj05,g_rcj06,g_rcj07,g_rcj08,g_rcj12 FROM rcj_file #FUN-CA0160 Add #FUN-CC0082 Add rcj12
   #批量提交笔数
   IF NOT cl_null(p_transnum) AND p_transnum > 1 THEN
      LET g_sum_limit = p_transnum
   ELSE
      LET g_sum_limit = 1
   END IF
  #FUN-CA0091 Add End -----

   IF NOT cl_null(p_posdbs) THEN
      SELECT DISTINCT ryg00,ryg02 INTO g_posdbs_t,g_db_links_t FROM ryg_file WHERE ryg00 = p_posdbs 
   ELSE
      SELECT DISTINCT ryg00,ryg02 INTO g_posdbs_t,g_db_links_t FROM ryg_file  #未來如果有多筆傳輸DB可用FOREACH循環
   END IF
   LET g_posdbs = s_dbstring(g_posdbs_t)
   LET g_db_links = p200_dblinks(g_db_links_t)
  #LET g_posstr = p_posstr
   
  #CALL s_showmsg_init()  #FUN-CB0103 Mark
   LET g_trans_no = p200_trans_no()
   LET g_ryy.ryy02 = g_today
   LET g_time = TIME
   LET g_ryy.ryy03 = TIME
   LET g_success = 'Y'
   LET g_sucflag = 0 
   LET g_pid = FGL_GETPID()
   IF g_ryz10 = 'N' THEN  #FUN-C80045 add
      #判斷進程 begin
      LET l_n = 0
      LET l_ch_cmd = "ps -ef | grep 'apcp200'| grep fglrun-bin | grep -v ",g_pid," | grep -v r.d2+ | grep 42r | grep -v fgldeb | grep -v p_cron | wc -l "
      LET l_ch_pipe = base.Channel.create()
      CALL l_ch_pipe.openPipe(l_ch_cmd,"r")
      WHILE l_ch_pipe.read(l_n)
      END WHILE
      CALL l_ch_pipe.close()
      IF l_n=0 THEN  #沒有進程在跑
        #CALL p200_uplock('4')
        #CALL p200_uplock('1')
      ELSE           #有進程在跑
         IF g_bgjob='N' THEN
            CALL cl_err('','-263',1)
         END IF
         CALL cl_used(g_prog,g_time,2) RETURNING g_time
         EXIT PROGRAM
      END IF
      #判斷進程 end
   #FUN-C80045 add sta
   ELSE
      #多進程處理 - Begin --- Add By baogc
      LET ls_cmd = "COLUMNS=132;export COLUMNS; ps -ef | grep 'apcp200'| grep fglrun-bin | grep -v r.d2+ | grep -v fgldeb | grep -v export | grep 42r | grep -v p_cron "
      LET lch_cmd = base.Channel.create()
      LET l_count = 0
      CALL lch_cmd.openPipe(ls_cmd, "r")
      WHILE lch_cmd.read(ls_result)
         LET lst_token = base.StringTokenizer.create(ls_result, ' ')
         LET li_i = 1
         WHILE lst_token.hasMoreTokens()
            LET ls_token = lst_token.nextToken()
            IF li_i = 2 THEN LET l_pid = ls_token END IF
            LET li_i = li_i + 1
         END WHILE
         LET l_gbq01 = l_pid
         LET l_g_plant = g_plant CLIPPED,'%' CLIPPED
         LET l_gbq10 = NULL
         SELECT gbq10 INTO l_gbq10 FROM gbq_file
          WHERE gbq01 = l_gbq01 AND gbq10 LIKE l_g_plant
         IF l_gbq10 IS NOT NULL THEN
            LET l_count = l_count + 1
         END IF
      END WHILE
      CALL lch_cmd.close()
      IF l_count>=2 THEN
         IF g_bgjob='N' THEN
            CALL cl_err('','-263',1)
         END IF
         CALL cl_used(g_prog,g_time,2) RETURNING g_time
         EXIT PROGRAM
      END IF
      #多進程處理 - End -----
   END IF
   #FUN-C80045 add end
  #LET g_sql = " SELECT sta FROM ",g_posdbs,"possae",g_db_links," WHERE filename ='UP' " 
  #PREPARE sel_lock_pre FROM g_sql
  #EXECUTE sel_lock_pre INTO g_lockflag
  #IF SQLCA.sqlcode = 100 THEN
  #   LET g_lockflag = 'N'
  #   CALL p200_uplock('1')
  #ELSE
  #   IF g_lockflag = 'Y' THEN
  #      CALL cl_err('possae','-263',1)
  #      CALL cl_used(g_prog,g_time,2) RETURNING g_time
  #      EXIT PROGRAM
  #   ELSE
  #      CALL p200_uplock('2')
  #   END IF
  #END IF
  #LET g_forupd_sql = "SELECT sta FROM ",g_posdbs,"possae",g_db_links," WHERE filename = 'UP' FOR UPDATE"
  #LET g_forupd_sql = cl_forupd_sql(g_forupd_sql)
  #DECLARE downlock_curs CURSOR FROM g_forupd_sql

   LET l_plant = g_plant  #FUN-C80045 Add
   LET tok = base.StringTokenizer.create(p_plantstr,"|")   
   LET l_azw01 = '' 
   WHILE tok.hasMoreTokens()
      LET l_azw01 = tok.nextToken()
      #FUN-C80045 add sta
      IF g_ryz10 = 'Y' THEN
         LET l_count = 0
         SELECT count(*) INTO l_count FROM ryg_file 
          WHERE ryg01 = l_azw01 
            AND ryg03 = l_plant
            AND rygacti = 'Y'  
         IF l_count = 0 THEN
            CONTINUE WHILE
         END IF
      END IF
      #FUN-C80045 add end  
      LET g_plant_new = l_azw01
      CALL s_gettrandbs()
      LET g_dbs=g_dbs_tra
      CALL s_getlegal(l_azw01) RETURNING l_legal
      
      CALL p200_chk_database(l_azw01) #切庫

     #FUN-CB0103 Add Begin ---
      SELECT azi03,azi04 INTO g_azi03,g_azi04  #FUN-CC0082 Mod
        FROM azi_file WHERE azi01 = (SELECT occ42 FROM occ_file WHERE occ01 = (SELECT rtz06 FROM rtz_file WHERE rtz01 = l_azw01)) #FUN-CC0082 Add
      IF cl_null(g_azi03) THEN LET g_azi03 = '2' END IF #FUN-CC0082 Add
      IF cl_null(g_azi04) THEN LET g_azi04 = '2' END IF
     #FUN-CB0103 Add End -----

      LET l_sql = "SELECT rtz06,rtz07 FROM ",cl_get_target_table(l_azw01,'rtz_file'),
                  " WHERE rtz01 = '",l_azw01,"' "
      CALL cl_replace_sqldb(l_sql) RETURNING l_sql
      CALL cl_parse_qry_sql(l_sql,l_azw01) RETURNING l_sql
      PREPARE sel_rtz06_pre FROM l_sql
      EXECUTE sel_rtz06_pre INTO g_rtz06,g_rtz07

      LET g_success ='Y'

      LET tok1 = base.StringTokenizer.create(p_posstr,"|")
      LET g_posstr = ''
      WHILE tok1.hasMoreTokens()
         LET g_posstr = tok1.nextToken()

         CASE g_posstr         #DB_TABLE_NAME
            WHEN "oea_file"    #訂單
                 IF g_bgjob = "N" THEN
                    MESSAGE "UP OEA_FILE"            
                    CALL ui.Interface.refresh()
                 END IF
                #FUN-CA0091 Add Begin ---
                 IF NOT cl_null(g_sum_limit) AND g_sum_limit > 1 THEN
                    CALL p200_oea_p_ins('oea_file',l_azw01) #批量操作
                 ELSE
                #FUN-CA0091 Add End -----
                    CALL p200_oea_ins('oea_file',l_azw01)
                 END IF #FUN-CA0091 Add
   
            WHEN "oga_file"    #銷售單
                 IF g_bgjob = "N" THEN
                    MESSAGE "UP OGA_FILE"      
                    CALL ui.Interface.refresh()      
                 END IF
                 IF g_psell_way='1' THEN
                   #CALL p200_oga_s_ins('oga_file',l_azw01)
                 ELSE 
                   #FUN-CA0091 Add Begin ---
                    IF NOT cl_null(g_sum_limit) AND g_sum_limit > 1 THEN
                       CALL p200_oga_p_ins("oga_file",l_azw01)
                       CALL p200_oga_d_ins('oga_file',l_azw01,'2') #FUN-CC0082 Add
                    ELSE
                   #FUN-CA0091 Add End -----
                      #CALL p200_oga_d_ins('oga_file',l_azw01)     #FUN-CC0082 Mark
                       CALL p200_oga_d_ins('oga_file',l_azw01,'1') #FUN-CC0082 Add
                    END IF #FUN-CA0091 Add
                 END IF
   
            WHEN "rxa_file"    #訂金退回 
                 IF g_bgjob = "N" THEN
                    MESSAGE "UP RXA_FILE"      
                    CALL ui.Interface.refresh()      
                 END IF

                #FUN-CA0091 Add Begin ---
                 IF NOT cl_null(g_sum_limit) AND g_sum_limit > 1 THEN
                    CALL p200_rxa_p_ins('rxa_file',l_azw01)
                 ELSE
                #FUN-CA0091 Add End -----
                    CALL p200_rxa_ins('rxa_file',l_azw01)
                 END IF #FUN-CA0091 Add

            WHEN "oha_file"    #銷售退貨單
                 IF g_bgjob = "N" THEN
                    MESSAGE "UP OHA_FILE"
                    CALL ui.Interface.refresh()
                 END IF
                 IF g_psell_way='1' THEN
                   #CALL p200_oha_s_ins('oha_file',l_azw01)
                 ELSE 
                   #FUN-CA0091 Add Begin ---
                    IF NOT cl_null(g_sum_limit) AND g_sum_limit > 1 THEN
                       CALL p200_oha_p_ins('oha_file',l_azw01)
                    ELSE
                   #FUN-CA0091 Add End -----
                       CALL p200_oha_d_ins('oha_file',l_azw01)
                    END IF #FUN-CA0091 Add
                 END IF

            #WHEN "ryv_file"    #公告欄
            #     IF g_bgjob = "N" THEN
            #        MESSAGE "UP RYV_FILE"            
            #     END IF
            #     CALL p200_ryv_ins('ryv_file',l_azw01)

             WHEN "ome_file"   #日結檔
                 IF g_bgjob = "N" THEN 
                    MESSAGE "UP OME_FILE"            
                    CALL ui.Interface.refresh()
                 END IF
                 CALL p200_ome_ins('ome_file',l_azw01)
           
            #FUN-CA0160 Add Begin ---
             WHEN "lps_file"   #髮卡
                 IF g_bgjob = "N" THEN 
                    MESSAGE "UP LPS_FILE"            
                    CALL ui.Interface.refresh()
                 END IF
                 CALL p200_lps_ins_p('lps_file',l_azw01)

             WHEN "lpv_file"   #退卡
                 IF g_bgjob = "N" THEN 
                    MESSAGE "UP LPV_FILE"            
                    CALL ui.Interface.refresh()
                 END IF
                 CALL p200_lpv_ins_p('lpv_file',l_azw01)
                 CALL p200_lru_ins_p('lru_file',l_azw01)

             WHEN "lpu_file"   #卡儲值
                 IF g_bgjob = "N" THEN 
                    MESSAGE "UP LPU_FILE"            
                    CALL ui.Interface.refresh()
                 END IF
                 CALL p200_lpu_ins_p('lpu_file',l_azw01)

             WHEN "lrw_file"   #換卡
                 IF g_bgjob = "N" THEN 
                    MESSAGE "UP LRW_FILE"            
                    CALL ui.Interface.refresh()
                 END IF
                 CALL p200_lrw_ins_p('lrw_file',l_azw01)

             WHEN "rxe_file_2"   #售券
                 IF g_bgjob = "N" THEN 
                    MESSAGE "UP RXE_FILE"            
                    CALL ui.Interface.refresh()
                 END IF
                 CALL p200_rxe_ins_p_oga('rxe_file_2',l_azw01)

             WHEN "rxe_file_3"   #退券
                 IF g_bgjob = "N" THEN 
                    MESSAGE "UP RXE_FILE"            
                    CALL ui.Interface.refresh()
                 END IF
                 CALL p200_rxe_ins_p_oha('rxe_file_3',l_azw01)
            #FUN-CA0160 Add End -----

         END CASE
      END WHILE
   END WHILE

   #FUN-CC0082 Add Begin ---
   #异店取货销售归属1.订货门店,则产生代收单据与代管库存
   IF g_rcj12 = '1' THEN
      LET tok2 = base.StringTokenizer.create(p_plantstr,"|")
      LET l_azw01 = ''
      WHILE tok2.hasMoreTokens()
         LET l_azw01 = tok2.nextToken()
         IF g_ryz10 = 'Y' THEN
            LET l_count = 0
            SELECT count(*) INTO l_count FROM ryg_file
             WHERE ryg01 = l_azw01
               AND ryg03 = l_plant
               AND rygacti = 'Y'
            IF l_count = 0 THEN
               CONTINUE WHILE
            END IF
         END IF
         LET g_plant_new = l_azw01
         CALL s_gettrandbs()
         LET g_dbs=g_dbs_tra
         CALL s_getlegal(l_azw01) RETURNING l_legal
         
         CALL p200_chk_database(l_azw01) #切庫

         SELECT azi03,azi04 INTO g_azi03,g_azi04 FROM azi_file WHERE azi01 = (SELECT occ42 FROM occ_file WHERE occ01 = (SELECT rtz06 FROM rtz_file WHERE rtz01 = l_azw01))
         IF cl_null(g_azi03) THEN LET g_azi03 = '2' END IF
         IF cl_null(g_azi04) THEN LET g_azi04 = '2' END IF
         
         LET l_sql = "SELECT rtz06,rtz07 FROM ",cl_get_target_table(l_azw01,'rtz_file'),
                     " WHERE rtz01 = '",l_azw01,"' "
         CALL cl_replace_sqldb(l_sql) RETURNING l_sql
         CALL cl_parse_qry_sql(l_sql,l_azw01) RETURNING l_sql
         PREPARE sel_rtz06_pre2 FROM l_sql
         EXECUTE sel_rtz06_pre2 INTO g_rtz06,g_rtz07
   
         LET g_success ='Y'
         
         LET tok3 = base.StringTokenizer.create(p_posstr,"|")
         LET g_posstr = ''
         WHILE tok3.hasMoreTokens()
            LET g_posstr = tok3.nextToken()
            CASE g_posstr
               WHEN "oga_file"
                  IF g_bgjob = "N" THEN
                     MESSAGE "UP RXF_FILE"
                     CALL ui.Interface.refresh()
                  END IF
                  CALL p200_ins_rxf_oga(l_azw01)
              #WHEN "oha_file"
              #   IF g_bgjob = "N" THEN
              #      MESSAGE "UP RXF_FILE"
              #      CALL ui.Interface.refresh()
              #   END IF
              #   CALL p200_ins_rxf_oha(l_azw01)
            END CASE
         END WHILE
      END WHILE
   END IF     
   #FUN-CC0082 Add End -----
   
  #CALL p200_uplock('3')
   LET g_ryy.ryy04 = g_today
   LET g_ryy.ryy05 = TIME
   IF g_sucflag  > 0 THEN
      INSERT INTO ryy_file VALUES (g_ryy.*)
      IF SQLCA.sqlcode THEN
         LET g_success='N'
         LET g_errno=SQLCA.sqlcode
         CALL s_errmsg('ryy01',g_ryy.ryy01,'INS ryy_file',SQLCA.sqlcode,1)
         RETURN
      END IF
   END IF
  #IF g_success = 'N' THEN
  #    CALL s_showmsg()
  #END IF
   IF g_flag = 'Y' THEN
      CALL cl_err('','apc-143',1)
   END IF
   #FUN-D10060------add---str
   LET l_n1 = 0
   SELECT COUNT(*) INTO l_n1 FROM ryl_file WHERE ryl01 = g_trans_no
   IF l_n1 > 0 THEN
      CALL s_send_mail(g_prog,g_trans_no)
   END IF
   #FUN-D10060------add---end
   CALL p200_chk_database(l_plant) #切庫 - 切回原營運中心的庫 #FUN-C80045 Add
END FUNCTION

FUNCTION p200_uplock(p_flag)
DEFINE p_flag    LIKE type_file.chr1
DEFINE l_time    LIKE type_file.chr18

   LET l_time=CURRENT YEAR TO SECOND

   CASE p_flag
      WHEN '1'
       LET g_sql = " INSERT INTO ",g_posdbs,"possae",g_db_links,"(filename,ftime,pid,sta)", 
                   " VALUES ('UP','",l_time,"','",g_pid,"','N')  "
      WHEN '2'
       LET g_sql = " UPDATE ",g_posdbs,"possae",g_db_links," SET sta = 'Y',ftime ='",l_time,"',pid ='",g_pid,"' ",
                   " WHERE filename = 'UP' "
      WHEN '3'
       LET g_sql = " UPDATE ",g_posdbs,"possae",g_db_links," SET sta = 'N',ftime ='",l_time,"',pid ='",g_pid,"' ",
                   " WHERE filename = 'UP' "
      WHEN '4'
       LET g_sql = " DELETE FROM ",g_posdbs,"possae",g_db_links," ",
                   " WHERE filename = 'UP' "
   END CASE

   TRY
   PREPARE downlock_pre FROM g_sql
   EXECUTE downlock_pre
   CATCH
      IF SQLCA.sqlcode THEN
         LET g_success='N'
         CALL s_errmsg('sta',"possae",'',SQLCA.sqlcode,1)
      END IF
      IF g_bgjob = "N" THEN
         MESSAGE "failure to UPload"
         CALL ui.Interface.refresh()
      END IF 
      RETURN
   END TRY

END FUNCTION

FUNCTION p200_oea_ins(p_gat01,p_azw01)       
DEFINE l_sql    STRING
DEFINE l_ins    STRING
DEFINE l_sel    STRING
DEFINE l_saleno LIKE oga_file.oga16
DEFINE l_item   LIKE type_file.chr5
DEFINE p_azw01  LIKE azw_file.azw01
DEFINE l_rye03  LIKE rye_file.rye03
DEFINE p_gat01  LIKE gat_file.gat01
DEFINE l_oea    RECORD   LIKE  oea_file.*
DEFINE l_oeb    RECORD   LIKE  oeb_file.*
DEFINE l_oeg    RECORD   LIKE  oeg_file.*  
DEFINE l_oeaa   RECORD   LIKE  oeaa_file.*
DEFINE l_getflg LIKE type_file.chr1
DEFINE l_oas    RECORD   LIKE  oas_file.*
DEFINE l_count  LIKE type_file.num5
DEFINE t_azi04  LIKE azi_file.azi04
DEFINE l_ima25  LIKE ima_file.ima25
DEFINE l_flag1  LIKE type_file.chr1
DEFINE l_rty05  LIKE rty_file.rty05
DEFINE l_rtt01  LIKE rtt_file.rtt01
DEFINE l_rtt11  LIKE rtt_file.rtt11
DEFINE l_rtv12  LIKE rtv_file.rtv12
DEFINE l_rtu01  LIKE rtu_file.rtu01
DEFINE l_oap041 LIKE oap_file.oap041
  
   LET g_time = TIME
   IF NOT cl_null(g_saleno) THEN 
      LET g_wc = " saleno = '",g_saleno,"' "
   ELSE
     #CALL p200_g_wc() RETURNING g_wc           #FUN-CA0160 Mark
      CALL p200_g_wc("oea_file") RETURNING g_wc #FUN-CA0160 Add
   END IF
   IF cl_null(g_wc) THEN LET g_wc = " 1=1" END IF

   LET l_sql = "SELECT DISTINCT ",
               " CAST(bdate AS DATE), ",                            #oea02    訂單日期
               " opno, ",                                           #oea14    人員編號
               " 100*pay_amt/tot_amt, ",                            #oea161   訂金應收比例
               " tot_uamt, ",                                       #oea61    訂單總未稅金額
               " CAST(sdate AS DATE), ",                            #oea72    確認日
               " opno, ",                                           #oeauser  資料所有者
               " tot_amt, ",                                        #oea1008  訂單總含稅金額
               " shop, ",                                           #oeaplant 所屬營運中心
               " shop, ",                                           #oea83    銷貨營運中心
               " getshop, ",                                        #oea84    取貨營運中心
               " cardno, ",                                         #oea87    會員卡號
               " contman, ",                                        #oea88    顧客姓名
               " conttel, ",                                        #oea89    聯繫電話
               " stime[1,2]||':'||stime[3,4]||':'||stime[5,6], ",   #oeacont  確認時間
               " opno, ",                                           #oeaconu  確認人員
               " opno, ",                                           #oeaoriu  資料建立者
               " CAST(sdate AS DATE), ",                            #oeadate  最近修改日
               " saleno, ",                                         #oea94    POS單號
               " NULL, ",                                           #oea95    生產門店   #FUN-CC0082 Add
               " pay_amt, ",                                        #oea261   訂金金額
               " tot_amt-pay_amt, ",                                #oea262   出貨金額
               " CAST(gdate AS DATE), ",                            #oeb15    約定交貨日 #FUN-C90011 Add
               " gtime[1,2]||':'||gtime[3,4]||':'||gtime[5,6], ",   #oeb51    交貨時間   #FUN-C90011 Add
               " shipadd ",                                         #oap041   地址
               "  FROM ",g_posdbs,"td_sale",g_db_links," ",
               " WHERE type = '3' ",       #抓取交易類型為3.訂單的資料
               "   AND shop = '",p_azw01,"' ",
              #"   AND condition2 = 'A' ", #抓取未上傳的數據  #FUN-CB0103 Mark
               "   AND condition2 <> 'Y' ", #抓取未上傳的數據 #FUN-CB0103 Add 
               "   AND ",g_wc," ",
               " ORDER BY saleno "
 
   PREPARE sel_td_sale_oea_pre FROM l_sql
   DECLARE sel_td_sale_oea_curs CURSOR WITH HOLD FOR sel_td_sale_oea_pre
   FOREACH sel_td_sale_oea_curs INTO 
               l_oea.oea02,                #訂單日期
               l_oea.oea14,                #人員編號
               l_oea.oea161,               #訂金應收比例
               l_oea.oea61,                #訂單總未稅金額
               l_oea.oea72,                #確認日
               l_oea.oeauser,              #資料所有者
               l_oea.oea1008,              #訂單總含稅金額
               l_oea.oeaplant,             #所屬營運中心
               l_oea.oea83,                #銷貨營運中心
               l_oea.oea84,                #取貨營運中心
               l_oea.oea87,                #會員卡號
               l_oea.oea88,                #顧客姓名
               l_oea.oea89,                #聯繫電話
               l_oea.oeacont,              #確認時間
               l_oea.oeaconu,              #確認人員
               l_oea.oeaoriu,              #資料建立者
               l_oea.oeadate,              #最近修改日
               l_oea.oea94,                #POS單號
               l_oea.oea95,                #生產門店  #FUN-CC0082 Add
               l_oea.oea261,               #訂金金額
               l_oea.oea262,               #出貨金額
               l_oeb.oeb15,                #約定交貨日 #FUN-C90011 Add
               l_oeb.oeb51,                #交貨時間   #FUN-C90011 Add
               l_oap041                    #地址
        
      LET g_success = 'Y' #成功標誌初始化
      IF SQLCA.sqlcode THEN
         LET g_success='N'
         LET g_errno = SQLCA.sqlcode
         LET g_showmsg = 'SEL TD_SALE'||' '||'SHOP:'||p_azw01||' '||'SALENO:'||l_oea.oea94
         CALL s_errmsg('oea94',l_oea.oea94,g_showmsg,SQLCA.sqlcode,1)
         LET g_msg1='TD_SALE'||'SEL'||p_azw01||l_oea.oea94 
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg=g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,l_oea.oea94,'01','TD_SALE',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno=''
         LET g_msg=''
         LET g_msg1=''
         LET g_showmsg = ''
         INITIALIZE l_oea.* TO NULL #FUN-C80051 Add
         INITIALIZE l_oeb.* TO NULL #FUN-C80051 Add
         CONTINUE FOREACH
      END IF

      LET l_oea.oea162  = 100 - l_oea.oea161 #出貨應收比率 = 100-訂金應收比例
      
      IF cl_null(l_oea.oea261) THEN
         LET l_oea.oea261 = 0
      END IF
         
      CALL p200_log_check(p_azw01,l_oea.oea94)

      BEGIN WORK 

      IF g_bgjob = "N" THEN
         MESSAGE "oea_file  SHOP:",p_azw01,"  SALENO:",l_oea.oea94,"  BEGIN:",TIME(CURRENT) 
         CALL ui.Interface.refresh()
      END IF

      LET l_sucflag = 0
      LET l_saleno  = l_oea.oea94   #POS單號
      LET g_fno1    = l_oea.oea94
      LET g_ndate   = l_oea.oea02
     #CALL p200_auto_doc(p_gat01,p_azw01) RETURNING l_oea.oea01       #FUN-CC0082 Mark
      CALL p200_auto_doc(p_gat01,p_azw01,'Y') RETURNING l_oea.oea01   #FUN-CC0082 Add
      IF g_success ='N' THEN      
         INITIALIZE l_oea.* TO NULL #FUN-C80051 Add
         INITIALIZE l_oeb.* TO NULL #FUN-C80051 Add
         CONTINUE FOREACH
      END IF
      
      #oea_file default 預設值 Begin --- #FUN-C80051 Add
      LET l_oea.oea00   = '1'                #類別
      LET l_oea.oea044  = 'MISC'             #送貨地址碼
      LET l_oea.oea05   = '1'                #發票別
      LET l_oea.oea06   = '0'                #修改版本
      LET l_oea.oea07   = 'N'                #出貨是否計入未開發票的銷貨
      LET l_oea.oea08   = '1'                #訂單性質
      LET l_oea.oea09   = '0'                #允許超交率
      LET l_oea.oea11   = '9'                #訂單來源
      LET l_oea.oea163  = 0                  #尾款應收比率
      LET l_oea.oea18   = 'N'                #是否採用訂單匯率立帳
      LET l_oea.oea37   = 'N'                #訂單分配否
      LET l_oea.oea49   = '1'                #狀況碼
      LET l_oea.oea62   = 0                  #已出貨未稅金額
      LET l_oea.oea63   = 0                  #被結案未稅金額
      LET l_oea.oea901  = 'N'                #多角貿易否
      LET l_oea.oea905  = 'N'                #多角貿易拋轉否
      LET l_oea.oea906  = 'N'                #多角貿易來源訂單否
      LET l_oea.oea909  = 'N'                #No use
      LET l_oea.oeamksg = 'N'                #是否簽核
      LET l_oea.oeadays = 0                  #簽核完成天數
      LET l_oea.oeaprit = 0                  #簽核優先等級
      LET l_oea.oeasseq = 0                  #已簽核順序
      LET l_oea.oeasmax = 0                  #應簽核順序
      LET l_oea.oeaconf = 'Y'                #確認否
      LET l_oea.oeaprsw = 0                  #訂單列印次數
      LET l_oea.oea1005 = 'N'                #是否計算業績
      LET l_oea.oea1012 = 'N'                #自提否
      LET l_oea.oea82   = 'N'                #借貨償價
      LET l_oea.oea917  = 'N'                #二維輸入
      LET l_oea.oea918  = 'N'                #订金立账分期
      LET l_oea.oea919  = 'N'                #尾款立账分期
      LET l_oea.oea263  = '0'                #尾款金額
      LET l_oea.oea85   = '1'                #結算方式
      LET l_oea.oea50   = 'N'                #是否作CSD展開
      LET l_oea.oea17   = g_rtz06            #
      LET l_oea.oeaslk02 = 'N'               #
      LET l_oea.oealegal = l_legal           #所屬法人
      #oea_file default 預設值 End ----- #FUN-C80051 Add

      IF NOT cl_null(l_oap041) THEN
         CALL p200_ins_oap(p_azw01,l_oea.oea01,l_oap041)
      END IF

      IF cl_null(l_oea.oea87) THEN
         LET l_oea.oea03 = l_oea.oea17
         LET g_vip = 'N'
      ELSE
         LET l_sql = "SELECT lpk02,lpk03,lpk20 FROM ",cl_get_target_table(p_azw01,'lpk_file'),",",
                                                      cl_get_target_table(p_azw01,'lpj_file'),
                     " WHERE lpk01 = lpj01 ",
                     "   AND lpj03 = '",l_oea.oea87,"' "
         CALL cl_replace_sqldb(l_sql) RETURNING l_sql
         CALL cl_parse_qry_sql(l_sql,p_azw01) RETURNING l_sql
         PREPARE sel_lpk_oea_pre FROM l_sql
         EXECUTE sel_lpk_oea_pre INTO l_oea.oea90,l_oea.oea91,l_oea.oea03
         LET g_vip = 'Y'
      END IF
      
      LET l_sql = "SELECT DISTINCT occ02,occ09,occ41,occ42,occ43, ",
                  "                occ44,occ45,occ46,occ47,occ48, ",
                  "                occ49,occ53,occ65,occ68,occ69  ",
                  "  FROM ",cl_get_target_table(p_azw01,'occ_file'),
                  " WHERE occ01 = '",l_oea.oea03,"' "
      CALL cl_replace_sqldb(l_sql) RETURNING l_sql                					
      CALL cl_parse_qry_sql(l_sql,p_azw01) RETURNING l_sql           
      PREPARE sel_occ_oea_pre FROM l_sql
      EXECUTE sel_occ_oea_pre INTO l_oea.oea032,l_oea.oea04,l_oea.oea21,l_oea.oea23,l_oea.oea25,
                                   l_oea.oea31,l_oea.oea32,l_oea.oea33,l_oea.oea43,l_oea.oea41,
                                   l_oea.oea42,l_oea.oea34,l_oea.oea65,l_oea.oea80,l_oea.oea81

      CALL s_currm(l_oea.oea23,l_oea.oea02,g_oaz.oaz52,p_azw01) RETURNING l_oea.oea24

      LET l_sql= "SELECT DISTINCT ryi02,ryi02,ryi02 FROM ",cl_get_target_table(p_azw01,'ryi_file'),
                 " WHERE ryi01='",l_oea.oeauser,"'"
      CALL cl_replace_sqldb(l_sql) RETURNING l_sql                  					
      CALL cl_parse_qry_sql(l_sql,p_azw01) RETURNING l_sql             
      PREPARE sel_ryi02_oea_pre7 FROM l_sql
      EXECUTE sel_ryi02_oea_pre7 INTO l_oea.oeauser,l_oea.oeaoriu,l_oea.oea14
      LET l_oea.oeaconu = l_oea.oeauser
       
      LET l_sql="SELECT DISTINCT gen03,gen03,gen03 FROM ",cl_get_target_table(p_azw01,'gen_file'), 
                " WHERE gen01='",l_oea.oeauser,"'"
      CALL cl_replace_sqldb(l_sql) RETURNING l_sql            							
      CALL cl_parse_qry_sql(l_sql,p_azw01) RETURNING l_sql    
      PREPARE sel_gen03_oea_pre7 FROM l_sql
      EXECUTE sel_gen03_oea_pre7 INTO l_oea.oeagrup,l_oea.oeaorig,l_oea.oea15
      
      IF NOT cl_null(l_oea.oea21) THEN 
         LET l_sql="SELECT gec04,gec05,gec07", 
                   "  FROM ",cl_get_target_table(p_azw01,'gec_file'),
                   " WHERE gec01='",l_oea.oea21,"'",
                   "   AND gec011='2'  "#銷項
         CALL cl_replace_sqldb(l_sql) RETURNING l_sql
         CALL cl_parse_qry_sql(l_sql,p_azw01) RETURNING l_sql          
         PREPARE sel_gec_oea_pre2 FROM l_sql          
         EXECUTE sel_gec_oea_pre2 INTO l_oea.oea211,l_oea.oea212,l_oea.oea213 
      END IF    

      LET l_ins = " INSERT INTO ",cl_get_target_table(p_azw01,'oea_file'),"(",
                  "        oea00,oea01,oea02,oea03,oea032, ",
                  "        oea04,oea044,oea05,oea06,oea07, ",
                  "        oea08,oea09,oea11,oea14,oea15, ",
                  "        oea161,oea162,oea163,oea17,oea18, ",
                  "        oea21,oea211,oea212,oea213,oea23, ",
                  "        oea24,oea25,oea31,oea32,oea33, ",
                  "        oea34,oea37,oea41,oea42,oea43, ",
                  "        oea49,oea61,oea62,oea63,oea72, ",
                  "        oea901,oea905,oea906,oea909,oeamksg, ",
                  "        oeadays,oeaprit,oeasseq,oeasmax,oeaconf, ",
                  "        oeaprsw,oeauser,oeagrup,oea65,oea1005, ",
                  "        oea1008,oea1012,oea80,oea81,oea82, ",
                  "        oea917,oea918,oea919,oeaplant,oealegal, ",
                  "        oea83,oea84,oea87,oea88,oea89, ",
                  "        oea90,oea91,oeacont,oeaconu,oeaoriu, ", 
                  "        oeaorig,oea94,oeaslk02,oea261,oea262, ",
                  "        oea263,oea85,oea50,oeadate ) ",
                  " VALUES(?,?,?,?,?,  ?,?,?,?,?,  ?,?,?,?,?, ",
                  "        ?,?,?,?,?,  ?,?,?,?,?,  ?,?,?,?,?, ",
                  "        ?,?,?,?,?,  ?,?,?,?,?,  ?,?,?,?,?, ",
                  "        ?,?,?,?,?,  ?,?,?,?,?,  ?,?,?,?,?, ",
                  "        ?,?,?,?,?,  ?,?,?,?,?,  ?,?,?,?,?, ",
                  "        ?,?,?,?,?,  ?,?,?,?) "
      CALL cl_replace_sqldb(l_ins) RETURNING l_ins
      CALL cl_parse_qry_sql(l_ins,p_azw01) RETURNING l_ins
      PREPARE ins_oea_pre FROM l_ins
      EXECUTE ins_oea_pre USING
                l_oea.oea00,l_oea.oea01,l_oea.oea02,l_oea.oea03,l_oea.oea032,
                l_oea.oea04,l_oea.oea044,l_oea.oea05,l_oea.oea06,l_oea.oea07,
                l_oea.oea08,l_oea.oea09,l_oea.oea11,l_oea.oea14,l_oea.oea15,
                l_oea.oea161,l_oea.oea162,l_oea.oea163,l_oea.oea17,l_oea.oea18,
                l_oea.oea21,l_oea.oea211,l_oea.oea212,l_oea.oea213,l_oea.oea23,
                l_oea.oea24,l_oea.oea25,l_oea.oea31,l_oea.oea32,l_oea.oea33,
                l_oea.oea34,l_oea.oea37,l_oea.oea41,l_oea.oea42,l_oea.oea43,
                l_oea.oea49,l_oea.oea61,l_oea.oea62,l_oea.oea63,l_oea.oea72,
                l_oea.oea901,l_oea.oea905,l_oea.oea906,l_oea.oea909,l_oea.oeamksg,
                l_oea.oeadays,l_oea.oeaprit,l_oea.oeasseq,l_oea.oeasmax,l_oea.oeaconf,
                l_oea.oeaprsw,l_oea.oeauser,l_oea.oeagrup,l_oea.oea65,l_oea.oea1005,
                l_oea.oea1008,l_oea.oea1012,l_oea.oea80,l_oea.oea81,l_oea.oea82,
                l_oea.oea917,l_oea.oea918,l_oea.oea919,l_oea.oeaplant,l_oea.oealegal,
                l_oea.oea83,l_oea.oea84,l_oea.oea87,l_oea.oea88,l_oea.oea89,
                l_oea.oea90,l_oea.oea91,l_oea.oeacont,l_oea.oeaconu,l_oea.oeaoriu,
                l_oea.oeaorig,l_oea.oea94,l_oea.oeaslk02,l_oea.oea261,l_oea.oea262,
                l_oea.oea263,l_oea.oea85,l_oea.oea50,l_oea.oeadate

      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno = SQLCA.sqlcode
         LET g_showmsg = 'INS oea_file'||' '||'SHOP:'||p_azw01||' '||'SALENO:'||g_fno1
         CALL s_errmsg('oea01',l_oea.oea01,g_showmsg,SQLCA.sqlcode,1)
         LET g_msg1 = 'oea_file'||'INS'||p_azw01||g_fno1
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,g_fno1,'01','TD_SALE',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         LET g_showmsg = ''
         INITIALIZE l_oea.* TO NULL #FUN-C80051 Add
         INITIALIZE l_oeb.* TO NULL #FUN-C80051 Add
         CONTINUE FOREACH
      END IF

      #ins oeaa_file
      LET l_sql = "SELECT COUNT(*) FROM ",cl_get_target_table(p_azw01,'oas_file'),
                  " WHERE oas01 = '",l_oea.oea80,"' "
      CALL cl_replace_sqldb(l_sql) RETURNING l_sql                 
      CALL cl_parse_qry_sql(l_sql,p_azw01) RETURNING l_sql
      PREPARE sel_oas_oeaa_pre FROM l_sql
      EXECUTE sel_oas_oeaa_pre INTO l_count
      IF l_count = 0 THEN 
         LET l_oeaa.oeaa01 = l_oea.oea01
         LET l_oeaa.oeaa02 = '1'
         LET l_oeaa.oeaa03 = 1
         LET l_oeaa.oeaa04 = l_oea.oea80
         CALL s_rdatem(l_oea.oea03,l_oeaa.oeaa04,l_oea.oea02,l_oea.oea02,l_oea.oea02,g_plant_new)
             RETURNING l_oeaa.oeaa05,l_oeaa.oeaa06

         LET l_oeaa.oeaa07    = l_oea.oea24
         LET l_oeaa.oeaa08    = l_oea.oea261
         LET l_oeaa.oeaaplant = g_plant_new
         LET l_oeaa.oeaalegal = l_legal

         LET l_ins = " INSERT INTO ",cl_get_target_table(p_azw01,'oeaa_file'),"(",
                     "        oeaa01,oeaa02,oeaa03,oeaa04,oeaa05, ",
                     "        oeaa06,oeaa07,oeaa08,oeaaplant,oeaalegal) ",
                     " VALUES(?,?,?,?,?,  ?,?,?,?,?) "
         CALL cl_replace_sqldb(l_ins) RETURNING l_ins
         CALL cl_parse_qry_sql(l_ins,p_azw01) RETURNING l_ins
         PREPARE ins_oeaa_pre1 FROM l_ins
         EXECUTE ins_oeaa_pre1 USING
                     l_oeaa.oeaa01,l_oeaa.oeaa02,l_oeaa.oeaa03,l_oeaa.oeaa04,l_oeaa.oeaa05,
                     l_oeaa.oeaa06,l_oeaa.oeaa07,l_oeaa.oeaa08,l_oeaa.oeaaplant,l_oeaa.oeaalegal
         IF STATUS THEN
            CALL cl_err3("ins","oeaa_file",l_oeaa.oeaa01,l_oeaa.oeaa02,SQLCA.sqlcode,"","",1)
         END IF
      ELSE
         SELECT azi04 INTO t_azi04 FROM azi_file WHERE azi01 = l_oea.oea23  
         LET g_sql = "SELECT oas01,oas02,oas03,oas04,oas05",
                     " FROM ",cl_get_target_table(p_azw01,'oas_file'),
                     " WHERE oas01 = '",l_oea.oea80,"' "
         CALL cl_replace_sqldb(l_sql) RETURNING l_sql                 
         CALL cl_parse_qry_sql(l_sql,p_azw01) RETURNING l_sql 
         PREPARE sel_oasp1 FROM g_sql
         DECLARE sel_oas CURSOR FOR sel_oasp1
         FOREACH sel_oas INTO l_oas.oas01,l_oas.oas02,l_oas.oas03,l_oas.oas04,l_oas.oas05
            LET l_oeaa.oeaa01 = l_oea.oea01
            LET l_oeaa.oeaa02 = '1'
            LET l_oeaa.oeaa03 = l_oas.oas03
            LET l_oeaa.oeaa04 = l_oas.oas04

            CALL s_rdatem(l_oea.oea03,l_oeaa.oeaa04,l_oea.oea02,l_oea.oea02,l_oea.oea02,g_plant_new)
                RETURNING l_oeaa.oeaa05,l_oeaa.oeaa06
            LET l_oeaa.oeaa07 = l_oea.oea24
            LET l_oeaa.oeaa08 = l_oea.oea261 * l_oas.oas05/100
            CALL cl_digcut(l_oeaa.oeaa08,t_azi04) RETURNING l_oeaa.oeaa08
            LET l_oeaa.oeaaplant = g_plant_new
            LET l_oeaa.oeaalegal = l_legal
            IF cl_null(l_oeaa.oeaa08) THEN
               LET l_oeaa.oeaa08 = 0
            END IF
            LET l_ins = " INSERT INTO ",cl_get_target_table(p_azw01,'oeaa_file'),"(",
                        "        oeaa01,oeaa02,oeaa03,oeaa04,oeaa05, ",
                        "        oeaa06,oeaa07,oeaa08,oeaaplant,oeaalegal) ",
                        " VALUES(?,?,?,?,?,  ?,?,?,?,?) "
            CALL cl_replace_sqldb(l_ins) RETURNING l_ins
            CALL cl_parse_qry_sql(l_ins,p_azw01) RETURNING l_ins
            PREPARE ins_oeaa_pre2 FROM l_ins
            EXECUTE ins_oeaa_pre2 USING
                        l_oeaa.oeaa01,l_oeaa.oeaa02,l_oeaa.oeaa03,l_oeaa.oeaa04,l_oeaa.oeaa05,
                        l_oeaa.oeaa06,l_oeaa.oeaa07,l_oeaa.oeaa08,l_oeaa.oeaaplant,l_oeaa.oeaalegal
            IF STATUS THEN 
               CALL cl_err3("ins","oeaa_file",l_oeaa.oeaa01,l_oeaa.oeaa02,SQLCA.sqlcode,"","",1)
            END IF  
         END FOREACH
      END IF
      
      #ins oeb_file
      #oeb_file default 預設值 Begin --- #FUN-C80051 Add
      LET l_oeb.oeb19   = 'N'                #備置否
      LET l_oeb.oeb22   = '0'                #版本
      LET l_oeb.oeb23   =  0                 #待出貨數量
      LET l_oeb.oeb24   =  0                 #已出貨數量
      LET l_oeb.oeb25   =  0                 #已銷退數量
      LET l_oeb.oeb26   =  0                 #被結案數量
      LET l_oeb.oeb906  = 'N'                #檢驗否
      LET l_oeb.oeb28   =  0                 #已轉請購量
      LET l_oeb.oeb48   = '1'                #出貨方式 1.訂貨 2.現貨
      LET l_oeb.oeb1003 = '1'                #作業方式
      LET l_oeb.oeb1012 = 'N'                #搭贈
      LET l_oeb.oeb09   = g_rtz07            #出貨倉庫
      LET l_oeb.oeblegal = l_legal           #所屬法人
      LET l_oeb.oeb16 = l_oeb.oeb15          #排定交貨日
      #oeb_file default 預設值 End ----- #FUN-C80051 Add

      LET l_sql = " SELECT DISTINCT ",
                  " '",l_oea.oea01,"', ",            #oeb01    訂單單號                  
                  " item, ",                         #oeb03    項次
                 #" CASE WHEN featureno IS NULL THEN pluno ELSE featureno END, ",   #oeb04    產品編號
                  " CASE WHEN featureno IS NULL THEN pluno WHEN featureno = ' ' THEN pluno ELSE featureno END, ",   #oeb04    產品編號
                  " unit, ",                         #oeb05    銷售單位
                  " qty, ",                          #oeb12    數量
                  " price, ",                        #oeb13    單價
                  " uamt, ",                         #oeb14    未稅金額
                  " amt, ",                          #oeb14t   含稅金額
                  " oldprice, ",                     #oeb17    取出單價
                  " 'N', ",                          #oeb70    結案否
                  " unit, ",                         #oeb916   計價單位
                  " qty, ",                          #oeb917   計價數量
                  " disc, ",                         #oeb47    分攤折價
                  " shop, ",                         #oebplant 所屬營運中心
                  " counterno, ",                    #oeb49    攤位編號
                  " oldprice ",                      #oeb37    基礎單價
                  " FROM ",g_posdbs,"td_sale_detail",g_db_links," ",
                  " WHERE shop='",p_azw01,"' ",
                  " AND cnfflg='Y' ",
                  " AND saleno = '",l_oea.oea94,"' ",
                  " ORDER BY item "
   
      PREPARE sel_td_sale_detail_oeb_pre FROM l_sql
      DECLARE sel_td_sale_detail_oeb_curs CURSOR WITH HOLD FOR sel_td_sale_detail_oeb_pre
      FOREACH sel_td_sale_detail_oeb_curs INTO
                  l_oeb.oeb01,                      #訂單單號
                  l_oeb.oeb03,                      #項次
                  l_oeb.oeb04,                      #產品編號
                  l_oeb.oeb05,                      #銷售單位
                  l_oeb.oeb12,                      #數量
                  l_oeb.oeb13,                      #單價
                  l_oeb.oeb14,                      #未稅金額
                  l_oeb.oeb14t,                     #含稅金額
                  l_oeb.oeb17,                      #取出單價
                  l_oeb.oeb70,                      #結案否
                  l_oeb.oeb916,                     #計價單位
                  l_oeb.oeb917,                     #計價數量
                  l_oeb.oeb47,                      #分攤折價
                  l_oeb.oebplant,                   #所屬營運中心
                  l_oeb.oeb49,                      #攤位編號
                  l_oeb.oeb37                       #基礎單價

         IF SQLCA.sqlcode THEN
            LET g_success = 'N'
            LET g_errno = SQLCA.sqlcode
            LET g_showmsg = 'SEL TD_SALE_DETAIL'||' '||'SHOP:'||p_azw01||' '||'SALENO:'||g_fno1
            CALL s_errmsg('oea94',l_oea.oea94,g_showmsg,SQLCA.sqlcode,1)
            LET g_msg1 = 'TD_SALE_DETAIL'||'SEL'||p_azw01||g_fno1 
            ROLLBACK WORK
            CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
            LET g_msg = g_msg[1,255]
            CALL p200_log(g_trans_no,p_azw01,g_fno1,'01','TD_SALE_DETAIL',g_errno,g_msg,'0','N',g_msg1)
            LET g_errno = ''
            LET g_msg   = ''
            LET g_msg1  = ''
            LET g_showmsg = ''
            EXIT FOREACH
         END IF
         
         LET l_oeb.oeb08    = l_oea.oea84      #出貨營運中心

         LET l_sql = "SELECT ima02,ima25 FROM ",cl_get_target_table(p_azw01,'ima_file'),
                     " WHERE ima01 = '",l_oeb.oeb04,"' "
         CALL cl_replace_sqldb(l_sql) RETURNING l_sql
         CALL cl_parse_qry_sql(l_sql,p_azw01) RETURNING l_sql
         PREPARE sel_ima_oeb_pre FROM l_sql
         EXECUTE sel_ima_oeb_pre INTO l_oeb.oeb06,l_ima25

         CALL s_umfchk('',l_oeb.oeb05,l_ima25) RETURNING l_flag1,l_oeb.oeb05_fac
         IF cl_null(l_oeb.oeb05_fac) THEN LET l_oeb.oeb05_fac = 1 END IF

         LET l_sql="SELECT DISTINCT rty06 FROM ",cl_get_target_table(p_azw01,'rty_file'),
                   " WHERE rty01 = '",p_azw01,"' AND rty02 = '",l_oeb.oeb04 ,"' "
         CALL cl_replace_sqldb(l_sql) RETURNING l_sql
         CALL cl_parse_qry_sql(l_sql,p_azw01) RETURNING l_sql
         PREPARE sel_rty06_oeb_pre FROM l_sql
         EXECUTE sel_rty06_oeb_pre INTO l_oeb.oeb44
         IF cl_null(l_oeb.oeb44) THEN LET l_oeb.oeb44 = '1' END IF

         IF NOT cl_null(l_oea.oea15) THEN
            LET l_oeb.oeb930 = s_costcenter(l_oea.oea15)
         END IF

         #若經營方式為聯營或代銷
         IF l_oeb.oeb44='3' OR l_oeb.oeb44='4' THEN
            LET l_sql = "SELECT rty05 FROM ",cl_get_target_table(p_azw01,'rty_file'),
                        " WHERE rty01 = '",p_azw01,"' ",
                        "   AND rty02 = '",l_oeb.oeb04,"' AND rtyacti = 'Y' "
            CALL cl_replace_sqldb(l_sql) RETURNING l_sql
            CALL cl_parse_qry_sql(l_sql,p_azw01) RETURNING l_sql
            PREPARE sel_rty05_oea_pre FROM l_sql
            EXECUTE sel_rty05_oea_pre INTO l_rty05
            IF NOT cl_null(l_rty05) THEN
               LET l_sql = "SELECT rtt01,rtt11 FROM ",cl_get_target_table(p_azw01,'rtt_file'),",",
                                                      cl_get_target_table(p_azw01,'rts_file'),",",
                                                      cl_get_target_table(p_azw01,'rto_file'),
                           " WHERE rts01 = rtt01 ",
                           "   AND rttplant = rtsplant ",
                           "   AND rts02 = rtt02 ",
                           "   AND rtt04 = '",l_oeb.oeb04,"' ",
                           "   AND rto01 = rts04 ",
                           "   AND rtoplant = rtsplant ",
                           "   AND rto05 = '",l_rty05,"' ",
                           "   AND rto06 = '",l_oeb.oeb44,"' ",
                           "   AND rto08 <= '",l_oea.oea02,"' ",
                           "   AND rto09 >= '",l_oea.oea02,"' ", 
                           "   AND rtt15 = 'Y' ",
                           "   AND rtoconf = 'Y' ",
                           "   AND rtsconf = 'Y' ",
                           "   AND rto03 = rts02 ",
                           "   AND rtoplant = '",p_azw01,"' "
               CALL cl_replace_sqldb(l_sql) RETURNING l_sql
               CALL cl_parse_qry_sql(l_sql,p_azw01) RETURNING l_sql
               PREPARE sel_rtt_oea_pre FROM l_sql
               EXECUTE sel_rtt_oea_pre INTO l_rtt01,l_rtt11
               IF NOT cl_null(l_rtt01) THEN
                  LET l_sql = "SELECT rtv12,rtu01 FROM ",cl_get_target_table(p_azw01,'rtv_file'),",",
                                                         cl_get_target_table(p_azw01,'rtu_file'),",",
                                                         cl_get_target_table(p_azw01,'rtt_file'),
                              " WHERE rtt01 = rtu04 ",
                              "   AND rtt02 = rtu02 ",
                              "   AND rttplant = rtuplant ",
                              "   AND rtuplant = '",p_azw01,"' ",
                              "   AND rtuconf = 'Y' ",
                              "   AND rtuplant = rtvplant ",
                              "   AND rtu01 = rtv01 ",
                              "   AND rtu02 = rtv02 ",
                              "   AND rtu09 <= '",l_oea.oea02,"' ",
                              "   AND rtu10 >= '",l_oea.oea02,"' ", 
                              "   AND rtt01 = '",l_rtt01,"' ",
                              "   AND rtu05 = '",l_rty05,"' ",
                              "   AND rtu06 = '",l_oeb.oeb44,"' ",
                              "   AND rtv04 = '",l_oeb.oeb04,"' "
                  CALL cl_replace_sqldb(l_sql) RETURNING l_sql
                  CALL cl_parse_qry_sql(l_sql,p_azw01) RETURNING l_sql
                  PREPARE sel_rtv12_oea_pre FROM l_sql
                  EXECUTE sel_rtv12_oea_pre INTO l_rtv12,l_rtu01
                  IF NOT cl_null(l_rtu01) THEN
                     LET l_oeb.oeb45=l_rtv12
                  ELSE
                     LET l_oeb.oeb45=l_rtt11
                  END IF
               END IF
            END IF
         ELSE
            LET l_oeb.oeb45 = NULL
         END IF
         LET l_oeb.oeb46 = l_oeb.oeb45

         IF NOT cl_null(l_oeb.oeb49) THEN
            #1.抓合同中的商户
            LET l_sql = "SELECT DISTINCT lnt04 FROM ",cl_get_target_table(p_azw01,'lnt_file'),
                        " WHERE lnt17 <= '",l_oea.oea02,"' ",
                        "   AND lnt18 >= '",l_oea.oea02,"' ",
                        "   AND lnt06  = '",l_oeb.oeb49,"' ",
                        "   AND (lnt26 = 'Y' OR lnt26 = 'S' OR lnt26 = 'E') "
            CALL cl_replace_sqldb(l_sql) RETURNING l_sql
            CALL cl_parse_qry_sql(l_sql,p_azw01) RETURNING l_sql
            PREPARE sel_lnt04_oea_pre FROM l_sql
            EXECUTE sel_lnt04_oea_pre INTO l_oeb.oeb50
            #2.抓预租
            IF cl_null(l_oeb.oeb50) THEN 
               LET l_sql = "SELECT DISTINCT lih08 FROM ",cl_get_target_table(p_azw01,'lih_file'),
                           " WHERE lih14 <= '",l_oea.oea02,"' ",
                           "   AND lih15 >= '",l_oea.oea02,"' ",
                           "   AND lih07  = '",l_oeb.oeb49,"' ",
                           "   AND lihconf = 'Y' "
               CALL cl_replace_sqldb(l_sql) RETURNING l_sql
               CALL cl_parse_qry_sql(l_sql,p_azw01) RETURNING l_sql
               PREPARE sel_lih08_oea_pre FROM l_sql
               EXECUTE sel_lih08_oea_pre INTO l_oeb.oeb50
            END IF
            
            #商户不存在
            IF cl_null(l_oeb.oeb50) THEN 
               LET g_showmsg = 'SEL oeb50'||' '||'SHOP:'||p_azw01||' '||'SALENO:'||g_fno1
               CALL s_errmsg('oeb01',l_oeb.oeb01,g_showmsg,'alm-133',1)
               LET g_errno   = 'alm-133'
               LET g_success = 'N'
               ROLLBACK WORK 
               LET g_msg1 = 'oeb_file'||'SEL oeb50'||p_azw01||g_fno1
               CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
               LET g_msg = g_msg[1,255]
               CALL p200_log(g_trans_no,p_azw01,g_fno1,'01','TD_SALE',g_errno,g_msg,'0','N',g_msg1)
               LET g_errno = ''
               LET g_msg   = ''
               LET g_msg1  = ''
               LET g_showmsg = ''
               RETURN 
            END IF 
         END IF 

         LET l_ins = " INSERT INTO ",cl_get_target_table(p_azw01,'oeb_file'),"(",
                     "        oeb01,oeb03,oeb04,oeb05,oeb05_fac, ",
                     "        oeb06,oeb08,oeb09,oeb12,oeb13, ",
                     "        oeb14,oeb14t,oeb17,oeb19,oeb22, ",
                     "        oeb23,oeb24,oeb25,oeb26,oeb70, ",
                     "        oeb906,oeb916,oeb917,oeb930,oeb28, ",
                     "        oeb44,oeb45,oeb46,oeb47,oeb48, ",
                     "        oebplant,oeblegal,oeb49,oeb50,oeb37, ",
                     "        oeb1003,oeb1012,oeb15,oeb16,oeb51) ", #FUN-C90011 Add oeb15,oeb16,oeb51
                     " VALUES(?,?,?,?,?,  ?,?,?,?,?, ",
                     "        ?,?,?,?,?,  ?,?,?,?,?, ",
                     "        ?,?,?,?,?,  ?,?,?,?,?, ",
                     "        ?,?,?,?,?,  ?,?,?,?,?) "          #FUN-C90011 Add ,?,?,?
         CALL cl_replace_sqldb(l_ins) RETURNING l_ins
         CALL cl_parse_qry_sql(l_ins,p_azw01) RETURNING l_ins
         PREPARE ins_oeb_pre FROM l_ins
         EXECUTE ins_oeb_pre USING 
                     l_oeb.oeb01,l_oeb.oeb03,l_oeb.oeb04,l_oeb.oeb05,l_oeb.oeb05_fac,
                     l_oeb.oeb06,l_oeb.oeb08,l_oeb.oeb09,l_oeb.oeb12,l_oeb.oeb13,
                     l_oeb.oeb14,l_oeb.oeb14t,l_oeb.oeb17,l_oeb.oeb19,l_oeb.oeb22,
                     l_oeb.oeb23,l_oeb.oeb24,l_oeb.oeb25,l_oeb.oeb26,l_oeb.oeb70,
                     l_oeb.oeb906,l_oeb.oeb916,l_oeb.oeb917,l_oeb.oeb930,l_oeb.oeb28,
                     l_oeb.oeb44,l_oeb.oeb45,l_oeb.oeb46,l_oeb.oeb47,l_oeb.oeb48,
                     l_oeb.oebplant,l_oeb.oeblegal,l_oeb.oeb49,l_oeb.oeb50,l_oeb.oeb37,
                     l_oeb.oeb1003,l_oeb.oeb1012,l_oeb.oeb15,l_oeb.oeb16,l_oeb.oeb51  #FUN-C90011 Add oeb15,oeb16,oeb51

         IF SQLCA.sqlcode THEN
            LET g_success = 'N'
            LET g_errno = SQLCA.sqlcode
            LET g_showmsg = 'INS oeb_file'||' '||'SHOP:'||p_azw01||' '||'SALENO:'||g_fno1
            CALL s_errmsg('oeb01',l_oeb.oeb01,g_showmsg,SQLCA.sqlcode,1)
            LET g_msg1 = 'oeb_file'||'INS'||p_azw01||g_fno1
            ROLLBACK WORK
            CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
            LET g_msg = g_msg[1,255]
            CALL p200_log(g_trans_no,p_azw01,g_fno1,'01','TD_SALE_DETAIL',g_errno,g_msg,'0','N',g_msg1)
            LET g_errno = ''
            LET g_msg   = ''
            LET g_msg1  = ''
            LET g_showmsg = ''
            EXIT FOREACH
         END IF
         IF SQLCA.sqlerrd[3] > 0 THEN
            IF l_sucflag = 0 THEN
               LET l_sucflag = SQLCA.sqlerrd[3]
            END IF
         END IF

        #CALL p200_rxc_ins("oeb_file",p_azw01,l_saleno,l_oeb.oeb03,l_oea.oea01,l_oeb.oeb05,l_oea.oea02,l_oeb.oeb04)     #更新上傳折價明細檔     #FUN-CC0082 Mark
         CALL p200_rxc_ins("oeb_file",p_azw01,l_saleno,l_oeb.oeb03,l_oea.oea01,l_oeb.oeb05,l_oea.oea02,l_oeb.oeb04,'')     #更新上傳折價明細檔  #FUN-CC0082 Add
         IF g_success = 'N' THEN
            INITIALIZE l_oeb.* TO NULL #FUN-C80051 Add
            CONTINUE FOREACH
         END IF
      END FOREACH

      IF g_success = 'N' THEN
         INITIALIZE l_oea.* TO NULL #FUN-C80051 Add
         INITIALIZE l_oeb.* TO NULL #FUN-C80051 Add
         CONTINUE FOREACH
      END IF

      #單身無資料，取消單頭資料
      IF l_sucflag = 0 THEN
         LET g_success = 'N'
         LET g_errno = 'wag-037'
         LET g_showmsg = 'INS oeb_file'||' '||'SHOP:'||p_azw01||' '||'SALENO:'||g_fno1
         CALL s_errmsg('oeb01',l_oea.oea01,g_showmsg,g_errno,1)
         LET g_msg1 = 'oeb_file'||'INS'||p_azw01||g_fno1
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,g_fno1,'02','TD_SALE_DETAIL',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         LET g_showmsg = ''
         INITIALIZE l_oea.* TO NULL #FUN-C80051 Add
         INITIALIZE l_oeb.* TO NULL #FUN-C80051 Add
         CONTINUE FOREACH
      END IF

      #ins oeg_file
      LET l_ins = " INSERT INTO ",cl_get_target_table(p_azw01,'oeg_file'),"(",
                  "        oeg01, ",                     #訂單單號    
                  "        oeg02, ",                     #項次        
                  "        oeg03, ",                     #序號        
                  "        oeg04, ",                     #稅別        
                  "        oeg05, ",                     #稅率        
                  "        oeg06, ",                     #固定稅額    
                  "        oeg07, ",                     #含稅否      
                  "        oeg08, ",                     #未稅金額    
                  "        oeg08t, ",                    #含稅金額    
                  "        oeg09, ",                     #稅額        
                  "        oegdate, ",                   #最近修改日
                  "        oeggrup, ",                   #資料所有部門
                  "        oeglegal, ",                  #所屬法人    
                  "        oegmodu, ",                   #資料修改者
                  "        oegorig, ",                   #資料建立部門
                  "        oegoriu, ",                   #資料建立者
                  "        oegplant, ",                  #所屬營運中心
                  "        oeguser) "                    #資料所有者
                  
      LET l_sel = " SELECT DISTINCT ",
                  " '",l_oea.oea01,"', ",                #oeg01    訂單單號
                  " mitem, ",                            #oeg02    項次
                  " item, ",                             #oeg03    序號
                  " taxcode, ",                          #oeg04    稅別
                  " taxrate, ",                          #oeg05    稅率
                  " 0, ",                                #oeg06    固定稅額
                  " incltax, ",                          #oeg07    含稅否
                  " uamt, ",                             #oeg08    未稅金額
                  " amt, ",                              #oeg08t   含稅金額
                  " tax, ",                              #oeg09    稅額
                  " '",l_oea.oeadate,"', ",              #oegdate  最近修改日
                  " '",l_oea.oeagrup,"', ",              #oeggrup  資料所有部門
                  " '",l_oea.oealegal,"', ",             #oeglegal 所屬法人
                  " '",l_oea.oeamodu,"', ",              #oegmodu  資料修改者
                  " '",l_oea.oeaorig,"', ",              #oegorig  資料建立部門
                  " '",l_oea.oeaoriu,"', ",              #oegoriu  資料建立者
                  " shop, ",                             #oegplant 所屬營運中心
                  " '",l_oea.oeauser,"' ",               #oeguser  資料所有者
                  " FROM ",g_posdbs,"td_sale_detail_taxdetail",g_db_links," ",
                  " WHERE shop = '",p_azw01,"' ",
                  " AND saleno = '",l_oea.oea94,"' ",
                  " ORDER BY mitem,item "
      
      LET l_sql = l_ins,l_sel CLIPPED
      CALL cl_replace_sqldb(l_sql) RETURNING l_sql
      CALL cl_parse_qry_sql(l_sql,p_azw01) RETURNING l_sql
      PREPARE sel_td_sale_detail_taxdetail_oea_pre FROM l_sql
      EXECUTE sel_td_sale_detail_taxdetail_oea_pre
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno = SQLCA.sqlcode
         LET g_showmsg = 'SEL TD_SALE_DETAIL_TAXDETAIL'||' '||'SHOP:'||p_azw01||' '||'SALENO:'||g_fno1
         CALL s_errmsg('oea94',l_oea.oea94,g_showmsg,SQLCA.sqlcode,1)
         LET g_msg1 = 'TD_SALE_DETAIL_TAXDETAIL'||'SEL'||p_azw01||g_fno1
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,g_fno1,'01','TD_SALE_DETAIL_TAXDETAIL',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         LET g_showmsg = ''
         INITIALIZE l_oea.* TO NULL #FUN-C80051 Add
         INITIALIZE l_oeb.* TO NULL #FUN-C80051 Add
         CONTINUE FOREACH
      END IF

      #ins rxx_file/rxy_file/rxz_file
     #FUN-CC0082 Mark&Add Begin ---
     #CALL p200_xyz_ins("oea_file",p_azw01,l_saleno,l_oea.oea01,l_oea.oeauser)  #更新上傳交款明細/交款匯總/刷卡明細檔
      IF g_rcj12 = '2' AND l_oea.oeaplant <> l_oea.oea84 THEN
         CALL p200_xyz_ins("oea_file",p_azw01,l_saleno,l_oea.oea01,l_oea.oeauser,l_oea.oea84)
      ELSE
         CALL p200_xyz_ins("oea_file",p_azw01,l_saleno,l_oea.oea01,l_oea.oeauser,'')
      END IF
     #FUN-CC0082 Mark&Add End -----
      IF g_success = 'N' THEN
         INITIALIZE l_oea.* TO NULL #FUN-C80051 Add
         INITIALIZE l_oeb.* TO NULL #FUN-C80051 Add
         CONTINUE FOREACH
      END IF

      IF g_success='Y' AND l_sucflag>0 THEN
         IF g_success = 'Y' THEN
            CALL p200_upd_posflag("td_sale",p_azw01,l_saleno,l_oea.oea01) 
            IF g_success = 'N' THEN 
               INITIALIZE l_oea.* TO NULL #FUN-C80051 Add
               INITIALIZE l_oeb.* TO NULL #FUN-C80051 Add
               CONTINUE FOREACH 
            END IF
         END IF
      ELSE                          #若單身上傳資料失敗或者無具體數據上傳
         ROLLBACK WORK
         LET g_errno = 'wag-037' #單身無資料
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,l_saleno,'01','TD_SALE_DETAIL|TD_SALE',g_errno,g_msg,'0','N','')     
         LET g_errno = ''
         LET g_msg   = ''
         INITIALIZE l_oea.* TO NULL #FUN-C80051 Add
         INITIALIZE l_oeb.* TO NULL #FUN-C80051 Add
         CONTINUE FOREACH
      END IF
  
      #審核過賬---
      IF g_success = 'Y' AND l_sucflag > 0 THEN
        #CALL t400sub_y_chk('1',l_oea.oea01,p_azw01,l_saleno)         #CALL 原確認的 check 段
         IF g_success = "Y" THEN
           #CALL t400sub_y_upd(l_oea.oea01,'confirm',p_azw01,l_saleno)       #CALL 原確認的 update 段
            IF g_success = "Y" THEN
               LET l_sql="SELECT DISTINCT rye03 FROM ",cl_get_target_table(p_azw01,'rye_file'), 
                         " WHERE rye01 = 'apm' AND rye02 = '1' "
               CALL cl_replace_sqldb(l_sql) RETURNING l_sql                						
               CALL cl_parse_qry_sql(l_sql,p_azw01) RETURNING l_sql         
               PREPARE sel_rye03_pre FROM l_sql
               EXECUTE sel_rye03_pre INTO l_rye03
               IF SQLCA.sqlcode OR cl_null(l_rye03) THEN
                  LET g_success = 'N'
                  ROLLBACK WORK
                  INITIALIZE l_oea.* TO NULL #FUN-C80051 Add
                  INITIALIZE l_oeb.* TO NULL #FUN-C80051 Add
                  CONTINUE FOREACH
               ELSE
                 #FUN-CA0091 Mark&Add Begin ---
                 #SELECT ryz09 INTO l_ryz09  FROM ryz_file WHERE ryz01 = '0'
                 #IF l_ryz09 = 'Y' THEN   
                  IF g_ryz09 = 'Y' THEN   
                 #FUN-CA0091 Mark&Add End -----
                     CALL t400sub_exp(l_oea.oea01,l_rye03,p_azw01,l_saleno)
                     IF g_success = 'N' THEN
                        ROLLBACK WORK
                        INITIALIZE l_oea.* TO NULL #FUN-C80051 Add
                        INITIALIZE l_oeb.* TO NULL #FUN-C80051 Add
                        CONTINUE FOREACH
                     END IF  
                  END IF    
               END IF
            END IF 
         END IF
      END IF

      IF g_success = 'Y' AND l_sucflag > 0 THEN
         LET g_sucflag = 1
         COMMIT WORK 
      ELSE                       #若單身無數據上傳,則取消單頭上傳
         ROLLBACK WORK
        #FUN-C80045 Mark Begin ---
        #CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
        #LET g_msg = g_msg[1,255]
        #CALL p200_log(g_trans_no,p_azw01,l_saleno,'01','TD_SALE_DETAIL|TD_SALE',g_errno,g_msg,'0','N','')   
        #LET g_errno = ''
        #LET g_msg   = ''
        #FUN-C80045 Mark End -----
         INITIALIZE l_oea.* TO NULL #FUN-C80051 Add
         INITIALIZE l_oeb.* TO NULL #FUN-C80051 Add
         CONTINUE FOREACH
      END IF
      INITIALIZE l_oea.* TO NULL #FUN-C80051 Add
      INITIALIZE l_oeb.* TO NULL #FUN-C80051 Add
   END FOREACH  
END FUNCTION

#FUN-CA0091 Add Begin ---
FUNCTION p200_oea_p_ins(p_gat01,p_azw01)
DEFINE p_gat01       LIKE gat_file.gat01
DEFINE p_azw01       LIKE azw_file.azw01
DEFINE p_azw02       LIKE azw_file.azw01
DEFINE l_ins         STRING
DEFINE l_upd         STRING
DEFINE l_sql         STRING
DEFINE l_sel         STRING
DEFINE l_oea01       LIKE oea_file.oea01
DEFINE l_oea03       LIKE oea_file.oea03
DEFINE l_oea04       LIKE oea_file.oea04
DEFINE l_oea80       LIKE oea_file.oea80
DEFINE l_oea032      LIKE oea_file.oea032
DEFINE l_oea02       LIKE oea_file.oea02
DEFINE l_oeaplant    LIKE oea_file.oeaplant
DEFINE l_date        LIKE oea_file.oea02
DEFINE l_oea11       LIKE oea_file.oea11
DEFINE l_oea12       LIKE oea_file.oea12
DEFINE l_oea94       LIKE oea_file.oea94
DEFINE l_oea23       LIKE oea_file.oea23
DEFINE l_oea24       LIKE oea_file.oea24
DEFINE l_i           LIKE type_file.num5
DEFINE l_num_len     LIKE type_file.num10
DEFINE l_num_str     LIKE type_file.chr20
DEFINE l_oea01_str   STRING
DEFINE l_oea01_num   LIKE type_file.chr20
DEFINE l_oea01_chr   LIKE type_file.chr20
DEFINE l_cnt         LIKE type_file.num5
DEFINE l_oea02_old   LIKE oea_file.oea02
DEFINE l_oea01_min   LIKE oea_file.oea01
DEFINE l_oea01_max   LIKE oea_file.oea01
DEFINE l_oea01_min_o LIKE oea_file.oea01
DEFINE l_oea01_max_o LIKE oea_file.oea01
DEFINE l_oea02_num   LIKE type_file.num10
DEFINE l_azn05       LIKE azn_file.azn05
DEFINE l_azn05_old   LIKE azn_file.azn05
DEFINE l_upd_num     LIKE type_file.num10
DEFINE l_saleno      STRING
DEFINE l_oeaa05      LIKE oeaa_file.oeaa05
DEFINE l_oeaa06      LIKE oeaa_file.oeaa06
DEFINE l_count       LIKE type_file.num5
DEFINE l_rye03       LIKE rye_file.rye03

  #FUN-CA0160 Mark Begin ---
  ##先删除需要建立的临时表
  #DROP TABLE oea_temp
  #DROP TABLE oeb_temp
  #DROP TABLE rxx_temp
  #DROP TABLE rxy_temp
  #DROP TABLE rxz_temp
  #
  ##建立临时表
  #SELECT * FROM oea_file WHERE 1=0 INTO TEMP oea_temp
  #SELECT * FROM oeb_file WHERE 1=0 INTO TEMP oeb_temp
  #SELECT * FROM rxx_file WHERE 1=0 INTO TEMP rxx_temp
  #SELECT * FROM rxy_file WHERE 1=0 INTO TEMP rxy_temp
  #SELECT * FROM rxz_file WHERE 1=0 INTO TEMP rxz_temp
  #
  ##建立索引
  #CREATE INDEX oea_temp_01 ON oea_temp (oea94)
  #CREATE INDEX oea_temp_02 ON oea_temp (oea15)
  #CREATE INDEX oea_temp_03 ON oea_temp (oea01)
  #CREATE INDEX oeb_temp_01 ON oeb_temp (oeb04)
  #CREATE INDEX oeb_temp_02 ON oeb_temp (oeb01,oeb03)
  #FUN-CA0160 Mark End -----
   
   #组出过滤条件
   IF NOT cl_null(g_saleno) THEN
      LET g_wc = " saleno = '",g_saleno,"' "
   ELSE
     #CALL p200_g_wc() RETURNING g_wc           #FUN-CA0160 Mark
      CALL p200_g_wc("oea_file") RETURNING g_wc #FUN-CA0160 Add
   END IF
   IF cl_null(g_wc) THEN LET g_wc = " 1=1" END IF

   SELECT azw02 INTO p_azw02 FROM azw_file WHERE azw01 = p_azw01
   
   #将中间库中满足条件的单据Condition2更新为B
   LET l_upd = "UPDATE ",g_posdbs,"td_sale",g_db_links," ",
               "   SET Condition2 = 'B' ",
               " WHERE Condition2 <> 'Y' AND Type = '3' AND Cnfflg = 'Y' AND Shop = '",p_azw01 CLIPPED,"' AND ",g_wc CLIPPED
   PREPARE upd_td_sale_pre FROM l_upd
   EXECUTE upd_td_sale_pre
   IF SQLCA.sqlcode THEN
      LET g_success = 'N'
      LET g_errno   = SQLCA.sqlcode 
      LET g_msg1    = 'Oper:Upd'||' '||'Table:td_sale(oea)'||' '||'Field:Condition2'||' '||'Shop:'||p_azw01
      CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
      ROLLBACK WORK
      CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
      LET g_msg   = g_msg[1,255]
      CALL p200_log(g_trans_no,p_azw01,'Batch Operation','01','TD_SALE',g_errno,g_msg,'0','N',g_msg1)
      LET g_errno = ''
      LET g_msg   = ''
      LET g_msg1  = ''
      RETURN
   END IF
   
   LET l_upd_num = SQLCA.sqlerrd[3]
   IF l_upd_num <= 0 THEN RETURN END IF
   IF cl_null(g_sum_limit) OR g_sum_limit = 0 THEN LET g_sum_limit = l_upd_num END IF

  #FUN-CA0160 Add Begin ---
   #先删除需要建立的临时表
   DROP TABLE oea_temp
   DROP TABLE oeb_temp
   DROP TABLE rxx_temp
   DROP TABLE rxy_temp
   DROP TABLE rxz_temp
   
   #建立临时表
   SELECT * FROM oea_file WHERE 1=0 INTO TEMP oea_temp
   SELECT * FROM oeb_file WHERE 1=0 INTO TEMP oeb_temp
   SELECT * FROM rxx_file WHERE 1=0 INTO TEMP rxx_temp
   SELECT * FROM rxy_file WHERE 1=0 INTO TEMP rxy_temp
   SELECT * FROM rxz_file WHERE 1=0 INTO TEMP rxz_temp
   
   #建立索引
   CREATE INDEX oea_temp_01 ON oea_temp (oea94)
   CREATE INDEX oea_temp_02 ON oea_temp (oea15)
   CREATE INDEX oea_temp_03 ON oea_temp (oea01)
   CREATE INDEX oeb_temp_01 ON oeb_temp (oeb04)
   CREATE INDEX oeb_temp_02 ON oeb_temp (oeb01,oeb03)
  #FUN-CA0160 Add End -----
   
   WHILE l_upd_num > 0 #剩余笔数大于0做WHILE循环
      LET l_upd_num = l_upd_num - g_sum_limit #依次减去每批的笔数
      
      #清空临时表
      DELETE FROM oea_temp
      DELETE FROM oeb_temp
      DELETE FROM rxx_temp
      DELETE FROM rxy_temp
      DELETE FROM rxz_temp
      
      LET g_success = 'Y'
      BEGIN WORK
      
      LET l_ins = "INSERT INTO oea_temp( ",
                  "                     oea00, ",         #类型
                  "                     oea01, ",         #订单单号/合约单号
                  "                     oea02, ",         #订单日期/合约日期
                  "                     oea03, ",         #账款客户编号
                  "                     oea032, ",        #账款客户简称
                  "                     oea04, ",         #送货客户编号
                  "                     oea044, ",        #送货地址码
                  "                     oea05, ",         #发票别
                  "                     oea06, ",         #更改版本
                  "                     oea07, ",         #出货是否计入未开发票的销货待验收入
                  "                     oea08, ",         #订单性质
                  "                     oea09, ",         #允许超交率
                  "                     oea11, ",         #订单来源
                  "                     oea14, ",         #人员编号
                  "                     oea15, ",         #部门编号
                  "                     oea161, ",        #订金应收比率
                  "                     oea162, ",        #出货应收比率
                  "                     oea163, ",        #尾款应收比率
                  "                     oea17, ",         #收款客戶編號
                  "                     oea18, ",         #是否采用订单汇率立账
                  "                     oea21, ",         #税种
                  "                     oea211, ",        #税率
                  "                     oea212, ",        #联数
                  "                     oea213, ",        #含税否
                  "                     oea23, ",         #币种
                  "                     oea24, ",         #汇率
                  "                     oea25, ",         #销售分类一
                  "                     oea261, ",        #订金金额
                  "                     oea262, ",        #出货金额
                  "                     oea263, ",        #尾款金额
                  "                     oea31, ",         #价格条件编号
                  "                     oea32, ",         #收款条件编号
                  "                     oea33, ",         #其它条件
                  "                     oea34, ",         #佣金率%或佣金金额
                  "                     oea37, ",         #订单分配否
                  "                     oea41, ",         #起运地
                  "                     oea42, ",         #到达地
                  "                     oea43, ",         #交运方式
                  "                     oea49, ",         #状况码
                  "                     oea50, ",         #是否作CSD展开
                  "                     oea61, ",         #订单总税前金额
                  "                     oea62, ",         #已出货税前金额
                  "                     oea63, ",         #被结案税前金额
                  "                     oea65, ",         #客户出货签收否
                  "                     oea72, ",         #审核日
                  "                     oea80, ",         #订金收款条件
                  "                     oea81, ",         #尾款收款条件
                  "                     oea82, ",         #借货偿价
                  "                     oea83, ",         #销货营运中心
                  "                     oea84, ",         #取货营运中心
                  "                     oea85, ",         #结算方式
                  "                     oea87, ",         #会员卡号
                  "                     oea88, ",         #顾客姓名
                  "                     oea89, ",         #联系电话
                  "                     oea90, ",         #证件类型
                  "                     oea901, ",        #多角贸易否
                  "                     oea905, ",        #多角贸易抛转否
                  "                     oea906, ",        #多角贸易来源订单否
                  "                     oea909, ",        #No Use
                  "                     oea91, ",         #证件号码
                  "                     oea917, ",        #二维输入
                  "                     oea918, ",        #订金立账分期
                  "                     oea919, ",        #尾款立账分期
                  "                     oea94, ",         #POS单号
                  "                     oea95, ",         #生产门店   #FUN-CC0082 Add
                  "                     oea1005, ",       #是否计算业绩
                  "                     oea1008, ",       #订单总含税金额
                  "                     oea1012, ",       #自提否
                  "                     oeamksg, ",       #是否签核
                  "                     oeadays, ",       #签核完成天数
                  "                     oeaprit, ",       #签核优先等级
                  "                     oeasseq, ",       #已签核顺序
                  "                     oeasmax, ",       #应签核顺序
                  "                     oeaconf, ",       #审核否
                  "                     oeaprsw, ",       #订单打印次数
                  "                     oeauser, ",       #资料所有者
                  "                     oeagrup, ",       #资料所有部门
                  "                     oeaplant, ",      #所属营运中心
                  "                     oealegal, ",      #所属法人
                  "                     oeacont, ",       #审核时间
                  "                     oeaconu, ",       #审核人员
                  "                     oeaoriu, ",       #资料建立者
                  "                     oeaorig, ",       #资料建立部门
                  "                     oeaslk02, ",      #款式明细
                  "                     oeadate) "        #最近更改日
      LET l_sel = "SELECT ",
                  "       '1', ",                                                       #oea00         #类型
                  "       ROW_NUMBER() over(order by Shop,Saleno), ",                   #oea01         #订单单号/合约单号
                  "       CAST(bdate AS DATE), ",                                       #oea02         #订单日期/合约日期
                  "       CASE WHEN cardno IS NOT NULL THEN lpk20 ELSE rtz06 END, ",    #oea03         #账款客户编号
                  "       occ02, ",                                                     #oea032        #账款客户简称
                  "       occ09, ",                                                     #oea04         #送货客户编号
                  "       'MISC', ",                                                    #oea044        #送货地址码
                  "       '1', ",                                                       #oea05         #发票别
                  "       '0', ",                                                       #oea06         #更改版本
                  "       'N', ",                                                       #oea07         #出货是否计入未开发票的销货待验收入
                  "       '1', ",                                                       #oea08         #订单性质
                  "       '0', ",                                                       #oea09         #允许超交率
                  "       '9', ",                                                       #oea11         #订单来源
                  "       ryi02, ",                                                     #oea14         #人员编号
                  "       gen03, ",                                                     #oea15         #部门编号
                  "       100*pay_amt/tot_amt, ",                                       #oea161        #订金应收比率
                  "       100 - 100*pay_amt/tot_amt, ",                                 #oea162        #出货应收比率
                  "       0, ",                                                         #oea163        #尾款应收比率
                  "       rtz06, ",                                                     #oea17         #收款客戶編號
                  "       'N', ",                                                       #oea18         #是否采用订单汇率立账
                  "       occ41, ",                                                     #oea21         #税种
                  "       gec04, ",                                                     #oea211        #税率
                  "       gec05, ",                                                     #oea212        #联数
                  "       gec07, ",                                                     #oea213        #含税否
                  "       occ42, ",                                                     #oea23         #币种
                  "       NULL, ",                                                      #oea24         #汇率
                  "       occ43, ",                                                     #oea25         #销售分类一
                  "       COALESCE(pay_amt,0), ",                                       #oea261        #订金金额
                  "       tot_amt-pay_amt, ",                                           #oea262        #出货金额
                  "       0, ",                                                         #oea263        #尾款金额
                  "       occ44, ",                                                     #oea31         #价格条件编号
                  "       occ45, ",                                                     #oea32         #收款条件编号
                  "       occ46, ",                                                     #oea33         #其它条件
                  "       occ53, ",                                                     #oea34         #佣金率%或佣金金额
                  "       'N', ",                                                       #oea37         #订单分配否
                  "       occ48, ",                                                     #oea41         #起运地
                  "       occ49, ",                                                     #oea42         #到达地
                  "       occ47, ",                                                     #oea43         #交运方式
                  "       '1', ",                                                       #oea49         #状况码
                  "       'N', ",                                                       #oea50         #是否作CSD展开
                  "       tot_uamt, ",                                                  #oea61         #订单总税前金额
                  "       0, ",                                                         #oea62         #已出货税前金额
                  "       0, ",                                                         #oea63         #被结案税前金额
                  "       occ65, ",                                                     #oea65         #客户出货签收否
                  "       CAST(sdate AS DATE), ",                                       #oea72         #审核日
                  "       occ68, ",                                                     #oea80         #订金收款条件
                  "       occ69, ",                                                     #oea81         #尾款收款条件
                  "       'N', ",                                                       #oea82         #借货偿价
                  "       shop, ",                                                      #oea83         #销货营运中心
                  "       getshop, ",                                                   #oea84         #取货营运中心
                  "       '1', ",                                                       #oea85         #结算方式
                  "       cardno, ",                                                    #oea87         #会员卡号
                  "       contman, ",                                                   #oea88         #顾客姓名
                  "       conttel, ",                                                   #oea89         #联系电话
                  "       lpk02, ",                                                     #oea90         #证件类型
                  "       'N', ",                                                       #oea901        #多角贸易否
                  "       'N', ",                                                       #oea905        #多角贸易抛转否
                  "       'N', ",                                                       #oea906        #多角贸易来源订单否
                  "       'N', ",                                                       #oea909        #No Use
                  "       lpk03, ",                                                     #oea91         #证件号码
                  "       'N', ",                                                       #oea917        #二维输入
                  "       'N', ",                                                       #oea918        #订金立账分期
                  "       'N', ",                                                       #oea919        #尾款立账分期
                  "       saleno, ",                                                    #oea94         #POS单号
                  "       NULL, ",                                                      #oea95         #生产门店 #FUN-CC0082 Add
                  "       'N', ",                                                       #oea1005       #是否计算业绩
                  "       tot_amt, ",                                                   #oea1008       #订单总含税金额
                  "       'N', ",                                                       #oea1012       #自提否
                  "       'N', ",                                                       #oeamksg       #是否签核
                  "       0, ",                                                         #oeadays       #签核完成天数
                  "       0, ",                                                         #oeaprit       #签核优先等级
                  "       0, ",                                                         #oeasseq       #已签核顺序
                  "       0, ",                                                         #oeasmax       #应签核顺序
                  "       'Y', ",                                                       #oeaconf       #审核否
                  "       0, ",                                                         #oeaprsw       #订单打印次数
                  "       ryi02, ",                                                     #oeauser       #资料所有者
                  "       gen03, ",                                                     #oeagrup       #资料所有部门
                  "       shop, ",                                                      #oeaplant      #所属营运中心
                  "       '",p_azw02,"', ",                                             #oealegal      #所属法人
                  "       stime[1,2]||':'||stime[3,4]||':'||stime[5,6], ",              #oeacont       #审核时间
                  "       ryi02, ",                                                     #oeaconu       #审核人员
                  "       ryi02, ",                                                     #oeaoriu       #资料建立者
                  "       gen03, ",                                                     #oeaorig       #资料建立部门
                  "       'N', ",                                                       #oeaslk02      #款式明细
                  "       CAST(sdate AS DATE) ",                                        #oeadate       #最近更改日
                  "  FROM ( ",
                  "SELECT * ",
                  "  FROM ",g_posdbs,"td_sale",g_db_links," ",
                  " WHERE Shop = '",p_azw01,"' AND Condition2 = 'B' AND Type = '3' AND Cnfflg = 'Y' ",
                  " ORDER BY Bdate,Saleno) LEFT OUTER JOIN ",cl_get_target_table(p_azw01,'rtz_file'),
                  "                                     ON rtz01 = shop ",
                  "                        LEFT OUTER JOIN ",cl_get_target_table(p_azw01,'lpj_file'),
                  "                                     ON lpj03 = cardno ",
                  "                        LEFT OUTER JOIN ",cl_get_target_table(p_azw01,'lpk_file'),
                  "                                     ON lpk01 = lpj01 ",
                  "                        LEFT OUTER JOIN ",cl_get_target_table(p_azw01,'occ_file'),
                  "                                     ON lpk20 = occ01 OR occ01 = rtz06 ",
                  "                        LEFT OUTER JOIN ",cl_get_target_table(p_azw01,'ryi_file'),
                  "                                     ON ryi01 = opno ",
                  "                        LEFT OUTER JOIN ",cl_get_target_table(p_azw01,'gen_file'),
                  "                                     ON gen01 = ryi02 ",
                  "                        LEFT OUTER JOIN ",cl_get_target_table(p_azw01,'gec_file'),
                  "                                     ON gec01 = occ41 AND gec011 = '2' ",
                  " WHERE ROWNUM <= ",g_sum_limit," ",
                  " ORDER BY Bdate,Saleno "
      LET l_sql = l_ins CLIPPED," ",l_sel CLIPPED
      PREPARE ins_oea_temp_pre FROM l_sql
      EXECUTE ins_oea_temp_pre
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Ins'||' '||'Table:oea_temp'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','01','TD_SALE',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CONTINUE WHILE
      END IF
      
      INITIALIZE l_oea02_old,l_oea01_min_o,l_oea01_max_o,l_azn05_old TO NULL                                    
      INITIALIZE l_oea02,l_oea02_num,l_oea01_min,l_oea01_max,l_azn05 TO NULL
      LET l_sql = "SELECT DISTINCT MIN(to_number(oea01)),oea02,MAX(to_number(oea01)) FROM oea_temp GROUP BY oea02 order by oea02"
      PREPARE sel_oea02_pre FROM l_sql
      DECLARE sel_oea02_cs CURSOR FOR sel_oea02_pre
      FOREACH sel_oea02_cs INTO l_oea01_min,l_oea02,l_oea01_max
      
         #自动编号
         LET g_ndate = l_oea02
        #CALL p200_auto_doc(p_gat01,p_azw01) RETURNING l_oea01     #FUN-CC0082 Mark
         CALL p200_auto_doc(p_gat01,p_azw01,'Y') RETURNING l_oea01 #FUN-CC0082 Add
         IF g_success = 'N' THEN
            RETURN
         END IF
         
         CASE g_ryz05
            WHEN "1"
               LET l_num_len = 8
            WHEN "2"
               LET l_num_len = 9
            WHEN "3"
               LET l_num_len = 10
         END CASE
         
         CASE g_ryz06
            WHEN "1" #按流水号
               LET l_num_len = l_num_len
               IF NOT cl_null(l_oea02_old) THEN
                  #已排流水号个数 = 最大流水号旧值- 最小流水号旧值+ 1 + 上一笔已排流水号个数
                  LET l_oea02_num = l_oea01_max_o - l_oea01_min_o + 1 + l_oea02_num
               ELSE
                  LET l_oea02_num = 0
               END IF
            WHEN "2" #按年月
               LET l_num_len = l_num_len - 4
               IF NOT cl_null(l_oea02_old) THEN 
                  IF YEAR(l_oea02_old) = YEAR(l_oea02) AND MONTH(l_oea02_old) = MONTH(l_oea02) THEN
                     LET l_oea02_num = l_oea01_max_o - l_oea01_min_o + 1 + l_oea02_num
                  ELSE
                     LET l_oea02_num = 0
                  END IF
               ELSE
                  LET l_oea02_num = 0
               END IF
            WHEN "3" #按年周
               LET l_num_len = l_num_len - 4
               IF NOT cl_null(l_oea02_old) THEN
                  INITIALIZE l_azn05 TO NULL
                  SELECT azn05 INTO l_azn05 FROM azn_file WHERE azn01 = l_oea02
                  IF YEAR(l_oea02_old) = YEAR(l_oea02) AND l_azn05_old = l_azn05 THEN
                     LET l_oea02_num = l_oea01_max_o - l_oea01_min_o + 1 + l_oea02_num
                  ELSE
                     LET l_oea02_num = 0
                  END IF
               ELSE
                  LET l_oea02_num = 0
               END IF
            WHEN "4" #按年月日
               LET l_num_len = l_num_len - 6
              #FUN-D30061 Mark&Add Begin ---
              #IF NOT cl_null(l_oea02_old) THEN
              #   LET l_oea02_num = l_oea01_max_o - l_oea01_min_o + 1 + l_oea02_num
              #ELSE
              #   LET l_oea02_num = 0
              #END IF
               LET l_oea02_num = 0
              #FUN-D30061 Mark&Add End -----
         END CASE
            
         LET l_oea01_min_o = l_oea01_min
         LET l_oea01_max_o = l_oea01_max
         LET l_azn05_old   = l_azn05
         LET l_oea02_old   = l_oea02
               
         INITIALIZE l_num_str TO NULL
         FOR l_cnt = 1 TO l_num_len
            LET l_num_str = l_num_str CLIPPED,'0'
         END FOR
         LET l_oea01_str = l_oea01
         LET l_oea01_num = l_oea01_str.subString(l_oea01_str.getLength() - l_num_len + 1,l_oea01_str.getLength())
         LET l_oea01_chr = l_oea01_str.subString(1,l_oea01_str.getLength() - l_num_len)
         
         #   最大流水号  = 实际流水号  - 最小ROWNUM  + 已排流水号个数
         LET l_oea01_num = l_oea01_num - l_oea01_min + l_oea02_num
         
         #批次更新oea_temp中的单号
         LET l_upd = "UPDATE oea_temp SET oea01 = '",l_oea01_chr CLIPPED,"'||","substr(to_char","((oea01 + '",l_oea01_num,"'),'",l_num_str,"'),2) ",
                     " WHERE oea02 = '",l_oea02,"' "
         PREPARE upd_oea01_pre FROM l_upd
         EXECUTE upd_oea01_pre
         IF SQLCA.sqlcode THEN
            LET g_success = 'N'
            LET g_errno   = SQLCA.sqlcode
            LET g_msg1    = 'Oper:Upd'||' '||'Table:oea_temp'||' '||'Field:oea01'||' '||'Shop:'||p_azw01
            CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
            ROLLBACK WORK
            CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
            LET g_msg   = g_msg[1,255]
            CALL p200_log(g_trans_no,p_azw01,'Batch Operation','01','TD_SALE',g_errno,g_msg,'0','N',g_msg1)
            LET g_errno = ''
            LET g_msg   = ''
            LET g_msg1  = ''
            CALL p200_upd_posflag_p('2',p_gat01,'td_sale',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
            CONTINUE WHILE
         END IF
      END FOREACH

      #更新汇率
     #LET l_sql = "SELECT oea23,oea02 FROM oea_temp "          #FUN-CB0103 Mark
      LET l_sql = "SELECT DISTINCT oea23,oea02 FROM oea_temp " #FUN-CB0103 Add
      PREPARE sel_oea23_pre FROM l_sql
      DECLARE sel_oea23_cs CURSOR FOR sel_oea23_pre
      FOREACH sel_oea23_cs INTO l_oea23,l_oea02
         CALL s_currm(l_oea23,l_oea02,g_oaz.oaz52,p_azw01) RETURNING l_oea24
         UPDATE oea_temp SET oea24 = l_oea24 WHERE oea23 = l_oea23 AND oea02 = l_oea02
         IF SQLCA.sqlcode THEN
            LET g_success = 'N'
            LET g_errno   = SQLCA.sqlcode
            LET g_msg1    = 'Oper:Upd'||' '||'Table:oea_temp'||' '||'Field:oea24'||' '||'Shop:'||p_azw01
            CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
            ROLLBACK WORK
            CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
            LET g_msg   = g_msg[1,255]
            CALL p200_log(g_trans_no,p_azw01,'Batch Operation','01','TD_SALE',g_errno,g_msg,'0','N',g_msg1)
            LET g_errno = ''
            LET g_msg   = ''
            LET g_msg1  = ''
            CALL p200_upd_posflag_p('2',p_gat01,'td_sale',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
            CONTINUE WHILE
         END IF
      END FOREACH
      
      #ins oeb_temp
      LET l_ins = "INSERT INTO oeb_temp( ",
                  "                     oeb01, ",        #订单单号
                  "                     oeb03, ",        #项次
                  "                     oeb04, ",        #产品编号
                  "                     oeb05, ",        #销售单位
                  "                     oeb05_fac, ",    #销售/库存单位换算率
                  "                     oeb06, ",        #品名规格
                  "                     oeb08, ",        #出货营运中心
                  "                     oeb09, ",        #出货仓库
                  "                     oeb12, ",        #数量
                  "                     oeb13, ",        #单价
                  "                     oeb14, ",        #税前金额
                  "                     oeb14t, ",       #含税金额
                  "                     oeb15, ",        #约定交货日
                  "                     oeb16, ",        #排定交货日
                  "                     oeb17, ",        #取出单价
                  "                     oeb19, ",        #备置否
                  "                     oeb22, ",        #版本
                  "                     oeb23, ",        #待出货数量
                  "                     oeb24, ",        #已出货数量
                  "                     oeb25, ",        #已销退数量
                  "                     oeb26, ",        #被结案数量
                  "                     oeb28, ",        #请购单号
                  "                     oeb37, ",        #基础单价
                  "                     oeb44, ",        #经营方式
                  "                     oeb45, ",        #原扣率
                  "                     oeb46, ",        #新扣率
                  "                     oeb47, ",        #分摊折价=全部折价字段值的合计
                  "                     oeb48, ",        #出货方式 1.订货 2.现货
                  "                     oeb49, ",        #摊位编号
                  "                     oeb50, ",        #商户编号
                  "                     oeb51, ",        #交货时间
                  "                     oeb70, ",        #结案否
                  "                     oeb906, ",       #检验否
                  "                     oeb916, ",       #计价单位
                  "                     oeb917, ",       #计价数量
                  "                     oeb930, ",       #成本中心
                  "                     oeb1003, ",      #作业方式
                  "                     oeb1012, ",      #搭赠
                  "                     oebplant, ",     #所属营运中心
                  "                     oeblegal) "      #所属法人
                  
      LET l_sel = "SELECT ",
                  "       oea01, ",                                      #oeb01        #订单单号
                  "       item, ",                                       #oeb03        #项次
                  "       CASE WHEN featureno IS NULL THEN pluno ",      #oeb04        #产品编号
                  "            WHEN featureno = ' '   THEN pluno ",
                  "            ELSE featureno END, ",
                  "       unit, ",                                       #oeb05        #销售单位
                  "       '0', ",                                        #oeb05_fac    #销售/库存单位换算率
                  "       NULL, ",                                       #oeb06        #品名规格
                  "       oea84, ",                                      #oeb08        #出货营运中心
                  "       '",g_rtz07,"', ",                              #oeb09        #出货仓库
                  "       qty, ",                                        #oeb12        #数量
                  "       price, ",                                      #oeb13        #单价
                  "       uamt, ",                                       #oeb14        #税前金额
                  "       amt, ",                                        #oeb14t       #含税金额
                  "       NULL, ",                                       #oeb15        #约定交货日
                  "       NULL, ",                                       #oeb16        #排定交货日
                  "       oldprice, ",                                   #oeb17        #取出单价
                  "       'N', ",                                        #oeb19        #备置否
                  "       '0', ",                                        #oeb22        #版本
                  "       0, ",                                          #oeb23        #待出货数量
                  "       0, ",                                          #oeb24        #已出货数量
                  "       0, ",                                          #oeb25        #已销退数量
                  "       0, ",                                          #oeb26        #被结案数量
                  "       0, ",                                          #oeb28        #已转请购量
                  "       oldprice, ",                                   #oeb37        #基础单价
                  "       '1', ",                                        #oeb44        #经营方式
                  "       NULL, ",                                       #oeb45        #原扣率
                  "       NULL, ",                                       #oeb46        #新扣率
                  "       disc, ",                                       #oeb47        #分摊折价=全部折价字段值的合计
                  "       '1', ",                                        #oeb48        #出货方式 1.订货 2.现货
                  "       counterno, ",                                  #oeb49        #摊位编号
                  "       NULL, ",                                       #oeb50        #商户编号
                  "       NULL, ",                                       #oeb51        #交货时间
                  "       'N', ",                                        #oeb70        #结案否
                  "       'N', ",                                        #oeb906       #检验否
                  "       unit, ",                                       #oeb916       #计价单位
                  "       qty, ",                                        #oeb917       #计价数量
                  "       NULL, ",                                       #oeb930       #成本中心
                  "       '1', ",                                        #oeb1003      #作业方式
                  "       'N', ",                                        #oeb1012      #搭赠
                  "       shop, ",                                       #oebplant     #所属营运中心
                  "       oealegal ",                                    #oeblegal     #所属法人
                  "  FROM ",g_posdbs,"td_sale_detail",g_db_links,",oea_temp ",
                  " WHERE shop = '",p_azw01,"' AND cnfflg = 'Y' AND saleno = oea94 ",
                  " ORDER BY item "
      LET l_sql = l_ins CLIPPED," ",l_sel CLIPPED
      PREPARE ins_oeb_temp_pre FROM l_sql
      EXECUTE ins_oeb_temp_pre
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Ins'||' '||'Table:oeb_temp'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
        #CALL p200_log(g_trans_no,p_azw01,'Batch Operation','01','TD_SALE',g_errno,g_msg,'0','N',g_msg1)        #FUN-CA0160 Mark
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','01','TD_SALE_DETAIL',g_errno,g_msg,'0','N',g_msg1) #FUN-CA0160 Add
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'td_sale',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF
      
      #抓取不存在oeb的oea   
      LET l_cnt = 0
      LET l_sql = "SELECT count(*) FROM oea_temp WHERE oea01 NOT IN (SELECT oeb01 FROM oeb_temp) "
      PREPARE sel_oea01_pre FROM l_sql
      EXECUTE sel_oea01_pre INTO l_cnt
      IF l_cnt > 0 THEN
         LET g_errno   = 'apc1051' #存在单身无资料的单据
         LET g_msg1    = 'Oper:Chk'||' '||'Table:oea_temp'||' '||'Shop:'||p_azw01
        #CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1) #FUN-CB0103 Mark
         CALL s_errmsg('Batch Operation:','',g_msg1,g_errno,1)       #FUN-CB0103 Add
        #ROLLBACK WORK #FUN-D10023 Mark
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
        #CALL p200_log(g_trans_no,p_azw01,'Batch Operation','01','TD_SALE',g_errno,g_msg,'0','N',g_msg1)        #FUN-CA0160 Mark
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','01','TD_SALE_DETAIL',g_errno,g_msg,'0','N',g_msg1) #FUN-CA0160 Add
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
      END IF

      #更新中间库状态为A
      LET l_upd = "UPDATE ",g_posdbs,"td_sale",g_db_links," ",
                  "   SET Condition2 = 'A' ",
                  " WHERE Shop = '",p_azw01,"' ",
                  "   AND EXISTS (SELECT 1 ",
                  "                 FROM oea_temp ",
                  "                WHERE oea01 NOT IN (SELECT oeb01 FROM oeb_temp) ",
                  "                  AND oea94 = Saleno) "
      PREPARE upd_td_sale_flag_oea_pre FROM l_upd
      EXECUTE upd_td_sale_flag_oea_pre
   
      #删除不存在oeb的oea
      DELETE FROM oea_temp WHERE oea01 NOT IN (SELECT oeb01 FROM oeb_temp)
      
      #更新品名规格
      LET l_upd = "UPDATE oeb_temp ",
                  "   SET oeb06 = ",
                  "       (SELECT ima02 FROM ",cl_get_target_table(p_azw01,'ima_file'),
                  "         WHERE ima01 = oeb04) "
      PREPARE upd_oeb_temp_pre1 FROM l_upd
      EXECUTE upd_oeb_temp_pre1
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Upd'||' '||'Table:oeb_temp'||' '||'Field:oeb06'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
        #CALL p200_log(g_trans_no,p_azw01,'Batch Operation','01','TD_SALE',g_errno,g_msg,'0','N',g_msg1)        #FUN-CA0160 Mark
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','01','TD_SALE_DETAIL',g_errno,g_msg,'0','N',g_msg1) #FUN-CA0160 Add
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'td_sale',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF
      
      #更新经营方式
      LET l_upd = "UPDATE oeb_temp ",
                  "   SET oeb44 = ",
                 #FUN-CB0103 Mark&Add Begin ---
                 #"       (SELECT COALESCE(rty06,'1') FROM ",cl_get_target_table(p_azw01,'rty_file'),
                 #"         WHERE rty01 = '",p_azw01,"' AND rty02 = oeb04) "
                  "       COALESCE((SELECT COALESCE(rty06,'1') FROM ",cl_get_target_table(p_azw01,'rty_file'),
                  "                  WHERE rty01 = '",p_azw01,"' AND rty02 = oeb04),'1') "
                 #FUN-CB0103 Mark&Add End -----
      PREPARE upd_oeb_temp_pre3 FROM l_upd
      EXECUTE upd_oeb_temp_pre3
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Upd'||' '||'Table:oeb_temp'||' '||'Field:oeb44'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
        #CALL p200_log(g_trans_no,p_azw01,'Batch Operation','01','TD_SALE',g_errno,g_msg,'0','N',g_msg1)        #FUN-CA0160 Mark
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','01','TD_SALE_DETAIL',g_errno,g_msg,'0','N',g_msg1) #FUN-CA0160 Add
         LET g_errno = '' 
         LET g_msg   = ''   
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'td_sale',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF 
      
      #更新单位换算率(销售单位=库存单位)
      LET l_sql = "UPDATE oeb_temp ",
                  "   SET oeb05_fac = '1' ",
                  " WHERE EXISTS (SELECT 1 ",
                  "                 FROM ",cl_get_target_table(p_azw01,'ima_file'),
                  "                WHERE oeb04 = ima01 AND ima25 = oeb05) "
      PREPARE upd_oeb05_fac_pre FROM l_sql
      EXECUTE upd_oeb05_fac_pre
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Upd'||' '||'Table:oeb_temp'||' '||'Field:oeb05_fac'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
        #CALL p200_log(g_trans_no,p_azw01,'Batch Operation','01','TD_SALE',g_errno,g_msg,'0','N',g_msg1)        #FUN-CA0160 Mark
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','01','TD_SALE_DETAIL',g_errno,g_msg,'0','N',g_msg1) #FUN-CA0160 Add
         LET g_errno = '' 
         LET g_msg   = ''   
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'td_sale',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF 
      
      #更新单位换算率(销售单位<>库存单位)
      LET l_sql = "UPDATE oeb_temp ",
                  "   SET oeb05_fac = ",
                 #FUN-CB0103 Mark&Add Begin ---
                 #"       (SELECT smd06/smd04 ",
                 #"          FROM ",cl_get_target_table(p_azw01,'smd_file'),
                 #"         WHERE smd01 = oeb04 ",
                 #"           AND smd02 = oeb05 AND smd03 = (SELECT ima25 ",
                 #"                                            FROM ",cl_get_target_table(p_azw01,'ima_file'),
                 #"                                           WHERE ima01 = oeb04))",
                  "       COALESCE((SELECT smd06/smd04 ",
                  "                   FROM ",cl_get_target_table(p_azw01,'smd_file'),
                  "                  WHERE smd01 = oeb04 ",
                  "                    AND smd02 = oeb05 AND smd03 = (SELECT ima25 ",
                  "                                                     FROM ",cl_get_target_table(p_azw01,'ima_file'),
                  "                                                    WHERE ima01 = oeb04)),0)",
                 #FUN-CB0103 Mark&Add End -----
                  " WHERE oeb05_fac = 0 "
      PREPARE upd_oeb05_fac_p1 FROM l_sql
      EXECUTE upd_oeb05_fac_p1
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Upd'||' '||'Table:oeb_temp'||' '||'Field:oeb05_fac'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
        #CALL p200_log(g_trans_no,p_azw01,'Batch Operation','01','TD_SALE',g_errno,g_msg,'0','N',g_msg1)        #FUN-CA0160 Mark
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','01','TD_SALE_DETAIL',g_errno,g_msg,'0','N',g_msg1) #FUN-CA0160 Add
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'td_sale',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF

      #更新单位换算率(销售单位<>库存单位)
      LET l_sql = "UPDATE oeb_temp ",
                  "   SET oeb05_fac = ",
                 #FUN-CB0103 Mark&Add Begin ---
                 #"       (SELECT smd04/smd06 ",
                 #"          FROM ",cl_get_target_table(p_azw01,'smd_file'),
                 #"         WHERE smd01 = oeb04 ",
                 #"           AND smd03 = oeb05 AND smd02 = (SELECT ima25 ",
                 #"                                            FROM ",cl_get_target_table(p_azw01,'ima_file'),
                 #"                                           WHERE ima01 = oeb04))",
                  "       COALESCE((SELECT smd04/smd06 ",
                  "                   FROM ",cl_get_target_table(p_azw01,'smd_file'),
                  "                  WHERE smd01 = oeb04 ",
                  "                    AND smd03 = oeb05 AND smd02 = (SELECT ima25 ",
                  "                                                     FROM ",cl_get_target_table(p_azw01,'ima_file'),
                  "                                                    WHERE ima01 = oeb04)),0)",
                 #FUN-CB0103 Mark&Add End -----
                  " WHERE oeb05_fac = 0 "
      PREPARE upd_oeb05_fac_p2 FROM l_sql
      EXECUTE upd_oeb05_fac_p2
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Upd'||' '||'Table:oeb_temp'||' '||'Field:oeb05_fac'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
        #CALL p200_log(g_trans_no,p_azw01,'Batch Operation','01','TD_SALE',g_errno,g_msg,'0','N',g_msg1)        #FUN-CA0160 Mark
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','01','TD_SALE_DETAIL',g_errno,g_msg,'0','N',g_msg1) #FUN-CA0160 Add
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'td_sale',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF

      #更新单位换算率(销售单位<>库存单位)
      LET l_sql = "UPDATE oeb_temp ",
                  "   SET oeb05_fac = ",
                 #FUN-CB0103 Mark&Add Begin ---
                 #"       (SELECT smc03/smc04 ",
                 #"          FROM ",cl_get_target_table(p_azw01,'smc_file'),
                 #"         WHERE smc01 = oeb05 AND smc02 = (SELECT ima25 ",
                 #"                                            FROM ",cl_get_target_table(p_azw01,'ima_file'),
                 #"                                           WHERE ima01 = oeb04))",
                  "       COALESCE((SELECT smc03/smc04 ",
                  "                   FROM ",cl_get_target_table(p_azw01,'smc_file'),
                  "                  WHERE smc01 = oeb05 AND smc02 = (SELECT ima25 ",
                  "                                                     FROM ",cl_get_target_table(p_azw01,'ima_file'),
                  "                                                    WHERE ima01 = oeb04)),0)",
                 #FUN-CB0103 Mark&Add End -----
                  " WHERE oeb05_fac = 0 "
      PREPARE upd_oeb05_fac_p3 FROM l_sql
      EXECUTE upd_oeb05_fac_p3
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Upd'||' '||'Table:oeb_temp'||' '||'Field:oeb05_fac'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
        #CALL p200_log(g_trans_no,p_azw01,'Batch Operation','01','TD_SALE',g_errno,g_msg,'0','N',g_msg1)        #FUN-CA0160 Mark
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','01','TD_SALE_DETAIL',g_errno,g_msg,'0','N',g_msg1) #FUN-CA0160 Add
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'td_sale',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF
      
      #更新成本中心
      LET l_sql = "UPDATE oeb_temp ",
                  "   SET oeb930 = ",
                  "       (SELECT gem10 FROM ",cl_get_target_table(p_azw01,'gem_file'),
                  "         WHERE EXISTS (SELECT 1 FROM oea_temp ",
                  "                        WHERE gem01 = oea15 ",
                  "                          AND oea01 = oeb01)) "
      PREPARE upd_oeb930_pre FROM l_sql
      EXECUTE upd_oeb930_pre
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Upd'||' '||'Table:oeb_temp'||' '||'Field:oeb930'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
        #CALL p200_log(g_trans_no,p_azw01,'Batch Operation','01','TD_SALE',g_errno,g_msg,'0','N',g_msg1)        #FUN-CA0160 Mark
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','01','TD_SALE_DETAIL',g_errno,g_msg,'0','N',g_msg1) #FUN-CA0160 Add
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'td_sale',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF
      
      #更新扣率(经营方式为代销或联营)
      LET l_sql = "UPDATE oeb_temp ",
                  "   SET (oeb45,oeb46) = ",
                  "       (SELECT rtv12,rtv12",
                  "          FROM ",cl_get_target_table(p_azw01,'rtv_file'),",",
                                    cl_get_target_table(p_azw01,'rtu_file'),",",
                                    cl_get_target_table(p_azw01,'rtt_file'),",",
                                    cl_get_target_table(p_azw01,'rty_file'),",oea_temp",
                  "         WHERE rtt01 = rtu04 ",
                  "           AND rtt02 = rtu02 ",
                  "           AND rttplant = rtuplant ",
                  "           AND rtuplant = '",p_azw01,"' ",
                  "           AND rtuconf = 'Y' ",
                  "           AND rtuplant = rtvplant ",
                  "           AND rtu01 = rtv01 ",
                  "           AND rtu02 = rtv02 ",
                  "           AND rty01 = '",p_azw01,"' ",
                  "           AND rty02 = oeb04 AND rtyacti = 'Y'",
                  "           AND rtu09 <= oea02 ",
                  "           AND rtu10 >= oea02 ",
                  "           AND rtu05 = rty05 ",
                  "           AND rtu06 = oeb44 ",
                  "           AND rtv04 = oeb04 ",
                  "           AND oea01 = oeb01 )",
                  " WHERE oeb44 IN ('3','4')"
      PREPARE upd_oeb45_p_pre1 FROM l_sql
      EXECUTE upd_oeb45_p_pre1
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Upd'||' '||'Table:oeb_temp'||' '||'Field:(oeb45/oeb46)'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
        #CALL p200_log(g_trans_no,p_azw01,'Batch Operation','01','TD_SALE',g_errno,g_msg,'0','N',g_msg1)        #FUN-CA0160 Mark
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','01','TD_SALE_DETAIL',g_errno,g_msg,'0','N',g_msg1) #FUN-CA0160 Add
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'td_sale',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF
      
      #更新扣率(经营方式为代销或联营)
      LET l_sql = "UPDATE oeb_temp ",
                  "   SET (oeb45,oeb46) = ",
                  "       (SELECT rtt11,rtt11",
                  "          FROM ",cl_get_target_table(p_azw01,'rtt_file'),",",
                                    cl_get_target_table(p_azw01,'rts_file'),",",
                                    cl_get_target_table(p_azw01,'rto_file'),",",
                                    cl_get_target_table(p_azw01,'rty_file'),",oea_temp",
                  "         WHERE rts01 = rtt01 ",
                  "           AND rttplant = rtsplant ",
                  "           AND rts02 = rtt02 ",
                  "           AND rtt04 = oeb04 ",
                  "           AND rto01 = rts04 ",
                  "           AND rtoplant = rtsplant ",
                  "           AND rto05 = rty05 ",
                  "           AND rty01 = '",p_azw01,"' ",
                  "           AND rty02 = oeb04 AND rtyacti = 'Y' ",
                  "           AND rto06 = oeb44 ",
                  "           AND rto08 <= oea02 ",
                  "           AND rto09 >= oea02 ",
                  "           AND rtt15 = 'Y' ",
                  "           AND rtoconf = 'Y' ",
                  "           AND rtsconf = 'Y' ",
                  "           AND rto03 = rts02 ",
                  "           AND rtoplant = '",p_azw01,"' ",
                  "           AND oea01 = oeb01 )",
                  " WHERE oeb44 IN ('3','4')",
                  "   AND oeb45 IS NULL "
      PREPARE upd_oeb45_p_pre2 FROM l_sql
      EXECUTE upd_oeb45_p_pre2
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Upd'||' '||'Table:oeb_temp'||' '||'Field:(oeb45/oeb46)'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
        #CALL p200_log(g_trans_no,p_azw01,'Batch Operation','01','TD_SALE',g_errno,g_msg,'0','N',g_msg1)        #FUN-CA0160 Mark
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','01','TD_SALE_DETAIL',g_errno,g_msg,'0','N',g_msg1) #FUN-CA0160 Add
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'td_sale',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF
      
      #更新商户(抓合同中的商户)
      LET l_sql = "UPDATE oeb_temp ",
                  "   SET oeb50 = ",
                  "       (SELECT DISTINCT lnt04 FROM ",cl_get_target_table(p_azw01,'lnt_file'),",oea_temp ",
                  "         WHERE lnt17 <= oea02 ",
                  "           AND lnt18 >= oea02 ",
                  "           AND lnt06  = oeb49 ",
                  "           AND (lnt26 = 'Y' OR lnt26 = 'S' OR lnt26 = 'E') ",
                  "           AND oea01 = oeb01 )",
                  " WHERE oeb49 IS NOT NULL "
      PREPARE upd_oeb49_p_pre1 FROM l_sql
      EXECUTE upd_oeb49_p_pre1
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Upd'||' '||'Table:oeb_temp'||' '||'Field:oeb50'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
        #CALL p200_log(g_trans_no,p_azw01,'Batch Operation','01','TD_SALE',g_errno,g_msg,'0','N',g_msg1)        #FUN-CA0160 Mark
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','01','TD_SALE_DETAIL',g_errno,g_msg,'0','N',g_msg1) #FUN-CA0160 Add
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'td_sale',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF
      
      #更新商户(抓预租协议中的商户)
      LET l_sql = "UPDATE oeb_temp ",
                  "   SET oeb50 = ",
                  "       (SELECT DISTINCT lih08 FROM ",cl_get_target_table(p_azw01,'lih_file'),",oea_temp ",
                  "         WHERE lih14 <= oea02 ",
                  "           AND lih15 >= oea02 ",
                  "           AND lih07  = oeb49 ",
                  "           AND lihconf = 'Y' ",
                  "           AND oea01 = oeb01 )",
                  " WHERE oeb49 IS NOT NULL ",
                  "   AND oeb50 IS NULL "
      PREPARE upd_oeb49_p_pre2 FROM l_sql
      EXECUTE upd_oeb49_p_pre2
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Upd'||' '||'Table:oeb_temp'||' '||'Field:oeb50'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
        #CALL p200_log(g_trans_no,p_azw01,'Batch Operation','01','TD_SALE',g_errno,g_msg,'0','N',g_msg1)        #FUN-CA0160 Mark
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','01','TD_SALE_DETAIL',g_errno,g_msg,'0','N',g_msg1) #FUN-CA0160 Add
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'td_sale',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF

      #更新约定交货日
      LET l_sql = "UPDATE oeb_temp ",
                  "   SET oeb15 = ",
                  "       (SELECT CAST(gdate AS DATE) ",
                  "          FROM ",g_posdbs,"td_sale",g_db_links," ",
                  "         WHERE EXISTS (SELECT 1 ",
                  "                         FROM oea_temp ",
                  "                        WHERE oea94 = saleno AND oea01 = oeb01 AND shop = oeaplant)) "
      PREPARE upd_oeb15_pre FROM l_sql
      EXECUTE upd_oeb15_pre
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Upd'||' '||'Table:oeb_temp'||' '||'Field:oeb15'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
        #CALL p200_log(g_trans_no,p_azw01,'Batch Operation','01','TD_SALE',g_errno,g_msg,'0','N',g_msg1)        #FUN-CA0160 Mark
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','01','TD_SALE_DETAIL',g_errno,g_msg,'0','N',g_msg1) #FUN-CA0160 Add
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'td_sale',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF

      #更新交货时间
      LET l_sql = "UPDATE oeb_temp ",
                  "   SET oeb51 = ",
                 #"       (SELECT gtime[1,2]||':'||gtime[3,4]||':'||g_time[5,6] ", #FUN-CB0103 Mark
                  "       (SELECT gtime[1,2]||':'||gtime[3,4]||':'||gtime[5,6] ",  #FUN-CB0103 Add
                  "          FROM ",g_posdbs,"td_sale",g_db_links," ",
                  "         WHERE EXISTS (SELECT 1 ",
                  "                         FROM oea_temp ",
                  "                        WHERE oea94 = saleno AND oea01 = oeb01 AND shop = oeaplant)) "
      PREPARE upd_oeb51_pre FROM l_sql
      EXECUTE upd_oeb51_pre
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Upd'||' '||'Table:oeb_temp'||' '||'Field:oeb51'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
        #CALL p200_log(g_trans_no,p_azw01,'Batch Operation','01','TD_SALE',g_errno,g_msg,'0','N',g_msg1)        #FUN-CA0160 Mark
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','01','TD_SALE_DETAIL',g_errno,g_msg,'0','N',g_msg1) #FUN-CA0160 Add
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'td_sale',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF

      #更新排定交货日
      UPDATE oeb_temp SET oeb16 = oeb15 WHERE oeb15 IS NOT NULL
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Upd'||' '||'Table:oeb_temp'||' '||'Field:oeb15'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
        #CALL p200_log(g_trans_no,p_azw01,'Batch Operation','01','TD_SALE',g_errno,g_msg,'0','N',g_msg1)        #FUN-CA0160 Mark
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','01','TD_SALE_DETAIL',g_errno,g_msg,'0','N',g_msg1) #FUN-CA0160 Add
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'td_sale',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF
      
      #ins xyz
      CALL p200_xyz_ins_p("oea_file",p_azw01)
      IF g_success='N' THEN
         ROLLBACK WORK
         CONTINUE WHILE
      END IF
      
      #ins rxc_file 开始
     #CALL p200_rxc_ins_p("oea_file",p_azw01)                       #FUN-CA0160 Mark
      CALL p200_rxc_ins_p("oea_file",p_azw01,"td_Sale_Detail_Agio") #FUN-CA0160 Add
      IF g_success = 'N' THEN
         ROLLBACK WORK
         CONTINUE WHILE
      END IF

      #如果地址码不为空,则新增单据出货地址档
      LET l_ins = "INSERT INTO ",cl_get_target_table(p_azw01,'oap_file'),"(",
                  "              oap01,  ",      #单据单号
                  "              oap02,  ",      #No Use
                  "              oap03,  ",      #全名
                  "              oap041, ",      #地址-1
                  "              oap042, ",      #地址-2
                  "              oap043, ",      #地址-3
                  "              oap044, ",      #地址-4
                  "              oap045) "       #地址-5
      LET l_sel = "SELECT ",
                  "       oea01, ",              #oap01           #单据单号
                  "       NULL, ",               #oap02           #No Use
                  "       NULL, ",               #oap03           #全名
                  "       shipadd, ",            #oap041          #地址-1
                  "       NULL, ",               #oap042          #地址-2
                  "       NULL, ",               #oap043          #地址-3
                  "       NULL, ",               #oap044          #地址-4
                  "       NULL ",                #oap045          #地址-5
                  "  FROM ",g_posdbs,"td_sale",g_db_links,", ",
                  "       oea_temp",
                  " WHERE oea94 = saleno ",
                 #"   AND ogaplant = shop AND type = '3' ", #FUN-CB0103 Mark
                  "   AND oeaplant = shop AND type = '3' ", #FUN-CB0103 Add
                  "   AND shipadd IS NOT NULL "
      LET l_sql = l_ins CLIPPED," ",l_sel CLIPPED
      PREPARE ins_oap_p_pre2 FROM l_sql
      EXECUTE ins_oap_p_pre2
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Ins'||' '||'Table:oap_file'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
        #CALL p200_log(g_trans_no,p_azw01,'Batch Operation','01','TD_SALE',g_errno,g_msg,'0','N',g_msg1)        #FUN-CA0160 Mark
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','01','TD_SALE_DETAIL',g_errno,g_msg,'0','N',g_msg1) #FUN-CA0160 Add
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'td_sale',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF 
      
      #ins oeaa_file 
     #LET l_sql = "SELECT oea03,oea04,oea02,oea80,oea23 FROM oea_temp ORDER BY oea03 "          #FUN-CB0103 Mark
      LET l_sql = "SELECT DISTINCT oea03,oea04,oea02,oea80,oea23 FROM oea_temp ORDER BY oea03 " #FUN-CB0103 Add
      PREPARE sel_oea03_pre FROM l_sql
      DECLARE sel_oea03_cs CURSOR FOR sel_oea03_pre
      FOREACH sel_oea03_cs INTO l_oea03,l_oea04,l_oea02,l_oea80,l_oea23
         CALL s_rdatem(l_oea03,l_oea80,l_oea02,l_oea02,l_oea02,p_azw01)
             RETURNING l_oeaa05,l_oeaa06
         LET l_ins = "INSERT INTO ",cl_get_target_table(p_azw01,'oeaa_file'),"(",
                     "            oeaa01, ",        #订单单号
                     "            oeaa02, ",        #类型
                     "            oeaa03, ",        #期别
                     "            oeaa04, ",        #子收款条件
                     "            oeaa05, ",        #应收款日
                     "            oeaa06, ",        #容许票据到期日
                     "            oeaa07, ",        #汇率
                     "            oeaa08, ",        #应收金额
                     "            oeaaplant, ",     #所属营运中心
                     "            oeaalegal) "      #所属法人
         LET l_count = 0
         IF NOT cl_null(l_oea80) THEN
            LET l_sql = "SELECT COUNT(*) FROM ",cl_get_target_table(p_azw01,'oas_file'),
                        " WHERE oas01 = '",l_oea80,"' "
            PREPARE sel_count_oas_pre FROM l_sql
            EXECUTE sel_count_oas_pre INTO l_count
         END IF
         IF l_count = 0 THEN
            LET l_sel = "SELECT ",
                        "       oea01, ",              #oeaa01        #订单单号
                        "       '1', ",                #oeaa02        #类型
                        "       1, ",                  #oeaa03        #期别
                        "       oea80, ",              #oeaa04        #子收款条件
                        "       '",l_oeaa05,"', ",     #oeaa05        #应收款日
                        "       '",l_oeaa06,"', ",     #oeaa06        #容许票据到期日
                        "       oea24, ",              #oeaa07        #汇率
                        "       oea261, ",             #oeaa08        #应收金额
                        "       oeaplant, ",           #oeaaplant     #所属营运中心
                        "       oealegal ",            #oeaalegal     #所属法人
                        "  FROM oea_temp ",
                        " WHERE oea02 = '",l_oea02,"' AND oea03 = '",l_oea03,"' ",
                        "   AND oea04 = '",l_oea04,"' "
            LET l_sql = l_ins CLIPPED," ",l_sel CLIPPED
            PREPARE ins_oeaa_pre3 FROM l_sql
            EXECUTE ins_oeaa_pre3
         ELSE
            SELECT azi04 INTO t_azi04 FROM azi_file WHERE azi01 = l_oea23
            LET l_sel = "SELECT ",
                        "       oea01, ",                                              #oeaa01        #订单单号
                        "       '1', ",                                                #oeaa02        #类型
                        "       oas03, ",                                              #oeaa03        #期别
                        "       oas04, ",                                              #oeaa04        #子收款条件
                        "       '",l_oeaa05,"', ",                                     #oeaa05        #应收款日
                        "       '",l_oeaa06,"', ",                                     #oeaa06        #容许票据到期日
                        "       oea24, ",                                              #oeaa07        #汇率
                        "       COALESCE(ROUND(oea261*oas05/100,",t_azi04,"),0), ",    #oeaa08        #应收金额
                        "       oeaplant, ",                                           #oeaaplant     #所属营运中心
                        "       oealegal ",                                            #oeaalegal     #所属法人
                        "  FROM oea_temp,",cl_get_target_table(p_azw01,'oas_file'),
                        " WHERE oea02 = '",l_oea02,"' AND oea03 = '",l_oea03,"' ",
                        "   AND oea04 = '",l_oea04,"' AND oea80 = '",l_oea80,"' ",
                        "   AND oas01 = oea80 "
            LET l_sql = l_ins CLIPPED," ",l_sel CLIPPED
            PREPARE ins_oeaa_pre4 FROM l_sql
            EXECUTE ins_oeaa_pre4
         END IF
      END FOREACH
      
      #ins oeg_file 单身税别明细
      LET l_ins = " INSERT INTO ",cl_get_target_table(p_azw01,'oeg_file'),"(",
                  "        oeg01, ",                     #訂單單號
                  "        oeg02, ",                     #項次
                  "        oeg03, ",                     #序號
                  "        oeg04, ",                     #稅別
                  "        oeg05, ",                     #稅率
                  "        oeg06, ",                     #固定稅額
                  "        oeg07, ",                     #含稅否
                  "        oeg08, ",                     #未稅金額
                  "        oeg08t, ",                    #含稅金額
                  "        oeg09, ",                     #稅額
                  "        oegdate, ",                   #最近修改日
                  "        oeggrup, ",                   #資料所有部門
                  "        oeglegal, ",                  #所屬法人
                  "        oegmodu, ",                   #資料修改者
                  "        oegorig, ",                   #資料建立部門
                  "        oegoriu, ",                   #資料建立者
                  "        oegplant, ",                  #所屬營運中心
                  "        oeguser) "                    #資料所有者

      LET l_sel = "SELECT DISTINCT ",
                  "       oea01, ",                      #oeg01    訂單單號
                  "       mitem, ",                      #oeg02    項次
                  "       item, ",                       #oeg03    序號
                  "       taxcode, ",                    #oeg04    稅別
                  "       taxrate, ",                    #oeg05    稅率
                  "       0, ",                          #oeg06    固定稅額
                  "       incltax, ",                    #oeg07    含稅否
                  "       uamt, ",                       #oeg08    未稅金額
                  "       amt, ",                        #oeg08t   含稅金額
                  "       tax, ",                        #oeg09    稅額
                  "       oeadate, ",                    #oegdate  最近修改日
                  "       oeagrup, ",                    #oeggrup  資料所有部門
                  "       oealegal, ",                   #oeglegal 所屬法人
                  "       oeamodu, ",                    #oegmodu  資料修改者
                  "       oeaorig, ",                    #oegorig  資料建立部門
                  "       oeaoriu, ",                    #oegoriu  資料建立者
                  "       shop, ",                       #oegplant 所屬營運中心
                  "       oeauser ",                     #oeguser  資料所有者
                  "  FROM ",g_posdbs,"td_sale_detail_taxdetail",g_db_links,",oea_temp ",
                  " WHERE shop = '",p_azw01,"' ",
                  "   AND saleno = oea94 ",
                  " ORDER BY mitem,item "
      LET l_sql = l_ins CLIPPED," ",l_sel CLIPPED
      PREPARE ins_oeg_p_pre FROM l_sql
      EXECUTE ins_oeg_p_pre
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Ins'||' '||'Table:oeg_file'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
        #CALL p200_log(g_trans_no,p_azw01,'Batch Operation','01','TD_SALE',g_errno,g_msg,'0','N',g_msg1)        #FUN-CA0160 Mark
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','01','TD_SALE_DETAIL_TAXDETAIL',g_errno,g_msg,'0','N',g_msg1) #FUN-CA0160 Add
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'td_sale',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF
      
      #更新中间库标志位
      CALL p200_upd_posflag_p("1","oea_file","td_sale",p_azw01)
      IF g_success = 'N' THEN
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Upd'||' '||'Table:td_sale'||' '||'Field:Condition2'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','01','TD_SALE',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'td_sale',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF
      
      #将临时表oea_temp插入到数据库中
      LET l_ins = " INSERT INTO ",cl_get_target_table(p_azw01,'oea_file'),
                  " SELECT * FROM oea_temp " 
      CALL cl_replace_sqldb(l_ins) RETURNING l_ins
      CALL cl_parse_qry_sql(l_ins,p_azw01) RETURNING l_ins
      PREPARE ins_oea_p_pre FROM l_ins
      EXECUTE ins_oea_p_pre
      IF SQLCA.sqlcode THEN 
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Ins'||' '||'Table:oea_file'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','01','TD_SALE',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'td_sale',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF 
         
      #将临时表oeb_temp插入到数据库中
      LET l_ins = " INSERT INTO ",cl_get_target_table(p_azw01,'oeb_file'),
                  " SELECT * FROM oeb_temp "
      CALL cl_replace_sqldb(l_ins) RETURNING l_ins
      CALL cl_parse_qry_sql(l_ins,p_azw01) RETURNING l_ins
      PREPARE ins_oeb_p_pre FROM l_ins
      EXECUTE ins_oeb_p_pre
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Ins'||' '||'Table:oeb_file'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','01','TD_SALE',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'td_sale',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF
         
      #将临时表rxx_temp插入到数据库中
      LET l_ins = " INSERT INTO ",cl_get_target_table(p_azw01,'rxx_file'),
                  " SELECT * FROM rxx_temp "
      CALL cl_replace_sqldb(l_ins) RETURNING l_ins
      CALL cl_parse_qry_sql(l_ins,p_azw01) RETURNING l_ins
      PREPARE ins_rxx_p_pre3 FROM l_ins
      EXECUTE ins_rxx_p_pre3
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Ins'||' '||'Table:rxx_file'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','01','TD_SALE',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'td_sale',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF

      #将临时表rxy_temp插入到数据库中
      LET l_ins = " INSERT INTO ",cl_get_target_table(p_azw01,'rxy_file'),
                  " SELECT * FROM rxy_temp "
      CALL cl_replace_sqldb(l_ins) RETURNING l_ins
      CALL cl_parse_qry_sql(l_ins,p_azw01) RETURNING l_ins
      PREPARE ins_rxy_p_pre3 FROM l_ins
      EXECUTE ins_rxy_p_pre3
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Ins'||' '||'Table:rxy_file'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','01','TD_SALE',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'td_sale',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF

      #将临时表rxz_temp插入到数据库中
      LET l_ins = " INSERT INTO ",cl_get_target_table(p_azw01,'rxz_file'),
                  " SELECT * FROM rxz_temp "
      CALL cl_replace_sqldb(l_ins) RETURNING l_ins
      CALL cl_parse_qry_sql(l_ins,p_azw01) RETURNING l_ins
      PREPARE ins_rxz_p_pre3 FROM l_ins
      EXECUTE ins_rxz_p_pre3
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Ins'||' '||'Table:rxz_file'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','01','TD_SALE',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'td_sale',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF
      
      #订单转请购
      LET l_sql="SELECT DISTINCT rye03 FROM ",cl_get_target_table(p_azw01,'rye_file'),
                " WHERE rye01 = 'apm' AND rye02 = '1' "
      CALL cl_replace_sqldb(l_sql) RETURNING l_sql
      CALL cl_parse_qry_sql(l_sql,p_azw01) RETURNING l_sql
      PREPARE sel_rye03_pre1 FROM l_sql
      EXECUTE sel_rye03_pre1 INTO l_rye03
      IF SQLCA.sqlcode OR cl_null(l_rye03) THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Sel'||' '||'Table:rye_file'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','01','TD_SALE',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'td_sale',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      ELSE
         IF g_ryz09 = 'Y' THEN
            INITIALIZE l_oea01,l_oea94 TO NULL
            LET l_sql = "SELECT oea01,oea94 FROM oea_temp ORDER BY oea01,oea94 "
            PREPARE sel_oea01_oea94_pre FROM l_sql
            DECLARE sel_oea01_oea94_cs CURSOR FOR sel_oea01_oea94_pre
            FOREACH sel_oea01_oea94_cs INTO l_oea01,l_oea94
               CALL t400sub_exp(l_oea01,l_rye03,p_azw01,l_oea94)
               IF g_success = 'N' THEN
                  ROLLBACK WORK
                  CONTINUE WHILE
               END IF
               INITIALIZE l_oea01,l_oea94 TO NULL
            END FOREACH
         END IF
      END IF
      
      IF g_success = 'Y' THEN
         LET g_sucflag = 1
         COMMIT WORK
      ELSE
         ROLLBACK WORK
      END IF
   END WHILE
  #FUN-CA0160 Add Begin ---
   #删除建立的临时表
   DROP TABLE oea_temp
   DROP TABLE oeb_temp
   DROP TABLE rxx_temp
   DROP TABLE rxy_temp
   DROP TABLE rxz_temp
  #FUN-CA0160 Add End -----
END FUNCTION
#FUN-CA0091 Add End -----

#FUN-CA0091 Add Begin ---
FUNCTION p200_oga_p_ins(p_gat01,p_azw01)
DEFINE p_gat01     LIKE gat_file.gat01
DEFINE p_azw01     LIKE azw_file.azw01
DEFINE p_azw02     LIKE azw_file.azw02
DEFINE l_ins       STRING
DEFINE l_upd       STRING
DEFINE l_sql       STRING
DEFINE l_sel       STRING
DEFINE l_oga01     LIKE oga_file.oga01
DEFINE l_oga03     LIKE oga_file.oga03
DEFINE l_oga032    LIKE oga_file.oga032
DEFINE l_oga02     LIKE oga_file.oga02
DEFINE l_ogaplant  LIKE oga_file.ogaplant
DEFINE l_date      LIKE oga_file.oga02
DEFINE l_oga11     LIKE oga_file.oga11
DEFINE l_oga12     LIKE oga_file.oga12
DEFINE l_oga98     LIKE oga_file.oga98
DEFINE l_oga16     LIKE oga_file.oga16
DEFINE l_oga23     LIKE oga_file.oga23
DEFINE l_oga24     LIKE oga_file.oga24
DEFINE l_i         LIKE type_file.num5
DEFINE l_num_len   LIKE type_file.num10
DEFINE l_num_str   LIKE type_file.chr20
DEFINE l_oga01_str STRING
DEFINE l_oga01_num LIKE type_file.chr20
DEFINE l_oga01_chr LIKE type_file.chr20
DEFINE l_cnt       LIKE type_file.num5
DEFINE l_oga02_old LIKE oga_file.oga02
DEFINE l_oga01_min LIKE oga_file.oga01
DEFINE l_oga01_max LIKE oga_file.oga01
DEFINE l_oga01_min_o LIKE oga_file.oga01
DEFINE l_oga01_max_o LIKE oga_file.oga01
DEFINE l_oga02_num LIKE type_file.num10
DEFINE l_azn05     LIKE azn_file.azn05
DEFINE l_azn05_old LIKE azn_file.azn05
DEFINE l_upd_num   LIKE type_file.num10
DEFINE l_saleno    STRING
DEFINE l_shop_field    LIKE type_file.chr100 #FUN-CC0082 Add
DEFINE l_shop_where    STRING                #FUN-CC0082 Add
DEFINE l_ordershop     LIKE oga_file.oga84   #FUN-CC0082 Add

  #FUN-CA0160 Mark Begin ---
  ##先删除需要建立的临时表
  #DROP TABLE oga_temp
  #DROP TABLE ogb_temp
  #DROP TABLE rxx_temp
  #DROP TABLE rxy_temp
  #DROP TABLE rxz_temp

  ##建立临时表
  #SELECT * FROM oga_file WHERE 1=0 INTO TEMP oga_temp
  #SELECT * FROM ogb_file WHERE 1=0 INTO TEMP ogb_temp
  #SELECT * FROM rxx_file WHERE 1=0 INTO TEMP rxx_temp
  #SELECT * FROM rxy_file WHERE 1=0 INTO TEMP rxy_temp
  #SELECT * FROM rxz_file WHERE 1=0 INTO TEMP rxz_temp

  ##建立索引
  #CREATE INDEX oga_temp_01 ON oga_temp (oga98)
  #CREATE INDEX oga_temp_02 ON oga_temp (oga15)
  #CREATE INDEX oga_temp_03 ON oga_temp (oga01)
  #CREATE INDEX ogb_temp_01 ON ogb_temp (ogb04)
  #CREATE INDEX ogb_temp_02 ON ogb_temp (ogb01,ogb03)
  #FUN-CA0160 Mark End -----

   #组出过滤条件
   IF NOT cl_null(g_saleno) THEN
      LET g_wc = " saleno = '",g_saleno,"' "
   ELSE
     #CALL p200_g_wc() RETURNING g_wc           #FUN-CA0160 Mark
      CALL p200_g_wc("oga_file") RETURNING g_wc #FUN-CA0160 Add
   END IF
   IF cl_null(g_wc) THEN LET g_wc = " 1=1" END IF

   SELECT azw02 INTO p_azw02 FROM azw_file WHERE azw01 = p_azw01
   
  #FUN-CA0160 Mark Begin ---
  ##清空临时表
  #DELETE FROM oga_temp
  #DELETE FROM ogb_temp
  #DELETE FROM rxx_temp
  #DELETE FROM rxy_temp
  #DELETE FROM rxz_temp
  #FUN-CA0160 Mark End -----

   #将中间库中符合条件的资料Condition2更新为B
   #非异店取货的资料
   LET l_shop_where = " Shop = '",p_azw01,"' AND (OrderShop IS NULL OR OrderShop = ' ' OR OrderShop = Shop) "
   LET l_upd = "UPDATE ",g_posdbs,"td_sale",g_db_links," ",
               "   SET Condition2 = 'B' ",
               " WHERE Condition2 <> 'Y' AND Type = '0' AND Cnfflg = 'Y' AND ",g_wc CLIPPED,
               "   AND ",l_shop_where CLIPPED
   PREPARE upd_td_sale_oga_pre FROM l_upd
   EXECUTE upd_td_sale_oga_pre
   IF SQLCA.sqlcode THEN
      LET g_success = 'N'
      LET g_errno   = SQLCA.sqlcode
      LET g_msg1    = 'Oper:Upd'||' '||'Table:td_sale'||' '||'Shop:'||p_azw01
      CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
      ROLLBACK WORK
      CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
      LET g_msg   = g_msg[1,255]
      CALL p200_log(g_trans_no,p_azw01,'Batch Operation','02','TD_SALE',g_errno,g_msg,'0','N',g_msg1)
      LET g_errno = ''
      LET g_msg   = ''
      LET g_msg1  = ''
      RETURN
   END IF

   LET l_upd_num = SQLCA.sqlerrd[3]
   IF l_upd_num <= 0 THEN RETURN END IF
   IF cl_null(g_sum_limit) OR g_sum_limit = 0 THEN LET g_sum_limit = l_upd_num END IF

  #FUN-CA0160 Add Begin ---
   #先删除需要建立的临时表
   DROP TABLE oga_temp
   DROP TABLE ogb_temp
   DROP TABLE rxx_temp
   DROP TABLE rxy_temp
   DROP TABLE rxz_temp

   #建立临时表
   SELECT * FROM oga_file WHERE 1=0 INTO TEMP oga_temp
   SELECT * FROM ogb_file WHERE 1=0 INTO TEMP ogb_temp
   SELECT * FROM rxx_file WHERE 1=0 INTO TEMP rxx_temp
   SELECT * FROM rxy_file WHERE 1=0 INTO TEMP rxy_temp
   SELECT * FROM rxz_file WHERE 1=0 INTO TEMP rxz_temp

   #建立索引
   CREATE INDEX oga_temp_01 ON oga_temp (oga98)
   CREATE INDEX oga_temp_02 ON oga_temp (oga15)
   CREATE INDEX oga_temp_03 ON oga_temp (oga01)
   CREATE INDEX ogb_temp_01 ON ogb_temp (ogb04)
   CREATE INDEX ogb_temp_02 ON ogb_temp (ogb01,ogb03)
  #FUN-CA0160 Add End -----

   WHILE l_upd_num > 0
      LET l_upd_num = l_upd_num - g_sum_limit

     #清空临时表
      DELETE FROM oga_temp
      DELETE FROM ogb_temp
      DELETE FROM rxx_temp
      DELETE FROM rxy_temp
      DELETE FROM rxz_temp

      LET g_success = 'Y'
      BEGIN WORK


      #ins oga_temp开始
      LET l_ins = "INSERT INTO oga_temp(",
                  "                      oga00, ",          #出货别
                  "                      oga01, ",          #出货单号/出通单号
                  "                      oga02, ",          #出货日期
                  "                      oga03, ",          #账款客户编号
                  "                      oga032, ",         #账款客户简称
                  "                      oga04, ",          #送货客户编号
                  "                      oga044, ",         #送货地址码
                  "                      oga05, ",          #发票别
                  "                      oga06, ",          #更改版本
                  "                      oga07, ",          #出货是否计入未开发票的销货待验收入
                  "                      oga08, ",          #1.内销 2.外销  3.视同外销
                  "                      oga09, ",          #单据别
                  "                      oga11, ",          #应收款日
                  "                      oga12, ",          #容许票据到期日
                  "                      oga14, ",          #人员编号
                  "                      oga15, ",          #部门编号
                  "                      oga16, ",          #订单单号
                  "                      oga161, ",         #订金应收比率
                  "                      oga162, ",         #出货应收比率
                  "                      oga163, ",         #尾款应收比率
                  "                      oga18, ",          #收款客户编号
                  "                      oga20, ",          #分录底稿是否可重新生成
                  "                      oga21, ",          #税种
                  "                      oga211, ",         #税率
                  "                      oga212, ",         #联数
                  "                      oga213, ",         #含税否
                  "                      oga23, ",          #币种
                  "                      oga24, ",          #汇率
                  "                      oga25, ",          #销售分类一
                  "                      oga30, ",          #包装单审核码
                  "                      oga31, ",          #价格条件编号
                  "                      oga32, ",          #收款条件编号
                  "                      oga33, ",          #其它条件
                  "                      oga41, ",          #起运地
                  "                      oga42, ",          #到达地
                  "                      oga43, ",          #交运方式
                  "                      oga50, ",          #原币出货金额
                  "                      oga501, ",         #本币出货金额
                  "                      oga51, ",          #原币出货金额
                  "                      oga511, ",         #本币出货金额
                  "                      oga52, ",          #原币预收订金转销货收入金额
                  "                      oga53, ",          #原币应开发票税前金额
                  "                      oga54, ",          #原币已开发票税前金额
                  "                      oga55, ",          #状况码
                  "                      oga57, ",          #发票性质
                  "                      oga65, ",          #客户出货签收否
                  "                      oga69, ",          #录入日期
                  "                      oga83, ",          #销货营运中心
                  "                      oga84, ",          #取货营运中心
                  "                      oga85, ",          #结算方式
                  "                      oga87, ",          #会员卡号
                  "                      oga88, ",          #顾客姓名
                  "                      oga89, ",          #联系电话
                  "                      oga90, ",          #证件类型
                  "                      oga903, ",         #信用检查放行否
                  "                      oga909, ",         #三角贸易否
                  "                      oga91, ",          #证件号码
                  "                      oga94, ",          #POS销售否 Y-是,N-否
                  "                      oga95, ",          #本次积分
                  "                      oga96, ",          #收银机号
                  "                      oga98, ",          #POS单号
                  "                      oga1005, ",        #是否计算业绩
                  "                      oga1008, ",        #出货总含税金额
                  "                      oga1014, ",        #调货销退单所自动生成否
                  "                      ogaconf, ",        #审核否/作废码
                  "                      ogacond, ",        #审核日期
                  "                      ogacont, ",        #审核时间
                  "                      ogaconu, ",        #审核人员
                  "                      ogadate, ",        #最近更改日
                  "                      ogagrup, ",        #资料所有部门
                  "                      ogaoriu, ",        #资料建立者
                  "                      ogaorig, ",        #资料建立部门
                  "                      ogaplant, ",       #所属营运中心
                  "                      ogalegal, ",       #所属法人
                  "                      ogamksg, ",        #签核
                  "                      ogapost, ",        #出货扣账否
                  "                      ogaprsw, ",        #打印次数
                  "                      ogauser) "         #资料所有者
                  
      LET l_sel = "SELECT ",
                  "       '1', ",                                                                               #oga00          #出货别
                  "       CAST ((ROW_NUMBER() over(order by Bdate,Saleno)) AS VARCHAR2(20)), ",                 #oga01          #出货单号/出通单号
                  "       CAST (bdate AS DATE), ",                                                              #oga02          #出货日期
                  "       CASE WHEN cardno IS NOT NULL THEN lpk20 ELSE rtz06 END, ",                            #oga03          #账款客户编号
                  "       occ02, ",                                                                             #oga032         #账款客户简称
                  "       occ09, ",                                                                             #oga04          #送货客户编号
                  "       'MISC', ",                                                                            #oga044         #送货地址码
                  "       '1', ",                                                                               #oga05          #发票别
                  "       '0', ",                                                                               #oga06          #更改版本
                  "       'N', ",                                                                               #oga07          #出货是否计入未开发票的销货待验收入
                  "       '1', ",                                                                               #oga08          #1.内销 2.外销  3.视同外销
                  "       '2', ",                                                                               #oga09          #单据别
                  "       NULL, ",                                                                              #oga11          #应收款日
                  "       NULL, ",                                                                              #oga12          #容许票据到期日
                  "       ryi02, ",                                                                             #oga14          #人员编号
                  "       gen03, ",                                                                             #oga15          #部门编号
                  "       CASE WHEN otype = '1' THEN ofno ELSE NULL END, ",                                     #oga16          #订单单号
                  "       0, ",                                                                                 #oga161         #订金应收比率
                  "       100, ",                                                                               #oga162         #出货应收比率
                  "       0, ",                                                                                 #oga163         #尾款应收比率
                  "       CASE WHEN cardno IS NOT NULL THEN lpk20 ELSE rtz06 END, ",                            #oga18          #收款客户编号
                  "       'N', ",                                                                               #oga20          #分录底稿是否可重新生成
                  "       occ41, ",                                                                             #oga21          #税种
                  "       gec04, ",                                                                             #oga211         #税率
                  "       gec05, ",                                                                             #oga212         #联数
                  "       gec07, ",                                                                             #oga213         #含税否
                  "       occ42, ",                                                                             #oga23          #币种
                  "       NULL, ",                                                                              #oga24          #汇率
                  "       occ43, ",                                                                             #oga25          #销售分类一
                  "       'N', ",                                                                               #oga30          #包装单审核码
                  "       occ44, ",                                                                             #oga31          #价格条件编号
                  "       occ45, ",                                                                             #oga32          #收款条件编号
                  "       occ46, ",                                                                             #oga33          #其它条件
                  "       occ48, ",                                                                             #oga41          #起运地
                  "       occ49, ",                                                                             #oga42          #到达地
                  "       occ47, ",                                                                             #oga43          #交运方式
                  "       tot_uamt, ",                                                                          #oga50          #原币出货金额
                  "       NULL, ",                                                                              #oga501         #本币出货金额
                  "       tot_amt, ",                                                                           #oga51          #原币出货金额
                  "       NULL, ",                                                                              #oga511         #本币出货金额
                  "       0, ",                                                                                 #oga52          #原币预收订金转销货收入金额
                  "       tot_uamt, ",                                                                          #oga53          #原币应开发票税前金额
                  "       0, ",                                                                                 #oga54          #原币已开发票税前金额
                  "       '1', ",                                                                               #oga55          #状况码
                  "       '1', ",                                                                               #oga57          #发票性质
                  "       'N', ",                                                                               #oga65          #客户出货签收否
                  "       CAST (sdate AS DATE), ",                                                              #oga69          #录入日期
                  "       shop, ",                                                                              #oga83          #销货营运中心
                  "       getshop, ",                                                                           #oga84          #取货营运中心
                  "       '1', ",                                                                               #oga85          #结算方式
                  "       cardno, ",                                                                            #oga87          #会员卡号
                  "       contman, ",                                                                           #oga88          #顾客姓名
                  "       conttel, ",                                                                           #oga89          #联系电话
                  "       CASE WHEN cardno IS NOT NULL THEN lpk02 ELSE NULL END, ",                             #oga90          #证件类型
                  "       'N', ",                                                                               #oga903         #信用检查放行否
                  "       'N', ",                                                                               #oga909         #三角贸易否
                  "       CASE WHEN cardno IS NOT NULL THEN lpk03 ELSE NULL END, ",                             #oga91          #证件号码
                  "       'Y', ",                                                                               #oga94          #POS销售否 Y-是,N-否
                  "       point_qty, ",                                                                         #oga95          #本次积分
                  "       machine, ",                                                                           #oga96          #收银机号
                  "       saleno, ",                                                                            #oga98          #POS单号
                  "       'N', ",                                                                               #oga1005        #是否计算业绩
                  "       tot_amt, ",                                                                           #oga1008        #出货总含税金额
                  "       'N', ",                                                                               #oga1014        #调货销退单所自动生成否
                  "       'Y', ",                                                                               #ogaconf        #审核否/作废码
                  "       CAST (sdate AS DATE), ",                                                              #ogacond        #审核日期
                  "       stime[1,2]||':'||stime[3,4]||':'||stime[5,6], ",                                      #ogacont        #审核时间
                  "       ryi02, ",                                                                             #ogaconu        #审核人员
                  "       CAST (sdate AS DATE), ",                                                              #ogadate        #最近更改日
                  "       gen03, ",                                                                             #ogagrup        #资料所有部门
                  "       ryi02, ",                                                                             #ogaoriu        #资料建立者
                  "       gen03, ",                                                                             #ogaorig        #资料建立部门
                  "       shop, ",                                                                              #ogaplant       #所属营运中心
                  "       '",p_azw02,"', ",                                                                     #ogalegal       #所属法人
                  "       'N', ",                                                                               #ogamksg        #签核
                  "       'Y', ",                                                                               #ogapost        #出货扣账否
                  "       0, ",                                                                                 #ogaprsw        #打印次数
                  "       ryi02 ",                                                                              #ogauser        #资料所有者
                  "  FROM ( ",
                  "SELECT * ",
                  "  FROM ",g_posdbs,"td_sale",g_db_links," ",
                 #" WHERE type = '0' AND cnfflg = 'Y' AND condition2 = 'B' AND shop = '",p_azw01,"' ",  #FUN-CC0082 Mark
                  " WHERE type = '0' AND cnfflg = 'Y' AND condition2 = 'B' AND ",l_shop_where CLIPPED,  #FUN-CC0082 Add
                  " ORDER BY bdate,saleno )"," LEFT OUTER JOIN ",cl_get_target_table(p_azw01,'rtz_file'),
                  "                                         ON rtz01 = shop ",
                  "                            LEFT OUTER JOIN ",cl_get_target_table(p_azw01,'lpj_file'),
                  "                                         ON lpj03 = cardno ",
                  "                            LEFT OUTER JOIN ",cl_get_target_table(p_azw01,'lpk_file'),
                  "                                         ON lpk01 = lpj01 ",
                  "                            LEFT OUTER JOIN ",cl_get_target_table(p_azw01,'occ_file'),
                  "                                         ON lpk20 = occ01 OR occ01 = rtz06 ",
                  "                            LEFT OUTER JOIN ",cl_get_target_table(p_azw01,'ryi_file'),
                  "                                         ON ryi01 = opno ",
                  "                            LEFT OUTER JOIN ",cl_get_target_table(p_azw01,'gen_file'),
                  "                                         ON gen01 = ryi02 ",
                  "                            LEFT OUTER JOIN ",cl_get_target_table(p_azw01,'gec_file'),
                  "                                         ON gec01 = occ41 AND gec011 = '2' ",
                  " WHERE ROWNUM <= ",g_sum_limit," ",
                  " ORDER BY bdate,saleno "
      LET l_sql = l_ins CLIPPED," ",l_sel CLIPPED
      CALL cl_replace_sqldb(l_sql) RETURNING l_sql
     #CALL cl_parse_qry_sql(l_sql,p_azw01) RETURNING l_sql
      PREPARE ins_oga_temp_pre FROM l_sql
      EXECUTE ins_oga_temp_pre
      IF SQLCA.sqlcode OR SQLCA.sqlerrd[3] = 0 THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Upd'||' '||'Table:td_sale'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','02','TD_SALE',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
        #RETURN         #FUN-CA0160 Mark
         CONTINUE WHILE #FUN-CA0160 Add
      END IF

      INITIALIZE l_oga02_old,l_oga01_min_o,l_oga01_max_o,l_azn05_old TO NULL
      INITIALIZE l_oga02,l_oga02_num,l_oga01_min,l_oga01_max,l_azn05 TO NULL
      LET l_sql = "SELECT DISTINCT MIN(to_number(oga01)),oga02,MAX(to_number(oga01)) FROM oga_temp GROUP BY oga02 ORDER by oga02"
      PREPARE sel_oga02_pre FROM l_sql
      DECLARE sel_oga02_cs CURSOR FOR sel_oga02_pre
      FOREACH sel_oga02_cs INTO l_oga01_min,l_oga02,l_oga01_max

         #自动编号
         LET g_ndate = l_oga02
        #CALL p200_auto_doc(p_gat01,p_azw01) RETURNING l_oga01     #FUN-CC0082 Mark
         CALL p200_auto_doc(p_gat01,p_azw01,'Y') RETURNING l_oga01 #FUN-CC0082 Add
         IF g_success = 'N' THEN
            RETURN
         END IF
         CASE g_ryz05
            WHEN "1"
               LET l_num_len = 8
            WHEN "2"
               LET l_num_len = 9
            WHEN "3"
               LET l_num_len = 10
         END CASE 

         CASE g_ryz06
            WHEN "1"
               LET l_num_len = l_num_len
               IF NOT cl_null(l_oga02_old) THEN
                  #已排流水号个数   最大流水号旧值  最小流水号旧值      上一笔已排流水号个数
                  LET l_oga02_num = l_oga01_max_o - l_oga01_min_o + 1 + l_oga02_num
               ELSE
                  LET l_oga02_num = 0
               END IF
            WHEN "2"
               LET l_num_len = l_num_len - 4
               IF NOT cl_null(l_oga02_old) THEN
                  IF YEAR(l_oga02_old) = YEAR(l_oga02) AND MONTH(l_oga02_old) = MONTH(l_oga02) THEN
                     LET l_oga02_num = l_oga01_max_o - l_oga01_min_o + 1 + l_oga02_num
                  ELSE
                     LET l_oga02_num = 0
                  END IF
               ELSE
                  LET l_oga02_num = 0
               END IF
            WHEN "3"
               LET l_num_len = l_num_len - 4
               IF NOT cl_null(l_oga02_old) THEN
                  INITIALIZE l_azn05 TO NULL
                  SELECT azn05 INTO l_azn05 FROM azn_file WHERE azn01 = l_oga02 #抓取周
                  IF YEAR(l_oga02_old) = YEAR(l_oga02) AND l_azn05_old = l_azn05 THEN
                     LET l_oga02_num = l_oga01_max_o - l_oga01_min_o + 1 + l_oga02_num
                  ELSE
                     LET l_oga02_num = 0
                  END IF
               ELSE
                  LET l_oga02_num = 0
               END IF
            WHEN "4"
               LET l_num_len = l_num_len - 6
              #FUN-D30061 Mark&Add Begin ---
              #IF NOT cl_null(l_oga02_old) THEN
              #   LET l_oga02_num = l_oga01_max_o - l_oga01_min_o + 1 + l_oga02_num
              #ELSE
              #   LET l_oga02_num = 0
              #END IF
               LET l_oga02_num = 0
              #FUN-D30061 Mark&Add End -----
         END CASE
         LET l_oga01_min_o = l_oga01_min
         LET l_oga01_max_o = l_oga01_max
         LET l_azn05_old   = l_azn05
         LET l_oga02_old   = l_oga02

         INITIALIZE l_num_str TO NULL  #格式字串
         FOR l_cnt = 1 TO l_num_len
            LET l_num_str = l_num_str CLIPPED,'0'
         END FOR
         LET l_oga01_str = l_oga01
         LET l_oga01_num = l_oga01_str.subString(l_oga01_str.getLength() - l_num_len + 1,l_oga01_str.getLength())
         LET l_oga01_chr = l_oga01_str.subString(1,l_oga01_str.getLength() - l_num_len)

         #   最大流水号    实际流水号    最小ROWNUM    已排流水号个数
         LET l_oga01_num = l_oga01_num - l_oga01_min + l_oga02_num

         #批次更新oga_temp中的单号
         LET l_upd = "UPDATE oga_temp SET oga01 = '",l_oga01_chr CLIPPED,"'||","substr(to_char","((oga01 + '",l_oga01_num,"'),'",l_num_str,"'),2) ",
                     " WHERE oga02 = '",l_oga02,"' "
         PREPARE upd_oga01_pre FROM l_upd
         EXECUTE upd_oga01_pre 
         IF SQLCA.sqlcode THEN
            LET g_success = 'N'
            LET g_errno   = SQLCA.sqlcode
            LET g_msg1    = 'Oper:Upd'||' '||'Table:oga_temp'||' '||'Field:oga01'||' '||'Shop:'||p_azw01
            CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
            ROLLBACK WORK
            CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
            LET g_msg   = g_msg[1,255]
            CALL p200_log(g_trans_no,p_azw01,'Batch Operation','02','TD_SALE',g_errno,g_msg,'0','N',g_msg1)
            LET g_errno = ''
            LET g_msg   = ''
            LET g_msg1  = ''
            CONTINUE WHILE
         END IF
      END FOREACH

      #存在订单未上传
      LET l_cnt = 0
      LET l_sql = "SELECT COUNT(*) ",
                  "  FROM ",g_posdbs,"td_sale",g_db_links," ",
                  " WHERE Condition2 <> 'Y' AND type = '3' AND shop = '",p_azw01,"' AND EXISTS (SELECT 1 FROM oga_temp WHERE oga16 = saleno AND oga16 IS NOT NULL)"
      PREPARE sel_oga_oea_pre FROM l_sql
      EXECUTE sel_oga_oea_pre INTO l_cnt
      IF l_cnt > 0 THEN
         LET g_errno   = 'apc1052' #该批次单据中存在来源订单未上传,请先上传订单
         LET g_msg1    = 'Oper:Chk'||' '||'Table:oga_temp'||' '||'Shop:'||p_azw01
        #CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1) #FUN-CB0103 Mark
         CALL s_errmsg('Batch Operation:','',g_msg1,g_errno,1)       #FUN-CB0103 Add
        #ROLLBACK WORK #FUN-D10023 Mark
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','02','TD_SALE',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
      END IF   

      #更新中间库状态为A
      LET l_upd = "UPDATE ",g_posdbs,"td_sale",g_db_links," a ",
                  "   SET a.Condition2 = 'A' ",
                  " WHERE a.Shop = '",p_azw01,"' AND a.Type = '0' ",
                  "   AND a.Saleno IN (SELECT oga98 ",
                  "                      FROM oga_temp ",
                  "                     WHERE EXISTS (SELECT 1 FROM ",g_posdbs,"td_sale",g_db_links," b ",
                  "                                    WHERE b.Condition2 <> 'Y' ",
                  "                                      AND b.Type = '3' AND b.Shop = '",p_azw01,"' ",
                  "                                      AND oga16 = b.Saleno) ",
                  "                       AND oga16 IS NOT NULL) "
      PREPARE upd_td_sale_flag_oga_pre1 FROM l_upd
      EXECUTE upd_td_sale_flag_oga_pre1

      #删除来源订单未上传的单据
      LET l_sql = "DELETE FROM oga_temp ",
                  " WHERE EXISTS (SELECT 1 FROM ",g_posdbs,"td_sale",g_db_links," ",
                  "                WHERE Condition2 <> 'Y' ",
                  "                  AND type = '3' AND shop = '",p_azw01,"' ",
                  "                  AND oga16 = saleno) ",
                  "   AND oga16 IS NOT NULL "
      PREPARE del_oga_temp_pre FROM l_sql
      EXECUTE del_oga_temp_pre

     #FUN-D10023 Add Begin ---
      #来源订单不存在
      LET l_cnt = 0
      LET l_sql = "SELECT COUNT(*) ",
                  "  FROM oga_temp ",
                  " WHERE oga16 NOT IN (SELECT Saleno FROM ",g_posdbs,"td_Sale",g_db_links," ",
                  "                      WHERE Type = '3' AND Shop = '",p_azw01,"') ",
                  "   AND oga16 IS NOT NULL "
      PREPARE sel_oga_oea_pre2 FROM l_sql
      EXECUTE sel_oga_oea_pre2 INTO l_cnt
      IF l_cnt > 0 THEN
         LET g_errno   = 'apc1052' #该批次单据中存在来源订单未上传,请先上传订单
         LET g_msg1    = 'Oper:Chk'||' '||'Table:oga_temp'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,g_errno,1)
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','02','TD_SALE',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
      END IF

      #更新中间库状态为A
      LET l_upd = "UPDATE ",g_posdbs,"td_sale",g_db_links," a ",
                  "   SET a.Condition2 = 'A' ",
                  " WHERE a.Shop = '",p_azw01,"' AND a.Type = '0' ",
                  "   AND a.Saleno IN (SELECT oga98 ",
                  "                      FROM oga_temp ",
                  "                     WHERE oga16 NOT IN (SELECT b.Saleno FROM ",g_posdbs,"td_Sale",g_db_links," b ",
                  "                                          WHERE b.Type = '3' AND b.Shop = '",p_azw01,"') ",
                  "                       AND oga16 IS NOT NULL) "
      PREPARE upd_td_sale_flag_oga_pre4 FROM l_upd
      EXECUTE upd_td_sale_flag_oga_pre4

      #删除来源订单未上传的单据
      LET l_sql = "DELETE FROM oga_temp ",
                  " WHERE oga16 NOT IN (SELECT Saleno FROM ",g_posdbs,"td_Sale",g_db_links," ",
                  "                      WHERE Type = '3' AND Shop = '",p_azw01,"') ",
                  "   AND oga16 IS NOT NULL "
      PREPARE del_oga_temp_pre2 FROM l_sql
      EXECUTE del_oga_temp_pre2
     #FUN-D10023 Add End -----

      #检查出货单单据日期
      INITIALIZE l_oga02 TO NULL
      SELECT MIN(oga02) INTO l_oga02 FROM oga_temp WHERE oga02 <= g_sma.sma53
      IF NOT cl_null(l_oga02) THEN
         LET g_errno   = 'apc1054' #该批次资料中存在最小单据日期小于等于关帐日期
         LET g_msg1    = 'Oper:Chk'||' '||'Table:oga_temp'||' '||'MIN(oga02):'||l_oga02||' '||'Shop:'||p_azw01
        #CALL s_errmsg('Batch Operation','',g_msg1,SQLCA.sqlcode,1) #FUN-CB0103 Mark
         CALL s_errmsg('Batch Operation','',g_msg1,g_errno,1)       #FUN-CB0103 Add
        #ROLLBACK WORK #FUN-D10023 Mark
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','02','TD_SALE',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
      END IF

      #更新中间库状态为A
      LET l_upd = "UPDATE ",g_posdbs,"td_sale",g_db_links," ",
                  "   SET Condition2 = 'A' ",
                  " WHERE Shop = '",p_azw01,"' ",
                  "   AND EXISTS (SELECT 1 ",
                  "                 FROM oga_temp ",
                  "                WHERE oga02 <= '",g_sma.sma53,"' ",
                  "                  AND oga98 = Saleno) "
      PREPARE upd_td_sale_flag_oga_pre2 FROM l_upd
      EXECUTE upd_td_sale_flag_oga_pre2

      #删除出货日期小于等于关帐日期的资料
      DELETE FROM oga_temp WHERE oga02 <= g_sma.sma53

      #如果来源订单单号不为空,则回写中间库该订单的结案码与结案日期
      LET l_upd = "UPDATE ",g_posdbs,"td_sale",g_db_links," ",
                  "   SET ecsflg = 'Y', ",
                 #"       ecsdate = (SELECT CAST(oga02 AS NVARCHAR2(8)) FROM oga_temp ",                                #FUN-CB0103 Mark
                  "       ecsdate = (SELECT CAST(",cl_tp_tochar("oga02",'YYYYMMDD')," AS NVARCHAR2(8)) FROM oga_temp ", #FUN-CB0103 Add
                  "                   WHERE oga16 IS NOT NULL ",
                  "                     AND oga16 = saleno AND shop = ogaplant) ",
                  " WHERE EXISTS (SELECT 1 FROM oga_temp ",
                  "                WHERE oga16 IS NOT NULL ",
                  "                  AND oga16 = saleno AND shop = ogaplant) "
      PREPARE upd_ecsflg_p_pre FROM l_upd
      EXECUTE upd_ecsflg_p_pre
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Upd'||' '||'Table:td_sale'||' '||'Field:(ecsflg/ecsdate)'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','02','TD_SALE',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'td_sale',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF

     ####################################################################
     #更新订单单号
      LET l_upd = "UPDATE oga_temp SET oga16 = (SELECT oea01 FROM oea_file WHERE oea94 = oga16 ",
                  "                                                          AND oeaplant = '",p_azw01,"' ), ",  #TQC-D30070 add
                  "                    oga161 = (SELECT oea161 FROM oea_file WHERE oea94 = oga16 ",
                  "                                                            AND oeaplant = '",p_azw01,"' ), ",  #TQC-D30070 add
                  "                    oga162 = oga162 - (SELECT oea161 FROM oea_file WHERE oea94 = oga16  ",
                  "                                                                     AND oeaplant = '",p_azw01,"' )  ",  #TQC-D30070 add
                  " WHERE oga16 IS NOT NULL "
     #PREPARE upd_oga16_pre FROM l_sql #FUN-CB0103 Mark
      PREPARE upd_oga16_pre FROM l_upd #FUN-CB0103 Add
      EXECUTE upd_oga16_pre
      IF SQLCA.sqlcode THEN
      END IF
     ####################################################################

     #更新汇率
      LET l_sql = "SELECT DISTINCT oga23,oga02 FROM oga_temp ORDER BY oga23,oga02 "
      PREPARE sel_oga23_pre FROM l_sql
      DECLARE sel_oga23_cs CURSOR FOR sel_oga23_pre
      FOREACH sel_oga23_cs INTO l_oga23,l_oga02
         CALL s_currm(l_oga23,l_oga02,g_oaz.oaz52,p_azw01) RETURNING l_oga24
         UPDATE oga_temp SET oga24 = l_oga24 WHERE oga23 = l_oga23 AND oga02 = l_oga02
         IF SQLCA.sqlcode THEN
            LET g_success = 'N'
            LET g_errno   = SQLCA.sqlcode
            LET g_msg1    = 'Oper:Upd'||' '||'Table:oga_temp'||' '||'Field:oga24'||' '||'Shop:'||p_azw01
            CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
            ROLLBACK WORK
            CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
            LET g_msg   = g_msg[1,255]
            CALL p200_log(g_trans_no,p_azw01,'Batch Operation','02','TD_SALE',g_errno,g_msg,'0','N',g_msg1)
            LET g_errno = ''
            LET g_msg   = ''
            LET g_msg1  = ''
            CALL p200_upd_posflag_p('2',p_gat01,'td_sale',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
            CONTINUE WHILE
         END IF
      END FOREACH
     ######################################################################################
     #更新应收款日与票据到期日
      #1.来源订单为空 
      LET l_sql = "SELECT DISTINCT oga03,oga032,oga02,ogaplant,oga02 ",
                  "  FROM oga_temp ",
                  " WHERE oga16 IS NULL "
      PREPARE sel_oga_temp_pre1 FROM l_sql
      DECLARE sel_oga_temp_cs1 CURSOR FOR sel_oga_temp_pre1
      FOREACH sel_oga_temp_cs1 INTO l_oga03,l_oga032,l_oga02,l_ogaplant,l_date
         CALL s_rdatem(l_oga03,l_oga032,l_oga02,l_oga02,l_date,p_azw01)
            RETURNING l_oga11,l_oga12
         LET l_upd = "UPDATE oga_temp ",
                     "   SET oga11 = '",l_oga11,"', ",
                     "       oga12 = '",l_oga12,"'  ",
                     " WHERE oga03 = '",l_oga03,"' ",
                     "   AND oga032 = '",l_oga032,"' ",
                     "   AND oga02 = '",l_oga02,"' ",
                     "   AND ogaplant = '",l_ogaplant,"' ",
                     "   AND oga16 IS NULL "
         PREPARE upd_oga_temp_pre1 FROM l_upd
         EXECUTE upd_oga_temp_pre1
         IF SQLCA.sqlcode THEN
            LET g_success = 'N'
            LET g_errno   = SQLCA.sqlcode
            LET g_msg1    = 'Oper:Upd'||' '||'Table:oga_temp'||' '||'Field:(oga11/oga12)'||' '||'Shop:'||p_azw01
            CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
            ROLLBACK WORK
            CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
            LET g_msg   = g_msg[1,255]
            CALL p200_log(g_trans_no,p_azw01,'Batch Operation','02','TD_SALE',g_errno,g_msg,'0','N',g_msg1)
            LET g_errno = ''
            LET g_msg   = ''
            LET g_msg1  = ''
            CALL p200_upd_posflag_p('2',p_gat01,'td_sale',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
            CONTINUE WHILE
         END IF
      END FOREACH   
      #2.来源订单不为空
      LET l_sql = "SELECT DISTINCT oga03,oga032,oga02,ogaplant,oea02 ",
                  "  FROM oga_temp ",
                  "  LEFT OUTER JOIN oea_file ON oea01 = oga16 ",
                  " WHERE oga16 IS NOT NULL "
      PREPARE sel_oga_temp_pre2 FROM l_sql
      DECLARE sel_oga_temp_cs2 CURSOR FOR sel_oga_temp_pre2
      FOREACH sel_oga_temp_cs2 INTO l_oga03,l_oga032,l_oga02,l_ogaplant,l_date
         CALL s_rdatem(l_oga03,l_oga032,l_oga02,l_oga02,l_date,p_azw01)
            RETURNING l_oga11,l_oga12
         LET l_upd = "UPDATE oga_temp ",
                     "   SET oga11 = '",l_oga11,"', ",
                     "       oga12 = '",l_oga12,"'  ",
                     " WHERE oga03 = '",l_oga03,"' ",
                     "   AND oga032 = '",l_oga032,"' ",
                     "   AND oga02 = '",l_oga02,"' ",
                     "   AND ogaplant = '",l_ogaplant,"' ",
                     "   AND EXISTS (SELECT 1 ",
                     "                 FROM ",cl_get_target_table(p_azw01,'oea_file'),
                     "                WHERE oea01 = oga16 AND oea02 = '",l_date,"') "
         PREPARE upd_oga_temp_pre2 FROM l_upd
         EXECUTE upd_oga_temp_pre2
         IF SQLCA.sqlcode THEN
            LET g_success = 'N'
            LET g_errno   = SQLCA.sqlcode
            LET g_msg1    = 'Oper:Upd'||' '||'Table:oga_temp'||' '||'Field:(oga11/oga12)'||' '||'Shop:'||p_azw01
            CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
            ROLLBACK WORK
            CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
            LET g_msg   = g_msg[1,255]
            CALL p200_log(g_trans_no,p_azw01,'Batch Operation','02','TD_SALE',g_errno,g_msg,'0','N',g_msg1)
            LET g_errno = ''
            LET g_msg   = ''
            LET g_msg1  = ''
            CALL p200_upd_posflag_p('2',p_gat01,'td_sale',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
            CONTINUE WHILE
         END IF
      END FOREACH
     ######################################################################################

      #ins ogb_temp 开始
      LET l_sql = " INSERT INTO ogb_temp ",
                  "   (ogb01,   ogb03,   ogb04,   ogb05,   ogb12,     ogb13,    ogb14,   ogb14t,  ogb16,   ogb18, ",
                  "    ogb31,   ogb32,   ogb64,   ogb916,  ogb917,    ogbplant, ogblegal,ogb47,   ogb48,   ogb37, ",
                  "    ogb40,   ogb17,   ogb19,   ogb50,   ogb51,     ogb52,    ogb53,   ogb54,   ogb55,   ogb60, ",
                  "    ogb63,   ogb1005, ogb1012, ogb08,   ogb05_fac, ogb15_fac,ogb06,   ogb15,   ogb09,   ogb44, ",
                  "    ogb45,   ogb46) ",
                  " SELECT ",
                  " oga01, ",                                         #ogb01    出貨單號
                  " item,",                                           #ogb03    項次
                  " CASE WHEN featureno IS NULL THEN pluno WHEN featureno = ' ' THEN pluno ELSE featureno END, ",   #oeb04    產品編號
                  " unit, ",                                          #ogb05    銷售單位
                  " qty, ",                                           #ogb12    實際出貨數量
                  " price,",                                          #ogb13    原幣單價
                  " uamt, ",                                          #ogb14    原幣未稅金額
                  " amt, ",                                           #ogb14t   原幣含稅金額
                  " qty, ",                                           #ogb16    數量
                  " qty, ",                                           #ogb18    預計出貨數量
                  " oga16, ",                                         #ogb31    訂單單號
                  " CASE WHEN oga16 IS NOT NULL THEN oitem ELSE NULL END, ",                                         #ogb32    訂單項次
                 #" rqty, ",                                          #ogb64    銷退數量 #FUN-C80079 Mark
                  " 0, ",                                             #ogb64    銷退數量 #FUN-C80079 Add #財務要求
                  " unit, ",                                          #ogb916   計價單位
                  " qty, ",                                           #ogb917   計價數量
                  " shop, ",                                          #ogbplant 所屬工廠
                  " ogalegal, ",                                      #ogblegal 所屬法人
                  " COALESCE(disc,0), ",                              #ogb47    分攤折價
                  " counterno, ",                                     #ogb48    攤位編號
                  " oldprice, ",                                      #ogb37    基礎單价
                  " mno,",                                            #ogb40    抽成代號
                  " 'N',",                                            #ogb17    多倉儲批出貨否
                  " 'N',",                                            #ogb19    檢驗否
                  " 0,  ",                                            #ogb50    開票性質
                  " 0,  ",                                            #ogb51    已簽退數量
                  " 0,  ",                                            #ogb52    簽退數量
                  " 0,  ",                                            #ogb53    單位一驗退數量
                  " 0,  ",                                            #ogb54    單位二驗退數量
                  " 0,  ",                                            #ogb55    驗退計價數量
                  " 0,  ",                                            #ogb60    已開發票數量
                  " 0,  ",                                            #ogb63    銷退數量
                  " '1',",                                            #ogb1005  作業方式
                  " 'N', ",                                           #ogb1012  搭贈
                  " oga84, ",                                         #ogb08    出货营运中心编号
                 #" CASE WHEN unit = ima25 THEN 1 ELSE 0 END,",       #ogb05_fac销售/库存汇总单位换算率
                  " 1, ",                                             #ogb05_fac销售/库存汇总单位换算率
                 #" CASE WHEN unit = ima25 THEN 1 ELSE 0 END,",       #ogb15_fac销售/库存明细单位换算率
                  " 1, ",                                             #ogb15_fac销售/库存明细单位换算率
                 #" ima02, ",                                         #ogb06    品名规格
                  " NULL, ",                                          #ogb06    品名规格
                 #" ima25, ",                                         #ogb15    库存单位
                  " NULL, ",                                          #ogb15    库存单位
                  " '",g_rtz07,"',",                                  #ogb09    出货仓库编号
                 #" COALESCE(rty06,'1'),",                            #ogb44    经营方式
                  " '1',",                                            #ogb44    经营方式
                  " '',",                                             #ogb45    原扣率
                  " '' ",                                             #ogb46    新扣率
                  " FROM ",g_posdbs,"td_sale_detail",g_db_links," ",
                 #"        LEFT OUTER JOIN ",cl_get_target_table(p_azw01,'rty_file'),
                 #"                     ON (rty01 = '",p_azw01,"' ",
                 #"                     AND rty02 = (CASE WHEN featureno IS NULL THEN pluno WHEN featureno = ' ' THEN pluno ELSE featureno END))",
                 #"        LEFT OUTER JOIN ",cl_get_target_table(p_azw01,'ima_file'),
                 #"                     ON (ima01 = featureno OR ((featureno=' ' OR featureno IS NULL) AND ima01 = pluno))",
                  "     ,oga_temp ", 
                  " WHERE shop = '",p_azw01,"' ",
                  "   AND cnfflg = 'Y' AND saleno = oga98 " #FUN-CA0160 Add
                 #"   AND cnfflg = 'Y' AND saleno = oga98 ", #FUN-CA0160 Mark
                 #" ORDER BY item " #FUN-CA0160 Mark
      CALL cl_replace_sqldb(l_sql) RETURNING l_sql
     #CALL cl_parse_qry_sql(l_sql,p_azw01) RETURNING l_sql
      PREPARE ins_ogb_temp_pre FROM l_sql
      EXECUTE ins_ogb_temp_pre
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Ins'||' '||'Table:ogb_temp'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
        #CALL p200_log(g_trans_no,p_azw01,'Batch Operation','02','TD_SALE',g_errno,g_msg,'0','N',g_msg1)        #FUN-CA0160 Mark
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','02','TD_SALE_DETAIL',g_errno,g_msg,'0','N',g_msg1) #FUN-CA0160 Add
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'td_sale',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF

     #UPD ogb06/ogb15/ogb44
      LET l_upd = "UPDATE ogb_temp ",
                  "   SET ogb06 = ",
                  "       (SELECT ima02 FROM ",cl_get_target_table(p_azw01,'ima_file'),
                  "         WHERE ima01 = ogb04) "
      PREPARE upd_ogb_temp_pre1 FROM l_upd
      EXECUTE upd_ogb_temp_pre1
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Upd'||' '||'Table:ogb_temp'||' '||'Field:ogb06'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
        #CALL p200_log(g_trans_no,p_azw01,'Batch Operation','02','TD_SALE',g_errno,g_msg,'0','N',g_msg1)        #FUN-CA0160 Mark
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','02','TD_SALE_DETAIL',g_errno,g_msg,'0','N',g_msg1) #FUN-CA0160 Add
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'td_sale',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF
      LET l_upd = "UPDATE ogb_temp ",
                  "   SET ogb15 = ",
                  "       (SELECT ima25 FROM ",cl_get_target_table(p_azw01,'ima_file'),
                  "         WHERE ima01 = ogb04) "
      PREPARE upd_ogb_temp_pre2 FROM l_upd
      EXECUTE upd_ogb_temp_pre2
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Upd'||' '||'Table:ogb_temp'||' '||'Field:ogb15'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
        #CALL p200_log(g_trans_no,p_azw01,'Batch Operation','02','TD_SALE',g_errno,g_msg,'0','N',g_msg1)        #FUN-CA0160 Mark
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','02','TD_SALE_DETAIL',g_errno,g_msg,'0','N',g_msg1) #FUN-CA0160 Add
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'td_sale',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF

      LET l_upd = "UPDATE ogb_temp ",
                  "   SET ogb44 = ",
                  "       COALESCE((SELECT COALESCE(rty06,'1') FROM ",cl_get_target_table(p_azw01,'rty_file'),
                  "         WHERE rty01 = '",p_azw01,"' AND rty02 = ogb04),'1') "
      PREPARE upd_ogb_temp_pre3 FROM l_upd
      EXECUTE upd_ogb_temp_pre3
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Upd'||' '||'Table:ogb_temp'||' '||'Field:ogb44'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
        #CALL p200_log(g_trans_no,p_azw01,'Batch Operation','02','TD_SALE',g_errno,g_msg,'0','N',g_msg1)        #FUN-CA0160 Mark
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','02','TD_SALE_DETAIL',g_errno,g_msg,'0','N',g_msg1) #FUN-CA0160 Add
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'td_sale',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF

     ################################################################################
      #抓取不存在ogb的oga   
      LET l_cnt = 0
      LET l_sql = "SELECT count(*) FROM oga_temp WHERE oga01 NOT IN (SELECT ogb01 FROM ogb_temp) "
      PREPARE sel_oga01_pre FROM l_sql
      EXECUTE sel_oga01_pre INTO l_cnt
      IF l_cnt > 0 THEN
         LET g_errno   = 'apc1051' #存在单身无资料的单据
         LET g_msg1    = 'Oper:Chk'||' '||'Table:oga_temp'||' '||'Shop:'||p_azw01
        #CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1) #FUN-CB0103 Mark
         CALL s_errmsg('Batch Operation:','',g_msg1,g_errno,1)       #FUN-CB0103 Add
        #ROLLBACK WORK #FUN-D10023 Mark
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
        #CALL p200_log(g_trans_no,p_azw01,'Batch Operation','02','TD_SALE',g_errno,g_msg,'0','N',g_msg1)        #FUN-CA0160 Mark
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','02','TD_SALE_DETAIL',g_errno,g_msg,'0','N',g_msg1) #FUN-CA0160 Add
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
      END IF

      #更新中间库状态为A
      LET l_upd = "UPDATE ",g_posdbs,"td_sale",g_db_links," ",
                  "   SET Condition2 = 'A' ",
                  " WHERE Shop = '",p_azw01,"' ",
                  "   AND EXISTS (SELECT 1 ",
                  "                 FROM oga_temp ",
                  "                WHERE oga01 NOT IN (SELECT ogb01 FROM ogb_temp) ",
                  "                  AND oga98 = Saleno) "
      PREPARE upd_td_sale_flag_oga_pre3 FROM l_upd
      EXECUTE upd_td_sale_flag_oga_pre3

      #删除不存在ogb的oga
      DELETE FROM oga_temp WHERE oga01 NOT IN (SELECT ogb01 FROM ogb_temp)
     ################################################################################

     ################################################################################
     #如果销售单位和库存单位ima25不同时，抓取单位转换率
      LET l_sql = "UPDATE ogb_temp ",
                  "   SET ogb05_fac = ",
                 #FUN-CB0103 Mark&Add Begin ---
                 #"       (SELECT smd06/smd04 ",
                 #"          FROM ",cl_get_target_table(p_azw01,'smd_file'),
                 #"         WHERE smd01 = ogb04 AND smd02 = ogb05 AND smd03 = ogb15)",
                  "       COALESCE((SELECT smd06/smd04 ",
                  "                   FROM ",cl_get_target_table(p_azw01,'smd_file'),
                  "                  WHERE smd01 = ogb04 AND smd02 = ogb05 AND smd03 = ogb15),0)",
                 #FUN-CB0103 Mark&Add End -----
                  " WHERE ogb05 <> ogb15 AND ogb05_fac = 0 "
      PREPARE sel_ogb05_fac_p4 FROM l_sql
      EXECUTE sel_ogb05_fac_p4

      LET l_sql = "UPDATE ogb_temp ",
                  "   SET ogb05_fac = ",
                 #FUN-CB0103 Mark&Add Begin ---
                 #"       (SELECT smd04/smd06 ",
                 #"          FROM ",cl_get_target_table(p_azw01,'smd_file'),
                 #"         WHERE smd01 = ogb04 AND smd03 = ogb05 AND smd02 = ogb15)",
                  "       COALESCE((SELECT smd04/smd06 ",
                  "                   FROM ",cl_get_target_table(p_azw01,'smd_file'),
                  "                  WHERE smd01 = ogb04 AND smd03 = ogb05 AND smd02 = ogb15),0)",
                 #FUN-CB0103 Mark&Add End -----
                  " WHERE ogb05 <> ogb15 AND ogb05_fac = 0 "
      PREPARE sel_ogb05_fac_p5 FROM l_sql
      EXECUTE sel_ogb05_fac_p5

      LET l_sql = "UPDATE ogb_temp ",
                  "   SET ogb05_fac = ",
                 #FUN-CB0103 Mark&Add Begin ---
                 #"       (SELECT smc03/smc04 ",
                 #"          FROM ",cl_get_target_table(p_azw01,'smc_file'),
                 #"         WHERE smc01 = ogb05 AND smc02 = ogb15)",
                  "       COALESCE((SELECT smc03/smc04 ",
                  "                   FROM ",cl_get_target_table(p_azw01,'smc_file'),
                  "                  WHERE smc01 = ogb05 AND smc02 = ogb15),0)",
                 #FUN-CB0103 Mark&Add End -----
                  " WHERE ogb05 <> ogb15 AND ogb05_fac = 0 "
      PREPARE sel_ogb05_fac_p6 FROM l_sql
      EXECUTE sel_ogb05_fac_p6

      LET l_sql = "UPDATE ogb_temp SET ogb15_fac = ogb05_fac,ogb16 = ogb16 * ogb15_fac WHERE ogb05 <> ogb15 "
      PREPARE upd_ogb15_fac_p FROM l_sql
      EXECUTE upd_ogb15_fac_p
     ################################################################################

      #更新ogb_temp中成本中心
      LET l_sql = "UPDATE ogb_temp ",
                  "   SET ogb930 = ",
                  "       (SELECT gem10 FROM ",cl_get_target_table(p_azw01,'gem_file'),
                  "         WHERE EXISTS (SELECT 1 FROM oga_temp ",
                  "                        WHERE gem01 = oga15 ",
                  "                          AND oga01 = ogb01)) "
      PREPARE upd_ogb930_p2 FROM l_sql
      EXECUTE upd_ogb930_p2
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Upd'||' '||'Table:ogb_temp'||' '||'Field:ogb930'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
        #CALL p200_log(g_trans_no,p_azw01,'Batch Operation','02','TD_SALE',g_errno,g_msg,'0','N',g_msg1)        #FUN-CA0160 Mark
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','02','TD_SALE_DETAIL',g_errno,g_msg,'0','N',g_msg1) #FUN-CA0160 Add
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'td_sale',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF

      #更新出货金额
      LET l_sql = "UPDATE ",cl_get_target_table(p_azw01,'oea_file'),
                  "   SET oea62 = oea62 + (SELECT oga50 FROM oga_temp WHERE oga16 = oea01 AND oga16 IS NOT NULL ) ",
                  " WHERE EXISTS (SELECT 1 FROM oga_temp WHERE oga16 = oea01 AND oga16 IS NOT NULL ) "
      PREPARE upd_oea62_pre FROM l_sql
      EXECUTE upd_oea62_pre
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Upd'||' '||'Table:oea_file'||' '||'Field:oea62'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
        #CALL p200_log(g_trans_no,p_azw01,'Batch Operation','02','TD_SALE',g_errno,g_msg,'0','N',g_msg1)        #FUN-CA0160 Mark
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','02','TD_SALE_DETAIL',g_errno,g_msg,'0','N',g_msg1) #FUN-CA0160 Add
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'td_sale',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF

      #更新已出貨數量
      LET l_sql = "UPDATE ",cl_get_target_table(p_azw01,'oeb_file'),
                  "   SET oeb24 = oeb24 + (SELECT ogb16 FROM ogb_temp ",
                  "                         WHERE ogb31 IS NOT NULL ",
                  "                           AND ogb04[1,4] != 'MISC' ",
                  "                           AND oeb01 = ogb31 ",
                  "                           AND oeb03 = ogb32) ",
                  " WHERE EXISTS (SELECT 1 FROM ogb_temp ",
                  "                WHERE ogb31 IS NOT NULL ",
                  "                  AND ogb04[1,4] != 'MISC' ",
                  "                  AND oeb01 = ogb31 ",
                  "                  AND oeb03 = ogb32) "
      PREPARE upd_oeb24_pre FROM l_sql
      EXECUTE upd_oeb24_pre
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Upd'||' '||'Table:oeb_file'||' '||'Field:oeb24'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
        #CALL p200_log(g_trans_no,p_azw01,'Batch Operation','02','TD_SALE',g_errno,g_msg,'0','N',g_msg1)        #FUN-CA0160 Mark
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','02','TD_SALE_DETAIL',g_errno,g_msg,'0','N',g_msg1) #FUN-CA0160 Add
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'td_sale',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF

      ################################################################################
      #若經營方式為聯營或代銷
      LET l_sql = "UPDATE ogb_temp ",
                  "   SET (ogb45,ogb46) = ",
                  "       (SELECT rtv12,rtv12",
                  "          FROM ",cl_get_target_table(p_azw01,'rtv_file'),",",
                                    cl_get_target_table(p_azw01,'rtu_file'),",",
                                    cl_get_target_table(p_azw01,'rtt_file'),",",
                                    cl_get_target_table(p_azw01,'rty_file'),",oga_temp",
                  "         WHERE rtt01 = rtu04 ",
                  "           AND rtt02 = rtu02 ",
                  "           AND rttplant = rtuplant ",
                  "           AND rtuplant = '",p_azw01,"' ",
                  "           AND rtuconf = 'Y' ",
                  "           AND rtuplant = rtvplant ",
                  "           AND rtu01 = rtv01 ",
                  "           AND rtu02 = rtv02 ",
                  "           AND rty01 = '",p_azw01,"' ",
                  "           AND rty02 = ogb04 AND rtyacti = 'Y'",
                  "           AND rtu09 <= oga02 ",
                  "           AND rtu10 >= oga02 ",
                  "           AND rtu05 = rty05 ",
                  "           AND rtu06 = ogb44 ",
                  "           AND rtv04 = ogb04 ",
                  "           AND oga01 = ogb01 )",
                  " WHERE ogb44 IN ('3','4')"
      PREPARE upd_ogb45_p_pre FROM l_sql
      EXECUTE upd_ogb45_p_pre
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Upd'||' '||'Table:ogb_temp'||' '||'Field:(ogb45/ogb46)'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
        #CALL p200_log(g_trans_no,p_azw01,'Batch Operation','02','TD_SALE',g_errno,g_msg,'0','N',g_msg1)        #FUN-CA0160 Mark
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','02','TD_SALE_DETAIL',g_errno,g_msg,'0','N',g_msg1) #FUN-CA0160 Add
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'td_sale',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF
      
      LET l_sql = "UPDATE ogb_temp ",
                  "   SET (ogb45,ogb46) = ",
                  "       (SELECT rtt11,rtt11",
                  "          FROM ",cl_get_target_table(p_azw01,'rtt_file'),",",
                                    cl_get_target_table(p_azw01,'rts_file'),",",
                                    cl_get_target_table(p_azw01,'rto_file'),",",
                                    cl_get_target_table(p_azw01,'rty_file'),",oga_temp",
                  "         WHERE rts01 = rtt01 ",
                  "           AND rttplant = rtsplant ",
                  "           AND rts02 = rtt02 ",
                  "           AND rtt04 = ogb04 ",
                  "           AND rto01 = rts04 ",
                  "           AND rtoplant = rtsplant ",
                  "           AND rto05 = rty05 ",
                  "           AND rty01 = '",p_azw01,"' ",
                  "           AND rty02 = ogb04 AND rtyacti = 'Y' ",
                  "           AND rto06 = ogb44 ",
                  "           AND rto08 <= oga02 ",
                  "           AND rto09 >= oga02 ",
                  "           AND rtt15 = 'Y' ",
                  "           AND rtoconf = 'Y' ",
                  "           AND rtsconf = 'Y' ",
                  "           AND rto03 = rts02 ",
                  "           AND rtoplant = '",p_azw01,"' ",
                  "           AND oga01 = ogb01 )",
                  " WHERE ogb44 IN ('3','4')",
                  "   AND ogb45 IS NULL "
      PREPARE upd_ogb45_p_pre1 FROM l_sql
      EXECUTE upd_ogb45_p_pre1
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Upd'||' '||'Table:ogb_temp'||' '||'Field:(ogb45/ogb46)'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
        #CALL p200_log(g_trans_no,p_azw01,'Batch Operation','02','TD_SALE',g_errno,g_msg,'0','N',g_msg1)        #FUN-CA0160 Mark
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','02','TD_SALE_DETAIL',g_errno,g_msg,'0','N',g_msg1) #FUN-CA0160 Add
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'td_sale',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF
      ######################################################################################

      #################################################################################
      #若摊位编号不为空,则抓取摊位对应的商户编号
      #1.抓合同中的商户
      LET l_sql = "UPDATE ogb_temp ",
                  "   SET ogb49 = ",
                  "       (SELECT DISTINCT lnt04 FROM ",cl_get_target_table(p_azw01,'lnt_file'),",oga_temp ",
                  "         WHERE lnt17 <= oga02 ",
                  "           AND lnt18 >= oga02 ",
                  "           AND lnt06  = ogb48 ",
                  "           AND (lnt26 = 'Y' OR lnt26 = 'S' OR lnt26 = 'E') ",
                  "           AND oga01 = ogb01 )",
                  " WHERE ogb48 IS NOT NULL "
      PREPARE upd_ogb49_p_pre FROM l_sql
      EXECUTE upd_ogb49_p_pre
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Upd'||' '||'Table:ogb_temp'||' '||'Field:ogb49'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
        #CALL p200_log(g_trans_no,p_azw01,'Batch Operation','02','TD_SALE',g_errno,g_msg,'0','N',g_msg1)        #FUN-CA0160 Mark
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','02','TD_SALE_DETAIL',g_errno,g_msg,'0','N',g_msg1) #FUN-CA0160 Add
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'td_sale',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF

      #2.抓预租协议中的商户
      LET l_sql = "UPDATE ogb_temp ",
                  "   SET ogb49 = ",
                  "       (SELECT DISTINCT lih08 FROM ",cl_get_target_table(p_azw01,'lih_file'),",oga_temp ",
                  "         WHERE lih14 <= oga02 ",
                  "           AND lih15 >= oga02 ",
                  "           AND lih07  = ogb48 ",
                  "           AND lihconf = 'Y' ",
                  "           AND oga01 = ogb01 )",
                  " WHERE ogb48 IS NOT NULL ",
                  "   AND ogb49 IS NULL "
      PREPARE upd_ogb49_p_pre1 FROM l_sql
      EXECUTE upd_ogb49_p_pre1
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Upd'||' '||'Table:ogb_temp'||' '||'Field:ogb49'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
        #CALL p200_log(g_trans_no,p_azw01,'Batch Operation','02','TD_SALE',g_errno,g_msg,'0','N',g_msg1)        #FUN-CA0160 Mark
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','02','TD_SALE_DETAIL',g_errno,g_msg,'0','N',g_msg1) #FUN-CA0160 Add
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'td_sale',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF
      #######################################################################

     #ins xyz 
      CALL p200_xyz_ins_p("oga_file",p_azw01)
      IF g_success='N' THEN
         ROLLBACK WORK
         CONTINUE WHILE
      END IF  

      #若是訂單轉銷售且支付方式為沖預收則更新預收單號為訂單號
      #注：POS銷售時,沖預收的訂單只能一次性付完
      LET l_sql = "UPDATE rxy_temp ",
                  "   SET rxy06 = (SELECT oga16 FROM oga_temp ",
                  "                 WHERE oga01 = rxy01 AND oga16 IS NOT NULL) ",
                  " WHERE rxy00 = '02' ", 
                 #"   AND rxy03 = '07' ", #FUN-CA0160 Mark
                  "   AND rxy33 = 'Y' ",  #FUN-CA0160 Add
                  "   AND EXISTS (SELECT 1 FROM oga_temp ",
                  "                WHERE oga01 = rxy01 AND oga16 IS NOT NULL) "
      CALL cl_replace_sqldb(l_sql) RETURNING l_sql
     #CALL cl_parse_qry_sql(l_sql,p_azw01) RETURNING l_sql
      PREPARE upd_rxy06_p_pre FROM l_sql
      EXECUTE upd_rxy06_p_pre 
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Upd'||' '||'Table:rxy_temp'||' '||'Field:rxy06'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
        #CALL p200_log(g_trans_no,p_azw01,'Batch Operation','02','TD_SALE',g_errno,g_msg,'0','N',g_msg1)        #FUN-CA0160 Mark
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','02','TD_SALE_DETAIL',g_errno,g_msg,'0','N',g_msg1) #FUN-CA0160 Add
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'td_sale',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF

     #ins rxc_file 开始
     #CALL p200_rxc_ins_p("oga_file",p_azw01)                       #FUN-CA0160 Mark
      CALL p200_rxc_ins_p("oga_file",p_azw01,"td_Sale_Detail_Agio") #FUN-CA0160 Add
      IF g_success = 'N' THEN
         ROLLBACK WORK
         CONTINUE WHILE
      END IF

      #ins ogi_file
      LET l_ins = "INSERT INTO ",cl_get_target_table(p_azw01,'ogi_file'),"(",
                  "       ogi01, ",                     #出貨單號
                  "       ogi02, ",                     #項次
                  "       ogi03, ",                     #序號
                  "       ogi04, ",                     #稅別
                  "       ogi05, ",                     #稅率
                  "       ogi06, ",                     #固定稅額
                  "       ogi07, ",                     #含稅否
                  "       ogi08, ",                     #未稅金額
                  "       ogi08t, ",                    #含稅金額
                  "       ogi09, ",                     #稅額
                  "       ogidate, ",                   #最近修改日
                  "       ogigrup, ",                   #資料所有部門
                  "       ogilegal, ",                  #所屬法人
                  "       ogimodu, ",                   #資料修改者
                  "       ogiorig, ",                   #資料建立部門
                  "       ogioriu, ",                   #資料建立者
                  "       ogiplant, ",                  #所屬營運中心
                  "       ogiuser) "                    #資料所有者

      LET l_sel = "SELECT DISTINCT ",
                  "       oga01, ",                            #ogi01    出貨單號
                  "       mitem, ",                            #ogi02    項次
                  "       item, ",                             #ogi03    序號
                  "       taxcode, ",                          #ogi04    稅別
                  "       taxrate, ",                          #ogi05    稅率
                  "       0, ",                                #ogi06    固定稅額
                  "       incltax, ",                          #ogi07    含稅否
                  "       uamt, ",                             #ogi08    未稅金額
                  "       amt, ",                              #ogi08t   含稅金額
                  "       tax, ",                              #ogi09    稅額
                  "       ogadate, ",                          #ogidate  最近修改日
                  "       ogagrup, ",                          #ogigrup  資料所有部門
                  "       ogalegal, ",                         #ogilegal 所屬法人
                  "       ogamodu, ",                          #ogimodu  資料修改者
                  "       ogaorig, ",                          #ogiorig  資料建立部門
                  "       ogaoriu, ",                          #ogioriu  資料建立者
                  "       shop, ",                             #ogiplant 所屬營運中心
                  "       ogauser ",                           #ogiuser  資料所有者
                  "  FROM ",g_posdbs,"td_sale_detail_taxdetail",g_db_links,",oga_temp ",
                  " WHERE shop = '",p_azw01,"' ",
                  "   AND saleno = oga98 "  #FUN-CA0160 Add
                 #"   AND saleno = oga98 ", #FUN-CA0160 Mark
                 #" ORDER BY oga01,mitem,item "  #FUN-CA0160 Mark
      LET l_sql = l_ins CLIPPED," ",l_sel CLIPPED
      CALL cl_replace_sqldb(l_sql) RETURNING l_sql
     #CALL cl_parse_qry_sql(l_sql,p_azw01) RETURNING l_sql
      PREPARE sel_td_sale_detail_taxdetail_p_oga_pre FROM l_sql
      EXECUTE sel_td_sale_detail_taxdetail_p_oga_pre
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Ins'||' '||'Table:ogi_file'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
        #CALL p200_log(g_trans_no,p_azw01,'Batch Operation','02','TD_SALE',g_errno,g_msg,'0','N',g_msg1)        #FUN-CA0160 Mark
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','02','TD_SALE_DETAIL',g_errno,g_msg,'0','N',g_msg1) #FUN-CA0160 Add
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'td_sale',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF

      #ins ogh_file
      LET l_ins = "INSERT INTO ",cl_get_target_table(p_azw01,'ogh_file'),"(",
                  "       ogh01, ",                     #出貨單號
                  "       ogh02, ",                     #序號
                  "       ogh03, ",                     #稅別
                  "       ogh04, ",                     #稅率
                  "       ogh05, ",                     #固定稅額
                  "       ogh06, ",                     #含稅否
                  "       ogh07, ",                     #未稅金額
                  "       ogh07t, ",                    #含稅金額
                  "       ogh08, ",                     #稅額
                  "       ogh09, ",                     #留抵稅額
                  "       oghdate, ",                   #最近修改日
                  "       oghgrup, ",                   #資料所有部門
                  "       oghlegal, ",                  #所屬法人
                  "       oghmodu, ",                   #資料修改者
                  "       oghorig, ",                   #資料建立部門
                  "       oghoriu, ",                   #資料建立者
                  "       oghplant, ",                  #所屬營運中心
                  "       oghuser) "                    #資料所有者

      LET l_sel = "SELECT DISTINCT ",
                  "       oga01, ",                            #ogh01    出貨單號
                  "       item, ",                             #ogh02    序號
                  "       taxcode, ",                          #ogh03    稅別
                  "       taxrate, ",                          #ogh04    稅率
                  "       0, ",                                #ogh05    固定稅額
                  "       incltax, ",                          #ogh06    含稅否
                  "       uamt, ",                             #ogh07    未稅金額
                  "       amt, ",                              #ogh07t   含稅金額
                  "       tax, ",                              #ogh08    稅額
                  "       acctax, ",                           #ogh09    留抵稅額
                  "       ogadate, ",                          #oghdate  最近修改日
                  "       ogagrup, ",                          #oghgrup  資料所有部門
                  "       ogalegal, ",                         #oghlegal 所屬法人
                  "       ogamodu, ",                          #oghmodu  資料修改者
                  "       ogaorig, ",                          #oghorig  資料建立部門
                  "       ogaoriu, ",                          #oghoriu  資料建立者
                  "       shop, ",                             #oghplant 所屬營運中心
                  "       ogauser ",                           #oghuser  資料所有者
                  "  FROM ",g_posdbs,"td_sale_taxmaster",g_db_links,",oga_temp ",
                  " WHERE shop = '",p_azw01,"' ",
                  "   AND saleno = oga98 ",
                  " ORDER BY oga01,item "
      LET l_sql = l_ins CLIPPED," ",l_sel CLIPPED
      CALL cl_replace_sqldb(l_sql) RETURNING l_sql
     #CALL cl_parse_qry_sql(l_sql,p_azw01) RETURNING l_sql
      PREPARE sel_td_sale_taxmaster_p_oga_pre FROM l_sql
      EXECUTE sel_td_sale_taxmaster_p_oga_pre
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Ins'||' '||'Table:ogh_temp'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
        #CALL p200_log(g_trans_no,p_azw01,'Batch Operation','02','TD_SALE',g_errno,g_msg,'0','N',g_msg1)        #FUN-CA0160 Mark
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','02','TD_SALE_DETAIL',g_errno,g_msg,'0','N',g_msg1) #FUN-CA0160 Add
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'td_sale',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF

      #如果地址码不为空,则新增单据出货地址档
      LET l_ins = "INSERT INTO ",cl_get_target_table(p_azw01,'oap_file'),"(",
                  "              oap01,  ",      #单据单号
                  "              oap02,  ",      #No Use
                  "              oap03,  ",      #全名
                  "              oap041, ",      #地址-1
                  "              oap042, ",      #地址-2
                  "              oap043, ",      #地址-3
                  "              oap044, ",      #地址-4
                  "              oap045) "       #地址-5
      LET l_sel = "SELECT ",
                  "       oga01, ",              #oap01           #单据单号
                  "       NULL, ",               #oap02           #No Use
                  "       NULL, ",               #oap03           #全名
                  "       shipadd, ",            #oap041          #地址-1
                  "       NULL, ",               #oap042          #地址-2
                  "       NULL, ",               #oap043          #地址-3
                  "       NULL, ",               #oap044          #地址-4
                  "       NULL ",                #oap045          #地址-5
                  "  FROM ",g_posdbs,"td_sale",g_db_links,", ",
                  "       oga_temp",
                  " WHERE oga98 = saleno ",
                  "   AND ogaplant = shop AND type = '0' ",
                  "   AND shipadd IS NOT NULL "
      LET l_sql = l_ins CLIPPED," ",l_sel CLIPPED
      CALL cl_replace_sqldb(l_sql) RETURNING l_sql
     #CALL cl_parse_qry_sql(l_sql,p_azw01) RETURNING l_sql
      PREPARE ins_oap_p_pre FROM l_sql
      EXECUTE ins_oap_p_pre
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Ins'||' '||'Table:oap_file'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
        #CALL p200_log(g_trans_no,p_azw01,'Batch Operation','02','TD_SALE',g_errno,g_msg,'0','N',g_msg1)        #FUN-CA0160 Mark
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','02','TD_SALE_DETAIL',g_errno,g_msg,'0','N',g_msg1) #FUN-CA0160 Add
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'td_sale',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF

     #更新中间库标志位
      CALL p200_upd_posflag_p("1","oga_file","td_sale",p_azw01)
      IF g_success = 'N' THEN
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Upd'||' '||'Table:td_sale'||' '||'Field:Condition2'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','02','TD_SALE',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'td_sale',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF   

     #更新庫存
      IF g_success = 'Y' THEN
         CALL s_upimg_p('1','',p_azw01,'')
         IF g_success = 'N' THEN
            ROLLBACK WORK
           #FUN-CB0103 Add Begin ---
            CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
            LET g_msg   = g_msg[1,255]
            CALL p200_log(g_trans_no,p_azw01,'Batch Operation','02','TD_SALE',g_errno,g_msg,'0','N',g_msg1)
            LET g_errno = ''
            LET g_msg   = ''
            LET g_msg1  = '' 
            CALL p200_upd_posflag_p('2',p_gat01,'td_sale',p_azw01) #将对应中间库的资料Condition2更新为A
           #FUN-CB0103 Add End -----
            CONTINUE WHILE
         END IF

         CALL s_instlf_p('1','',p_azw01)
         IF g_success = 'N' THEN
            ROLLBACK WORK
           #FUN-CB0103 Add Begin ---
            CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
            LET g_msg   = g_msg[1,255]
            CALL p200_log(g_trans_no,p_azw01,'Batch Operation','02','TD_SALE',g_errno,g_msg,'0','N',g_msg1)
            LET g_errno = ''
            LET g_msg   = ''
            LET g_msg1  = ''
            CALL p200_upd_posflag_p('2',p_gat01,'td_sale',p_azw01) #将对应中间库的资料Condition2更新为A
           #FUN-CB0103 Add End -----
            CONTINUE WHILE
         END IF
      END IF

      #将临时表oga_temp插入到数据库中
      LET l_ins = " INSERT INTO ",cl_get_target_table(p_azw01,'oga_file'),
                  " SELECT * FROM oga_temp "
      CALL cl_replace_sqldb(l_ins) RETURNING l_ins
      CALL cl_parse_qry_sql(l_ins,p_azw01) RETURNING l_ins
      PREPARE ins_oga_p_pre FROM l_ins
      EXECUTE ins_oga_p_pre
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Ins'||' '||'Table:oga_file'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','02','TD_SALE',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'td_sale',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF
      
      #将临时表ogb_temp插入到数据库中
      LET l_ins = " INSERT INTO ",cl_get_target_table(p_azw01,'ogb_file'),
                  " SELECT * FROM ogb_temp "
      CALL cl_replace_sqldb(l_ins) RETURNING l_ins
      CALL cl_parse_qry_sql(l_ins,p_azw01) RETURNING l_ins
      PREPARE ins_ogb_p_pre FROM l_ins
      EXECUTE ins_ogb_p_pre
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Ins'||' '||'Table:ogb_file'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','02','TD_SALE',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'td_sale',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF

      #将临时表rxx_temp插入到数据库中
      LET l_ins = " INSERT INTO ",cl_get_target_table(p_azw01,'rxx_file'),
                  " SELECT * FROM rxx_temp "
      CALL cl_replace_sqldb(l_ins) RETURNING l_ins
      CALL cl_parse_qry_sql(l_ins,p_azw01) RETURNING l_ins
      PREPARE ins_rxx_p_pre FROM l_ins
      EXECUTE ins_rxx_p_pre
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Ins'||' '||'Table:rxx_file'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','02','TD_SALE',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'td_sale',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF

      #将临时表rxy_temp插入到数据库中
      LET l_ins = " INSERT INTO ",cl_get_target_table(p_azw01,'rxy_file'),
                  " SELECT * FROM rxy_temp "
      CALL cl_replace_sqldb(l_ins) RETURNING l_ins
      CALL cl_parse_qry_sql(l_ins,p_azw01) RETURNING l_ins
      PREPARE ins_rxy_p_pre FROM l_ins
      EXECUTE ins_rxy_p_pre
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Ins'||' '||'Table:rxy_file'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','02','TD_SALE',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'td_sale',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF

      #将临时表rxz_temp插入到数据库中
      LET l_ins = " INSERT INTO ",cl_get_target_table(p_azw01,'rxz_file'),
                  " SELECT * FROM rxz_temp "
      CALL cl_replace_sqldb(l_ins) RETURNING l_ins
      CALL cl_parse_qry_sql(l_ins,p_azw01) RETURNING l_ins
      PREPARE ins_rxz_p_pre FROM l_ins
      EXECUTE ins_rxz_p_pre
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Ins'||' '||'Table:rxz_file'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','02','TD_SALE',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'td_sale',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF

     #LET l_sql = "SELECT DISTINCT ogb01 FROM ogb_temp WHERE ogb44 IN ('2','3','4') ORDER BY ogb01 "                                  #FUN-CB0103 Mark
      LET l_sql = "SELECT DISTINCT oga01,oga98 FROM oga_temp,ogb_temp WHERE oga01 = ogb01 AND ogb44 IN ('2','3','4') ORDER BY oga01 " #FUN-CB0103 Add
      PREPARE sel_ogb_temp_pre3 FROM l_sql
      DECLARE sel_ogb_temp_cs3 CURSOR FOR sel_ogb_temp_pre3
     #FOREACH sel_ogb_temp_cs3 INTO l_oga01        #FUN-CB0103 Mark
      FOREACH sel_ogb_temp_cs3 INTO l_oga01,g_fno1 #FUN-CB0103 Add
         IF g_success = 'Y' THEN
            CALL t620sub1_post('1',l_oga01)           #經營方式處理
            IF g_success = 'N' THEN
               #經營方式報錯處理
               ROLLBACK WORK
               FOR l_i = 1 TO g_err_msg.getLength()
                  LET g_msg1 = 'TD_SALE'||'INS'||p_azw01||g_fno1
                  LET g_msg1 = g_err_msg[l_i].fld1||g_err_msg[l_i].fld2||g_err_msg[l_i].fld3
                  LET g_errno = g_err_msg[l_i].fld4
                  CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
                  CALL p200_log(g_trans_no,p_azw01,g_fno1,'02','TD_SALE',g_errno,g_msg,'0','N',g_msg1)
               END FOR
               CONTINUE FOREACH
            END IF
         END IF
         INITIALIZE l_oga01 TO NULL
      END FOREACH

      IF g_success = 'Y' THEN
         LET g_sucflag = 1
         COMMIT WORK
      ELSE
         ROLLBACK WORK
      END IF
   END WHILE
  #FUN-CA0160 Add Begin ---
   #删除建立的临时表
   DROP TABLE oga_temp
   DROP TABLE ogb_temp
   DROP TABLE rxx_temp
   DROP TABLE rxy_temp
   DROP TABLE rxz_temp
  #FUN-CA0160 Add End -----
END FUNCTION
#FUN-CA0091 Add End -----

#FUN-CA0091 Add Begin ---
FUNCTION p200_oha_p_ins(p_gat01,p_azw01)
DEFINE p_gat01       LIKE gat_file.gat01
DEFINE p_azw01       LIKE azw_file.azw01
DEFINE p_azw02       LIKE azw_file.azw02
DEFINE l_ins         STRING
DEFINE l_upd         STRING
DEFINE l_sql         STRING
DEFINE l_sel         STRING
DEFINE l_oha01       LIKE oha_file.oha01
DEFINE l_oha03       LIKE oha_file.oha03
DEFINE l_oha032      LIKE oha_file.oha032
DEFINE l_oha02       LIKE oha_file.oha02
DEFINE l_ohaplant    LIKE oha_file.ohaplant
DEFINE l_date        LIKE oha_file.oha02
DEFINE l_oha98       LIKE oha_file.oha98
DEFINE l_oha16       LIKE oha_file.oha16
DEFINE l_oha23       LIKE oha_file.oha23
DEFINE l_oha24       LIKE oha_file.oha24
DEFINE l_i           LIKE type_file.num5
DEFINE l_num_len     LIKE type_file.num10
DEFINE l_num_str     LIKE type_file.chr20
DEFINE l_oha01_str   STRING
DEFINE l_oha01_num   LIKE type_file.chr20
DEFINE l_oha01_chr   LIKE type_file.chr20
DEFINE l_cnt         LIKE type_file.num5
DEFINE l_oha02_old   LIKE oha_file.oha02
DEFINE l_oha01_min   LIKE oha_file.oha01
DEFINE l_oha01_max   LIKE oha_file.oha01
DEFINE l_oha01_min_o LIKE oha_file.oha01
DEFINE l_oha01_max_o LIKE oha_file.oha01
DEFINE l_oha02_num   LIKE type_file.num10
DEFINE l_azn05       LIKE azn_file.azn05
DEFINE l_azn05_old   LIKE azn_file.azn05
DEFINE l_upd_num     LIKE type_file.num10
DEFINE l_saleno      STRING

  #FUN-CA0160 Mark Begin ---
  ##先删除需要建立的临时表
  #DROP TABLE oha_temp
  #DROP TABLE ohb_temp
  #DROP TABLE rxx_temp
  #DROP TABLE rxy_temp
  #DROP TABLE rxz_temp
  #
  ##建立临时表
  #SELECT * FROM oha_file WHERE 1=0 INTO TEMP oha_temp
  #SELECT * FROM ohb_file WHERE 1=0 INTO TEMP ohb_temp
  #SELECT * FROM rxx_file WHERE 1=0 INTO TEMP rxx_temp
  #SELECT * FROM rxy_file WHERE 1=0 INTO TEMP rxy_temp
  #SELECT * FROM rxz_file WHERE 1=0 INTO TEMP rxz_temp
  #
  ##建立索引
  #CREATE INDEX oha_temp_01 ON oha_temp (oha98)
  #CREATE INDEX oha_temp_02 ON oha_temp (oha15)
  #CREATE INDEX oha_temp_03 ON oha_temp (oha01)
  #CREATE INDEX ohb_temp_01 ON ohb_temp (ohb04)
  #CREATE INDEX ohb_temp_02 ON ohb_temp (ohb01,ohb03)
  #FUN-CA0160 Mark End -----

   #组出过滤条件
   IF NOT cl_null(g_saleno) THEN
      LET g_wc = " saleno = '",g_saleno,"' "
   ELSE
     #CALL p200_g_wc() RETURNING g_wc           #FUN-CA0160 Mark
      CALL p200_g_wc("oha_file") RETURNING g_wc #FUN-CA0160 Add
   END IF
   IF cl_null(g_wc) THEN LET g_wc = " 1=1" END IF

   SELECT azw02 INTO p_azw02 FROM azw_file WHERE azw01 = p_azw01
   
   LET g_success = 'Y'
   
   LET l_upd = "UPDATE ",g_posdbs,"td_sale",g_db_links," ",
               "   SET Condition2 = 'B' ",
               " WHERE Condition2 <> 'Y' AND Type IN ('1','2') AND Cnfflg = 'Y' AND Shop = '",p_azw01 CLIPPED,"' AND ",g_wc CLIPPED
   PREPARE upd_td_sale_oha_pre FROM l_upd
   EXECUTE upd_td_sale_oha_pre
   IF SQLCA.sqlcode THEN
      LET g_success = 'N'
      LET g_errno   = SQLCA.sqlcode
      LET g_msg1    = 'Oper:Upd'||' '||'Table:td_sale'||' '||'Shop:'||p_azw01
      CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
      ROLLBACK WORK
      CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
      LET g_msg   = g_msg[1,255]
      CALL p200_log(g_trans_no,p_azw01,'Batch Operation','02','TD_SALE',g_errno,g_msg,'0','N',g_msg1)
      LET g_errno = ''
      LET g_msg   = ''
      LET g_msg1  = ''
      RETURN
   END IF
   
   LET l_upd_num = SQLCA.sqlerrd[3]
   IF l_upd_num <= 0 THEN RETURN END IF
   IF cl_null(g_sum_limit) OR g_sum_limit = 0 THEN LET g_sum_limit = l_upd_num END IF

  #FUN-CA0160 Add Begin ---
   #先删除需要建立的临时表
   DROP TABLE oha_temp
   DROP TABLE ohb_temp
   DROP TABLE rxx_temp
   DROP TABLE rxy_temp
   DROP TABLE rxz_temp
   
   #建立临时表
   SELECT * FROM oha_file WHERE 1=0 INTO TEMP oha_temp
   SELECT * FROM ohb_file WHERE 1=0 INTO TEMP ohb_temp
   SELECT * FROM rxx_file WHERE 1=0 INTO TEMP rxx_temp
   SELECT * FROM rxy_file WHERE 1=0 INTO TEMP rxy_temp
   SELECT * FROM rxz_file WHERE 1=0 INTO TEMP rxz_temp
   
   #建立索引
   CREATE INDEX oha_temp_01 ON oha_temp (oha98)
   CREATE INDEX oha_temp_02 ON oha_temp (oha15)
   CREATE INDEX oha_temp_03 ON oha_temp (oha01)
   CREATE INDEX ohb_temp_01 ON ohb_temp (ohb04)
   CREATE INDEX ohb_temp_02 ON ohb_temp (ohb01,ohb03)
  #FUN-CA0160 Add End -----

   WHILE l_upd_num > 0
      LET l_upd_num = l_upd_num - g_sum_limit

      #清空临时表
      DELETE FROM oha_temp
      DELETE FROM ohb_temp
      DELETE FROM rxx_temp
      DELETE FROM rxy_temp
      DELETE FROM rxz_temp

      LET g_success = 'Y'
      BEGIN WORK

      LET l_ins = "INSERT INTO oha_temp( ",
                  "                     oha01, ",       #销退单号
                  "                     oha02, ",       #销退日期
                  "                     oha03, ",       #账款客户编号
                  "                     oha032, ",      #账款客户简称
                  "                     oha04, ",       #退货客户编号
                  "                     oha05, ",       #单据别
                  "                     oha08, ",       #1.内销 2.外销 3.视同外销
                  "                     oha09, ",       #销退处理方式
                  "                     oha14, ",       #人员编号
                  "                     oha15, ",       #部门编号
                  "                     oha16, ",       #出货单号
                  "                     oha21, ",       #税种
                  "                     oha211, ",      #税率
                  "                     oha212, ",      #联数
                  "                     oha213, ",      #含税否
                  "                     oha23, ",       #币种
                  "                     oha24, ",       #汇率
                  "                     oha25, ",       #销售分类一
                  "                     oha31, ",       #价格条件
                  "                     oha42, ",       #是否入库存
                  "                     oha43, ",       #起始三角贸易销退单否
                  "                     oha44, ",       #抛转否
                  "                     oha48, ",       #备注
                  "                     oha50, ",       #原币销退总税前金额
                  "                     oha53, ",       #原币销退应开折让税前金额
                  "                     oha54, ",       #原币销退已开折让税前金额
                  "                     oha55, ",       #状况码
                  "                     oha57, ",       #发票性质
                  "                     oha85, ",       #结算方式
                  "                     oha87, ",       #会员卡号
                  "                     oha88, ",       #顾客姓名
                  "                     oha89, ",       #联系电话
                  "                     oha90, ",       #证件类型
                  "                     oha91, ",       #证件号码
                  "                     oha94, ",       #POS销售否 Y-是,N-否
                  "                     oha95, ",       #本次积分
                  "                     oha96, ",       #收银机号
                  "                     oha98, ",       #POS单号
                  "                     oha1015, ",     #调货出货单自动生成否
                  "                     oha1019, ",     #返利退回税前金额
                  "                     ohaconf, ",     #审核否
                  "                     ohapost, ",     #扣账否
                  "                     ohaprsw, ",     #打印次数
                  "                     ohauser, ",     #资料所有者
                  "                     ohagrup, ",     #资料所有部门
                  "                     ohamksg, ",     #签核否
                  "                     ohaplant, ",    #所属营运中心
                  "                     ohalegal, ",    #所属法人
                  "                     ohacond, ",     #审核日期
                  "                     ohaconu, ",     #审核人员
                  "                     ohaoriu, ",     #资料建立者
                  "                     ohaorig, ",     #资料建立部门
                  "                     ohacont, ",     #审核时间
                  "                     ohadate) "      #最近更改日
      LET l_sel = "SELECT ",
                  "       ROW_NUMBER() over(order by Shop,Saleno), ",                       #oha01           #销退单号
                  "       CAST (bdate AS DATE), ",                                          #oha02           #销退日期
                  "       CASE WHEN cardno IS NOT NULL THEN lpk20 ELSE rtz06 END, ",        #oha03           #账款客户编号
                  "       occ02, ",                                                         #oha032          #账款客户简称
                  "       CASE WHEN cardno IS NOT NULL THEN lpk20 ELSE rtz06 END, ",        #oha04           #退货客户编号
                  "       '1', ",                                                           #oha05           #单据别
                  "       '1', ",                                                           #oha08           #1.内销 2.外销 3.视同外销
                  "       '1', ",                                                           #oha09           #销退处理方式
                  "       ryi02, ",                                                         #oha14           #人员编号
                  "       gen03, ",                                                         #oha15           #部门编号
                 #"       CASE otype WHEN 0 THEN ofno ELSE CAST('' AS NVARCHAR2(20)) END, ",#oha16           #出货单号      #FUN-CC0082 Mark
                  "       CASE WHEN (otype = 0 AND (OrderShop = Shop OR OrderShop IS NULL OR OrderShop = ' ')) THEN ofno ", #FUN-CC0082 Add
                  "            ELSE CAST('' AS NVARCHAR2(20)) END, ",                       #oha16           #出货单号      #FUN-CC0082 Add
                  "       occ41, ",                                                         #oha21           #税种
                  "       gec04, ",                                                         #oha211          #税率
                  "       gec05, ",                                                         #oha212          #联数
                  "       gec07, ",                                                         #oha213          #含税否
                  "       occ42, ",                                                         #oha23           #币种
                  "       NULL, ",                                                          #oha24           #汇率
                  "       occ43, ",                                                         #oha25           #销售分类一
                  "       occ44, ",                                                         #oha31           #价格条件
                  "       'N', ",                                                           #oha42           #是否入库存
                  "       'N', ",                                                           #oha43           #起始三角贸易销退单否
                  "       'N', ",                                                           #oha44           #抛转否
                  "       memo, ",                                                          #oha48           #备注
                  "       tot_uamt, ",                                                      #oha50           #原币销退总税前金额
                  "       tot_uamt, ",                                                      #oha53           #原币销退应开折让税前金额
                  "       0, ",                                                             #oha54           #原币销退已开折让税前金额
                  "       '1', ",                                                           #oha55           #状况码
                  "       '1', ",                                                           #oha57           #发票性质
                  "       '1', ",                                                           #oha85           #结算方式
                  "       cardno, ",                                                        #oha87           #会员卡号
                  "       contman, ",                                                       #oha88           #顾客姓名
                  "       conttel, ",                                                       #oha89           #联系电话
                  "       lpk02, ",                                                         #oha90           #证件类型
                  "       lpk03, ",                                                         #oha91           #证件号码
                  "       'Y', ",                                                           #oha94           #POS销售否 Y-是,N-否
                  "       point_qty, ",                                                     #oha95           #本次积分
                  "       machine, ",                                                       #oha96           #收银机号
                  "       saleno, ",                                                        #oha98           #POS单号
                  "       'N', ",                                                           #oha1015         #调货出货单自动生成否
                  "       0, ",                                                             #oha1019         #返利退回税前金额
                  "       'Y', ",                                                           #ohaconf         #审核否
                  "       'Y', ",                                                           #ohapost         #扣账否
                  "       0, ",                                                             #ohaprsw         #打印次数
                  "       ryi02, ",                                                         #ohauser         #资料所有者
                  "       gen03, ",                                                         #ohagrup         #资料所有部门
                  "       'N', ",                                                           #ohamksg         #签核否
                  "       shop, ",                                                          #ohaplant        #所属营运中心
                  "       '",p_azw02,"', ",                                                 #ohalegal        #所属法人
                  "       CAST (sdate AS DATE), ",                                          #ohacond         #审核日期
                  "       ryi02, ",                                                         #ohaconu         #审核人员
                  "       ryi02, ",                                                         #ohaoriu         #资料建立者
                  "       gen03, ",                                                         #ohaorig         #资料建立部门
                  "       stime[1,2]||':'||stime[3,4]||':'||stime[5,6], ",                  #ohacont         #审核时间
                  "       CAST (sdate AS DATE) ",                                           #ohadate         #最近更改日
                  "  FROM ( ",
                  "SELECT * ",
                  "  FROM ",g_posdbs,"td_sale",g_db_links," ",
                  " WHERE shop = '",p_azw01,"' AND condition2 = 'B' ",
                  "   AND (type = '1' OR type = '2') AND cnfflg = 'Y' ",
                  " ORDER BY bdate,saleno) LEFT OUTER JOIN ",cl_get_target_table(p_azw01,'rtz_file'),
                  "                                     ON rtz01 = shop ",
                  "                        LEFT OUTER JOIN ",cl_get_target_table(p_azw01,'lpj_file'),
                  "                                     ON lpj03 = cardno ",
                  "                        LEFT OUTER JOIN ",cl_get_target_table(p_azw01,'lpk_file'),
                  "                                     ON lpk01 = lpj01 ",
                  "                        LEFT OUTER JOIN ",cl_get_target_table(p_azw01,'occ_file'),
                  "                                     ON lpk20 = occ01 OR occ01 = rtz06 ",
                  "                        LEFT OUTER JOIN ",cl_get_target_table(p_azw01,'ryi_file'),
                  "                                     ON ryi01 = opno ",
                  "                        LEFT OUTER JOIN ",cl_get_target_table(p_azw01,'gen_file'),
                  "                                     ON gen01 = ryi02 ",
                  "                        LEFT OUTER JOIN ",cl_get_target_table(p_azw01,'gec_file'),
                  "                                     ON gec01 = occ41 AND gec011 = '2' ",
                  " WHERE ROWNUM <= ",g_sum_limit," ",
                  " ORDER BY bdate,saleno "
      LET l_sql = l_ins CLIPPED," ",l_sel CLIPPED
      PREPARE ins_oha_temp_pre FROM l_sql
      EXECUTE ins_oha_temp_pre
      IF SQLCA.sqlcode OR SQLCA.sqlerrd[3] = 0 THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Ins'||' '||'Table:oha_temp'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','02','TD_SALE',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
        #RETURN         #FUN-CA0160 Mark
         CONTINUE WHILE #FUN-CA0160 Add
      END IF
      
      INITIALIZE l_oha02_old,l_oha01_min_o,l_oha01_max_o,l_azn05_old TO NULL                                    
      INITIALIZE l_oha02,l_oha02_num,l_oha01_min,l_oha01_max,l_azn05 TO NULL
      LET l_sql = "SELECT DISTINCT MIN(to_number(oha01)),oha02,MAX(to_number(oha01)) FROM oha_temp GROUP BY oha02 order by oha02"
      PREPARE sel_oha02_pre FROM l_sql
      DECLARE sel_oha02_cs CURSOR FOR sel_oha02_pre
      FOREACH sel_oha02_cs INTO l_oha01_min,l_oha02,l_oha01_max
      
         #自动编号
         LET g_ndate = l_oha02
        #CALL p200_auto_doc(p_gat01,p_azw01) RETURNING l_oha01     #FUN-CC0082 Mark
         CALL p200_auto_doc(p_gat01,p_azw01,'Y') RETURNING l_oha01 #FUN-CC0082 Add
         IF g_success = 'N' THEN
           #RETURN     #FUN-CA0160 Mark
            EXIT WHILE #FUN-CA0160 Add
         END IF
         
         CASE g_ryz05
            WHEN "1"
               LET l_num_len = 8
            WHEN "2"
               LET l_num_len = 9
            WHEN "3"
               LET l_num_len = 10
         END CASE
         
         CASE g_ryz06
            WHEN "1"
               LET l_num_len = l_num_len
               IF NOT cl_null(l_oha02_old) THEN
                  LET l_oha02_num = l_oha01_max_o - l_oha01_min_o + 1 + l_oha02_num
               ELSE
                  LET l_oha02_num = 0
               END IF
            WHEN "2"
               LET l_num_len = l_num_len - 4
               IF NOT cl_null(l_oha02_old) THEN #若FOREACH之前还有日期
                  IF YEAR(l_oha02_old) = YEAR(l_oha02) AND MONTH(l_oha02_old) = MONTH(l_oha02) THEN
                     LET l_oha02_num = l_oha01_max_o - l_oha01_min_o + 1 + l_oha02_num
                  ELSE
                     LET l_oha02_num = 0
                  END IF
               ELSE
                  LET l_oha02_num = 0
               END IF
            WHEN "3"
               LET l_num_len = l_num_len - 4
               IF NOT cl_null(l_oha02_old) THEN
                  INITIALIZE l_azn05 TO NULL
                  SELECT azn05 INTO l_azn05 FROM azn_file WHERE azn01 = l_oha02
                  IF YEAR(l_oha02_old) = YEAR(l_oha02) AND l_azn05_old = l_azn05 THEN
                     LET l_oha02_num = l_oha01_max_o - l_oha01_min_o + 1 + l_oha02_num
                  ELSE
                     LET l_oha02_num = 0
                  END IF
               ELSE
                  LET l_oha02_num = 0
               END IF
            WHEN "4"
               LET l_num_len = l_num_len - 6
              #FUN-D30061 Mark&Add Begin ---
              #IF NOT cl_null(l_oha02_old) THEN
              #   LET l_oha02_num = l_oha01_max_o - l_oha01_min_o + 1 + l_oha02_num
              #ELSE
              #   LET l_oha02_num = 0
              #END IF
               LET l_oha02_num = 0
              #FUN-D30061 Mark&Add End -----
         END CASE
            
         LET l_oha01_min_o = l_oha01_min
         LET l_oha01_max_o = l_oha01_max
         LET l_azn05_old   = l_azn05
         LET l_oha02_old   = l_oha02
               
         INITIALIZE l_num_str TO NULL
         FOR l_cnt = 1 TO l_num_len
            LET l_num_str = l_num_str CLIPPED,'0'
         END FOR
         LET l_oha01_str = l_oha01
         LET l_oha01_num = l_oha01_str.subString(l_oha01_str.getLength() - l_num_len + 1,l_oha01_str.getLength())
         LET l_oha01_chr = l_oha01_str.subString(1,l_oha01_str.getLength() - l_num_len)
         LET l_oha01_num = l_oha01_num - l_oha01_min + l_oha02_num
         
         #批次更新oha_temp中的单号
         LET l_upd = "UPDATE oha_temp SET oha01 = '",l_oha01_chr CLIPPED,"'||","substr(to_char","((oha01 + '",l_oha01_num,"'),'",l_num_str,"'),2) ",
                     " WHERE oha02 = '",l_oha02,"' "
         PREPARE upd_oha01_pre FROM l_upd
         EXECUTE upd_oha01_pre
         IF SQLCA.sqlcode THEN
            LET g_success = 'N'
            LET g_errno   = SQLCA.sqlcode
            LET g_msg1    = 'Oper:Upd'||' '||'Table:oha_temp'||' '||'Field:oha01'||' '||'Shop:'||p_azw01
            CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
            ROLLBACK WORK
            CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
            LET g_msg   = g_msg[1,255]
            CALL p200_log(g_trans_no,p_azw01,'Batch Operation','02','TD_SALE',g_errno,g_msg,'0','N',g_msg1)
            LET g_errno = ''
            LET g_msg   = ''
            LET g_msg1  = ''
            CALL p200_upd_posflag_p('2',p_gat01,'td_sale',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
           #RETURN         #FUN-CA0160 Mark
            CONTINUE WHILE #FUN-CA0160 Add
         END IF
   
      END FOREACH
      
      #存在出货单未上传
      LET l_cnt = 0
      LET l_sql = "SELECT COUNT(*) ",
                  "  FROM ",g_posdbs,"td_sale",g_db_links," ",
                  " WHERE Condition2 <> 'Y' AND type = '0' AND shop = '",p_azw01,"' AND EXISTS (SELECT 1 FROM oha_temp WHERE oha16 = saleno AND oha16 IS NOT NULL)"
      PREPARE sel_oha_oga_pre FROM l_sql
      EXECUTE sel_oha_oga_pre INTO l_cnt
      IF l_cnt > 0 THEN
        #LET g_success = 'N' #FUN-D10023 Mark
         LET g_errno   = 'apc1053' #存在出货单未上传
         LET g_msg1    = 'Oper:Chk'||' '||'Table:oha_temp'||' '||'Shop:'||p_azw01
        #CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1) #FUN-CB0103 Mark
         CALL s_errmsg('Batch Operation:','',g_msg1,g_errno,1)       #FUN-CB0103 Add
        #ROLLBACK WORK #FUN-D10023 Mark
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','02','TD_SALE',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
      END IF

      #更新中间库状态为A
      LET l_upd = "UPDATE ",g_posdbs,"td_sale",g_db_links," a ",
                  "   SET a.Condition2 = 'A' ",
                  " WHERE a.Shop = '",p_azw01,"' AND a.Type IN ('1','2') ",
                  "   AND a.Saleno IN (SELECT oha98 ",       #FUN-D10023 Mod
                  "                      FROM oha_temp ",    #FUN-D10023 Mod
                  "                     WHERE EXISTS (SELECT 1 FROM ",g_posdbs,"td_sale",g_db_links," b ",
                  "                                    WHERE b.Condition2 <> 'Y' ",
                  "                                      AND b.Type = '0' AND b.Shop = '",p_azw01,"' ",
                  "                                      AND oha16 = b.Saleno) ",
                  "                       AND oha16 IS NOT NULL) "
      PREPARE upd_td_sale_flag_oha_pre1 FROM l_upd
      EXECUTE upd_td_sale_flag_oha_pre1
      
      #删除来源出货单未上传的单据
      LET l_sql = "DELETE FROM oha_temp ",
                  " WHERE EXISTS (SELECT 1 FROM ",g_posdbs,"td_sale",g_db_links," ",
                  "                WHERE Condition2 <> 'Y' ",
                  "                  AND type = '0' AND shop = '",p_azw01,"' ",
                  "                  AND oha16 = saleno) ",
                  "   AND oha16 IS NOT NULL "
      PREPARE del_oha_temp_pre FROM l_sql
      EXECUTE del_oha_temp_pre

     #FUN-D10023 Add Begin ---
      #出货单不存在
      LET l_cnt = 0
      LET l_sql = "SELECT COUNT(*) ",
                  "  FROM oha_temp ",
                  " WHERE oha16 NOT IN (SELECT Saleno FROM ",g_posdbs,"td_sale",g_db_links," ",
                  "                      WHERE Type = '0' AND Shop = '",p_azw01,"') ",
                  "   AND oha16 IS NOT NULL "
      PREPARE sel_oha_oga_pre2 FROM l_sql
      EXECUTE sel_oha_oga_pre2 INTO l_cnt
      IF l_cnt > 0 THEN
         LET g_errno   = 'apc1053' #存在出货单未上传
         LET g_msg1    = 'Oper:Chk'||' '||'Table:oha_temp'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,g_errno,1)
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','02','TD_SALE',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
      END IF

      #更新中间库状态为A
      LET l_upd = "UPDATE ",g_posdbs,"td_sale",g_db_links," a ",
                  "   SET a.Condition2 = 'A' ",
                  " WHERE a.Shop = '",p_azw01,"' AND a.Type IN ('1','2') ",
                  "   AND a.Saleno IN (SELECT oha98 ",
                  "                      FROM oha_temp ",
                  "                     WHERE oha16 NOT IN (SELECT b.Saleno FROM ",g_posdbs,"td_sale",g_db_links," b ",
                  "                                          WHERE b.Type = '0' AND b.Shop = '",p_azw01,"') ",
                  "                       AND oha16 IS NOT NULL) "
      PREPARE upd_td_sale_flag_oha_pre4 FROM l_upd
      EXECUTE upd_td_sale_flag_oha_pre4
            
      #删除来源出货单未上传的单据
      LET l_sql = "DELETE FROM oha_temp ",
                  " WHERE oha16 NOT IN (SELECT Saleno FROM ",g_posdbs,"td_sale",g_db_links," ",
                  "                      WHERE Type = '0' AND Shop = '",p_azw01,"') ",
                  "   AND oha16 IS NOT NULL "
      PREPARE del_oha_temp_pre2 FROM l_sql
      EXECUTE del_oha_temp_pre2
     #FUN-D10023 Add End -----
      
      #报错单据日期小于关帐日期的资料
      INITIALIZE l_oha02 TO NULL
      SELECT MIN(oha02) INTO l_oha02 FROM oha_temp WHERE oha02 <= g_sma.sma53
      IF NOT cl_null(l_oha02) THEN
         LET g_errno   = 'apc1054' #单据日期小于关帐日期
         LET g_msg1    = 'Oper:Chk'||' '||'Table:oha_temp'||' '||'Field:Min(oha02)'||' '||'Shop:'||p_azw01
        #CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1) #FUN-CB0103 Mark
         CALL s_errmsg('Batch Operation:','',g_msg1,g_errno,1)       #FUN-CB0103 Add
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','02','TD_SALE',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
      END IF

      #更新中间库状态为A
      LET l_upd = "UPDATE ",g_posdbs,"td_sale",g_db_links," ",
                  "   SET Condition2 = 'A' ",
                  " WHERE Shop = '",p_azw01,"' ",
                  "   AND EXISTS (SELECT 1 ",
                  "                 FROM oha_temp ",
                  "                WHERE oha02 <= '",g_sma.sma53,"' ",
                  "                  AND oha98 = Saleno) "
      PREPARE upd_td_sale_flag_oha_pre2 FROM l_upd
      EXECUTE upd_td_sale_flag_oha_pre2

      #删除单据日期小于关帐日期的资料
      DELETE FROM oha_temp WHERE oha02 <= g_sma.sma53
      
     ##存在订单未上传
     #LET l_cnt = 0
     #LET l_sql = "SELECT COUNT(*) ",
     #            "  FROM ",g_posdbs,"td_sale",g_db_links," a ",
     #            " WHERE a.Condition2 <> 'Y' AND a.type = '3' AND a.shop = '",p_azw01,"' ",
     #            "   AND saleno IN (SELECT ofno FROM ",g_posdbs,"td_sale",g_db_links," b ",
     #            "                   WHERE EXISTS (SELECT 1 ",
     #            "                                   FROM oha_temp ",
     #            "                                  WHERE oha16 = b.saleno AND oha16 IS NOT NULL) ",
     #            "                     AND b.shop = '",p_azw01,"' AND ofno IS NOT NULL AND otype = '1') "
     #PREPARE sel_oha_oea_pre FROM l_sql
     #EXECUTE sel_oha_oea_pre INTO l_cnt
     #IF l_cnt > 0 THEN
     #  #CALL s_errmsg()
     #   CALL p200_upd_posflag_p('2',p_gat01,'td_sale',p_azw01)
     #   CONTINUE WHILE
     #END IF
     
      #更新来源出货单单号
      LET l_sql= "UPDATE oha_temp ",
                 "   SET oha16 = (SELECT oga01 FROM ",cl_get_target_table(p_azw01,'oga_file'),
                 "                 WHERE oga98 = oha16 AND ogaconf = 'Y' AND ROWNUM = 1 ", 
                 "                   AND ogaplant = '",p_azw01,"' ) ",   #TQC-D30070 add
                 " WHERE oha16 IS NOT NULL "
      PREPARE upd_oha16_pre FROM l_sql
      EXECUTE upd_oha16_pre
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Upd'||' '||'Table:oha_temp'||' '||'Field:oha16'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','02','TD_SALE',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'td_sale',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF
      
      #更新汇率
     #LET l_sql = "SELECT oha23,oha02 FROM oha_temp "          #FUN-CB0103 Mark
      LET l_sql = "SELECT DISTINCT oha23,oha02 FROM oha_temp " #FUN-CB0103 Add
      PREPARE sel_oha23_pre FROM l_sql
      DECLARE sel_oha23_cs CURSOR FOR sel_oha23_pre
      FOREACH sel_oha23_cs INTO l_oha23,l_oha02
         CALL s_currm(l_oha23,l_oha02,g_oaz.oaz52,p_azw01) RETURNING l_oha24
         UPDATE oha_temp SET oha24 = l_oha24 WHERE oha23 = l_oha23 AND oha02 = l_oha02
         IF SQLCA.sqlcode THEN
            LET g_success = 'N'
            LET g_errno   = SQLCA.sqlcode
            LET g_msg1    = 'Oper:Upd'||' '||'Table:oha_temp'||' '||'Field:oha24'||' '||'Shop:'||p_azw01
            CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
            ROLLBACK WORK
            CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
            LET g_msg   = g_msg[1,255]
            CALL p200_log(g_trans_no,p_azw01,'Batch Operation','02','TD_SALE',g_errno,g_msg,'0','N',g_msg1)
            LET g_errno = ''
            LET g_msg   = ''
            LET g_msg1  = ''
            CALL p200_upd_posflag_p('2',p_gat01,'td_sale',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
            CONTINUE WHILE
         END IF
      END FOREACH
      
      #ins ohb_temp开始
      LET l_ins = "INSERT INTO ohb_temp( ",
                  "                     ohb01, ",            #销退单号
                  "                     ohb03, ",            #项次
                  "                     ohb04, ",            #产品编号
                  "                     ohb05, ",            #销售单位
                  "                     ohb05_fac, ",        #销售/库存单位换算率
                  "                     ohb06, ",            #品名规格
                  "                     ohb08, ",            #销退入库营运中心编号
                  "                     ohb09, ",            #销退入库仓库编号
                  "                     ohb12, ",            #数量
                  "                     ohb13, ",            #原币单价
                  "                     ohb14, ",            #原币税前金额
                  "                     ohb14t, ",           #原币含税金额
                  "                     ohb15, ",            #库存明细单位由厂/仓/位/批自动得出
                  "                     ohb15_fac, ",        #销售/库存明细单位换算率
                  "                     ohb16, ",            #数量
                  "                     ohb30, ",            #原出货发票号
                  "                     ohb31, ",            #出货单号
                  "                     ohb32, ",            #出货项次
                  "                     ohb33, ",            #订单单号
                  "                     ohb34, ",            #订单项次
                  "                     ohb37, ",            #基础单价
                  "                     ohb40, ",            #抽成编号
                  "                     ohb60, ",            #已开折让数量
                  "                     ohb61, ",            #检验
                  "                     ohb64, ",            #经营方式
                  "                     ohb65, ",            #原扣率
                  "                     ohb66, ",            #新扣率
                  "                     ohb67, ",            #分摊折价=全部折价字段值的合计
                  "                     ohb68, ",            #有实物否  Y-是,N-否
                  "                     ohb69, ",            #摊位编号
                  "                     ohb70, ",            #商户编号
                  "                     ohb71, ",            #开票性质
                  "                     ohb916, ",           #计价单位
                  "                     ohb917, ",           #计价数量
                  "                     ohb930, ",           #成本中心
                  "                     ohb1004, ",          #搭增
                  "                     ohb1005, ",          #作业方式
                  "                     ohbplant, ",         #所属营运中心
                  "                     ohblegal) "          #所属法人
      LET l_sel = "SELECT ",
                  "       oha01, ",                                      #ohb01          #销退单号
                  "       item, ",                                       #ohb03          #项次
                  "       CASE WHEN featureno IS NULL THEN pluno ",      #ohb04          #产品编号
                  "            WHEN featureno = ' '   THEN pluno ",
                  "            ELSE featureno END, ",
                  "       unit, ",                                       #ohb05          #销售单位
                  "       '0', ",                                        #ohb05_fac      #销售/库存单位换算率
                  "       NULL, ",                                       #ohb06          #品名规格
                  "       shop, ",                                       #ohb08          #销退入库营运中心编号
                  "       '",g_rtz07,"', ",                              #ohb09          #销退入库仓库编号
                  "       qty, ",                                        #ohb12          #数量
                  "       price, ",                                      #ohb13          #原币单价
                  "       uamt, ",                                       #ohb14          #原币税前金额
                  "       amt, ",                                        #ohb14t         #原币含税金额
                  "       NULL, ",                                       #ohb15          #库存明细单位
                  "       '0', ",                                        #ohb15_fac      #销售/库存明细单位换算率
                  "       qty, ",                                        #ohb16          #数量
                  "       NULL, ",                                       #ohb30          #原出货发票号
                  "       oha16, ",                                      #ohb31          #出货单号
                  "       CASE WHEN oha16 IS NOT NULL THEN oitem ",      #ohb32          #出货项次
                  "            ELSE NULL END, ",
                  "       NULL, ",                                       #ohb33          #订单单号
                  "       NULL, ",                                       #ohb34          #订单项次
                  "       oldprice, ",                                   #ohb37          #基础单价
                  "       mno, ",                                        #ohb40          #抽成编号
                  "       0, ",                                          #ohb60          #已开折让数量
                  "       'N', ",                                        #ohb61          #检验
                  "       '1', ",                                        #ohb64          #经营方式
                  "       NULL, ",                                       #ohb65          #原扣率
                  "       NULL, ",                                       #ohb66          #新扣率
                  "       disc, ",                                       #ohb67          #分摊折价=全部折价字段值的合计
                  "       'N', ",                                        #ohb68          #有实物否Y-是,N-否
                  "       counterno, ",                                  #ohb69          #摊位编号
                  "       NULL, ",                                       #ohb70          #商户编号
                  "       NULL, ",                                       #ohb71          #开票性质
                  "       unit, ",                                       #ohb916         #计价单位
                  "       qty, ",                                        #ohb917         #计价数量
                  "       NULL, ",                                       #ohb930         #成本中心
                  "       'N', ",                                        #ohb1004        #搭增
                  "       '1', ",                                        #ohb1005        #作业方式
                  "       shop, ",                                       #ohbplant       #所属营运中心
                  "       ohalegal  ",                                   #ohblegal       #所属法人
                  "  FROM ",g_posdbs,"td_sale_detail",g_db_links,",oha_temp ",
                  " WHERE shop = '",p_azw01,"' AND cnfflg = 'Y' AND saleno = oha98 ",
                  " ORDER BY item "
      LET l_sql = l_ins CLIPPED," ",l_sel CLIPPED
      PREPARE ins_ohb_temp_pre FROM l_sql
      EXECUTE ins_ohb_temp_pre
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Ins'||' '||'Table:ohb_temp'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
        #CALL p200_log(g_trans_no,p_azw01,'Batch Operation','02','TD_SALE',g_errno,g_msg,'0','N',g_msg1)        #FUN-CA0160 Mark
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','02','TD_SALE_DETAIL',g_errno,g_msg,'0','N',g_msg1) #FUN-CA0160 Add
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'td_sale',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF
      
      #抓取不存在ohb的oha   
      LET l_cnt = 0
      LET l_sql = "SELECT count(*) FROM oha_temp WHERE oha01 NOT IN (SELECT ohb01 FROM ohb_temp) "
      PREPARE sel_oha01_pre FROM l_sql
      EXECUTE sel_oha01_pre INTO l_cnt
      IF l_cnt > 0 THEN
         LET g_errno   = 'apc1051' #存在单身无资料的单据
         LET g_msg1    = 'Oper:Chk'||' '||'Table:oha_temp'||' '||'Shop:'||p_azw01
        #CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1) #FUN-CB0103 Mark
         CALL s_errmsg('Batch Operation:','',g_msg1,g_errno,1)       #FUN-CB0103 Add
        #ROLLBACK WORK #FUN-D10023 Mark
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
        #CALL p200_log(g_trans_no,p_azw01,'Batch Operation','02','TD_SALE',g_errno,g_msg,'0','N',g_msg1)        #FUN-CA0160 Mark
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','02','TD_SALE_DETAIL',g_errno,g_msg,'0','N',g_msg1) #FUN-CA0160 Add
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
      END IF

      #更新中间库状态为A
      LET l_upd = "UPDATE ",g_posdbs,"td_sale",g_db_links," ",
                  "   SET Condition2 = 'A' ",
                  " WHERE Shop = '",p_azw01,"' ",
                  "   AND EXISTS (SELECT 1 ",
                  "                 FROM oha_temp ",
                  "                WHERE oha01 NOT IN (SELECT ohb01 FROM ohb_temp) ",
                  "                  AND oha98 = Saleno) "
      PREPARE upd_td_sale_flag_oha_pre3 FROM l_upd
      EXECUTE upd_td_sale_flag_oha_pre3
   
      #删除不存在ohb的oha
      DELETE FROM oha_temp WHERE oha01 NOT IN (SELECT ohb01 FROM ohb_temp)
      
      #更新品名规格
      LET l_upd = "UPDATE ohb_temp ",
                  "   SET ohb06 = ",
                  "       (SELECT ima02 FROM ",cl_get_target_table(p_azw01,'ima_file'),
                  "         WHERE ima01 = ohb04) "
      PREPARE upd_ohb_temp_pre1 FROM l_upd
      EXECUTE upd_ohb_temp_pre1
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Upd'||' '||'Table:ohb_temp'||' '||'Field:ohb06'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
        #CALL p200_log(g_trans_no,p_azw01,'Batch Operation','02','TD_SALE',g_errno,g_msg,'0','N',g_msg1)        #FUN-CA0160 Mark
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','02','TD_SALE_DETAIL',g_errno,g_msg,'0','N',g_msg1) #FUN-CA0160 Add
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'td_sale',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF
      
      #更新库存单位
      LET l_upd = "UPDATE ohb_temp ",
                  "   SET ohb15 = ",
                  "       (SELECT ima25 FROM ",cl_get_target_table(p_azw01,'ima_file'),
                  "         WHERE ima01 = ohb04) "
      PREPARE upd_ohb_temp_pre2 FROM l_upd
      EXECUTE upd_ohb_temp_pre2
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Upd'||' '||'Table:ohb_temp'||' '||'Field:oha15'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
        #CALL p200_log(g_trans_no,p_azw01,'Batch Operation','02','TD_SALE',g_errno,g_msg,'0','N',g_msg1)        #FUN-CA0160 Mark
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','02','TD_SALE_DETAIL',g_errno,g_msg,'0','N',g_msg1) #FUN-CA0160 Add
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'td_sale',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF
      
      #更新经营方式
      LET l_upd = "UPDATE ohb_temp ",
                  "   SET ohb64 = ",
                 #FUN-CB0103 Mark&Add Begin ---
                 #"       (SELECT COALESCE(rty06,'1') FROM ",cl_get_target_table(p_azw01,'rty_file'),
                 #"         WHERE rty01 = '",p_azw01,"' AND rty02 = ohb04) "
                  "       COALESCE((SELECT COALESCE(rty06,'1') FROM ",cl_get_target_table(p_azw01,'rty_file'),
                  "                  WHERE rty01 = '",p_azw01,"' AND rty02 = ohb04),'1') "
                 #FUN-CB0103 Mark&Add Begin ---
      PREPARE upd_ohb_temp_pre3 FROM l_upd
      EXECUTE upd_ohb_temp_pre3
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Upd'||' '||'Table:ohb_temp'||' '||'Field:ohb64'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
        #CALL p200_log(g_trans_no,p_azw01,'Batch Operation','02','TD_SALE',g_errno,g_msg,'0','N',g_msg1)        #FUN-CA0160 Mark
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','02','TD_SALE_DETAIL',g_errno,g_msg,'0','N',g_msg1) #FUN-CA0160 Add
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'td_sale',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF
      
      #更新单位换算率(销售单位=库存单位)
      UPDATE ohb_temp SET ohb05_fac = '1',ohb15_fac = '1' WHERE ohb05 = ohb15
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Upd'||' '||'Table:ohb_temp'||' '||'Field:ohb05_fac'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
        #CALL p200_log(g_trans_no,p_azw01,'Batch Operation','02','TD_SALE',g_errno,g_msg,'0','N',g_msg1)        #FUN-CA0160 Mark
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','02','TD_SALE_DETAIL',g_errno,g_msg,'0','N',g_msg1) #FUN-CA0160 Add
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'td_sale',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF
      
      #更新单位换算率(销售单位<>库存单位)
      LET l_sql = "UPDATE ohb_temp ",
                  "   SET ohb05_fac = ",
                 #FUN-CB0103 Mark&Add Begin ---
                 #"       (SELECT smd06/smd04 ",
                 #"          FROM ",cl_get_target_table(p_azw01,'smd_file'),
                 #"         WHERE smd01 = ohb04 AND smd02 = ohb05 AND smd03 = ohb15)",
                  "       COALESCE((SELECT smd06/smd04 ",
                  "                   FROM ",cl_get_target_table(p_azw01,'smd_file'),
                  "                  WHERE smd01 = ohb04 AND smd02 = ohb05 AND smd03 = ohb15),0)",
                 #FUN-CB0103 Mark&Add End -----
                  " WHERE ohb05 <> ohb15 AND ohb05_fac = 0 "
      PREPARE upd_ohb05_fac_p1 FROM l_sql
      EXECUTE upd_ohb05_fac_p1
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Upd'||' '||'Table:ohb_temp'||' '||'Field:ohb05_fac'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
        #CALL p200_log(g_trans_no,p_azw01,'Batch Operation','02','TD_SALE',g_errno,g_msg,'0','N',g_msg1)        #FUN-CA0160 Mark
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','02','TD_SALE_DETAIL',g_errno,g_msg,'0','N',g_msg1) #FUN-CA0160 Add
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'td_sale',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF

      LET l_sql = "UPDATE ohb_temp ",
                  "   SET ohb05_fac = ",
                 #FUN-CB0103 Mark&Add Begin ---
                 #"       (SELECT smd04/smd06 ",
                 #"          FROM ",cl_get_target_table(p_azw01,'smd_file'),
                 #"         WHERE smd01 = ohb04 AND smd03 = ohb05 AND smd02 = ohb15)",
                  "       COALESCE((SELECT smd04/smd06 ",
                  "                   FROM ",cl_get_target_table(p_azw01,'smd_file'),
                  "                  WHERE smd01 = ohb04 AND smd03 = ohb05 AND smd02 = ohb15),0)",
                 #FUN-CB0103 Mark&Add End -----
                  " WHERE ohb05 <> ohb15 AND ohb05_fac = 0 "
      PREPARE upd_ohb05_fac_p2 FROM l_sql
      EXECUTE upd_ohb05_fac_p2
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Upd'||' '||'Table:ohb_temp'||' '||'Field:ohb05_fac'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
        #CALL p200_log(g_trans_no,p_azw01,'Batch Operation','02','TD_SALE',g_errno,g_msg,'0','N',g_msg1)        #FUN-CA0160 Mark
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','02','TD_SALE_DETAIL',g_errno,g_msg,'0','N',g_msg1) #FUN-CA0160 Add
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'td_sale',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF

      LET l_sql = "UPDATE ohb_temp ",
                  "   SET ohb05_fac = ",
                 #FUN-CB0103 Mark&Add Begin ---
                 #"       (SELECT smc03/smc04 ",
                 #"          FROM ",cl_get_target_table(p_azw01,'smc_file'),
                 #"         WHERE smc01 = ohb05 AND smc02 = ohb15)",
                  "       COALESCE((SELECT smc03/smc04 ",
                  "                   FROM ",cl_get_target_table(p_azw01,'smc_file'),
                  "                  WHERE smc01 = ohb05 AND smc02 = ohb15),0)",
                 #FUN-CB0103 Mark&Add End -----
                  " WHERE ohb05 <> ohb15 AND ohb05_fac = 0 "
      PREPARE upd_ohb05_fac_p3 FROM l_sql
      EXECUTE upd_ohb05_fac_p3
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Upd'||' '||'Table:ohb_temp'||' '||'Field:ohb05_fac'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
        #CALL p200_log(g_trans_no,p_azw01,'Batch Operation','02','TD_SALE',g_errno,g_msg,'0','N',g_msg1)        #FUN-CA0160 Mark
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','02','TD_SALE_DETAIL',g_errno,g_msg,'0','N',g_msg1) #FUN-CA0160 Add
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'td_sale',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF

      LET l_sql = "UPDATE ohb_temp SET ohb15_fac = ohb05_fac,ohb16 = ohb16 * ohb15_fac WHERE ohb05 <> ohb15 "
      PREPARE upd_ohb15_fac_p FROM l_sql
      EXECUTE upd_ohb15_fac_p
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Upd'||' '||'Table:ohb_temp'||' '||'Field:ohb15_fac'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
        #CALL p200_log(g_trans_no,p_azw01,'Batch Operation','02','TD_SALE',g_errno,g_msg,'0','N',g_msg1)        #FUN-CA0160 Mark
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','02','TD_SALE_DETAIL',g_errno,g_msg,'0','N',g_msg1) #FUN-CA0160 Add
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'td_sale',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF
      
      #更新来源订单单号/项次
      LET l_sql = "UPDATE ohb_temp ",
                  "   SET ohb33 = ",
                  "       (SELECT ogb31 FROM ",cl_get_target_table(p_azw01,'ogb_file'),
                  "         WHERE ogb01 = ohb31 AND ogb03 = ohb32 ) ",
                  " WHERE ohb31 IS NOT NULL "
      PREPARE upd_ohb33_pre FROM l_sql
      EXECUTE upd_ohb33_pre
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Upd'||' '||'Table:ohb_temp'||' '||'Field:ohb33'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
        #CALL p200_log(g_trans_no,p_azw01,'Batch Operation','02','TD_SALE',g_errno,g_msg,'0','N',g_msg1)        #FUN-CA0160 Mark
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','02','TD_SALE_DETAIL',g_errno,g_msg,'0','N',g_msg1) #FUN-CA0160 Add
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'td_sale',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF

      #更新来源订单单号/项次
      LET l_sql = "UPDATE ohb_temp ",
                  "   SET ohb34 = ",
                  "       (SELECT ogb32 FROM ",cl_get_target_table(p_azw01,'ogb_file'),
                  "         WHERE ogb01 = ohb31 AND ogb03 = ohb32 ) ",
                  " WHERE ohb31 IS NOT NULL "
      PREPARE upd_ohb34_pre FROM l_sql
      EXECUTE upd_ohb34_pre
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Upd'||' '||'Table:ohb_temp'||' '||'Field:ohb34'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
        #CALL p200_log(g_trans_no,p_azw01,'Batch Operation','02','TD_SALE',g_errno,g_msg,'0','N',g_msg1)        #FUN-CA0160 Mark
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','02','TD_SALE_DETAIL',g_errno,g_msg,'0','N',g_msg1) #FUN-CA0160 Add
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'td_sale',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF
                  
      #更新成本中心
      LET l_sql = "UPDATE ohb_temp ",
                  "   SET ohb930 = ",
                  "       (SELECT gem10 FROM ",cl_get_target_table(p_azw01,'gem_file'),
                  "         WHERE EXISTS (SELECT 1 FROM oha_temp ",
                  "                        WHERE gem01 = oha15 ",
                  "                          AND oha01 = ohb01)) "
      PREPARE upd_ohb930_pre FROM l_sql
      EXECUTE upd_ohb930_pre
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Upd'||' '||'Table:ohb_temp'||' '||'Field:ohb930'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
        #CALL p200_log(g_trans_no,p_azw01,'Batch Operation','02','TD_SALE',g_errno,g_msg,'0','N',g_msg1)        #FUN-CA0160 Mark
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','02','TD_SALE_DETAIL',g_errno,g_msg,'0','N',g_msg1) #FUN-CA0160 Add
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'td_sale',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF
      
      #更新扣率(经营方式为代销或联营)
      LET l_sql = "UPDATE ohb_temp ",
                  "   SET (ohb65,ohb66) = ",
                  "       (SELECT rtv12,rtv12",
                  "          FROM ",cl_get_target_table(p_azw01,'rtv_file'),",",
                                    cl_get_target_table(p_azw01,'rtu_file'),",",
                                    cl_get_target_table(p_azw01,'rtt_file'),",",
                                    cl_get_target_table(p_azw01,'rty_file'),",oha_temp",
                  "         WHERE rtt01 = rtu04 ",
                  "           AND rtt02 = rtu02 ",
                  "           AND rttplant = rtuplant ",
                  "           AND rtuplant = '",p_azw01,"' ",
                  "           AND rtuconf = 'Y' ",
                  "           AND rtuplant = rtvplant ",
                  "           AND rtu01 = rtv01 ",
                  "           AND rtu02 = rtv02 ",
                  "           AND rty01 = '",p_azw01,"' ",
                  "           AND rty02 = ohb04 AND rtyacti = 'Y'",
                  "           AND rtu09 <= oha02 ",
                  "           AND rtu10 >= oha02 ",
                  "           AND rtu05 = rty05 ",
                  "           AND rtu06 = ohb64 ",
                  "           AND rtv04 = ohb04 ",
                  "           AND oha01 = ohb01 )",
                  " WHERE ohb64 IN ('3','4')"
      PREPARE upd_ohb65_p_pre1 FROM l_sql
      EXECUTE upd_ohb65_p_pre1
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Upd'||' '||'Table:ohb_temp'||' '||'Field:(ohb65/ohb66)'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
        #CALL p200_log(g_trans_no,p_azw01,'Batch Operation','02','TD_SALE',g_errno,g_msg,'0','N',g_msg1)        #FUN-CA0160 Mark
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','02','TD_SALE_DETAIL',g_errno,g_msg,'0','N',g_msg1) #FUN-CA0160 Add
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'td_sale',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF
      
      LET l_sql = "UPDATE ohb_temp ",
                  "   SET (ohb65,ohb66) = ",
                  "       (SELECT rtt11,rtt11",
                  "          FROM ",cl_get_target_table(p_azw01,'rtt_file'),",",
                                    cl_get_target_table(p_azw01,'rts_file'),",",
                                    cl_get_target_table(p_azw01,'rto_file'),",",
                                    cl_get_target_table(p_azw01,'rty_file'),",oha_temp",
                  "         WHERE rts01 = rtt01 ",
                  "           AND rttplant = rtsplant ",
                  "           AND rts02 = rtt02 ",
                  "           AND rtt04 = ohb04 ",
                  "           AND rto01 = rts04 ",
                  "           AND rtoplant = rtsplant ",
                  "           AND rto05 = rty05 ",
                  "           AND rty01 = '",p_azw01,"' ",
                  "           AND rty02 = ohb04 AND rtyacti = 'Y' ",
                  "           AND rto06 = ohb64 ",
                  "           AND rto08 <= oha02 ",
                  "           AND rto09 >= oha02 ",
                  "           AND rtt15 = 'Y' ",
                  "           AND rtoconf = 'Y' ",
                  "           AND rtsconf = 'Y' ",
                  "           AND rto03 = rts02 ",
                  "           AND rtoplant = '",p_azw01,"' ",
                  "           AND oha01 = ohb01 )",
                  " WHERE ohb64 IN ('3','4')",
                  "   AND ohb65 IS NULL "
      PREPARE upd_ohb65_p_pre2 FROM l_sql
      EXECUTE upd_ohb65_p_pre2
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Upd'||' '||'Table:ohb_temp'||' '||'Field:(ohb65/ohb66)'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
        #CALL p200_log(g_trans_no,p_azw01,'Batch Operation','02','TD_SALE',g_errno,g_msg,'0','N',g_msg1)        #FUN-CA0160 Mark
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','02','TD_SALE_DETAIL',g_errno,g_msg,'0','N',g_msg1) #FUN-CA0160 Add
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'td_sale',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF
      
      #更新商户(抓合同中的商户)
      LET l_sql = "UPDATE ohb_temp ",
                  "   SET ohb70 = ",
                  "       (SELECT DISTINCT lnt04 FROM ",cl_get_target_table(p_azw01,'lnt_file'),",oha_temp ",
                  "         WHERE lnt17 <= oha02 ",
                  "           AND lnt18 >= oha02 ",
                  "           AND lnt06  = ohb69 ",
                  "           AND (lnt26 = 'Y' OR lnt26 = 'S' OR lnt26 = 'E') ",
                  "           AND oha01 = ohb01 )",
                  " WHERE ohb69 IS NOT NULL "
      PREPARE upd_ohb70_p_pre1 FROM l_sql
      EXECUTE upd_ohb70_p_pre1
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Upd'||' '||'Table:ohb_temp'||' '||'Field:ohb70'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
        #CALL p200_log(g_trans_no,p_azw01,'Batch Operation','02','TD_SALE',g_errno,g_msg,'0','N',g_msg1)        #FUN-CA0160 Mark
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','02','TD_SALE_DETAIL',g_errno,g_msg,'0','N',g_msg1) #FUN-CA0160 Add
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'td_sale',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF
      
      #更新商户(抓预租协议中的商户)
      LET l_sql = "UPDATE ohb_temp ",
                  "   SET ohb70 = ",
                  "       (SELECT DISTINCT lih08 FROM ",cl_get_target_table(p_azw01,'lih_file'),",oha_temp ",
                  "         WHERE lih14 <= oha02 ",
                  "           AND lih15 >= oha02 ",
                  "           AND lih07  = ohb69 ",
                  "           AND lihconf = 'Y' ",
                  "           AND oha01 = ohb01 )",
                  " WHERE ohb69 IS NOT NULL ",
                  "   AND ohb70 IS NULL "
      PREPARE upd_ohb70_p_pre2 FROM l_sql
      EXECUTE upd_ohb70_p_pre2
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Upd'||' '||'Table:ohb_temp'||' '||'Field:ohb70'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
        #CALL p200_log(g_trans_no,p_azw01,'Batch Operation','02','TD_SALE',g_errno,g_msg,'0','N',g_msg1)        #FUN-CA0160 Mark
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','02','TD_SALE_DETAIL',g_errno,g_msg,'0','N',g_msg1) #FUN-CA0160 Add
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'td_sale',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF
      
      #ins xyz
      CALL p200_xyz_ins_p("oha_file",p_azw01)
      IF g_success='N' THEN
         ROLLBACK WORK
         CONTINUE WHILE
      END IF
      
      #ins rxc_file 开始
     #CALL p200_rxc_ins_p("oha_file",p_azw01)                       #FUN-CA0160 Mark
      CALL p200_rxc_ins_p("oha_file",p_azw01,"td_Sale_Detail_Agio") #FUN-CA0160 Add
      IF g_success = 'N' THEN
         ROLLBACK WORK
         CONTINUE WHILE
      END IF
      
      #ins ogk_file
      LET l_ins = " INSERT INTO ",cl_get_target_table(p_azw01,'ogk_file'),"(",
                  "        ogk01, ",                     #出貨單號
                  "        ogk02, ",                     #項次
                  "        ogk03, ",                     #序號
                  "        ogk04, ",                     #稅別
                  "        ogk05, ",                     #稅率
                  "        ogk06, ",                     #固定稅額
                  "        ogk07, ",                     #含稅否
                  "        ogk08, ",                     #未稅金額
                  "        ogk08t, ",                    #含稅金額
                  "        ogk09, ",                     #稅額
                  "        ogkdate, ",                   #最近修改日
                  "        ogkgrup, ",                   #資料所有部門
                  "        ogklegal, ",                  #所屬法人
                  "        ogkmodu, ",                   #資料修改者
                  "        ogkorig, ",                   #資料建立部門
                  "        ogkoriu, ",                   #資料建立者
                  "        ogkplant, ",                  #所屬營運中心
                  "        ogkuser) "                    #資料所有者

      LET l_sel = "SELECT DISTINCT ",
                  "       oha01, ",                            #ogk01    出貨單號
                  "       mitem, ",                            #ogk02    項次
                  "       item, ",                             #ogk03    序號
                  "       taxcode, ",                          #ogk04    稅別
                  "       taxrate, ",                          #ogk05    稅率
                  "       0, ",                                #ogk06    固定稅額
                  "       incltax, ",                          #ogk07    含稅否
                  "       uamt, ",                             #ogk08    未稅金額
                  "       amt, ",                              #ogk08t   含稅金額
                  "       tax, ",                              #ogk09    稅額
                  "       ohadate, ",                          #ogkdate  最近修改日
                  "       ohagrup, ",                          #ogkgrup  資料所有部門
                  "       ohalegal, ",                         #ogklegal 所屬法人
                  "       ohamodu, ",                          #ogkmodu  資料修改者
                  "       ohaorig, ",                          #ogkorig  資料建立部門
                  "       ohaoriu, ",                          #ogkoriu  資料建立者
                  "       shop, ",                             #ogkplant 所屬營運中心
                  "       ohauser ",                           #ogkuser  資料所有者
                  "  FROM ",g_posdbs,"td_sale_detail_taxdetail",g_db_links,",oha_temp ",
                  " WHERE shop = '",p_azw01,"' ",
                  "   AND saleno = oha98 ",
                  " ORDER BY mitem,item "
      LET l_sql = l_ins CLIPPED," ",l_sel CLIPPED
      PREPARE ins_ogk_p_pre FROM l_sql
      EXECUTE ins_ogk_p_pre
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Ins'||' '||'Table:ogk_file'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
        #CALL p200_log(g_trans_no,p_azw01,'Batch Operation','02','TD_SALE',g_errno,g_msg,'0','N',g_msg1)        #FUN-CA0160 Mark
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','02','TD_SALE_DETAIL',g_errno,g_msg,'0','N',g_msg1) #FUN-CA0160 Add
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'td_sale',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF
      
      #ins ogj_file
      LET l_ins = " INSERT INTO ",cl_get_target_table(p_azw01,'ogj_file'),"(",
                  "        ogj01, ",                     #出貨單號
                  "        ogj02, ",                     #序號
                  "        ogj03, ",                     #稅別
                  "        ogj04, ",                     #稅率
                  "        ogj05, ",                     #固定稅額
                  "        ogj06, ",                     #含稅否
                  "        ogj07, ",                     #未稅金額
                  "        ogj07t, ",                    #含稅金額
                  "        ogj08, ",                     #稅額
                  "        ogj09, ",                     #留抵稅額
                  "        ogjdate, ",                   #最近修改日
                  "        ogjgrup, ",                   #資料所有部門
                  "        ogjlegal, ",                  #所屬法人
                  "        ogjmodu, ",                   #資料修改者
                  "        ogjorig, ",                   #資料建立部門
                  "        ogjoriu, ",                   #資料建立者
                  "        ogjplant, ",                  #所屬營運中心
                  "        ogjuser) "                    #資料所有者

      LET l_sel = "SELECT DISTINCT ",
                  "       oha01, ",                            #ogj01    出貨單號
                  "       item, ",                             #ogj02    序號
                  "       taxcode, ",                          #ogj03    稅別
                  "       taxrate, ",                          #ogj04    稅率
                  "       0, ",                                #ogj05    固定稅額
                  "       incltax, ",                          #ogj06    含稅否
                  "       uamt, ",                             #ogj07    未稅金額
                  "       amt, ",                              #ogj07t   含稅金額
                  "       tax, ",                              #ogj08    稅額
                  "       acctax, ",                           #ogj09    留抵稅額
                  "       ohadate, ",                          #ogjdate  最近修改日
                  "       ohagrup, ",                          #ogjgrup  資料所有部門
                  "       ohalegal, ",                         #ogjlegal 所屬法人
                  "       ohamodu, ",                          #ogjmodu  資料修改者
                  "       ohaorig, ",                          #ogjorig  資料建立部門
                  "       ohaoriu, ",                          #ogjoriu  資料建立者
                  "       shop, ",                             #ogjplant 所屬營運中心
                  "       ohauser ",                           #ogjuser  資料所有者
                  "  FROM ",g_posdbs,"td_sale_taxmaster",g_db_links,",oha_temp ",
                  " WHERE shop = '",p_azw01,"' ",
                  "   AND saleno = oha98 ",
                  " ORDER BY item "
                  
      LET l_sql = l_ins CLIPPED," ",l_sel CLIPPED
      PREPARE ins_ogj_p_pre FROM l_sql
      EXECUTE ins_ogj_p_pre
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Ins'||' '||'Table:ogj_file'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
        #CALL p200_log(g_trans_no,p_azw01,'Batch Operation','02','TD_SALE',g_errno,g_msg,'0','N',g_msg1)        #FUN-CA0160 Mark
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','02','TD_SALE_DETAIL',g_errno,g_msg,'0','N',g_msg1) #FUN-CA0160 Add
         LET g_errno = ''  
         LET g_msg   = ''  
         LET g_msg1  = ''  
         CALL p200_upd_posflag_p('2',p_gat01,'td_sale',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF

      #更新中间库标志位
      CALL p200_upd_posflag_p("1","oha_file","td_sale",p_azw01)
      IF g_success = 'N' THEN
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Upd'||' '||'Table:td_sale'||' '||'Field:Condition2'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','02','TD_SALE',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'td_sale',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF
      
      #更新庫存
      IF g_success = 'Y' THEN
         CALL s_upimg_p('2','',p_azw01,'')
         IF g_success = 'N' THEN
           #FUN-CB0103 Add Begin ---
            ROLLBACK WORK
            CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
            LET g_msg   = g_msg[1,255]
            CALL p200_log(g_trans_no,p_azw01,'Batch Operation','02','TD_SALE',g_errno,g_msg,'0','N',g_msg1)
            LET g_errno = ''
            LET g_msg   = ''
            LET g_msg1  = ''
            CALL p200_upd_posflag_p('2',p_gat01,'td_sale',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
           #FUN-CB0103 Add End -----
            CONTINUE WHILE
         END IF
         CALL s_instlf_p('2','',p_azw01)
         IF g_success = 'N' THEN
           #FUN-CB0103 Add Begin ---
            ROLLBACK WORK
            CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
            LET g_msg   = g_msg[1,255]
            CALL p200_log(g_trans_no,p_azw01,'Batch Operation','02','TD_SALE',g_errno,g_msg,'0','N',g_msg1)
            LET g_errno = ''
            LET g_msg   = ''
            LET g_msg1  = ''
            CALL p200_upd_posflag_p('2',p_gat01,'td_sale',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
           #FUN-CB0103 Add End -----
            CONTINUE WHILE
         END IF
      END IF
      
      #将临时表oha_temp插入到数据库中
      LET l_ins = " INSERT INTO ",cl_get_target_table(p_azw01,'oha_file'),
                  " SELECT * FROM oha_temp " 
      CALL cl_replace_sqldb(l_ins) RETURNING l_ins
      CALL cl_parse_qry_sql(l_ins,p_azw01) RETURNING l_ins
      PREPARE ins_oha_p_pre FROM l_ins
      EXECUTE ins_oha_p_pre
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Ins'||' '||'Table:oha_file'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','02','TD_SALE',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''  
         LET g_msg   = ''  
         LET g_msg1  = ''  
         CALL p200_upd_posflag_p('2',p_gat01,'td_sale',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF
         
      #将临时表ohb_temp插入到数据库中
      LET l_ins = " INSERT INTO ",cl_get_target_table(p_azw01,'ohb_file'),
                  " SELECT * FROM ohb_temp "
      CALL cl_replace_sqldb(l_ins) RETURNING l_ins
      CALL cl_parse_qry_sql(l_ins,p_azw01) RETURNING l_ins
      PREPARE ins_ohb_p_pre FROM l_ins
      EXECUTE ins_ohb_p_pre
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Ins'||' '||'Table:ohb_file'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','02','TD_SALE',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''  
         LET g_msg   = ''  
         LET g_msg1  = ''  
         CALL p200_upd_posflag_p('2',p_gat01,'td_sale',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF
         
      #将临时表rxx_temp插入到数据库中
      LET l_ins = " INSERT INTO ",cl_get_target_table(p_azw01,'rxx_file'),
                  " SELECT * FROM rxx_temp "
      CALL cl_replace_sqldb(l_ins) RETURNING l_ins
      CALL cl_parse_qry_sql(l_ins,p_azw01) RETURNING l_ins
      PREPARE ins_rxx_p_pre2 FROM l_ins
      EXECUTE ins_rxx_p_pre2
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Ins'||' '||'Table:rxx_file'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','02','TD_SALE',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''  
         LET g_msg   = ''  
         LET g_msg1  = ''  
         CALL p200_upd_posflag_p('2',p_gat01,'td_sale',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF

      #将临时表rxy_temp插入到数据库中
      LET l_ins = " INSERT INTO ",cl_get_target_table(p_azw01,'rxy_file'),
                  " SELECT * FROM rxy_temp "
      CALL cl_replace_sqldb(l_ins) RETURNING l_ins
      CALL cl_parse_qry_sql(l_ins,p_azw01) RETURNING l_ins
      PREPARE ins_rxy_p_pre2 FROM l_ins
      EXECUTE ins_rxy_p_pre2
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Ins'||' '||'Table:rxy_file'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','02','TD_SALE',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'td_sale',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF

      #将临时表rxz_temp插入到数据库中
      LET l_ins = " INSERT INTO ",cl_get_target_table(p_azw01,'rxz_file'),
                  " SELECT * FROM rxz_temp "
      CALL cl_replace_sqldb(l_ins) RETURNING l_ins
      CALL cl_parse_qry_sql(l_ins,p_azw01) RETURNING l_ins
      PREPARE ins_rxz_p_pre2 FROM l_ins
      EXECUTE ins_rxz_p_pre2
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Ins'||' '||'Table:rxz_file'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','02','TD_SALE',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'td_sale',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF
      
      LET l_sql = "SELECT DISTINCT ohb01 FROM ohb_temp WHERE ohb64 IN ('2','3','4') ORDER BY ohb01 "
      PREPARE sel_ohb_temp_pre3 FROM l_sql
      DECLARE sel_ohb_temp_cs3 CURSOR FOR sel_ohb_temp_pre3
      FOREACH sel_ohb_temp_cs3 INTO l_oha01
         IF g_success = 'Y' THEN
            CALL t620sub1_post('2',l_oha01)           #經營方式處理
            IF g_success = 'N' THEN
               #經營方式報錯處理
               ROLLBACK WORK
               FOR l_i = 1 TO g_err_msg.getLength()
                  LET g_msg1 = 'TD_SALE'||'INS'||p_azw01||g_fno1
                  LET g_msg1 = g_err_msg[l_i].fld1||g_err_msg[l_i].fld2||g_err_msg[l_i].fld3
                  LET g_errno = g_err_msg[l_i].fld4
                  CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
                 #CALL p200_log(g_trans_no,p_azw01,g_fno1,'03','TD_SALE',g_errno,g_msg,'0','N',g_msg1) #FUN-CB0103 Mark
                  CALL p200_log(g_trans_no,p_azw01,g_fno1,'02','TD_SALE',g_errno,g_msg,'0','N',g_msg1) #FUN-CB0103 Add
               END FOR
            END IF
         END IF
         INITIALIZE l_oha01 TO NULL
      END FOREACH 
      
      IF g_success = 'Y' THEN
         LET g_sucflag = 1
         COMMIT WORK
      ELSE
         ROLLBACK WORK
      END IF
      
   END WHILE
  #FUN-CA0160 Add Begin ---
   #删除建立的临时表
   DROP TABLE oha_temp
   DROP TABLE ohb_temp
   DROP TABLE rxx_temp
   DROP TABLE rxy_temp
   DROP TABLE rxz_temp
  #FUN-CA0160 Add End -----
END FUNCTION
#FUN-CA0091 Add End -----

#FUN-CA0091 Add Begin ---
FUNCTION p200_rxa_p_ins(p_gat01,p_azw01)
DEFINE p_gat01       LIKE gat_file.gat01
DEFINE p_azw01       LIKE azw_file.azw01
DEFINE p_azw02       LIKE azw_file.azw02
DEFINE l_ins         STRING
DEFINE l_upd         STRING
DEFINE l_sql         STRING
DEFINE l_sel         STRING
DEFINE l_rxa01       LIKE rxa_file.rxa01
DEFINE l_rxacond     LIKE rxa_file.rxacond
DEFINE l_num_len     LIKE type_file.num10
DEFINE l_num_str     LIKE type_file.chr20
DEFINE l_rxa01_str   STRING
DEFINE l_rxa01_num   LIKE type_file.chr20
DEFINE l_rxa01_chr   LIKE type_file.chr20
DEFINE l_cnt         LIKE type_file.num5
DEFINE l_rxacond_old LIKE rxa_file.rxacond
DEFINE l_rxa01_min   LIKE rxa_file.rxa01
DEFINE l_rxa01_max   LIKE rxa_file.rxa01
DEFINE l_rxa01_min_o LIKE rxa_file.rxa01
DEFINE l_rxa01_max_o LIKE rxa_file.rxa01
DEFINE l_rxacond_num LIKE type_file.num10
DEFINE l_azn05       LIKE azn_file.azn05
DEFINE l_azn05_old   LIKE azn_file.azn05
DEFINE l_upd_num     LIKE type_file.num10

  #FUN-CA0160 Mark Begin ---
  ##先删除需要建立的临时表
  #DROP TABLE rxa_temp
  #DROP TABLE rxx_temp
  #DROP TABLE rxy_temp
  #DROP TABLE rxz_temp
  #
  ##建立临时表
  #SELECT * FROM rxa_file WHERE 1=0 INTO TEMP rxa_temp
  #SELECT * FROM rxx_file WHERE 1=0 INTO TEMP rxx_temp
  #SELECT * FROM rxy_file WHERE 1=0 INTO TEMP rxy_temp
  #SELECT * FROM rxz_file WHERE 1=0 INTO TEMP rxz_temp
  #
  ##建立索引
  #CREATE INDEX rxa_temp_01 ON rxa_temp (rxa08)
  #CREATE INDEX rxa_temp_02 ON rxa_temp (rxa01)
  #FUN-CA0160 Mark Begin ---
   
   #组出过滤条件
   IF NOT cl_null(g_saleno) THEN
      LET g_wc = " saleno = '",g_saleno,"' "
   ELSE
     #CALL p200_g_wc() RETURNING g_wc           #FUN-CA0160 Mark
      CALL p200_g_wc("rxa_file") RETURNING g_wc #FUN-CA0160 Add
   END IF
   IF cl_null(g_wc) THEN LET g_wc = " 1=1" END IF

   SELECT azw02 INTO p_azw02 FROM azw_file WHERE azw01 = p_azw01 #FUN-CA0160 Add
   
   #将中间库中满足条件的单据Condition2更新为B
   LET l_upd = "UPDATE ",g_posdbs,"td_sale",g_db_links," ",
               "   SET Condition2 = 'B' ",
               " WHERE Condition2 <> 'Y' AND Type = '4' AND Cnfflg = 'Y' AND Shop = '",p_azw01 CLIPPED,"' AND ",g_wc CLIPPED
   PREPARE upd_td_sale_rxa_pre FROM l_upd
   EXECUTE upd_td_sale_rxa_pre
   IF SQLCA.sqlcode THEN
      LET g_success = 'N'
      LET g_errno   = SQLCA.sqlcode
      LET g_msg1    = 'Oper:Upd'||' '||'Table:td_sale'||' '||'Shop:'||p_azw01
      CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
      ROLLBACK WORK
      CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
      LET g_msg   = g_msg[1,255]
     #CALL p200_log(g_trans_no,p_azw01,'Batch Operation','02','TD_SALE',g_errno,g_msg,'0','N',g_msg1) #FUN-CB0103 Mark
      CALL p200_log(g_trans_no,p_azw01,'Batch Operation','03','TD_SALE',g_errno,g_msg,'0','N',g_msg1) #FUN-CB0103 Add
      LET g_errno = ''
      LET g_msg   = ''
      LET g_msg1  = ''
      RETURN
   END IF
   
   LET l_upd_num = SQLCA.sqlerrd[3]
   IF l_upd_num <= 0 THEN RETURN END IF
   IF cl_null(g_sum_limit) OR g_sum_limit = 0 THEN LET g_sum_limit = l_upd_num END IF
   
  #FUN-CA0160 Add Begin ---
   #先删除需要建立的临时表
   DROP TABLE rxa_temp
   DROP TABLE rxx_temp
   DROP TABLE rxy_temp
   DROP TABLE rxz_temp

   #建立临时表
   SELECT * FROM rxa_file WHERE 1=0 INTO TEMP rxa_temp
   SELECT * FROM rxx_file WHERE 1=0 INTO TEMP rxx_temp
   SELECT * FROM rxy_file WHERE 1=0 INTO TEMP rxy_temp
   SELECT * FROM rxz_file WHERE 1=0 INTO TEMP rxz_temp

   #建立索引
   CREATE INDEX rxa_temp_01 ON rxa_temp (rxa08)
   CREATE INDEX rxa_temp_02 ON rxa_temp (rxa01)
  #FUN-CA0160 Add Begin ---

   WHILE l_upd_num > 0 #剩余笔数大于0做WHILE循环
      LET l_upd_num = l_upd_num - g_sum_limit #依次减去每批的笔数
      
      #清空临时表
      DELETE FROM rxa_temp
      DELETE FROM rxx_temp
      DELETE FROM rxy_temp
      DELETE FROM rxz_temp
      
      LET g_success = 'Y'
      BEGIN WORK

      LET l_ins = "INSERT INTO rxa_temp( ",
                  "                     rxa01, ",         #退回单号
                  "                     rxa09, ",         #單據日期 #FUN-D30097 add
                  "                     rxa02, ",         #订单单号
                  "                     rxa03, ",         #客户编号
                  "                     rxa04, ",         #已冲金额
                  "                     rxa05, ",         #已退金额
                  "                     rxa06, ",         #可退金额
                  "                     rxa07, ",         #备注
                  "                     rxa08, ",         #POS单号
                  "                     rxa900, ",        #状况码
                  "                     rxaacti, ",       #资料有效码
                  "                     rxacond, ",       #审核日期
                  "                     rxaconu, ",       #审核人员
                  "                     rxacrat, ",       #资料创建日
                  "                     rxadate, ",       #最近更改日
                  "                     rxadays, ",       #签核完成天数
                  "                     rxagrup, ",       #资料所有部门
                  "                     rxalegal, ",      #法人别
                  "                     rxamksg, ",       #是否签核
                  "                     rxamodu, ",       #资料更改者
                  "                     rxaplant, ",      #所属营运中心
                  "                     rxaprit, ",       #签核优先等级
                  "                     rxasign, ",       #签核等级
                  "                     rxasmax, ",       #应签核顺序
                  "                     rxasseq, ",       #已签核顺序
                  "                     rxauser, ",       #资料所有者
                  "                     rxaconf, ",       #审核码
                  "                     rxacont, ",       #审核时间
                  "                     rxaoriu, ",       #资料建立者
                  "                     rxaorig) "        #资料建立部门
      LET l_sel = "SELECT ",
                  "       ROW_NUMBER() over(order by Shop,Saleno), ",         #rxa01         #退回单号
                  "       CAST(bdate AS DATE), ",                             #rxa09         #單據日期 #FUN-D30097 add
                  "       ofno, ",                                            #rxa02         #订单单号
                  "       '', ",                                              #rxa03         #客户编号
                  "       0, ",                                               #rxa04         #已冲金额
                  "       0, ",                                               #rxa05         #已退金额
                  "       tot_amt, ",                                         #rxa06         #可退金额
                  "       memo, ",                                            #rxa07         #备注
                  "       saleno, ",                                          #rxa08         #POS单号
                  "       '1', ",                                             #rxa900        #状况码
                  "       'Y', ",                                             #rxaacti       #资料有效码
                  "       CAST(sdate AS DATE), ",                             #rxacond       #审核日期
                  "       ryi02, ",                                           #rxaconu       #审核人员
                  "       CAST(sdate AS DATE), ",                             #rxacrat       #资料创建日
                  "       CAST(sdate AS DATE), ",                             #rxadate       #最近更改日
                  "       0, ",                                               #rxadays       #签核完成天数
                  "       gen03, ",                                           #rxagrup       #资料所有部门
                  "       '",p_azw02,"', ",                                   #rxalegal      #法人别
                  "       'N', ",                                             #rxamksg       #是否签核
                  "       '', ",                                              #rxamodu       #资料更改者
                  "       shop, ",                                            #rxaplant      #所属营运中心
                  "       '0', ",                                             #rxaprit       #签核优先等级
                  "       '0', ",                                             #rxasign       #签核等级
                  "       '0', ",                                             #rxasmax       #应签核顺序
                  "       '0', ",                                             #rxasseq       #已签核顺序
                  "       ryi02, ",                                           #rxauser       #资料所有者
                  "       'Y', ",                                             #rxaconf       #审核码
                  "       stime[1,2]||':'||stime[3,4]||':'||stime[5,6], ",    #rxacont       #审核时间
                  "       ryi02, ",                                           #rxaoriu       #资料建立者
                  "       gen03 ",                                            #rxaorig       #资料建立部门
                  "  FROM( ",
                  "SELECT * ",
                  "  FROM ",g_posdbs,"td_sale",g_db_links," ",
                  " WHERE Shop = '",p_azw01,"' AND Type = '4' AND Condition2 = 'B' AND Cnfflg = 'Y' ",
                 #" ORDER BY sdate,saleno) LEFT OUTER JOIN ",cl_get_target_table(p_azw01,'ryi_file'), #FUN-D10144 Mark
                  " ORDER BY Bdate,saleno) LEFT OUTER JOIN ",cl_get_target_table(p_azw01,'ryi_file'), #FUN-D10144 Add
                  "                                     ON ryi01 = opno ",
                  "                        LEFT OUTER JOIN ",cl_get_target_table(p_azw01,'gen_file'),
                  "                                     ON gen01 = ryi02 ",
                  " WHERE ROWNUM <= ",g_sum_limit," ",
                  " ORDER BY sdate,saleno "
      LET l_sql = l_ins CLIPPED," ",l_sel CLIPPED
      PREPARE ins_rxa_temp_pre FROM l_sql
      EXECUTE ins_rxa_temp_pre
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Ins'||' '||'Table:rxa_temp'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
        #CALL p200_log(g_trans_no,p_azw01,'Batch Operation','02','TD_SALE',g_errno,g_msg,'0','N',g_msg1) #FUN-CB0103 Mark
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','03','TD_SALE',g_errno,g_msg,'0','N',g_msg1) #FUN-CB0103 Add
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
        #RETURN         #FUN-CA0160 Mark
         CONTINUE WHILE #FUN-CA0160 Add
      END IF
      
      INITIALIZE l_rxacond_old,l_rxa01_min_o,l_rxa01_max_o,l_azn05_old TO NULL                                    
      INITIALIZE l_rxacond,l_rxacond_num,l_rxa01_min,l_rxa01_max,l_azn05 TO NULL
      LET l_sql = "SELECT DISTINCT MIN(to_number(rxa01)),rxacond,MAX(to_number(rxa01)) FROM rxa_temp GROUP BY rxacond order by rxacond"
      PREPARE sel_rxacond_pre FROM l_sql
      DECLARE sel_rxacond_cs CURSOR FOR sel_rxacond_pre
      FOREACH sel_rxacond_cs INTO l_rxa01_min,l_rxacond,l_rxa01_max
      
        #自动编号
         LET g_ndate = l_rxacond
        #CALL p200_auto_doc(p_gat01,p_azw01) RETURNING l_rxa01     #FUN-CC0082 Mark
         CALL p200_auto_doc(p_gat01,p_azw01,'Y') RETURNING l_rxa01 #FUN-CC0082 Add
         IF g_success = 'N' THEN
           #RETURN     #FUN-CA0160 Mark
            EXIT WHILE #FUN-CA0160 Add
         END IF
         
         CASE g_ryz05
            WHEN "1"
               LET l_num_len = 8
            WHEN "2"
               LET l_num_len = 9
            WHEN "3"
               LET l_num_len = 10
         END CASE
         
         CASE g_ryz06
            WHEN "1" #按流水号
               LET l_num_len = l_num_len
               IF NOT cl_null(l_rxacond_old) THEN
                  #已排流水号个数   = 最大流水号旧值- 最小流水号旧值+ 1 + 上一笔已排流水号个数
                  LET l_rxacond_num = l_rxa01_max_o - l_rxa01_min_o + 1 + l_rxacond_num
               ELSE
                  LET l_rxacond_num = 0
               END IF
            WHEN "2" #按年月
               LET l_num_len = l_num_len - 4
               IF NOT cl_null(l_rxacond_old) THEN 
                  IF YEAR(l_rxacond_old) = YEAR(l_rxacond) AND MONTH(l_rxacond_old) = MONTH(l_rxacond) THEN
                     LET l_rxacond_num = l_rxa01_max_o - l_rxa01_min_o + 1 + l_rxacond_num
                  ELSE
                     LET l_rxacond_num = 0
                  END IF
               ELSE
                  LET l_rxacond_num = 0
               END IF
            WHEN "3" #按年周
               LET l_num_len = l_num_len - 4
               IF NOT cl_null(l_rxacond_old) THEN
                  INITIALIZE l_azn05 TO NULL
                  SELECT azn05 INTO l_azn05 FROM azn_file WHERE azn01 = l_rxacond
                  IF YEAR(l_rxacond_old) = YEAR(l_rxacond) AND l_azn05_old = l_azn05 THEN
                     LET l_rxacond_num = l_rxa01_max_o - l_rxa01_min_o + 1 + l_rxacond_num
                  ELSE
                     LET l_rxacond_num = 0
                  END IF
               ELSE
                  LET l_rxacond_num = 0
               END IF
            WHEN "4" #按年月日
               LET l_num_len = l_num_len - 6
              #FUN-D30061 Mark&Add Begin ---
              #IF NOT cl_null(l_rxacond_old) THEN
              #   LET l_rxacond_num = l_rxa01_max_o - l_rxa01_min_o + 1 + l_rxacond_num
              #ELSE
              #   LET l_rxacond_num = 0
              #END IF
               LET l_rxacond_num = 0
              #FUN-D30061 Mark&Add End -----
         END CASE
            
         LET l_rxa01_min_o = l_rxa01_min
         LET l_rxa01_max_o = l_rxa01_max
         LET l_azn05_old   = l_azn05
         LET l_rxacond_old   = l_rxacond
               
         INITIALIZE l_num_str TO NULL
         FOR l_cnt = 1 TO l_num_len
            LET l_num_str = l_num_str CLIPPED,'0'
         END FOR
         LET l_rxa01_str = l_rxa01
         LET l_rxa01_num = l_rxa01_str.subString(l_rxa01_str.getLength() - l_num_len + 1,l_rxa01_str.getLength())
         LET l_rxa01_chr = l_rxa01_str.subString(1,l_rxa01_str.getLength() - l_num_len)
         
         #   最大流水号  = 实际流水号  - 最小ROWNUM  + 已排流水号个数
         LET l_rxa01_num = l_rxa01_num - l_rxa01_min + l_rxacond_num
         
         #批次更新rxa_temp中的单号
         LET l_upd = "UPDATE rxa_temp SET rxa01 = '",l_rxa01_chr CLIPPED,"'||","substr(to_char","((rxa01 + '",l_rxa01_num,"'),'",l_num_str,"'),2) ",
                     " WHERE rxacond = '",l_rxacond,"' "
         PREPARE upd_rxa01_pre FROM l_upd
         EXECUTE upd_rxa01_pre
         IF SQLCA.sqlcode THEN
            LET g_success = 'N'
            LET g_errno   = SQLCA.sqlcode
            LET g_msg1    = 'Oper:Upd'||' '||'Table:rxa_temp'||' '||'Field:rxa01'||' '||'Shop:'||p_azw01
            CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
            ROLLBACK WORK
            CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
            LET g_msg   = g_msg[1,255]
           #CALL p200_log(g_trans_no,p_azw01,'Batch Operation','02','TD_SALE',g_errno,g_msg,'0','N',g_msg1) #FUN-CB0103 Mark
            CALL p200_log(g_trans_no,p_azw01,'Batch Operation','03','TD_SALE',g_errno,g_msg,'0','N',g_msg1) #FUN-CB0103 Add
            LET g_errno = ''
            LET g_msg   = ''
            LET g_msg1  = ''
           #RETURN         #FUN-CA0160 Mark
            CONTINUE WHILE #FUN-CA0160 Add
         END IF
      END FOREACH
      
      #判断来源订单是否上传
      LET l_cnt = 0
      LET l_sql = "SELECT COUNT(*) ",
                  "  FROM ",g_posdbs,"td_sale",g_db_links," ",
                  " WHERE Condition2 <> 'Y' AND type = '3' AND shop = '",p_azw01,"' AND EXISTS (SELECT 1 FROM rxa_temp WHERE rxa02 = saleno AND rxa02 IS NOT NULL)"
      PREPARE sel_rxa_oea_pre FROM l_sql
      EXECUTE sel_rxa_oea_pre INTO l_cnt
      IF l_cnt > 0 THEN
        #LET g_success = 'N' #FUN-D10023 Mark
         LET g_errno   = 'apc1052'
         LET g_msg1    = 'Oper:Chk'||' '||'Table:rxa_temp'||' '||'Shop:'||p_azw01
        #CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1) #FUN-CB0103 Mark
         CALL s_errmsg('Batch Operation:','',g_msg1,g_errno,1)       #FUN-CB0103 Add
        #ROLLBACK WORK #FUN-D10023 Mark
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
        #CALL p200_log(g_trans_no,p_azw01,'Batch Operation','01','TD_SALE',g_errno,g_msg,'0','N',g_msg1) #FUN-CB0103 Mark
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','03','TD_SALE',g_errno,g_msg,'0','N',g_msg1) #FUN-CB0103 Add
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
        #CALL p200_upd_posflag_p('2',p_gat01,'td_sale',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A #FUN-D10023 Mark
        #CONTINUE WHILE #FUN-D10023 Mark
      END IF

      #更新中间库状态为A
      LET l_upd = "UPDATE ",g_posdbs,"td_sale",g_db_links," a ",
                  "   SET a.Condition2 = 'A' ",
                  " WHERE a.Shop = '",p_azw01,"' AND a.Type = '4' ",
                  "   AND a.Saleno IN (SELECT rxa08 ",
                  "                      FROM rxa_temp ",
                  "                     WHERE EXISTS (SELECT 1 FROM ",g_posdbs,"td_sale",g_db_links," b ",
                  "                                    WHERE b.Condition2 <> 'Y' ",
                  "                                      AND b.Type = '3' AND b.Shop = '",p_azw01,"' ",
                  "                                      AND rxa02 = b.Saleno) ",
                  "                       AND rxa02 IS NOT NULL) "
      PREPARE upd_td_sale_flag_rxa_pre1 FROM l_upd
      EXECUTE upd_td_sale_flag_rxa_pre1
      
      #删除来源订单未上传的单据
      LET l_sql = "DELETE FROM rxa_temp ",
                  " WHERE EXISTS (SELECT 1 FROM ",g_posdbs,"td_sale",g_db_links," ",
                  "                WHERE Condition2 <> 'Y' ",
                  "                  AND type = '3' AND shop = '",p_azw01,"' ",
                  "                  AND rxa02 = saleno) ",
                  "   AND rxa02 IS NOT NULL "
      PREPARE del_rxa_temp_pre FROM l_sql
      EXECUTE del_rxa_temp_pre

     #FUN-D10023 Add Begin ---
      #判断来源订单是否存在
      LET l_cnt = 0
      LET l_sql = "SELECT COUNT(*) ",
                  "  FROM rxa_temp ",
                  " WHERE rxa02 NOT IN (SELECT Saleno FROM ",g_posdbs,"td_Sale",g_db_links," ",
                  "                      WHERE Type = '3' AND Shop = '",p_azw01,"') ",
                  "   AND rxa02 IS NOT NULL "
      PREPARE sel_rxa_oea_pre2 FROM l_sql
      EXECUTE sel_rxa_oea_pre2 INTO l_cnt
      IF l_cnt > 0 THEN
         LET g_errno   = 'apc1052'
         LET g_msg1    = 'Oper:Chk'||' '||'Table:rxa_temp'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,g_errno,1)
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','03','TD_SALE',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
      END IF         
         
      #更新中间库状态为A
      LET l_upd = "UPDATE ",g_posdbs,"td_sale",g_db_links," a ",
                  "   SET a.Condition2 = 'A' ",
                  " WHERE a.Shop = '",p_azw01,"' AND a.Type = '4' ",
                  "   AND a.Saleno IN (SELECT rxa08 ",
                  "                      FROM rxa_temp ",
                  "                     WHERE rxa02 NOT IN (SELECT b.Saleno FROM ",g_posdbs,"td_Sale",g_db_links," b ",
                  "                                          WHERE b.Type = '3' AND b.Shop = '",p_azw01,"') ",
                  "                       AND rxa02 IS NOT NULL) "
      PREPARE upd_td_sale_flag_rxa_pre2 FROM l_upd
      EXECUTE upd_td_sale_flag_rxa_pre2

      #删除来源订单未上传的单据
      LET l_sql = "DELETE FROM rxa_temp ",
                  " WHERE rxa02 NOT IN (SELECT Saleno FROM ",g_posdbs,"td_Sale",g_db_links," ",
                  "                      WHERE Type = '3' AND Shop = '",p_azw01,"') ",
                  "   AND rxa02 IS NOT NULL "
      PREPARE del_rxa_temp_pre2 FROM l_sql
      EXECUTE del_rxa_temp_pre2
     #FUN-D10023 Add End -----
      
      #FUN-CB0103 Add Begin ---
      #更新中间库订单结案码
      IF g_success = 'Y' THEN
         LET l_upd = "UPDATE ",g_posdbs,"td_sale",g_db_links," ",
                     "   SET ecsflg = 'Y', ",
                     "       ecsdate = (SELECT CAST(",cl_tp_tochar("rxacond",'YYYYMMDD')," AS NVARCHAR2(8)) FROM rxa_temp ",
                     "                   WHERE rxa02 IS NOT NULL ",
                     "                     AND rxa02 = Saleno AND Shop = rxaplant) ",
                     " WHERE EXISTS (SELECT 1 FROM rxa_temp ",
                     "                WHERE rxa02 IS NOT NULL ",
                    #"                  AND rxa02 = Saleno AND Shop = ogaplant) " #FUN-D10023 Mark
                     "                  AND rxa02 = Saleno AND Shop = rxaplant) " #FUN-D10023 Add
         PREPARE upd_ecsflg_rxa_p_pre FROM l_upd
         EXECUTE upd_ecsflg_rxa_p_pre
         IF SQLCA.sqlcode THEN
            LET g_success = 'N'
            LET g_errno   = SQLCA.sqlcode
            LET g_msg1    = 'Oper:Upd'||' '||'Table:td_Sale'||' '||'Field:(ecsflg/ecsdate)'||' '||'Shop:'||p_azw01
            CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
            ROLLBACK WORK
            CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
            LET g_msg   = g_msg[1,255]
            CALL p200_log(g_trans_no,p_azw01,'Batch Operation','03','TD_SALE',g_errno,g_msg,'0','N',g_msg1)
            LET g_errno = ''
            LET g_msg   = ''
            LET g_msg1  = ''
            CALL p200_upd_posflag_p('2',p_gat01,'td_sale',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
            CONTINUE WHILE
         END IF
      END IF
      #FUN-CB0103 Add End -----

      #更新客户编号
      LET l_upd = "UPDATE rxa_temp ",
                  "   SET rxa03 = ",
                  "       (SELECT oea03 FROM ",cl_get_target_table(p_azw01,'oea_file'),
                  "         WHERE oea94 = rxa02 AND ROWNUM = 1 ",
                  "           AND oeaplant = '",p_azw01,"' ) ",   #TQC-D30070 add 
                  " WHERE rxa02 IS NOT NULL "
      PREPARE upd_rxa03_pre FROM l_upd
      EXECUTE upd_rxa03_pre 
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Upd'||' '||'Table:rxa_temp'||' '||'Field:rxa03'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
        #CALL p200_log(g_trans_no,p_azw01,'Batch Operation','01','TD_SALE',g_errno,g_msg,'0','N',g_msg1) #FUN-CB0103 Mark
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','03','TD_SALE',g_errno,g_msg,'0','N',g_msg1) #FUN-CB0103 Add
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'td_sale',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF
      
      #更新来源订单单号
      LET l_upd = "UPDATE rxa_temp ",
                  "   SET rxa02 = ",
                  "       (SELECT oea01 FROM ",cl_get_target_table(p_azw01,'oea_file'),
                  "         WHERE oea94 = rxa02 AND ROWNUM = 1  ",
                  "           AND oeaplant = '",p_azw01,"' ) ",   #TQC-D30070 add
                  " WHERE rxa02 IS NOT NULL "
      PREPARE upd_rxa02_pre FROM l_upd
      EXECUTE upd_rxa02_pre 
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Upd'||' '||'Table:rxa_temp'||' '||'Field:rxa02'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
        #CALL p200_log(g_trans_no,p_azw01,'Batch Operation','01','TD_SALE',g_errno,g_msg,'0','N',g_msg1) #FUN-CB0103 Mark
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','03','TD_SALE',g_errno,g_msg,'0','N',g_msg1) #FUN-CB0103 Add
         LET g_errno = '' 
         LET g_msg   = ''   
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'td_sale',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF
      
     #FUN-CB0103 Mod Begin ---
      #更新订单单身结案码
      LET l_upd = "UPDATE ",cl_get_target_table(p_azw01,'oeb_file'),
                  "   SET oeb70 = 'Y' ",
                  "      ,oeb70d = (SELECT rxacond FROM rxa_temp WHERE rxa02 = oeb01) ", #FUN-CB0103 Add
                  "      ,oeb26  = oeb12 - oeb24 + oeb25 ",                              #FUN-CB0103 Add
                  " WHERE EXISTS (SELECT 1 FROM rxa_temp WHERE rxa02 = oeb01) "
      PREPARE upd_oeb_p_pre FROM l_upd
      EXECUTE upd_oeb_p_pre
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Upd'||' '||'Table:oeb_file'||' '||'Field:oeb70'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
        #CALL p200_log(g_trans_no,p_azw01,'Batch Operation','01','TD_SALE',g_errno,g_msg,'0','N',g_msg1) #FUN-CB0103 Mark
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','03','TD_SALE',g_errno,g_msg,'0','N',g_msg1) #FUN-CB0103 Add
         LET g_errno = '' 
         LET g_msg   = ''   
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'td_sale',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF

      #更新订单单头结案码
      LET l_upd = "UPDATE ",cl_get_target_table(p_azw01,'oea_file'),
                  "   SET oea49 = '2' ",
                  "      ,oea63 = (SELECT SUM(oeb14/oeb12*oeb26) FROM ",cl_get_target_table(p_azw01,'oeb_file'), #FUN-CB0103 Add
                  "                 WHERE oeb01 = oea01) ",                                                      #FUN-CB0103 Add
                  " WHERE EXISTS (SELECT 1 FROM rxa_temp WHERE rxa02 = oea01) "
      PREPARE upd_oea_p_pre FROM l_upd
      EXECUTE upd_oea_p_pre
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Upd'||' '||'Table:oea_file'||' '||'Field:oea49'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
        #CALL p200_log(g_trans_no,p_azw01,'Batch Operation','01','TD_SALE',g_errno,g_msg,'0','N',g_msg1) #FUN-CB0103 Mark
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','03','TD_SALE',g_errno,g_msg,'0','N',g_msg1) #FUN-CB0103 Add
         LET g_errno = '' 
         LET g_msg   = ''   
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'td_sale',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF
     #FUN-CB0103 Mod End -----
      
      #付款
      #ins xyz
      CALL p200_xyz_ins_p("rxa_file",p_azw01)
      IF g_success='N' THEN
         ROLLBACK WORK
         CONTINUE WHILE
      END IF
      
      #更新中间库标志位
      CALL p200_upd_posflag_p("1","rxa_file","td_sale",p_azw01)
      IF g_success = 'N' THEN
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Upd'||' '||'Table:td_sale'||' '||'Field:Condition2'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','03','TD_SALE',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'td_sale',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF
      
      #将临时表rxa_temp插入到数据库中
      LET l_ins = " INSERT INTO ",cl_get_target_table(p_azw01,'rxa_file'),
                  " SELECT * FROM rxa_temp " 
      CALL cl_replace_sqldb(l_ins) RETURNING l_ins
      CALL cl_parse_qry_sql(l_ins,p_azw01) RETURNING l_ins
      PREPARE ins_rxa_p_pre FROM l_ins
      EXECUTE ins_rxa_p_pre
      IF SQLCA.sqlcode THEN 
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Ins'||' '||'Table:rxa_file'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
        #CALL p200_log(g_trans_no,p_azw01,'Batch Operation','01','TD_SALE',g_errno,g_msg,'0','N',g_msg1) #FUN-CB0103 Mark
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','03','TD_SALE',g_errno,g_msg,'0','N',g_msg1) #FUN-CB0103 Add
         LET g_errno = '' 
         LET g_msg   = ''   
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'td_sale',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF 
         
      #将临时表rxx_temp插入到数据库中
      LET l_ins = " INSERT INTO ",cl_get_target_table(p_azw01,'rxx_file'),
                  " SELECT * FROM rxx_temp "
      CALL cl_replace_sqldb(l_ins) RETURNING l_ins
      CALL cl_parse_qry_sql(l_ins,p_azw01) RETURNING l_ins
      PREPARE ins_rxx_p_pre4 FROM l_ins
      EXECUTE ins_rxx_p_pre4
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Ins'||' '||'Table:rxx_file'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
        #CALL p200_log(g_trans_no,p_azw01,'Batch Operation','01','TD_SALE',g_errno,g_msg,'0','N',g_msg1) #FUN-CB0103 Mark
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','03','TD_SALE',g_errno,g_msg,'0','N',g_msg1) #FUN-CB0103 Add
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'td_sale',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF

      #将临时表rxy_temp插入到数据库中
      LET l_ins = " INSERT INTO ",cl_get_target_table(p_azw01,'rxy_file'),
                  " SELECT * FROM rxy_temp "
      CALL cl_replace_sqldb(l_ins) RETURNING l_ins
      CALL cl_parse_qry_sql(l_ins,p_azw01) RETURNING l_ins
      PREPARE ins_rxy_p_pre4 FROM l_ins
      EXECUTE ins_rxy_p_pre4
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Ins'||' '||'Table:rxy_file'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
        #CALL p200_log(g_trans_no,p_azw01,'Batch Operation','01','TD_SALE',g_errno,g_msg,'0','N',g_msg1) #FUN-CB0103 Mark
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','03','TD_SALE',g_errno,g_msg,'0','N',g_msg1) #FUN-CB0103 Add
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'td_sale',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF

      #将临时表rxz_temp插入到数据库中
      LET l_ins = " INSERT INTO ",cl_get_target_table(p_azw01,'rxz_file'),
                  " SELECT * FROM rxz_temp "
      CALL cl_replace_sqldb(l_ins) RETURNING l_ins
      CALL cl_parse_qry_sql(l_ins,p_azw01) RETURNING l_ins
      PREPARE ins_rxz_p_pre4 FROM l_ins
      EXECUTE ins_rxz_p_pre4
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Ins'||' '||'Table:rxz_file'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
        #CALL p200_log(g_trans_no,p_azw01,'Batch Operation','01','TD_SALE',g_errno,g_msg,'0','N',g_msg1) #FUN-CB0103 Mark
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','03','TD_SALE',g_errno,g_msg,'0','N',g_msg1) #FUN-CB0103 Add
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'td_sale',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF
      
      IF g_success = 'Y' THEN
         LET g_sucflag = 1
         COMMIT WORK
      ELSE
         ROLLBACK WORK
      END IF
      
   END WHILE
  #FUN-CA0160 Add Begin ---
   #删除建立的临时表
   DROP TABLE rxa_temp
   DROP TABLE rxx_temp
   DROP TABLE rxy_temp
   DROP TABLE rxz_temp
  #FUN-CA0160 Add End -----
END FUNCTION
#FUN-CA0091 Add End -----

#FUN-CA0091 Add Begin ---
#FUNCTION p200_rxc_ins_p(p_gat01,p_azw01)        #FUN-CA0160 Mark
FUNCTION p200_rxc_ins_p(p_gat01,p_azw01,p_table) #FUN-CA0160 Add
DEFINE p_gat01      LIKE gat_file.gat01
DEFINE p_rxc00      LIKE rxc_file.rxc00
DEFINE p_azw01      LIKE azw_file.azw01
DEFINE p_table      LIKE type_file.chr100 #FUN-CA0160 Add
DEFINE l_sql        STRING
DEFINE l_upd        STRING
DEFINE l_rxc        RECORD LIKE rxc_file.*
DEFINE l_count      LIKE type_file.num5
DEFINE l_ryl04      LIKE ryl_file.ryl04
DEFINE l_table_head LIKE type_file.chr20
DEFINE l_table_body LIKE type_file.chr20
DEFINE l_field      RECORD
       hkey         LIKE type_file.chr100,
       bkey         LIKE type_file.chr100,
       rxc01        LIKE type_file.chr100,
       rxc02        LIKE type_file.chr100,
       rxclegal     LIKE type_file.chr100,
       rxc11        LIKE type_file.chr100,
       ogb1001      LIKE type_file.chr100,
       shop         LIKE type_file.chr100,
       saleno       LIKE type_file.chr100
                    END RECORD
DEFINE l_no_str     LIKE type_file.chr20  #FUN-CA0160 Add

   LET g_time = TIME

   IF p_azw01 IS NULL THEN RETURN END IF
   LET l_sql = ''

   IF g_psell_way = '2' THEN
      CASE p_gat01
         WHEN "oea_file"          #訂單
            LET p_rxc00 = '01'
            LET l_ryl04 = '01'
            LET l_table_head = 'oea_temp'
            LET l_table_body = 'oeb_temp'
            LET l_field.hkey = 'oea01'
            LET l_field.bkey = 'oeb01'
            LET l_field.rxc01 = 'oeb01'
            LET l_field.rxc02 = 'oeb03'
            LET l_field.rxclegal = 'oeblegal'
            LET l_field.rxc11 = "CASE WHEN oea87 IS NOT NULL THEN 'Y' ELSE 'N' END"
            LET l_field.ogb1001 = "oeb1001"
            LET l_field.shop = "oeaplant"
            LET l_field.saleno = "oea94"
            LET l_no_str       = "Saleno" #FUN-CA0160 Add

         WHEN "oga_file"          #銷售單
            LET p_rxc00 = '02'
            LET l_ryl04 = '02'
            LET l_table_head = 'oga_temp'
            LET l_table_body = 'ogb_temp'
            LET l_field.hkey = 'oga01'
            LET l_field.bkey = 'ogb01'
            LET l_field.rxc01 = 'ogb01'
            LET l_field.rxc02 = 'ogb03'
            LET l_field.rxclegal = 'ogblegal'
            LET l_field.rxc11 = "CASE WHEN oga87 IS NOT NULL THEN 'Y' ELSE 'N' END"
            LET l_field.ogb1001 = "ogb1001"
            LET l_field.shop = "ogaplant"
            LET l_field.saleno = "oga98"
            LET l_no_str       = "Saleno" #FUN-CA0160 Add

         WHEN "oha_file"          #銷退單
            LET p_rxc00 = '03'
            LET l_ryl04 = '02'
            LET l_table_head = 'oha_temp'
            LET l_table_body = 'ohb_temp'
            LET l_field.hkey = 'oha01'
            LET l_field.bkey = 'ohb01'
            LET l_field.rxc01 = 'ohb01'
            LET l_field.rxc02 = 'ohb03'
            LET l_field.rxclegal = 'ohblegal'
            LET l_field.rxc11 = "CASE WHEN oha87 IS NOT NULL THEN 'Y' ELSE 'N' END"
            LET l_field.ogb1001 = "ohb50"
            LET l_field.shop = "ohaplant"
            LET l_field.saleno = "oha98"
            LET l_no_str       = "Saleno" #FUN-CA0160 Add

        #FUN-CA0160 Add Begin ---
         WHEN "rxe_file_2"          #售券
            LET p_rxc00 = '02'
            LET l_ryl04 = '05'
            LET l_table_head = 'oga_temp'
            LET l_table_body = 'ogb_temp'
            LET l_field.hkey = 'oga01'
            LET l_field.bkey = 'ogb01'
            LET l_field.rxc01 = 'ogb01'
            LET l_field.rxc02 = 'ogb03'
            LET l_field.rxclegal = 'ogblegal'
            LET l_field.rxc11 = "CASE WHEN oga87 IS NOT NULL THEN 'Y' ELSE 'N' END"
            LET l_field.ogb1001 = "ogb1001"
            LET l_field.shop = "ogaplant"
            LET l_field.saleno = "oga98"
            LET l_no_str       = "SaleCouponno"

         WHEN "rxe_file_3"          #退券
            LET p_rxc00 = '03'
            LET l_ryl04 = '05'
            LET l_table_head = 'oha_temp'
            LET l_table_body = 'ohb_temp'
            LET l_field.hkey = 'oha01'
            LET l_field.bkey = 'ohb01'
            LET l_field.rxc01 = 'ohb01'
            LET l_field.rxc02 = 'ohb03'
            LET l_field.rxclegal = 'ohblegal'
            LET l_field.rxc11 = "CASE WHEN oha87 IS NOT NULL THEN 'Y' ELSE 'N' END"
            LET l_field.ogb1001 = "ohb50"
            LET l_field.shop = "ohaplant"
            LET l_field.saleno = "oha98"
            LET l_no_str       = "SaleCouponno"
        #FUN-CA0160 Add End -----
      END CASE
   ELSE  #匯總
   END IF

   IF g_psell_way = '2' THEN  #明細
      LET l_sql = " INSERT INTO ",cl_get_target_table(p_azw01,'rxc_file'),"( ",
                  "        rxc00,rxc01,rxc02,rxc03,rxc04, ",
                  "        rxc05,rxc06,rxc07,rxc08,rxc09, ",
                  "        rxc10,rxclegal,rxcplant,rxc11,rxc12, ",
                  "        rxc13,rxc14,rxc15) ",
                  " SELECT rxc00,rxc01,rxc02,rxc03,rxc04,rxc05,SUM(rxc06),rxc07,rxc08,rxc09,rxc10, ",
                  "        rxclegal,rxcplant,rxc11,rxc12,rxc13,rxc14,rxc15 FROM (",
                  " SELECT DISTINCT ",
                  " '",p_rxc00,"' rxc00,",                                           #rxc00    单据别:01-订单,02-销售单,03-销退單
                  " ",l_field.rxc01," rxc01, ",                                      #rxc01    單號
                  " mitem rxc02, ",                                                  #rxc02    項次
                  "(CASE dctype WHEN 7  THEN '01'  ",                                #rxc03    折價方式 - 01.一般促銷
                  "             WHEN 8  THEN '02'  ",                                #rxc03    折價方式 - 02.組合促銷
                  "             WHEN 9  THEN '03'  ",                                #rxc03    折價方式 - 03.滿額促銷
                  "             WHEN 11 THEN '06'  ",                                #rxc03    折價方式 - 06.會員價
                  "             WHEN 10 THEN '12'  ",                                #rxc03    折價方式 - 12.促銷會員價
                  "             WHEN 1  THEN '13'  ",                                #rxc03    折價方式 - 13.單項折價
                  "             WHEN 2  THEN '13'  ",                                #rxc03    折價方式 - 13.單項折價
                  "             WHEN 3  THEN '13'  ",                                #rxc03    折價方式 - 13.單項折價
                  "             WHEN 4  THEN '14'  ",                                #rxc03    折價方式 - 14.小計折價
                  "             WHEN 5  THEN '14'  ",                                #rxc03    折價方式 - 14.小計折價
                  "             WHEN 6  THEN '14'  ",                                #rxc03    折價方式 - 14.小計折價
                  "             WHEN 15 THEN '15'  ",                                #rxc03    折價方式 - 15.折扣券   #FUN-D10040 Add
                  "             WHEN 12 THEN '18' END)  rxc03, ",                    #rxc03    折價方式 - 16.強迫折價
                  "(CASE WHEN (pmtno IS NULL) THEN CAST(' ' AS NVARCHAR2(20)) ELSE pmtno END) rxc04, ", #rxc04    促銷單號
                  " '' rxc05, ",                                                     #rxc05    分類促銷單號
                  " disc rxc06, ",                                                   #rxc06    折價金額
                  " 0 rxc07, ",                                                      #rxc07    廠商促銷分攤比例
                  " '' rxc08, ",                                                     #rxc08    返券促銷單號
                  " 0 rxc09, ",                                                      #rxc09    返券金額
                  " 0 rxc10, ",                                                      #rxc10    廠商返券分攤比例
                  " ",l_field.rxclegal," rxclegal, ",                                #rxclegal 所屬法人
                  " shop rxcplant, ",                                                #rxcplant 所屬營運中心
                  " ",l_field.rxc11," rxc11, ",                                      #rxc11    是否會員
                  " '' rxc12, ",                                                     #rxc12    結算營運中心
                  " '' rxc13, ",                                                     #rxc13    分攤廠商
                  " '' rxc14, ",                                                     #rxc14    分攤來源單號
                  " qty rxc15 ",                                                     #rxc15    數量-參加促銷的數量
                 #"  FROM ",g_posdbs,"td_sale_detail_agio",g_db_links,",",l_table_head,",",l_table_body, #FUN-CA0160 Mark
                  "  FROM ",g_posdbs,p_table CLIPPED,g_db_links,",",l_table_head,",",l_table_body,       #FUN-CA0160 Add
                  " WHERE shop = ",l_field.shop," AND mitem = ",l_field.rxc02," ",
                 #"   AND saleno = ",l_field.saleno," AND ",l_field.hkey," = ",l_field.bkey," )",        #FUN-CA0160 Mark
                  "   AND ",l_no_str," = ",l_field.saleno," AND ",l_field.hkey," = ",l_field.bkey," )",  #FUN-CA0160 Add
                  " GROUP BY rxc00,rxc01,rxc02,rxc03,rxc04,rxc05,rxc07,rxc08,rxc09,rxc10, ",
                  "          rxclegal,rxcplant,rxc11,rxc12,rxc13,rxc14,rxc15"
   ELSE  #匯總
   END IF
   PREPARE ins_rxc_p_pre FROM l_sql
   EXECUTE ins_rxc_p_pre
   IF SQLCA.sqlcode THEN
      LET g_success = 'N'
      LET g_errno   = SQLCA.sqlcode
      LET g_msg1    = 'Oper:Ins'||' '||'Table:rxc_file'||' '||'Shop:'||p_azw01
      CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
      ROLLBACK WORK
      CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
      LET g_msg   = g_msg[1,255]
     #CALL p200_log(g_trans_no,p_azw01,'Batch Operation','01','TD_SALE',g_errno,g_msg,'0','N',g_msg1)                #FUN-CA0160 Mark
      CALL p200_log(g_trans_no,p_azw01,'Batch Operation',l_ryl04,'TD_SALE_DETAIL_AGIO',g_errno,g_msg,'0','N',g_msg1) #FUN-CA0160 Add
      LET g_errno = ''
      LET g_msg   = ''
      LET g_msg1  = ''
      CALL p200_upd_posflag_p('2',p_gat01,'td_sale',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
      RETURN
   END IF         
   
   #若為換贈，則寫理由碼 
   LET l_upd = "UPDATE ",l_table_body,           
               "   SET ",l_field.ogb1001," = '",g_oaz.oaz88,"' ",                       
               " WHERE EXISTS (SELECT 1 FROM ",cl_get_target_table(p_azw01,'rxc_file'),",",l_table_body, 
               "                WHERE rxc01 = ",l_field.rxc01," ",
               "                  AND rxc02 = ",l_field.rxc02," ",   
               "                  AND rxc03 = '18' )"
                         
   CALL cl_replace_sqldb(l_upd) RETURNING l_upd
   CALL cl_parse_qry_sql(l_upd,p_azw01) RETURNING l_upd
   PREPARE upd_ogb1001_pre FROM l_upd
   EXECUTE upd_ogb1001_pre
   IF SQLCA.sqlcode THEN
      LET g_success = 'N'
      LET g_errno   = SQLCA.sqlcode
      LET g_msg1    = 'Oper:Upd'||' '||'Table:'||l_table_body||' '||'Shop:'||p_azw01
      CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
      ROLLBACK WORK
      CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
      LET g_msg   = g_msg[1,255]
      CALL p200_log(g_trans_no,p_azw01,'Batch Operation',l_ryl04,'TD_SALE_DETAIL_AGIO',g_errno,g_msg,'0','N',g_msg1)
      LET g_errno = ''
      LET g_msg   = ''
      LET g_msg1  = ''
      CALL p200_upd_posflag_p('2',p_gat01,'td_sale',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
      RETURN
   END IF
END FUNCTION
#FUN-CA0091 Add End -----

#FUN-CA0091 Add Begin ---
FUNCTION p200_xyz_ins_p(p_gat01,p_azw01)
DEFINE p_gat01   LIKE gat_file.gat01
DEFINE p_doctype LIKE rxx_file.rxx00       #單據別
DEFINE p_paytype LIKE rxx_file.rxx03       #款別類型1收款/-1退款
DEFINE p_azw01   LIKE azw_file.azw01
DEFINE l_ins     STRING
DEFINE l_sel     STRING
DEFINE l_sql     STRING
DEFINE p_sdate   LIKE type_file.chr50
DEFINE p_stime   LIKE type_file.chr50
DEFINE p_rxy12   LIKE type_file.chr50
DEFINE p_num     LIKE type_file.chr1
DEFINE p_rxy06   STRING
DEFINE l_ryl04   LIKE ryl_file.ryl04
DEFINE l_lqe01   LIKE lqe_file.lqe01
DEFINE l_lqe19   LIKE lqe_file.lqe19
DEFINE l_table   LIKE type_file.chr20
DEFINE l_field   RECORD
       rxy01     LIKE type_file.chr100,
       rxy34     LIKE type_file.chr100, #FUN-CC0082 Add
       rxyplant  LIKE type_file.chr100,
       rxylegal  LIKE type_file.chr100,
       shop      LIKE type_file.chr100,
       saleno    LIKE type_file.chr100,
       lqe18     LIKE type_file.chr100,
       lqe19     LIKE type_file.chr100,
       rxz01     LIKE type_file.chr100,
       rxz08     LIKE type_file.chr100,
       rxzlegal  LIKE type_file.chr100
                 END RECORD

   LET g_time = TIME                  #CURRENT TIME

   IF p_azw01 IS NULL THEN RETURN END IF
   LET l_sql = ''
   LET l_sel = ''
   LET l_ins = ''

   CASE p_gat01
      WHEN "oea_file"           #訂單
         LET p_doctype = '01'
         LET p_sdate   = "CAST (sdate AS DATE)"
         LET p_stime   = "stime[1,2]||':'||stime[3,4]||':'||stime[5,6]"
         LET p_paytype = '1'
         LET l_ryl04   = '01'
         LET l_table   = "oea_temp"
         LET l_field.rxy01    = "oea01"      #单号
         LET l_field.rxyplant = "oeaplant"   #所属营运中心
         LET l_field.rxylegal = "oealegal"   #所属法人
         LET l_field.shop     = "oeaplant"   #门店编号
         LET l_field.saleno   = "oea94"      #POS单号
         LET l_field.lqe18    = "oeaplant"   #核销门店
         LET l_field.lqe19    = "oea02"      #核销日期
         LET l_field.rxz01    = "oea01"      #单号
         LET l_field.rxz08    = "oeauser"    #刷卡人员
         LET l_field.rxzlegal = "oealegal"   #所属法人
        #FUN-CC0082 Add Begin ---
         IF g_rcj12 = '1' THEN 
            LET l_field.rxy34 = "NULL"
         ELSE
            LET l_field.rxy34 = "CASE WHEN (oeaplant <> oea84) THEN oea84 ELSE NULL END"
         END IF
        #FUN-CC0082 Add End -----

      WHEN "oga_file"           #銷售單
         LET p_doctype= '02'
         LET p_paytype = '1'
         LET p_sdate   = "CAST (sdate AS DATE)"
         LET p_stime   = "stime[1,2]||':'||stime[3,4]||':'||stime[5,6]"
         LET l_ryl04   = '02'
         LET l_table   = "oga_temp"
         LET l_field.rxy01    = "oga01"      #单号
         LET l_field.rxyplant = "ogaplant"   #所属营运中心
         LET l_field.rxylegal = "ogalegal"   #所属法人
         LET l_field.shop     = "ogaplant"   #门店编号 
         LET l_field.saleno   = "oga98"      #POS单号
         LET l_field.lqe18    = "ogaplant"   #核销门店
         LET l_field.lqe19    = "oga02"      #核销日期
         LET l_field.rxz01    = "oga01"      #单号
         LET l_field.rxz08    = "ogauser"    #刷卡人员
         LET l_field.rxzlegal = "ogalegal"   #所属法人
        #FUN-CC0082 Add Begin ---
         IF g_rcj12 = '1' THEN
            #异店取货归属为1.订货门店时,异店取货非冲预收的付款信息rxy34(代收门店)给值取货门店
            LET l_field.rxy34 = "CASE WHEN (ogaplant <> oga84 AND (IsOrderPay = 'N' OR IsOrderPay IS NULL)) THEN oga84 ELSE NULL END"
         ELSE
            #异店取货归属为2.取货门店时,异店取货冲预收的付款信息rxy34(代收门店)给值订货门店
            LET l_field.rxy34 = "CASE WHEN (ogaplant <> oga84 AND IsOrderPay = 'Y') THEN ogaplant ELSE NULL END"
         END IF
        #FUN-CC0082 Add End -----

      WHEN "oha_file"           #銷退單
         LET p_doctype = '03'
         LET p_paytype = '-1'
         LET p_sdate   = "CAST (sdate AS DATE)"
         LET p_stime   = "stime[1,2]||':'||stime[3,4]||':'||stime[5,6]"
         LET l_ryl04   = '02'
         LET l_table   = "oha_temp"
         LET l_field.rxy01    = "oha01"      #单号
         LET l_field.rxyplant = "ohaplant"   #所属营运中心
         LET l_field.rxylegal = "ohalegal"   #所属法人
         LET l_field.shop     = "ohaplant"   #门店编号
         LET l_field.saleno   = "oha98"      #POS单号
         LET l_field.lqe18    = "ohaplant"   #核销门店
         LET l_field.lqe19    = "oha02"      #核销日期
         LET l_field.rxz01    = "oha01"      #单号
         LET l_field.rxz08    = "ohauser"    #刷卡人员
         LET l_field.rxzlegal = "ohalegal"   #所属法人
         LET l_field.rxy34 = "NULL" #FUN-CC0082 Add

      WHEN "rxa_file"           #退款單
         LET p_doctype = '04'
         LET p_paytype = '-1'
         LET p_sdate   = "CAST (sdate AS DATE)"
         LET p_stime   = "stime[1,2]||':'||stime[3,4]||':'||stime[5,6]"
         LET l_ryl04   = '03'
         LET l_table   = "rxa_temp"
         LET l_field.rxy01    = "rxa01"      #单号
         LET l_field.rxyplant = "rxaplant"   #所属营运中心
         LET l_field.rxylegal = "rxalegal"   #所属法人
         LET l_field.shop     = "rxaplant"   #门店编号
         LET l_field.saleno   = "rxa08"      #POS单号
         LET l_field.lqe18    = "rxaplant"   #核销门店
         LET l_field.lqe19    = "rxacond"    #核销日期
         LET l_field.rxz01    = "rxa01"      #单号
         LET l_field.rxz08    = "rxauser"    #刷卡人员
         LET l_field.rxzlegal = "rxalegal"   #所属法人
         LET l_field.rxy34 = "NULL" #FUN-CC0082 Add

   END CASE

   #rxy_file 交款明細表
   LET l_ins = " INSERT INTO rxy_temp( ",
               " rxy00    ,",                             #單據別
               " rxy01    ,",                             #單號
               " rxy02    ,",                             #項次
               " rxy03    ,",                             #款別
               " rxy04    ,",                             #款別類型
               " rxy05    ,",                             #交款金額
               " rxy06    ,",                             #卡號/票號/帳號
               " rxy07    ,",                             #刷卡手續費率
               " rxy08    ,",                             #刷卡手續費額
               " rxy09    ,",                             #支票面額
               " rxy10    ,",                             #出票日期
               " rxy11    ,",                             #出票單位
               " rxy12    ,",                             #卡券種類編號
               " rxy13    ,",                             #券面額編號
               " rxy14    ,",                             #券起始編號
               " rxy15    ,",                             #券終止編號
               " rxy16    ,",                             #券數量
               " rxy17    ,",                             #票券溢交款金額
               " rxy18    ,",                             #退款類型
               " rxy19    ,",                             #沖預收款類型
               " rxy20    ,",                             #固定手續費
               " rxy21    ,",                             #交款日期    
               " rxy22    ,",                             #交款時間
               " rxy30    ,",                             #POS款別
               " rxy31    ,",                             #銷售單號
               " rxylegal ,",                             #所屬法人
               " rxyplant ,",                             #所屬營運中心
               " rxy33    ,",                             #冲预收否  #FUN-CB0025
               " rxy34    ,",                             #代收款營運中心 #FUN-CC0082 Add
               " rxy23    )"                              #抵現積分
         
         
   LET l_sel = " SELECT DISTINCT ",
               " '",p_doctype,"', ",                                                          #rxy00    單據別
               " ",l_field.rxy01,", ",                                                        #rxy01    單號
               " item, ",                                                                     #rxy02    項次
               " paycodeerp, ",                                                               #rxy03    款別
               " '",p_paytype,"', ",                                                          #rxy04    款別類型
              #" pay-changed, ",                                                              #rxy05    交款金額 #FUN-CA0160 Mark
               " pay-extra-changed, ",                                                        #rxy05    交款金額 #FUN-CA0160 Add
               " paysernum, ",                                                                #rxy06    卡號/票號/帳號
               " '0', ",                                                                      #rxy07    刷卡手續費率
               " '0', ",                                                                      #rxy08    刷卡手續費額
              #" CASE paycodeerp WHEN CAST('03' AS NVARCHAR2(20)) THEN pay+extra ELSE null END CASE, ",        #rxy09    支票面額 #FUN-CA0160 Mark
               " CASE paycodeerp WHEN CAST('03' AS NVARCHAR2(20)) THEN pay ELSE null END CASE, ",              #rxy09    支票面額 #FUN-CA0160 Add
               " '', ",                                                                       #rxy10    出票日期
               " '', ",                                                                       #rxy11    出票單位
               " cttype, ",                                                                   #rxy12    卡券種類編號
              #" CASE paycodeerp WHEN CAST('04' AS NVARCHAR2(20)) THEN pay+extra ELSE null END CASE, ",        #rxy13    券面額編號 #FUN-CA0160 Mark
               " CASE paycodeerp WHEN CAST('04' AS NVARCHAR2(20)) THEN pay ELSE null END CASE, ",              #rxy13    券面額編號 #FUN-CA0160 Add
               " CASE paycodeerp WHEN CAST('04' AS NVARCHAR2(20)) THEN paysernum ELSE null END CASE, ", #rxy14    券起始編號
               " CASE paycodeerp WHEN CAST('04' AS NVARCHAR2(20)) THEN paysernum ELSE null END CASE, ", #rxy15    券終止編號
               " CASE paycodeerp WHEN CAST('04' AS NVARCHAR2(20)) THEN '1' ELSE '0' END CASE,",    #rxy16    券數量
               " extra, ",                                                                    #rxy17    票券溢交款金額
               " CASE paycodeerp WHEN CAST('02' AS NVARCHAR2(20)) THEN 'T' WHEN CAST('03' AS NVARCHAR2(20)) THEN 'T' ELSE '' END CASE ,",   #rxy18    退款類型
              #" CASE paycodeerp WHEN CAST('07' AS NVARCHAR2(20)) THEN '1' ELSE '' END CASE   ,",  #rxy19    沖預收款類型 #FUN-CB0025
               " CASE IsOrderPay WHEN CAST('Y' AS NVARCHAR2(1)) THEN '1' ELSE '' END CASE   ,",    #rxy19    沖預收款類型 #FUN-CB0025
               " '0', ",                                                                      #rxy20    固定手續費
               " ",p_sdate,", ",                                                              #rxy21    交款日期
               " ",p_stime,", ",                                                              #rxy22    交款時間
               " paycode, ",                                                                  #rxy30    POS款別
               " '', ",                                                                       #rxy31    銷售單號
               " ",l_field.rxylegal," ,",                                                     #rxylegal 所屬法人
               " shop, ",                                                                     #rxyplant 所屬營運中心
              #" IsOrderPay, ",                                                               #rxy33    冲预收否 #FUN-CB0025 #FUN-CB0103 Mark
               " CASE WHEN IsOrderPay IS NULL THEN CAST('N' AS NVARCHAR2(1)) ELSE IsOrderPay END, ",    #rxy33    冲预收否   #FUN-CB0103 Add
               " ",l_field.rxy34,", ",                                                        #rxy34    代收款營運中心  #FUN-CC0082 Add
               " descore ",                                                                   #rxy23    抵現積分
               "  FROM  ",g_posdbs,"td_sale_pay",g_db_links,",",l_table,
               " WHERE shop = ",l_field.shop," ",
               "   AND cnfflg ='Y' AND saleno = ",l_field.saleno," ",
               " ORDER BY ",l_field.rxy01,",item "

   LET l_sql = l_ins,l_sel CLIPPED
   CALL cl_replace_sqldb(l_sql) RETURNING l_sql
   CALL cl_parse_qry_sql(l_sql,p_azw01) RETURNING l_sql
   PREPARE ins_rxy_temp_pre FROM l_sql
   EXECUTE ins_rxy_temp_pre
   IF SQLCA.sqlcode THEN
      LET g_success = 'N'
      LET g_errno   = SQLCA.sqlcode
      LET g_msg1    = 'Oper:Ins'||' '||'Table:rxy_temp'||' '||'Shop:'||p_azw01
      CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
      ROLLBACK WORK
      CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
      LET g_msg   = g_msg[1,255]
      CALL p200_log(g_trans_no,p_azw01,'Batch Operation',l_ryl04,'TD_SALE_PAY',g_errno,g_msg,'0','N',g_msg1)
      LET g_errno = ''
      LET g_msg   = ''
      LET g_msg1  = ''
      CALL p200_upd_posflag_p('2',p_gat01,'td_sale',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
      RETURN
   END IF

  ##若存在券付款，且未核銷則做核銷
  #LET l_sql = "SELECT paysernum,sdate FROM ",g_posdbs,"td_sale_pay",g_db_links,",",l_table,
  #            " WHERE shop = ",l_field.shop," AND saleno = ",l_field.saleno," AND cnfflg ='Y' ",
  #            "   AND paycodeerp = '04' AND isverification = 'N' "
  #CALL cl_replace_sqldb(l_sql) RETURNING l_sql
  #CALL cl_parse_qry_sql(l_sql,p_azw01) RETURNING l_sql
  #PREPARE sel_paysernum_p_pre FROM l_sql
  #DECLARE sel_paysernum_p_cs CURSOR FOR sel_paysernum_p_pre
  #FOREACH sel_paysernum_p_cs INTO l_lqe01,l_lqe19
  #   IF SQLCA.sqlcode THEN
  #      LET g_success = 'N'           
  #      ROLLBACK WORK
  #      RETURN         
  #   END IF
  #   
  #   LET l_sql = "UPDATE ",cl_get_target_table(p_azw01,'lqe_file'),
  #               "   SET lqe17 = '4', ",
  #               "       lqe18 = '",p_azw01,"', ",
  #               "       lqe19 = '",l_lqe19,"' ",
  #               " WHERE lqe01 = '",l_lqe01,"' "
  #   
  #   CALL cl_replace_sqldb(l_sql) RETURNING l_sql
  #   CALL cl_parse_qry_sql(l_sql,p_azw01) RETURNING l_sql
  #   PREPARE upd_lqe_p_pre1 FROM l_sql
  #   EXECUTE upd_lqe_p_pre1
  #   IF SQLCA.sqlcode OR SQLCA.sqlerrd[3] = 0 THEN
  #      LET g_success = 'N'
  #      ROLLBACK WORK
  #      RETURN 
  #   END IF
  #END FOREACH
      
  #直接Upd lqe_file的Sql預留 (Mark原因：經測試該Sql效率低於Foreach)
   LET l_sql = "UPDATE ",cl_get_target_table(p_azw01,'lqe_file'),
               #"   SET (lqe17,lqe18,lqe19) = ",                #FUN-D10040 mark
               "   SET (lqe17,lqe24,lqe25) = ",                 #FUN-D10040 add
               "       (SELECT '4',",l_field.lqe18,",",l_field.lqe19," FROM ",g_posdbs,"td_sale_pay",g_db_links,",",l_table,
               "         WHERE shop = ",l_field.shop," AND saleno = ",l_field.saleno," AND lqe01 = paysernum AND paycodeerp = '04') ",
               " WHERE EXISTS (SELECT 1 FROM ",g_posdbs,"td_sale_pay",g_db_links,",",l_table,
               "                WHERE paysernum = lqe01 ",
               "                  AND shop = ",l_field.shop," AND saleno = ",l_field.saleno," ",
               "                  AND paycodeerp = '04' AND isverification = 'N') "
   
   CALL cl_replace_sqldb(l_sql) RETURNING l_sql
   CALL cl_parse_qry_sql(l_sql,p_azw01) RETURNING l_sql
   PREPARE upd_lqe_p_pre FROM l_sql
   EXECUTE upd_lqe_p_pre
   IF SQLCA.sqlcode THEN
      LET g_success = 'N'
      LET g_errno   = SQLCA.sqlcode
      #LET g_msg1    = 'Oper:Upd'||' '||'Table:lqe_file'||' '||'Field:(lqe17/lqe18/lae19)'||' '||'Shop:'||p_azw01   #FUN-D10040 mark
      LET g_msg1    = 'Oper:Upd'||' '||'Table:lqe_file'||' '||'Field:(lqe17/lqe24/lqe25)'||' '||'Shop:'||p_azw01    #FUN-D10040 add
      CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
      ROLLBACK WORK
      CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
      LET g_msg   = g_msg[1,255]
      CALL p200_log(g_trans_no,p_azw01,'Batch Operation',l_ryl04,'TD_SALE_PAY',g_errno,g_msg,'0','N',g_msg1)
      LET g_errno = ''
      LET g_msg   = ''
      LET g_msg1  = ''
      CALL p200_upd_posflag_p('2',p_gat01,'td_sale',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
      RETURN
   END IF

   #rxx_file  交款匯總表
   LET l_ins = " INSERT INTO rxx_temp( ",
               " rxx00   ,",                        #單據別
               " rxx01   ,",                        #單號
               " rxx02   ,",                        #款別
               " rxx03   ,",                        #款別類型
               " rxx04   ,",                        #交款金額
               " rxx05   ,",                        #溢交款金額
               " rxx11   ,",                        #銷售單號
               " rxxlegal,",                        #法人別    
               " rxxplant)"                         #機構別
  
   LET l_sel = " SELECT DISTINCT ",
               " rxy00 ,",                        #單據別
               " rxy01 ,",                        #單號
              #" rxy03 ,",                        #款別                      #FUN-CC0082 Mark
               " CASE WHEN rxy33 = 'Y' THEN '07' ELSE rxy03 END,",    #款別  #FUN-CC0082 Add
               " rxy04 ,",                        #款別類型  
               " SUM(rxy05) ,",                   #交款金額  
               " SUM(COALESCE(rxy17,0)) ,",       #溢交款金額
               " ''  ,",                          #銷售單號
               " rxylegal,",                      #法人別
               " rxyplant ",                      #機構別
               " FROM rxy_temp,",l_table,
               " WHERE rxy00 = '",p_doctype,"' AND rxyplant = ",l_field.rxyplant," ",
               "   AND rxy01 = ",l_field.rxy01,"  ",
              #" GROUP BY rxy00,rxy01,rxy03,rxy04,rxylegal,rxyplant "                                          #FUN-CC0082 Mark
               " GROUP BY rxy00,rxy01,CASE WHEN rxy33 = 'Y' THEN '07' ELSE rxy03 END,rxy04,rxylegal,rxyplant " #FUN-CC0082 Add
  
   LET l_sql = l_ins,l_sel CLIPPED
   CALL cl_replace_sqldb(l_sql) RETURNING l_sql
   CALL cl_parse_qry_sql(l_sql,p_azw01) RETURNING l_sql
   PREPARE ins_rxx_temp_pre FROM l_sql
   EXECUTE ins_rxx_temp_pre 
   IF SQLCA.sqlcode THEN
      LET g_success = 'N'
      LET g_errno   = SQLCA.sqlcode
      LET g_msg1    = 'Oper:Ins'||' '||'Table:rxx_temp'||' '||'Shop:'||p_azw01
      CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
      ROLLBACK WORK
      CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
      LET g_msg   = g_msg[1,255]
      CALL p200_log(g_trans_no,p_azw01,'Batch Operation',l_ryl04,'TD_SALE_PAY',g_errno,g_msg,'0','N',g_msg1)
      LET g_errno = ''
      LET g_msg   = ''
      LET g_msg1  = '' 
      CALL p200_upd_posflag_p('2',p_gat01,'td_sale',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
      RETURN
   END IF      

   #rxz_file 刷卡明細表
   LET l_ins = " INSERT INTO rxz_temp( ",
               " rxz00   ,",                              #單據別
               " rxz01   ,",                              #單號
               " rxz02   ,",                              #款別類型
               " rxz03   ,",                              #刷卡序號
               " rxz04   ,",                              #卡號
               " rxz05   ,",                              #刷卡金額
               " rxz06   ,",                              #刷卡日期
               " rxz07   ,",                              #刷卡時間
               " rxz08   ,",                              #刷卡人員
               " rxz09   ,",                              #刷卡手續費額
               " rxz10   ,",                              #刷卡手續費率
               " rxz11   ,",                              #銀行名稱
               " rxz12   ,",                              #銀行注冊否
               " rxz13   ,",                              #狀態
               " rxz14   ,",                              #狀態說明
               " rxz15   ,",                              #固定手續費
               " rxz20   ,",                              #卡類型
               " rxz21   ,",                              #銷售單號
               " rxzlegal,",                              #法人別
               " rxzplant)"                               #機構別

   LET l_sel = " SELECT DISTINCT ",
               " '",p_doctype,"'   ,",                    #rxz00    單據別
               " ",l_field.rxz01," ,",                    #rxz01    單號
               " '",p_paytype,"'   ,",                    #rxz02    款別類型
               " item, ",                                 #rxz03    刷卡序號
               " paysernum, ",                            #rxz04    卡號
               " pay, ",                                  #rxz05    刷卡金額
               " ",p_sdate,",",                           #rxz06    刷卡日期
               " ",p_stime,",",                           #rxz07    刷卡時間
               " ",l_field.rxz08,", ",                    #rxz08    刷卡人員
               " '0', ",                                  #rxz09    刷卡手續費額
               " '0', ",                                  #rxz10    刷卡手續費率
               " '', ",                                   #rxz11    銀行名稱
               " 'N', ",                                  #rxz12    銀行注冊否
               " '1', ",                                  #rxz13    狀態
               " '', ",                                   #rxz14    狀態說明
               " '0', ",                                  #rxz15    固定手續費
               " CASE paycodeerp ",
               "   WHEN CAST('02' AS NVARCHAR2(20)) THEN '2' ",
               "   WHEN CAST('05' AS NVARCHAR2(20)) THEN '5' ",
               "   WHEN CAST('06' AS NVARCHAR2(20)) THEN '6' END, ",    #rxz20    卡類型
               " '', ",                                   #rxz21    銷售單號
               " ",l_field.rxzlegal,", ",                 #rxzlegal 所屬法人 
               " shop ",                                  #rxzplant 所屬營運中心
               "  FROM  ",g_posdbs,"td_sale_pay",g_db_links,",",l_table,
               " WHERE shop = ",l_field.shop," ",            
               "   AND saleno = ",l_field.saleno," AND cnfflg = 'Y' ", 
               "   AND paycodeerp IN ('02','05','06') ",
               " ORDER BY ",l_field.rxz01,",item "   
               
   LET l_sql = l_ins,l_sel CLIPPED                        
   CALL cl_replace_sqldb(l_sql) RETURNING l_sql           
   CALL cl_parse_qry_sql(l_sql,p_azw01) RETURNING l_sql   
   PREPARE ins_rxz_temp_pre FROM l_sql                         
   EXECUTE ins_rxz_temp_pre   
   IF SQLCA.sqlcode THEN 
      LET g_success = 'N'
      LET g_errno   = SQLCA.sqlcode
      LET g_msg1    = 'Oper:Ins'||' '||'Table:rxz_temp'||' '||'Shop:'||p_azw01
      CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
      ROLLBACK WORK
      CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
      LET g_msg   = g_msg[1,255]
      CALL p200_log(g_trans_no,p_azw01,'Batch Operation',l_ryl04,'TD_SALE_PAY',g_errno,g_msg,'0','N',g_msg1)
      LET g_errno = ''
      LET g_msg   = ''
      LET g_msg1  = '' 
      CALL p200_upd_posflag_p('2',p_gat01,'td_sale',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
      RETURN
   END IF      
END FUNCTION
#FUN-CA0091 Add End -----

#FUN-CA0091 Add Begin ---
FUNCTION p200_upd_posflag_p(p_flag,p_gat01,p_ryk03,p_azw01)        #回填標誌欄位
DEFINE p_flag   LIKE type_file.chr1
DEFINE p_gat01  LIKE gat_file.gat01
DEFINE p_ryk03  LIKE ryk_file.ryk03
DEFINE p_azw01  LIKE azw_file.azw01
DEFINE l_upd    STRING
DEFINE l_field  RECORD
       shop     LIKE type_file.chr100,
       saleno   LIKE type_file.chr100
                END RECORD
DEFINE l_table  LIKE type_file.chr20
DEFINE l_ryl04  LIKE ryl_file.ryl04
DEFINE l_no_str LIKE type_file.chr20 #FUN-CA0160 Add

   LET g_time = TIME
  #IF g_success='N' THEN RETURN END IF #FUN-CA0160 Mark
   
   CASE p_gat01
      WHEN "oea_file"
         LET l_table        = "oea_temp"  #临时表
         LET l_field.shop   = "oeaplant"  #门店
         LET l_field.saleno = "oea94"     #POS单号
         LET l_ryl04        = '01'
         LET l_no_str       = "Saleno"    #FUN-CA0160 Add
      WHEN "oga_file"
         LET l_table        = "oga_temp"  #临时表
         LET l_field.shop   = "ogaplant"  #门店
         LET l_field.saleno = "oga98"     #POS单号
         LET l_ryl04        = '02'
         LET l_no_str       = "Saleno"    #FUN-CA0160 Add
      WHEN "oha_file"
         LET l_table        = "oha_temp"  #临时表
         LET l_field.shop   = "ohaplant"  #门店
         LET l_field.saleno = "oha98"     #POS单号
         LET l_ryl04        = '02'
         LET l_no_str       = "Saleno"    #FUN-CA0160 Add
      WHEN "rxa_file"
         LET l_table        = "rxa_temp"  #临时表
         LET l_field.shop   = "rxaplant"  #门店
         LET l_field.saleno = "rxa08"     #POS单号
         LET l_ryl04        = '03'
         LET l_no_str       = "Saleno"    #FUN-CA0160 Add
     #WHEN "ome_file"
     #   LET l_table        = "ome_temp"  #临时表
     #   LET l_field.shop   = "omeplant"  #门店
     #   LET l_field.saleno = "ome98"     #POS单号

     #FUN-CA0160 Add Begin ---
      WHEN "rxe_file_2"
         LET l_table        = "oga_temp"  #临时表
         LET l_field.shop   = "ogaplant"  #门店
         LET l_field.saleno = "oga98"     #POS单号
         LET l_ryl04        = '05'
         LET l_no_str       = "SaleCouponno"
      WHEN "rxe_file_3"
         LET l_table        = "oha_temp"  #临时表
         LET l_field.shop   = "ohaplant"  #门店
         LET l_field.saleno = "oha98"     #POS单号
         LET l_ryl04        = '05'
         LET l_no_str       = "SaleCouponno"
      WHEN "lps_file"
         LET l_table        = "lps_temp"  #临时表
         LET l_field.shop   = "lpsplant"  #门店
         LET l_field.saleno = "lps18"     #POS单号
         LET l_ryl04        = '04'
         LET l_no_str       = "SaleCardno"
      WHEN "lpu_file"
         LET l_table        = "lpu_temp"  #临时表
         LET l_field.shop   = "lpuplant"  #门店
         LET l_field.saleno = "lpu17"     #POS单号
         LET l_ryl04        = '04'
         LET l_no_str       = "Rechargeno"
      WHEN "lpv_file"
         LET l_table        = "lpv_temp"  #临时表
         LET l_field.shop   = "lpvplant"  #门店
         LET l_field.saleno = "lpv15"     #POS单号
         LET l_ryl04        = '04'
         LET l_no_str       = "SaleCardno"
      WHEN "lru_file"
         LET l_table        = "lru_temp"  #临时表
         LET l_field.shop   = "lruplant"  #门店
         LET l_field.saleno = "lru10"     #POS单号
         LET l_ryl04        = '04'
         LET l_no_str       = "SaleCardno"
      WHEN "lrw_file"
         LET l_table        = "lrw_temp"  #临时表
         LET l_field.shop   = "lrwplant"  #门店
         LET l_field.saleno = "lrw25"     #POS单号
         LET l_ryl04        = '04'
         LET l_no_str       = "ChangeCardno"
     #FUN-CA0160 Add End -----
   END CASE

   IF p_flag = '1' THEN
      LET l_upd = "UPDATE ",g_posdbs,p_ryk03,g_db_links," ",
                  "   SET condition2 = 'Y' ",
                  " WHERE condition2 = 'B' ",
                  "   AND EXISTS (SELECT 1 FROM ",l_table,
                  "                WHERE shop   = ",l_field.shop," ",
                 #"                  AND saleno = ",l_field.saleno,") "       #FUN-CA0160 Mark
                  "                  AND ",l_no_str," = ",l_field.saleno,") " #FUN-CA0160 Add
   END IF
   IF p_flag = '2' THEN
      LET l_upd = "UPDATE ",g_posdbs,p_ryk03,g_db_links," ",
                  "   SET condition2 = 'A' ",
                  " WHERE condition2 = 'B' ",
                  "   AND EXISTS (SELECT 1 FROM ",l_table,
                  "                WHERE shop   = ",l_field.shop," ",
                 #"                  AND saleno = ",l_field.saleno,") "       #FUN-CA0160 Mark
                  "                  AND ",l_no_str," = ",l_field.saleno,") " #FUN-CA0160 Add
   END IF
   PREPARE upd_pos_pre FROM l_upd
   EXECUTE upd_pos_pre
   IF SQLCA.sqlcode THEN
      LET g_success = 'N'
      RETURN
   END IF

END FUNCTION
#FUN-CA0091 Add End -----

#FUNCTION p200_oga_d_ins(p_gat01,p_azw01)       #FUN-CC0082 Mark
FUNCTION p200_oga_d_ins(p_gat01,p_azw01,p_flag) #FUN-CC0082 Add
DEFINE l_sql     STRING
DEFINE l_ins     STRING
DEFINE l_sel     STRING
DEFINE l_saleno  LIKE oga_file.oga16
DEFINE l_item    LIKE type_file.chr5
DEFINE p_azw01   LIKE azw_file.azw01
DEFINE p_gat01   LIKE gat_file.gat01
DEFINE l_check   LIKE type_file.chr1
DEFINE l_oga     RECORD LIKE  oga_file.*
DEFINE l_ogb     RECORD LIKE  ogb_file.*
DEFINE l_ogi     RECORD LIKE  ogi_file.*
DEFINE l_ogh     RECORD LIKE  ogh_file.*
DEFINE l_ima25   LIKE ima_file.ima25
DEFINE l_flag    LIKE type_file.chr1
DEFINE l_fac     LIKE ogb_file.ogb05_fac
DEFINE l_upd     STRING 
DEFINE l_date    LIKE type_file.dat
DEFINE l_i       LIKE type_file.num5
DEFINE l_rty05   LIKE rty_file.rty05
DEFINE l_rtt01   LIKE rtt_file.rtt01
DEFINE l_rtt11   LIKE rtt_file.rtt11
DEFINE l_rtv12   LIKE rtv_file.rtv12
DEFINE l_rtu01   LIKE rtu_file.rtu01
DEFINE l_oap041  LIKE oap_file.oap041
DEFINE l_ordershop  LIKE oga_file.oga84   #FUN-CC0082 Add
DEFINE l_shop_field LIKE type_file.chr100 #FUN-CC0082 Add
DEFINE l_shop_where STRING                #FUN-CC0082 Add
DEFINE p_flag       LIKE type_file.chr1   #FUN-CC0082 Add

   LET g_time = TIME
   IF NOT cl_null(g_saleno) THEN
      LET g_wc = " saleno = '",g_saleno,"' "
   ELSE
     #CALL p200_g_wc() RETURNING g_wc           #FUN-CA0160 Mark
      CALL p200_g_wc("oga_file") RETURNING g_wc #FUN-CA0160 Add
   END IF
   IF cl_null(g_wc) THEN LET g_wc = " 1=1" END IF

   INITIALIZE l_oga.* TO NULL
   INITIALIZE l_ogb.* TO NULL
   INITIALIZE l_ogi.* TO NULL
   INITIALIZE l_ogh.* TO NULL
   INITIALIZE l_ordershop TO NULL #FUN-CC0082 Add

  #FUN-CC0082 Add Begin ---
   IF g_rcj12 = '1' THEN
      LET l_shop_field = "COALESCE(RTRIM(LTRIM(OrderShop)),Shop)"
      LET l_shop_where = " ((Shop = '",p_azw01 CLIPPED,"' AND (OrderShop IS NULL OR OrderShop = ' ')) OR OrderShop = '",p_azw01 CLIPPED,"') "
   ELSE
      LET l_shop_field = "Shop"
      LET l_shop_where = " Shop = '",p_azw01 CLIPPED,"' "
   END IF 
   #若从批量逻辑中调用时,只做异店取货处理
   IF p_flag = '2' THEN
      LET l_shop_where = l_shop_where CLIPPED," AND OrderShop IS NOT NULL AND OrderShop <> ' ' AND OrderShop <> Shop "
   END IF 
  #FUN-CC0082 Add End -----

   LET l_sql = " SELECT DISTINCT ",
               " CAST (bdate AS DATE), ",                                                #oga02    出貨日期
               " '2', ",                                                                 #oga09    單據別
               " opno, ",                                                                #oga14    人員編號
               " CASE otype WHEN 1 THEN ofno ELSE CAST('' AS NVARCHAR2(20)) END, ",      #oga16    訂單單號
               " tot_uamt, ",                                                            #oga50    原幣出貨金額税前
               " tot_amt, ",                                                             #oga51    原幣出貨金額
               " tot_uamt, ",                                                            #oga53    原幣應開發票未稅金額
               " opno, ",                                                                #ogauser  資料所有者
               " tot_amt, ",                                                             #oga1008  出貨總含稅金額
               " CAST (sdate AS DATE), ",                                                #oga69    輸入日期
              #FUN-CC0082 Mark&Add Begin ---
              #" shop, ",                                                                #ogaplant 所屬營運中心
              #" shop, ",                                                                #oga83    銷貨營運中心
              #" getshop, ",                                                             #oga84    取貨營運中心
               " ",l_shop_field,", ",                                                    #ogaplant 所屬營運中心
               " ",l_shop_field,", ",                                                    #oga83    銷貨營運中心
               " COALESCE(getshop,shop), ",                                              #oga84    取貨營運中心
              #FUN-CC0082 Mark&Add End -----
               " cardno, ",                                                              #oga87    會員卡號
               " contman, ",                                                             #oga88    顧客姓名
               " conttel, ",                                                             #oga89    聯系電話
               " point_qty, ",                                                           #oga95    本次積分
               " machine, ",                                                             #oga96    收銀機號
               " CAST (sdate AS DATE), ",                                                #ogacond  確認日期
               " opno, ",                                                                #ogaconu  確認人員
               " CAST (sdate AS DATE), ",                                                #ogadate  最近修改日
               " opno, ",                                                                #ogaoriu  資料建立者
               " stime[1,2]||':'||stime[3,4]||':'||stime[5,6], ",                        #ogacont  確認時間
               " saleno, ",                                                              #oga98    POS單號
               " COALESCE(RTRIM(LTRIM(OrderShop)),Shop), ",                              #ordershop訂貨門店  #FUN-CC0082 Add
               " shipadd ",                                                              #oap041   地址
               " FROM ",g_posdbs,"td_sale",g_db_links," ",
              #" WHERE shop = '",p_azw01,"' AND condition2 = 'A' ",  #FUN-CB0103 Mark
              #" WHERE shop = '",p_azw01,"' AND condition2 <> 'Y' ", #FUN-CB0103 Add #FUN-CC0082 Mark
               " WHERE condition2 <> 'Y' AND ",l_shop_where CLIPPED,                 #FUN-CC0082 Add
               "   AND type = '0' AND cnfflg = 'Y' ",
               "   AND ",g_wc," ",
               " ORDER BY saleno "

   PREPARE sel_td_sale_oga_pre FROM l_sql
   DECLARE sel_td_sale_oga_curs CURSOR WITH HOLD FOR sel_td_sale_oga_pre
   FOREACH sel_td_sale_oga_curs INTO 
               l_oga.oga02,                        #出貨日期
               l_oga.oga09,                        #單據別
               l_oga.oga14,                        #人員編號
               l_oga.oga16,                        #訂單單號
               l_oga.oga50,                        #原幣出貨金額税前
               l_oga.oga51,                        #原幣出貨金額
               l_oga.oga53,                        #原幣應開發票未稅金額
               l_oga.ogauser,                      #資料所有者
               l_oga.oga1008,                      #出貨總含稅金額
               l_oga.oga69,                        #輸入日期
               l_oga.ogaplant,                     #所屬營運中心
               l_oga.oga83,                        #銷貨營運中心
               l_oga.oga84,                        #取貨營運中心
               l_oga.oga87,                        #會員卡號
               l_oga.oga88,                        #顧客姓名
               l_oga.oga89,                        #聯系電話
               l_oga.oga95,                        #本次積分
               l_oga.oga96,                        #收銀機號
               l_oga.ogacond,                      #確認日期
               l_oga.ogaconu,                      #確認人員
               l_oga.ogadate,                      #最近修改日
               l_oga.ogaoriu,                      #資料建立者
               l_oga.ogacont,                      #確認時間
               l_oga.oga98,                        #POS單號
               l_ordershop,                        #訂貨門店 #FUN-CC0082 Add
               l_oap041                            #地址

      LET g_success = 'Y' #成功標誌初始化
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno = SQLCA.sqlcode
         LET g_showmsg = 'SEL TD_SALE'||' '||'SHOP:'||p_azw01||' '||'SALENO:'||l_oga.oga98
         CALL s_errmsg('oga98',l_oga.oga98,g_showmsg,SQLCA.sqlcode,1)  
         LET g_msg1 = 'TD_SALE'||'SEL'||p_azw01||l_oga.oga98
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,l_oga.oga98,'02','TD_SALE',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         LET g_showmsg = ''
         INITIALIZE l_oga.* TO NULL #FUN-C80051 Add
         INITIALIZE l_ogb.* TO NULL #FUN-C80051 Add
         CONTINUE FOREACH
      END IF

      IF cl_null(l_ordershop) THEN LET l_ordershop = p_azw01 END IF #FUN-CC0082 Add
      
      ##--訂單單號欄位不為空,即此銷售單乃訂單拋磚過來,--#
      ##--須檢查對應訂單是否已上傳,若未上傳則先上傳訂單相關數據--#
      IF NOT cl_null(l_oga.oga16) THEN   
        #FUN-CC0082 Mark&Add Begin ---
        #IF NOT p200_check_oga16(p_azw01,l_oga.oga16) THEN
         IF g_rcj12 = '2' AND NOT cl_null(l_ordershop) AND l_ordershop <> l_oga.oga84 THEN #銷售歸屬2.取貨門店
            IF NOT p200_check_oga16(l_ordershop,l_oga.oga16) THEN
               LET g_success = 'N'
               LET g_errno = "apc1058" #訂單未上傳
               LET g_showmsg = 'Chk oga16'||' '||'SHOP:'||p_azw01||' '||'SALENO:'||l_oga.oga98
               CALL s_errmsg('oga16',l_oga.oga16,g_showmsg,SQLCA.sqlcode,1)
               LET g_msg1 = 'TD_SALE'||'SEL'||p_azw01||l_oga.oga98
               CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
               LET g_msg = g_msg[1,255]
               CALL p200_log(g_trans_no,p_azw01,l_oga.oga98,'02','TD_SALE',g_errno,g_msg,'0','N',g_msg1)
               LET g_errno = ''
               LET g_msg   = ''
               LET g_msg1  = ''
               LET g_showmsg = ''
               INITIALIZE l_oga.* TO NULL #FUN-C80051 Add
               INITIALIZE l_ogb.* TO NULL #FUN-C80051 Add
               CONTINUE FOREACH
            END IF
         ELSE
            IF NOT p200_check_oga16(p_azw01,l_oga.oga16) THEN
        #FUN-CC0082 Mark&Add End -----
               LET g_saleno = l_oga.oga16
               CALL p200_oea_ins("oea_file",p_azw01)
               IF NOT p200_check_oga16(p_azw01,l_oga.oga16) THEN
                  INITIALIZE l_oga.* TO NULL #FUN-C80051 Add
                  INITIALIZE l_ogb.* TO NULL #FUN-C80051 Add
                  LET g_saleno = '' #FUN-C90065 Add
                  CONTINUE FOREACH
               END IF
               LET g_saleno = ''
            END IF #FUN-CC0082 Add
         END IF
      ELSE
         LET l_oga.oga16 = ''
      END IF
      IF g_success ='N' THEN
         INITIALIZE l_oga.* TO NULL #FUN-C80051 Add
         INITIALIZE l_ogb.* TO NULL #FUN-C80051 Add
         CONTINUE FOREACH
      END IF

      CALL p200_log_check(p_azw01,l_oga.oga98)

      BEGIN WORK 
      
      IF g_bgjob = "N" THEN
         MESSAGE "oga_file  SHOP:",p_azw01,"  SALENO:",l_oga.oga98,"  BEGIN:",TIME(CURRENT)
         CALL ui.Interface.refresh()
      END IF
      
      LET l_sucflag = 0
      LET l_saleno  = l_oga.oga98
      LET g_fno1    = l_oga.oga98
     #LET g_ndate   = l_oga.oga69 #FUN-D10144 Mark
      LET g_ndate   = l_oga.oga02 #FUN-D10144 Add
     #CALL p200_auto_doc(p_gat01,p_azw01) RETURNING l_oga.oga01     #FUN-CC0082 Mark
      CALL p200_auto_doc(p_gat01,p_azw01,'Y') RETURNING l_oga.oga01 #FUN-CC0082 Add
      IF g_success ='N' THEN 
         INITIALIZE l_oga.* TO NULL #FUN-C80051 Add
         INITIALIZE l_ogb.* TO NULL #FUN-C80051 Add
         CONTINUE FOREACH
      END IF

      #oga_file default 預設值 Begin --- #FUN-C80051 Add
      LET l_oga.oga00    = '1'               #出貨別
      LET l_oga.oga044   = 'MISC'            #送貨地址碼
      LET l_oga.oga05    = '1'               #發票別
      LET l_oga.oga06    = '0'               #修改版本                  
      LET l_oga.oga07    = 'N'               #出貨是否計入未開發票的銷貨 
      LET l_oga.oga08    = '1'               #1.內銷 2.外銷  3.視同外銷 
      LET l_oga.oga163   = 0                 #尾款應收比率  
      LET l_oga.oga20    = 'N'               #分錄底稿是否可重新產生            
      LET l_oga.oga30    = 'N'               #包裝單確認碼    
      LET l_oga.oga54    = 0                 #原幣已開發票未稅金額
      LET l_oga.oga903   = 'N'               #信用查核放行否 
      LET l_oga.oga909   = 'N'               #三角貿易否
      LET l_oga.ogaconf  = 'Y'               #確認否
      LET l_oga.ogapost  = 'Y'               #出貨扣帳否    
      LET l_oga.ogaprsw  = 0                 #列印次數
      LET l_oga.oga55    = '1'               #狀況碼
      LET l_oga.ogamksg  = 'N'               #簽核
      LET l_oga.oga65    = 'N'               #客戶出貨簽收否
      LET l_oga.oga1005  = 'N'               #是否計算業績
      LET l_oga.oga94    = 'Y'               #POS銷售否 Y-是,N-否    
      LET l_oga.oga57    = '1'               #發票性質
      LET l_oga.oga85    = '1'               #結算方式
      LET l_oga.oga1014  = 'N'               #調貨銷退單所自動產生否
      LET l_oga.ogalegal = l_legal           #所屬法人
      #oga_file default 預設值 End ----- #FUN-C80051 Add

      LET g_oga16_set = l_oga.oga16
      
      IF cl_null(l_oga.oga52) THEN LET l_oga.oga52 = 0 END IF

      IF NOT cl_null(l_oap041) THEN
         CALL p200_ins_oap(p_azw01,l_oga.oga01,l_oap041)
      END IF
      
      IF cl_null(l_oga.oga87) THEN
         LET l_oga.oga03 = g_rtz06
         LET g_vip = 'N'
      ELSE
         LET l_sql = "SELECT lpk02,lpk03,lpk20 FROM ",cl_get_target_table(p_azw01,'lpk_file'),",",
                                                      cl_get_target_table(p_azw01,'lpj_file'),
                     " WHERE lpk01 = lpj01 ",
                     "   AND lpj03 = '",l_oga.oga87,"' "
         CALL cl_replace_sqldb(l_sql) RETURNING l_sql
         CALL cl_parse_qry_sql(l_sql,p_azw01) RETURNING l_sql
         PREPARE sel_lpk_oga_pre FROM l_sql
         EXECUTE sel_lpk_oga_pre INTO l_oga.oga90,l_oga.oga91,l_oga.oga03
         LET g_vip = 'Y'
      END IF
      LET l_oga.oga18 = l_oga.oga03
            
      LET l_sql= " SELECT ryi02,ryi02,ryi02 FROM ",cl_get_target_table(p_azw01,'ryi_file'),
                 "  WHERE ryi01 = '",l_oga.ogauser,"' "
      CALL cl_replace_sqldb(l_sql) RETURNING l_sql                  					
      CALL cl_parse_qry_sql(l_sql,p_azw01) RETURNING l_sql             
      PREPARE sel_ryi02_oga_pre FROM l_sql
      EXECUTE sel_ryi02_oga_pre INTO l_oga.ogauser,l_oga.ogaconu,l_oga.oga14
      LET l_oga.ogaoriu = l_oga.ogauser
      
      LET l_sql="SELECT DISTINCT gen03,gen03,gen03 FROM ",cl_get_target_table(p_azw01,'gen_file'),
                " WHERE gen01 = '",l_oga.ogauser,"' "
      CALL cl_replace_sqldb(l_sql) RETURNING l_sql						
      CALL cl_parse_qry_sql(l_sql,p_azw01) RETURNING l_sql
      PREPARE sel_gen03_oga_pre FROM l_sql
      EXECUTE sel_gen03_oga_pre INTO l_oga.ogaorig,l_oga.ogagrup,l_oga.oga15
      
      LET l_sql = "SELECT DISTINCT occ02,occ09,occ41,occ42,occ43,occ44, ",
                  "                occ45,occ46,occ47,occ48,occ49 ",
                  "  FROM ",cl_get_target_table(p_azw01,'occ_file'),
                  " WHERE occ01 = '",l_oga.oga03,"' "
      CALL cl_replace_sqldb(l_sql) RETURNING l_sql						
      CALL cl_parse_qry_sql(l_sql,p_azw01) RETURNING l_sql
      PREPARE sel_occ_oga_pre FROM l_sql
      EXECUTE sel_occ_oga_pre INTO l_oga.oga032,l_oga.oga04,l_oga.oga21,l_oga.oga23,
                                   l_oga.oga25,l_oga.oga31,l_oga.oga32,l_oga.oga33,
                                   l_oga.oga43,l_oga.oga41,l_oga.oga42

      LET l_sql="SELECT DISTINCT gec04,gec05,gec07",
                "  FROM ",cl_get_target_table(p_azw01,'gec_file'),
                " WHERE gec01 = '",l_oga.oga21,"'",
                "   AND gec011 = '2'"
      CALL cl_replace_sqldb(l_sql) RETURNING l_sql				
      CALL cl_parse_qry_sql(l_sql,p_azw01) RETURNING l_sql         
      PREPARE sel_gec_oga_pre FROM l_sql
      EXECUTE sel_gec_oga_pre INTO l_oga.oga211,l_oga.oga212,l_oga.oga213 
      
      #依據上傳的出貨單號抓取對應的訂單單號
      IF NOT cl_null(l_oga.oga16) THEN
        #LET l_sql= " SELECT oea01,oea02,oea161 FROM ",cl_get_target_table(p_azw01,'oea_file'),     #FUN-CC0082 Mark
         LET l_sql= " SELECT oea01,oea02,oea161 FROM ",cl_get_target_table(l_ordershop,'oea_file'), #FUN-CC0082 Add
                    "  WHERE oea94 = '",l_oga.oga16,"' ",
                    "    AND oeaplant = '",l_ordershop,"' ",   #TQC-D30070 add 
                    "    AND oeaconf = 'Y' "
        #CALL cl_replace_sqldb(l_sql) RETURNING l_sql         #FUN-CC0082 Mark
        #CALL cl_parse_qry_sql(l_sql,p_azw01) RETURNING l_sql #FUN-CC0082 Add
         PREPARE sel_oea01_oga_pre FROM l_sql
         EXECUTE sel_oea01_oga_pre INTO l_oga.oga16,l_date,l_oga.oga161
      END IF

      IF cl_null(l_oga.oga161) THEN LET l_oga.oga161 = 0 END IF
      LET l_oga.oga162 = 100 - l_oga.oga161
      
      IF cl_null(l_date) THEN LET l_date = l_oga.oga02 END IF

      CALL s_rdatem(l_oga.oga03,l_oga.oga32,l_oga.oga02,l_oga.oga02,l_date,p_azw01) 
           RETURNING l_oga.oga11,l_oga.oga12

      CALL s_currm(l_oga.oga23,l_oga.oga02,g_oaz.oaz52,p_azw01) RETURNING l_oga.oga24

      LET l_oga.oga501 = l_oga.oga50 * l_oga.oga24
      LET l_oga.oga511 = l_oga.oga51 * l_oga.oga24

      IF NOT cl_null(l_oga.oga16) THEN
         #如果來源訂單單號不為空，則回寫中間庫訂單的結案否和結案時間
        #CALL p200_upd_td_sale_ecsflg(p_azw01,g_oga16_set,l_oga.oga02)     #FUN-CC0082 Mark
         CALL p200_upd_td_sale_ecsflg(l_ordershop,g_oga16_set,l_oga.oga02) #FUN-CC0082 Add
         IF g_success = 'N' THEN
            INITIALIZE l_oga.* TO NULL #FUN-C80051 Add
            INITIALIZE l_ogb.* TO NULL #FUN-C80051 Add
            CONTINUE FOREACH
         END IF
      END IF
      
      LET l_ins = " INSERT INTO ",cl_get_target_table(p_azw01,'oga_file'),"(",
                  "        oga00,oga01,oga02,oga03,oga032, ",
                  "        oga04,oga044,oga05,oga06,oga07, ",
                  "        oga08,oga09,oga11,oga12,oga14, ",
                  "        oga15,oga16,oga161,oga162,oga163, ",
                  "        oga18,oga20,oga21,oga211,oga212, ",
                  "        oga213,oga23,oga24,oga25,oga30, ",
                  "        oga31,oga32,oga33,oga41,oga42, ",
                  "        oga43,oga50,oga501,oga51,oga511, ",
                  "        oga53,oga54,oga903,oga909,ogaconf, ",
                  "        ogapost,ogaprsw,ogauser,ogagrup,oga55, ",
                  "        ogamksg,oga65,oga1005,oga1008,oga69, ",
                  "        ogaplant,ogalegal,oga83,oga84,oga87, ",
                  "        oga88,oga89,oga90,oga91,oga94, ",
                  "        oga95,oga96,ogacond,ogaconu,ogaoriu, ",
                  "        ogaorig,ogacont,oga98,oga57,oga52, ",
                  "        oga85,oga1014,ogadate) ",
                  " VALUES(?,?,?,?,?,   ?,?,?,?,?, ",
                  "        ?,?,?,?,?,   ?,?,?,?,?, ",
                  "        ?,?,?,?,?,   ?,?,?,?,?, ",
                  "        ?,?,?,?,?,   ?,?,?,?,?, ",
                  "        ?,?,?,?,?,   ?,?,?,?,?, ",
                  "        ?,?,?,?,?,   ?,?,?,?,?, ",
                  "        ?,?,?,?,?,   ?,?,?,?,?, ",
                  "        ?,?,?,?,?,   ?,?,?) "
      CALL cl_replace_sqldb(l_ins) RETURNING l_ins
      CALL cl_parse_qry_sql(l_ins,p_azw01) RETURNING l_ins
      PREPARE ins_oga_pre FROM l_ins
      EXECUTE ins_oga_pre USING
                  l_oga.oga00,l_oga.oga01,l_oga.oga02,l_oga.oga03,l_oga.oga032,
                  l_oga.oga04,l_oga.oga044,l_oga.oga05,l_oga.oga06,l_oga.oga07,
                  l_oga.oga08,l_oga.oga09,l_oga.oga11,l_oga.oga12,l_oga.oga14,
                  l_oga.oga15,l_oga.oga16,l_oga.oga161,l_oga.oga162,l_oga.oga163,
                  l_oga.oga18,l_oga.oga20,l_oga.oga21,l_oga.oga211,l_oga.oga212,
                  l_oga.oga213,l_oga.oga23,l_oga.oga24,l_oga.oga25,l_oga.oga30,
                  l_oga.oga31,l_oga.oga32,l_oga.oga33,l_oga.oga41,l_oga.oga42,
                  l_oga.oga43,l_oga.oga50,l_oga.oga501,l_oga.oga51,l_oga.oga511,
                  l_oga.oga53,l_oga.oga54,l_oga.oga903,l_oga.oga909,l_oga.ogaconf,
                  l_oga.ogapost,l_oga.ogaprsw,l_oga.ogauser,l_oga.ogagrup,l_oga.oga55,
                  l_oga.ogamksg,l_oga.oga65,l_oga.oga1005,l_oga.oga1008,l_oga.oga69,
                  l_oga.ogaplant,l_oga.ogalegal,l_oga.oga83,l_oga.oga84,l_oga.oga87,
                  l_oga.oga88,l_oga.oga89,l_oga.oga90,l_oga.oga91,l_oga.oga94,
                  l_oga.oga95,l_oga.oga96,l_oga.ogacond,l_oga.ogaconu,l_oga.ogaoriu,
                  l_oga.ogaorig,l_oga.ogacont,l_oga.oga98,l_oga.oga57,l_oga.oga52,
                  l_oga.oga85,l_oga.oga1014,l_oga.ogadate
      IF SQLCA.sqlcode OR SQLCA.sqlerrd[3]=0 THEN
         LET g_success = 'N'
         LET g_errno = SQLCA.sqlcode
         LET g_showmsg = 'INS oga_file'||' '||'SHOP:'||p_azw01||' '||'SALENO:'||g_fno1
         CALL s_errmsg('oga01',l_oga.oga01,g_showmsg,SQLCA.sqlcode,1)
         LET g_msg1 = 'oga_file'||'INS'||p_azw01||g_fno1
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,g_fno1,'02','TD_SALE',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         LET g_showmsg = ''
         INITIALIZE l_oga.* TO NULL #FUN-C80051 Add
         INITIALIZE l_ogb.* TO NULL #FUN-C80051 Add
         CONTINUE FOREACH
      END IF

      #ins ogb_file
      #ogb_file default 預設值 Begin --- FUN-C80051 Add
      LET l_ogb.ogb17 = 'N'                 #多倉儲批出貨否
      LET l_ogb.ogb19 = 'N'                 #檢驗否
      LET l_ogb.ogb50 = 0                   #開票性質
      LET l_ogb.ogb51 = 0                   #已簽退數量
      LET l_ogb.ogb52 = 0                   #簽退數量
      LET l_ogb.ogb53 = 0                   #單位一驗退數量
      LET l_ogb.ogb54 = 0                   #單位二驗退數量
      LET l_ogb.ogb55 = 0                   #驗退計價數量
      LET l_ogb.ogb60 = 0                   #已開發票數量
      LET l_ogb.ogb63 = 0                   #銷退數量
      LET l_ogb.ogb1005 = '1'               #作業方式
      LET l_ogb.ogb1012 = 'N'               #搭贈
      #ogb_file default 預設值 End ----- #FUN-C80051 Add

      LET l_sql = " SELECT ",
                  " '",l_oga.oga01,"', ",                             #ogb01    出貨單號
                  " item,",                                           #ogb03    項次
                 #" CASE WHEN featureno IS NULL THEN pluno ELSE featureno END, ",     #ogb04    產品編號
                  " CASE WHEN featureno IS NULL THEN pluno WHEN featureno = ' ' THEN pluno ELSE featureno END, ",   #oeb04    產品編號
                  " unit, ",                                          #ogb05    銷售單位
                  " qty, ",                                           #ogb12    實際出貨數量
                  " price,",                                          #ogb13    原幣單價
                  " uamt, ",                                          #ogb14    原幣未稅金額
                  " amt, ",                                           #ogb14t   原幣含稅金額
                  " qty, ",                                           #ogb16    數量
                  " qty, ",                                           #ogb18    預計出貨數量
                  " '",l_oga.oga16,"', ",                             #ogb31    訂單單號
                  " oitem, ",                                         #ogb32    訂單項次
                 #" rqty, ",                                          #ogb64    銷退數量 #FUN-C80079 Mark
                  " 0, ",                                             #ogb64    銷退數量 #FUN-C80079 Add #財務要求
                  " unit, ",                                          #ogb916   計價單位
                  " qty, ",                                           #ogb917   計價數量
                 #" shop, ",                                          #ogbplant 所屬工廠 #FUN-CC0082 Mark
                  " '",l_oga.ogaplant,"', ",                          #ogbplant 所屬工廠 #FUN-CC0082 Add
                  " '",l_legal,"', ",                                 #ogblegal 所屬法人
                  " COALESCE(disc,0), ",                              #ogb47    分攤折價
                  " counterno, ",                                     #ogb48    攤位編號
                  " oldprice, ",                                      #ogb37    基礎單价
                  " mno ",                                            #ogb40    抽成代號
                  " FROM  ",g_posdbs,"td_sale_detail",g_db_links," ",
                 #" WHERE shop = '",p_azw01,"' ",     #FUN-CC0082 Mark
                  " WHERE shop = '",l_oga.oga84,"' ", #FUN-CC0082 Add
                  "   AND cnfflg = 'Y' AND saleno = '",l_saleno,"' ",
                  " ORDER BY item "

      PREPARE sel_td_sale_detail_ogb_pre FROM l_sql
      DECLARE sel_td_sale_detail_ogb_curs CURSOR WITH HOLD FOR sel_td_sale_detail_ogb_pre
      FOREACH sel_td_sale_detail_ogb_curs INTO 
                  l_ogb.ogb01,                          #出貨單號
                  l_ogb.ogb03,                          #項次
                  l_ogb.ogb04,                          #產品編號
                  l_ogb.ogb05,                          #銷售單位
                  l_ogb.ogb12,                          #實際出貨數量
                  l_ogb.ogb13,                          #原幣單價
                  l_ogb.ogb14,                          #原幣未稅金額
                  l_ogb.ogb14t,                         #原幣含稅金額
                  l_ogb.ogb16,                          #數量
                  l_ogb.ogb18,                          #預計出貨數量
                  l_ogb.ogb31,                          #訂單單號
                  l_ogb.ogb32,                          #訂單項次
                  l_ogb.ogb64,                          #銷退數量
                  l_ogb.ogb916,                         #計價單位
                  l_ogb.ogb917,                         #計價數量
                  l_ogb.ogbplant,                       #所屬工廠
                  l_ogb.ogblegal,                       #所屬法人
                  l_ogb.ogb47,                          #分攤折價
                  l_ogb.ogb48,                          #攤位編號
                  l_ogb.ogb37,                          #基礎單价
                  l_ogb.ogb40                           #抽成代號

         IF SQLCA.sqlcode THEN
            LET g_success = 'N'
            LET g_errno = SQLCA.sqlcode
            LET g_showmsg = 'SEL TD_SALE_DETAIL'||' '||'SHOP:'||p_azw01||' '||'SALENO:'||g_fno1
            CALL s_errmsg('oga98',l_oga.oga98,g_showmsg,SQLCA.sqlcode,1)
            ROLLBACK WORK
            LET g_msg1 = 'TD_SALE_DETAIL'||'SEL'||p_azw01||g_fno1 
            CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
            LET g_msg = g_msg[1,255]
            CALL p200_log(g_trans_no,p_azw01,g_fno1,'02','TD_SALE_DETAIL',g_errno,g_msg,'0','N',g_msg1)
            LET g_errno = ''
            LET g_msg   = ''
            LET g_msg1  = ''
            LET g_showmsg = ''
            EXIT FOREACH
         END IF
         IF l_ogb.ogb12 = 0 THEN
            INITIALIZE l_ogb.* TO NULL #FUN-C80051 Add
            CONTINUE FOREACH
         END IF
         
         LET l_ogb.ogb08 = l_oga.oga84
         LET l_item = l_ogb.ogb03 USING "&&&&"
         LET l_ogb.ogb09 = g_rtz07
         
         LET l_sql ="SELECT ima02,ima25 ",
                    "  FROM ",cl_get_target_table(p_azw01,'ima_file'),
                    " WHERE ima01='",l_ogb.ogb04 ,"'"
         CALL cl_replace_sqldb(l_sql) RETURNING l_sql						
         CALL cl_parse_qry_sql(l_sql,p_azw01) RETURNING l_sql
         PREPARE sel_ima_ogb_pre FROM l_sql
         EXECUTE sel_ima_ogb_pre INTO l_ogb.ogb06,l_ogb.ogb15
   
         CALL s_umfchkm(l_ogb.ogb04,l_ogb.ogb05,l_ogb.ogb15,p_azw01) RETURNING l_flag,l_fac
         IF l_flag='1' THEN 
            LET l_ogb.ogb05_fac=1
            LET l_ogb.ogb15_fac=1
         ELSE 
            LET l_ogb.ogb05_fac = l_fac
            LET l_ogb.ogb15_fac = l_fac
         END IF
         LET l_ogb.ogb16 = l_ogb.ogb12 * l_ogb.ogb15_fac

         IF cl_null(l_ogb.ogb31) THEN 
            LET l_ogb.ogb31 = '' 
            LET l_ogb.ogb32 = '' 
         END IF
         IF cl_null(l_ogb.ogb32) THEN LET l_ogb.ogb32 = '' END IF
         
         LET l_sql = "SELECT DISTINCT rty06 FROM ",cl_get_target_table(p_azw01,'rty_file'),
                     " WHERE rty01 = '",p_azw01,"' AND rty02 ='",l_ogb.ogb04 ,"'"
         CALL cl_replace_sqldb(l_sql) RETURNING l_sql
         CALL cl_parse_qry_sql(l_sql,p_azw01) RETURNING l_sql
         PREPARE sel_rty06_ogb_pre FROM l_sql
         EXECUTE sel_rty06_ogb_pre INTO l_ogb.ogb44
         IF cl_null(l_ogb.ogb44) THEN LET l_ogb.ogb44 = '1' END IF
         
         #若經營方式為聯營或代銷  
         IF l_ogb.ogb44='3' OR l_ogb.ogb44='4' THEN
            LET l_sql = "SELECT rty05 FROM ",cl_get_target_table(p_azw01,'rty_file'),
                        " WHERE rty01 = '",p_azw01,"' ",
                        "   AND rty02 = '",l_ogb.ogb04,"' AND rtyacti = 'Y' "
            CALL cl_replace_sqldb(l_sql) RETURNING l_sql
            CALL cl_parse_qry_sql(l_sql,p_azw01) RETURNING l_sql
            PREPARE sel_rty05_oga_pre FROM l_sql 
            EXECUTE sel_rty05_oga_pre INTO l_rty05
            IF NOT cl_null(l_rty05) THEN
               LET l_sql = "SELECT rtt01,rtt11 FROM ",cl_get_target_table(p_azw01,'rtt_file'),",",
                                                      cl_get_target_table(p_azw01,'rts_file'),",",
                                                      cl_get_target_table(p_azw01,'rto_file'),
                           " WHERE rts01 = rtt01 ",
                           "   AND rttplant = rtsplant ",
                           "   AND rts02 = rtt02 ",
                           "   AND rtt04 = '",l_ogb.ogb04,"' ",
                           "   AND rto01 = rts04 ",
                           "   AND rtoplant = rtsplant ",
                           "   AND rto05 = '",l_rty05,"' ",
                           "   AND rto06 = '",l_ogb.ogb44,"' ",
                           "   AND rto08 <= '",l_oga.oga02,"' ",
                           "   AND rto09 >= '",l_oga.oga02,"' ",
                           "   AND rtt15 = 'Y' ",
                           "   AND rtoconf = 'Y' ",
                           "   AND rtsconf = 'Y' ",
                           "   AND rto03 = rts02 ",
                           "   AND rtoplant = '",p_azw01,"' "
               CALL cl_replace_sqldb(l_sql) RETURNING l_sql
               CALL cl_parse_qry_sql(l_sql,p_azw01) RETURNING l_sql
               PREPARE sel_rtt_oga_pre FROM l_sql
               EXECUTE sel_rtt_oga_pre INTO l_rtt01,l_rtt11
               IF NOT cl_null(l_rtt01) THEN
                  LET l_sql = "SELECT rtv12,rtu01 FROM ",cl_get_target_table(p_azw01,'rtv_file'),",",
                                                         cl_get_target_table(p_azw01,'rtu_file'),",",
                                                         cl_get_target_table(p_azw01,'rtt_file'),
                              " WHERE rtt01 = rtu04 ",
                              "   AND rtt02 = rtu02 ",
                              "   AND rttplant = rtuplant ",
                              "   AND rtuplant = '",p_azw01,"' ",
                              "   AND rtuconf = 'Y' ",
                              "   AND rtuplant = rtvplant ",
                              "   AND rtu01 = rtv01 ",
                              "   AND rtu02 = rtv02 ",
                              "   AND rtu09 <= '",l_oga.oga02,"' ",
                              "   AND rtu10 >= '",l_oga.oga02,"' ", 
                              "   AND rtt01 = '",l_rtt01,"' ",
                              "   AND rtu05 = '",l_rty05,"' ",
                              "   AND rtu06 = '",l_ogb.ogb44,"' ",
                              "   AND rtv04 = '",l_ogb.ogb04,"' "
                  CALL cl_replace_sqldb(l_sql) RETURNING l_sql
                  CALL cl_parse_qry_sql(l_sql,p_azw01) RETURNING l_sql
                  PREPARE sel_rtv12_oga_pre FROM l_sql
                  EXECUTE sel_rtv12_oga_pre INTO l_rtv12,l_rtu01
                  IF NOT cl_null(l_rtu01) THEN
                     LET l_ogb.ogb45=l_rtv12
                  ELSE
                     LET l_ogb.ogb45=l_rtt11
                  END IF
               END IF
            END IF
         ELSE
            LET l_ogb.ogb45 = NULL
         END IF
         LET l_ogb.ogb46 = l_ogb.ogb45

         IF NOT cl_null(l_ogb.ogb48) THEN
            #1.抓合同中的商户
            LET l_sql = "SELECT DISTINCT lnt04 FROM ",cl_get_target_table(p_azw01,'lnt_file'),
                        " WHERE lnt17 <= '",l_oga.oga02,"' ",
                        "   AND lnt18 >= '",l_oga.oga02,"' ",
                        "   AND lnt06  = '",l_ogb.ogb48,"' ",
                        "   AND (lnt26 = 'Y' OR lnt26 = 'S' OR lnt26 = 'E') "
            CALL cl_replace_sqldb(l_sql) RETURNING l_sql
            CALL cl_parse_qry_sql(l_sql,p_azw01) RETURNING l_sql
            PREPARE sel_lnt04_oga_pre FROM l_sql
            EXECUTE sel_lnt04_oga_pre INTO l_ogb.ogb49
            #2.抓预租
            IF cl_null(l_ogb.ogb49) THEN
               LET l_sql = "SELECT DISTINCT lih08 FROM ",cl_get_target_table(p_azw01,'lih_file'),
                           " WHERE lih14 <= '",l_oga.oga02,"' ",
                           "   AND lih15 >= '",l_oga.oga02,"' ",
                           "   AND lih07  = '",l_ogb.ogb48,"' ",
                           "   AND lihconf = 'Y' "
               CALL cl_replace_sqldb(l_sql) RETURNING l_sql
               CALL cl_parse_qry_sql(l_sql,p_azw01) RETURNING l_sql
               PREPARE sel_lih08_oga_pre FROM l_sql
               EXECUTE sel_lih08_oga_pre INTO l_ogb.ogb49
            END IF

            #商户不存在
            IF cl_null(l_ogb.ogb49) THEN
               LET g_showmsg = 'SEL ogb49'||' '||'SHOP:'||p_azw01||' '||'SALENO:'||g_fno1
               CALL s_errmsg('ogb01',l_ogb.ogb01,g_showmsg,'alm-133',1)
               LET g_errno   = 'alm-133'
               LET g_success = 'N'
               ROLLBACK WORK
               LET g_msg1 = 'ogb_file'||'SEL ogb49'||p_azw01||g_fno1
               CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
               LET g_msg = g_msg[1,255]
               CALL p200_log(g_trans_no,p_azw01,g_fno1,'02','TD_SALE',g_errno,g_msg,'0','N',g_msg1)
               LET g_errno = ''
               LET g_msg   = ''
               LET g_msg1  = ''
               LET g_showmsg = ''
               RETURN
            END IF
         END IF

         IF NOT cl_null(l_oga.oga15) THEN
            LET l_ogb.ogb930 = s_costcenter(l_oga.oga15)
         END IF
         
         LET l_ins = " INSERT INTO ",cl_get_target_table(p_azw01,'ogb_file'),"(",
                     "        ogb01,ogb03,ogb04,ogb05,ogb05_fac, ",
                     "        ogb06,ogb08,ogb09,ogb12,ogb13, ",
                     "        ogb14,ogb14t,ogb15,ogb15_fac,ogb16, ",
                     "        ogb17,ogb18,ogb19,ogb31,ogb32, ",
                     "        ogb60,ogb63,ogb64,ogb916,ogb917, ",
                     "        ogb930,ogbplant,ogblegal,ogb44,ogb45, ",
                     "        ogb46,ogb47,ogb48,ogb49,ogb37, ",
                     "        ogb40,ogb71,ogb50,ogb51,ogb52, ",
                     "        ogb1005,ogb53,ogb54,ogb55,ogb1012) ",
                     " VALUES(?,?,?,?,?,   ?,?,?,?,?, ",
                     "        ?,?,?,?,?,   ?,?,?,?,?, ",
                     "        ?,?,?,?,?,   ?,?,?,?,?, ",
                     "        ?,?,?,?,?,   ?,?,?,?,?, ",
                     "        ?,?,?,?,?) "
         CALL cl_replace_sqldb(l_ins) RETURNING l_ins					
         CALL cl_parse_qry_sql(l_ins,p_azw01) RETURNING l_ins
         PREPARE ins_ogb_pre FROM l_ins
         EXECUTE ins_ogb_pre USING
                     l_ogb.ogb01,l_ogb.ogb03,l_ogb.ogb04,l_ogb.ogb05,l_ogb.ogb05_fac,
                     l_ogb.ogb06,l_ogb.ogb08,l_ogb.ogb09,l_ogb.ogb12,l_ogb.ogb13,
                     l_ogb.ogb14,l_ogb.ogb14t,l_ogb.ogb15,l_ogb.ogb15_fac,l_ogb.ogb16,
                     l_ogb.ogb17,l_ogb.ogb18,l_ogb.ogb19,l_ogb.ogb31,l_ogb.ogb32,
                     l_ogb.ogb60,l_ogb.ogb63,l_ogb.ogb64,l_ogb.ogb916,l_ogb.ogb917,
                     l_ogb.ogb930,l_ogb.ogbplant,l_ogb.ogblegal,l_ogb.ogb44,l_ogb.ogb45,
                     l_ogb.ogb46,l_ogb.ogb47,l_ogb.ogb48,l_ogb.ogb49,l_ogb.ogb37,
                     l_ogb.ogb40,l_ogb.ogb71,l_ogb.ogb50,l_ogb.ogb51,l_ogb.ogb52,
                     l_ogb.ogb1005,l_ogb.ogb53,l_ogb.ogb54,l_ogb.ogb55,l_ogb.ogb1012
         IF SQLCA.sqlcode THEN
            LET g_success = 'N'
            LET g_errno = SQLCA.sqlcode
            LET g_showmsg = 'INS ogb_file'||' '||'SHOP:'||p_azw01||' '||'SALENO:'||g_fno1
            CALL s_errmsg('ogb01',l_ogb.ogb01,g_showmsg,SQLCA.sqlcode,1)
            LET g_msg1 = 'ogb_file'||'INS'||p_azw01||g_fno1 
            ROLLBACK WORK
            CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
            LET g_msg = g_msg[1,255]
            CALL p200_log(g_trans_no,p_azw01,g_fno1,'02','TD_SALE_DETAIL',g_errno,g_msg,'0','N',g_msg1)
            LET g_errno = ''
            LET g_msg   = ''
            LET g_msg1  = ''
            LET g_showmsg = ''
            EXIT FOREACH
         END IF

         IF SQLCA.sqlerrd[3] > 0 THEN
            IF l_sucflag = 0 THEN
               LET l_sucflag = SQLCA.sqlerrd[3]
            END IF
         END IF

        #CALL p200_rxc_ins("ogb_file",p_azw01,l_saleno,l_ogb.ogb03,l_oga.oga01,l_ogb.ogb05,l_oga.oga02,l_ogb.ogb04)             #FUN-CC0082 Mark
         CALL p200_rxc_ins("ogb_file",p_azw01,l_saleno,l_ogb.ogb03,l_oga.oga01,l_ogb.ogb05,l_oga.oga02,l_ogb.ogb04,l_oga.oga84) #FUN-CC0082 Add
         IF g_success='N' THEN
            INITIALIZE l_ogb.* TO NULL #FUN-C80051 Add
            CONTINUE FOREACH
         END IF

      END FOREACH
      IF g_success = 'N' THEN 
         INITIALIZE l_oga.* TO NULL #FUN-C80051 Add
         INITIALIZE l_ogb.* TO NULL #FUN-C80051 Add
         CONTINUE FOREACH 
      END IF

      #單身無資料，取消單頭資料
      IF l_sucflag = 0 THEN
         LET g_success = 'N'
         LET g_errno = 'wag-037'
         LET g_showmsg = 'INS ogb_file'||' '||'SHOP:'||p_azw01||' '||'SALENO:'||g_fno1
         CALL s_errmsg('ogb01',l_oga.oga01,g_showmsg,g_errno,1)
         LET g_msg1 = 'ogb_file'||'INS'||p_azw01||g_fno1
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,g_fno1,'02','TD_SALE_DETAIL',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         LET g_showmsg = ''
         INITIALIZE l_oga.* TO NULL #FUN-C80051 Add
         INITIALIZE l_ogb.* TO NULL #FUN-C80051 Add
         CONTINUE FOREACH
      END IF
      
      #ins ogi_file
      LET l_ins = " INSERT INTO ",cl_get_target_table(p_azw01,'ogi_file'),"(",
                  "        ogi01, ",                     #出貨單號    
                  "        ogi02, ",                     #項次        
                  "        ogi03, ",                     #序號        
                  "        ogi04, ",                     #稅別        
                  "        ogi05, ",                     #稅率        
                  "        ogi06, ",                     #固定稅額    
                  "        ogi07, ",                     #含稅否      
                  "        ogi08, ",                     #未稅金額    
                  "        ogi08t, ",                    #含稅金額    
                  "        ogi09, ",                     #稅額        
                  "        ogidate, ",                   #最近修改日
                  "        ogigrup, ",                   #資料所有部門
                  "        ogilegal, ",                  #所屬法人    
                  "        ogimodu, ",                   #資料修改者
                  "        ogiorig, ",                   #資料建立部門
                  "        ogioriu, ",                   #資料建立者
                  "        ogiplant, ",                  #所屬營運中心
                  "        ogiuser) "                    #資料所有者
                  
      LET l_sel = " SELECT DISTINCT ",
                  " '",l_oga.oga01,"', ",                #ogi01    出貨單號
                  " mitem, ",                            #ogi02    項次
                  " item, ",                             #ogi03    序號
                  " taxcode, ",                          #ogi04    稅別
                  " taxrate, ",                          #ogi05    稅率
                  " 0, ",                                #ogi06    固定稅額
                  " incltax, ",                          #ogi07    含稅否
                  " uamt, ",                             #ogi08    未稅金額
                  " amt, ",                              #ogi08t   含稅金額
                  " tax, ",                              #ogi09    稅額
                  " '",l_oga.ogadate,"', ",              #ogidate  最近修改日
                  " '",l_oga.ogagrup,"', ",              #ogigrup  資料所有部門
                  " '",l_oga.ogalegal,"', ",             #ogilegal 所屬法人
                  " '",l_oga.ogamodu,"', ",              #ogimodu  資料修改者
                  " '",l_oga.ogaorig,"', ",              #ogiorig  資料建立部門
                  " '",l_oga.ogaoriu,"', ",              #ogioriu  資料建立者
                 #" shop, ",                             #ogiplant 所屬營運中心 #FUN-CC0082 Mark
                  " '",l_oga.ogaplant,"', ",             #ogiplant 所屬營運中心 #FUN-CC0082 Add
                  " '",l_oga.ogauser,"' ",               #ogiuser  資料所有者
                  " FROM ",g_posdbs,"td_sale_detail_taxdetail",g_db_links," ",
                 #" WHERE shop = '",p_azw01,"' ",     #FUN-CC0082 Mark
                  " WHERE shop = '",l_oga.oga84,"' ", #FUN-CC0082 Add
                  " AND saleno = '",l_oga.oga98,"' ",
                  " ORDER BY mitem,item "
      
      LET l_sql = l_ins,l_sel CLIPPED
      CALL cl_replace_sqldb(l_sql) RETURNING l_sql
      CALL cl_parse_qry_sql(l_sql,p_azw01) RETURNING l_sql
      PREPARE sel_td_sale_detail_taxdetail_oga_pre FROM l_sql
      EXECUTE sel_td_sale_detail_taxdetail_oga_pre
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno = SQLCA.sqlcode
         LET g_showmsg = 'SEL TD_SALE_DETAIL_TAXDETAIL'||' '||'SHOP:'||p_azw01||' '||'SALENO:'||g_fno1
         CALL s_errmsg('oga98',l_oga.oga98,g_showmsg,SQLCA.sqlcode,1)
         LET g_msg1 = 'TD_SALE_DETAIL_TAXDETAIL'||'SEL'||p_azw01||g_fno1
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,g_fno1,'02','TD_SALE_DETAIL_TAXDETAIL',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         LET g_showmsg = ''
         INITIALIZE l_oga.* TO NULL #FUN-C80051 Add
         INITIALIZE l_ogb.* TO NULL #FUN-C80051 Add
         CONTINUE FOREACH
      END IF

      #ins ogh_file
      LET l_ins = " INSERT INTO ",cl_get_target_table(p_azw01,'ogh_file'),"(",
                  "        ogh01, ",                     #出貨單號    
                  "        ogh02, ",                     #序號        
                  "        ogh03, ",                     #稅別        
                  "        ogh04, ",                     #稅率        
                  "        ogh05, ",                     #固定稅額    
                  "        ogh06, ",                     #含稅否      
                  "        ogh07, ",                     #未稅金額    
                  "        ogh07t, ",                    #含稅金額    
                  "        ogh08, ",                     #稅額        
                  "        ogh09, ",                     #留抵稅額
                  "        oghdate, ",                   #最近修改日
                  "        oghgrup, ",                   #資料所有部門
                  "        oghlegal, ",                  #所屬法人    
                  "        oghmodu, ",                   #資料修改者
                  "        oghorig, ",                   #資料建立部門
                  "        oghoriu, ",                   #資料建立者
                  "        oghplant, ",                  #所屬營運中心
                  "        oghuser) "                    #資料所有者
                  
      LET l_sel = " SELECT DISTINCT ",
                  " '",l_oga.oga01,"', ",                #ogh01    出貨單號
                  " item, ",                             #ogh02    序號
                  " taxcode, ",                          #ogh03    稅別
                  " taxrate, ",                          #ogh04    稅率
                  " 0, ",                                #ogh05    固定稅額
                  " incltax, ",                          #ogh06    含稅否
                  " uamt, ",                             #ogh07    未稅金額
                  " amt, ",                              #ogh07t   含稅金額
                  " tax, ",                              #ogh08    稅額
                  " acctax, ",                           #ogh09    留抵稅額
                  " '",l_oga.ogadate,"', ",              #oghdate  最近修改日
                  " '",l_oga.ogagrup,"', ",              #oghgrup  資料所有部門
                  " '",l_oga.ogalegal,"', ",             #oghlegal 所屬法人
                  " '",l_oga.ogamodu,"', ",              #oghmodu  資料修改者
                  " '",l_oga.ogaorig,"', ",              #oghorig  資料建立部門
                  " '",l_oga.ogaoriu,"', ",              #oghoriu  資料建立者
                 #" shop, ",                             #oghplant 所屬營運中心 #FUN-CC0082 Mark
                  " '",l_oga.ogaplant,"', ",             #oghplant 所屬營運中心 #FUN-CC0082 Add
                  " '",l_oga.ogauser,"' ",               #oghuser  資料所有者
                  " FROM ",g_posdbs,"td_sale_taxmaster",g_db_links," ",
                 #" WHERE shop = '",p_azw01,"' ",     #FUN-CC0082 Mark
                  " WHERE shop = '",l_oga.oga84,"' ", #FUN-CC0082 Add
                  " AND saleno = '",l_oga.oga98,"' ",
                  " ORDER BY item "
                  
      LET l_sql = l_ins,l_sel CLIPPED
      CALL cl_replace_sqldb(l_sql) RETURNING l_sql
      CALL cl_parse_qry_sql(l_sql,p_azw01) RETURNING l_sql
      PREPARE sel_td_sale_taxmaster_oga_pre FROM l_sql
      EXECUTE sel_td_sale_taxmaster_oga_pre 
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno = SQLCA.sqlcode
         LET g_showmsg = 'SEL TD_SALE_TAXMASTER'||' '||'SHOP:'||p_azw01||' '||'SALENO:'||g_fno1
         CALL s_errmsg('oga98',l_oga.oga98,g_showmsg,SQLCA.sqlcode,1)
         LET g_msg1 = 'TD_SALE_TAXMASTER'||'SEL'||p_azw01||g_fno1
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,g_fno1,'02','TD_SALE_TAXMASTER',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         LET g_showmsg = ''
         INITIALIZE l_oga.* TO NULL #FUN-C80051 Add
         INITIALIZE l_ogb.* TO NULL #FUN-C80051 Add
         CONTINUE FOREACH
      END IF

     #FUN-CC0082 Mark&Add Begin ---
     #CALL p200_xyz_ins("oga_file",p_azw01,l_saleno,l_oga.oga01,l_oga.ogauser)
      IF g_rcj12 = '1' AND l_ordershop <> l_oga.oga84 THEN
         CALL p200_xyz_ins("oga_file",l_oga.ogaplant,l_saleno,l_oga.oga01,l_oga.ogauser,l_oga.oga84)
      ELSE
         IF g_rcj12 = '2' AND l_ordershop <> l_oga.oga84 THEN
            CALL p200_xyz_ins("oga_file",l_oga.ogaplant,l_saleno,l_oga.oga01,l_oga.ogauser,l_ordershop)
         ELSE
            CALL p200_xyz_ins("oga_file",l_oga.ogaplant,l_saleno,l_oga.oga01,l_oga.ogauser,'')
         END IF
      END IF
     #FUN-CC0082 Mark&Add End -----
      IF g_success='N' THEN
         INITIALIZE l_oga.* TO NULL #FUN-C80051 Add
         INITIALIZE l_ogb.* TO NULL #FUN-C80051 Add
         CONTINUE FOREACH
      END IF

      #若是訂單轉銷售且支付方式為沖預收則更新預收單號為訂單號
      #注：POS銷售時，沖預收的訂單只能一次性付完
      IF NOT cl_null(l_oga.oga16) THEN
         LET l_sql = "UPDATE ",cl_get_target_table(p_azw01,'rxy_file'),
                     "   SET rxy06 = '",l_oga.oga16,"' ",
                     " WHERE rxy00 = '02' ",
                     "   AND rxy01 = '",l_oga.oga01,"' ",
                    #"   AND rxy03 = '07' " #FUN-CA0160 Mark
                     "   AND rxy33 = 'Y' "  #FUN-CA0160 Add
         CALL cl_replace_sqldb(l_sql) RETURNING l_sql
         CALL cl_parse_qry_sql(l_sql,p_azw01) RETURNING l_sql
         PREPARE upd_rxy06_pre FROM l_sql
         EXECUTE upd_rxy06_pre
         IF SQLCA.sqlcode THEN
            LET g_success = 'N'
            LET g_errno = SQLCA.sqlcode
            LET g_showmsg = 'UPD rxy_file'||' '||'SHOP:'||p_azw01||' '||'SALENO:'||g_fno1
            CALL s_errmsg('rxy01',l_oga.oga01,g_showmsg,SQLCA.sqlcode,1)
            LET g_msg1 = 'rxy_file'||'UPD'||p_azw01||g_fno1
            ROLLBACK WORK
            CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
            LET g_msg = g_msg[1,255]
            CALL p200_log(g_trans_no,p_azw01,g_fno1,'02','UPD rxy_file',g_errno,g_msg,'0','N',g_msg1)
            LET g_errno = ''
            LET g_msg   = ''
            LET g_msg1  = ''
            LET g_showmsg = ''
            INITIALIZE l_oga.* TO NULL #FUN-C80051 Add
            INITIALIZE l_ogb.* TO NULL #FUN-C80051 Add
            CONTINUE FOREACH
         END IF
      END IF

      IF g_success='Y' THEN
        #CALL p200_upd_posflag("td_sale",p_azw01,l_saleno,l_oga.oga01)     #FUN-CC0082 Mark
         CALL p200_upd_posflag("td_sale",l_oga.oga84,l_saleno,l_oga.oga01) #FUN-CC0082 Add
         IF g_success = 'N' THEN 
            INITIALIZE l_oga.* TO NULL #FUN-C80051 Add
            INITIALIZE l_ogb.* TO NULL #FUN-C80051 Add
            CONTINUE FOREACH 
         END IF
      END IF

      IF g_success='Y' THEN
        #CALL p200_sub_oga(l_oga.oga01,p_azw01)             #FUN-CC0082 Mark
         CALL p200_sub_oga(l_oga.oga01,p_azw01,l_ordershop) #FUN-CC0082 Add
         IF g_success = 'Y' AND g_azw.azw04 = '2' THEN
            CALL t620sub1_post('1',l_oga.oga01)           #經營方式處理
            IF g_success = 'N' THEN
               #經營方式報錯處理
               ROLLBACK WORK
               FOR l_i = 1 TO g_err_msg.getLength()
                  LET g_msg1 = 'TD_SALE'||'INS'||p_azw01||g_fno1
                  LET g_msg1 = g_err_msg[l_i].fld1||g_err_msg[l_i].fld2||g_err_msg[l_i].fld3
                  LET g_errno = g_err_msg[l_i].fld4
                  CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
                  CALL p200_log(g_trans_no,p_azw01,g_fno1,'02','TD_SALE',g_errno,g_msg,'0','N',g_msg1)
               END FOR
               INITIALIZE l_oga.* TO NULL #FUN-C80051 Add
               INITIALIZE l_ogb.* TO NULL #FUN-C80051 Add
               CONTINUE FOREACH
            END IF
         END IF
      END IF

     #FUN-CC0082 Add Begin ---
     #写代管库存明细
      IF g_success = 'Y' AND g_rcj12 = '1' AND l_ordershop <> l_oga.oga84 THEN

         #更新中间库CONDITION1为A
         LET l_upd = "UPDATE ",g_posdbs,"td_Sale",g_db_links," ",
                     "   SET Condition1 = 'A' ",
                     " WHERE Saleno = '",l_oga.oga98,"' ",
                     "   AND Shop = '",l_oga.oga84,"' "
         PREPARE upd_condition1_pre FROM l_upd
         EXECUTE upd_condition1_pre
         IF SQLCA.sqlcode THEN
            LET g_success = 'N'
            LET g_errno = SQLCA.sqlcode
            LET g_showmsg = 'UPD Condition1'||' '||'SHOP:'||p_azw01||' '||'SALENO:'||l_oga.oga98
            CALL s_errmsg('Saleno',l_oga.oga98,g_showmsg,SQLCA.sqlcode,1)
            ROLLBACK WORK
            LET g_msg1 = 'Condition1 '||'UPD '||p_azw01||' '||l_oga.oga98
            CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
            LET g_msg = g_msg[1,255]
            CALL p200_log(g_trans_no,p_azw01,l_oga.oga98,'02','td_Sale',g_errno,g_msg,'0','N',g_msg1)
            LET g_errno = ''
            LET g_msg   = ''
            LET g_msg1  = ''
            LET g_showmsg = ''
            CONTINUE FOREACH 
         END IF

         LET l_ins = "INSERT INTO ",cl_get_target_table(p_azw01,'rxg_file'),"( ",
                     "            rxg01, ",                 #產品編號
                     "            rxg02, ",                 #單據日期
                     "            rxg03, ",                 #執行日期
                     "            rxg04, ",                 #異動狀況
                     "            rxg05, ",                 #異動單號
                     "            rxg06, ",                 #異動項次
                     "            rxg07, ",                 #數量
                     "            rxg08, ",                 #單位
                     "            rxg09, ",                 #倉庫
                     "            rxg10, ",                 #儲位
                     "            rxg11, ",                 #批號
                     "            rxg12, ",                 #訂單編號
                     "            rxg13, ",                 #訂單項次
                     "            rxg14, ",                 #配送單號
                     "            rxg15, ",                 #配送單項次
                     "            rxg16, ",                 #配送中心
                     "            rxg17, ",                 #訂貨營運中心
                     "            rxg18, ",                 #取貨營運中心
                     "            rxglegal, ",              #所屬法人
                     "            rxgplant) "               #所屬營運中心
         LET l_sel = "SELECT ",
                     "       ogb04, ",                 #rxg01       #產品編號
                     "       oga02, ",                 #rxg02       #單據日期
                     "       '",g_today,"', ",         #rxg03       #執行日期
                     "       '3', ",                   #rxg04       #異動狀況
                     "       ogb01, ",                 #rxg05       #異動單號
                     "       ogb03, ",                 #rxg06       #異動項次
                     "       ogb12, ",                 #rxg07       #數量
                     "       ogb05, ",                 #rxg08       #單位
                     "       '",g_rtz07,"', ",         #rxg09       #倉庫
                     "       ' ', ",                   #rxg10       #儲位
                     "       ' ', ",                   #rxg11       #批號
                     "       ogb31, ",                 #rxg12       #訂單編號
                     "       ogb32, ",                 #rxg13       #訂單項次
                     "       NULL, ",                  #rxg14       #配送單號
                     "       NULL, ",                  #rxg15       #配送單項次
                     "       NULL, ",                  #rxg16       #配送中心
                     "       ogaplant, ",              #rxg17       #訂貨營運中心
                     "       oga84, ",                 #rxg18       #取貨營運中心
                     "       '",l_legal,"', ",         #rxglegal    #所屬法人
                     "       ogaplant ",               #rxgplant    #所屬營運中心
                     "  FROM ",cl_get_target_table(p_azw01,'ogb_file'),", ",
                     "       ",cl_get_target_table(p_azw01,'oga_file'),
                     " WHERE oga01 = '",l_oga.oga01,"' AND ogb01 = oga01 "
         LET l_sql = l_ins CLIPPED," ",l_sel CLIPPED
         PREPARE ins_rxg_pre FROM l_sql
         EXECUTE ins_rxg_pre
         IF SQLCA.sqlcode THEN
            LET g_success = 'N'
            LET g_errno = SQLCA.sqlcode
            LET g_showmsg = 'INS rxg_file'||' '||'SHOP:'||p_azw01||' '||'SALENO:'||l_oga.oga98
            CALL s_errmsg('Saleno',l_oga.oga98,g_showmsg,SQLCA.sqlcode,1)
            ROLLBACK WORK
            LET g_msg1 = 'rxg_file '||'INS '||p_azw01||' '||l_oga.oga98
            CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
            LET g_msg = g_msg[1,255]
            CALL p200_log(g_trans_no,p_azw01,l_oga.oga98,'02','td_Sale',g_errno,g_msg,'0','N',g_msg1)
            LET g_errno = ''
            LET g_msg   = ''
            LET g_msg1  = ''
            LET g_showmsg = ''
            CONTINUE FOREACH 
         END IF
      END IF
     #FUN-CC0082 Add End -----

      IF g_success = 'Y' THEN
         LET g_sucflag = 1
         COMMIT WORK
      ELSE                       #若單身無數據上傳,則取消單頭上傳
         ROLLBACK WORK
        #FUN-C80045 Mark Begin ---
        #CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
        #LET g_msg = g_msg[1,255]
        #CALL p200_log(g_trans_no,p_azw01,l_saleno,'02','TD_SALE|TD_SALE_DETAIL',g_errno,g_msg,'0','N','')
        #LET g_errno = ''
        #LET g_msg   = ''
        #FUN-C80045 Mark End -----
         INITIALIZE l_oga.* TO NULL #FUN-C80051 Add
         INITIALIZE l_ogb.* TO NULL #FUN-C80051 Add
         CONTINUE FOREACH
      END IF
      INITIALIZE l_oga.* TO NULL #FUN-C80051 Add
      INITIALIZE l_ogb.* TO NULL #FUN-C80051 Add

   END FOREACH

END FUNCTION

FUNCTION p200_oha_d_ins(p_gat01,p_azw01)
DEFINE l_ins      STRING
DEFINE l_sel      STRING
DEFINE p_azw01    LIKE azw_file.azw01
DEFINE l_saleno   LIKE oga_file.oga16
DEFINE p_gat01    LIKE gat_file.gat01
DEFINE l_cnt      LIKE type_file.num5
DEFINE l_item     LIKE type_file.chr5
DEFINE l_oma01    LIKE oma_file.oma01
DEFINE l_oea01    LIKE oea_file.oea01
DEFINE l_oha      RECORD LIKE  oha_file.*
DEFINE l_ohb      RECORD LIKE  ohb_file.*
DEFINE l_ogj      RECORD LIKE  ogj_file.*
DEFINE l_ogk      RECORD LIKE  ogk_file.*
DEFINE l_sql      STRING
DEFINE l_flag     LIKE type_file.chr1
DEFINE l_fac      LIKE ogb_file.ogb05_fac
DEFINE l_upd      STRING
DEFINE l_ohbi     RECORD LIKE ohbi_file.*
DEFINE l_ohb01    LIKE ohb_file.ohb01
DEFINE l_ohb03    LIKE ohb_file.ohb03
DEFINE t_azi03    LIKE azi_file.azi03
DEFINE t_azi04    LIKE azi_file.azi04
DEFINE l_i        LIKE type_file.num5
DEFINE l_check    LIKE type_file.chr1
DEFINE l_rty05  LIKE rty_file.rty05
DEFINE l_rtt01  LIKE rtt_file.rtt01
DEFINE l_rtt11  LIKE rtt_file.rtt11
DEFINE l_rtv12  LIKE rtv_file.rtv12
DEFINE l_rtu01  LIKE rtu_file.rtu01
     
   LET g_time = TIME
   IF NOT cl_null(g_saleno) THEN
      LET g_wc = " saleno = '",g_saleno,"' "
   ELSE
     #CALL p200_g_wc() RETURNING g_wc           #FUN-CA0160 Mark
      CALL p200_g_wc("oha_file") RETURNING g_wc #FUN-CA0160 Add
   END IF
   IF cl_null(g_wc) THEN LET g_wc = " 1=1" END IF

   INITIALIZE l_oha.* TO NULL
   INITIALIZE l_ohb.* TO NULL
   INITIALIZE l_ogj.* TO NULL
   INITIALIZE l_ogk.* TO NULL

   LET g_sql =  " SELECT ",
                " CAST (bdate AS DATE), ",                          #oha02    銷退日期
                " opno, ",                                          #oha14    人員編號
               #" CASE otype WHEN 0 THEN ofno ELSE CAST('' AS NVARCHAR2(20)) END, ",  #oha16    出貨單號            #FUN-CC0082 Mark
                " CASE WHEN (otype = 0 AND (OrderShop = Shop OR OrderShop IS NULL OR OrderShop = ' ')) THEN ofno ", #FUN-CC0082 Add
                "      ELSE CAST('' AS NVARCHAR2(20)) END, ",       #oha16    出货单号                              #FUN-CC0082 Add
                " memo, ",                                          #oha48    備註
                " tot_uamt, ",                                      #oha50    原幣銷退總未稅金額
                " opno, ",                                          #ohauser  資料所有者
                " shop, ",                                          #ohaplant 所屬營運中心
                " cardno, ",                                        #oha87    所屬法人
                " contman, ",                                       #oha88    顧客姓名
                " conttel, ",                                       #oha89    顧客姓名
                " point_qty, ",                                     #oha95    本次積分
                " machine, ",                                       #oha96    收銀機號
                " CAST (sdate AS DATE), ",                          #ohacond  確認日期
                " opno, ",                                          #ohaconu  確認人員
                " CAST (sdate AS DATE), ",                          #ohadate  最近修改日
                " opno, ",                                          #ohaoriu  資料建立者
                " saleno, ",                                        #oha98    POS單號
                " stime[1,2]||':'||stime[3,4]||':'||stime[5,6] ",   #ohacont  確認時間
                " FROM ",g_posdbs,"td_sale",g_db_links,"  ", 
               #" WHERE shop = '",p_azw01,"' AND condition2 = 'A' ",    #FUN-CB0103 Mark
                " WHERE shop = '",p_azw01,"' AND condition2 <> 'Y' ",   #FUN-CB0103 Add
                " AND (type = '1' OR type = '2') AND cnfflg = 'Y' ",
                " AND ",g_wc," ",
                " ORDER BY saleno "

   PREPARE sel_td_sale_oha_pre FROM g_sql
   DECLARE sel_td_sale_oha_curs CURSOR WITH HOLD FOR sel_td_sale_oha_pre
   FOREACH sel_td_sale_oha_curs INTO 
                 l_oha.oha02,                #銷退日期
                 l_oha.oha14,                #人員編號
                 l_oha.oha16,                #出貨單號
                 l_oha.oha48,                #備註
                 l_oha.oha50,                #原幣銷退總未稅金額
                 l_oha.ohauser,              #資料所有者
                 l_oha.ohaplant,             #所屬營運中心
                 l_oha.oha87,                #所屬法人
                 l_oha.oha88,                #顧客姓名
                 l_oha.oha89,                #顧客姓名
                 l_oha.oha95,                #本次積分
                 l_oha.oha96,                #收銀機號
                 l_oha.ohacond,              #確認日期
                 l_oha.ohaconu,              #確認人員
                 l_oha.ohadate,              #最近修改日
                 l_oha.ohaoriu,              #資料建立者
                 l_oha.oha98,                #POS單號
                 l_oha.ohacont               #確認時間

      LET g_success = 'Y' #成功標誌初始化
      IF SQLCA.sqlcode THEN
         LET g_success='N'
         LET g_errno=SQLCA.sqlcode
         LET g_showmsg = 'SEL TD_SALE'||' '||'SHOP:'||p_azw01||' '||'SALENO:'||l_oha.oha98
         CALL s_errmsg('oha98',l_oha.oha98,g_showmsg,SQLCA.sqlcode,1)
         LET g_msg1='TD_SALE'||'SEL'||p_azw01||l_oha.oha98
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg=g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,l_oha.oha98,'02','TD_SALE',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno=''
         LET g_msg=''
         LET g_msg1=''
         LET g_showmsg = ''
         INITIALIZE l_oha.* TO NULL #FUN-C80051 Add
         INITIALIZE l_ohb.* TO NULL #FUN-C80051 Add
         CONTINUE FOREACH
      END IF

      ##--出貨單號欄位不為空--#
      ##--須檢查對應出貨單是否已上傳,若未上傳則先上傳出貨單相關數據--#
      IF NOT cl_null(l_oha.oha16) THEN   
        #CALL p200_check_oha16(p_azw01,l_oha.oha16) RETURNING l_check   #訂單上傳否檢查 
        #IF NOT l_check THEN                         #l_check='N'示未上傳  
         IF NOT p200_check_oha16(p_azw01,l_oha.oha16) THEN
            LET g_saleno = l_oha.oha16
            IF g_psell_way='1' THEN
              #CALL p200_oga_s_ins('oga_file',p_azw01)
            ELSE
              #CALL p200_oga_d_ins("oga_file",p_azw01)     #FUN-CC0082 Mark
               CALL p200_oga_d_ins("oga_file",p_azw01,'1') #FUN-CC0082 Add
            END IF
            IF NOT p200_check_oha16(p_azw01,l_oha.oha16) THEN
               INITIALIZE l_oha.* TO NULL #FUN-C80051 Add
               INITIALIZE l_ohb.* TO NULL #FUN-C80051 Add
               LET g_saleno = '' #FUN-C90065 Add
               CONTINUE FOREACH
            END IF
            LET g_saleno = ''
         END IF
      ELSE
         LET l_oha.oha16 = ''
      END IF
      IF g_success ='N' THEN
         INITIALIZE l_oha.* TO NULL #FUN-C80051 Add
         INITIALIZE l_ohb.* TO NULL #FUN-C80051 Add
         CONTINUE FOREACH
      END IF

      LET g_success = 'Y'
      LET l_sucflag = 0
       
      CALL p200_log_check(p_azw01,l_oha.oha98)
      BEGIN WORK
      IF g_bgjob = "N" THEN
         MESSAGE "oha_file  SHOP:",p_azw01,"  SALENO:",l_oha.oha98,"  BEGIN:",TIME(CURRENT) 
         CALL ui.Interface.refresh()
      END IF
      LET l_saleno=l_oha.oha98
      LET g_fno1 = l_oha.oha98
      LET g_ndate= l_oha.oha02
     #CALL p200_auto_doc(p_gat01,p_azw01) RETURNING l_oha.oha01     #FUN-CC0082 Mark
      CALL p200_auto_doc(p_gat01,p_azw01,'Y') RETURNING l_oha.oha01 #FUN-CC0082 Add
      IF g_success = 'N' THEN
         INITIALIZE l_oha.* TO NULL #FUN-C80051 Add
         INITIALIZE l_ohb.* TO NULL #FUN-C80051 Add
         CONTINUE FOREACH
      END IF
      
      #oha_file default 預設值 Begin --- FUN-C80051 Add 
      LET l_oha.oha05   = '1'          #單據別1.一般銷退 2.多角銷售銷退 3.代採銷退 4.調貨銷退 5.借貨還量
      LET l_oha.oha08   = '1'          #1.內銷 2.外銷 3.視同外銷
      LET l_oha.oha09   = '1'          #銷退處理方式
      LET l_oha.oha42   = 'N'          #是否入庫存
      LET l_oha.oha43   = 'N'          #起始三角貿易銷退單否
      LET l_oha.oha44   = 'N'          #拋轉否
      LET l_oha.ohaconf = 'Y'          #確認否
      LET l_oha.ohapost = 'Y'          #扣帳否
      LET l_oha.ohaprsw = 0            #列印次數
      LET l_oha.oha55   = '1'          #狀況碼
      LET l_oha.ohamksg = 'N'          #簽核否
      LET l_oha.oha94   = 'Y'          #POS銷售否
      LET l_oha.oha57   = '1'          #發票性質
      LET l_oha.oha85   = '1'          #結算方式
      LET l_oha.oha54   = 0            #原幣銷退已開折讓未稅金額
      LET l_oha.oha1019 = 0            #折扣退回未稅金額
      LET l_oha.oha1015 = 'N'          #調貨出貨單自動產生否
      LET l_oha.ohalegal = l_legal     #所屬法人
      #oha_file default 預設值 End ----- FUN-C80051 Add

      LET g_oga16_set = l_oha.oha16
      
      IF cl_null(l_oha.oha03) THEN
         SELECT rtz06 INTO l_oha.oha03 FROM rtz_file WHERE rtz01=p_azw01
      END IF
      
      IF cl_null(l_oha.oha87) THEN
         LET l_oha.oha03 = g_rtz06
         LET g_vip = 'N'
      ELSE
         LET l_sql = "SELECT lpk02,lpk03,lpk20 FROM ",cl_get_target_table(p_azw01,'lpk_file'),",",
                                                      cl_get_target_table(p_azw01,'lpj_file'),
                     " WHERE lpk01 = lpj01 ",
                     "   AND lpj03 = '",l_oha.oha87,"' "
         CALL cl_replace_sqldb(l_sql) RETURNING l_sql
         CALL cl_parse_qry_sql(l_sql,p_azw01) RETURNING l_sql
         PREPARE sel_lpk_oha_pre FROM l_sql
         EXECUTE sel_lpk_oha_pre INTO l_oha.oha90,l_oha.oha91,l_oha.oha03
         LET g_vip = 'Y'
      END IF
      
      LET l_oha.oha04 = l_oha.oha03
      
      LET l_sql= " SELECT ryi02,ryi02,ryi02 FROM ",cl_get_target_table(p_azw01,'ryi_file'),
                 "  WHERE ryi01='",l_oha.ohauser,"' "
      CALL cl_replace_sqldb(l_sql) RETURNING l_sql                  					
      CALL cl_parse_qry_sql(l_sql,p_azw01) RETURNING l_sql             
      PREPARE sel_ryi02_oha_pre FROM l_sql
      EXECUTE sel_ryi02_oha_pre INTO l_oha.ohauser,l_oha.ohaconu,l_oha.oha14
      LET l_oha.ohaoriu = l_oha.ohauser
      
      LET l_sql="SELECT DISTINCT gen03,gen03,gen03 FROM ",cl_get_target_table(p_azw01,'gen_file'),
                " WHERE gen01='",l_oha.ohauser,"' "
      CALL cl_replace_sqldb(l_sql) RETURNING l_sql
      CALL cl_parse_qry_sql(l_sql,p_azw01) RETURNING l_sql
      PREPARE sel_gen03_oha_pre FROM l_sql
      EXECUTE sel_gen03_oha_pre INTO l_oha.ohagrup,l_oha.ohaorig,l_oha.oha15
      
      LET l_sql="SELECT DISTINCT occ02,occ41,occ42,occ43,occ44 ",
                "  FROM ",cl_get_target_table(p_azw01,'occ_file'),
                " WHERE occ01 = '",l_oha.oha03,"' "
      CALL cl_replace_sqldb(l_sql) RETURNING l_sql		
      CALL cl_parse_qry_sql(l_sql,p_azw01) RETURNING l_sql
      PREPARE sel_occ_oha_pre FROM l_sql
      EXECUTE sel_occ_oha_pre INTO l_oha.oha032,l_oha.oha21,l_oha.oha23,l_oha.oha25,l_oha.oha31
      
      LET l_sql="SELECT DISTINCT gec04,gec05,gec07 ",
                "  FROM ",cl_get_target_table(p_azw01,'gec_file'),
                " WHERE gec01  = '",l_oha.oha21,"' ",
                "   AND gec011 = '2' "
      CALL cl_replace_sqldb(l_sql) RETURNING l_sql						
      CALL cl_parse_qry_sql(l_sql,p_azw01) RETURNING l_sql
      PREPARE sel_gec04_oha_pre FROM l_sql
      EXECUTE sel_gec04_oha_pre INTO l_oha.oha211,l_oha.oha212,l_oha.oha213 

      #依據上傳的銷退單號抓取對應的出貨單號
      IF cl_null(l_oha.oha16) THEN
         LET l_oma01 = NULL
         LET l_oea01 = NULL
      ELSE
         LET l_sql= " SELECT oma01 FROM ",cl_get_target_table(p_azw01,'oma_file'),
                    "  WHERE oma16 = '",l_oha.oha16,"' ",
                    "    AND omaconf = 'Y' AND omavoid = 'N'"
         CALL cl_replace_sqldb(l_sql) RETURNING l_sql                  					
         CALL cl_parse_qry_sql(l_sql,p_azw01) RETURNING l_sql             
         PREPARE sel_oma01_oha_pre FROM l_sql
         EXECUTE sel_oma01_oha_pre INTO l_oma01
      
         LET l_sql= " SELECT oga01 FROM ",cl_get_target_table(p_azw01,'oga_file'),
                    "  WHERE oga98 ='",l_oha.oha16,"'",
                    "    AND ogaconf ='Y'"
         CALL cl_replace_sqldb(l_sql) RETURNING l_sql                  					
         CALL cl_parse_qry_sql(l_sql,p_azw01) RETURNING l_sql             
         PREPARE sel_oga01_oha_pre FROM l_sql
         EXECUTE sel_oga01_oha_pre INTO l_oha.oha16
      
         LET l_sql= " SELECT oea01 FROM ",cl_get_target_table(p_azw01,'oea_file'),
                    "  WHERE oea01 = '",l_oha.oha16,"' ",
                    "    AND oeaconf = 'Y' "
         CALL cl_replace_sqldb(l_sql) RETURNING l_sql                  					
         CALL cl_parse_qry_sql(l_sql,p_azw01) RETURNING l_sql             
         PREPARE sel_oea01_oha_pre FROM l_sql
         EXECUTE sel_oea01_oha_pre INTO l_oea01
      END IF
      
      CALL s_currm(l_oha.oha23,l_oha.oha02,g_oaz.oaz52,p_azw01) RETURNING l_oha.oha24
      SELECT azi03,azi04 INTO t_azi03,t_azi04 FROM azi_file WHERE azi01=l_oha.oha23
      CALL cl_numfor(l_oha.oha50,8,t_azi04) RETURNING l_oha.oha50

      LET  l_oha.oha53 = l_oha.oha50 - l_oha.oha1019

      LET l_ins = " INSERT INTO ",cl_get_target_table(p_azw01,'oha_file'),"(",
                  "        oha01,oha02,oha03,oha032,oha04, ",
                  "        oha05,oha08,oha09,oha14,oha15, ",
                  "        oha16,oha21,oha211,oha212,oha213, ",
                  "        oha23,oha24,oha25,oha31,oha42, ",
                  "        oha43,oha44,oha48,oha50,oha53, ",
                  "        oha54,ohaconf,ohapost,ohaprsw,ohauser, ",
                  "        ohagrup,oha55,ohamksg,ohaplant,ohalegal, ",
                  "        oha87,oha88,oha89,oha90,oha91, ",
                  "        oha94,oha95,oha96,ohacond,ohaconu, ",
                  "        ohaoriu,ohaorig,oha98,oha57,ohacont, ",
                  "        oha85,oha1019,oha1015,ohadate) ",
                  " VALUES(?,?,?,?,?,   ?,?,?,?,?, ",
                  "        ?,?,?,?,?,   ?,?,?,?,?, ",
                  "        ?,?,?,?,?,   ?,?,?,?,?, ",
                  "        ?,?,?,?,?,   ?,?,?,?,?, ",
                  "        ?,?,?,?,?,   ?,?,?,?,?, ",
                  "        ?,?,?,?) "
      CALL cl_replace_sqldb(l_ins) RETURNING l_ins
      CALL cl_parse_qry_sql(l_ins,p_azw01) RETURNING l_ins
      PREPARE ins_oha_pre FROM l_ins
      EXECUTE ins_oha_pre USING 
                  l_oha.oha01,l_oha.oha02,l_oha.oha03,l_oha.oha032,l_oha.oha04,
                  l_oha.oha05,l_oha.oha08,l_oha.oha09,l_oha.oha14,l_oha.oha15,
                  l_oha.oha16,l_oha.oha21,l_oha.oha211,l_oha.oha212,l_oha.oha213,
                  l_oha.oha23,l_oha.oha24,l_oha.oha25,l_oha.oha31,l_oha.oha42,
                  l_oha.oha43,l_oha.oha44,l_oha.oha48,l_oha.oha50,l_oha.oha53,
                  l_oha.oha54,l_oha.ohaconf,l_oha.ohapost,l_oha.ohaprsw,l_oha.ohauser,
                  l_oha.ohagrup,l_oha.oha55,l_oha.ohamksg,l_oha.ohaplant,l_oha.ohalegal,
                  l_oha.oha87,l_oha.oha88,l_oha.oha89,l_oha.oha90,l_oha.oha91,
                  l_oha.oha94,l_oha.oha95,l_oha.oha96,l_oha.ohacond,l_oha.ohaconu,
                  l_oha.ohaoriu,l_oha.ohaorig,l_oha.oha98,l_oha.oha57,l_oha.ohacont,
                  l_oha.oha85,l_oha.oha1019,l_oha.oha1015,l_oha.ohadate
      IF SQLCA.sqlcode OR SQLCA.sqlerrd[3] = 0 THEN
         LET g_success = 'N'
         LET g_errno = SQLCA.sqlcode
         LET g_showmsg = 'INS oha_file'||' '||'SHOP:'||p_azw01||' '||'SALENO:'||g_fno1
         CALL s_errmsg('oha01',l_oha.oha01,g_showmsg,SQLCA.sqlcode,1)   
         ROLLBACK WORK
         LET g_msg1 = 'oha_file'||'INS'||p_azw01||g_fno1 
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,g_fno1,'02','TD_SALE',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         LET g_showmsg = ''
         INITIALIZE l_oha.* TO NULL #FUN-C80051 Add
         INITIALIZE l_ohb.* TO NULL #FUN-C80051 Add
         CONTINUE FOREACH
      END IF 

      #ins ohb_file
      #ohb_file default 預設值 Begin --- FUN-C80051 Add
      LET l_ohb.ohb60 = 0              #
      LET l_ohb.ohb61 = 'N'            #
      LET l_ohb.ohb1005 = '1'          #作業方式
      LET l_ohb.ohb1004 = 'N'          #搭贈
      LET l_ohb.ohb09 = g_rtz07        #出貨倉庫
      #ohb_file default 預設值 End ----- FUN-C80051 Add

      LET g_sql = " SELECT DISTINCT ",
                  " '",l_oha.oha01,"', ",        #ohb01    銷退單號
                  " item, ",                     #ohb03    項次
                 #" CASE WHEN featureno IS NULL THEN pluno ELSE featureno END, ",    #ohb04    產品編號
                  " CASE WHEN featureno IS NULL THEN pluno WHEN featureno = ' ' THEN pluno ELSE featureno END, ",   #oeb04    產品編號
                  " unit, ",                     #ohb05    銷售單位
                  " shop, ",                     #ohb08    銷退入庫營運中心編號
                  " qty, ",                      #ohb12    數量
                  " price, ",                    #ohb13    原幣單價
                  " uamt, ",                     #ohb14    原幣未稅金額
                  " amt, ",                      #ohb14t   原幣含稅金額
                  " '",l_oha.oha16,"', ",        #ohb31    出貨單號
                  " oitem, ",                    #ohb32    出貨項次
                  " unit, ",                     #ohb916   計價單位
                  " qty, ",                      #ohb917   計價數量
                  " '",l_oha.ohalegal,"', ",     #ohalegal 所屬法人
                  " shop, ",                     #ohbplant 所屬營運中心
                  " disc, ",                     #ohb67    分攤折價
                  " 'N', ",                      #ohb68    有實物否  Y-是,N-否
                  " counterno, ",                #ohb69    攤位編號
                  " oldprice, ",                 #ohb37    基礎單价
                  " mno ",                       #ohb40    抽成代號
                  " FROM  ",g_posdbs,"td_sale_detail",g_db_links,   
                  " WHERE shop = '",p_azw01,"' ",
                  " AND saleno = '",l_saleno,"' ",
                 #" AND ",g_wc," ", #FUN-C80051 Mark
                  " ORDER BY item "
      CALL cl_replace_sqldb(g_sql) RETURNING g_sql
      CALL cl_parse_qry_sql(g_sql,p_azw01) RETURNING g_sql
      PREPARE sel_td_sale_detail_ohb_pre FROM g_sql
      DECLARE sel_td_sale_detail_ohb_curs CURSOR WITH HOLD FOR sel_td_sale_detail_ohb_pre
      FOREACH sel_td_sale_detail_ohb_curs INTO 
                  l_ohb.ohb01,                   #銷退單號
                  l_ohb.ohb03,                   #項次
                  l_ohb.ohb04,                   #產品編號
                  l_ohb.ohb05,                   #銷售單位
                  l_ohb.ohb08,                   #銷退入庫營運中心編號
                  l_ohb.ohb12,                   #數量
                  l_ohb.ohb13,                   #原幣單價
                  l_ohb.ohb14,                   #原幣未稅金額
                  l_ohb.ohb14t,                  #原幣含稅金額
                  l_ohb.ohb31,                   #出貨單號
                  l_ohb.ohb32,                   #出貨項次
                  l_ohb.ohb916,                  #計價單位
                  l_ohb.ohb917,                  #計價數量
                  l_ohb.ohblegal,                #所屬法人
                  l_ohb.ohbplant,                #所屬營運中心
                  l_ohb.ohb67,                   #分攤折價
                  l_ohb.ohb68,                   #有實物否  Y-是,N-否
                  l_ohb.ohb69,                   #攤位編號
                  l_ohb.ohb37,                   #基礎單价
                  l_ohb.ohb40                    #抽成代號
 
         IF SQLCA.sqlcode THEN
            LET g_success = 'N'
            LET g_errno = SQLCA.sqlcode
            LET g_showmsg = 'SEL TD_SALE_DETAIL'||' '||'SHOP:'||p_azw01||' '||'SALENO:'||g_fno1
            CALL s_errmsg('oha98',l_oha.oha98,g_showmsg,SQLCA.sqlcode,1)
            ROLLBACK WORK
            LET g_msg1 = 'TD_SALE_DETAIL'||'SEL'||p_azw01||g_fno1  
            CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
            LET g_msg = g_msg[1,255]
            CALL p200_log(g_trans_no,p_azw01,g_fno1,'02','TD_SALE_DETAIL',g_errno,g_msg,'0','N',g_msg1)
            LET g_errno = ''
            LET g_msg   = ''
            LET g_msg1  = ''
            LET g_showmsg = ''
            EXIT FOREACH
         END IF
         LET l_item = l_oha.oha03 USING "&&&&"

         LET g_sql = "SELECT rty06 FROM ",cl_get_target_table(p_azw01,'rty_file'),
                     " WHERE rty01 = '",p_azw01,"' AND rty02 = '",l_ohb.ohb04,"' "
         CALL cl_replace_sqldb(g_sql) RETURNING g_sql
         CALL cl_parse_qry_sql(g_sql,p_azw01) RETURNING g_sql        
         PREPARE sel_rty06_ohb_pre FROM g_sql
         EXECUTE sel_rty06_ohb_pre INTO l_ohb.ohb64
         
         IF cl_null(l_ohb.ohb64) THEN LET l_ohb.ohb64='1' END IF 
         
         #若經營方式為聯營或代銷  
         IF l_ohb.ohb64='3' OR l_ohb.ohb64='4' THEN
            LET l_sql = "SELECT rty05 FROM ",cl_get_target_table(p_azw01,'rty_file'),
                        " WHERE rty01 = '",p_azw01,"' ",
                        "   AND rty02 = '",l_ohb.ohb04,"' AND rtyacti = 'Y' "
            CALL cl_replace_sqldb(l_sql) RETURNING l_sql
            CALL cl_parse_qry_sql(l_sql,p_azw01) RETURNING l_sql
            PREPARE sel_rty05_oha_pre FROM l_sql 
            EXECUTE sel_rty05_oha_pre INTO l_rty05
            IF NOT cl_null(l_rty05) THEN
               LET l_sql = "SELECT rtt01,rtt11 FROM ",cl_get_target_table(p_azw01,'rtt_file'),",",
                                                      cl_get_target_table(p_azw01,'rts_file'),",",
                                                      cl_get_target_table(p_azw01,'rto_file'),
                           " WHERE rts01 = rtt01 ",
                           "   AND rttplant = rtsplant ",
                           "   AND rts02 = rtt02 ",
                           "   AND rtt04 = '",l_ohb.ohb04,"' ",
                           "   AND rto01 = rts04 ",
                           "   AND rtoplant = rtsplant ",
                           "   AND rto05 = '",l_rty05,"' ",
                           "   AND rto06 = '",l_ohb.ohb64,"' ",
                           "   AND rto08 <= '",l_oha.oha02,"' ",
                           "   AND rto09 >= '",l_oha.oha02,"' ",
                           "   AND rtt15 = 'Y' ",
                           "   AND rtoconf = 'Y' ",
                           "   AND rtsconf = 'Y' ",
                           "   AND rto03 = rts02 ",
                           "   AND rtoplant = '",p_azw01,"' "
               CALL cl_replace_sqldb(l_sql) RETURNING l_sql
               CALL cl_parse_qry_sql(l_sql,p_azw01) RETURNING l_sql
               PREPARE sel_rtt_oha_pre FROM l_sql
               EXECUTE sel_rtt_oha_pre INTO l_rtt01,l_rtt11
               IF NOT cl_null(l_rtt01) THEN
                  LET l_sql = "SELECT rtv12,rtu01 FROM ",cl_get_target_table(p_azw01,'rtv_file'),",",
                                                         cl_get_target_table(p_azw01,'rtu_file'),",",
                                                         cl_get_target_table(p_azw01,'rtt_file'),
                              " WHERE rtt01 = rtu04 ",
                              "   AND rtt02 = rtu02 ",
                              "   AND rttplant = rtuplant ",
                              "   AND rtuplant = '",p_azw01,"' ",
                              "   AND rtuconf = 'Y' ",
                              "   AND rtuplant = rtvplant ",
                              "   AND rtu01 = rtv01 ",
                              "   AND rtu02 = rtv02 ",
                              "   AND rtu09 <= '",l_oha.oha02,"' ",
                              "   AND rtu10 >= '",l_oha.oha02,"' ", 
                              "   AND rtt01 = '",l_rtt01,"' ",
                              "   AND rtu05 = '",l_rty05,"' ",
                              "   AND rtu06 = '",l_ohb.ohb64,"' ",
                              "   AND rtv04 = '",l_ohb.ohb04,"' "
                  CALL cl_replace_sqldb(l_sql) RETURNING l_sql
                  CALL cl_parse_qry_sql(l_sql,p_azw01) RETURNING l_sql
                  PREPARE sel_rtv12_oha_pre FROM l_sql
                  EXECUTE sel_rtv12_oha_pre INTO l_rtv12,l_rtu01
                  IF NOT cl_null(l_rtu01) THEN
                     LET l_ohb.ohb65=l_rtv12
                  ELSE
                     LET l_ohb.ohb65=l_rtt11
                  END IF
               END IF
            END IF
         ELSE
            LET l_ohb.ohb65 = NULL
         END IF
         LET l_ohb.ohb66 = l_ohb.ohb65

         IF NOT cl_null(l_ohb.ohb69) THEN
            #1.抓合同中的商户
            LET l_sql = "SELECT DISTINCT lnt04 FROM ",cl_get_target_table(p_azw01,'lnt_file'),
                        " WHERE lnt17 <= '",l_oha.oha02,"' ",
                        "   AND lnt18 >= '",l_oha.oha02,"' ",
                        "   AND lnt06  = '",l_ohb.ohb69,"' ",
                        "   AND (lnt26 = 'Y' OR lnt26 = 'S' OR lnt26 = 'E') "
            CALL cl_replace_sqldb(l_sql) RETURNING l_sql
            CALL cl_parse_qry_sql(l_sql,p_azw01) RETURNING l_sql
            PREPARE sel_lnt04_oha_pre FROM l_sql
            EXECUTE sel_lnt04_oha_pre INTO l_ohb.ohb70
            #2.抓预租
            IF cl_null(l_ohb.ohb70) THEN
               LET l_sql = "SELECT DISTINCT lih08 FROM ",cl_get_target_table(p_azw01,'lih_file'),
                           " WHERE lih14 <= '",l_oha.oha02,"' ",
                           "   AND lih15 >= '",l_oha.oha02,"' ",
                           "   AND lih07  = '",l_ohb.ohb69,"' ",
                           "   AND lihconf = 'Y' "
               CALL cl_replace_sqldb(l_sql) RETURNING l_sql
               CALL cl_parse_qry_sql(l_sql,p_azw01) RETURNING l_sql
               PREPARE sel_lih08_oha_pre FROM l_sql
               EXECUTE sel_lih08_oha_pre INTO l_ohb.ohb70
            END IF

            #商户不存在
            IF cl_null(l_ohb.ohb70) THEN
               LET g_showmsg = 'SEL ohb70'||' '||'SHOP:'||p_azw01||' '||'SALENO:'||g_fno1
               CALL s_errmsg('ohb01',l_ohb.ohb01,g_showmsg,'alm-133',1)
               LET g_errno   = 'alm-133'
               LET g_success = 'N'
               ROLLBACK WORK
               LET g_msg1 = 'ohb_file'||'SEL ohb70'||p_azw01||g_fno1
               CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
               LET g_msg = g_msg[1,255]
               CALL p200_log(g_trans_no,p_azw01,g_fno1,'02','TD_SALE',g_errno,g_msg,'0','N',g_msg1)
               LET g_errno = ''
               LET g_msg   = ''
               LET g_msg1  = ''
               LET g_showmsg = ''
               RETURN
            END IF
         END IF

         LET l_sql ="SELECT ima02,ima021,ima25 ",
                    "  FROM ",cl_get_target_table(p_azw01,'ima_file'),
                    " WHERE ima01='",l_ohb.ohb04 ,"'"
         CALL cl_replace_sqldb(l_sql) RETURNING l_sql
         CALL cl_parse_qry_sql(l_sql,p_azw01) RETURNING l_sql
         PREPARE sel_ima_ohb_pre FROM l_sql
         EXECUTE sel_ima_ohb_pre INTO l_ohb.ohb06,l_ohb.ohb07,l_ohb.ohb15
         
         CALL s_umfchkm(l_ohb.ohb04,l_ohb.ohb05,l_ohb.ohb15,p_azw01) RETURNING l_flag,l_fac
         IF l_flag='1' THEN
            LET l_ohb.ohb05_fac=1
            LET l_ohb.ohb15_fac=1
         ELSE
            LET l_ohb.ohb05_fac=l_fac
            LET l_ohb.ohb15_fac=l_fac
         END IF
         LET l_ohb.ohb16 = l_ohb.ohb12 * l_ohb.ohb15_fac
         
         IF NOT cl_null(l_ohb.ohb31) AND NOT cl_null(l_ohb.ohb32) THEN
            LET l_sql = "SELECT ogb31,ogb32 FROM ",cl_get_target_table(p_azw01,'ogb_file'),
                        " WHERE ogb01 = '",l_ohb.ohb31,"' ",
                        "   AND ogb03 = '",l_ohb.ohb32,"' "
            CALL cl_replace_sqldb(l_sql) RETURNING l_sql
            CALL cl_parse_qry_sql(l_sql,p_azw01) RETURNING l_sql
            PREPARE sel_ogb_ohb_pre FROM l_sql
            EXECUTE sel_ogb_ohb_pre INTO l_ohb.ohb33,l_ohb.ohb34

            IF cl_null(l_ohb.ohb33) THEN
               LET l_ohb.ohb33 = ''
               LET l_ohb.ohb34 = ''
            END IF

            #若來源出貨單號與項次不為空，則更新出貨單單身的已退貨數量
            CALL p200_upd_td_sale_detail_rqty(p_azw01,g_oga16_set,l_ohb.ohb32,l_ohb.ohb12)
            IF g_success = 'N' THEN
               INITIALIZE l_ohb.* TO NULL #FUN-C80051 Add
               CONTINUE FOREACH
            END IF
         END IF

         IF cl_null(l_ohb.ohb31) THEN 
            LET l_ohb.ohb31 = '' 
            LET l_ohb.ohb32 = ''
         END IF
         IF cl_null(l_ohb.ohb32) THEN LET l_ohb.ohb32 = '' END IF

         IF NOT cl_null(l_oha.oha15) THEN
            LET l_ohb.ohb930 = s_costcenter(l_oha.oha15)
         END IF

         LET l_ins=" INSERT INTO ",cl_get_target_table(p_azw01,'ohb_file'),"(",
                   "        ohb01,ohb03,ohb04,ohb05,ohb05_fac, ",
                   "        ohb06,ohb08,ohb09,ohb12,ohb13, ",
                   "        ohb14,ohb14t,ohb15,ohb15_fac,ohb16, ",
                   "        ohb30,ohb31,ohb32,ohb33,ohb34, ",
                   "        ohb60,ohb916,ohb917,ohb930,ohb61, ",
                   "        ohbplant,ohblegal,ohb64,ohb65,ohb66, ",
                   "        ohb67,ohb68,ohb69,ohb70,ohb37, ",
                   "        ohb40,ohb71,ohb1005,ohb1004) ",
                   " VALUES(?,?,?,?,?,   ?,?,?,?,?, ",
                   "        ?,?,?,?,?,   ?,?,?,?,?, ",
                   "        ?,?,?,?,?,   ?,?,?,?,?, ",
                   "        ?,?,?,?,?,   ?,?,?,?) "
         CALL cl_replace_sqldb(l_ins) RETURNING l_ins					
         CALL cl_parse_qry_sql(l_ins,p_azw01) RETURNING l_ins
         PREPARE ins_ohb_pre FROM l_ins
         EXECUTE ins_ohb_pre USING
                   l_ohb.ohb01,l_ohb.ohb03,l_ohb.ohb04,l_ohb.ohb05,l_ohb.ohb05_fac,
                   l_ohb.ohb06,l_ohb.ohb08,l_ohb.ohb09,l_ohb.ohb12,l_ohb.ohb13,
                   l_ohb.ohb14,l_ohb.ohb14t,l_ohb.ohb15,l_ohb.ohb15_fac,l_ohb.ohb16,
                   l_ohb.ohb30,l_ohb.ohb31,l_ohb.ohb32,l_ohb.ohb33,l_ohb.ohb34,
                   l_ohb.ohb60,l_ohb.ohb916,l_ohb.ohb917,l_ohb.ohb930,l_ohb.ohb61,
                   l_ohb.ohbplant,l_ohb.ohblegal,l_ohb.ohb64,l_ohb.ohb65,l_ohb.ohb66,
                   l_ohb.ohb67,l_ohb.ohb68,l_ohb.ohb69,l_ohb.ohb70,l_ohb.ohb37,
                   l_ohb.ohb40,l_ohb.ohb71,l_ohb.ohb1005,l_ohb.ohb1004
         IF SQLCA.sqlcode THEN
            LET g_success = 'N'
            LET g_errno = SQLCA.sqlcode
            LET g_showmsg = 'INS ohb_file'||' '||'SHOP:'||p_azw01||' '||'SALENO:'||g_fno1
            CALL s_errmsg('ohb01',l_ohb.ohb01,g_showmsg,SQLCA.sqlcode,1)
            ROLLBACK WORK
            LET g_msg1 = 'ohb_file'||'INS'||p_azw01||g_fno1
            CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
            LET g_msg = g_msg[1,255]
            CALL p200_log(g_trans_no,p_azw01,g_fno1,'02','TD_SALE_DETAIL',g_errno,g_msg,'0','N',g_msg1)
            LET g_errno = ''
            LET g_msg   = ''
            LET g_msg1  = ''
            LET g_showmsg = ''
            EXIT FOREACH
         ELSE
            IF NOT s_industry('std') THEN
              INITIALIZE l_ohbi.* TO NULL
              LET l_ohbi.ohbi01 = l_ohb.ohb01
              LET l_ohbi.ohbi03 = l_ohb.ohb03
              IF NOT s_ins_ohbi(l_ohbi.*,p_azw01) THEN
                 LET g_success = 'N'
                 LET g_errno   = ''
                 LET g_msg     = ''
                 LET g_msg1    = ''
                 INITIALIZE l_ohb.* TO NULL #FUN-C80051 Add
                 CONTINUE FOREACH
              END IF
            END IF 
         END IF

         IF SQLCA.sqlerrd[3] > 0 AND l_sucflag = 0 THEN
            LET l_sucflag = SQLCA.sqlerrd[3]
         END IF
         IF l_sucflag = 0 THEN 
            LET g_success = 'N' 
            INITIALIZE l_ohb.* TO NULL #FUN-C80051 Add
            CONTINUE FOREACH 
         END IF

        #CALL p200_rxc_ins("ohb_file",p_azw01,l_saleno,l_ohb.ohb03,l_oha.oha01,l_ohb.ohb05,l_oha.oha02,l_ohb.ohb04)         #FUN-CC0082 Mark
         CALL p200_rxc_ins("ohb_file",p_azw01,l_saleno,l_ohb.ohb03,l_oha.oha01,l_ohb.ohb05,l_oha.oha02,l_ohb.ohb04,p_azw01) #FUN-CC0082 Add
         IF g_success = 'N' THEN
            INITIALIZE l_ohb.* TO NULL #FUN-C80051 Add
            CONTINUE FOREACH
         END IF
      END FOREACH 
      IF g_success = 'N' THEN 
         INITIALIZE l_oha.* TO NULL #FUN-C80051 Add
         INITIALIZE l_ohb.* TO NULL #FUN-C80051 Add
         CONTINUE FOREACH 
      END IF

      #單身無資料，取消單頭資料
      IF l_sucflag = 0 THEN
         LET g_success = 'N'
         LET g_errno = 'wag-037'
         LET g_showmsg = 'INS ohb_file'||' '||'SHOP:'||p_azw01||' '||'SALENO:'||g_fno1
         CALL s_errmsg('ohb01',l_oha.oha01,g_showmsg,g_errno,1)
         LET g_msg1 = 'ohb_file'||'INS'||p_azw01||g_fno1
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,g_fno1,'02','TD_SALE_DETAIL',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         LET g_showmsg = ''
         INITIALIZE l_oha.* TO NULL #FUN-C80051 Add
         INITIALIZE l_ohb.* TO NULL #FUN-C80051 Add
         CONTINUE FOREACH
      END IF

      #ins ogk_file
      LET l_ins = " INSERT INTO ",cl_get_target_table(p_azw01,'ogk_file'),"(",
                  "        ogk01, ",                     #出貨單號    
                  "        ogk02, ",                     #項次        
                  "        ogk03, ",                     #序號        
                  "        ogk04, ",                     #稅別        
                  "        ogk05, ",                     #稅率        
                  "        ogk06, ",                     #固定稅額    
                  "        ogk07, ",                     #含稅否      
                  "        ogk08, ",                     #未稅金額    
                  "        ogk08t, ",                    #含稅金額    
                  "        ogk09, ",                     #稅額        
                  "        ogkdate, ",                   #最近修改日
                  "        ogkgrup, ",                   #資料所有部門
                  "        ogklegal, ",                  #所屬法人    
                  "        ogkmodu, ",                   #資料修改者
                  "        ogkorig, ",                   #資料建立部門
                  "        ogkoriu, ",                   #資料建立者
                  "        ogkplant, ",                  #所屬營運中心
                  "        ogkuser) "                    #資料所有者
                  
      LET l_sel = " SELECT DISTINCT ",
                  " '",l_oha.oha01,"', ",                #ogk01    出貨單號
                  " mitem, ",                            #ogk02    項次
                  " item, ",                             #ogk03    序號
                  " taxcode, ",                          #ogk04    稅別
                  " taxrate, ",                          #ogk05    稅率
                  " 0, ",                                #ogk06    固定稅額
                  " incltax, ",                          #ogk07    含稅否
                  " uamt, ",                             #ogk08    未稅金額
                  " amt, ",                              #ogk08t   含稅金額
                  " tax, ",                              #ogk09    稅額
                  " '",l_oha.ohadate,"', ",              #ogkdate  最近修改日
                  " '",l_oha.ohagrup,"', ",              #ogkgrup  資料所有部門
                  " '",l_oha.ohalegal,"', ",             #ogklegal 所屬法人
                  " '",l_oha.ohamodu,"', ",              #ogkmodu  資料修改者
                  " '",l_oha.ohaorig,"', ",              #ogkorig  資料建立部門
                  " '",l_oha.ohaoriu,"', ",              #ogkoriu  資料建立者
                  " shop, ",                             #ogkplant 所屬營運中心
                  " '",l_oha.ohauser,"' ",               #ogkuser  資料所有者
                  " FROM ",g_posdbs,"td_sale_detail_taxdetail",g_db_links," ",
                  " WHERE shop = '",p_azw01,"' ",
                  " AND saleno = '",l_oha.oha98,"' ",
                  " ORDER BY mitem,item "
      
      LET l_sql = l_ins,l_sel CLIPPED
      CALL cl_replace_sqldb(l_sql) RETURNING l_sql
      CALL cl_parse_qry_sql(l_sql,p_azw01) RETURNING l_sql
      PREPARE sel_td_sale_detail_taxdetail_oha_pre FROM l_sql
      EXECUTE sel_td_sale_detail_taxdetail_oha_pre
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno = SQLCA.sqlcode
         LET g_showmsg = 'SEL TD_SALE_DETAIL_TAXDETAIL'||' '||'SHOP:'||p_azw01||' '||'SALENO:'||g_fno1
         CALL s_errmsg('oha98',l_oha.oha98,g_showmsg,SQLCA.sqlcode,1)
         LET g_msg1 = 'TD_SALE_DETAIL_TAXDETAIL'||'SEL'||p_azw01||g_fno1
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,g_fno1,'02','TD_SALE_DETAIL_TAXDETAIL',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         LET g_showmsg = ''
         INITIALIZE l_oha.* TO NULL #FUN-C80051 Add
         INITIALIZE l_ohb.* TO NULL #FUN-C80051 Add
         CONTINUE FOREACH
      END IF
      
      #ins ogj_file
      LET l_ins = " INSERT INTO ",cl_get_target_table(p_azw01,'ogj_file'),"(",
                  "        ogj01, ",                     #出貨單號    
                  "        ogj02, ",                     #序號        
                  "        ogj03, ",                     #稅別        
                  "        ogj04, ",                     #稅率        
                  "        ogj05, ",                     #固定稅額    
                  "        ogj06, ",                     #含稅否      
                  "        ogj07, ",                     #未稅金額    
                  "        ogj07t, ",                    #含稅金額    
                  "        ogj08, ",                     #稅額        
                  "        ogj09, ",                     #留抵稅額
                  "        ogjdate, ",                   #最近修改日
                  "        ogjgrup, ",                   #資料所有部門
                  "        ogjlegal, ",                  #所屬法人    
                  "        ogjmodu, ",                   #資料修改者
                  "        ogjorig, ",                   #資料建立部門
                  "        ogjoriu, ",                   #資料建立者
                  "        ogjplant, ",                  #所屬營運中心
                  "        ogjuser) "                    #資料所有者
                  
      LET l_sel = " SELECT DISTINCT ",
                  " '",l_oha.oha01,"', ",                #ogj01    出貨單號
                  " item, ",                             #ogj02    序號
                  " taxcode, ",                          #ogj03    稅別
                  " taxrate, ",                          #ogj04    稅率
                  " 0, ",                                #ogj05    固定稅額
                  " incltax, ",                          #ogj06    含稅否
                  " uamt, ",                             #ogj07    未稅金額
                  " amt, ",                              #ogj07t   含稅金額
                  " tax, ",                              #ogj08    稅額
                  " acctax, ",                           #ogj09    留抵稅額
                  " '",l_oha.ohadate,"', ",              #ogjdate  最近修改日
                  " '",l_oha.ohagrup,"', ",              #ogjgrup  資料所有部門
                  " '",l_oha.ohalegal,"', ",             #ogjlegal 所屬法人
                  " '",l_oha.ohamodu,"', ",              #ogjmodu  資料修改者
                  " '",l_oha.ohaorig,"', ",              #ogjorig  資料建立部門
                  " '",l_oha.ohaoriu,"', ",              #ogjoriu  資料建立者
                  " shop, ",                             #ogjplant 所屬營運中心
                  " '",l_oha.ohauser,"' ",               #ogjuser  資料所有者
                  " FROM ",g_posdbs,"td_sale_taxmaster",g_db_links," ",
                  " WHERE shop = '",p_azw01,"' ",
                  " AND saleno = '",l_oha.oha98,"' ",
                  " ORDER BY item "
      
      LET l_sql = l_ins,l_sel CLIPPED
      CALL cl_replace_sqldb(l_sql) RETURNING l_sql
      CALL cl_parse_qry_sql(l_sql,p_azw01) RETURNING l_sql
      PREPARE sel_td_sale_taxmaster_oha_pre FROM l_sql
      EXECUTE sel_td_sale_taxmaster_oha_pre
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno = SQLCA.sqlcode
         LET g_showmsg = 'SEL TD_SALE_TAXMASTER'||' '||'SHOP:'||p_azw01||' '||'SALENO:'||g_fno1
         CALL s_errmsg('oha98',l_oha.oha98,g_showmsg,SQLCA.sqlcode,1)
         LET g_msg1 = 'TD_SALE_TAXMASTER'||'SEL'||p_azw01||g_fno1
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,g_fno1,'02','TD_SALE_TAXMASTER',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         LET g_showmsg = ''
         INITIALIZE l_oha.* TO NULL #FUN-C80051 Add
         INITIALIZE l_ohb.* TO NULL #FUN-C80051 Add
         CONTINUE FOREACH
      END IF
   
      IF g_success = 'Y' AND l_sucflag > 0 THEN       
        #FUN-CC0082 Mark&Add Begin ---
        #CALL p200_xyz_ins(p_gat01,p_azw01,l_saleno,l_oha.oha01,l_oha.ohauser)      #更新上傳交款明細/交款匯總/刷卡明細檔
         CALL p200_xyz_ins(p_gat01,p_azw01,l_saleno,l_oha.oha01,l_oha.ohauser,'')      #更新上傳交款明細/交款匯總/刷卡明細檔
        #FUN-CC0082 Mark&Add End -----
         IF g_success = 'N' THEN 
            INITIALIZE l_oha.* TO NULL #FUN-C80051 Add
            INITIALIZE l_ohb.* TO NULL #FUN-C80051 Add
            CONTINUE FOREACH 
         END IF
         CALL p200_sub_oha_confirm(l_oha.oha01,p_azw01,l_saleno)      #確認
         IF g_success = 'Y' AND g_azw.azw04 = '2' THEN
            CALL t620sub1_post('2',l_oha.oha01)                       #經營方式處理
            IF g_success = 'N' THEN
               #經營方式報錯處理
               ROLLBACK WORK
               FOR l_i = 1 TO g_err_msg.getLength()
                  LET g_msg1 = 'TD_SALE'||'INS'||p_azw01||g_fno1
                  LET g_msg1 = g_err_msg[l_i].fld1||g_err_msg[l_i].fld2||g_err_msg[l_i].fld3
                  LET g_errno = g_err_msg[l_i].fld4
                  CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
                  CALL p200_log(g_trans_no,p_azw01,g_fno1,'02','TD_SALE',g_errno,g_msg,'0','N',g_msg1)
               END FOR
               INITIALIZE l_oha.* TO NULL #FUN-C80051 Add
               INITIALIZE l_ohb.* TO NULL #FUN-C80051 Add
               CONTINUE FOREACH
            END IF
         END IF
      END IF

      IF g_success='Y' THEN
         CALL p200_upd_posflag("td_sale",p_azw01,l_saleno,l_oha.oha01)  #回填標誌欄位
         IF g_success = 'N' THEN
            INITIALIZE l_oha.* TO NULL #FUN-C80051 Add
            INITIALIZE l_ohb.* TO NULL #FUN-C80051 Add
            CONTINUE FOREACH
         END IF
      END IF

      IF g_success ='Y' AND l_sucflag > 0 THEN
         LET g_sucflag=1
         COMMIT WORK
      ELSE
         ROLLBACK WORK
        #FUN-C80045 Mark Begin ---
        #CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
        #LET g_msg = g_msg[1,255]
        #CALL p200_log(g_trans_no,p_azw01,l_saleno,'02','TD_SALE|TD_SALE_DETAIL',g_errno,g_msg,'0','N','')
        #LET g_errno = ''
        #LET g_msg   = ''
        #FUN-C80045 Mark End -----
         INITIALIZE l_oha.* TO NULL #FUN-C80051 Add
         INITIALIZE l_ohb.* TO NULL #FUN-C80051 Add
         CONTINUE FOREACH
      END IF
      INITIALIZE l_oha.* TO NULL #FUN-C80051 Add
      INITIALIZE l_ohb.* TO NULL #FUN-C80051 Add                      
   END FOREACH 
END FUNCTION   
               
FUNCTION p200_rxa_ins(p_gat01,p_azw01)       
DEFINE l_sql      STRING
DEFINE p_azw01    LIKE azw_file.azw01
DEFINE l_azw02    LIKE azw_file.azw02
DEFINE p_gat01    LIKE gat_file.gat01
DEFINE l_rxa      RECORD LIKE  rxa_file.* 
DEFINE l_upd      STRING
DEFINE l_saleno   LIKE oga_file.oga16
DEFINE l_check    LIKE type_file.chr1
               
   IF NOT cl_null(g_saleno) THEN
      LET g_wc = " saleno = '",g_saleno,"' "
   ELSE
     #CALL p200_g_wc() RETURNING g_wc           #FUN-CA0160 Mark
      CALL p200_g_wc("rxa_file") RETURNING g_wc #FUN-CA0160 Add
   END IF
   IF cl_null(g_wc) THEN LET g_wc = " 1=1" END IF
         
   SELECT azw02 INTO l_azw02
     FROM azw_file WHERE azw01 = p_azw01
   INITIALIZE l_rxa.* TO NULL
         
   LET l_sql = " SELECT DISTINCT ",
               " '',",                                            #rxa01    退回單號
               " CAST(bdate AS DATE),",                           #rx09     單據日期 #FUN-D30097 add 
               " ofno,",                                          #rxa02    訂單單號
               " '',",                                            #rxa03    客戶代碼
               " 0 ,",                                            #rxa04    已冲金額
               " 0 ,",                                            #rxa05    已退金額
               " tot_AMT,",                                       #rxa06    可退金額
               " memo,",                                          #rxa07    備注
               " '1',",                                           #rxa900   狀況碼
               " 'Y',",                                           #rxaacti  資料有效碼
               " CAST(sdate AS DATE),",                           #rxacond  審核日期    
               " opno,",                                          #rxaconu  審核人員
               " CAST(sdate AS DATE),",                           #rxacrat  資料創建日
               " CAST(sdate AS DATE),",                           #rxadate  最近修改日
               " 0,",                                             #rxadays  簽核完成天數
               " '',",                                            #rxagrup  資料所有部門
               " '",l_azw02,"',",                                 #rxalegal 所屬法人
               " 'N',",                                           #rxamksg  是否簽核
               " '',",                                            #rxamodu  資料修改者
               " shop,",                                          #rxaplant 所屬營運中心
               " '0',",                                           #rxaprit  簽核優先等級
               " '0',",                                           #rxasign  簽核等級    
               " '0',",                                           #rxasmax  應簽核順序  
               " '0',",                                           #rxasseq  已簽核順序  
               " '',",                                            #rxauser  資料所有者  
               " 'Y',",                                           #rxaconf  審核碼      
               " stime[1,2]||':'||stime[3,4]||':'||stime[5,6], ", #rxacont  審核時間    
               " opno, ",                                         #rxaoriu  資料建立者  
               " '', ",                                           #rxaorig  資料建立部門
               " saleno, ",                                       #rxa08    POS單號  #FUN-D10144 Add ,
               " CAST(Bdate AS DATE) ",                           #g_ndate  自動編號 #FUN-D10144 Add
               " FROM ",g_posdbs,"td_sale",g_db_links," ",
               " WHERE shop = '",p_azw01,"' AND type = '4' ",
              #" AND condition2 = 'A' AND cnfflg = 'Y' AND ",g_wc," ",  #FUN-CB0103 Mark
               " AND condition2 <> 'Y' AND cnfflg = 'Y' AND ",g_wc," ", #FUN-CB0103 Add
               " ORDER BY saleno "

 
   PREPARE sel_salehead_rxa_pre FROM l_sql
   DECLARE sel_salehead_rxa_curs CURSOR WITH HOLD FOR sel_salehead_rxa_pre
   FOREACH sel_salehead_rxa_curs INTO 
               l_rxa.rxa01,                #退回單號                     
               l_rxa.rxa09,                #單據日期 #FUN-D30097 add                     
               l_rxa.rxa02,                #訂單單號 
               l_rxa.rxa03,                #客戶代碼 
               l_rxa.rxa04,                #已冲金額
               l_rxa.rxa05,                #已退金額 
               l_rxa.rxa06,                #可退金額 
               l_rxa.rxa07,                #備注     
               l_rxa.rxa900,               #狀況碼   
               l_rxa.rxaacti,              #資料有效碼  
               l_rxa.rxacond,              #審核日期    
               l_rxa.rxaconu,              #審核人員    
               l_rxa.rxacrat,              #資料創建日  
               l_rxa.rxadate,              #最近修改日  
               l_rxa.rxadays,              #簽核完成天數
               l_rxa.rxagrup,              #資料所有部門
               l_rxa.rxalegal,             #所屬法人    
               l_rxa.rxamksg,              #是否簽核    
               l_rxa.rxamodu,              #資料修改者  
               l_rxa.rxaplant,             #所屬營運中心   
               l_rxa.rxaprit,              #簽核優先等級
               l_rxa.rxasign,              #簽核等級    
               l_rxa.rxasmax,              #應簽核順序  
               l_rxa.rxasseq,              #已簽核順序  
               l_rxa.rxauser,              #資料所有者  
               l_rxa.rxaconf,              #審核碼      
               l_rxa.rxacont,              #審核時間    
               l_rxa.rxaoriu,              #資料建立者  
               l_rxa.rxaorig,              #資料建立部門
               l_rxa.rxa08,                #POS單號    #FUN-D10144 Add ,
               g_ndate                     #自動編號   #FUN-D10144 Add
      LET g_success = 'Y' #成功標誌初始化
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno = SQLCA.sqlcode 
         LET g_showmsg = 'SEL TD_SALE'||' '||'SHOP:'||p_azw01||' '||'SALENO:'||l_rxa.rxa08
         CALL s_errmsg('rxa08',l_rxa.rxa08,g_showmsg,SQLCA.sqlcode,1)
         LET g_msg1 = 'TD_SALE'||'SEL'||p_azw01||l_rxa.rxa08
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,l_rxa.rxa08,'03','TD_SALE',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         LET g_showmsg = ''
         INITIALIZE l_rxa.* TO NULL #FUN-C80051 Add
         CONTINUE FOREACH
      END IF
      ##--訂單單號欄位不為空,即此銷售單乃訂單拋磚過來,--#
      ##--須檢查對應訂單是否已上傳,若未上傳則先上傳訂單相關數據--#
      IF NOT cl_null(l_rxa.rxa02) THEN   
         IF NOT p200_check_oga16(p_azw01,l_rxa.rxa02) THEN
            LET g_saleno = l_rxa.rxa02
            CALL p200_oea_ins("oea_file",p_azw01)
            IF NOT p200_check_oga16(p_azw01,l_rxa.rxa02) THEN
               INITIALIZE l_rxa.* TO NULL #FUN-C80051 Add
               LET g_saleno = '' #FUN-C90065 Add
               CONTINUE FOREACH
            END IF
            LET g_saleno = ''
         END IF
      END IF
      IF g_success ='N' THEN
         INITIALIZE l_rxa.* TO NULL #FUN-C80051 Add
         CONTINUE FOREACH
      END IF

      CALL p200_log_check(p_azw01,l_rxa.rxa08) 

      BEGIN WORK 

      IF g_bgjob = "N" THEN
         MESSAGE "rxa_file  SHOP:",p_azw01,"  SALENO:",l_rxa.rxa08,"  BEGIN:",TIME(CURRENT)
         CALL ui.Interface.refresh()
      END IF
      LET l_sucflag = 0
      LET l_saleno  = l_rxa.rxa08
      LET g_fno1    = l_rxa.rxa08
     #LET g_ndate   = l_rxa.rxacond #FUN-D10144 Mark

     #CALL p200_auto_doc(p_gat01,p_azw01) RETURNING l_rxa.rxa01       #FUN-CC0082 Mark
      CALL p200_auto_doc(p_gat01,p_azw01,'Y') RETURNING l_rxa.rxa01   #FUN-CC0082 Add
      IF g_success ='N' THEN      
         INITIALIZE l_rxa.* TO NULL #FUN-C80051 Add
         CONTINUE FOREACH
      END IF
      
      #FUN-CB0103 Add Begin ---
      #更新中间库订单结案码
      IF g_success = 'Y' THEN
         LET l_upd = "UPDATE ",g_posdbs,"td_sale",g_db_links," ",
                     "   SET ecsflg  = 'Y', ",
                     "       ecsdate = '",l_rxa.rxacond USING 'YYYYMMDD',"' ",
                     " WHERE Shop = '",p_azw01,"' ",
                     "   AND Saleno = '",l_rxa.rxa02 CLIPPED,"' "
         PREPARE upd_ecsflg_rxa_pre FROM l_upd
         EXECUTE upd_ecsflg_rxa_pre
         IF SQLCA.sqlcode THEN
            LET g_success = 'N'
            LET g_errno = SQLCA.sqlcode
            LET g_showmsg = 'UPD td_Sale'||' '||'SHOP:'||p_azw01||' '||'SALENO:'||g_fno1
            CALL s_errmsg('rxa08',l_rxa.rxa08,g_showmsg,SQLCA.sqlcode,1)
            LET g_msg1 = 'oeb_file'||'UPD'||p_azw01||g_fno1
            ROLLBACK WORK
            CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
            LET g_msg = g_msg[1,255]
            CALL p200_log(g_trans_no,p_azw01,g_fno1,'03','TD_SALE',g_errno,g_msg,'0','N',g_msg1)
            LET g_errno = ''
            LET g_msg   = ''
            LET g_msg1  = ''
            LET g_showmsg = ''
            INITIALIZE l_rxa.* TO NULL
            CONTINUE FOREACH
         END IF
      END IF
      #FUN-CB0103 Add End -----

      #订单单号取ERP生成的订单单号
      LET l_sql = "SELECT oea01,oea03 FROM ",cl_get_target_table(p_azw01,'oea_file'),
                  " WHERE oea94 = '",l_rxa.rxa02 ,"' "
      CALL cl_replace_sqldb(l_sql) RETURNING l_sql
      CALL cl_parse_qry_sql(l_sql,p_azw01) RETURNING l_sql
      PREPARE sel_oea_rxa_pre FROM l_sql  
      EXECUTE sel_oea_rxa_pre INTO l_rxa.rxa02,l_rxa.rxa03

      LET l_sql = "SELECT ryi02 FROM ",cl_get_target_table(p_azw01,'ryi_file'),
                  " WHERE ryi01 = '",l_rxa.rxaconu,"' "
      CALL cl_replace_sqldb(l_sql) RETURNING l_sql 
      CALL cl_parse_qry_sql(l_sql,p_azw01) RETURNING l_sql
      PREPARE sel_ryi_rxa_pre FROM l_sql
      EXECUTE sel_ryi_rxa_pre INTO l_rxa.rxaconu
      LET l_rxa.rxauser = l_rxa.rxaconu
      LET l_rxa.rxaoriu = l_rxa.rxaconu
      
      LET l_sql = "SELECT gen03 FROM ",cl_get_target_table(p_azw01,'gen_file'),
                  " WHERE gen01 = '",l_rxa.rxaconu,"' "
      CALL cl_replace_sqldb(l_sql) RETURNING l_sql
      CALL cl_parse_qry_sql(l_sql,p_azw01) RETURNING l_sql
      PREPARE sel_gen03_rxa_pre FROM l_sql  
      EXECUTE sel_gen03_rxa_pre INTO l_rxa.rxagrup
      
      LET l_rxa.rxaorig = l_rxa.rxagrup
      
      LET l_sql = " INSERT INTO ",cl_get_target_table(p_azw01,'rxa_file'),"(",
                  "        rxa01,rxa02,rxa03,rxa04,rxa05, ",
                  "        rxa06,rxa07,rxa900,rxaacti,rxacond, ",
                  "        rxaconu,rxacrat,rxadate,rxadays,rxagrup, ",
                  "        rxalegal,rxamksg,rxamodu,rxaplant,rxaprit, ",
                  "        rxasign,rxasmax,rxasseq,rxauser,rxaconf, ",
                  "        rxacont,rxaoriu,rxaorig,rxa08) ",
                  " VALUES(?,?,?,?,?,   ?,?,?,?,?, ",
                  "        ?,?,?,?,?,   ?,?,?,?,?, ",
                  "        ?,?,?,?,?,   ?,?,?,?) "
      CALL cl_replace_sqldb(l_sql) RETURNING l_sql
      CALL cl_parse_qry_sql(l_sql,p_azw01) RETURNING l_sql
      PREPARE ins_rxa_pre FROM l_sql
      EXECUTE ins_rxa_pre USING 
                  l_rxa.rxa01,l_rxa.rxa02,l_rxa.rxa03,l_rxa.rxa04,l_rxa.rxa05,
                  l_rxa.rxa06,l_rxa.rxa07,l_rxa.rxa900,l_rxa.rxaacti,l_rxa.rxacond,
                  l_rxa.rxaconu,l_rxa.rxacrat,l_rxa.rxadate,l_rxa.rxadays,l_rxa.rxagrup,
                  l_rxa.rxalegal,l_rxa.rxamksg,l_rxa.rxamodu,l_rxa.rxaplant,l_rxa.rxaprit,
                  l_rxa.rxasign,l_rxa.rxasmax,l_rxa.rxasseq,l_rxa.rxauser,l_rxa.rxaconf,
                  l_rxa.rxacont,l_rxa.rxaoriu,l_rxa.rxaorig,l_rxa.rxa08 
                  
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno = SQLCA.sqlcode 
         LET g_showmsg = 'INS rxa_file'||' '||'SHOP:'||p_azw01||' '||'SALENO:'||g_fno1
         CALL s_errmsg('rxa01',l_rxa.rxa01,g_showmsg,SQLCA.sqlcode,1)
         LET g_msg1 = 'rxa_file'||'INS'||p_azw01||g_fno1
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,g_fno1,'03','TD_SALE',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         LET g_showmsg = ''
         INITIALIZE l_rxa.* TO NULL #FUN-C80051 Add
         CONTINUE FOREACH
      END IF

     #FUN-CB0103 Add Begin ---
      IF SQLCA.sqlerrd[3] > 0 AND l_sucflag = 0 THEN
         LET l_sucflag = SQLCA.sqlerrd[3]
      END IF
      IF SQLCA.sqlerrd[3] = 0 THEN
         ROLLBACK WORK
         INITIALIZE l_rxa.* TO NULL #FUN-C80051 Add
         CONTINUE FOREACH
      END IF
     #FUN-CB0103 Add End -----

     #FUN-CB0103 Mod Begin ---
      #更新訂單單身
      IF g_success = 'Y' THEN
         LET l_upd = "UPDATE ",cl_get_target_table(p_azw01,'oeb_file'),
                     "   SET oeb70 = 'Y' ",
                     "      ,oeb70d = '",l_rxa.rxacond,"' ",   #FUN-CB0103 Add
                     "      ,oeb26  = oeb12 - oeb24 + oeb25 ", #FUN-CB0103 Add
                     " WHERE oeb01 = '",l_rxa.rxa02,"' "
         CALL cl_replace_sqldb(l_upd) RETURNING l_upd
         CALL cl_parse_qry_sql(l_upd,p_azw01) RETURNING l_upd 
         PREPARE upd_oeb_pre FROM l_upd
         EXECUTE upd_oeb_pre
         IF SQLCA.sqlcode THEN
            LET g_success = 'N'
            LET g_errno = SQLCA.sqlcode 
            LET g_showmsg = 'UPD oeb_file'||' '||'SHOP:'||p_azw01||' '||'SALENO:'||g_fno1
            CALL s_errmsg('oeb01',l_rxa.rxa02,g_showmsg,SQLCA.sqlcode,1)
            LET g_msg1 = 'oeb_file'||'UPD'||p_azw01||g_fno1
            ROLLBACK WORK
            CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
            LET g_msg = g_msg[1,255]
            CALL p200_log(g_trans_no,p_azw01,g_fno1,'03','TD_SALE',g_errno,g_msg,'0','N',g_msg1)
            LET g_errno = ''
            LET g_msg   = ''
            LET g_msg1  = ''
            LET g_showmsg = ''
            INITIALIZE l_rxa.* TO NULL #FUN-C80051 Add
            CONTINUE FOREACH
         END IF
      END IF
      #更新訂單單頭
      IF g_success = 'Y' THEN
         LET l_upd = "UPDATE ",cl_get_target_table(p_azw01,'oea_file'),
                     "   SET oea49 = '2' ",
                     "      ,oea63 = (SELECT SUM(oeb14/oeb12*oeb26) FROM ",cl_get_target_table(p_azw01,'oeb_file'), #FUN-CB0103 Add
                     "                 WHERE oeb01 = '",l_rxa.rxa02,"') ",                                          #FUN-CB0103 Add
                     " WHERE oea01 = '",l_rxa.rxa02,"' "
         CALL cl_replace_sqldb(l_upd) RETURNING l_upd 
         CALL cl_parse_qry_sql(l_upd,p_azw01) RETURNING l_upd 
         PREPARE upd_oea_pre FROM l_upd
         EXECUTE upd_oea_pre
         IF SQLCA.sqlcode  OR SQLCA.sqlerrd[3] = 0 THEN
            LET g_success  = 'N'
            LET g_errno = SQLCA.sqlcode 
            LET g_showmsg = 'UPD oea_file'||' '||'SHOP:'||p_azw01||' '||'SALENO:'||g_fno1
            CALL s_errmsg('oea01',l_rxa.rxa02,g_showmsg,SQLCA.sqlcode,1)
            LET g_msg1 = 'oea_file'||'UPD'||p_azw01||g_fno1
            ROLLBACK WORK
            CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
            LET g_msg = g_msg[1,255]
            CALL p200_log(g_trans_no,p_azw01,g_fno1,'03','TD_SALE',g_errno,g_msg,'0','N',g_msg1)
            LET g_errno = ''
            LET g_msg   = ''
            LET g_msg1  = ''
            LET g_showmsg = ''
            INITIALIZE l_rxa.* TO NULL #FUN-C80051 Add
            CONTINUE FOREACH
         END IF
      END IF
     #FUN-CB0103 Mod End -----

     #FUN-CB0103 Mark Begin ---
     #IF SQLCA.sqlerrd[3] > 0 AND l_sucflag = 0 THEN
     #   LET l_sucflag = SQLCA.sqlerrd[3]
     #END IF
     #IF SQLCA.sqlerrd[3] = 0 THEN
     #   ROLLBACK WORK
     #   INITIALIZE l_rxa.* TO NULL #FUN-C80051 Add
     #   CONTINUE FOREACH
     #END IF
     #FUN-CB0103 Mark End -----
      IF g_success = 'Y' AND l_sucflag > 0 THEN
        #更新上傳交款明細/交款匯總/刷卡明細檔
        #FUN-CC0082 Mark&Add Begin ---
        #CALL p200_xyz_ins("rxa_file",p_azw01,l_saleno,l_rxa.rxa01,l_rxa.rxauser)  #更新上傳交款明細/交款匯總/刷卡明細檔
         CALL p200_xyz_ins("rxa_file",p_azw01,l_saleno,l_rxa.rxa01,l_rxa.rxauser,'')  #更新上傳交款明細/交款匯總/刷卡明細檔
        #FUN-CC0082 Mark&Add End -----
         IF g_success = 'N' THEN
            INITIALIZE l_rxa.* TO NULL #FUN-C80051 Add
            CONTINUE FOREACH
         END IF
         IF g_success = 'Y' THEN
            CALL p200_upd_posflag("td_sale",p_azw01,l_rxa.rxa08,l_rxa.rxa01)  #回填標誌欄位 
            IF g_success = 'N' THEN 
               INITIALIZE l_rxa.* TO NULL #FUN-C80051 Add
               CONTINUE FOREACH 
            END IF
         END IF
      END IF

      IF g_success = 'Y' AND l_sucflag > 0 THEN
         LET g_sucflag=1      
         COMMIT WORK 
      ELSE 
         ROLLBACK WORK
        #FUN-C80045 Mark Begin ---
        #CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
        #LET g_msg = g_msg[1,255]
        #CALL p200_log(g_trans_no,p_azw01,l_saleno,'03','TD_SALE|TD_SALE_DETAIL',g_errno,g_msg,'0','N','')
        #LET g_errno = ''
        #LET g_msg   = ''
        #FUN-C80045 Mark End -----
         INITIALIZE l_rxa.* TO NULL #FUN-C80051 Add
         CONTINUE FOREACH
      END IF
      INITIALIZE l_rxa.* TO NULL #FUN-C80051 Add
   END FOREACH
  
END FUNCTION

FUNCTION p200_ome_ins(p_gat01,p_azw01)
DEFINE p_gat01   LIKE gat_file.gat01
DEFINE p_azw01   LIKE azw_file.azw01
DEFINE l_ome     RECORD LIKE ome_file.*
DEFINE l_cnt     LIKE type_file.num5
DEFINE l_oom09   LIKE oom_file.oom09

   IF NOT cl_null(g_saleno) THEN
      LET g_wc = " saleno = '",g_saleno,"' "
   ELSE
     #CALL p200_g_wc() RETURNING g_wc           #FUN-CA0160 Mark
      CALL p200_g_wc("ome_file") RETURNING g_wc #FUN-CA0160 Add
   END IF
   IF cl_null(g_wc) THEN LET g_wc = " 1=1" END IF
   
   LET g_sql = " SELECT DISTINCT ",         
               " invstartno, ",                          #ome01   發票號碼
               " invendno, ",                            #ome011  發票截止號碼
               " CAST(bdate AS DATE), ",                 #ome02   發票日期
               " buyerguino, ",                          #ome042  發票客戶統一編號
               " '1', ",                                 #ome08   1.內銷 2.外銷
               " invformat, ",                           #ome171  格式
               " taxationtype, ",                        #ome172  課稅別
               " invtype, ",                             #ome212  聯數
               " invuamt, ",                             #ome59   本幣發票未稅金額
               " invamt, ",                              #ome59t  本幣發票含稅金額
               " invtax, ",                              #ome59x  本幣發票稅額
               " 'Y', ",                                 #ome70   POS開立否
               " machine, ",                             #ome71   POS機號
               " saleno, ",                              #ome72   POS單號
               " shop, ",                                #ome73   營運中心編號
               " gftinvamt, ",                           #ome74   禮券已開發票金額
               " gftinvtax, ",                           #ome75   禮券已開發票稅額
               " accumtax, ",                            #ome76   已開發票留抵稅額
               " taxableamt, ",                          #ome78   應稅金額
               " zerotax, ",                             #ome79   零稅金額
               " dutyfreeamt, ",                         #ome80   免稅金額
               " '1', ",                                 #ome81   電子發票匯出狀態 1.未匯出過,2.已匯出過
               " CAST(sdate AS DATE), ",                 #omedate 資料輸入日
               " '",g_grup,"', ",                        #omegrup 資料所有部門
               " '",g_grup,"', ",                        #omeorig 資料建立部門
               " '",g_user,"', ",                        #omeoriu 資料建立者
               " '",g_user,"'  ",                        #omeuser 資料所有者
               " FROM ",g_posdbs,"td_invoicedetail",g_db_links," ",
              #" WHERE shop = '",p_azw01,"' AND condition2 = 'A' ",   #FUN-CB0103 Mark
               " WHERE shop = '",p_azw01,"' AND condition2 <> 'Y' ",  #FUN-CB0103 Add
               " AND ",g_wc CLIPPED,
               " ORDER BY invendno,CAST(bdate AS DATE),taxationtype desc "
   PREPARE sel_td_invoicedetail_ome_pre FROM g_sql
   DECLARE sel_td_invoicedetail_ome_curs CURSOR WITH HOLD FOR sel_td_invoicedetail_ome_pre
   FOREACH sel_td_invoicedetail_ome_curs INTO 
               l_ome.ome01,                              #發票號碼        
               l_ome.ome011,                             #發票截止號碼    
               l_ome.ome02,                              #發票日期        
               l_ome.ome042,                             #發票客戶統一編號
               l_ome.ome08,                              #1.內銷 2.外銷   
               l_ome.ome171,                             #格式            
               l_ome.ome172,                             #課稅別          
               l_ome.ome212,                             #聯數            
               l_ome.ome59,                              #本幣發票未稅金額
               l_ome.ome59t,                             #本幣發票含稅金額
               l_ome.ome59x,                             #本幣發票稅額    
               l_ome.ome70,                              #POS開立否       
               l_ome.ome71,                              #POS機號         
               l_ome.ome72,                              #POS單號         
               l_ome.ome73,                              #營運中心編號    
               l_ome.ome74,                              #禮券已開發票金額
               l_ome.ome75,                              #禮券已開發票稅額
               l_ome.ome76,                              #已開發票留抵稅額
               l_ome.ome78,                              #應稅金額        
               l_ome.ome79,                              #零稅金額        
               l_ome.ome80,                              #免稅金額        
               l_ome.ome81,                              #電子發票匯出狀態 1.未匯出過,2.已匯出過
               l_ome.omedate,                            #資料輸入日      
               l_ome.omegrup,                            #資料所有部門    
               l_ome.omeorig,                            #資料建立部門    
               l_ome.omeoriu,                            #資料建立者      
               l_ome.omeuser                             #資料所有者      

      LET g_success = 'Y' #成功標誌初始化
      IF SQLCA.sqlcode THEN
         LET g_success='N'
         LET g_errno = SQLCA.sqlcode                                
         LET g_showmsg = 'SEL TD_INVOICEDETAIL'||' '||'SHOP:'||p_azw01||' '||'SALENO:'||l_ome.ome72
         CALL s_errmsg('ome72',l_ome.ome72,g_showmsg,SQLCA.sqlcode,1)
         LET g_msg1='TD_INVOICEDETAIL'||'SEL'||p_azw01||l_ome.ome72 
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg             
         LET g_msg=g_msg[1,255]                                     
         CALL p200_log(g_trans_no,p_azw01,l_ome.ome72,'04','TD_INVOICEDETAIL',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno=''
         LET g_msg=''
         LET g_msg1=''
         LET g_showmsg = ''                                         
         INITIALIZE l_ome.* TO NULL #FUN-C80051 Add
         CONTINUE FOREACH
      END IF 
      
      BEGIN WORK 
      
      IF g_bgjob = 'N' THEN
         MESSAGE "ome_file  SHOP:",p_azw01,"  SALENO:",l_ome.ome72,"  BEGIN:",TIME(CURRENT)
         CALL ui.Interface.refresh()
      END IF 
      
      LET l_sucflag = 0
      LET g_fno1    = l_ome.ome72
      
      #若發票是銷售發票或作廢的發票時,ome00欄位請填 '1';若是折讓的發票,ome00欄位請填 '4'
     #IF (l_ome.ome59t < 0) AND (l_ome.ome172 <> 'F') THEN	#FUN-C80080 Mark
      IF l_ome.ome171 = '33' OR l_ome.ome171 = '34' THEN        #FUN-C80080 Add
          LET l_ome.ome00 = '4'	#銷項發票(折讓)
      ELSE	
          LET l_ome.ome00 = '1'	#銷項發票
      END IF 
      
      LET g_sql = "SELECT oom03,oom13 FROM ",cl_get_target_table(p_azw01,'oom_file'),
                  " WHERE oom07 <= '",l_ome.ome01,"' ",
                  "   AND oom08 >= '",l_ome.ome01,"' "
      CALL cl_replace_sqldb(g_sql) RETURNING g_sql
      CALL cl_parse_qry_sql(g_sql,p_azw01) RETURNING g_sql
      PREPARE sel_oom_ome_pre FROM g_sql
      EXECUTE sel_oom_ome_pre INTO l_ome.ome05,l_ome.ome60
      
      LET g_sql = "SELECT oom06 FROM ",cl_get_target_table(p_azw01,'oom_file'),
                  " WHERE oom07 <= '",l_ome.ome011,"' ",
                  "   AND oom08 >= '",l_ome.ome011,"' "
      CALL cl_replace_sqldb(g_sql) RETURNING g_sql
      CALL cl_parse_qry_sql(g_sql,p_azw01) RETURNING g_sql
      PREPARE sel_oom06_ome_pre FROM g_sql
      EXECUTE sel_oom06_ome_pre INTO l_ome.ome77
      
      LET l_ome.omelegal = l_legal
      
      IF l_ome.ome172 = 'F' THEN
         LET l_ome.omevoid  = 'Y'
         LET l_ome.omevoidd = l_ome.ome02
      ELSE
      	 LET l_ome.omevoid  = 'N'
      	 LET l_ome.omevoidd = NULL
      END IF

      IF cl_null(l_ome.ome03) THEN LET l_ome.ome03 = ' ' END IF     #發票代碼
      IF cl_null(l_ome.ome22) THEN LET l_ome.ome22 = 'N' END IF     #電子發票否
      IF cl_null(l_ome.omecncl) THEN LET l_ome.omecncl = 'N' END IF #註銷否

     #IF l_ome.ome172 <> 'F' OR cl_null(l_ome.ome172) THEN                                                       #FUN-C80080 Mark
     #Note:非作廢(ome172<>'F'或者ome172為空)非折讓(ome171<>'33' AND ome171<>'34')才走Ins邏輯                     #FUN-C80080 Add
      IF (l_ome.ome172 <> 'F' OR cl_null(l_ome.ome172)) AND (l_ome.ome171 <> '33' AND l_ome.ome171 <> '34') THEN #FUN-C80080 Add
         #ins
         LET l_cnt = 0
         IF l_ome.ome59t > 0 THEN
            LET g_sql = "SELECT COUNT(*) FROM ",cl_get_target_table(p_azw01,'ome_file'),
                        " WHERE ome01 = '",l_ome.ome01,"' ",
                        "   AND ome70 = 'Y' "
         ELSE
            LET g_sql = "SELECT COUNt(*) FROM ",cl_get_target_table(p_azw01,'ome_file'),
                        " WHERE ome01 = '",l_ome.ome01,"' ",
                        "   AND ome70 = 'Y' ",
                        "   AND ome59t < 0 "
         END IF
         CALL cl_replace_sqldb(g_sql) RETURNING g_sql
         CALL cl_parse_qry_sql(g_sql,p_azw01) RETURNING g_sql
         PREPARE sel_count_ome_pre FROM g_sql
         EXECUTE sel_count_ome_pre INTO l_cnt
         IF l_cnt > 0 THEN 
            LET g_success = 'N'
            LET g_errno = '-239'  #資料重複
            LET g_showmsg = 'SEL ome_file'||' '||'SHOP:'||p_azw01||' '||'SALENO:'||l_ome.ome72
            CALL s_errmsg('ome01',l_ome.ome01,g_showmsg,g_errno,1) 
            ROLLBACK WORK 
            LET g_msg1 = 'ome_file'||'SEL'||p_azw01||l_ome.ome72
            CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
            LET g_msg = g_msg[1,255]
            CALL p200_log(g_trans_no,p_azw01,l_ome.ome72,'04','TD_INVOICEDETAIL',g_errno,g_msg,'0','N',g_msg1)
            LET g_errno = ''
            LET g_msg = ''
            LET g_msg1 = ''
            LET g_showmsg = ''
            INITIALIZE l_ome.* TO NULL #FUN-C80051 Add
            CONTINUE FOREACH 
         END IF 
         #抓取系統時間
         LET g_sql = "SELECT stime[1,2]||':'||stime[3,4]||':'||stime[5,6] ",
                     "  FROM ",g_posdbs,"td_sale",g_db_links," ",
                     " WHERE shop = '",p_azw01,"' AND saleno = '",l_ome.ome72,"' "
         CALL cl_replace_sqldb(g_sql) RETURNING g_sql
         CALL cl_parse_qry_sql(g_sql,p_azw01) RETURNING g_sql
         PREPARE sel_stime_ome_pre FROM g_sql
         EXECUTE sel_stime_ome_pre INTO l_ome.ome82
         LET g_sql = " INSERT INTO ",cl_get_target_table(p_azw01,'ome_file'),"(",
                     "        ome00,ome01,ome011,ome02,ome04, ",
                     "        ome042,ome043,ome044,ome05,ome08, ",
                     "        ome16,ome17,ome171,ome172,ome173, ",
                     "        ome174,ome175,ome21,ome211,ome212, ",
                     "        ome213,ome32,ome33,ome34,ome35, ",
                     "        ome38,ome39,ome59,ome59t,ome59x, ",
                     "        ome60,ome70,ome71,ome72,ome73, ",
                     "        ome74,ome75,ome76,ome77,ome78, ",
                     "        ome79,ome80,omedate,omegrup,omelegal, ",
                     "        omemodd,omemodu,omeorig,omeoriu,omeprsw, ",
                     "        omeuser,omevoid,omevoid2,omevoidd,omevoidu, ",
                     "        ome03,ome22,omecncl,ome81,ome82) ",      #FUN-C80080 Add ome81,ome82
                     " VALUES(?,?,?,?,?,   ?,?,?,?,?, ",
                     "        ?,?,?,?,?,   ?,?,?,?,?, ",
                     "        ?,?,?,?,?,   ?,?,?,?,?, ",
                     "        ?,?,?,?,?,   ?,?,?,?,?, ",
                     "        ?,?,?,?,?,   ?,?,?,?,?, ",
                     "        ?,?,?,?,?,   ?,?,?,?,?) "                #FUN-C80080 Add ,?,?
         CALL cl_replace_sqldb(g_sql) RETURNING g_sql
         CALL cl_parse_qry_sql(g_sql,p_azw01) RETURNING g_sql
         PREPARE ins_ome_pre FROM g_sql
         EXECUTE ins_ome_pre USING
                     l_ome.ome00,l_ome.ome01,l_ome.ome011,l_ome.ome02,l_ome.ome04,
                     l_ome.ome042,l_ome.ome043,l_ome.ome044,l_ome.ome05,l_ome.ome08,
                     l_ome.ome16,l_ome.ome17,l_ome.ome171,l_ome.ome172,l_ome.ome173,
                     l_ome.ome174,l_ome.ome175,l_ome.ome21,l_ome.ome211,l_ome.ome212,
                     l_ome.ome213,l_ome.ome32,l_ome.ome33,l_ome.ome34,l_ome.ome35,
                     l_ome.ome38,l_ome.ome39,l_ome.ome59,l_ome.ome59t,l_ome.ome59x,
                     l_ome.ome60,l_ome.ome70,l_ome.ome71,l_ome.ome72,l_ome.ome73,
                     l_ome.ome74,l_ome.ome75,l_ome.ome76,l_ome.ome77,l_ome.ome78,
                     l_ome.ome79,l_ome.ome80,l_ome.omedate,l_ome.omegrup,l_ome.omelegal,
                     l_ome.omemodd,l_ome.omemodu,l_ome.omeorig,l_ome.omeoriu,l_ome.omeprsw,
                     l_ome.omeuser,l_ome.omevoid,l_ome.omevoid2,l_ome.omevoidd,l_ome.omevoidu,
                     l_ome.ome03,l_ome.ome22,l_ome.omecncl,l_ome.ome81,l_ome.ome82 #FUN-C80080 Add ome81,ome82
         IF SQLCA.sqlcode OR SQLCA.sqlerrd[3] = 0 THEN 
            LET g_errno = SQLCA.sqlcode
            LET g_success = 'N'
            LET g_showmsg = 'INS ome_file'||' '||'SHOP:'||p_azw01||' '||'SALENO:'||l_ome.ome72
            CALL s_errmsg('ome01,ome011',l_ome.ome01||'/'||l_ome.ome011,g_showmsg,g_errno,1)
            ROLLBACK WORK
            LET g_msg1 = 'ome_file'||'INS'||p_azw01||l_ome.ome72
            CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
            LET g_msg = g_msg[1,255]
            CALL p200_log(g_trans_no,p_azw01,l_ome.ome72,'04','TD_INVOICEDETAIL',g_errno,g_msg,'0','N',g_msg1)
            LET g_errno = ''
            LET g_msg = ''
            LET g_msg1 = ''
            LET g_showmsg = ''
            INITIALIZE l_ome.* TO NULL #FUN-C80051 Add
            CONTINUE FOREACH 
         END IF 
      ELSE
      	 #upd
      	 LET g_sql = "UPDATE ",cl_get_target_table(p_azw01,'ome_file'),
      	             "   SET ome172 = '",l_ome.ome172,"', ",
                     "       ome00  = '",l_ome.ome00,"', ",     #FUN-C80080 Add
      	             "       omevoid = '",l_ome.omevoid,"' "    #FUN-C90065 Mod
      	            #"       omevoidd = '",l_ome.omevoidd,"' ", #FUN-C90065 Mark
      	            #" WHERE ome01 = '",l_ome.ome01,"' "        #FUN-C90065 Mark
        #FUN-C90065 Add Begin ---
         IF l_ome.omevoid = 'Y' THEN
            LET g_sql = g_sql ," , omevoidd = '",l_ome.omevoidd ,"' "
         END IF
         LET g_sql = g_sql , " WHERE ome01 = '",l_ome.ome01,"'"
        #FUN-C90065 Add End -----
      	 CALL cl_replace_sqldb(g_sql) RETURNING g_sql
         CALL cl_parse_qry_sql(g_sql,p_azw01) RETURNING g_sql
         PREPARE upd_ome_pre FROM g_sql
         EXECUTE upd_ome_pre
         IF SQLCA.sqlcode OR SQLCA.sqlerrd[3] = 0 THEN
            LET g_errno = SQLCA.sqlcode
            LET g_success = 'N'
            LET g_showmsg = 'UPD ome_file'||' '||'SHOP:'||p_azw01||' '||'SALENO:'||l_ome.ome72
            CALL s_errmsg('ome01,ome011',l_ome.ome01||'/'||l_ome.ome011,g_showmsg,g_errno,1)
            ROLLBACK WORK
            LET g_msg1 = 'ome_file'||'UPD'||p_azw01||l_ome.ome72
            CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
            LET g_msg = g_msg[1,255]
            CALL p200_log(g_trans_no,p_azw01,l_ome.ome72,'04','TD_INVOICEDETAIL',g_errno,g_msg,'0','N',g_msg1)
            LET g_errno = ''
            LET g_msg = ''
            LET g_msg1 = ''
            LET g_showmsg = ''
            INITIALIZE l_ome.* TO NULL #FUN-C80051 Add
            CONTINUE FOREACH 
         END IF
      END IF
    	
      IF g_success='Y' THEN
         CALL p200_upd_posflag("TD_INVOICEDETAIL",p_azw01,g_fno1,'')  #回填標誌欄位
         IF g_success = 'N' THEN 
            INITIALIZE l_ome.* TO NULL #FUN-C80051 Add
            CONTINUE FOREACH 
         END IF
      END IF 
      
      LET g_sql = "SELECT oom09 FROM ",cl_get_target_table(p_azw01,'oom_file'),
                  " WHERE oom07 <= '",l_ome.ome011,"' ",
                  "   AND oom08 >= '",l_ome.ome011,"' "
      CALL cl_replace_sqldb(g_sql) RETURNING g_sql
      CALL cl_parse_qry_sql(g_sql,p_azw01) RETURNING g_sql
      PREPARE sel_oom09_pre FROM g_sql
      EXECUTE sel_oom09_pre INTO l_oom09
      IF cl_null(l_oom09) OR (l_oom09 < l_ome.ome011) THEN
         LET g_sql = "UPDATE ",cl_get_target_table(p_azw01,'oom_file'),
                     "   SET oom09 = '",l_ome.ome011,"', ",
                     "       oom10 = '",l_ome.ome02,"' ",
                     " WHERE oom07 <= '",l_ome.ome011,"' ",
                     "   AND oom08 >= '",l_ome.ome011,"' ",
                     "   AND (oom09 < '",l_ome.ome011,"' OR oom09 IS NULL) "
         CALL cl_replace_sqldb(g_sql) RETURNING g_sql
         CALL cl_parse_qry_sql(g_sql,p_azw01) RETURNING g_sql
         PREPARE upd_oom_pre FROM g_sql
         EXECUTE upd_oom_pre
         IF SQLCA.sqlcode OR SQLCA.sqlerrd[3] = 0 THEN
            LET g_errno = SQLCA.sqlcode
            LET g_success = 'N'
            LET g_showmsg = 'UPD oom_file'||' '||'SHOP:'||p_azw01||' '||'SALENO:'||l_ome.ome72
            CALL s_errmsg('ome72',l_ome.ome72,g_showmsg,g_errno,1)
            ROLLBACK WORK
            LET g_msg1 = 'oom_file'||'UPD'||p_azw01||l_ome.ome72
            CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
            LET g_msg = g_msg[1,255]
            CALL p200_log(g_trans_no,p_azw01,l_ome.ome72,'04','TD_INVOICEDETAIL',g_errno,g_msg,'0','N',g_msg1)
            LET g_errno = ''
            LET g_msg = ''
            LET g_msg1 = ''
            LET g_showmsg = ''
            INITIALIZE l_ome.* TO NULL #FUN-C80051 Add
            CONTINUE FOREACH 
         END IF 
      END IF

      IF g_success ='Y' THEN
         COMMIT WORK 
      ELSE  
         ROLLBACK WORK
        #FUN-C80045 Mark Begin ---
        #CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
        #LET g_msg=g_msg[1,255]
        #CALL p200_log(g_trans_no,p_azw01,g_fno1,'04','TD_INVOICEDETAIL',g_errno,g_msg,'0','N','')
        #FUN-C80045 Mark End -----
         LET g_flag = 'Y'
         LET g_errno=''
         LET g_msg=''
         LET g_msg1=''   
      END IF 
      INITIALIZE l_ome.* TO NULL #FUN-C80051 Add
   END FOREACH
END FUNCTION

#FUNCTION p200_rxc_ins(p_gat01,p_azw01,p_saleno,p_item,p_doc_no,p_unit,p_date,p_prono)       #FUN-CC0082 Mark
FUNCTION p200_rxc_ins(p_gat01,p_azw01,p_saleno,p_item,p_doc_no,p_unit,p_date,p_prono,p_shop) #FUN-CC0082 Add
DEFINE p_gat01    LIKE gat_file.gat01
DEFINE p_rxc00    LIKE rxc_file.rxc00
DEFINE p_azw01    LIKE azw_file.azw01
DEFINE p_saleno   LIKE type_file.chr18
DEFINE p_item     LIKE ogb_file.ogb03
DEFINE p_doc_no   LIKE oga_file.oga01
DEFINE p_unit     LIKE ogb_file.ogb05
DEFINE p_date     LIKE oga_file.oga02
DEFINE p_prono    LIKE ogb_file.ogb04
DEFINE l_sql      STRING
DEFINE l_upd      STRING
DEFINE l_rxc      RECORD LIKE rxc_file.*
DEFINE l_count    LIKE type_file.num5
DEFINE l_ryl04    LIKE ryl_file.ryl04
DEFINE p_shop     LIKE oga_file.oga84

   LET g_time = TIME

   IF p_azw01 IS NULL THEN RETURN END IF
   LET l_sql = ''
   IF cl_null(p_shop) THEN LET p_shop = p_azw01 END IF #FUN-CC0082 Add

   IF g_psell_way = '2' THEN
      CASE p_gat01
         WHEN "oeb_file"          #訂單
            LET p_rxc00 = '01'
            LET l_ryl04 = '01'

         WHEN "ogb_file"          #銷售單
            LET p_rxc00 = '02'
            LET l_ryl04 = '02'

         WHEN "ohb_file"          #銷退單
            LET p_rxc00 = '03'
            LET l_ryl04 = '02'
      END CASE
   ELSE  #匯總
   END IF
   
   IF g_psell_way = '2' THEN  #明細
      LET l_sql = " SELECT DISTINCT ",
                  " '",p_rxc00,"',",                                           #rxc00    单据别:01-订单,02-销售单,03-销退單
                  " '",p_doc_no,"', ",                                         #rxc01    單號
                  " mitem, ",                                                  #rxc02    項次
                  " CASE dctype WHEN 7  THEN '01'  ",                          #rxc03    折價方式 - 01.一般促銷
                  "             WHEN 8  THEN '02'  ",                          #rxc03    折價方式 - 02.組合促銷
                  "             WHEN 9  THEN '03'  ",                          #rxc03    折價方式 - 03.滿額促銷
                  "             WHEN 11 THEN '06'  ",                          #rxc03    折價方式 - 06.會員價
                  "             WHEN 10 THEN '12'  ",                          #rxc03    折價方式 - 12.促銷會員價
                  "             WHEN 1  THEN '13'  ",                          #rxc03    折價方式 - 13.單項折價
                  "             WHEN 2  THEN '13'  ",                          #rxc03    折價方式 - 13.單項折價
                  "             WHEN 3  THEN '13'  ",                          #rxc03    折價方式 - 13.單項折價
                  "             WHEN 4  THEN '14'  ",                          #rxc03    折價方式 - 14.小計折價
                  "             WHEN 5  THEN '14'  ",                          #rxc03    折價方式 - 14.小計折價
                  "             WHEN 6  THEN '14'  ",                          #rxc03    折價方式 - 14.小計折價
                  "             WHEN 15 THEN '15'  ",                          #rxc03    折價方式 - 15.折扣券   #FUN-D10040 Add
                  "             WHEN 12 THEN '18' END, ",                      #rxc03    折價方式 - 16.強迫折價
                  " CASE WHEN (pmtno IS NULL) THEN CAST(' ' AS NVARCHAR2(20)) ELSE pmtno END CASE, ", #rxc04    促銷單號
                  " '', ",                                                     #rxc05    分類促銷單號
                  " disc, ",                                                   #rxc06    折價金額
                  " 0, ",                                                      #rxc07    廠商促銷分攤比例
                  " '', ",                                                     #rxc08    返券促銷單號
                  " 0, ",                                                      #rxc09    返券金額
                  " 0, ",                                                      #rxc10    廠商返券分攤比例
                  " '",l_legal,"', ",                                          #rxclegal 所屬法人
                 #" shop, ",                                                   #rxcplant 所屬營運中心 #FUN-CC0082 Mark
                  " '",p_azw01,"', ",                                          #rxcplant 所屬營運中心 #FUN-CC0082 Add
                  " '",g_vip,"', ",                                            #rxc11    是否會員
                  " '', ",                                                     #rxc12    結算營運中心
                  " '', ",                                                     #rxc13    分攤廠商
                  " '', ",                                                     #rxc14    分攤來源單號
                  " qty ",                                                     #rxc15    數量-參加促銷的數量
                  " FROM ",g_posdbs,"td_sale_detail_agio",g_db_links," ",
                 #" WHERE shop = '",p_azw01,"' AND mitem = '",p_item,"' ", #FUN-CC0082 Mark
                  " WHERE shop = '",p_shop,"' AND mitem = '",p_item,"' ",  #FUN-CC0082 Add
                 #" AND saleno = '",p_saleno,"' AND ",g_wc," "  #FUN-C80051 Mark
                  " AND saleno = '",p_saleno,"' "               #FUN-C80051 Add
   ELSE  #匯總
   END IF
   PREPARE sel_td_sale_detail_agio_pre FROM l_sql
   DECLARE sel_td_sale_detail_agio_cs CURSOR FOR sel_td_sale_detail_agio_pre
   FOREACH sel_td_sale_detail_agio_cs INTO 
           l_rxc.rxc00,l_rxc.rxc01,l_rxc.rxc02,l_rxc.rxc03,l_rxc.rxc04,
           l_rxc.rxc05,l_rxc.rxc06,l_rxc.rxc07,l_rxc.rxc08,l_rxc.rxc09,
           l_rxc.rxc10,l_rxc.rxclegal,l_rxc.rxcplant,l_rxc.rxc11,l_rxc.rxc12,
           l_rxc.rxc13,l_rxc.rxc14,l_rxc.rxc15
           
      IF SQLCA.sqlcode THEN        
         LET g_success = 'N'       
         LET g_errno = SQLCA.sqlcode
        #LET g_showmsg = 'SEL TD_SALE_DETAIL_AGIO'||' '||'SHOP:'||p_azw01||' '||'SALENO:'||p_saleno #FUN-CC0082 Mark
         LET g_showmsg = 'SEL TD_SALE_DETAIL_AGIO'||' '||'SHOP:'||p_shop||' '||'SALENO:'||p_saleno  #FUN-CC0082 Add
         CALL s_errmsg('rxc00,rxc01',p_rxc00||'/'||p_doc_no,g_showmsg,SQLCA.sqlcode,1)                      
         ROLLBACK WORK             
        #LET g_msg1 = 'TD_SALE_DETAIL_AGIO'||'SEL'||p_azw01||p_saleno #FUN-CC0082 Mark
         LET g_msg1 = 'TD_SALE_DETAIL_AGIO'||'SEL'||p_shop||p_saleno  #FUN-CC0082 Add
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg = g_msg[1,255]                                                 
        #CALL p200_log(g_trans_no,p_azw01,p_saleno,l_ryl04,'TD_SALE_DETAIL_AGIO',g_errno,g_msg,'0','N',g_msg1) #FUN-CC0082 Mark
         CALL p200_log(g_trans_no,p_shop,p_saleno,l_ryl04,'TD_SALE_DETAIL_AGIO',g_errno,g_msg,'0','N',g_msg1)  #FUN-CC0082 Add
         LET g_errno = '' 
         LET g_msg   = ''
         LET g_msg1  = '' 
         LET g_showmsg = ''
         RETURN      
      END IF
  
      #若為換贈，則寫理由碼
      IF l_rxc.rxc03 = '18' THEN
         CASE l_rxc.rxc00
            WHEN '01'
               LET l_upd = "UPDATE ",cl_get_target_table(p_azw01,'oeb_file'),
                           "   SET oeb1001 = '",g_oaz.oaz88,"' ",
                           " WHERE oeb01 = '",l_rxc.rxc01,"' ",
                           "   AND oeb03 = '",l_rxc.rxc02,"' "
            WHEN '02'
               LET l_upd = "UPDATE ",cl_get_target_table(p_azw01,'ogb_file'),
                           "   SET ogb1001 = '",g_oaz.oaz88,"' ",
                           " WHERE ogb01 = '",l_rxc.rxc01,"' ",
                           "   AND ogb03 = '",l_rxc.rxc02,"' "
            WHEN '03'
               LET l_upd = "UPDATE ",cl_get_target_table(p_azw01,'ohb_file'),
                           "   SET ohb50 = '",g_oaz.oaz88,"' ",
                           " WHERE ohb01 = '",l_rxc.rxc01,"' ",
                           "   AND ohb03 = '",l_rxc.rxc02,"' "
         END CASE
         CALL cl_replace_sqldb(l_upd) RETURNING l_upd
         CALL cl_parse_qry_sql(l_upd,p_azw01) RETURNING l_upd
         PREPARE upd_oeb1001_pre1 FROM l_upd
         EXECUTE upd_oeb1001_pre1
         IF SQLCA.sqlcode THEN
            LET g_success = 'N'
            LET g_errno = SQLCA.sqlcode
            CASE l_rxc.rxc00
               WHEN '01'
                 #LET g_showmsg = 'UPD oeb_file '||' '||'SHOP:'||p_azw01||' '||'SALENO:'||p_saleno #FUN-CC0082 Mark
                  LET g_showmsg = 'UPD oeb_file '||' '||'SHOP:'||p_shop||' '||'SALENO:'||p_saleno  #FUN-CC0082 Add
               WHEN '02'
                 #LET g_showmsg = 'UPD ogb_file '||' '||'SHOP:'||p_azw01||' '||'SALENO:'||p_saleno #FUN-CC0082 Mark
                  LET g_showmsg = 'UPD ogb_file '||' '||'SHOP:'||p_shop||' '||'SALENO:'||p_saleno  #FUN-CC0082 Add
               WHEN '03'
                 #LET g_showmsg = 'UPD ohb_file '||' '||'SHOP:'||p_azw01||' '||'SALENO:'||p_saleno #FUN-CC0082 Mark
                  LET g_showmsg = 'UPD ohb_file '||' '||'SHOP:'||p_shop||' '||'SALENO:'||p_saleno  #FUN-CC0082 Add
            END CASE
            CALL s_errmsg('oeb1001',g_oaz.oaz88,g_showmsg,SQLCA.sqlcode,1)
            ROLLBACK WORK
           #LET g_msg1 = 'TD_SALE_DETAIL_AGIO'||'SEL'||p_azw01||p_saleno #FUN-CC0082 Mark
            LET g_msg1 = 'TD_SALE_DETAIL_AGIO'||'SEL'||p_shop||p_saleno  #FUN-CC0082 Add
            CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
            LET g_msg = g_msg[1,255]
           #CALL p200_log(g_trans_no,p_azw01,p_saleno,l_ryl04,'TD_SALE_DETAIL_AGIO',g_errno,g_msg,'0','N',g_msg1) #FUN-CC0082 Mark
            CALL p200_log(g_trans_no,p_shop,p_saleno,l_ryl04,'TD_SALE_DETAIL_AGIO',g_errno,g_msg,'0','N',g_msg1)  #FUN-CC0082 Add
            LET g_errno = ''
            LET g_msg   = ''
            LET g_msg1  = ''
            LET g_showmsg = ''
            RETURN
         END IF
      END IF
      
      CALL p200_get_rxc12(p_azw01,p_date,p_prono,p_unit,l_rxc.rxc04) RETURNING l_rxc.rxc12,l_rxc.rxc13,l_rxc.rxc14
      LET l_sql = "SELECT COUNT(*) FROM ",cl_get_target_table(p_azw01,'rxc_file'),
                  " WHERE rxc00 = '",l_rxc.rxc00,"' ",
                  "   AND rxc01 = '",l_rxc.rxc01,"' ",
                  "   AND rxc02 = '",l_rxc.rxc02,"' ",
                  "   AND rxc03 = '",l_rxc.rxc03,"' "
      CALL cl_replace_sqldb(l_sql) RETURNING l_sql
      CALL cl_parse_qry_sql(l_sql,p_azw01) RETURNING l_sql
      PREPARE sel_count_rxc_pre FROM l_sql
      EXECUTE sel_count_rxc_pre INTO l_count
      IF l_count > 0 THEN
         LET l_sql = "UPDATE ",cl_get_target_table(p_azw01,'rxc_file'),
                     "   SET rxc06 = rxc06 + ",l_rxc.rxc06," ",
                     " WHERE rxc00 = '",l_rxc.rxc00,"' ",
                     "   AND rxc01 = '",l_rxc.rxc01,"' ",
                     "   AND rxc02 = '",l_rxc.rxc02,"' ",
                     "   AND rxc03 = '",l_rxc.rxc03,"' "
         CALL cl_replace_sqldb(l_sql) RETURNING l_sql
         CALL cl_parse_qry_sql(l_sql,p_azw01) RETURNING l_sql
         PREPARE upd_rxc_pre FROM l_sql
         EXECUTE upd_rxc_pre
         IF SQLCA.sqlcode OR SQLCA.sqlerrd[3] = 0 THEN
            LET g_success = 'N'
            LET g_errno = SQLCA.sqlcode
           #LET g_showmsg = 'UPD rxc_file'||' '||'SHOP:'||p_azw01||' '||'SALENO:'||p_saleno #FUN-CC0082 Mark
            LET g_showmsg = 'UPD rxc_file'||' '||'SHOP:'||p_shop||' '||'SALENO:'||p_saleno  #FUN-CC0082 Add
            CALL s_errmsg('rxc00,rxc01',p_rxc00||'/'||p_doc_no,g_showmsg,SQLCA.sqlcode,1)
            ROLLBACK WORK
           #LET g_msg1 = 'rxc_file'||'UPD'||p_azw01||p_saleno #FUN-CC0082 Mark
            LET g_msg1 = 'rxc_file'||'UPD'||p_shop||p_saleno　#FUN-CC0082 Add
            CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
            LET g_msg = g_msg[1,255]
           #CALL p200_log(g_trans_no,p_azw01,p_saleno,l_ryl04,'TD_SALE_DETAIL_AGIO',g_errno,g_msg,'0','N',g_msg1) #FUN-CC0082 Mark
            CALL p200_log(g_trans_no,p_shop,p_saleno,l_ryl04,'TD_SALE_DETAIL_AGIO',g_errno,g_msg,'0','N',g_msg1)  #FUN-CC0082 Add
            LET g_errno = ''
            LET g_msg   = ''
            LET g_msg1  = ''
            LET g_showmsg = ''
            RETURN
         END IF
      ELSE
         LET l_sql = " INSERT INTO ",cl_get_target_table(p_azw01,'rxc_file'),"( ",        
                     "        rxc00,rxc01,rxc02,rxc03,rxc04, ",
                     "        rxc05,rxc06,rxc07,rxc08,rxc09, ",
                     "        rxc10,rxclegal,rxcplant,rxc11,rxc12, ",
                     "        rxc13,rxc14,rxc15) ",
                     " VALUES(?,?,?,?,?,   ?,?,?,?,?, ",
                     "        ?,?,?,?,?,   ?,?,?) "
         CALL cl_replace_sqldb(l_sql) RETURNING l_sql
         CALL cl_parse_qry_sql(l_sql,p_azw01) RETURNING l_sql
         PREPARE ins_rxc_pre1 FROM l_sql
         EXECUTE ins_rxc_pre1 USING
              l_rxc.rxc00,l_rxc.rxc01,l_rxc.rxc02,l_rxc.rxc03,l_rxc.rxc04,
              l_rxc.rxc05,l_rxc.rxc06,l_rxc.rxc07,l_rxc.rxc08,l_rxc.rxc09,
              l_rxc.rxc10,l_rxc.rxclegal,l_rxc.rxcplant,l_rxc.rxc11,l_rxc.rxc12,
              l_rxc.rxc13,l_rxc.rxc14,l_rxc.rxc15
         IF SQLCA.sqlcode OR SQLCA.sqlerrd[3] = 0 THEN
            LET g_success = 'N'       
            LET g_errno = SQLCA.sqlcode
           #LET g_showmsg = 'INS rxc_file'||' '||'SHOP:'||p_azw01||' '||'SALENO:'||p_saleno #FUN-CC0082 Mark
            LET g_showmsg = 'INS rxc_file'||' '||'SHOP:'||p_shop||' '||'SALENO:'||p_saleno  #FUN-CC0082 Add
            CALL s_errmsg('rxc00,rxc01',p_rxc00||'/'||p_doc_no,g_showmsg,SQLCA.sqlcode,1)                      
            ROLLBACK WORK             
           #LET g_msg1 = 'rxc_file'||'INS'||p_azw01||p_saleno #FUN-CC0082 Mark
            LET g_msg1 = 'rxc_file'||'INS'||p_shop||p_saleno  #FUN-CC0082 Add
            CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
            LET g_msg = g_msg[1,255]                                                 
           #CALL p200_log(g_trans_no,p_azw01,p_saleno,l_ryl04,'TD_SALE_DETAIL_AGIO',g_errno,g_msg,'0','N',g_msg1) #FUN-CC0082 Mark
            CALL p200_log(g_trans_no,p_shop,p_saleno,l_ryl04,'TD_SALE_DETAIL_AGIO',g_errno,g_msg,'0','N',g_msg1)  #FUN-CC0082 Add
            LET g_errno = '' 
            LET g_msg   = ''
            LET g_msg1  = '' 
            LET g_showmsg = ''
            RETURN     
         END IF
      END IF
   END FOREACH
   
END FUNCTION

#FUNCTION p200_xyz_ins(p_gat01,p_azw01,p_saleno,p_doc_no,p_opno)        #FUN-CC0082 Mark
FUNCTION p200_xyz_ins(p_gat01,p_azw01,p_saleno,p_doc_no,p_opno,p_rxy34) #FUN-CC0082 Add
DEFINE p_gat01   LIKE gat_file.gat01
DEFINE p_doctype LIKE rxx_file.rxx00       #單據別
DEFINE p_paytype LIKE rxx_file.rxx03       #款別類型1收款/-1退款
DEFINE p_type    LIKE type_file.chr1       #0:銷售單 6:銷退單
DEFINE p_azw01   LIKE azw_file.azw01
DEFINE p_saleno     LIKE type_file.chr18
DEFINE l_tab1    LIKE ryk_file.ryk03
DEFINE l_tab2    LIKE ryk_file.ryk03
DEFINE l_ins     STRING
DEFINE l_sel     STRING
DEFINE l_sql     STRING
DEFINE p_doc_no  LIKE oga_file.oga01     #單據自動編號
DEFINE p_sdate   LIKE type_file.chr50
DEFINE p_stime   LIKE type_file.chr50
DEFINE p_rxy12   LIKE type_file.chr50
DEFINE p_opno    LIKE ryi_file.ryi02
DEFINE p_num     LIKE type_file.chr1
DEFINE p_rxy06   STRING
DEFINE l_ryl04   LIKE ryl_file.ryl04
DEFINE l_lqe01   LIKE lqe_file.lqe01  #FUN-C80079 Add
DEFINE l_lqe19   LIKE lqe_file.lqe19  #FUN-C80079 Add
#FUN-CC0082 Add Begin ---
DEFINE p_rxy34   LIKE rxy_file.rxy34
DEFINE p_shop    LIKE oga_file.oga84
DEFINE l_field   RECORD
       rxy34     LIKE type_file.chr100
                 END RECORD
#FUN-CC0082 Add End -----

   LET g_time = TIME                  #CURRENT TIME
 
   IF p_azw01 IS NULL THEN RETURN END IF
   LET l_sql = ''
   LET l_sel = ''
   LET l_ins = ''
   LET p_type= ''

   CASE p_gat01
      WHEN "oea_file"           #訂單  
         LET p_doctype = '01'
         LET l_tab2    = "td_sale_pay"
         LET p_sdate   = "CAST (sdate AS DATE)"
         LET p_stime   = "stime[1,2]||':'||stime[3,4]||':'||stime[5,6]"
         LET p_paytype = '1'
         LET l_ryl04   = '01'
         LET l_field.rxy34 = "'",p_rxy34,"'" #FUN-CC0082 Add
         LET p_shop    = p_azw01             #FUN-CC0082 Add

      WHEN "oga_file"           #銷售單  
         LET p_doctype= '02'
         IF g_psell_way = '1' THEN
            LET l_tab2   = ""
         ELSE
            LET l_tab2   = "td_sale_pay"
         END IF
         LET p_paytype = '1'
         LET p_sdate   = "CAST (sdate AS DATE)"
         LET p_stime   = "stime[1,2]||':'||stime[3,4]||':'||stime[5,6]"
         LET l_ryl04   = '02'
        #FUN-CC0082 Add Begin ---
         IF g_rcj12 = '1' THEN 
            LET l_field.rxy34 = "CASE WHEN (IsOrderPay = 'N' OR IsOrderPay IS NULL) THEN '",p_rxy34,"' ELSE NULL END"
            IF cl_null(p_rxy34) THEN LET p_shop = p_azw01 ELSE LET p_shop = p_rxy34 END IF
         ELSE
            LET l_field.rxy34 = "CASE WHEN (IsOrderPay = 'Y') THEN '",p_rxy34,"' ELSE NULL END"
            LET p_shop = p_azw01
         END IF
        #FUN-CC0082 Add End -----

      WHEN "oha_file"           #銷退單  
         LET p_doctype = '03'
         LET l_tab2    = "td_sale_pay"
         LET p_paytype = '-1'
         LET p_sdate   = "CAST (sdate AS DATE)"
         LET p_stime   = "stime[1,2]||':'||stime[3,4]||':'||stime[5,6]"
         LET l_ryl04   = '02'
         LET l_field.rxy34 = "NULL" #FUN-CC0082 Add
         LET p_shop    = p_azw01    #FUN-CC0082 Add

      WHEN "rxa_file"           #退款單  
         LET p_doctype = '04'
         LET l_tab2    = "td_sale_pay"
         LET p_paytype = '-1'
         LET p_sdate   = "CAST (sdate AS DATE)"
         LET p_stime   = "stime[1,2]||':'||stime[3,4]||':'||stime[5,6]"
         LET l_ryl04   = '03'
         LET l_field.rxy34 = "NULL" #FUN-CC0082 Add
         LET p_shop    = p_azw01    #FUN-CC0082 Add

   END CASE

   #rxy_file 交款明細表
   LET l_ins = " INSERT INTO ",cl_get_target_table(p_azw01,'rxy_file'),"(  ",
               " rxy00    ,",                             #單據別
               " rxy01    ,",                             #單號
               " rxy02    ,",                             #項次
               " rxy03    ,",                             #款別          
               " rxy04    ,",                             #款別類型      
               " rxy05    ,",                             #交款金額      
               " rxy06    ,",                             #卡號/票號/帳號
               " rxy07    ,",                             #刷卡手續費率  
               " rxy08    ,",                             #刷卡手續費額  
               " rxy09    ,",                             #支票面額      
               " rxy10    ,",                             #出票日期      
               " rxy11    ,",                             #出票單位      
               " rxy12    ,",                             #卡券種類編號  
               " rxy13    ,",                             #券面額編號    
               " rxy14    ,",                             #券起始編號    
               " rxy15    ,",                             #券終止編號    
               " rxy16    ,",                             #券數量        
               " rxy17    ,",                             #票券溢交款金額
               " rxy18    ,",                             #退款類型      
               " rxy19    ,",                             #沖預收款類型  
               " rxy20    ,",                             #固定手續費    
               " rxy21    ,",                             #交款日期      
               " rxy22    ,",                             #交款時間      
               " rxy30    ,",                             #POS款別       
               " rxy31    ,",                             #銷售單號      
               " rxylegal ,",                             #所屬法人    
               " rxyplant ,",                             #所屬營運中心        
              #" rxy33,   ,",                             #冲预收否  #FUN-CB0025 #FUN-CB0103 Mark
               " rxy33    ,",                             #冲预收否  #FUN-CB0025 #FUN-CB0103 Add
               " rxy34    ,",                             #代收款營運中心 #FUN-CC0082 Add
               " rxy23    )"                              #抵現積分


   LET l_sel = " SELECT DISTINCT ",
               " '",p_doctype,"', ",                                                          #rxy00    單據別
               " '",p_doc_no,"', ",                                                           #rxy01    單號
               " item, ",                                                                     #rxy02    項次
               " paycodeerp, ",                                                               #rxy03    款別          
               " '",p_paytype,"', ",                                                          #rxy04    款別類型      
              #" pay-changed, ",                                                              #rxy05    交款金額 #FUN-CA0160 Mark
               " pay-extra-changed, ",                                                        #rxy05    交款金額 #FUN-CA0160 Add
               " paysernum, ",                                                                #rxy06    卡號/票號/帳號
               " '0', ",                                                                      #rxy07    刷卡手續費率   
               " '0', ",                                                                      #rxy08    刷卡手續費額
              #" CASE paycodeerp WHEN CAST('03' AS NVARCHAR2(20)) THEN pay+extra ELSE null END CASE, ",        #rxy09    支票面額 #FUN-CA0160 Mark
               " CASE paycodeerp WHEN CAST('03' AS NVARCHAR2(20)) THEN pay ELSE null END CASE, ",              #rxy09    支票面額 #FUN-CA0160 Add
               " '', ",                                                                       #rxy10    出票日期
               " '', ",                                                                       #rxy11    出票單位
               " cttype, ",                                                                   #rxy12    卡券種類編號  
              #" CASE paycodeerp WHEN CAST('04' AS NVARCHAR2(20)) THEN pay+extra ELSE null END CASE, ",        #rxy13    券面額編號 #FUN-CA0160 Mark
               " CASE paycodeerp WHEN CAST('04' AS NVARCHAR2(20)) THEN pay ELSE null END CASE, ",              #rxy13    券面額編號 #FUN-CA0160 Add
              #" paysernum, ",                                                                #rxy14    券起始編號  #TQC-C90016 mark  
              #" paysernum, ",                                                                #rxy15    券終止編號  #TQC-C90016 mark  
               " CASE paycodeerp WHEN CAST('04' AS NVARCHAR2(20)) THEN paysernum ELSE null END CASE, ",              #TQC-C90016 add
               " CASE paycodeerp WHEN CAST('04' AS NVARCHAR2(20)) THEN paysernum ELSE null END CASE, ",              #TQC-C90016 add
               " CASE paycodeerp WHEN CAST('04' AS NVARCHAR2(20)) THEN '1' ELSE '0' END CASE,",    #rxy16    券數量        
               " extra, ",                                                                    #rxy17    票券溢交款金額
               " CASE paycodeerp WHEN CAST('02' AS NVARCHAR2(20)) THEN 'T' WHEN CAST('03' AS NVARCHAR2(20)) THEN 'T' ELSE '' END CASE ,",   #rxy18    退款類型      
              #" CASE paycodeerp WHEN CAST('07' AS NVARCHAR2(20)) THEN '1' ELSE '' END CASE   ,",  #rxy19    沖預收款類型 #FUN-CB0025
               " CASE IsOrderPay WHEN CAST('Y' AS NVARCHAR2(1)) THEN '1' ELSE '' END CASE   ,",    #rxy19    沖預收款類型 #FUN-CB0025
               " '0', ",                                                                      #rxy20    固定手續費    
               " ",p_sdate,", ",                                                              #rxy21    交款日期      
               " ",p_stime,", ",                                                              #rxy22    交款時間      
               " paycode, ",                                                                  #rxy30    POS款別       
               " '', ",                                                                       #rxy31    銷售單號      
               " '",l_legal,"' ,",                                                            #rxylegal 所屬法人   
              #" shop, ",                                                                     #rxyplant 所屬營運中心 #FUN-CC0082 Mark
               " '",p_azw01,"', ",                                                            #rxyplant 所屬營運中心 #FUN-CC0082 Add
              #" IsOrderPay, ",                                                               #rxy33    冲预收否           #FUN-CB0103 Mark
               " CASE WHEN IsOrderPay IS NULL THEN CAST('N' AS NVARCHAR2(1)) ELSE IsOrderPay END, ",    #rxy33    冲预收否 #FUN-CB0103 Add
               " ",l_field.rxy34,", ",                                                        #rxy34    代收款營運中心 #FUN-CC0082 Add
               " descore ",                                                                   #rxy23    抵現積分
               "  FROM  ",g_posdbs,l_tab2,g_db_links," ",
              #"  LEFT OUTER JOIN ",cl_get_target_table(p_azw01,'lqe_file'),
              #"  ON (lqe01 = paysernum AND paycodeerp = '04') ",
              #" WHERE shop = '",p_azw01,"' ", #FUN-CC0082 Mark
               " WHERE shop = '",p_shop,"' ",  #FUN-CC0082 Add
               "   AND cnfflg ='Y' AND saleno = '",p_saleno,"' "

   LET l_sql = l_ins,l_sel CLIPPED
   CALL cl_replace_sqldb(l_sql) RETURNING l_sql
   CALL cl_parse_qry_sql(l_sql,p_azw01) RETURNING l_sql
   PREPARE ins_rxy_pre FROM l_sql
   EXECUTE ins_rxy_pre 
   IF SQLCA.sqlcode THEN
      LET g_success = 'N'
      LET g_errno = SQLCA.sqlcode
     #LET g_showmsg = 'INS rxy_file'||' '||'SHOP:'||p_azw01||' '||'SALENO:'||p_saleno #FUN-CC0082 Mark
      LET g_showmsg = 'INS rxy_file'||' '||'SHOP:'||p_shop||' '||'SALENO:'||p_saleno  #FUN-CC0082 Add
      CALL s_errmsg('rxy00,rxy01',p_doctype||'/'||p_doc_no,g_showmsg,SQLCA.sqlcode,1)
      ROLLBACK WORK
     #LET g_msg1 = 'rxy_file'||'INS'||p_azw01||p_saleno #FUN-CC0082 Mark
      LET g_msg1 = 'rxy_file'||'INS'||p_shop||p_saleno  #FUN-CC0082 Add
      CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
      LET g_msg = g_msg[1,255]
     #CALL p200_log(g_trans_no,p_azw01,p_saleno,l_ryl04,'TD_SALE_PAY',g_errno,g_msg,'0','N',g_msg1) #FUN-CC0082 Mark
      CALL p200_log(g_trans_no,p_shop,p_saleno,l_ryl04,'TD_SALE_PAY',g_errno,g_msg,'0','N',g_msg1)  #FUN-CC0082 Add
      LET g_errno = ''
      LET g_msg   = ''
      LET g_msg1  = ''
      LET g_showmsg = ''
      RETURN
   END IF

   #FUN-C80079 Add Begin ---
   #若存在券付款，且未核銷則做核銷
   LET l_sql = "SELECT paysernum,sdate FROM ",g_posdbs,l_tab2,g_db_links," ",
              #" WHERE shop = '",p_azw01,"' AND saleno = '",p_saleno,"' AND cnfflg ='Y' ", #FUN-CC0082 Mark
               " WHERE shop = '",p_shop,"' AND saleno = '",p_saleno,"' AND cnfflg ='Y' ",  #FUN-CC0082 Add
               "   AND paycodeerp = '04' AND isverification = 'N' "
   CALL cl_replace_sqldb(l_sql) RETURNING l_sql
   CALL cl_parse_qry_sql(l_sql,p_azw01) RETURNING l_sql
   PREPARE sel_paysernum_pre FROM l_sql
   DECLARE sel_paysernum_cs CURSOR FOR sel_paysernum_pre
   FOREACH sel_paysernum_cs INTO l_lqe01,l_lqe19
      IF SQLCA.sqlcode THEN         
         LET g_success = 'N'       
         LET g_errno = SQLCA.sqlcode
        #LET g_showmsg = 'SEL TD_SALE_PAY'||' '||'SHOP:'||p_azw01||' '||'SALENO:'||p_saleno #FUN-CC0082 Mark
         LET g_showmsg = 'SEL TD_SALE_PAY'||' '||'SHOP:'||p_shop||' '||'SALENO:'||p_saleno  #FUN-CC0082 Add
         CALL s_errmsg('lqe01',l_lqe01,g_showmsg,SQLCA.sqlcode,1)                       
         ROLLBACK WORK             
        #LET g_msg1 = 'TD_SALE_PAY'||'SEL'||p_azw01||p_saleno #FUN-CC0082 Mark
         LET g_msg1 = 'TD_SALE_PAY'||'SEL'||p_shop||p_saleno  #FUN-CC0082 Add
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg                        
         LET g_msg = g_msg[1,255]                                                 
        #CALL p200_log(g_trans_no,p_azw01,p_saleno,l_ryl04,'TD_SALE_PAY',g_errno,g_msg,'0','N',g_msg1) #FUN-CC0082 Mark
         CALL p200_log(g_trans_no,p_shop,p_saleno,l_ryl04,'TD_SALE_PAY',g_errno,g_msg,'0','N',g_msg1)  #FUN-CC0082 Add
         LET g_errno = ''       
         LET g_msg   = ''       
         LET g_msg1  = ''       
         LET g_showmsg = ''     
         RETURN                 
      END IF

      LET l_sql = "UPDATE ",cl_get_target_table(p_azw01,'lqe_file'),
                  "   SET lqe17 = '4', ",
                  #"       lqe18 = '",p_azw01,"', ",  #FUN-D10040 mark
                  #"       lqe19 = '",l_lqe19,"' ",   #FUN-D10040 mark
                  "       lqe24 = '",p_azw01,"', ",   #FUN-D10040 add
                  "       lqe25 = '",l_lqe19,"' ",    #FUN-D10040 add
                  " WHERE lqe01 = '",l_lqe01,"' "
      
      CALL cl_replace_sqldb(l_sql) RETURNING l_sql
      CALL cl_parse_qry_sql(l_sql,p_azw01) RETURNING l_sql
      PREPARE upd_lqe_pre1 FROM l_sql
      EXECUTE upd_lqe_pre1
      IF SQLCA.sqlcode OR SQLCA.sqlerrd[3] = 0 THEN
         LET g_success = 'N'                                                                  
         LET g_errno = SQLCA.sqlcode                                                          
        #LET g_showmsg = 'UPD lqe_file'||' '||'SHOP:'||p_azw01||' '||'SALENO:'||p_saleno   #FUN-CC0082 Mark
         LET g_showmsg = 'UPD lqe_file'||' '||'SHOP:'||p_shop||' '||'SALENO:'||p_saleno    #FUN-CC0082 Add
         CALL s_errmsg('lqe01',l_lqe01,g_showmsg,SQLCA.sqlcode,1)                             
         ROLLBACK WORK                                                                        
        #LET g_msg1 = 'lqe_file'||'UPD'||p_azw01||p_saleno #FUN-CC0082 Mark
         LET g_msg1 = 'lqe_file'||'UPD'||p_shop||p_saleno  #FUN-CC0082 Add
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg                     
         LET g_msg = g_msg[1,255]                                
        #CALL p200_log(g_trans_no,p_azw01,p_saleno,l_ryl04,'TD_SALE_PAY',g_errno,g_msg,'0','N',g_msg1) #FUN-CC0082 Mark
         CALL p200_log(g_trans_no,p_shop,p_saleno,l_ryl04,'TD_SALE_PAY',g_errno,g_msg,'0','N',g_msg1)  #FUN-CC0082 Add
         LET g_errno = ''       
         LET g_msg   = ''
         LET g_msg1  = ''       
         LET g_showmsg = ''     
         RETURN 
      END IF
   END FOREACH

  #直接Upd lqe_file的Sql預留 (Mark原因：經測試該Sql效率低於Foreach)
  #LET l_sql = "UPDATE ",cl_get_target_table(p_azw01,'lqe_file'),
  #            "   SET lqe17 = '4', ",
  #            "       lqe18 = '",p_azw01,"', ",
  #            "       lqe19 = (SELECT sdate FROM ",g_posdbs,l_tab2,g_db_links," ",
  #            "                 WHERE shop = '",p_azw01,"' AND saleno = '",p_saleno,"' AND lqe01 = paysernum) ",
  #            " WHERE EXISTS (SELECT 1 FROM ",g_posdbs,l_tab2,g_db_links," ",
  #            "                WHERE lqe01 = paysernum ",
  #            "                  AND shop = '",p_azw01,"' AND saleno = '",p_saleno,"' ",
  #            "                  AND paycodeerp = '04' AND isverification = 'N') "
  #
  #CALL cl_replace_sqldb(l_sql) RETURNING l_sql
  #CALL cl_parse_qry_sql(l_sql,p_azw01) RETURNING l_sql
  #PREPARE upd_lqe_pre FROM l_sql
  #EXECUTE upd_lqe_pre
  #IF SQLCA.sqlcode THEN
  #   LET g_success = 'N'
  #   LET g_errno = SQLCA.sqlcode
  #   LET g_showmsg = 'UPD lqe_file'||' '||'SHOP:'||p_azw01||' '||'SALENO:'||p_saleno
  #   CALL s_errmsg('lqe01',l_lqe01,g_showmsg,SQLCA.sqlcode,1)
  #   ROLLBACK WORK
  #   LET g_msg1 = 'lqe_file'||'UPD'||p_azw01||p_saleno
  #   CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
  #   LET g_msg = g_msg[1,255]
  #   CALL p200_log(g_trans_no,p_azw01,p_saleno,l_ryl04,'TD_SALE_PAY',g_errno,g_msg,'0','N',g_msg1)
  #   LET g_errno = ''
  #   LET g_msg   = ''
  #   LET g_msg1  = ''
  #   LET g_showmsg = ''
  #   RETURN
  #END IF
   #FUN-C80079 Add End -----

   #rxx_file  交款匯總表
   LET l_ins = " INSERT INTO ",cl_get_target_table(p_azw01,'rxx_file'),"(  ",
               " rxx00   ,",                        #單據別
               " rxx01   ,",                        #單號
               " rxx02   ,",                        #款別
               " rxx03   ,",                        #款別類型  
               " rxx04   ,",                        #交款金額  
               " rxx05   ,",                        #溢交款金額
               " rxx11   ,",                        #銷售單號  
               " rxxlegal,",                        #法人別    
               " rxxplant)"                         #機構別    

   LET l_sel = " SELECT DISTINCT ",
               " rxy00 ,",                        #單據別
               " rxy01 ,",                        #單號
              #" rxy03 ,",                        #款別                     #FUN-CC0082 Mark
               " CASE WHEN rxy33 = 'Y' THEN '07' ELSE rxy03 END,",    #款別 #FUN-CC0082 Add
               " rxy04 ,",                        #款別類型  
               " SUM(rxy05) ,",                   #交款金額  
               " SUM(COALESCE(rxy17,0)) ,",       #溢交款金額
               " ''  ,",                          #銷售單號  
               " rxylegal,",                      #法人別    
               " rxyplant ",                      #機構別    
               " FROM ",cl_get_target_table(p_azw01,'rxy_file'),"   ",
               " WHERE rxy00 = '",p_doctype,"' AND rxyplant = '",p_azw01,"' ",  
               "   AND rxy01 = '",p_doc_no,"'  ",
              #" GROUP BY rxy00,rxy01,rxy03,rxy04,rxylegal,rxyplant "                                          #FUN-CC0082 Mark
               " GROUP BY rxy00,rxy01,CASE WHEN rxy33 = 'Y' THEN '07' ELSE rxy03 END,rxy04,rxylegal,rxyplant " #FUN-CC0082 Add

   LET l_sql = l_ins,l_sel CLIPPED
   CALL cl_replace_sqldb(l_sql) RETURNING l_sql
   CALL cl_parse_qry_sql(l_sql,p_azw01) RETURNING l_sql
   PREPARE ins_rxx_pre FROM l_sql
   EXECUTE ins_rxx_pre 
   IF SQLCA.sqlcode THEN
      LET g_success = 'N'
      LET g_errno = SQLCA.sqlcode
     #LET g_showmsg = 'INS rxx_file'||' '||'SHOP:'||p_azw01||' '||'SALENO:'||p_saleno #FUN-CC0082 Mark
      LET g_showmsg = 'INS rxx_file'||' '||'SHOP:'||p_shop||' '||'SALENO:'||p_saleno  #FUN-CC0082 Add
      CALL s_errmsg('rxx00,rxx01',p_doctype||'/'||p_doc_no,g_showmsg,SQLCA.sqlcode,1)
      ROLLBACK WORK
     #LET g_msg1 = 'rxx_file'||'INS'||p_azw01||p_saleno #FUN-CC0082 Mark
      LET g_msg1 = 'rxx_file'||'INS'||p_shop||p_saleno  #FUN-CC0082 Add
      CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
      LET g_msg = g_msg[1,255]
     #CALL p200_log(g_trans_no,p_azw01,p_saleno,l_ryl04,'TD_SALE_PAY',g_errno,g_msg,'0','N',g_msg1) #FUN-CC0082 Mark
      CALL p200_log(g_trans_no,p_shop,p_saleno,l_ryl04,'TD_SALE_PAY',g_errno,g_msg,'0','N',g_msg1)  #FUN-CC0082 Add
      LET g_errno = ''
      LET g_msg   = ''
      LET g_msg1  = ''
      LET g_showmsg = ''
      RETURN
   END IF


   #rxz_file 刷卡明細表
   LET l_ins = " INSERT INTO ",cl_get_target_table(p_azw01,'rxz_file'),"(  ",
               " rxz00   ,",                              #單據別
               " rxz01   ,",                              #單號
               " rxz02   ,",                              #款別類型    
               " rxz03   ,",                              #刷卡序號
               " rxz04   ,",                              #卡號        
               " rxz05   ,",                              #刷卡金額    
               " rxz06   ,",                              #刷卡日期    
               " rxz07   ,",                              #刷卡時間    
               " rxz08   ,",                              #刷卡人員    
               " rxz09   ,",                              #刷卡手續費額
               " rxz10   ,",                              #刷卡手續費率
               " rxz11   ,",                              #銀行名稱    
               " rxz12   ,",                              #銀行注冊否  
               " rxz13   ,",                              #狀態        
               " rxz14   ,",                              #狀態說明    
               " rxz15   ,",                              #固定手續費  
               " rxz20   ,",                              #卡類型      
               " rxz21   ,",                              #銷售單號    
               " rxzlegal,",                              #法人別      
               " rxzplant)"                               #機構別      

   LET l_sel = " SELECT DISTINCT ",
               " '",p_doctype,"'   ,",                    #rxz00    單據別
               " '",p_doc_no,"' ,",                       #rxz01    單號
               " '",p_paytype,"'   ,",                    #rxz02    款別類型    
               " item, ",                                 #rxz03    刷卡序號
               " paysernum, ",                            #rxz04    卡號        
               " pay, ",                                  #rxz05    刷卡金額    
               " ",p_sdate,",",                           #rxz06    刷卡日期
               " ",p_stime,",",                           #rxz07    刷卡時間
               " '",p_opno,"', ",                         #rxz08    刷卡人員    
               " '0', ",                                  #rxz09    刷卡手續費額
               " '0', ",                                  #rxz10    刷卡手續費率
               " '', ",                                   #rxz11    銀行名稱    
               " 'N', ",                                  #rxz12    銀行注冊否  
               " '1', ",                                  #rxz13    狀態        
               " '', ",                                   #rxz14    狀態說明    
               " '0', ",                                  #rxz15    固定手續費  
               " CASE paycodeerp ",
               "   WHEN CAST('02' AS NVARCHAR2(20)) THEN '2' ",
               "   WHEN CAST('05' AS NVARCHAR2(20)) THEN '5' ",
               "   WHEN CAST('06' AS NVARCHAR2(20)) THEN '6' END, ",    #rxz20    卡類型      
               " '', ",                                   #rxz21    銷售單號    
               " '",l_legal,"', ",                        #rxzlegal 所屬法人  
              #" shop ",                                  #rxzplant 所屬營運中心  #FUN-CC0082 Mark
               " '",p_azw01,"' ",                         #rxzplant 所屬營運中心  #FUN-CC0082 Add
               "  FROM  ",g_posdbs,l_tab2,g_db_links,
              #" WHERE shop = '",p_azw01,"' ", #FUN-CC0082 Mark
               " WHERE shop = '",p_shop,"' ",  #FUN-CC0082 Add
               "   AND saleno = '",p_saleno,"' AND cnfflg = 'Y' ",
               "   AND paycodeerp IN ('02','05','06') "

   LET l_sql = l_ins,l_sel CLIPPED
   CALL cl_replace_sqldb(l_sql) RETURNING l_sql
   CALL cl_parse_qry_sql(l_sql,p_azw01) RETURNING l_sql
   PREPARE ins_rxz_pre FROM l_sql
   EXECUTE ins_rxz_pre 
   IF SQLCA.sqlcode THEN
      LET g_success = 'N'
      LET g_errno = SQLCA.sqlcode
     #LET g_showmsg = 'INS rxz_file'||' '||'SHOP:'||p_azw01||' '||'SALENO:'||p_saleno #FUN-CC0082 Mark
      LET g_showmsg = 'INS rxz_file'||' '||'SHOP:'||p_shop||' '||'SALENO:'||p_saleno  #FUN-CC0082 Add
      CALL s_errmsg('rxz00,rxz01',p_doctype||'/'||p_doc_no,'INS rxz_file',SQLCA.sqlcode,1)
      ROLLBACK WORK
     #LET g_msg1 = 'rxz_file'||'INS'||p_azw01||p_saleno #FUN-CC0082 Mark
      LET g_msg1 = 'rxz_file'||'INS'||p_shop||p_saleno  #FUN-CC0082 Add
      CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
      LET g_msg = g_msg[1,255]
     #CALL p200_log(g_trans_no,p_azw01,p_saleno,l_ryl04,'TD_SALE_PAY',g_errno,g_msg,'0','N',g_msg1) #FUN-CC0082 Mark
      CALL p200_log(g_trans_no,p_shop,p_saleno,l_ryl04,'TD_SALE_PAY',g_errno,g_msg,'0','N',g_msg1)  #FUN-CC0082 Add
      LET g_errno = ''
      LET g_msg   = ''
      LET g_msg1  = ''
      LET g_showmsg = ''
      RETURN
   END IF
END FUNCTION

FUNCTION p200_dblinks(l_db_links)
DEFINE l_db_links LIKE ryg_file.ryg02

  IF l_db_links IS NULL OR l_db_links = ' ' THEN
     RETURN ' '
  ELSE
     LET l_db_links = '@',l_db_links CLIPPED
     RETURN l_db_links
  END IF

END FUNCTION

FUNCTION p200_trans_no()
DEFINE l_doc  LIKE type_file.chr9
DEFINE l_doc1 LIKE type_file.chr7
DEFINE l_no   LIKE type_file.num10
DEFINE l_time LIKE type_file.chr30

   LET l_time =CURRENT YEAR TO FRACTION(4)
   LET l_time = l_time[1,4],l_time[6,7],l_time[9,10],l_time[12,13],l_time[15,16],l_time[18,19],l_time[21,23]
   LET g_ryy.ryy01 = "U",l_time CLIPPED
   RETURN g_ryy.ryy01
END FUNCTION

FUNCTION p200_check_oga16(p_azw01,p_saleno)
DEFINE  p_azw01   LIKE azw_file.azw01
DEFINE  p_saleno  LIKE oga_file.oga16
DEFINE  l_tflg    LIKE type_file.chr1   #傳輸標志
DEFINE  l_sql     STRING

   LET l_sql = " SELECT condition2 FROM ",g_posdbs,"td_sale",g_db_links," ",
               "  WHERE shop = '",p_azw01,"' AND saleno = '",p_saleno,"' ",
               "    AND type = '3' "
   PREPARE check_oea_saleno_pre FROM l_sql
   EXECUTE check_oea_saleno_pre INTO l_tflg 
   IF l_tflg='Y' THEN 
      RETURN TRUE
   ELSE 
      RETURN FALSE
   END IF
END FUNCTION

FUNCTION p200_check_oha16(p_azw01,p_saleno)
DEFINE  p_azw01   LIKE azw_file.azw01
DEFINE  p_saleno  LIKE oha_file.oha16
DEFINE  l_tflg    LIKE type_file.chr1   #傳輸標志
DEFINE  l_sql     STRING

   LET l_sql = " SELECT condition2 FROM ",g_posdbs,"td_sale",g_db_links," ",
               "  WHERE shop = '",p_azw01,"' AND saleno = '",p_saleno,"' ",
               "    AND type = '0' "
   PREPARE check_oga_saleno_pre FROM l_sql
   EXECUTE check_oga_saleno_pre INTO l_tflg
   IF l_tflg='Y' THEN
      RETURN TRUE
   ELSE
      RETURN FALSE
   END IF
END FUNCTION

#FUNCTION p200_g_wc()               #FUN-CA0160 Mark
FUNCTION p200_g_wc(p_gat01)         #FUN-CA0160 Add
DEFINE p_gat01  LIKE gat_file.gat01 #FUN-CA0160 Add
DEFINE l_wc     STRING  
DEFINE tok      base.StringTokenizer
DEFINE l_saleno LIKE oga_file.oga16
DEFINE l_no_str LIKE type_file.chr20 #FUN-CA0160 Add

  #FUN-CA0160 Add Begin ---
   CASE p_gat01 
      WHEN "oea_file"      #订单
         LET l_no_str = " Saleno"
      WHEN "oga_file"      #出货单
         LET l_no_str = " Saleno"
      WHEN "oha_file"      #销退单
         LET l_no_str = " Saleno"
      WHEN "rxa_file"      #退订单
         LET l_no_str = " Saleno"
      WHEN "ome_file"      #发票
         LET l_no_str = " Saleno"
      WHEN "lps_file"      #发卡
         LET l_no_str = " SaleCardno"
      WHEN "lpu_file"      #储值
         LET l_no_str = " Rechargeno"
      WHEN "lpv_file"      #退卡
         LET l_no_str = " SaleCardno"
      WHEN "lru_file"      #退卡
         LET l_no_str = " SaleCardno"
      WHEN "lrw_file"      #换卡
         LET l_no_str = " ChangeCardno"
      WHEN "rxe_file_2"    #售券
         LET l_no_str = " SaleCouponno"
      WHEN "rxe_file_3"    #退券
         LET l_no_str = " SaleCouponno"
   END CASE

   IF cl_null(l_no_str) THEN LET l_no_str = " Saleno" END IF
  #FUN-CA0160 Add End -----

   IF NOT cl_null(g_up_no) THEN
      LET tok = base.StringTokenizer.create(g_up_no,"|")
      LET l_saleno = '' 
      WHILE tok.hasMoreTokens()
         LET l_saleno = tok.nextToken()
         IF cl_null(l_wc) THEN
           #LET l_wc = " saleno IN ('",l_saleno CLIPPED,"' "               #FUN-CA0160 Mark
            LET l_wc = " ",l_no_str CLIPPED," IN ('",l_saleno CLIPPED,"' " #FUN-CA0160 Add
         ELSE
            LET l_wc = l_wc,",'",l_saleno CLIPPED,"' "
         END IF
      END WHILE
      IF NOT cl_null(l_wc) THEN LET l_wc = l_wc CLIPPED,")" END IF
   END IF   
   IF cl_null(l_wc) THEN  
      LET l_wc = " 1=1" 
   END IF
   RETURN l_wc

END FUNCTION

######################################################################
#傳入門店機構p_azw01、對應上傳table:p_gat01進行自動編號，將單據編號l_doc_no返回 
######################################################################
#FUNCTION p200_auto_doc(p_gat01,p_azw01)      #FUN-CC0082 Mark
FUNCTION p200_auto_doc(p_gat01,p_azw01,p_pos) #FUN-CC0082 Add
DEFINE p_azw01     LIKE azw_file.azw01         #機構、門店
DEFINE p_gat01     LIKE gat_file.gat01         #table name
DEFINE p_pos       LIKE type_file.chr1         #是否取POS默認單別
DEFINE l_keyfld    LIKE gaq_file.gaq01         #column name
DEFINE li_result   LIKE type_file.num5         #flag
DEFINE l_doc_no    LIKE oga_file.oga01         #自動編號返回的單據編號 
DEFINE l_rye01     LIKE rye_file.rye01         #系統
DEFINE l_rye02     LIKE rye_file.rye02         #單據屬性
DEFINE l_rye04     LIKE rye_file.rye04         #POS默認單別
DEFINE l_sql       STRING
DEFINE l_ryl04     LIKE ryl_file.ryl04
DEFINE l_prog      LIKE type_file.chr10        #FUN-D10023 Add

   IF cl_null(g_fno1) THEN LET g_fno1 = 'Batch Operation' END IF #FUN-CB0103 Add

   CASE p_gat01 
      WHEN "oga_file"          #銷售
         LET l_rye01='axm'
         LET l_rye02='50'
         LET l_keyfld='oga01'
         LET l_ryl04 = '02'
         LET l_prog  = 'axmt620'  #對應程式代號 #FUN-D10023 Add
      WHEN "oea_file"          #訂單
         LET l_rye01='axm'
         LET l_rye02='30'
         LET l_keyfld='oea01'
         LET l_ryl04 = '01'
         LET l_prog  = 'axmt410'  #對應程式代號 #FUN-D10023 Add
      WHEN "oha_file"          #銷退
         LET l_rye01='axm'
         LET l_rye02='60'
         LET l_keyfld='oha01'
         LET l_ryl04 = '02'
         LET l_prog  = 'axmt700'  #對應程式代號 #FUN-D10023 Add
      WHEN "rxa_file"          #訂金退回
         LET l_rye01='art'
         LET l_rye02='B6'   
         LET l_keyfld='rxa01'     
         LET l_ryl04 = '03'
         LET l_prog  = 'artt700'  #對應程式代號 #FUN-D10023 Add

     #FUN-CA0160 Add Begin ---
      WHEN "rxe_file_2"        #售券
         LET l_rye01='axm'
         LET l_rye02='50'   
         LET l_keyfld='oga01'     
         LET l_ryl04 = '05'
         LET l_prog  = 'axmt620'  #對應程式代號 #FUN-D10023 Add
      WHEN "rxe_file_3"        #退券
         LET l_rye01='axm'
         LET l_rye02='60'   
         LET l_keyfld='oha01'     
         LET l_ryl04 = '05'
         LET l_prog  = 'axmt700'  #對應程式代號 #FUN-D10023 Add
      WHEN "lps_file"          #售卡
         LET l_rye01='alm'
         LET l_rye02='L8'   
         LET l_keyfld='lps01'     
         LET l_ryl04 = '04'
         LET l_prog  = 'almt610'  #對應程式代號 #FUN-D10023 Add
      WHEN "lpu_file"          #儲值
         LET l_rye01='alm'
         LET l_rye02='L9'   
         LET l_keyfld='lpu01'     
         LET l_ryl04 = '04'
         LET l_prog  = 'almt620'  #對應程式代號 #FUN-D10023 Add
      WHEN "lpv_file"          #退卡
         LET l_rye01='alm'
         LET l_rye02='M1'   
         LET l_keyfld='lpv01'     
         LET l_ryl04 = '04'
         LET l_prog  = 'almt630'  #對應程式代號 #FUN-D10023 Add
      WHEN "lru_file"          #退卡
         LET l_rye01='alm'
         LET l_rye02='N5'   
         LET l_keyfld='lru01'     
         LET l_ryl04 = '04'
         LET l_prog  = 'almt613'  #對應程式代號 #FUN-D10023 Add
      WHEN "lrw_file"          #換卡
         LET l_rye01='alm'
         LET l_rye02='N8'   
         LET l_keyfld='lrw01'     
         LET l_ryl04 = '04'
         LET l_prog  = 'almt616'  #對應程式代號 #FUN-D10023 Add
     #FUN-CA0160 Add End -----

     #FUN-CC0082 Add Begin ---
      WHEN "rxf_file"          #代收款单
         LET l_rye01='art'
         LET l_rye02='B7'   
         LET l_keyfld='rxf01'     
         LET l_ryl04 = '02'
         LET l_prog  = 'artt701'  #對應程式代號 #FUN-D10023 Add

      WHEN "ruo_file"          #调拨单
         LET l_rye01='art'
         LET l_rye02='J1'   
         LET l_keyfld='ruo01'     
         LET l_ryl04 = '02'
         LET l_prog  = 'artt256'  #對應程式代號 #FUN-D10023 Add

      WHEN "rvu_file"
         LET l_rye01='apm'
         LET l_rye02='7'   
         LET l_keyfld='rvu01'     
         LET l_ryl04 = '02'
         LET l_prog  = 'apmt720'  #對應程式代號 #FUN-D10023 Add
     #FUN-CC0082 Add End -----
         
      OTHERWISE
      CALL cl_err(p_gat01,'apc-999',1)  #
      LET g_success='N'
      EXIT CASE
   END CASE

   IF g_success='N' THEN RETURN '' END IF   
   IF cl_null(p_pos) THEN LET p_pos = 'N' END IF

  #FUN-CA0091 Add&Mark Begin ---
  #LET l_sql="SELECT rye04 FROM ",cl_get_target_table(p_azw01,'rye_file'),
  #          " WHERE rye01='",l_rye01,"' AND rye02='",l_rye02,"' ",
  #          "   AND ryeacti='Y'"
  #CALL cl_replace_sqldb(l_sql) RETURNING l_sql
  #CALL cl_parse_qry_sql(l_sql,p_azw01) RETURNING l_sql
  #PREPARE sel_rye04_pre FROM l_sql
  #EXECUTE sel_rye04_pre INTO l_rye04

                     #系統別  #單據別 #營運中心 #是否POS預設單別
  #CALL s_get_defslip(l_rye01,l_rye02,p_azw01,'Y') RETURNING l_rye04   #FUN-CC0082 Mark
   CALL s_get_defslip(l_rye01,l_rye02,p_azw01,p_pos) RETURNING l_rye04 #FUN-CC0082 Add
  #FUN-CA0091 Add&Mark End -----
   
   IF STATUS THEN
     #LET g_showmsg = 'SEL rye04'||' '||'SHOP:'||p_azw01||' '||'SALENO:'||g_fno1                     #FUN-D10023 Mark
      LET g_showmsg = 'SEL rye04'||' '||' Prog:'||l_prog||' SHOP:'||p_azw01||' '||' SALENO:'||g_fno1 #FUN-D10023 Add
      CALL s_errmsg('rye01',l_rye01,g_showmsg,'apc-999',1)
      LET g_success='N'
      LET g_errno = 'apc-999'
      ROLLBACK WORK
      LET g_msg1 = 'rye_file'||'SEL rye04'||p_azw01||g_fno1
      CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
      LET g_msg = g_msg[1,255]
      CALL p200_log(g_trans_no,p_azw01,g_fno1,l_ryl04,'TD_SALE',g_errno,g_msg,'0','N',g_msg1)
      LET g_errno = ''
      LET g_msg   = ''
      LET g_msg1  = ''
      LET g_showmsg = ''
      RETURN '' 
   END IF
 
   CALL s_auto_assign_no(l_rye01,l_rye04,g_ndate,l_rye02,p_gat01,l_keyfld,p_azw01,"","")
      RETURNING li_result,l_doc_no

   IF (NOT li_result) THEN 
      LET g_showmsg = 'AUTO doc_no'||' '||'SHOP:'||p_azw01||' '||'SALENO:'||g_fno1
      CALL s_errmsg('gat01',p_gat01,g_showmsg,'sub-145',1)
      LET g_success = 'N'
      LET g_errno = 'sub-145'
      ROLLBACK WORK
      LET g_msg1 = 'TD_SALE'||'AUTO doc_no'||p_azw01||g_fno1
      CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
      LET g_msg = g_msg[1,255]
      CALL p200_log(g_trans_no,p_azw01,g_fno1,l_ryl04,'TD_SALE',g_errno,g_msg,'0','N',g_msg1)
      LET g_errno = ''
      LET g_msg   = ''
      LET g_msg1  = ''
      LET g_showmsg = ''
      RETURN ''
   ELSE 
      RETURN l_doc_no
   END IF
END FUNCTION

FUNCTION p200_upd_posflag(p_ryk03,p_azw01,p_saleno,p_doc_no)        #回填標誌欄位
DEFINE p_ryk03  LIKE  ryk_file.ryk03
DEFINE p_azw01  LIKE  azw_file.azw01
DEFINE p_saleno LIKE  type_file.chr18
DEFINE l_upd    STRING
DEFINE l_today  LIKE  type_file.chr10
DEFINE p_doc_no LIKE  oga_file.oga01

   LET g_time = TIME
   IF g_success='N' THEN RETURN END IF 
   
   LET l_upd = "UPDATE ",g_posdbs,p_ryk03,g_db_links," ",
               "   SET condition2 = 'Y' ",
               " WHERE shop = '",p_azw01,"' ",
               "   AND saleno = '",p_saleno,"' ",
               "   AND condition2 = 'A' "

   PREPARE upd_pos_p_pre FROM l_upd
   EXECUTE upd_pos_p_pre
   IF SQLCA.sqlcode THEN
      LET g_success = 'N'
      LET g_errno = SQLCA.sqlcode
      LET g_showmsg = 'UPD CONDITION2'||' '||'SHOP:'||p_azw01||' '||'SALENO:'||p_saleno
      CALL s_errmsg('saleno',p_saleno,g_showmsg,SQLCA.sqlcode,1)
      ROLLBACK WORK
      LET g_msg1 = p_ryk03||'UPD CONDITION2'||p_azw01||p_saleno  
      CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
      LET g_msg = g_msg[1,255]
      CALL p200_log(g_trans_no,p_azw01,p_saleno,'02',p_ryk03,g_errno,g_msg,'0','N',g_msg1)
      LET g_errno = ''
      LET g_msg   = ''
      LET g_msg1  = ''
      LET g_showmsg = ''
      RETURN
   END IF

END FUNCTION

FUNCTION p200_chk_database(p_azw01)
DEFINE p_azw01  LIKE azw_file.azw01
DEFINE l_azp03  LIKE azp_file.azp03

   SELECT azp03 INTO l_azp03 FROM azp_file WHERE azp01 = p_azw01
   CALL cl_ins_del_sid(2,p_azw01) #刪除
   CLOSE DATABASE                 #關閉
   DATABASE l_azp03               #開啟
   CALL cl_ins_del_sid(1,p_azw01) #新增
   
   #重抓參數
   SELECT * INTO g_aza.* FROM aza_file WHERE aza01 = '0'
   SELECT * INTO g_sma.* FROM sma_file WHERE sma00 = '0'
   SELECT * INTO g_azw.* FROM azw_file WHERE azw01 = p_azw01
   SELECT * INTO g_oaz.* FROM oaz_file WHERE oaz00='0'
   SELECT * INTO g_aaz.* FROM aaz_file WHERE aaz00='0'
   LET g_plant = p_azw01
   CALL s_getlegal(p_azw01) RETURNING g_legal
END FUNCTION

FUNCTION p200_get_rxc12(p_azw01,p_date,p_prono,p_unit,p_pmtno)
DEFINE p_azw01    LIKE azw_file.azw01
DEFINE p_date     LIKE rtu_file.rtu09
DEFINE p_prono    LIKE rtv_file.rtv04
DEFINE p_unit     LIKE rtv_file.rtv14
DEFINE p_pmtno    LIKE rab_file.rab02
DEFINE l_sql      STRING
DEFINE l_rtu01_1  LIKE rtu_file.rtu01
DEFINE l_rtv02_1  LIKE rtv_file.rtv02
DEFINE l_rtv13_1  LIKE rtv_file.rtv13
DEFINE l_rtu05_1  LIKE rtu_file.rtu05
DEFINE l_rtu07_1  LIKE rtu_file.rtu07
DEFINE l_rtu08_1  LIKE rtu_file.rtu08
DEFINE l_rtu01_2  LIKE rtu_file.rtu01
DEFINE l_rtv02_2  LIKE rtv_file.rtv02
DEFINE l_rtv13_2  LIKE rtv_file.rtv13
DEFINE l_rtu05_2  LIKE rtu_file.rtu05

   LET l_sql = "SELECT rtu01,rtv02,rtv13,rtu05,rtu07,rtu08 ",
               "  FROM ",cl_get_target_table(p_azw01,'rtu_file'),",",
                         cl_get_target_table(p_azw01,'rtv_file'),
               " WHERE rtu01=rtv01 AND rtu02 = rtv02  ",
               "   AND '",p_date,"' BETWEEN rtu09 AND rtu10 ",
               "   AND rtv04 = '",p_prono,"' AND rtv14 = '",p_unit,"'",
               "   AND rtuplant = rtvplant AND rtuplant = '",p_azw01,"'"
   CALL cl_replace_sqldb(l_sql) RETURNING l_sql
   CALL cl_parse_qry_sql(l_sql,p_azw01) RETURNING l_sql
   PREPARE pre_sel3_rtv13 FROM l_sql
   EXECUTE pre_sel3_rtv13 INTO l_rtu01_1,l_rtv02_1,l_rtv13_1,l_rtu05_1,l_rtu07_1,l_rtu08_1
   IF cl_null(l_rtv13_1) OR l_rtv13_1 = 0 OR (l_rtu07_1<>'1' OR (l_rtu07_1='1' AND l_rtu08_1<>p_pmtno)) THEN
      LET l_sql = "SELECT A.rto01,A.rto03,A.rto05,A.rto12 FROM ",cl_get_target_table(p_azw01,'rto_file A'),
                  " WHERE A.rto05 = '",l_rtu05_1,"'",
                  "   AND '",p_date,"' BETWEEN A.rto08 AND A.rto09 ",
                  "   AND A.rtoplant = '",p_azw01,"'",
                  "   AND A.rtoconf = 'Y' ",
                  "   AND A.rto02 = (SELECT MAX(B.rto02) FROM ",cl_get_target_table(p_azw01,'rto_file B '),
                  "                   WHERE A.rto01=B.rto01 AND A.rto03=B.rto03 AND A.rtoplant = B.rtoplant) "
      CALL cl_replace_sqldb(l_sql) RETURNING l_sql
      CALL cl_parse_qry_sql(l_sql,g_plant_new) RETURNING l_sql
      PREPARE pre_sel_rto10 FROM l_sql
      EXECUTE pre_sel_rto10 INTO l_rtu01_2,l_rtv02_2,l_rtu05_2,l_rtv13_2
      IF SQLCA.sqlcode = 100 THEN
         RETURN l_rtv02_1,l_rtu05_1,l_rtu01_1
      ELSE
         RETURN l_rtv02_2,l_rtu05_2,l_rtu01_2
      END IF
   END IF

   RETURN l_rtv02_1,l_rtu05_1,l_rtu01_1
END FUNCTION

FUNCTION p200_ins_oap(p_azw01,p_oga01,p_oap041)
DEFINE p_azw01   LIKE azw_file.azw01
DEFINE p_oga01   LIKE oga_file.oga01
DEFINE p_oap041  LIKE oap_file.oap041
DEFINE l_oap     RECORD LIKE oap_file.*
DEFINE l_sql     STRING

   DELETE FROM oap_file WHERE oap01 = p_oga01
   LET l_oap.oap01 = p_oga01
   LET l_oap.oap041 = p_oap041
   LET l_sql = " INSERT INTO ",cl_get_target_table(p_azw01,'oap_file'),"( ",
               "        oap01,oap02,oap03,oap041, ",
               "        oap042,oap043,oap044,oap045) ",
               " VALUES(?,?,?,?,   ?,?,?,?) "
   CALL cl_replace_sqldb(l_sql) RETURNING l_sql
   CALL cl_parse_qry_sql(l_sql,p_azw01) RETURNING l_sql
   PREPARE ins_oap_pre FROM l_sql
   EXECUTE ins_oap_pre USING
           l_oap.oap01,l_oap.oap02,l_oap.oap03,l_oap.oap041,
           l_oap.oap042,l_oap.oap043,l_oap.oap044,l_oap.oap045
END FUNCTION

FUNCTION p200_upd_td_sale_ecsflg(p_azw01,p_oga16,p_oga02)
DEFINE p_azw01    LIKE azw_file.azw01
DEFINE p_oga16    LIKE oga_file.oga16
DEFINE p_oga02    LIKE oga_file.oga02
DEFINE l_upd      STRING
DEFINE l_sel      STRING

   LET l_upd = "UPDATE ",g_posdbs,"td_sale",g_db_links," ",
               "   SET ecsflg = 'Y', ",
              #"       ecsdate = '",p_oga02,"' ",                  #FUN-CB0103 Mark
               "       ecsdate = '",p_oga02 USING 'YYYYMMDD',"' ", #FUN-CB0103 Add
               " WHERE shop = '",p_azw01,"' ",
               "   AND saleno = '",p_oga16,"' "

   PREPARE upd_pos_ecsflg_pre FROM l_upd
   EXECUTE upd_pos_ecsflg_pre
   IF SQLCA.sqlcode THEN
      LET g_success = 'N'
      LET g_errno = SQLCA.sqlcode
      LET g_showmsg = 'UPD ECSFLAG/ECSDATE'||' '||'SHOP:'||p_azw01||' '||'SALENO:'||p_oga16
      CALL s_errmsg('saleno',p_oga16,g_showmsg,SQLCA.sqlcode,1)
      ROLLBACK WORK 
      LET g_msg1 = 'TD_SALE'||'UPD ECSFLAG/ECSDATE'||p_azw01||p_oga16
      CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
      LET g_msg = g_msg[1,255]
      CALL p200_log(g_trans_no,p_azw01,p_oga16,'02','TD_SALE',g_errno,g_msg,'0','N',g_msg1)
      LET g_errno = ''
      LET g_msg   = ''
      LET g_msg1  = ''
      LET g_showmsg = ''
      RETURN
   END IF 
END FUNCTION

FUNCTION p200_upd_td_sale_detail_rqty(p_azw01,p_oha16,p_ohb32,p_ohb12)
DEFINE p_azw01   LIKE azw_file.azw01
DEFINE p_oha16   LIKE oha_file.oha16
DEFINE p_ohb32   LIKE ohb_file.ohb32
DEFINE p_ohb12   LIKE ohb_file.ohb12
DEFINE l_upd     STRING

   LET l_upd = "UPDATE ",g_posdbs,"td_sale_detail",g_db_links," ",
               "   SET rqty = rqty + ",p_ohb12," ",
               " WHERE shop = '",p_azw01,"' ",
               "   AND saleno = '",p_oha16,"' ",
               "   AND item = ",p_ohb32," "
   PREPARE upd_pos_rqty_pre FROM l_upd
   EXECUTE upd_pos_rqty_pre
   IF SQLCA.sqlcode THEN
      LET g_success = 'N'
      LET g_errno = SQLCA.sqlcode
      LET g_showmsg = 'UPD RQTY'||' '||'SHOP:'||p_azw01||' '||'SALENO:'||p_oha16||' '||'ITEM:'||p_ohb32
      CALL s_errmsg('saleno',p_oha16,g_showmsg,SQLCA.sqlcode,1)
      ROLLBACK WORK
      LET g_msg1 = 'TD_SALE_DETAIL'||'UPD RQTY'||p_azw01||p_oha16
      CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
      LET g_msg = g_msg[1,255]
      CALL p200_log(g_trans_no,p_azw01,p_oha16,'02','TD_SALE_DETAIL',g_errno,g_msg,'0','N',g_msg1)
      LET g_errno = ''
      LET g_msg   = ''
      LET g_msg1  = ''
      LET g_showmsg = ''
      RETURN
   END IF
END FUNCTION

#FUN-CA0160 Add Begin ---
#发卡信息上传
FUNCTION p200_lps_ins_p(p_gat01,p_azw01)
DEFINE p_gat01       LIKE gat_file.gat01
DEFINE p_azw01       LIKE azw_file.azw01
DEFINE p_azw02       LIKE azw_file.azw02
DEFINE l_ins         STRING
DEFINE l_sel         STRING
DEFINE l_sql         STRING
DEFINE l_upd         STRING
DEFINE l_upd_num     LIKE type_file.num10
DEFINE l_lps01_min_o LIKE lps_file.lps01
DEFINE l_lps01_max_o LIKE lps_file.lps01
DEFINE l_lps03_old   LIKE lps_file.lps03
DEFINE l_lps03       LIKE lps_file.lps03
DEFINE l_lps03_num   LIKE type_file.num10
DEFINE l_lps01_min   LIKE lps_file.lps01
DEFINE l_lps01_max   LIKE lps_file.lps01
DEFINE l_lps01_str   STRING
DEFINE l_lps01       LIKE lps_file.lps01
DEFINE l_lps01_num   LIKE type_file.chr20
DEFINE l_lps01_chr   LIKE type_file.chr20
DEFINE l_oga01       LIKE oga_file.oga01
DEFINE l_oga01_str   STRING
DEFINE l_oga01_num   LIKE type_file.chr20
DEFINE l_oga01_chr   LIKE type_file.chr20
DEFINE l_azn05_old   LIKE azn_file.azn05
DEFINE l_azn05       LIKE azn_file.azn05
DEFINE l_num_len     LIKE type_file.num10
DEFINE l_num_str     LIKE type_file.chr20
DEFINE l_cnt         LIKE type_file.num10

   #组出过滤条件
   IF NOT cl_null(g_saleno) THEN
      LET g_wc = " SaleCardno = '",g_saleno,"' "
   ELSE
      CALL p200_g_wc("lps_file") RETURNING g_wc
   END IF
   IF cl_null(g_wc) THEN LET g_wc = " 1=1" END IF

   SELECT azw02 INTO p_azw02 FROM azw_file WHERE azw01 = p_azw01
   
   #将中间库中满足条件的单据Condition2更新为B
   LET l_upd = "UPDATE ",g_posdbs,"tg_SaleCard",g_db_links," ",
               "   SET Condition2 = 'B' ",
               " WHERE Condition2 <> 'Y' AND Type = '0' AND Cnfflg = 'Y' AND Shop = '",p_azw01 CLIPPED,"' AND ",g_wc CLIPPED
   PREPARE salecard_upd_tg_salecard_lps_pre FROM l_upd
   EXECUTE salecard_upd_tg_salecard_lps_pre
   IF SQLCA.sqlcode THEN
      LET g_success = 'N'
      LET g_errno   = SQLCA.sqlcode
      LET g_msg1    = 'Oper:Upd'||' '||'Table:tg_SaleCard'||' '||'Shop:'||p_azw01
      CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
      ROLLBACK WORK 
      CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
      LET g_msg   = g_msg[1,255]
      CALL p200_log(g_trans_no,p_azw01,'Batch Operation','05','tg_SaleCard',g_errno,g_msg,'0','N',g_msg1)
      LET g_errno = ''
      LET g_msg   = ''
      LET g_msg1  = ''
      RETURN
   END IF
   
   LET l_upd_num = SQLCA.sqlerrd[3]           #本次需上传总笔数
   IF l_upd_num <= 0 THEN RETURN END IF
   IF cl_null(g_sum_limit) OR g_sum_limit = 0 THEN LET g_sum_limit = l_upd_num END IF
   
   #先删除需要建立的临时表
   DROP TABLE lps_temp
   DROP TABLE lpt_temp
   DROP TABLE oga_temp
   DROP TABLE ogb_temp
   DROP TABLE ogh_temp      #FUN-D20096 Add
   DROP TABLE ogi_temp      #FUN-D20096 Add
   DROP TABLE rxx_temp
   DROP TABLE rxy_temp
   DROP TABLE rxz_temp
   
   #建立临时表
   SELECT * FROM lps_file WHERE 1=0 INTO TEMP lps_temp
   SELECT * FROM lpt_file WHERE 1=0 INTO TEMP lpt_temp
   SELECT * FROM oga_file WHERE 1=0 INTO TEMP oga_temp
   SELECT * FROM ogb_file WHERE 1=0 INTO TEMP ogb_temp
   SELECT * FROM ogh_file WHERE 1=0 INTO TEMP ogh_temp     #FUN-D20096 Add
   SELECT * FROM ogi_file WHERE 1=0 INTO TEMP ogi_temp     #FUN-D20096 Add
   SELECT * FROM rxx_file WHERE 1=0 INTO TEMP rxx_temp
   SELECT * FROM rxy_file WHERE 1=0 INTO TEMP rxy_temp
   SELECT * FROM rxz_file WHERE 1=0 INTO TEMP rxz_temp
   
   #建立索引

   WHILE l_upd_num > 0                        #剩余笔数大于0做WHILE循环
      LET l_upd_num = l_upd_num - g_sum_limit #依次减去每批的笔数
      
      #清空临时表
      DELETE FROM lps_temp
      DELETE FROM lpt_temp
      DELETE FROM oga_temp
      DELETE FROM ogb_temp
      DELETE FROM ogh_temp       #FUN-D20096 Add
      DELETE FROM ogi_temp       #FUN-D20096 Add
      DELETE FROM rxx_temp
      DELETE FROM rxy_temp
      DELETE FROM rxz_temp
      
      LET g_success = 'Y'
      BEGIN WORK
      
      LET l_ins = "INSERT INTO lps_temp( ",
                  "                     lps01, ",      #单据编号        
                  "                     lps02, ",      #no use          
                  "                     lps03, ",      #单据日期        
                  "                     lps04, ",      #消费金额底线合计
                  "                     lps05, ",      #卡内金额合计    
                  "                     lps06, ",      #折扣金额        
                  "                     lps061, ",     #折扣比率        
                  "                     lps07, ",      #付款金额合计    
                  "                     lps08, ",      #发卡原因编号    
                  "                     lps09, ",      #审核码          
                  "                     lps10, ",      #审核人          
                  "                     lps11, ",      #审核日期        
                  "                     lps12, ",      #备注            
                  "                     lps13, ",      #已付款金额      
                  "                     lps14, ",      #账款编号        
                  "                     lps15, ",      #单张购卡金额    
                  "                     lps16, ",      #购卡金额合计    
                  "                     lps17, ",      #对应出货单号
                  "                     lps18, ",      #POS单号
                  "                     lpsacti, ",    #资料有效码      
                  "                     lpscrat, ",    #资料创建日      
                  "                     lpsdate, ",    #资料更改日      
                  "                     lpsgrup, ",    #资料所有群      
                  "                     lpslegal, ",   #法人            
                  "                     lpsmodu, ",    #资料更改者      
                  "                     lpsplant, ",   #门店编号        
                  "                     lpsuser, ",    #资料所有者      
                  "                     lpsoriu, ",    #资料建立者      
                  "                     lpsorig) "     #资料建立部门    
      LET l_sel = "SELECT ",
                  "       ROW_NUMBER() over(order by Bdate,SaleCardno), ",  #lps01          #单据编号        
                  "       NULL, ",                                          #lps02          #no use          
                  "       CAST(Bdate AS DATE), ",                           #lps03          #单据日期        
                  "       0, ",                                             #lps04          #消费金额底线合计
                 #"       Tot_RechargeAmt, ",                               #lps05          #卡内金额合计    #FUN-CB0103 Mark
                  "       0, ",                                             #lps05          #卡内金额合计    #FUN-CB0103 Add
                  "       NULL, ",                                          #lps06          #折扣金额        
                  "       NULL, ",                                          #lps061         #折扣比率        
                  "       0, ",                                             #lps07          #付款金额合计    
                  "       NULL, ",                                          #lps08          #发卡原因编号    
                  "       'Y', ",                                           #lps09          #审核码          
                  "       ryi02, ",                                         #lps10          #审核人          
                 #"       CAST(Bdate AS DATE), ",                           #lps11          #审核日期  #FUN-D10144 Mark
                  "       CAST(Sdate AS DATE), ",                           #lps11          #审核日期  #FUN-D10144 Add
                  "       NULL, ",                                          #lps12          #备注            
                  "       NULL, ",                                          #lps13          #已付款金额      
                  "       NULL, ",                                          #lps14          #账款编号        
                  "       NULL, ",                                          #lps15          #单张购卡金额    
                  "       Tot_CostAmt, ",                                   #lps16          #购卡金额合计    
                  "       ROW_NUMBER() over(order by Bdate,SaleCardno), ",  #lps17          #对应出货单号
                  "       SaleCardno, ",                                    #lps18          #POS单号
                  "       'Y', ",                                           #lpsacti        #资料有效码      
                 #"       CAST(Bdate AS DATE), ",                           #lpscrat        #资料创建日      #FUN-D10144 Mark
                  "       CAST(Sdate AS DATE), ",                           #lpscrat        #资料创建日      #FUN-D10144 Add
                 #"       CAST(Bdate AS DATE), ",                           #lpsdate        #资料更改日      #FUN-D10144 Mark
                  "       CAST(Sdate AS DATE), ",                           #lpsdate        #资料更改日      #FUN-D10144 Add
                  "       gen03, ",                                         #lpsgrup        #资料所有群      
                  "       '",p_azw02,"', ",                                 #lpslegal       #法人            
                  "       ryi02, ",                                         #lpsmodu        #资料更改者      
                  "       Shop, ",                                          #lpsplant       #门店编号        
                  "       ryi02, ",                                         #lpsuser        #资料所有者      
                  "       ryi02, ",                                         #lpsoriu        #资料建立者      
                  "       gen03 ",                                          #lpsorig        #资料建立部门    
                  "  FROM ( ",
                  "SELECT * ",
                  "  FROM ",g_posdbs,"tg_SaleCard",g_db_links," ",
                  " WHERE Shop = '",p_azw01,"' AND Condition2 = 'B' AND Type = '0' AND Cnfflg = 'Y' ",
                  " ORDER BY Bdate,SaleCardno) LEFT OUTER JOIN ",cl_get_target_table(p_azw01,'ryi_file'),
                  "                                         ON ryi01 = opno ",
                  "                            LEFT OUTER JOIN ",cl_get_target_table(p_azw01,'gen_file'),
                  "                                         ON gen01 = ryi02 ",
                  " WHERE ROWNUM <= ",g_sum_limit," ",
                  " ORDER BY Bdate,SaleCardno "
      LET l_sql = l_ins CLIPPED," ",l_sel CLIPPED
      PREPARE ins_lps_temp_pre FROM l_sql
      EXECUTE ins_lps_temp_pre
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Ins'||' '||'Table:lps_temp'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','05','tg_SaleCard',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CONTINUE WHILE
      END IF
      
      INITIALIZE l_lps03_old,l_lps01_min_o,l_lps01_max_o,l_azn05_old TO NULL                                    
      INITIALIZE l_lps03,l_lps03_num,l_lps01_min,l_lps01_max,l_azn05 TO NULL
      LET l_sql = "SELECT DISTINCT MIN(to_number(lps01)),lps03,MAX(to_number(lps01)) FROM lps_temp GROUP BY lps03 order by lps03"
      PREPARE salecard_sel_lps03_pre FROM l_sql
      DECLARE salecard_sel_lps03_cs CURSOR FOR salecard_sel_lps03_pre
      FOREACH salecard_sel_lps03_cs INTO l_lps01_min,l_lps03,l_lps01_max
      
         #自动编号
         LET g_ndate = l_lps03
        #CALL p200_auto_doc(p_gat01,p_azw01) RETURNING l_lps01     #FUN-CC0082 Mark
         CALL p200_auto_doc(p_gat01,p_azw01,'Y') RETURNING l_lps01 #FUN-CC0082 Add
         IF g_success = 'N' THEN
            EXIT WHILE
         END IF
        #CALL p200_auto_doc("oga_file",p_azw01) RETURNING l_oga01     #FUN-CC0082 Mark
         CALL p200_auto_doc("oga_file",p_azw01,'Y') RETURNING l_oga01 #FUN-CC0082 Add
         IF g_success = 'N' THEN
            EXIT WHILE
         END IF
         
         CASE g_ryz05
            WHEN "1"
               LET l_num_len = 8
            WHEN "2"
               LET l_num_len = 9
            WHEN "3"
               LET l_num_len = 10
         END CASE
         
         CASE g_ryz06
            WHEN "1" #按流水号
               LET l_num_len = l_num_len
               IF NOT cl_null(l_lps03_old) THEN
                  #已排流水号个数 = 最大流水号旧值- 最小流水号旧值+ 1 + 上一笔已排流水号个数
                  LET l_lps03_num = l_lps01_max_o - l_lps01_min_o + 1 + l_lps03_num
               ELSE
                  LET l_lps03_num = 0
               END IF
            WHEN "2" #按年月
               LET l_num_len = l_num_len - 4
               IF NOT cl_null(l_lps03_old) THEN 
                  IF YEAR(l_lps03_old) = YEAR(l_lps03) AND MONTH(l_lps03_old) = MONTH(l_lps03) THEN
                     LET l_lps03_num = l_lps01_max_o - l_lps01_min_o + 1 + l_lps03_num
                  ELSE
                     LET l_lps03_num = 0
                  END IF
               ELSE
                  LET l_lps03_num = 0
               END IF
            WHEN "3" #按年周
               LET l_num_len = l_num_len - 4
               IF NOT cl_null(l_lps03_old) THEN
                  INITIALIZE l_azn05 TO NULL
                  SELECT azn05 INTO l_azn05 FROM azn_file WHERE azn01 = l_lps03
                  IF YEAR(l_lps03_old) = YEAR(l_lps03) AND l_azn05_old = l_azn05 THEN
                     LET l_lps03_num = l_lps01_max_o - l_lps01_min_o + 1 + l_lps03_num
                  ELSE
                     LET l_lps03_num = 0
                  END IF
               ELSE
                  LET l_lps03_num = 0
               END IF
            WHEN "4" #按年月日
               LET l_num_len = l_num_len - 6
              #FUN-D30061 Mark&Add Begin ---
              #IF NOT cl_null(l_lps03_old) THEN
              #   LET l_lps03_num = l_lps01_max_o - l_lps01_min_o + 1 + l_lps03_num
              #ELSE
              #   LET l_lps03_num = 0
              #END IF
               LET l_lps03_num = 0
              #FUN-D30061 Mark&Add End -----
         END CASE
            
         LET l_lps01_min_o = l_lps01_min
         LET l_lps01_max_o = l_lps01_max
         LET l_azn05_old   = l_azn05
         LET l_lps03_old   = l_lps03
               
         INITIALIZE l_num_str TO NULL
         FOR l_cnt = 1 TO l_num_len
            LET l_num_str = l_num_str CLIPPED,'0'
         END FOR
         LET l_lps01_str = l_lps01
         LET l_lps01_num = l_lps01_str.subString(l_lps01_str.getLength() - l_num_len + 1,l_lps01_str.getLength())
         LET l_lps01_chr = l_lps01_str.subString(1,l_lps01_str.getLength() - l_num_len)
         #   最大流水号  = 实际流水号  - 最小ROWNUM  + 已排流水号个数
         LET l_lps01_num = l_lps01_num - l_lps01_min + l_lps03_num
         LET l_oga01_str = l_oga01
         LET l_oga01_num = l_oga01_str.subString(l_oga01_str.getLength() - l_num_len + 1,l_oga01_str.getLength())
         LET l_oga01_chr = l_oga01_str.subString(1,l_oga01_str.getLength() - l_num_len)
         #   最大流水号  = 实际流水号  - 最小ROWNUM  + 已排流水号个数
         LET l_oga01_num = l_oga01_num - l_lps01_min + l_lps03_num
         
         #批次更新oea_temp中的单号
         LET l_upd = "UPDATE lps_temp SET lps01 = '",l_lps01_chr CLIPPED,"'||","substr(to_char","((lps01 + '",l_lps01_num,"'),'",l_num_str,"'),2), ",
                     "                    lps17 = '",l_oga01_chr CLIPPED,"'||","substr(to_char","((lps17 + '",l_oga01_num,"'),'",l_num_str,"'),2) ",
                     " WHERE lps03 = '",l_lps03,"' "
         PREPARE salecard_upd_lps01_pre FROM l_upd
         EXECUTE salecard_upd_lps01_pre
         IF SQLCA.sqlcode THEN
            LET g_success = 'N'
            LET g_errno   = SQLCA.sqlcode
            LET g_msg1    = 'Oper:Upd'||' '||'Table:lps_temp'||' '||'Field:lps01/lps17'||' '||'Shop:'||p_azw01
            CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
            ROLLBACK WORK
            CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
            LET g_msg   = g_msg[1,255]
            CALL p200_log(g_trans_no,p_azw01,'Batch Operation','05','tg_SaleCard',g_errno,g_msg,'0','N',g_msg1)
            LET g_errno = ''
            LET g_msg   = ''
            LET g_msg1  = ''
            CONTINUE WHILE
         END IF
      END FOREACH

      #检查出货单单据日期
      INITIALIZE l_lps03 TO NULL
      SELECT MIN(lps03) INTO l_lps03 FROM lps_temp WHERE lps03 <= g_sma.sma53
      IF NOT cl_null(l_lps03) THEN
         LET g_errno   = 'apc1054' #该批次资料中存在最小单据日期小于等于关帐日期
         LET g_msg1    = 'Oper:Chk'||' '||'Table:lps_temp'||' '||'MIN(lps03):'||l_lps03||' '||'Shop:'||p_azw01
        #CALL s_errmsg('Batch Operation','',g_msg1,SQLCA.sqlcode,1) #FUN-CB0103 Mark
         CALL s_errmsg('Batch Operation','',g_msg1,g_errno,1)       #FUN-CB0103 Add
         ROLLBACK WORK 
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','05','TG_SALECARD',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
      END IF 
      
      #更新中间库状态为A
      LET l_upd = "UPDATE ",g_posdbs,"tg_SaleCard",g_db_links," ",
                  "   SET Condition2 = 'A' ", 
                  " WHERE Shop = '",p_azw01,"' ",
                  "   AND EXISTS (SELECT 1 ", 
                  "                 FROM lps_temp ",   
                  "                WHERE lps03 <= '",g_sma.sma53,"' ",
                  "                  AND lps18 = SaleCardno) "
      PREPARE salecard_upd_tg_salecard_flag_lps_pre2 FROM l_upd
      EXECUTE salecard_upd_tg_salecard_flag_lps_pre2 
      
      #删除出货日期小于等于关帐日期的资料
      DELETE FROM lps_temp WHERE lps03 <= g_sma.sma53
      
      LET l_ins = "INSERT INTO lpt_temp( ",
                  "                     lpt00, ",     #no use        
                  "                     lpt01, ",     #单据编号      
                  "                     lpt02, ",     #開始卡号      
                  "                     lpt021, ",    #结束卡号      
                  "                     lpt03, ",     #卡种编号      
                  "                     lpt04, ",     #该卡属        
                  "                     lpt05, ",     #消费金额底线  
                  "                     lpt06, ",     #购卡金额      
                  "                     lpt07, ",     #总消费金额底线
                  "                     lpt08, ",     #总购卡金额    
                  "                     lpt09, ",     #单张卡内金额  
                  "                     lpt10, ",     #总卡内金额    
                  "                     lpt11, ",     #折扣比率      
                  "                     lpt12, ",     #总折扣金额    
                  "                     lpt13, ",     #付款金额      
                  "                     lpt14, ",     #有效期至      
                  "                     lpt15, ",     #会员编号      
                  "                     lpt16, ",     #余額有效期至  
                  "                     lpt17, ",     #加值金額
                  "                     lptlegal, ",  #法人          
                  "                     lptplant) "   #门店编号      
      LET l_sel = "SELECT ",
                  "       NULL, ",                                            #lpt00         #no use        
                  "       lps01, ",                                           #lpt01         #单据编号      
                  "       BeginCard, ",                                       #lpt02         #開始卡号      
                  "       EndCard, ",                                         #lpt021        #结束卡号      
                  "       Ctno, ",                                            #lpt03         #卡种编号      
                  "       lph21, ",                                           #lpt04         #该卡属        
                  "       CASE lph21 WHEN '0' THEN lph22 ELSE 0 END, ",       #lpt05         #消费金额底线  
                  "       CostAmt, ",                                         #lpt06         #购卡金额      
                  "       CASE lph21 WHEN '0' THEN lph22*Qty ELSE 0 END, ",   #lpt07         #总消费金额底线
                  "       CostAmt*Qty, ",                                     #lpt08         #总购卡金额    
                  "       RechargeAmt, ",                                     #lpt09         #单张卡内金额  
                  "       RealAmt*Qty, ",                                     #lpt10         #总卡内金额    
                  "       100, ",                                             #lpt11         #折扣比率      
                  "       Disc, ",                                            #lpt12         #总折扣金额    
                  "       Amt, ",                                             #lpt13         #付款金额      
                  "       NULL, ",                                            #lpt14         #有效期至      
                  "       MemberNo, ",                                        #lpt15         #会员编号      
                  "       NULL, ",                                            #lpt16         #余額有效期至  
                  "       (RealAmt-RechargeAmt)*Qty, ",                       #lpt17         #加值金額
                  "       '",p_azw02,"', ",                                   #lptlegal      #法人          
                  "       Shop ",                                             #lptplant      #门店编号      
                  "  FROM ",g_posdbs,"tg_SaleCard_Detail",g_db_links,
                  "       LEFT OUTER JOIN lph_file ON lph01 = Ctno ",
                  "      ,lps_temp ",
                  " WHERE Shop = '",p_azw01,"' AND Cnfflg = 'Y' AND SaleCardno = lps18 ",
                  " ORDER BY item "
      LET l_sql = l_ins CLIPPED," ",l_sel CLIPPED
      PREPARE salecard_ins_lpt_temp_pre FROM l_sql
      EXECUTE salecard_ins_lpt_temp_pre
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Ins'||' '||'Table:lpt_temp'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','05','tg_SaleCard_Detail',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'tg_SaleCard',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF
      
      #报错不存在lpt的lps
      LET l_cnt = 0
      SELECT COUNT(*) INTO l_cnt FROM lps_temp WHERE lps01 NOT IN (SELECT lpt01 FROM lpt_temp)
      IF l_cnt > 0 THEN
         LET g_errno   = 'apc1051' #存在单身无资料的单据
         LET g_msg1    = 'Oper:Chk'||' '||'Table:lps_temp'||' '||'Shop:'||p_azw01
        #CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1) #FUN-CB0103 Mark
         CALL s_errmsg('Batch Operation:','',g_msg1,g_errno,1)       #FUN-CB0103 Add
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','05','TG_SALECARD',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
      END IF
      
      #更新中间库Condition2 = 'A'
      LET l_upd = "UPDATE ",g_posdbs,"tg_SaleCard",g_db_links," ",
                  "   SET Condition2 = 'A' ",
                  " WHERE Shop = '",p_azw01,"' ",
                  "   AND EXISTS (SELECT 1 ",
                  "                 FROM lps_temp ",
                  "                WHERE lps01 NOT IN (SELECT lpt01 FROM lpt_temp) ",
                  "                  AND lps18 = SaleCardno) "
      PREPARE salecard_upd_tg_sale_flag_lps_pre FROM l_upd
      EXECUTE salecard_upd_tg_sale_flag_lps_pre
      
      #删除不存在lpt的lps
      DELETE FROM lps_temp WHERE lps01 NOT IN (SELECT lpt01 FROM lpt_temp)

     #FUN-CB0103 Add Begin ---
     #更新单头卡内金额合计
      LET l_upd = "UPDATE lps_temp ",
                  "   SET lps05 = (SELECT SUM(lpt10) FROM lpt_temp WHERE lpt01 = lps01) "
      PREPARE salecard_upd_lps05_pre FROM l_upd
      EXECUTE salecard_upd_lps05_pre
     #FUN-CB0103 Add End -----
      
      #ins xyz
      CALL p200_cardcoupon_xyz_ins_p("lps_file",p_azw01)
      IF g_success='N' THEN
      END IF

      #更新lps中的付款金额合计lps07
      LET l_upd = "UPDATE lps_temp ",
                  "   SET lps07 = (SELECT SUM(lpt13) FROM lpt_temp WHERE lpt01 = lps01) "
      PREPARE salecard_upd_lps07_pre FROM l_upd
      EXECUTE salecard_upd_lps07_pre
      
      #更新lps中的已付款金额lps13
      LET l_upd = "UPDATE lps_temp ",
                  "   SET lps13 = COALESCE((SELECT SUM(rxy05) ",
                  "                           FROM rxy_temp ",
                  "                          WHERE rxy00 = '20' ",
                  "                            AND rxy01 = lps01 ",
                  "                            AND rxyplant = lpsplant),0) "
      PREPARE salecard_upd_lps13_pre FROM l_upd
      EXECUTE salecard_upd_lps13_pre
      
      #产生出货单以及付款资料
      CALL p200_prod_oga_p('1',p_azw01)
      IF g_success = 'N' THEN
         CALL p200_upd_posflag_p('2',p_gat01,'tg_SaleCard',p_azw01) #将对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF
      
      #将临时表lps_temp插入到数据库中
      LET l_ins = " INSERT INTO ",cl_get_target_table(p_azw01,'lps_file'),
                  " SELECT * FROM lps_temp "
      CALL cl_replace_sqldb(l_ins) RETURNING l_ins
      CALL cl_parse_qry_sql(l_ins,p_azw01) RETURNING l_ins
      PREPARE salecard_ins_lps_pre FROM l_ins
      EXECUTE salecard_ins_lps_pre
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Ins'||' '||'Table:lps_file'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','05','TG_SALECARD',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'tg_SaleCard',p_azw01) #将对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF
      
      #将临时表lpt_temp插入到数据库中
      LET l_ins = " INSERT INTO ",cl_get_target_table(p_azw01,'lpt_file'),
                  " SELECT * FROM lpt_temp "
      CALL cl_replace_sqldb(l_ins) RETURNING l_ins
      CALL cl_parse_qry_sql(l_ins,p_azw01) RETURNING l_ins
      PREPARE salecard_ins_lpt_pre FROM l_ins
      EXECUTE salecard_ins_lpt_pre
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Ins'||' '||'Table:lpt_file'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','05','TG_SALECARD',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'tg_SaleCard',p_azw01) #将对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF
      
      #将临时表oga_temp插入到数据库中
      LET l_ins = " INSERT INTO ",cl_get_target_table(p_azw01,'oga_file'),
                  " SELECT * FROM oga_temp "
      CALL cl_replace_sqldb(l_ins) RETURNING l_ins
      CALL cl_parse_qry_sql(l_ins,p_azw01) RETURNING l_ins
      PREPARE salecard_ins_oga_lps_pre FROM l_ins
      EXECUTE salecard_ins_oga_lps_pre
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Ins'||' '||'Table:oga_file'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','05','TG_SALECARD',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'tg_SaleCard',p_azw01) #将对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF
      
      #将临时表ogb_temp插入到数据库中
      LET l_ins = " INSERT INTO ",cl_get_target_table(p_azw01,'ogb_file'),
                  " SELECT * FROM ogb_temp "
      CALL cl_replace_sqldb(l_ins) RETURNING l_ins
      CALL cl_parse_qry_sql(l_ins,p_azw01) RETURNING l_ins
      PREPARE salecard_ins_ogb_lps_pre FROM l_ins
      EXECUTE salecard_ins_ogb_lps_pre
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Ins'||' '||'Table:ogb_file'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','05','TG_SALECARD',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'tg_SaleCard',p_azw01) #将对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF

      #FUN-D20096---Add---Str
      #将临时表ogh_temp插入到数据库中
      LET l_ins = " INSERT INTO ",cl_get_target_table(p_azw01,'ogh_file'),
                  " SELECT * FROM ogh_temp "
      CALL cl_replace_sqldb(l_ins) RETURNING l_ins
      CALL cl_parse_qry_sql(l_ins,p_azw01) RETURNING l_ins
      PREPARE salecard_ins_ogh_lps_pre FROM l_ins
      EXECUTE salecard_ins_ogh_lps_pre
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Ins'||' '||'Table:ogh_file'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','05','tg_SaleCard_Tax',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'tg_SaleCard_Tax',p_azw01) #将对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF
      
      #将临时表ogi_temp插入到数据库中
      LET l_ins = " INSERT INTO ",cl_get_target_table(p_azw01,'ogi_file'),
                  " SELECT * FROM ogi_temp "
      CALL cl_replace_sqldb(l_ins) RETURNING l_ins
      CALL cl_parse_qry_sql(l_ins,p_azw01) RETURNING l_ins
      PREPARE salecard_ins_ogi_lps_pre FROM l_ins
      EXECUTE salecard_ins_ogi_lps_pre
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Ins'||' '||'Table:ogi_file'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','05','tg_SaleCard_Detail_Tax',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'tg_SaleCard_Detail_Tax',p_azw01) #将对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF
      #FUN-D20096---Add---End
      
      #将临时表rxx_temp插入到数据库中
      LET l_ins = " INSERT INTO ",cl_get_target_table(p_azw01,'rxx_file'),
                  " SELECT * FROM rxx_temp "
      CALL cl_replace_sqldb(l_ins) RETURNING l_ins
      CALL cl_parse_qry_sql(l_ins,p_azw01) RETURNING l_ins
      PREPARE salecard_ins_rxx_lps_pre FROM l_ins
      EXECUTE salecard_ins_rxx_lps_pre
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Ins'||' '||'Table:rxx_file'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','05','TG_SALECARD',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'tg_SaleCard',p_azw01) #将对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF
      
      #将临时表rxy_temp插入到数据库中
      LET l_ins = " INSERT INTO ",cl_get_target_table(p_azw01,'rxy_file'),
                  " SELECT * FROM rxy_temp "
      CALL cl_replace_sqldb(l_ins) RETURNING l_ins
      CALL cl_parse_qry_sql(l_ins,p_azw01) RETURNING l_ins
      PREPARE salecard_ins_rxy_lps_pre FROM l_ins
      EXECUTE salecard_ins_rxy_lps_pre
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Ins'||' '||'Table:rxy_file'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','05','TG_SALECARD',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'tg_SaleCard',p_azw01) #将对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF
      
      #将临时表rxz_temp插入到数据库中
      LET l_ins = " INSERT INTO ",cl_get_target_table(p_azw01,'rxz_file'),
                  " SELECT * FROM rxz_temp "
      CALL cl_replace_sqldb(l_ins) RETURNING l_ins
      CALL cl_parse_qry_sql(l_ins,p_azw01) RETURNING l_ins
      PREPARE salecard_ins_rxz_lps_pre FROM l_ins
      EXECUTE salecard_ins_rxz_lps_pre
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Ins'||' '||'Table:rxz_file'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','05','TG_SALECARD',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'tg_SaleCard',p_azw01) #将对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF

      #更新中间库标志位
      CALL p200_upd_posflag_p("1","lps_file","tg_SaleCard",p_azw01)
      IF g_success = 'N' THEN
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Upd'||' '||'Table:tg_Recharge'||' '||'Field:Condition2'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','05','TG_SALECARD',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'tg_SaleCard',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF
      
      IF g_success = 'Y' THEN
         LET g_sucflag = 1
         COMMIT WORK
      ELSE
         ROLLBACK WORK
      END IF
   END WHILE
   #删除建立的临时表
   DROP TABLE lps_temp
   DROP TABLE lpt_temp
   DROP TABLE oga_temp
   DROP TABLE ogb_temp
   DROP TABLE ogh_temp  #FUN-D20096 Add
   DROP TABLE ogi_temp  #FUN-D20096 Add
   DROP TABLE rxx_temp
   DROP TABLE rxy_temp
   DROP TABLE rxz_temp
END FUNCTION
#FUN-CA0160 Add End -----

#FUN-CA0160 Add Begin ---
#退卡 - 可儲值
FUNCTION p200_lpv_ins_p(p_gat01,p_azw01)
DEFINE p_gat01       LIKE gat_file.gat01
DEFINE p_azw01       LIKE azw_file.azw01
DEFINE p_azw02       LIKE azw_file.azw02
DEFINE l_ins         STRING
DEFINE l_sel         STRING
DEFINE l_sql         STRING
DEFINE l_upd         STRING
DEFINE l_upd_num     LIKE type_file.num10
DEFINE l_lpv01_min_o LIKE lpv_file.lpv01
DEFINE l_lpv01_max_o LIKE lpv_file.lpv01
DEFINE l_lpv10_old   LIKE lpv_file.lpv10
DEFINE l_lpv10       LIKE lpv_file.lpv10
DEFINE l_lpv10_num   LIKE type_file.num10
DEFINE l_lpv01_min   LIKE lpv_file.lpv01
DEFINE l_lpv01_max   LIKE lpv_file.lpv01
DEFINE l_lpv01_str   STRING
DEFINE l_lpv01       LIKE lpv_file.lpv01
DEFINE l_lpv01_num   LIKE type_file.chr20
DEFINE l_lpv01_chr   LIKE type_file.chr20
DEFINE l_oha01       LIKE oha_file.oha01
DEFINE l_oha01_str   STRING 
DEFINE l_oha01_num   LIKE type_file.chr20
DEFINE l_oha01_chr   LIKE type_file.chr20
DEFINE l_azn05_old   LIKE azn_file.azn05
DEFINE l_azn05       LIKE azn_file.azn05
DEFINE l_num_len     LIKE type_file.num10
DEFINE l_num_str     LIKE type_file.chr20
DEFINE l_cnt         LIKE type_file.num10
DEFINE l_lpv13       LIKE lpv_file.lpv13

   #组出过滤条件
   IF NOT cl_null(g_saleno) THEN
      LET g_wc = " SaleCardno = '",g_saleno,"' "
   ELSE
      CALL p200_g_wc("lpv_file") RETURNING g_wc
   END IF
   IF cl_null(g_wc) THEN LET g_wc = " 1=1" END IF

   SELECT azw02 INTO p_azw02 FROM azw_file WHERE azw01 = p_azw01
   
   #将中间库中满足条件的单据Condition2更新为B
   LET l_upd = "UPDATE ",g_posdbs,"tg_SaleCard",g_db_links," ",
               "   SET Condition2 = 'B' ",
               " WHERE Condition2 <> 'Y' AND Type = '1' AND Cnfflg = 'Y' AND Shop = '",p_azw01 CLIPPED,"' AND ",g_wc CLIPPED
   PREPARE salecard_upd_tg_salecard_lpv_pre FROM l_upd
   EXECUTE salecard_upd_tg_salecard_lpv_pre
   IF SQLCA.sqlcode THEN
      LET g_success = 'N'
      LET g_errno   = SQLCA.sqlcode
      LET g_msg1    = 'Oper:Upd'||' '||'Table:tg_SaleCard'||' '||'Shop:'||p_azw01
      CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
      ROLLBACK WORK
      CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
      LET g_msg   = g_msg[1,255]
      CALL p200_log(g_trans_no,p_azw01,'Batch Operation','05','tg_SaleCard',g_errno,g_msg,'0','N',g_msg1)
      LET g_errno = ''
      LET g_msg   = ''
      LET g_msg1  = ''
      RETURN
   END IF
   
   LET l_upd_num = SQLCA.sqlerrd[3]           #本次需上传总笔数
   IF l_upd_num <= 0 THEN RETURN END IF
   IF cl_null(g_sum_limit) OR g_sum_limit = 0 THEN LET g_sum_limit = l_upd_num END IF
   
   #先删除需要建立的临时表
   DROP TABLE lpv_temp
   DROP TABLE oha_temp
   DROP TABLE ohb_temp
   DROP TABLE ogj_temp    #FUN-D20096 Add
   DROP TABLE ogk_temp    #FUN-D20096 Add
   DROP TABLE rxx_temp
   DROP TABLE rxy_temp
   DROP TABLE rxz_temp
   
   #建立临时表
   SELECT * FROM lpv_file WHERE 1=0 INTO TEMP lpv_temp
   SELECT * FROM oha_file WHERE 1=0 INTO TEMP oha_temp
   SELECT * FROM ohb_file WHERE 1=0 INTO TEMP ohb_temp
   SELECT * FROM ogj_file WHERE 1=0 INTO TEMP ogj_temp    #FUN-D20096 Add
   SELECT * FROM ogk_file WHERE 1=0 INTO TEMP ogk_temp    #FUN-D20096 Add
   SELECT * FROM rxx_file WHERE 1=0 INTO TEMP rxx_temp
   SELECT * FROM rxy_file WHERE 1=0 INTO TEMP rxy_temp
   SELECT * FROM rxz_file WHERE 1=0 INTO TEMP rxz_temp
   
   #建立索引

   WHILE l_upd_num > 0                        #剩余笔数大于0做WHILE循环
      LET l_upd_num = l_upd_num - g_sum_limit #依次减去每批的笔数
      
      #清空临时表
      DELETE FROM lpv_temp
      DELETE FROM oha_temp
      DELETE FROM ohb_temp
      DELETE FROM ogj_temp    #FUN-D20096 Add
      DELETE FROM ogk_temp    #FUN-D20096 Add
      DELETE FROM rxx_temp
      DELETE FROM rxy_temp
      DELETE FROM rxz_temp
      
      LET g_success = 'Y'
      BEGIN WORK
      
      LET l_ins = "INSERT INTO lpv_temp( ",
                  "                     lpv01, ",     #單據編號
                  "                     lpv02, ",     #nouse
                  "                     lpv03, ",     #儲值卡編號
                  "                     lpv04, ",     #儲值卡餘額
                  "                     lpv05, ",     #折扣率
                  "                     lpv06, ",     #NoUse
                  "                     lpv07, ",     #實際退款金額
                  "                     lpv08, ",     #審核碼
                  "                     lpv09, ",     #審核人
                  "                     lpv10, ",     #審核日期
                  "                     lpv11, ",     #備注
                  "                     lpv12, ",     #卡種編號
                  "                     lpv13, ",     #對應銷退單號
                  "                     lpv14, ",     #已退款金額
                  "                     lpv15, ",     #POS單號
                  "                     lpv21, ",     #POS交易
                  "                     lpv22, ",     #POS送抵現值
                  "                     lpv23, ",     #發卡充值
                  "                     lpv231, ",    #發卡充值折扣金額
                  "                     lpv232, ",    #發卡充值加值金額
                  "                     lpv24, ",     #儲值卡充值
                  "                     lpv241, ",    #儲值卡充值折扣金額
                  "                     lpv242, ",    #儲值卡充值加值金額
                  "                     lpv25, ",     #訂單
                  "                     lpv26, ",     #ERP出貨單
                  "                     lpv27, ",     #EPR銷退單
                  "                     lpv28, ",     #預收退款
                  "                     lpv29, ",     #押金收取
                  "                     lpv30, ",     #押金返還
                  "                     lpv31, ",     #費用收取
                  "                     lpv32, ",     #費用支出
                  "                     lpv33, ",     #ERP訂單送抵現值
                  "                     lpv34, ",     #ERP出貨單送抵現值
                  "                     lpv35, ",     #開帳換卡異動金額
                  "                     lpv36, ",     #開帳換卡加值金額
                  "                     lpvacti, ",   #資料有效碼
                  "                     lpvcrat, ",   #資料創建日
                  "                     lpvdate, ",   #資料修改日
                  "                     lpvgrup, ",   #資料所有群
                  "                     lpvlegal, ",  #所屬法人
                  "                     lpvmodu, ",   #資料修改者
                  "                     lpvplant, ",  #所屬營運中心
                  "                     lpvuser, ",   #資料所有者
                  "                     lpvoriu, ",   #資料建立者
                  "                     lpvorig) "    #資料建立部門
      LET l_sel = "SELECT ",
                  "       ROW_NUMBER() over(order by Bdate,SaleCardno), ",                         #lpv01     #單據編號
                  "       NULL, ",                                                                 #lpv02     #nouse
                  "       BeginCard, ",                                                            #lpv03     #儲值卡編號
                  "       RealAmt, ",                                                              #lpv04     #儲值卡餘額
                  "       lpj11, ",                                                                #lpv05     #折扣率
                  "       NULL, ",                                                                 #lpv06     #NoUse
                  "       Amt, ",                                                                  #lpv07     #實際退款金額
                  "       'Y', ",                                                                  #lpv08     #審核碼
                  "       ryi02, ",                                                                #lpv09     #審核人
                 #"       CAST(Bdate AS DATE), ",                                                  #lpv10     #審核日期 #FUN-D10144 Mark
                  "       CAST(Sdate AS DATE), ",                                                  #lpv10     #審核日期 #FUN-D10144 Add
                  "       NULL, ",                                                                 #lpv11     #備注
                  "       lpj02, ",                                                                #lpv12     #卡種編號
                  "       ROW_NUMBER() over(order by Bdate,SaleCardno), ",                         #lpv13     #對應銷退單號
                  "       Amt, ",                                                                  #lpv14     #已退款金額
                  "       SaleCardno, ",                                                           #lpv15     #POS單號
                  "       0, ",                                                                    #lpv21     #POS交易
                  "       0, ",                                                                    #lpv22     #POS送抵現值
                  "       COALESCE((SELECT SUM(lsn04-lsn09-(lsn04-lsn09)*(1-lsn07/100)) ",         #lpv23     #發卡充值
                  "                   FROM ",cl_get_target_table(p_azw01,'lsn_file'),
                  "                  WHERE lsn01 = BeginCard AND lsn02 = '2'),0), ",
                  "       COALESCE((SELECT SUM((lsn04-lsn09)*(1-lsn07/100)) ",                     #lpv231    #發卡充值折扣金額
                  "                   FROM ",cl_get_target_table(p_azw01,'lsn_file'),
                  "                  WHERE lsn01 = BeginCard AND lsn02 = '2'),0), ",
                  "       COALESCE((SELECT SUM(lsn09) ",                                           #lpv232    #發卡充值加值金額
                  "                   FROM ",cl_get_target_table(p_azw01,'lsn_file'),
                  "                  WHERE lsn01 = BeginCard AND lsn02 = '2'),0), ",
                  "       COALESCE((SELECT SUM(lsn04-lsn09-(lsn04-lsn09)*(1-lsn07/100)) ",         #lpv24     #儲值卡充值
                  "                   FROM ",cl_get_target_table(p_azw01,'lsn_file'),
                  "                  WHERE lsn01 = BeginCard AND lsn02 = '3'),0), ",
                  "       COALESCE((SELECT SUM((lsn04-lsn09)*(1-lsn07/100)) ",                     #lpv241    #儲值卡充值折扣金額
                  "                   FROM ",cl_get_target_table(p_azw01,'lsn_file'),
                  "                  WHERE lsn01 = BeginCard AND lsn02 = '3'),0), ",
                  "       COALESCE((SELECT SUM(lsn09) ",                                           #lpv242    #儲值卡充值加值金額
                  "                   FROM ",cl_get_target_table(p_azw01,'lsn_file'),
                  "                  WHERE lsn01 = BeginCard AND lsn02 = '3'),0), ",
                  "       COALESCE((SELECT SUM(lsn04) ",                                           #lpv25     #訂單
                  "                   FROM ",cl_get_target_table(p_azw01,'lsn_file'),
                  "                  WHERE lsn01 = BeginCard AND lsn02 = '6'),0), ",
                  "       COALESCE((SELECT SUM(lsn04) ",                                           #lpv26     #ERP出貨單
                  "                   FROM ",cl_get_target_table(p_azw01,'lsn_file'),
                  "                  WHERE lsn01 = BeginCard AND lsn02 = '7'),0), ",
                  "       COALESCE((SELECT SUM(lsn04) ",                                           #lpv27     #EPR銷退單
                  "                   FROM ",cl_get_target_table(p_azw01,'lsn_file'),
                  "                  WHERE lsn01 = BeginCard AND lsn02 = '8'),0), ",
                  "       COALESCE((SELECT SUM(lsn04) ",                                           #lpv28     #預收退款
                  "                   FROM ",cl_get_target_table(p_azw01,'lsn_file'),
                  "                  WHERE lsn01 = BeginCard AND lsn02 = '9'),0), ",
                  "       COALESCE((SELECT SUM(lsn04) ",                                           #lpv29     #押金收取
                  "                   FROM ",cl_get_target_table(p_azw01,'lsn_file'),
                  "                  WHERE lsn01 = BeginCard AND lsn02 = 'A'),0), ",
                  "       COALESCE((SELECT SUM(lsn04) ",                                           #lpv30     #押金返還
                  "                   FROM ",cl_get_target_table(p_azw01,'lsn_file'),
                  "                  WHERE lsn01 = BeginCard AND lsn02 = 'B'),0), ",
                  "       COALESCE((SELECT SUM(lsn04) ",                                           #lpv31     #費用收取
                  "                   FROM ",cl_get_target_table(p_azw01,'lsn_file'),
                  "                  WHERE lsn01 = BeginCard AND lsn02 = 'C'),0), ",
                  "       COALESCE((SELECT SUM(lsn04) ",                                           #lpv32     #費用支出
                  "                   FROM ",cl_get_target_table(p_azw01,'lsn_file'),
                  "                  WHERE lsn01 = BeginCard AND lsn02 = 'D'),0), ",
                  "       COALESCE((SELECT SUM(lsn04) ",                                           #lpv33     #ERP訂單送抵現值
                  "                   FROM ",cl_get_target_table(p_azw01,'lsn_file'),
                  "                  WHERE lsn01 = BeginCard AND lsn02 = 'E'),0), ",
                  "       COALESCE((SELECT SUM(lsn04) ",                                           #lpv34     #ERP出貨單送抵現值
                  "                   FROM ",cl_get_target_table(p_azw01,'lsn_file'),
                  "                  WHERE lsn01 = BeginCard AND lsn02 = 'F'),0), ",
                  "       COALESCE((SELECT SUM(lsn04*(lsn07/100)) ",                               #lpv35     #開帳換卡異動金額
                  "                   FROM ",cl_get_target_table(p_azw01,'lsn_file'),
                  "                  WHERE lsn01 = BeginCard AND lsn02 = '1'),0)+ ",
                  "       COALESCE((SELECT SUM(lsn04-lsn09) ",
                  "                   FROM ",cl_get_target_table(p_azw01,'lsn_file'),
                  "                  WHERE lsn01 = BeginCard AND lsn02 = '5'),0), ",
                  "       COALESCE((SELECT SUM(lsn04*(1-lsn07/100)) ",                             #lpv36     #開帳換卡加值金額
                  "                   FROM ",cl_get_target_table(p_azw01,'lsn_file'),
                  "                  WHERE lsn01 = BeginCard AND lsn02 = '1'),0)+ ",
                  "       COALESCE((SELECT SUM(lsn09) ",
                  "                   FROM ",cl_get_target_table(p_azw01,'lsn_file'),
                  "                  WHERE lsn01 = BeginCard AND lsn02 = '5'),0), ",
                  "       'Y', ",                                                                  #lpvacti   #資料有效碼
                 #"       CAST(Bdate AS DATE), ",                                                  #lpvcrat   #資料創建日 #FUN-D10144 Mark
                  "       CAST(Sdate AS DATE), ",                                                  #lpvcrat   #資料創建日 #FUN-D10144 Add
                 #"       CAST(Bdate AS DATE), ",                                                  #lpvdate   #資料修改日 #FUN-D10144 Mark
                  "       CAST(Sdate AS DATE), ",                                                  #lpvdate   #資料修改日 #FUN-D10144 Add
                  "       gen03, ",                                                                #lpvgrup   #資料所有群
                  "       '",p_azw02,"', ",                                                        #lpvlegal  #所屬法人
                  "       ryi02, ",                                                                #lpvmodu   #資料修改者
                  "       Shop, ",                                                                 #lpvplant  #所屬營運中心
                  "       ryi02, ",                                                                #lpvuser   #資料所有者
                  "       ryi02, ",                                                                #lpvoriu   #資料建立者
                  "       gen03 ",                                                                 #lpvorig   #資料建立部門
                  "  FROM ( ",
                  "SELECT Bdate,Opno,a.* ",
                  "  FROM ",g_posdbs,"tg_SaleCard_Detail",g_db_links," a , ",
                  "       ",g_posdbs,"tg_SaleCard",g_db_links," b ",
                  " WHERE b.Shop = '",p_azw01,"' AND b.Condition2 = 'B' AND b.Cnfflg = 'Y' AND b.Type = '1' ",
                  "   AND a.Shop = b.Shop AND a.SaleCardno = b.SaleCardno ",
                  " ORDER BY b.Bdate,b.SaleCardno) LEFT OUTER JOIN ",cl_get_target_table(p_azw01,'ryi_file'),
                  "                                             ON ryi01 = Opno ",
                  "                                LEFT OUTER JOIN ",cl_get_target_table(p_azw01,'gen_file'),
                  "                                             ON gen01 = ryi02 ",
                  "                                LEFT OUTER JOIN ",cl_get_target_table(p_azw01,'lpj_file'),
                  "                                             ON lpj03 = BeginCard ",
                  " WHERE ROWNUM <= ",g_sum_limit," ",
                  "   AND lpj16 = 'Y' ",
                  " ORDER BY Bdate,SaleCardno "
      LET l_sql = l_ins CLIPPED," ",l_sel CLIPPED
      PREPARE salecard_ins_lpv_temp_pre FROM l_sql
      EXECUTE salecard_ins_lpv_temp_pre 
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Ins'||' '||'Table:lpv_temp'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK 
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg 
         LET g_msg   = g_msg[1,255] 
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','05','tg_SaleCard',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CONTINUE WHILE 
      END IF

      IF SQLCA.sqlerrd[3] = 0 THEN CONTINUE WHILE END IF

      INITIALIZE l_lpv10_old,l_lpv01_min_o,l_lpv01_max_o,l_azn05_old TO NULL                                    
      INITIALIZE l_lpv10,l_lpv10_num,l_lpv01_min,l_lpv01_max,l_azn05 TO NULL
      LET l_sql = "SELECT DISTINCT MIN(to_number(lpv01)),lpv10,MAX(to_number(lpv01)) FROM lpv_temp GROUP BY lpv10 order by lpv10"
      PREPARE salecard_sel_lpv10_pre FROM l_sql
      DECLARE salecard_sel_lpv10_cs CURSOR FOR salecard_sel_lpv10_pre
      FOREACH salecard_sel_lpv10_cs INTO l_lpv01_min,l_lpv10,l_lpv01_max
      
        #自动编号
         LET g_ndate = l_lpv10
        #CALL p200_auto_doc(p_gat01,p_azw01) RETURNING l_lpv01     #FUN-CC0082 Mark
         CALL p200_auto_doc(p_gat01,p_azw01,'Y') RETURNING l_lpv01 #FUN-CC0082 Add
         IF g_success = 'N' THEN
            EXIT WHILE
         END IF
        #CALL p200_auto_doc("oha_file",p_azw01) RETURNING l_oha01     #FUN-CC0082 Mark
         CALL p200_auto_doc("oha_file",p_azw01,'Y') RETURNING l_oha01 #FUN-CC0082 Add
         IF g_success = 'N' THEN
            EXIT WHILE
         END IF
         
         CASE g_ryz05
            WHEN "1"
               LET l_num_len = 8
            WHEN "2"
               LET l_num_len = 9
            WHEN "3"
               LET l_num_len = 10
         END CASE
         
         CASE g_ryz06
            WHEN "1" #按流水号
               LET l_num_len = l_num_len
               IF NOT cl_null(l_lpv10_old) THEN
                  #已排流水号个数 = 最大流水号旧值- 最小流水号旧值+ 1 + 上一笔已排流水号个数
                  LET l_lpv10_num = l_lpv01_max_o - l_lpv01_min_o + 1 + l_lpv10_num
               ELSE
                  LET l_lpv10_num = 0
               END IF
            WHEN "2" #按年月
               LET l_num_len = l_num_len - 4
               IF NOT cl_null(l_lpv10_old) THEN 
                  IF YEAR(l_lpv10_old) = YEAR(l_lpv10) AND MONTH(l_lpv10_old) = MONTH(l_lpv10) THEN
                     LET l_lpv10_num = l_lpv01_max_o - l_lpv01_min_o + 1 + l_lpv10_num
                  ELSE
                     LET l_lpv10_num = 0
                  END IF
               ELSE
                  LET l_lpv10_num = 0
               END IF
            WHEN "3" #按年周
               LET l_num_len = l_num_len - 4
               IF NOT cl_null(l_lpv10_old) THEN
                  INITIALIZE l_azn05 TO NULL
                  SELECT azn05 INTO l_azn05 FROM azn_file WHERE azn01 = l_lpv10
                  IF YEAR(l_lpv10_old) = YEAR(l_lpv10) AND l_azn05_old = l_azn05 THEN
                     LET l_lpv10_num = l_lpv01_max_o - l_lpv01_min_o + 1 + l_lpv10_num
                  ELSE
                     LET l_lpv10_num = 0
                  END IF
               ELSE
                  LET l_lpv10_num = 0
               END IF
            WHEN "4" #按年月日
               LET l_num_len = l_num_len - 6
              #FUN-D30061 Mark&Add Begin ---
              #IF NOT cl_null(l_lpv10_old) THEN
              #   LET l_lpv10_num = l_lpv01_max_o - l_lpv01_min_o + 1 + l_lpv10_num
              #ELSE
              #   LET l_lpv10_num = 0
              #END IF
               LET l_lpv10_num = 0
              #FUN-D30061 Mark&Add End -----
         END CASE
            
         LET l_lpv01_min_o = l_lpv01_min
         LET l_lpv01_max_o = l_lpv01_max
         LET l_azn05_old   = l_azn05
         LET l_lpv10_old   = l_lpv10
               
         INITIALIZE l_num_str TO NULL
         FOR l_cnt = 1 TO l_num_len
            LET l_num_str = l_num_str CLIPPED,'0'
         END FOR
         LET l_lpv01_str = l_lpv01
         LET l_lpv01_num = l_lpv01_str.subString(l_lpv01_str.getLength() - l_num_len + 1,l_lpv01_str.getLength())
         LET l_lpv01_chr = l_lpv01_str.subString(1,l_lpv01_str.getLength() - l_num_len)
         #   最大流水号  = 实际流水号  - 最小ROWNUM  + 已排流水号个数
         LET l_lpv01_num = l_lpv01_num - l_lpv01_min + l_lpv10_num
         LET l_oha01_str = l_oha01
         LET l_oha01_num = l_oha01_str.subString(l_oha01_str.getLength() - l_num_len + 1,l_oha01_str.getLength())
         LET l_oha01_chr = l_oha01_str.subString(1,l_oha01_str.getLength() - l_num_len)
         #   最大流水号  = 实际流水号  - 最小ROWNUM  + 已排流水号个数
         LET l_oha01_num = l_oha01_num - l_lpv01_min + l_lpv10_num
         
         #批次更新oea_temp中的单号
         LET l_upd = "UPDATE lpv_temp SET lpv01 = '",l_lpv01_chr CLIPPED,"'||","substr(to_char","((lpv01 + '",l_lpv01_num,"'),'",l_num_str,"'),2), ",
                     "                    lpv13 = '",l_oha01_chr CLIPPED,"'||","substr(to_char","((lpv13 + '",l_oha01_num,"'),'",l_num_str,"'),2) ",
                     " WHERE lpv10 = '",l_lpv10,"' "
         PREPARE salecard_upd_lpv01_pre FROM l_upd
         EXECUTE salecard_upd_lpv01_pre
         IF SQLCA.sqlcode THEN
            LET g_success = 'N'
            LET g_errno   = SQLCA.sqlcode
            LET g_msg1    = 'Oper:Upd'||' '||'Table:lpv_temp'||' '||'Field:lpv01/lpv13'||' '||'Shop:'||p_azw01
            CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
            ROLLBACK WORK
            CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
            LET g_msg   = g_msg[1,255]
            CALL p200_log(g_trans_no,p_azw01,'Batch Operation','05','tg_SaleCard',g_errno,g_msg,'0','N',g_msg1)
            LET g_errno = ''
            LET g_msg   = ''
            LET g_msg1  = ''
            CONTINUE WHILE
         END IF
      END FOREACH

      #检查单据日期
      INITIALIZE l_lpv10 TO NULL
      SELECT MIN(lpv10) INTO l_lpv10 FROM lpv_temp WHERE lpv10 <= g_sma.sma53
      IF NOT cl_null(l_lpv10) THEN
         LET g_errno   = 'apc1054' #该批次资料中存在最小单据日期小于等于关帐日期
         LET g_msg1    = 'Oper:Chk'||' '||'Table:lpv_temp'||' '||'MIN(lpv10):'||l_lpv10||' '||'Shop:'||p_azw01
        #CALL s_errmsg('Batch Operation','',g_msg1,SQLCA.sqlcode,1) #FUN-CB0103 Mark
         CALL s_errmsg('Batch Operation','',g_msg1,g_errno,1)       #FUN-CB0103 Add
         ROLLBACK WORK 
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','05','TG_SALECARD',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
      END IF 
      
      #更新中间库状态为A
      LET l_upd = "UPDATE ",g_posdbs,"tg_SaleCard",g_db_links," ",
                  "   SET Condition2 = 'A' ", 
                  " WHERE Shop = '",p_azw01,"' ",
                  "   AND EXISTS (SELECT 1 ", 
                  "                 FROM lpv_temp ",   
                  "                WHERE lpv10 <= '",g_sma.sma53,"' ",
                  "                  AND lpv15 = SaleCardno) "
      PREPARE salecard_upd_tg_salecard_flag_lpv_pre FROM l_upd
      EXECUTE salecard_upd_tg_salecard_flag_lpv_pre 
      
      #删除出货日期小于等于关帐日期的资料
      DELETE FROM lpv_temp WHERE lpv10 <= g_sma.sma53
      
      #ins xyz
      CALL p200_cardcoupon_xyz_ins_p("lpv_file",p_azw01)
      IF g_success='N' THEN
      END IF
      
     ##更新lpv中的已退款金额lpv14
     #LET l_upd = "UPDATE lpv_temp ",
     #            "   SET lpv14 = COALESCE((SELECT SUM(rxy05) ",
     #            "                           FROM rxy_temp ",
     #            "                          WHERE rxy00 = '22' ",
     #            "                            AND rxy01 = lpv01 ",
     #            "                            AND rxyplant = lpvplant),0) "
     #PREPARE salecard_upd_lpv14_pre FROM l_upd
     #EXECUTE salecard_upd_lpv14_pre
   
      #产生出货单以及付款资料
      CALL p200_prod_oha_p('1',p_azw01)
      IF g_success = 'N' THEN
         CALL p200_upd_posflag_p('2',p_gat01,'tg_SaleCard',p_azw01) #将对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF
      
      #将临时表lpv_temp插入到数据库中
      LET l_ins = " INSERT INTO ",cl_get_target_table(p_azw01,'lpv_file'),
                  " SELECT * FROM lpv_temp "
      CALL cl_replace_sqldb(l_ins) RETURNING l_ins
      CALL cl_parse_qry_sql(l_ins,p_azw01) RETURNING l_ins
      PREPARE salecard_ins_lpv_pre FROM l_ins
      EXECUTE salecard_ins_lpv_pre
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Ins'||' '||'Table:lpv_file'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','05','TG_SALECARD',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'tg_SaleCard',p_azw01) #将对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF

      #将临时表oha_temp插入到数据库中
      LET l_ins = " INSERT INTO ",cl_get_target_table(p_azw01,'oha_file'),
                  " SELECT * FROM oha_temp "
      CALL cl_replace_sqldb(l_ins) RETURNING l_ins
      CALL cl_parse_qry_sql(l_ins,p_azw01) RETURNING l_ins
      PREPARE salecard_ins_oha_lpv_pre FROM l_ins
      EXECUTE salecard_ins_oha_lpv_pre
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Ins'||' '||'Table:oha_file'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','05','TG_SALECARD',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'tg_SaleCard',p_azw01) #将对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF
      
      #将临时表ohb_temp插入到数据库中
      LET l_ins = " INSERT INTO ",cl_get_target_table(p_azw01,'ohb_file'),
                  " SELECT * FROM ohb_temp "
      CALL cl_replace_sqldb(l_ins) RETURNING l_ins
      CALL cl_parse_qry_sql(l_ins,p_azw01) RETURNING l_ins
      PREPARE salecard_ins_ohb_lpv_pre FROM l_ins
      EXECUTE salecard_ins_ohb_lpv_pre
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Ins'||' '||'Table:ohb_file'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','05','TG_SALECARD',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'tg_SaleCard',p_azw01) #将对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF

      #FUN-D20096---Add---Str
      #将临时表ogj_temp插入到数据库中
      LET l_ins = " INSERT INTO ",cl_get_target_table(p_azw01,'ogj_file'),
                  " SELECT * FROM ogj_temp "
      CALL cl_replace_sqldb(l_ins) RETURNING l_ins
      CALL cl_parse_qry_sql(l_ins,p_azw01) RETURNING l_ins
      PREPARE salecard_ins_ogj_lpv_pre FROM l_ins
      EXECUTE salecard_ins_ogj_lpv_pre
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Ins'||' '||'Table:ogj_file'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','05','TG_SALECARD_TAX',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'tg_SaleCard_Tax',p_azw01) #将对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF

      #将临时表ogk_temp插入到数据库中
      LET l_ins = " INSERT INTO ",cl_get_target_table(p_azw01,'ogk_file'),
                  " SELECT * FROM ogk_temp "
      CALL cl_replace_sqldb(l_ins) RETURNING l_ins
      CALL cl_parse_qry_sql(l_ins,p_azw01) RETURNING l_ins
      PREPARE salecard_ins_ogk_lpv_pre FROM l_ins
      EXECUTE salecard_ins_ogk_lpv_pre
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Ins'||' '||'Table:ogk_file'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','05','TG_SALECARD_DETAIL_TAX',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'tg_SaleCard_Detail_Tax',p_azw01) #将对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF
      #FUN-D20096---Add---End
      
      #将临时表rxx_temp插入到数据库中
      LET l_ins = " INSERT INTO ",cl_get_target_table(p_azw01,'rxx_file'),
                  " SELECT * FROM rxx_temp "
      CALL cl_replace_sqldb(l_ins) RETURNING l_ins
      CALL cl_parse_qry_sql(l_ins,p_azw01) RETURNING l_ins
      PREPARE salecard_ins_rxx_lpv_pre FROM l_ins
      EXECUTE salecard_ins_rxx_lpv_pre
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Ins'||' '||'Table:rxx_file'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','05','TG_SALECARD',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'tg_SaleCard',p_azw01) #将对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF
      
      #将临时表rxy_temp插入到数据库中
      LET l_ins = " INSERT INTO ",cl_get_target_table(p_azw01,'rxy_file'),
                  " SELECT * FROM rxy_temp "
      CALL cl_replace_sqldb(l_ins) RETURNING l_ins
      CALL cl_parse_qry_sql(l_ins,p_azw01) RETURNING l_ins
      PREPARE salecard_ins_rxy_lpv_pre FROM l_ins
      EXECUTE salecard_ins_rxy_lpv_pre
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Ins'||' '||'Table:rxy_file'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','05','TG_SALECARD',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'tg_SaleCard',p_azw01) #将对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF
      
      #将临时表rxz_temp插入到数据库中
      LET l_ins = " INSERT INTO ",cl_get_target_table(p_azw01,'rxz_file'),
                  " SELECT * FROM rxz_temp "
      CALL cl_replace_sqldb(l_ins) RETURNING l_ins
      CALL cl_parse_qry_sql(l_ins,p_azw01) RETURNING l_ins
      PREPARE salecard_ins_rxz_lpv_pre FROM l_ins
      EXECUTE salecard_ins_rxz_lpv_pre
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Ins'||' '||'Table:rxz_file'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','05','TG_SALECARD',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'tg_SaleCard',p_azw01) #将对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF

      #更新中间库标志位
      CALL p200_upd_posflag_p("1","lpv_file","tg_SaleCard",p_azw01)
      IF g_success = 'N' THEN
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Upd'||' '||'Table:tg_Recharge'||' '||'Field:Condition2'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','05','TG_SALECARD',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'tg_SaleCard',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF
      
      IF g_success = 'Y' THEN
         LET g_sucflag = 1
         COMMIT WORK
      ELSE
         ROLLBACK WORK
      END IF
      
   END WHILE
   #删除建立的临时表
   DROP TABLE lpv_temp
   DROP TABLE oha_temp
   DROP TABLE ohb_temp
   DROP TABLE ogj_temp   #FUN-D20096 Add
   DROP TABLE ogk_temp   #FUN-D20096 Add
   DROP TABLE rxx_temp
   DROP TABLE rxy_temp
   DROP TABLE rxz_temp
END FUNCTION
#FUN-CA0160 Add End -----

#FUN-CA0160 Add Begin ---
#退卡上传 - 非储值卡
FUNCTION p200_lru_ins_p(p_gat01,p_azw01)
DEFINE p_gat01       LIKE gat_file.gat01
DEFINE p_azw01       LIKE azw_file.azw01
DEFINE p_azw02       LIKE azw_file.azw02
DEFINE l_ins         STRING
DEFINE l_sel         STRING
DEFINE l_sql         STRING
DEFINE l_upd         STRING
DEFINE l_upd_num     LIKE type_file.num10
DEFINE l_lru01_min_o LIKE lru_file.lru01
DEFINE l_lru01_max_o LIKE lru_file.lru01
DEFINE l_lru05_old   LIKE lru_file.lru05
DEFINE l_lru05       LIKE lru_file.lru05
DEFINE l_lru05_num   LIKE type_file.num10
DEFINE l_lru01_min   LIKE lru_file.lru01
DEFINE l_lru01_max   LIKE lru_file.lru01
DEFINE l_lru01_str   STRING
DEFINE l_lru01       LIKE lru_file.lru01
DEFINE l_lru01_num   LIKE type_file.chr20
DEFINE l_lru01_chr   LIKE type_file.chr20
DEFINE l_azn05_old   LIKE azn_file.azn05
DEFINE l_azn05       LIKE azn_file.azn05
DEFINE l_num_len     LIKE type_file.num10
DEFINE l_num_str     LIKE type_file.chr20
DEFINE l_cnt         LIKE type_file.num10

   #组出过滤条件
   IF NOT cl_null(g_saleno) THEN
      LET g_wc = " SaleCardno = '",g_saleno,"' "
   ELSE
      CALL p200_g_wc("lru_file") RETURNING g_wc
   END IF
   IF cl_null(g_wc) THEN LET g_wc = " 1=1" END IF

   SELECT azw02 INTO p_azw02 FROM azw_file WHERE azw01 = p_azw01
   
   #将中间库中满足条件的单据Condition2更新为B
   LET l_upd = "UPDATE ",g_posdbs,"tg_SaleCard",g_db_links," ",
               "   SET Condition2 = 'B' ",
               " WHERE Condition2 <> 'Y' AND Type = '1' AND Cnfflg = 'Y' AND Shop = '",p_azw01 CLIPPED,"' AND ",g_wc CLIPPED
   PREPARE upd_tg_salecard_lru_pre FROM l_upd
   EXECUTE upd_tg_salecard_lru_pre
   IF SQLCA.sqlcode THEN
      LET g_success = 'N'
      LET g_errno   = SQLCA.sqlcode
      LET g_msg1    = 'Oper:Upd'||' '||'Table:tg_SaleCard(lru)'||' '||'Shop:'||p_azw01
      CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
      ROLLBACK WORK
      CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
      LET g_msg   = g_msg[1,255]
      CALL p200_log(g_trans_no,p_azw01,'Batch Operation','05','tg_SaleCard',g_errno,g_msg,'0','N',g_msg1)
      LET g_errno = ''
      LET g_msg   = ''
      LET g_msg1  = ''
      RETURN
   END IF
   
   LET l_upd_num = SQLCA.sqlerrd[3]           #本次需上传总笔数
   IF l_upd_num <= 0 THEN RETURN END IF
   IF cl_null(g_sum_limit) OR g_sum_limit = 0 THEN LET g_sum_limit = l_upd_num END IF
   
   #先删除需要建立的临时表
   DROP TABLE lru_temp
   DROP TABLE lrv_temp
   
   #建立临时表
   SELECT * FROM lru_file WHERE 1=0 INTO TEMP lru_temp
   SELECT * FROM lrv_file WHERE 1=0 INTO TEMP lrv_temp
   
   #建立索引
   
   WHILE l_upd_num > 0                        #剩余笔数大于0做WHILE循环
      LET l_upd_num = l_upd_num - g_sum_limit #依次减去每批的笔数
      
      #清空临时表
      DELETE FROM lru_temp
      DELETE FROM lrv_temp
      
      LET g_success = 'Y'
      BEGIN WORK

      LET l_ins = "INSERT INTO lru_temp( ",
                  "                     lru00, ",      #单据类型
                  "                     lru01, ",      #单据编号
                  "                     lru02, ",      #會員編號
                  "                     lru03, ",      #卡種
                  "                     lru04, ",      #原因編號
                  "                     lru05, ",      #单据日期
                  "                     lru06, ",      #审核码
                  "                     lru07, ",      #审核人
                  "                     lru08, ",      #审核日期
                  "                     lru09, ",      #备注
                  "                     lru10, ",      #POS单号
                  "                     lruacti, ",    #资料有效码
                  "                     lrucrat, ",    #資料創建日
                  "                     lrudate, ",    #最近更改日
                  "                     lrugrup, ",    #资料所有群
                  "                     lrulegal, ",   #法人
                  "                     lrumodu, ",    #资料更改者
                  "                     lruorig, ",    #资料建立部门
                  "                     lruoriu, ",    #资料建立者
                  "                     lruplant, ",   #門店編號
                  "                     lruuser) "     #资料所有者
      LET l_sel = "SELECT ",
                  "       '2', ",                                          #lru00      #单据类型
                  "       ROW_NUMBER() over(order by Bdate,SaleCardno), ", #lru01      #单据编号
                  "       lpj01, ",                                        #lru02      #會員編號
                  "       lpj02, ",                                        #lru03      #卡種
                  "       NULL, ",                                         #lru04      #原因編號
                  "       CAST(Bdate AS DATE), ",                          #lru05      #单据日期
                  "       'Y', ",                                          #lru06      #审核码
                  "       ryi02, ",                                        #lru07      #审核人
                 #"       CAST(Bdate AS DATE), ",                          #lru08      #审核日期 #FUN-D10144 Mark
                  "       CAST(Sdate AS DATE), ",                          #lru08      #审核日期 #FUN-D10144 Add
                  "       NULL, ",                                         #lru09      #备注
                  "       SaleCardno, ",                                   #lru10      #POS单号
                  "       'Y', ",                                          #lruacti    #资料有效码
                 #"       CAST(Bdate AS DATE), ",                          #lrucrat    #資料創建日 #FUN-D10144 Mark
                  "       CAST(Sdate AS DATE), ",                          #lrucrat    #資料創建日 #FUN-D10144 Add
                 #"       CAST(Bdate AS DATE), ",                          #lrudate    #最近更改日 #FUN-D10144 Mark
                  "       CAST(Sdate AS DATE), ",                          #lrudate    #最近更改日 #FUN-D10144 Add
                  "       gen03, ",                                        #lrugrup    #资料所有群
                  "       '",p_azw02,"', ",                                #lrulegal   #法人
                  "       ryi02, ",                                        #lrumodu    #资料更改者
                  "       gen03, ",                                        #lruorig    #资料建立部门
                  "       ryi02, ",                                        #lruoriu    #资料建立者
                  "       Shop, ",                                         #lruplant   #門店編號
                  "       ryi02 ",                                         #lruuser    #资料所有者
                  "  FROM ( ",
                  "SELECT Bdate,Opno,a.* ",
                  "  FROM ",g_posdbs,"tg_SaleCard_Detail",g_db_links," a , ",
                  "       ",g_posdbs,"tg_SaleCard",g_db_links," b ",
                  " WHERE b.Shop = '",p_azw01,"' AND b.Condition2 = 'B' AND b.Cnfflg = 'Y' AND b.Type = '1' ",
                  "   AND a.Shop = b.Shop AND a.SaleCardno = b.SaleCardno ",
                  " ORDER BY b.Bdate,b.SaleCardno) LEFT OUTER JOIN ",cl_get_target_table(p_azw01,'ryi_file'),
                  "                                             ON ryi01 = Opno ",
                  "                                LEFT OUTER JOIN ",cl_get_target_table(p_azw01,'gen_file'),
                  "                                             ON gen01 = ryi02 ",
                  "                                LEFT OUTER JOIN ",cl_get_target_table(p_azw01,'lpj_file'),
                  "                                             ON lpj03 = BeginCard ",
                  " WHERE ROWNUM <= ",g_sum_limit," ",
                  "   AND lpj16 = 'N' ",
                  " ORDER BY Bdate,SaleCardno "
      LET l_sql = l_ins CLIPPED," ",l_sel CLIPPED
      PREPARE ins_lru_temp_pre FROM l_sql
      EXECUTE ins_lru_temp_pre
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Ins'||' '||'Table:lru_temp'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','05','tg_SaleCard',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CONTINUE WHILE
      END IF

      IF SQLCA.sqlerrd[3] = 0 THEN CONTINUE WHILE END IF
      
      #检查单据日期  
      INITIALIZE l_lru05 TO NULL
      SELECT MIN(lru05) INTO l_lru05 FROM lru_temp WHERE lru05 <= g_sma.sma53
      IF NOT cl_null(l_lru05) THEN
         LET g_errno   = 'apc1054' #该批次资料中存在最小单据日期小于等于关帐日期
         LET g_msg1    = 'Oper:Chk'||' '||'Table:lru_temp'||' '||'MIN(lru05):'||l_lru05||' '||'Shop:'||p_azw01
        #CALL s_errmsg('Batch Operation','',g_msg1,SQLCA.sqlcode,1) #FUN-CB0103 Mark
         CALL s_errmsg('Batch Operation','',g_msg1,g_errno,1)       #FUN-CB0103 Add
         ROLLBACK WORK 
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','05','TG_SALECARD',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
      END IF 
         
      #更新中间库状态为A   
      LET l_upd = "UPDATE ",g_posdbs,"tg_SaleCard",g_db_links," ",
                  "   SET Condition2 = 'A' ",
                  " WHERE Shop = '",p_azw01,"' ",
                  "   AND EXISTS (SELECT 1 ",
                  "                 FROM lru_temp ",
                  "                WHERE lru05 <= '",g_sma.sma53,"' ",
                  "                  AND lru10 = SaleCardno) "
      PREPARE salecard_upd_tg_salecard_flag_lru_pre FROM l_upd
      EXECUTE salecard_upd_tg_salecard_flag_lru_pre 
         
      #删除出货日期小于等于关帐日期的资料
      DELETE FROM lru_temp WHERE lru05 <= g_sma.sma53
      
      INITIALIZE l_lru05_old,l_lru01_min_o,l_lru01_max_o,l_azn05_old TO NULL
      INITIALIZE l_lru05,l_lru05_num,l_lru01_min,l_lru01_max,l_azn05 TO NULL
      LET l_sql = "SELECT DISTINCT MIN(to_number(lru01)),lru05,MAX(to_number(lru01)) FROM lru_temp GROUP BY lru05 order by lru05"
      PREPARE salecard_sel_lru05_pre FROM l_sql
      DECLARE salecard_sel_lru05_cs CURSOR FOR salecard_sel_lru05_pre
      FOREACH salecard_sel_lru05_cs INTO l_lru01_min,l_lru05,l_lru01_max
                  
         #自动编号
         LET g_ndate = l_lru05
        #CALL p200_auto_doc(p_gat01,p_azw01) RETURNING l_lru01     #FUN-CC0082 Mark
         CALL p200_auto_doc(p_gat01,p_azw01,'Y') RETURNING l_lru01 #FUN-CC0082 Add
         IF g_success = 'N' THEN
            EXIT WHILE
         END IF   
                  
         CASE g_ryz05     
            WHEN "1"      
               LET l_num_len = 8 
            WHEN "2"      
               LET l_num_len = 9 
            WHEN "3"      
               LET l_num_len = 10
         END CASE 
                  
         CASE g_ryz06
            WHEN "1" #按流水号
               LET l_num_len = l_num_len
               IF NOT cl_null(l_lru05_old) THEN
                  #已排流水号个数 = 最大流水号旧值- 最小流水号旧值+ 1 + 上一笔已排流水号个数
                  LET l_lru05_num = l_lru01_max_o - l_lru01_min_o + 1 + l_lru05_num
               ELSE 
                  LET l_lru05_num = 0                           
               END IF                              
            WHEN "2" #按年月                                    
               LET l_num_len = l_num_len - 4       
               IF NOT cl_null(l_lru05_old) THEN                 
                  IF YEAR(l_lru05_old) = YEAR(l_lru05) AND MONTH(l_lru05_old) = MONTH(l_lru05) THEN
                     LET l_lru05_num = l_lru01_max_o - l_lru01_min_o + 1 + l_lru05_num
                  ELSE
                     LET l_lru05_num = 0
                  END IF
               ELSE
                  LET l_lru05_num = 0
               END IF
            WHEN "3" #按年周
               LET l_num_len = l_num_len - 4
               IF NOT cl_null(l_lru05_old) THEN
                  INITIALIZE l_azn05 TO NULL
                  SELECT azn05 INTO l_azn05 FROM azn_file WHERE azn01 = l_lru05
                  IF YEAR(l_lru05_old) = YEAR(l_lru05) AND l_azn05_old = l_azn05 THEN
                     LET l_lru05_num = l_lru01_max_o - l_lru01_min_o + 1 + l_lru05_num
                  ELSE
                     LET l_lru05_num = 0
                  END IF
               ELSE
                  LET l_lru05_num = 0
               END IF
            WHEN "4" #按年月日
               LET l_num_len = l_num_len - 6
              #FUN-D30061 Mark&Add Begin ---
              #IF NOT cl_null(l_lru05_old) THEN
              #   LET l_lru05_num = l_lru01_max_o - l_lru01_min_o + 1 + l_lru05_num
              #ELSE
              #   LET l_lru05_num = 0
              #END IF
               LET l_lru05_num = 0
              #FUN-D30061 Mark&Add End -----
         END CASE

         LET l_lru01_min_o = l_lru01_min
         LET l_lru01_max_o = l_lru01_max
         LET l_azn05_old   = l_azn05
         LET l_lru05_old   = l_lru05

         INITIALIZE l_num_str TO NULL
         FOR l_cnt = 1 TO l_num_len
            LET l_num_str = l_num_str CLIPPED,'0'
         END FOR
         LET l_lru01_str = l_lru01
         LET l_lru01_num = l_lru01_str.subString(l_lru01_str.getLength() - l_num_len + 1,l_lru01_str.getLength())
         LET l_lru01_chr = l_lru01_str.subString(1,l_lru01_str.getLength() - l_num_len)
         #   最大流水号  = 实际流水号  - 最小ROWNUM  + 已排流水号个数
         LET l_lru01_num = l_lru01_num - l_lru01_min + l_lru05_num

         #批次更新oea_temp中的单号
         LET l_upd = "UPDATE lru_temp SET lru01 = '",l_lru01_chr CLIPPED,"'||","substr(to_char","((lru01 + '",l_lru01_num,"'),'",l_num_str,"'),2) ",
                     " WHERE lru05 = '",l_lru05,"' "
         PREPARE salecard_upd_lru01_pre FROM l_upd
         EXECUTE salecard_upd_lru01_pre 
         IF SQLCA.sqlcode THEN 
            LET g_success = 'N'
            LET g_errno   = SQLCA.sqlcode
            LET g_msg1    = 'Oper:Upd'||' '||'Table:lru_temp'||' '||'Field:lru01'||' '||'Shop:'||p_azw01
            CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
            ROLLBACK WORK
            CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
            LET g_msg   = g_msg[1,255]
            CALL p200_log(g_trans_no,p_azw01,'Batch Operation','05','tg_SaleCard',g_errno,g_msg,'0','N',g_msg1)
            LET g_errno = ''
            LET g_msg   = ''
            LET g_msg1  = ''
            CONTINUE WHILE
         END IF   
      END FOREACH    
      
      LET l_ins = "INSERT INTO lrv_temp( ",
                  "                     lrv00, ",      #单据类型
                  "                     lrv01, ",      #单据编号
                  "                     lrv02, ",      #卡号
                  "                     lrv03, ",      #原有效期
                  "                     lrv04, ",      #有效期
                  "                     lrvlegal, ",   #法人
                  "                     lrvplant) "    #門店編號
      LET l_sel = "SELECT ",
                  "       '2', ",         #lrv00      #单据类型
                  "       lru01, ",       #lrv01      #单据编号
                  "       BeginCard, ",   #lrv02      #卡号
                  "       lpj05, ",       #lrv03      #原有效期
                  "       NULL, ",        #lrv04      #有效期
                  "       lrulegal, ",    #lrvlegal   #法人
                  "       lruplant ",     #lrvplant   #門店編號
                  "   FROM ",g_posdbs,"tg_SaleCard_Detail",g_db_links," ",
                  "        LEFT OUTER JOIN lpj_file ON lpj03 = BeginCard ",
                  "       ,lru_temp ",
                  " WHERE lru10 = SaleCardno "
      LET l_sql = l_ins CLIPPED," ",l_sel CLIPPED
      PREPARE ins_lrv_temp_pre FROM l_sql
      EXECUTE ins_lrv_temp_pre 
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Ins'||' '||'Table:lrv_temp'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','05','tg_SaleCard',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'tg_SaleCard',p_azw01) #将对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF
      
      #将临时表lru_temp插入到数据库中
      LET l_ins = " INSERT INTO ",cl_get_target_table(p_azw01,'lru_file'),
                  " SELECT * FROM lru_temp "
      CALL cl_replace_sqldb(l_ins) RETURNING l_ins
      CALL cl_parse_qry_sql(l_ins,p_azw01) RETURNING l_ins
      PREPARE salecard_ins_lru_pre FROM l_ins
      EXECUTE salecard_ins_lru_pre
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Ins'||' '||'Table:lru_file'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','05','TG_SALECARD',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'tg_SaleCard',p_azw01) #将对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF
      
      #将临时表lrv_temp插入到数据库中
      LET l_ins = " INSERT INTO ",cl_get_target_table(p_azw01,'lrv_file'),
                  " SELECT * FROM lrv_temp "
      CALL cl_replace_sqldb(l_ins) RETURNING l_ins
      CALL cl_parse_qry_sql(l_ins,p_azw01) RETURNING l_ins
      PREPARE salecard_ins_lrv_pre FROM l_ins
      EXECUTE salecard_ins_lrv_pre
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Ins'||' '||'Table:lrv_file'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','05','TG_SALECARD',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'tg_SaleCard',p_azw01) #将对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF
      
      #更新中间库标志位
      CALL p200_upd_posflag_p("1","lru_file","tg_SaleCard",p_azw01)
      IF g_success = 'N' THEN
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Upd'||' '||'Table:tg_Recharge'||' '||'Field:Condition2'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','05','TG_SALECARD',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = '' 
         LET g_msg   = '' 
         LET g_msg1  = '' 
         CALL p200_upd_posflag_p('2',p_gat01,'tg_SaleCard',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF
      
      IF g_success = 'Y' THEN
         LET g_sucflag = 1
         COMMIT WORK
      ELSE
         ROLLBACK WORK
      END IF

   END WHILE
   #删除建立的临时表
   DROP TABLE lru_temp
   DROP TABLE lrv_temp
END FUNCTION
#FUN-CA0160 Add End -----

#FUN-CA0160 Add Begin ---
#卡储值上传
FUNCTION p200_lpu_ins_p(p_gat01,p_azw01)
DEFINE p_gat01       LIKE gat_file.gat01
DEFINE p_azw01       LIKE azw_file.azw01
DEFINE p_azw02       LIKE azw_file.azw02
DEFINE l_ins         STRING
DEFINE l_sel         STRING
DEFINE l_sql         STRING
DEFINE l_upd         STRING
DEFINE l_upd_num     LIKE type_file.num10
DEFINE l_lpu01_min_o LIKE lpu_file.lpu01
DEFINE l_lpu01_max_o LIKE lpu_file.lpu01
DEFINE l_lpu10_old   LIKE lpu_file.lpu10
DEFINE l_lpu10       LIKE lpu_file.lpu10
DEFINE l_lpu10_num   LIKE type_file.num10
DEFINE l_lpu01_min   LIKE lpu_file.lpu01
DEFINE l_lpu01_max   LIKE lpu_file.lpu01
DEFINE l_lpu01_str   STRING
DEFINE l_lpu01       LIKE lpu_file.lpu01
DEFINE l_lpu01_num   LIKE type_file.chr20
DEFINE l_lpu01_chr   LIKE type_file.chr20
DEFINE l_oga01       LIKE oga_file.oga01
DEFINE l_oga01_str   STRING 
DEFINE l_oga01_num   LIKE type_file.chr20
DEFINE l_oga01_chr   LIKE type_file.chr20
DEFINE l_azn05_old   LIKE azn_file.azn05
DEFINE l_azn05       LIKE azn_file.azn05
DEFINE l_num_len     LIKE type_file.num10
DEFINE l_num_str     LIKE type_file.chr20
DEFINE l_cnt         LIKE type_file.num10

   #组出过滤条件
   IF NOT cl_null(g_saleno) THEN
      LET g_wc = " Rechargeno = '",g_saleno,"' "
   ELSE
      CALL p200_g_wc("lpu_file") RETURNING g_wc
   END IF
   IF cl_null(g_wc) THEN LET g_wc = " 1=1" END IF

   SELECT azw02 INTO p_azw02 FROM azw_file WHERE azw01 = p_azw01
   
   #将中间库中满足条件的单据Condition2更新为B
   LET l_upd = "UPDATE ",g_posdbs,"tg_Recharge",g_db_links," ",
               "   SET Condition2 = 'B' ",
               " WHERE Condition2 <> 'Y' AND BillType = '0' AND Cnfflg = 'Y' AND Shop = '",p_azw01 CLIPPED,"' AND ",g_wc CLIPPED
   PREPARE recharge_upd_tg_recharge_pre1 FROM l_upd
   EXECUTE recharge_upd_tg_recharge_pre1
   IF SQLCA.sqlcode THEN
      LET g_success = 'N'
      LET g_errno   = SQLCA.sqlcode
      LET g_msg1    = 'Oper:Upd'||' '||'Table:tg_Recharge'||' '||'Shop:'||p_azw01
      CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
      ROLLBACK WORK
      CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
      LET g_msg   = g_msg[1,255]
      CALL p200_log(g_trans_no,p_azw01,'Batch Operation','05','tg_Recharge',g_errno,g_msg,'0','N',g_msg1)
      LET g_errno = ''
      LET g_msg   = ''
      LET g_msg1  = ''
      RETURN
   END IF
   
   LET l_upd_num = SQLCA.sqlerrd[3]           #本次需上传总笔数
   IF l_upd_num <= 0 THEN RETURN END IF
   IF cl_null(g_sum_limit) OR g_sum_limit = 0 THEN LET g_sum_limit = l_upd_num END IF
   
   #先删除需要建立的临时表
   DROP TABLE lpu_temp
   DROP TABLE oga_temp
   DROP TABLE ogb_temp
   DROP TABLE ogh_temp     #FUN-D20096 Add
   DROP TABLE ogi_temp     #FUN-D20096 Add
   DROP TABLE rxx_temp
   DROP TABLE rxy_temp
   DROP TABLE rxz_temp
   
   #建立临时表
   SELECT * FROM lpu_file WHERE 1=0 INTO TEMP lpu_temp
   SELECT * FROM oga_file WHERE 1=0 INTO TEMP oga_temp
   SELECT * FROM ogb_file WHERE 1=0 INTO TEMP ogb_temp
   SELECT * FROM ogh_file WHERE 1=0 INTO TEMP ogh_temp     #FUN-D20096 Add
   SELECT * FROM ogi_file WHERE 1=0 INTO TEMP ogi_temp     #FUN-D20096 Add
   SELECT * FROM rxx_file WHERE 1=0 INTO TEMP rxx_temp
   SELECT * FROM rxy_file WHERE 1=0 INTO TEMP rxy_temp
   SELECT * FROM rxz_file WHERE 1=0 INTO TEMP rxz_temp
   
   #建立索引
   
   WHILE l_upd_num > 0                        #剩余笔数大于0做WHILE循环
      LET l_upd_num = l_upd_num - g_sum_limit #依次减去每批的笔数
      
      #清空临时表
      DELETE FROM lpu_temp
      DELETE FROM oga_temp
      DELETE FROM ogb_temp
      DELETE FROM ogh_temp     #FUN-D20096 Add
      DELETE FROM ogi_temp     #FUN-D20096 Add
      DELETE FROM rxx_temp
      DELETE FROM rxy_temp
      DELETE FROM rxz_temp
      
      LET g_success = 'Y'
      BEGIN WORK

      LET l_ins = "INSERT INTO lpu_temp( ",
                  "                     lpu01, ",       #單據編號
                  "                     lpu02, ",       #nouse
                  "                     lpu03, ",       #儲值卡編號
                  "                     lpu04, ",       #儲值卡餘額
                  "                     lpu05, ",       #充值金額
                  "                     lpu06, ",       #實付金額
                  "                     lpu07, ",       #折扣金額
                  "                     lpu071, ",      #折扣比率
                  "                     lpu08, ",       #確認碼
                  "                     lpu09, ",       #確認人
                  "                     lpu10, ",       #確認日期
                  "                     lpu11, ",       #備注
                  "                     lpu12, ",       #已付款金額
                  "                     lpu13, ",       #帳款編號
                  "                     lpu14, ",       #金額有效期至
                  "                     lpu15, ",       #加值金額
                  "                     lpu16, ",       #對應出貨單號
                  "                     lpu17, ",       #POS單號
                  "                     lpuacti, ",     #資料有效碼
                  "                     lpucrat, ",     #資料創建日
                  "                     lpudate, ",     #資料修改日
                  "                     lpugrup, ",     #資料所有群
                  "                     lpulegal, ",    #所屬法人
                  "                     lpumodu, ",     #資料修改者
                  "                     lpuplant, ",    #所屬營運中心
                  "                     lpuuser, ",     #資料所有者
                  "                     lpuoriu, ",     #資料建立者
                  "                     lpuorig) "      #資料建立部門
      LET l_sel = "SELECT ",
                  "       ROW_NUMBER() over(order by Bdate,Rechargeno), ",   #lpu01       #單據編號
                  "       NULL, ",                                           #lpu02       #nouse
                  "       Cardno, ",                                         #lpu03       #儲值卡編號
                 #"       lpj06, ",                                          #lpu04       #儲值卡餘額 #FUN-CB0103 Mark
                  "       BeforAmt, ",                                       #lpu04       #儲值卡餘額 #FUN-CB0103 Add
                  "       RechargeAmt, ",                                    #lpu05       #充值金額
                  "       RechargeAmt, ",                                    #lpu06       #實付金額
                  "       Disc, ",                                           #lpu07       #折扣金額
                  "       lpj11, ",                                          #lpu071      #折扣比率
                  "       'Y', ",                                            #lpu08       #確認碼
                  "       ryi02, ",                                          #lpu09       #確認人
                 #"       CAST(Bdate AS DATE), ",                            #lpu10       #確認日期 #FUN-D10144 Mark
                  "       CAST(Sdate AS DATE), ",                            #lpu10       #確認日期 #FUN-D10144 Add
                  "       NULL, ",                                           #lpu11       #備注
                  "       RechargeAmt, ",                                    #lpu12       #已付款金額
                  "       NULL, ",                                           #lpu13       #帳款編號
                  "       NULL, ",                                           #lpu14       #金額有效期至
                  "       RealAmt-RechargeAmt, ",                            #lpu15       #加值金額
                  "       ROW_NUMBER() over(order by Bdate,Rechargeno), ",   #lpu16       #對應出貨單號
                  "       Rechargeno, ",                                     #lpu17       #POS單號
                  "       'Y', ",                                            #lpuacti     #資料有效碼
                 #"       CAST(Bdate AS DATE), ",                            #lpucrat     #資料創建日 #FUN-D10144 Mark
                  "       CAST(Sdate AS DATE), ",                            #lpucrat     #資料創建日 #FUN-D10144 Add
                 #"       CAST(Bdate AS DATE), ",                            #lpudate     #資料修改日 #FUN-D10144 Mark
                  "       CAST(Sdate AS DATE), ",                            #lpudate     #資料修改日 #FUN-D10144 Add
                  "       gen03, ",                                          #lpugrup     #資料所有群
                  "       '",p_azw02,"', ",                                  #lpulegal    #所屬法人
                  "       ryi02, ",                                          #lpumodu     #資料修改者
                  "       Shop, ",                                           #lpuplant    #所屬營運中心
                  "       ryi02, ",                                          #lpuuser     #資料所有者
                  "       ryi02, ",                                          #lpuoriu     #資料建立者
                  "       gen03 ",                                           #lpuorig     #資料建立部門
                  "  FROM ( ",
                  "SELECT * ",
                  "  FROM ",g_posdbs,"tg_Recharge",g_db_links," ",
                  " WHERE Shop = '",p_azw01,"' AND Condition2 = 'B' AND Cnfflg = 'Y' ",
                  " ORDER BY Bdate,Rechargeno) LEFT OUTER JOIN ",cl_get_target_table(p_azw01,'ryi_file'),
                  "                                         ON ryi01 = Opno ",
                  "                            LEFT OUTER JOIN ",cl_get_target_table(p_azw01,'gen_file'),
                  "                                         ON gen01 = ryi02 ",
                  "                            LEFT OUTER JOIN ",cl_get_target_table(p_azw01,'lpj_file'),
                  "                                         ON lpj03 = Cardno ",
                  " WHERE ROWNUM <= ",g_sum_limit," ",
                  " ORDER BY Bdate,Rechargeno "
      LET l_sql = l_ins CLIPPED," ",l_sel CLIPPED
      PREPARE recharge_ins_lpu_temp_pre FROM l_sql
      EXECUTE recharge_ins_lpu_temp_pre
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Ins'||' '||'Table:lpu_temp'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','05','tg_Recharge',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CONTINUE WHILE
      END IF
      
      INITIALIZE l_lpu10_old,l_lpu01_min_o,l_lpu01_max_o,l_azn05_old TO NULL                                    
      INITIALIZE l_lpu10,l_lpu10_num,l_lpu01_min,l_lpu01_max,l_azn05 TO NULL
      LET l_sql = "SELECT DISTINCT MIN(to_number(lpu01)),lpu10,MAX(to_number(lpu01)) FROM lpu_temp GROUP BY lpu10 order by lpu10"
      PREPARE recharge_sel_lpu10_pre FROM l_sql
      DECLARE recharge_sel_lpu10_cs CURSOR FOR recharge_sel_lpu10_pre
      FOREACH recharge_sel_lpu10_cs INTO l_lpu01_min,l_lpu10,l_lpu01_max
      
        #自动编号
         LET g_ndate = l_lpu10
        #CALL p200_auto_doc(p_gat01,p_azw01) RETURNING l_lpu01     #FUN-CC0082 Mark
         CALL p200_auto_doc(p_gat01,p_azw01,'Y') RETURNING l_lpu01 #FUN-CC0082 Add
         IF g_success = 'N' THEN
            EXIT WHILE
         END IF
        #CALL p200_auto_doc("oga_file",p_azw01) RETURNING l_oga01     #FUN-CC0082 Mark
         CALL p200_auto_doc("oga_file",p_azw01,'Y') RETURNING l_oga01 #FUN-CC0082 Add
         IF g_success = 'N' THEN
            EXIT WHILE
         END IF
         
         CASE g_ryz05
            WHEN "1"
               LET l_num_len = 8
            WHEN "2"
               LET l_num_len = 9
            WHEN "3"
               LET l_num_len = 10
         END CASE
         
         CASE g_ryz06
            WHEN "1" #按流水号
               LET l_num_len = l_num_len
               IF NOT cl_null(l_lpu10_old) THEN
                  #已排流水号个数 = 最大流水号旧值- 最小流水号旧值+ 1 + 上一笔已排流水号个数
                  LET l_lpu10_num = l_lpu01_max_o - l_lpu01_min_o + 1 + l_lpu10_num
               ELSE
                  LET l_lpu10_num = 0
               END IF
            WHEN "2" #按年月
               LET l_num_len = l_num_len - 4
               IF NOT cl_null(l_lpu10_old) THEN 
                  IF YEAR(l_lpu10_old) = YEAR(l_lpu10) AND MONTH(l_lpu10_old) = MONTH(l_lpu10) THEN
                     LET l_lpu10_num = l_lpu01_max_o - l_lpu01_min_o + 1 + l_lpu10_num
                  ELSE
                     LET l_lpu10_num = 0
                  END IF
               ELSE
                  LET l_lpu10_num = 0
               END IF
            WHEN "3" #按年周
               LET l_num_len = l_num_len - 4
               IF NOT cl_null(l_lpu10_old) THEN
                  INITIALIZE l_azn05 TO NULL
                  SELECT azn05 INTO l_azn05 FROM azn_file WHERE azn01 = l_lpu10
                  IF YEAR(l_lpu10_old) = YEAR(l_lpu10) AND l_azn05_old = l_azn05 THEN
                     LET l_lpu10_num = l_lpu01_max_o - l_lpu01_min_o + 1 + l_lpu10_num
                  ELSE
                     LET l_lpu10_num = 0
                  END IF
               ELSE
                  LET l_lpu10_num = 0
               END IF
            WHEN "4" #按年月日
               LET l_num_len = l_num_len - 6
              #FUN-D30061 Mark&Add Begin ---
              #IF NOT cl_null(l_lpu10_old) THEN
              #   LET l_lpu10_num = l_lpu01_max_o - l_lpu01_min_o + 1 + l_lpu10_num
              #ELSE
              #   LET l_lpu10_num = 0
              #END IF
               LET l_lpu10_num = 0
              #FUN-D30061 Mark&Add End -----
         END CASE
            
         LET l_lpu01_min_o = l_lpu01_min
         LET l_lpu01_max_o = l_lpu01_max
         LET l_azn05_old   = l_azn05
         LET l_lpu10_old   = l_lpu10
               
         INITIALIZE l_num_str TO NULL
         FOR l_cnt = 1 TO l_num_len
            LET l_num_str = l_num_str CLIPPED,'0'
         END FOR
         LET l_lpu01_str = l_lpu01
         LET l_lpu01_num = l_lpu01_str.subString(l_lpu01_str.getLength() - l_num_len + 1,l_lpu01_str.getLength())
         LET l_lpu01_chr = l_lpu01_str.subString(1,l_lpu01_str.getLength() - l_num_len)
         #   最大流水号  = 实际流水号  - 最小ROWNUM  + 已排流水号个数
         LET l_lpu01_num = l_lpu01_num - l_lpu01_min + l_lpu10_num
         LET l_oga01_str = l_oga01
         LET l_oga01_num = l_oga01_str.subString(l_oga01_str.getLength() - l_num_len + 1,l_oga01_str.getLength())
         LET l_oga01_chr = l_oga01_str.subString(1,l_oga01_str.getLength() - l_num_len)
         #   最大流水号  = 实际流水号  - 最小ROWNUM  + 已排流水号个数
         LET l_oga01_num = l_oga01_num - l_lpu01_min + l_lpu10_num
         
         #批次更新oea_temp中的单号
         LET l_upd = "UPDATE lpu_temp SET lpu01 = '",l_lpu01_chr CLIPPED,"'||","substr(to_char","((lpu01 + '",l_lpu01_num,"'),'",l_num_str,"'),2), ",
                     "                    lpu16 = '",l_oga01_chr CLIPPED,"'||","substr(to_char","((lpu16 + '",l_oga01_num,"'),'",l_num_str,"'),2) ",
                     " WHERE lpu10 = '",l_lpu10,"' "
         PREPARE recharge_upd_lpu01_pre FROM l_upd
         EXECUTE recharge_upd_lpu01_pre
         IF SQLCA.sqlcode THEN
            LET g_success = 'N'
            LET g_errno   = SQLCA.sqlcode
            LET g_msg1    = 'Oper:Upd'||' '||'Table:lpu_temp'||' '||'Field:lpu01/lpu16'||' '||'Shop:'||p_azw01
            CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
            ROLLBACK WORK
            CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
            LET g_msg   = g_msg[1,255]
            CALL p200_log(g_trans_no,p_azw01,'Batch Operation','05','tg_Recharge',g_errno,g_msg,'0','N',g_msg1)
            LET g_errno = ''
            LET g_msg   = ''
            LET g_msg1  = ''
            CALL p200_upd_posflag_p('2',p_gat01,'tg_Recharge',p_azw01) #将对应中间库的资料Condition2更新为A
            CONTINUE WHILE
         END IF
      END FOREACH
      
      #检查单据日期
      INITIALIZE l_lpu10 TO NULL
      SELECT MIN(lpu10) INTO l_lpu10 FROM lpu_temp WHERE lpu10 <= g_sma.sma53
      IF NOT cl_null(l_lpu10) THEN
         LET g_errno   = 'apc1054' #该批次资料中存在最小单据日期小于等于关帐日期
         LET g_msg1    = 'Oper:Chk'||' '||'Table:lpu_temp'||' '||'MIN(lpu10):'||l_lpu10||' '||'Shop:'||p_azw01
        #CALL s_errmsg('Batch Operation','',g_msg1,SQLCA.sqlcode,1) #FUN-CB0103 Mark
         CALL s_errmsg('Batch Operation','',g_msg1,g_errno,1)       #FUN-CB0103 Add
         ROLLBACK WORK 
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','05','TG_RECHARGE',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
      END IF 
      
      #更新中间库状态为A
      LET l_upd = "UPDATE ",g_posdbs,"tg_Recharge",g_db_links," ",
                  "   SET Condition2 = 'A' ", 
                  " WHERE Shop = '",p_azw01,"' ",
                  "   AND EXISTS (SELECT 1 ", 
                  "                 FROM lpu_temp ",   
                  "                WHERE lpu10 <= '",g_sma.sma53,"' ",
                  "                  AND lpu17 = Rechargeno) "
      PREPARE recharge_upd_tg_recharge_flag_lpu_pre2 FROM l_upd
      EXECUTE recharge_upd_tg_recharge_flag_lpu_pre2 
      
      #删除出货日期小于等于关帐日期的资料
      DELETE FROM lpu_temp WHERE lpu10 <= g_sma.sma53
      
      #ins xyz
      CALL p200_cardcoupon_xyz_ins_p("lpu_file",p_azw01)
      IF g_success='N' THEN
      END IF
      
      #产生出货单以及付款资料
      CALL p200_prod_oga_p('2',p_azw01)
      IF g_success = 'N' THEN
         CALL p200_upd_posflag_p('2',p_gat01,'tg_Recharge',p_azw01) #将对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF
      
      #将临时表lpu_temp插入到数据库中
      LET l_ins = " INSERT INTO ",cl_get_target_table(p_azw01,'lpu_file'),
                  " SELECT * FROM lpu_temp "
      CALL cl_replace_sqldb(l_ins) RETURNING l_ins
      CALL cl_parse_qry_sql(l_ins,p_azw01) RETURNING l_ins
      PREPARE recharge_ins_lpu_pre FROM l_ins
      EXECUTE recharge_ins_lpu_pre
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Ins'||' '||'Table:lpu_file'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','05','TG_RECHARGE',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'tg_Recharge',p_azw01) #将对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF

      #将临时表oga_temp插入到数据库中
      LET l_ins = " INSERT INTO ",cl_get_target_table(p_azw01,'oga_file'),
                  " SELECT * FROM oga_temp "
      CALL cl_replace_sqldb(l_ins) RETURNING l_ins
      CALL cl_parse_qry_sql(l_ins,p_azw01) RETURNING l_ins
      PREPARE recharge_ins_oga_lpu_pre FROM l_ins
      EXECUTE recharge_ins_oga_lpu_pre
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Ins'||' '||'Table:oga_file'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','05','TG_RECHARGE',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'tg_Recharge',p_azw01) #将对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF
      
      #将临时表ogb_temp插入到数据库中
      LET l_ins = " INSERT INTO ",cl_get_target_table(p_azw01,'ogb_file'),
                  " SELECT * FROM ogb_temp "
      CALL cl_replace_sqldb(l_ins) RETURNING l_ins
      CALL cl_parse_qry_sql(l_ins,p_azw01) RETURNING l_ins
      PREPARE recharge_ins_ogb_lpu_pre FROM l_ins
      EXECUTE recharge_ins_ogb_lpu_pre
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Ins'||' '||'Table:ogb_file'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','05','TG_RECHARGE',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'tg_Recharge',p_azw01) #将对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF

      #FUN-D20096---Add---Str
      #将临时表ogh_temp插入到数据库中
      LET l_ins = " INSERT INTO ",cl_get_target_table(p_azw01,'ogh_file'),
                  " SELECT * FROM ogh_temp "
      CALL cl_replace_sqldb(l_ins) RETURNING l_ins
      CALL cl_parse_qry_sql(l_ins,p_azw01) RETURNING l_ins
      PREPARE recharge_ins_ogh_lpu_pre FROM l_ins
      EXECUTE recharge_ins_ogh_lpu_pre
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Ins'||' '||'Table:ogh_file'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','05','tg_SaleCard_Tax',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'tg_SaleCard_Tax',p_azw01) #将对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF

      #将临时表ogi_temp插入到数据库中
      LET l_ins = " INSERT INTO ",cl_get_target_table(p_azw01,'ogi_file'),
                  " SELECT * FROM ogi_temp "
      CALL cl_replace_sqldb(l_ins) RETURNING l_ins
      CALL cl_parse_qry_sql(l_ins,p_azw01) RETURNING l_ins
      PREPARE recharge_ins_ogi_lpu_pre FROM l_ins
      EXECUTE recharge_ins_ogi_lpu_pre
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Ins'||' '||'Table:ogi_file'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','05','tg_SaleCard_Detail_Tax',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'tg_SaleCard_Detail_Tax',p_azw01) #将对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF
      #FUN-D20096---Add---End
      
      #将临时表rxx_temp插入到数据库中
      LET l_ins = " INSERT INTO ",cl_get_target_table(p_azw01,'rxx_file'),
                  " SELECT * FROM rxx_temp "
      CALL cl_replace_sqldb(l_ins) RETURNING l_ins
      CALL cl_parse_qry_sql(l_ins,p_azw01) RETURNING l_ins
      PREPARE recharge_ins_rxx_lpu_pre FROM l_ins
      EXECUTE recharge_ins_rxx_lpu_pre
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Ins'||' '||'Table:rxx_file'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','05','TG_RECHARGE',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'tg_Recharge',p_azw01) #将对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF
      
      #将临时表rxy_temp插入到数据库中
      LET l_ins = " INSERT INTO ",cl_get_target_table(p_azw01,'rxy_file'),
                  " SELECT * FROM rxy_temp "
      CALL cl_replace_sqldb(l_ins) RETURNING l_ins
      CALL cl_parse_qry_sql(l_ins,p_azw01) RETURNING l_ins
      PREPARE recharge_ins_rxy_lpu_pre FROM l_ins
      EXECUTE recharge_ins_rxy_lpu_pre
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Ins'||' '||'Table:rxy_file'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','05','TG_RECHARGE',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'tg_Recharge',p_azw01) #将对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF
      
      #将临时表rxz_temp插入到数据库中
      LET l_ins = " INSERT INTO ",cl_get_target_table(p_azw01,'rxz_file'),
                  " SELECT * FROM rxz_temp "
      CALL cl_replace_sqldb(l_ins) RETURNING l_ins
      CALL cl_parse_qry_sql(l_ins,p_azw01) RETURNING l_ins
      PREPARE recharge_ins_rxz_lpu_pre FROM l_ins
      EXECUTE recharge_ins_rxz_lpu_pre
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Ins'||' '||'Table:rxz_file'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','05','TG_RECHARGE',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'tg_Recharge',p_azw01) #将对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF

      #更新中间库标志位
      CALL p200_upd_posflag_p("1","lpu_file","tg_Recharge",p_azw01)
      IF g_success = 'N' THEN
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Upd'||' '||'Table:tg_Recharge'||' '||'Field:Condition2'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK 
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','05','TG_RECHARGE',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'tg_Recharge',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF 

      IF g_success = 'Y' THEN
         LET g_sucflag = 1
         COMMIT WORK
      ELSE
         ROLLBACK WORK
      END IF
      
   END WHILE
   #删除建立的临时表
   DROP TABLE lpu_temp
   DROP TABLE oga_temp
   DROP TABLE ogb_temp
   DROP TABLE ogh_temp   #FUN-D20096 Add
   DROP TABLE ogi_temp   #FUN-D20096 Add
   DROP TABLE rxx_temp
   DROP TABLE rxy_temp
   DROP TABLE rxz_temp
END FUNCTION
#FUN-CA0160 Add End -----

#FUN-CA0160 Add Begin ---
#换卡上传
FUNCTION p200_lrw_ins_p(p_gat01,p_azw01)
DEFINE p_gat01       LIKE gat_file.gat01
DEFINE p_azw01       LIKE azw_file.azw01
DEFINE p_azw02       LIKE azw_file.azw02
DEFINE l_ins         STRING
DEFINE l_sel         STRING
DEFINE l_sql         STRING
DEFINE l_upd         STRING
DEFINE l_upd_num     LIKE type_file.num10
DEFINE l_lrw01_min_o LIKE lrw_file.lrw01
DEFINE l_lrw01_max_o LIKE lrw_file.lrw01
DEFINE l_lrw15_old   LIKE lrw_file.lrw15
DEFINE l_lrw15       LIKE lrw_file.lrw15
DEFINE l_lrw15_num   LIKE type_file.num10
DEFINE l_lrw01_min   LIKE lrw_file.lrw01
DEFINE l_lrw01_max   LIKE lrw_file.lrw01
DEFINE l_lrw01_str   STRING
DEFINE l_lrw01       LIKE lrw_file.lrw01
DEFINE l_lrw01_num   LIKE type_file.chr20
DEFINE l_lrw01_chr   LIKE type_file.chr20
DEFINE l_oga01       LIKE oga_file.oga01
DEFINE l_oga01_str   STRING 
DEFINE l_oga01_num   LIKE type_file.chr20
DEFINE l_oga01_chr   LIKE type_file.chr20
DEFINE l_azn05_old   LIKE azn_file.azn05
DEFINE l_azn05       LIKE azn_file.azn05
DEFINE l_num_len     LIKE type_file.num10
DEFINE l_num_str     LIKE type_file.chr20
DEFINE l_cnt         LIKE type_file.num10

   #组出过滤条件
   IF NOT cl_null(g_saleno) THEN
      LET g_wc = " ChangeCardno = '",g_saleno,"' "
   ELSE
      CALL p200_g_wc("lrw_file") RETURNING g_wc
   END IF
   IF cl_null(g_wc) THEN LET g_wc = " 1=1" END IF

   SELECT azw02 INTO p_azw02 FROM azw_file WHERE azw01 = p_azw01
   
   #将中间库中满足条件的单据Condition2更新为B
   LET l_upd = "UPDATE ",g_posdbs,"tg_ChangeCard",g_db_links," ",
               "   SET Condition2 = 'B' ",
               " WHERE Condition2 <> 'Y' AND Cnfflg = 'Y' AND Shop = '",p_azw01 CLIPPED,"' AND ",g_wc CLIPPED
   PREPARE changecard_upd_tg_changecard_pre FROM l_upd
   EXECUTE changecard_upd_tg_changecard_pre
   IF SQLCA.sqlcode THEN
      LET g_success = 'N'
      LET g_errno   = SQLCA.sqlcode
      LET g_msg1    = 'Oper:Upd'||' '||'Table:tg_ChangeCard'||' '||'Shop:'||p_azw01
      CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
      ROLLBACK WORK
      CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
      LET g_msg   = g_msg[1,255]
      CALL p200_log(g_trans_no,p_azw01,'Batch Operation','05','tg_ChangeCard',g_errno,g_msg,'0','N',g_msg1)
      LET g_errno = ''
      LET g_msg   = ''
      LET g_msg1  = ''
      RETURN
   END IF
   
   LET l_upd_num = SQLCA.sqlerrd[3]           #本次需上传总笔数
   IF l_upd_num <= 0 THEN RETURN END IF
   IF cl_null(g_sum_limit) OR g_sum_limit = 0 THEN LET g_sum_limit = l_upd_num END IF
   
   #先删除需要建立的临时表
   DROP TABLE lrw_temp
   DROP TABLE oga_temp
   DROP TABLE ogb_temp
   DROP TABLE ogh_temp    #FUN-D20096 Add
   DROP TABLE ogi_temp    #FUN-D20096 Add
   DROP TABLE rxx_temp
   DROP TABLE rxy_temp
   DROP TABLE rxz_temp
   
   #建立临时表
   SELECT * FROM lrw_file WHERE 1=0 INTO TEMP lrw_temp
   SELECT * FROM oga_file WHERE 1=0 INTO TEMP oga_temp
   SELECT * FROM ogb_file WHERE 1=0 INTO TEMP ogb_temp
   SELECT * FROM ogh_file WHERE 1=0 INTO TEMP ogh_temp    #FUN-D20096 Add
   SELECT * FROM ogi_file WHERE 1=0 INTO TEMP ogi_temp    #FUN-D20096 Add
   SELECT * FROM rxx_file WHERE 1=0 INTO TEMP rxx_temp
   SELECT * FROM rxy_file WHERE 1=0 INTO TEMP rxy_temp
   SELECT * FROM rxz_file WHERE 1=0 INTO TEMP rxz_temp
   
   #建立索引
   
   WHILE l_upd_num > 0                        #剩余笔数大于0做WHILE循环
      LET l_upd_num = l_upd_num - g_sum_limit #依次减去每批的笔数
      
      #清空临时表
      DELETE FROM lrw_temp
      DELETE FROM oga_temp
      DELETE FROM ogb_temp
      DELETE FROM ogh_temp    #FUN-D20096 Add
      DELETE FROM ogi_temp    #FUN-D20096 Add
      DELETE FROM rxx_temp
      DELETE FROM rxy_temp
      DELETE FROM rxz_temp
      
      LET g_success = 'Y'
      BEGIN WORK

      LET l_ins = "INSERT INTO lrw_temp( ",
                  "                     lrw01, ",       #單據編號
                  "                     lrw02, ",       #會員編號
                  "                     lrw03, ",       #原卡卡號
                  "                     lrw04, ",       #卡種編號
                  "                     lrw05, ",       #原卡狀態
                  "                     lrw06, ",       #原卡內餘額
                  "                     lrw07, ",       #原卡內積分
                  "                     lrw08, ",       #原卡有效期
                  "                     lrw09, ",       #新卡卡號
                  "                     lrw10, ",       #新卡卡種
                  "                     lrw11, ",       #新卡卡內金額
                  "                     lrw12, ",       #新卡卡內積分
                  "                     lrw13, ",       #新卡有效期
                  "                     lrw14, ",       #換卡原因編號
                  "                     lrw15, ",       #單據日期
                  "                     lrw16, ",       #確認碼
                  "                     lrw17, ",       #確認人
                  "                     lrw18, ",       #確認日期
                  "                     lrw19, ",       #備註
                  "                     lrw20, ",       #原卡儲值折扣率
                  "                     lrw21, ",       #原會員等級
                  "                     lrw22, ",       #現會員等級
                  "                     lrw23, ",       #換卡手續費
                  "                     lrw24, ",       #對應出貨單號
                  "                     lrw25, ",       #POS單號
                  "                     lrwacti, ",     #資料有效碼
                  "                     lrwcrat, ",     #資料創建日
                  "                     lrwdate, ",     #最近修改日
                  "                     lrwgrup, ",     #資料所有群
                  "                     lrwlegal, ",    #所屬法人
                  "                     lrwmodu, ",     #資料修改者
                  "                     lrworig, ",     #資料建立部門
                  "                     lrworiu, ",     #資料建立者
                  "                     lrwplant, ",    #所屬營運中心
                  "                     lrwuser) "      #資料所有者
      LET l_sel = "SELECT ",
                  "       ROW_NUMBER() over(order by Bdate,ChangeCardno), ",   #lrw01       #單據編號
                  "       lpj01, ",                                            #lrw02       #會員編號
                  "       OldCardno, ",                                        #lrw03       #原卡卡號
                  "       lpj02, ",                                            #lrw04       #卡種編號
                 #"       lpj09, ",                                            #lrw05       #原卡狀態  #FUN-D10040 Mark
                  "       '2', ",                                              #lrw05       #原卡狀態  #FUN-D10040 Add
                  "       COALESCE(lpj06,0), ",                                #lrw06       #原卡內餘額
                  "       COALESCE(lpj12,0), ",                                #lrw07       #原卡內積分
                  "       lpj05, ",                                            #lrw08       #原卡有效期
                  "       NewCardno, ",                                        #lrw09       #新卡卡號
                  "       NULL, ",                                             #lrw10       #新卡卡種
                  "       COALESCE(lpj06,0), ",                                #lrw11       #新卡卡內金額
                  "       COALESCE(lpj12,0), ",                                #lrw12       #新卡卡內積分
                  "       lpj05, ",                                            #lrw13       #新卡有效期
                  "       NULL, ",                                             #lrw14       #換卡原因編號
                  "       CAST(Bdate AS DATE), ",                              #lrw15       #單據日期 
                  "       'Y', ",                                              #lrw16       #確認碼
                  "       ryi02, ",                                            #lrw17       #確認人
                 #"       CAST(Bdate AS DATE), ",                              #lrw18       #確認日期 #FUN-D10144 Mark
                  "       CAST(Sdate AS DATE), ",                              #lrw18       #確認日期 #FUN-D10144 Add
                  "       NULL, ",                                             #lrw19       #備註
                  "       lpj11, ",                                            #lrw20       #原卡儲值折扣率
                 #"       NULL, ",                                             #lrw21       #原會員等級 #FUN-D10040 Mark
                  "       lpk10, ",                                            #lrw21       #原會員等級 #FUN-D10040 Add
                 #"       NULL, ",                                             #lrw22       #現會員等級 #FUN-D10040 Mark
                  "       lpk10, ",                                            #lrw22       #現會員等級 #FUN-D10040 Add
                  "       CostAmt, ",                                          #lrw23       #換卡手續費
                  "       ROW_NUMBER() over(order by Bdate,ChangeCardno), ",   #lrw24       #對應出貨單號
                  "       ChangeCardno, ",                                     #lrw24       #POS單號
                  "       'Y', ",                                              #lrwacti     #資料有效碼
                 #"       CAST(Bdate AS DATE), ",                              #lrwcrat     #資料創建日 #FUN-D10144 Mark
                  "       CAST(Sdate AS DATE), ",                              #lrwcrat     #資料創建日 #FUN-D10144 Add
                 #"       CAST(Bdate AS DATE), ",                              #lrwdate     #最近修改日 #FUN-D10144 Mark
                  "       CAST(Sdate AS DATE), ",                              #lrwdate     #最近修改日 #FUN-D10144 Add
                  "       gen03, ",                                            #lrwgrup     #資料所有群
                  "       '",p_azw02,"', ",                                    #lrwlegal    #所屬法人
                  "       ryi02, ",                                            #lrwmodu     #資料修改者
                  "       gen03, ",                                            #lrworig     #資料建立部門
                  "       ryi02, ",                                            #lrworiu     #資料建立者
                  "       Shop, ",                                             #lrwplant    #所屬營運中心
                  "       ryi02 ",                                             #lrwuser     #資料所有者
                  "  FROM ( ",
                  "SELECT * ",
                  "  FROM ",g_posdbs,"tg_ChangeCard",g_db_links," ",
                  " WHERE Shop = '",p_azw01,"' AND Condition2 = 'B' AND Cnfflg = 'Y' ",
                  " ORDER BY Bdate,ChangeCardno) LEFT OUTER JOIN ",cl_get_target_table(p_azw01,'ryi_file'),
                  "                                           ON ryi01 = Opno ",
                  "                              LEFT OUTER JOIN ",cl_get_target_table(p_azw01,'gen_file'),
                  "                                           ON gen01 = ryi02 ",
                  "                              LEFT OUTER JOIN ",cl_get_target_table(p_azw01,'lpj_file'),
                  "                                           ON lpj03 = OldCardno ",
                  "                              LEFT OUTER JOIN ",cl_get_target_table(p_azw01,'lpk_file'), #FUN-D10040 Add
                  "                                           ON lpk01 = lpj01 ",                           #FUN-D10040 Add
                  " WHERE ROWNUM <= ",g_sum_limit," ",
                  " ORDER BY Bdate,ChangeCardno "
      LET l_sql = l_ins CLIPPED," ",l_sel CLIPPED
      PREPARE changecard_ins_lrw_temp_pre FROM l_sql
      EXECUTE changecard_ins_lrw_temp_pre
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Ins'||' '||'Table:lrw_temp'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','05','tg_ChangeCard',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CONTINUE WHILE
      END IF 
      
      INITIALIZE l_lrw15_old,l_lrw01_min_o,l_lrw01_max_o,l_azn05_old TO NULL                                    
      INITIALIZE l_lrw15,l_lrw15_num,l_lrw01_min,l_lrw01_max,l_azn05 TO NULL
      LET l_sql = "SELECT DISTINCT MIN(to_number(lrw01)),lrw15,MAX(to_number(lrw01)) FROM lrw_temp GROUP BY lrw15 order by lrw15"
      PREPARE changecard_sel_lrw15_pre FROM l_sql
      DECLARE changecard_sel_lrw15_cs CURSOR FOR changecard_sel_lrw15_pre
      FOREACH changecard_sel_lrw15_cs INTO l_lrw01_min,l_lrw15,l_lrw01_max
      
         #自动编号
         LET g_ndate = l_lrw15
        #CALL p200_auto_doc(p_gat01,p_azw01) RETURNING l_lrw01     #FUN-CC0082 Mark
         CALL p200_auto_doc(p_gat01,p_azw01,'Y') RETURNING l_lrw01 #FUN-CC0082 Add
         IF g_success = 'N' THEN EXIT WHILE END IF                 #FUN-CC0082 Add
        #CALL p200_auto_doc("oga_file",p_azw01) RETURNING l_oga01     #FUN-CC0082 Mark
         CALL p200_auto_doc("oga_file",p_azw01,'Y') RETURNING l_oga01 #FUN-CC0082 Add
         IF g_success = 'N' THEN
            EXIT WHILE 
         END IF
         
         CASE g_ryz05
            WHEN "1"
               LET l_num_len = 8
            WHEN "2"
               LET l_num_len = 9
            WHEN "3"
               LET l_num_len = 10
         END CASE
         
         CASE g_ryz06
            WHEN "1" #按流水号
               LET l_num_len = l_num_len
               IF NOT cl_null(l_lrw15_old) THEN
                  #已排流水号个数 = 最大流水号旧值- 最小流水号旧值+ 1 + 上一笔已排流水号个数
                  LET l_lrw15_num = l_lrw01_max_o - l_lrw01_min_o + 1 + l_lrw15_num
               ELSE
                  LET l_lrw15_num = 0
               END IF
            WHEN "2" #按年月
               LET l_num_len = l_num_len - 4
               IF NOT cl_null(l_lrw15_old) THEN 
                  IF YEAR(l_lrw15_old) = YEAR(l_lrw15) AND MONTH(l_lrw15_old) = MONTH(l_lrw15) THEN
                     LET l_lrw15_num = l_lrw01_max_o - l_lrw01_min_o + 1 + l_lrw15_num
                  ELSE
                     LET l_lrw15_num = 0
                  END IF
               ELSE
                  LET l_lrw15_num = 0
               END IF
            WHEN "3" #按年周
               LET l_num_len = l_num_len - 4
               IF NOT cl_null(l_lrw15_old) THEN
                  INITIALIZE l_azn05 TO NULL
                  SELECT azn05 INTO l_azn05 FROM azn_file WHERE azn01 = l_lrw15
                  IF YEAR(l_lrw15_old) = YEAR(l_lrw15) AND l_azn05_old = l_azn05 THEN
                     LET l_lrw15_num = l_lrw01_max_o - l_lrw01_min_o + 1 + l_lrw15_num
                  ELSE
                     LET l_lrw15_num = 0
                  END IF
               ELSE
                  LET l_lrw15_num = 0
               END IF
            WHEN "4" #按年月日
               LET l_num_len = l_num_len - 6
              #FUN-D30061 Mark&Add Begin ---
              #IF NOT cl_null(l_lrw15_old) THEN
              #   LET l_lrw15_num = l_lrw01_max_o - l_lrw01_min_o + 1 + l_lrw15_num
              #ELSE
              #   LET l_lrw15_num = 0
              #END IF
               LET l_lrw15_num = 0
              #FUN-D30061 Mark&Add End -----
         END CASE
            
         LET l_lrw01_min_o = l_lrw01_min
         LET l_lrw01_max_o = l_lrw01_max
         LET l_azn05_old   = l_azn05
         LET l_lrw15_old   = l_lrw15
               
         INITIALIZE l_num_str TO NULL
         FOR l_cnt = 1 TO l_num_len
            LET l_num_str = l_num_str CLIPPED,'0'
         END FOR
         LET l_lrw01_str = l_lrw01
         LET l_lrw01_num = l_lrw01_str.subString(l_lrw01_str.getLength() - l_num_len + 1,l_lrw01_str.getLength())
         LET l_lrw01_chr = l_lrw01_str.subString(1,l_lrw01_str.getLength() - l_num_len)
         #   最大流水号  = 实际流水号  - 最小ROWNUM  + 已排流水号个数
         LET l_lrw01_num = l_lrw01_num - l_lrw01_min + l_lrw15_num
         LET l_oga01_str = l_oga01
         LET l_oga01_num = l_oga01_str.subString(l_oga01_str.getLength() - l_num_len + 1,l_oga01_str.getLength())
         LET l_oga01_chr = l_oga01_str.subString(1,l_oga01_str.getLength() - l_num_len)
         #   最大流水号  = 实际流水号  - 最小ROWNUM  + 已排流水号个数
         LET l_oga01_num = l_oga01_num - l_lrw01_min + l_lrw15_num
         
         #批次更新oea_temp中的单号
         LET l_upd = "UPDATE lrw_temp SET lrw01 = '",l_lrw01_chr CLIPPED,"'||","substr(to_char","((lrw01 + '",l_lrw01_num,"'),'",l_num_str,"'),2), ",
                     "                    lrw24 = '",l_oga01_chr CLIPPED,"'||","substr(to_char","((lrw24 + '",l_oga01_num,"'),'",l_num_str,"'),2) ",
                     " WHERE lrw15 = '",l_lrw15,"' "
         PREPARE changecard_upd_lrw01_pre FROM l_upd
         EXECUTE changecard_upd_lrw01_pre
         IF SQLCA.sqlcode THEN
            LET g_success = 'N'
            LET g_errno   = SQLCA.sqlcode
            LET g_msg1    = 'Oper:Upd'||' '||'Table:lrw_temp'||' '||'Field:lrw01/lrw24'||' '||'Shop:'||p_azw01
            CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
            ROLLBACK WORK
            CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
            LET g_msg   = g_msg[1,255]
            CALL p200_log(g_trans_no,p_azw01,'Batch Operation','05','tg_ChangeCard',g_errno,g_msg,'0','N',g_msg1)
            LET g_errno = ''
            LET g_msg   = ''
            LET g_msg1  = ''
            CALL p200_upd_posflag_p('2',p_gat01,'tg_ChangeCard',p_azw01) #将对应中间库的资料Condition2更新为A
            CONTINUE WHILE
         END IF
      END FOREACH
      
      #检查单据日期
      INITIALIZE l_lrw15 TO NULL
      SELECT MIN(lrw15) INTO l_lrw15 FROM lrw_temp WHERE lrw15 <= g_sma.sma53
      IF NOT cl_null(l_lrw15) THEN
         LET g_errno   = 'apc1054' #该批次资料中存在最小单据日期小于等于关帐日期
         LET g_msg1    = 'Oper:Chk'||' '||'Table:lrw_temp'||' '||'MIN(lrw15):'||l_lrw15||' '||'Shop:'||p_azw01
        #CALL s_errmsg('Batch Operation','',g_msg1,SQLCA.sqlcode,1) #FUN-CB0103 Mark
         CALL s_errmsg('Batch Operation','',g_msg1,g_errno,1)       #FUN-CB0103 Add
         ROLLBACK WORK 
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','05','TG_CHANGECARD',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
      END IF 
      
      #更新中间库状态为A
      LET l_upd = "UPDATE ",g_posdbs,"tg_ChangeCard",g_db_links," ",
                  "   SET Condition2 = 'A' ", 
                  " WHERE Shop = '",p_azw01,"' ",
                  "   AND EXISTS (SELECT 1 ", 
                  "                 FROM lrw_temp ",   
                  "                WHERE lrw15 <= '",g_sma.sma53,"' ",
                  "                  AND lrw25 = ChangeCardno) "
      PREPARE changecard_upd_tg_changecard_flag_lrw_pre FROM l_upd
      EXECUTE changecard_upd_tg_changecard_flag_lrw_pre 
      
      #删除出货日期小于等于关帐日期的资料
      DELETE FROM lrw_temp WHERE lrw15 <= g_sma.sma53
      
      #ins xyz
      CALL p200_cardcoupon_xyz_ins_p("lrw_file",p_azw01)
      IF g_success='N' THEN
      END IF
      
      #产生出货单以及付款资料
      CALL p200_prod_oga_p('3',p_azw01)
      IF g_success = 'N' THEN
         CALL p200_upd_posflag_p('2',p_gat01,'tg_ChangeCard',p_azw01) #将对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF
      
      #将临时表lrw_temp插入到数据库中
      LET l_ins = " INSERT INTO ",cl_get_target_table(p_azw01,'lrw_file'),
                  " SELECT * FROM lrw_temp "
      CALL cl_replace_sqldb(l_ins) RETURNING l_ins
      CALL cl_parse_qry_sql(l_ins,p_azw01) RETURNING l_ins
      PREPARE changecard_ins_lrw_pre FROM l_ins
      EXECUTE changecard_ins_lrw_pre
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Ins'||' '||'Table:lrw_file'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','05','TG_CHANGECARD',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'tg_ChangeCard',p_azw01) #将对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF

      #将临时表oga_temp插入到数据库中
      LET l_ins = " INSERT INTO ",cl_get_target_table(p_azw01,'oga_file'),
                  " SELECT * FROM oga_temp "
      CALL cl_replace_sqldb(l_ins) RETURNING l_ins
      CALL cl_parse_qry_sql(l_ins,p_azw01) RETURNING l_ins
      PREPARE changecard_ins_oga_lrw_pre FROM l_ins
      EXECUTE changecard_ins_oga_lrw_pre
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Ins'||' '||'Table:oga_file'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','05','TG_CHANGECARD',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'tg_ChangeCard',p_azw01) #将对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF
      
      #将临时表ogb_temp插入到数据库中
      LET l_ins = " INSERT INTO ",cl_get_target_table(p_azw01,'ogb_file'),
                  " SELECT * FROM ogb_temp "
      CALL cl_replace_sqldb(l_ins) RETURNING l_ins
      CALL cl_parse_qry_sql(l_ins,p_azw01) RETURNING l_ins
      PREPARE changecard_ins_ogb_lrw_pre FROM l_ins
      EXECUTE changecard_ins_ogb_lrw_pre
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Ins'||' '||'Table:ogb_file'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','05','TG_CHANGECARD',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'tg_ChangeCard',p_azw01) #将对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF
     
      #FUN-D20096---Add---Str
      #将临时表ogh_temp插入到数据库中
      LET l_ins = " INSERT INTO ",cl_get_target_table(p_azw01,'ogh_file'),
                  " SELECT * FROM ogh_temp "
      CALL cl_replace_sqldb(l_ins) RETURNING l_ins
      CALL cl_parse_qry_sql(l_ins,p_azw01) RETURNING l_ins
      PREPARE changecard_ins_ogh_lrw_pre FROM l_ins
      EXECUTE changecard_ins_ogh_lrw_pre
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Ins'||' '||'Table:ogh_file'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','05','tg_SaleCard_Tax',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'tg_SaleCard_Tax',p_azw01) #将对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF

      #将临时表ogi_temp插入到数据库中
      LET l_ins = " INSERT INTO ",cl_get_target_table(p_azw01,'ogi_file'),
                  " SELECT * FROM ogi_temp "
      CALL cl_replace_sqldb(l_ins) RETURNING l_ins
      CALL cl_parse_qry_sql(l_ins,p_azw01) RETURNING l_ins
      PREPARE changecard_ins_ogi_lrw_pre FROM l_ins
      EXECUTE changecard_ins_ogi_lrw_pre
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Ins'||' '||'Table:ogi_file'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','05','tg_SaleCard_Detail_Tax',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'tg_SaleCard_Detail_Tax',p_azw01) #将对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF
      #FUN-D20096---Add---End
 
      #将临时表rxx_temp插入到数据库中
      LET l_ins = " INSERT INTO ",cl_get_target_table(p_azw01,'rxx_file'),
                  " SELECT * FROM rxx_temp "
      CALL cl_replace_sqldb(l_ins) RETURNING l_ins
      CALL cl_parse_qry_sql(l_ins,p_azw01) RETURNING l_ins
      PREPARE changecard_ins_rxx_lrw_pre FROM l_ins
      EXECUTE changecard_ins_rxx_lrw_pre
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Ins'||' '||'Table:rxx_file'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','05','TG_CHANGECARD',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'tg_ChangeCard',p_azw01) #将对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF
      
      #将临时表rxy_temp插入到数据库中
      LET l_ins = " INSERT INTO ",cl_get_target_table(p_azw01,'rxy_file'),
                  " SELECT * FROM rxy_temp "
      CALL cl_replace_sqldb(l_ins) RETURNING l_ins
      CALL cl_parse_qry_sql(l_ins,p_azw01) RETURNING l_ins
      PREPARE changecard_ins_rxy_lrw_pre FROM l_ins
      EXECUTE changecard_ins_rxy_lrw_pre
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Ins'||' '||'Table:rxy_file'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','05','TG_CHANGECARD',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'tg_ChangeCard',p_azw01) #将对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF
      
      #将临时表rxz_temp插入到数据库中
      LET l_ins = " INSERT INTO ",cl_get_target_table(p_azw01,'rxz_file'),
                  " SELECT * FROM rxz_temp "
      CALL cl_replace_sqldb(l_ins) RETURNING l_ins
      CALL cl_parse_qry_sql(l_ins,p_azw01) RETURNING l_ins
      PREPARE changecard_ins_rxz_lrw_pre FROM l_ins
      EXECUTE changecard_ins_rxz_lrw_pre
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Ins'||' '||'Table:rxz_file'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','05','TG_CHANGECARD',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'tg_ChangeCard',p_azw01) #将对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF

      #更新中间库标志位
      CALL p200_upd_posflag_p("1","lrw_file","tg_ChangeCard",p_azw01)
      IF g_success = 'N' THEN
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Upd'||' '||'Table:tg_ChangeCard'||' '||'Field:Condition2'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK 
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','05','TG_CHANGECARD',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'tg_ChangeCard',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF
      
      IF g_success = 'Y' THEN
         LET g_sucflag = 1
         COMMIT WORK
      ELSE
         ROLLBACK WORK
      END IF
      
   END WHILE
   #删除建立的临时表
   DROP TABLE lrw_temp
   DROP TABLE oga_temp
   DROP TABLE ogb_temp
   DROP TABLE ogh_temp   #FUN-D20096 Add
   DROP TABLE ogi_temp   #FUN-D20096 Add
   DROP TABLE rxx_temp
   DROP TABLE rxy_temp
   DROP TABLE rxz_temp
END FUNCTION
#FUN-CA0160 Add End -----

#FUN-CA0160 Add Begin ---
FUNCTION p200_rxe_ins_p_oga(p_gat01,p_azw01)
DEFINE p_gat01       LIKE gat_file.gat01
DEFINE p_azw01       LIKE azw_file.azw01
DEFINE p_azw02       LIKE azw_file.azw02
DEFINE l_ins         STRING
DEFINE l_upd         STRING
DEFINE l_sql         STRING
DEFINE l_sel         STRING
DEFINE l_oga01       LIKE oga_file.oga01
DEFINE l_oga02       LIKE oga_file.oga02
DEFINE l_ogaplant    LIKE oga_file.ogaplant
DEFINE l_num_len     LIKE type_file.num10
DEFINE l_num_str     LIKE type_file.chr20
DEFINE l_oga01_str   STRING
DEFINE l_oga01_num   LIKE type_file.chr20
DEFINE l_oga01_chr   LIKE type_file.chr20
DEFINE l_oga02_old   LIKE oga_file.oga02
DEFINE l_oga01_min   LIKE oga_file.oga01
DEFINE l_oga01_max   LIKE oga_file.oga01
DEFINE l_oga01_min_o LIKE oga_file.oga01
DEFINE l_oga01_max_o LIKE oga_file.oga01
DEFINE l_oga02_num   LIKE type_file.num10
DEFINE l_azn05       LIKE azn_file.azn05
DEFINE l_azn05_old   LIKE azn_file.azn05
DEFINE l_upd_num     LIKE type_file.num10
DEFINE l_cnt         LIKE type_file.num5
DEFINE l_oga23       LIKE oga_file.oga23
DEFINE l_oga24       LIKE oga_file.oga24
DEFINE l_ogb09       LIKE ogb_file.ogb09

   #组出过滤条件
   IF NOT cl_null(g_saleno) THEN
      LET g_wc = " SaleCouponno = '",g_saleno,"' "
   ELSE
      CALL p200_g_wc("rxe_file_2") RETURNING g_wc
   END IF
   IF cl_null(g_wc) THEN LET g_wc = " 1=1" END IF

   SELECT azw02 INTO p_azw02 FROM azw_file WHERE azw01 = p_azw01

   #将中间库中符合条件的资料Condition2更新为B
   LET l_upd = "UPDATE ",g_posdbs,"tg_SaleCoupon",g_db_links," ",
               "   SET Condition2 = 'B' ",
               " WHERE Condition2 <> 'Y' AND Type = '0' AND Cnfflg = 'Y' AND Shop = '",p_azw01 CLIPPED,"' AND ",g_wc CLIPPED
   PREPARE salecoupon_upd_tg_salecoupon_oga_pre FROM l_upd
   EXECUTE salecoupon_upd_tg_salecoupon_oga_pre
   IF SQLCA.sqlcode THEN
      LET g_success = 'N'
      LET g_errno   = SQLCA.sqlcode
      LET g_msg1    = 'Oper:Upd'||' '||'Table:tg_SaleCoupon'||' '||'Shop:'||p_azw01
      CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
      ROLLBACK WORK
      CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
      LET g_msg   = g_msg[1,255]
      CALL p200_log(g_trans_no,p_azw01,'Batch Operation','06','TG_SALECOUPON',g_errno,g_msg,'0','N',g_msg1)
      LET g_errno = ''
      LET g_msg   = ''
      LET g_msg1  = ''
      RETURN
   END IF
   
   LET l_upd_num = SQLCA.sqlerrd[3] 
   IF l_upd_num <= 0 THEN RETURN END IF
   IF cl_null(g_sum_limit) OR g_sum_limit = 0 THEN LET g_sum_limit = l_upd_num END IF

   #先删除需要建立的临时表
   DROP TABLE oga_temp
   DROP TABLE ogb_temp
   DROP TABLE ogh_temp     #FUN-D20096 Add
   DROP TABLE ogi_temp     #FUN-D20096 Add
   DROP TABLE rxe_temp
   DROP TABLE rxx_temp
   DROP TABLE rxy_temp
   DROP TABLE rxz_temp

   #建立临时表
   SELECT * FROM oga_file WHERE 1=0 INTO TEMP oga_temp
   SELECT * FROM ogb_file WHERE 1=0 INTO TEMP ogb_temp
   SELECT * FROM ogh_file WHERE 1=0 INTO TEMP ogh_temp    #FUN-D20096 Add
   SELECT * FROM ogi_file WHERE 1=0 INTO TEMP ogi_temp    #FUN-D20096 Add
   SELECT * FROM rxe_file WHERE 1=0 INTO TEMP rxe_temp
   SELECT * FROM rxx_file WHERE 1=0 INTO TEMP rxx_temp
   SELECT * FROM rxy_file WHERE 1=0 INTO TEMP rxy_temp
   SELECT * FROM rxz_file WHERE 1=0 INTO TEMP rxz_temp

   #建立索引

   WHILE l_upd_num > 0
      LET l_upd_num = l_upd_num - g_sum_limit
   
     #清空临时表
      DELETE FROM oga_temp
      DELETE FROM ogb_temp
      DELETE FROM ogh_temp    #FUN-D20096 Add
      DELETE FROM ogi_temp    #FUN-D20096 Add
      DELETE FROM rxe_temp
      DELETE FROM rxx_temp
      DELETE FROM rxy_temp
      DELETE FROM rxz_temp
   
      LET g_success = 'Y'
      BEGIN WORK

      LET l_ins = "INSERT INTO oga_temp( ",
                  "                     oga00, ",        #出貨別
                  "                     oga01, ",        #出貨單號
                  "                     oga02, ",        #出貨日期
                  "                     oga03, ",        #账款客户编号
                  "                     oga032, ",       #账款客户简称
                  "                     oga04, ",        #送货客户编号
                  "                     oga06, ",        #修改版本
                  "                     oga07, ",        #出貨是否計入未開發票的銷貨待驗收入
                  "                     oga08, ",        #1.內銷 2.外銷  3.視同外銷
                  "                     oga09, ",        #單據別
                  "                     oga14, ",        #業務人員
                  "                     oga15, ",        #業務部門
                  "                     oga161, ",       #訂金應收比率
                  "                     oga162, ",       #出貨應收比率
                  "                     oga163, ",       #尾款應收比率
                  "                     oga18, ",        #收款客户编号
                  "                     oga21, ",        #税种
                  "                     oga211, ",       #税率
                  "                     oga212, ",       #联数
                  "                     oga213, ",       #含税否
                  "                     oga23, ",        #币种
                  "                     oga24, ",        #汇率
                  "                     oga25, ",        #销售分类一
                  "                     oga30, ",        #包裝單確認碼
                  "                     oga31, ",        #价格条件编号
                  "                     oga32, ",        #收款条件编号
                  "                     oga50, ",        #原币出货金额
                  "                     oga51, ",        #原币出货金额
                  "                     oga52, ",        #原幣預收訂金轉銷貨收入金額
                  "                     oga53, ",        #原幣應開發票未稅金額
                  "                     oga54, ",        #原幣已開發票未稅金額
                  "                     oga55, ",        #狀況碼
                  "                     oga57, ",        #發票性質
                  "                     oga65, ",        #客戶出貨簽收否
                  "                     oga69, ",        #輸入日期
                  "                     oga83, ",        #銷貨營運中心
                  "                     oga84, ",        #取貨營運中心
                  "                     oga85, ",        #結算方式
                  "                     oga903, ",       #信用查核放行否
                  "                     oga94, ",        #POS銷售否 Y-是,N-否
                  "                     oga95, ",        #本次積分
                  "                     oga96, ",        #收银机号
                  "                     oga98, ",        #POS單號
                  "                     oga1014, ",      #调货销退单所自动产生否
                  "                     ogaconu, ",      #審核人
                  "                     ogacond, ",      #審核日期
                  "                     ogaconf, ",      #確認否/作廢碼
                  "                     ogacont, ",      #审核时间      #FUN-CB0103 Add
                  "                     ogagrup, ",      #資料所有部門
                  "                     ogalegal, ",     #所屬法人
                  "                     ogaorig, ",      #資料建立部門
                  "                     ogaoriu, ",      #資料建立者
                  "                     ogaplant, ",     #所屬營運中心
                  "                     ogapost, ",      #出貨扣帳否 
                  "                     ogaprsw, ",      #列印次數
                  "                     ogauser, ",      #資料所有者
                  "                     ogamksg, ",      #签核
                  "                     ogaslk02) "      #出货类型（现货，期货）
      LET l_sel = "SELECT ",
                  "       '1', ",                                               #oga00       #出貨別
                  "       ROW_NUMBER() over(order by Bdate,SaleCouponno), ",    #oga01       #出货单号
                  "       CAST(Bdate AS DATE), ",                               #oga02       #出貨日期
                  "       rtz06, ",                                             #oga03       #账款客户编号
                  "       occ02, ",                                             #oga032      #账款客户简称
                 #"       rtz06, ",                                             #oga04       #送货客户编号 #FUN-D10040 Mark
                  "       occ09, ",                                             #oga04       #送货客户编号 #FUN-D10040 Add
                  "       '0', ",                                               #oga06       #修改版本
                  "       'N', ",                                               #oga07       #出貨是否計入未開發票的銷貨待驗收入
                  "       '1', ",                                               #oga08       #1.內銷 2.外銷  3.視同外銷
                  "       '2', ",                                               #oga09       #單據別
                  "       ryi02, ",                                             #oga14       #業務人員
                  "       gen03, ",                                             #oga15       #業務部門
                  "       0, ",                                                 #oga161      #訂金應收比率
                  "       100, ",                                               #oga162      #出貨應收比率
                  "       0, ",                                                 #oga163      #尾款應收比率
                  "       rtz06, ",                                             #oga18       #收款客户编号
                  "       occ41, ",                                             #oga21       #税种        
                  "       gec04, ",                                             #oga211      #税率        
                  "       gec05, ",                                             #oga212      #联数        
                  "       gec07, ",                                             #oga213      #含税否      
                  "       occ42, ",                                             #oga23       #币种        
                  "       NULL, ",                                              #oga24       #汇率        
                  "       occ43, ",                                             #oga25       #销售分类一  
                  "       'N', ",                                               #oga30       #包裝單確認碼包裝單確認碼
                  "       occ44, ",                                             #oga31       #价格条件编号
                  "       occ45, ",                                             #oga32       #收款条件编号
                  "       Tot_amt, ",                                           #oga50       #原币出货金额
                  "       Tot_amt, ",                                           #oga51       #原币出货金额
                  "       0, ",                                                 #oga52       #原幣預收訂金轉銷貨收入金額
                  "       0, ",                                                 #oga53       #原幣應開發票未稅金額
                  "       0, ",                                                 #oga54       #原幣已開發票未稅金額
                  "       '1', ",                                               #oga55       #狀況碼
                  "       '1', ",                                               #oga57       #發票性質
                  "       'N', ",                                               #oga65       #客戶出貨簽收否
                 #"       CAST(Bdate AS DATE), ",                               #oga69       #輸入日期 #FUN-D10144 Mark
                  "       CAST(Sdate AS DATE), ",                               #oga69       #輸入日期 #FUN-D10144 Add
                  "       Shop, ",                                              #oga83       #銷貨營運中心
                  "       Shop, ",                                              #oga84       #取貨營運中心
                  "       '1', ",                                               #oga85       #結算方式
                  "       'N', ",                                               #oga903      #信用查核放行否
                  "       'Y', ",                                               #oga94       #POS銷售否 Y-是,N-否
                  "       '0', ",                                               #oga95       #本次積分
                  "       Machine, ",                                           #oha96           #收银机号
                  "       SaleCouponno, ",                                      #oga98       #POS單號
                  "       'N', ",                                               #oga1014     #调货销退单所自动产生否
                  "       ryi02, ",                                             #ogaconu     #審核人
                 #"       CAST(Bdate AS DATE), ",                               #ogacond     #審核日期 #FUN-D10144 Mark
                  "       CAST(Sdate AS DATE), ",                               #ogacond     #審核日期 #FUN-D10144 Add
                  "       'Y', ",                                               #ogaconf     #確認否/作廢碼
                  "       Stime[1,2]||':'||Stime[3,4]||':'||Stime[5,6], ",      #ogacont     #审核时间  #FUN-CB0103 Add
                  "       gen03, ",                                             #ogagrup     #資料所有部門
                  "       '",p_azw02,"', ",                                     #ogalegal    #所屬法人
                  "       gen03, ",                                             #ogaorig     #資料建立部門
                  "       ryi02, ",                                             #ogaoriu     #資料建立者
                  "       Shop, ",                                              #ogaplant    #所屬營運中心
                  "       'Y', ",                                               #ogapost     #出貨扣帳否 
                  "       0, ",                                                 #ogaprsw     #列印次數
                  "       ryi02, ",                                             #ogauser     #資料所有者
                  "       'N', ",                                               #ogamksg     #签核
                  "       '1' ",                                                #ogaslk02    #出货类型（现货，期货）
                  "  FROM ( ",
                  "SELECT * ",
                  "  FROM ",g_posdbs,"tg_SaleCoupon",g_db_links," ",
                  " WHERE Shop = '",p_azw01,"' AND Condition2 = 'B' AND Type = '0' AND Cnfflg = 'Y' ",
                  " ORDER BY Bdate,SaleCouponno) LEFT OUTER JOIN ",cl_get_target_table(p_azw01,'ryi_file'),
                  "                                           ON ryi01 = Opno ",
                  "                              LEFT OUTER JOIN ",cl_get_target_table(p_azw01,'gen_file'),
                  "                                           ON gen01 = ryi02 ",
                  "                              LEFT OUTER JOIN ",cl_get_target_table(p_azw01,'rtz_file'),
                  "                                           ON rtz01 = Shop ",
                  "                              LEFT OUTER JOIN ",cl_get_target_table(p_azw01,'occ_file'),       
                  "                                           ON occ01 = rtz06 ",
                  "                              LEFT OUTER JOIN ",cl_get_target_table(p_azw01,'gec_file'),       
                  "                                           ON gec01 = occ41 AND gec011 = '2' ",  
                  " WHERE ROWNUM <= ",g_sum_limit," ",
                  " ORDER BY Bdate,SaleCouponno "
      LET l_sql = l_ins CLIPPED," ",l_sel CLIPPED
      PREPARE salecoupon_ins_oga_temp_pre FROM l_sql
      EXECUTE salecoupon_ins_oga_temp_pre
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Ins'||' '||'Table:oga_temp(SaleCoupon)'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','06','tg_SaleCoupon',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CONTINUE WHILE
      END IF

      #检查出货单单据日期
      INITIALIZE l_oga02 TO NULL
      SELECT MIN(oga02) INTO l_oga02 FROM oga_temp WHERE oga02 <= g_sma.sma53
      IF NOT cl_null(l_oga02) THEN
         LET g_errno   = 'apc1054' #该批次资料中存在最小单据日期小于等于关帐日期
         LET g_msg1    = 'Oper:Chk'||' '||'Table:oga_temp'||' '||'MIN(oga02):'||l_oga02||' '||'Shop:'||p_azw01
        #CALL s_errmsg('Batch Operation','',g_msg1,SQLCA.sqlcode,1) #FUN-CB0103 Mark
         CALL s_errmsg('Batch Operation','',g_msg1,g_errno,1)       #FUN-CB0103 Add
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','06','TG_SALECOUPON',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
      END IF

      #更新中间库状态为A
      LET l_upd = "UPDATE ",g_posdbs,"tg_SaleCoupon",g_db_links," ",
                  "   SET Condition2 = 'A' ",
                  " WHERE Shop = '",p_azw01,"' ",
                  "   AND EXISTS (SELECT 1 ",
                  "                 FROM oga_temp ",
                  "                WHERE oga02 <= '",g_sma.sma53,"' ",
                  "                  AND oga98 = SaleCouponno) "
      PREPARE salecoupon_upd_tg_salecoupon_flag_oga_pre2 FROM l_upd
      EXECUTE salecoupon_upd_tg_salecoupon_flag_oga_pre2

      #删除出货日期小于等于关帐日期的资料
      DELETE FROM oga_temp WHERE oga02 <= g_sma.sma53
      
      INITIALIZE l_oga02_old,l_oga01_min_o,l_oga01_max_o,l_azn05_old TO NULL
      INITIALIZE l_oga02,l_oga02_num,l_oga01_min,l_oga01_max,l_azn05 TO NULL
      LET l_sql = "SELECT DISTINCT MIN(to_number(oga01)),oga02,MAX(to_number(oga01)) FROM oga_temp GROUP BY oga02 ORDER by oga02"
      PREPARE salecoupon_sel_oga02_pre FROM l_sql
      DECLARE salecoupon_sel_oga02_cs CURSOR FOR salecoupon_sel_oga02_pre
      FOREACH salecoupon_sel_oga02_cs INTO l_oga01_min,l_oga02,l_oga01_max

         #自动编号
         LET g_ndate = l_oga02
        #CALL p200_auto_doc(p_gat01,p_azw01) RETURNING l_oga01     #FUN-CC0082 Mark
         CALL p200_auto_doc(p_gat01,p_azw01,'Y') RETURNING l_oga01 #FUN-CC0082 Add
         IF g_success = 'N' THEN
            EXIT WHILE
         END IF
         CASE g_ryz05
            WHEN "1"
               LET l_num_len = 8
            WHEN "2"
               LET l_num_len = 9
            WHEN "3"
               LET l_num_len = 10
         END CASE

         CASE g_ryz06
            WHEN "1"
               LET l_num_len = l_num_len
               IF NOT cl_null(l_oga02_old) THEN
                  #已排流水号个数   最大流水号旧值  最小流水号旧值      上一笔已排流水号个数
                  LET l_oga02_num = l_oga01_max_o - l_oga01_min_o + 1 + l_oga02_num
               ELSE
                  LET l_oga02_num = 0
               END IF
            WHEN "2"
               LET l_num_len = l_num_len - 4
               IF NOT cl_null(l_oga02_old) THEN
                  IF YEAR(l_oga02_old) = YEAR(l_oga02) AND MONTH(l_oga02_old) = MONTH(l_oga02) THEN
                     LET l_oga02_num = l_oga01_max_o - l_oga01_min_o + 1 + l_oga02_num
                  ELSE
                     LET l_oga02_num = 0
                  END IF
               ELSE
                  LET l_oga02_num = 0
               END IF
            WHEN "3"
               LET l_num_len = l_num_len - 4
               IF NOT cl_null(l_oga02_old) THEN
                  INITIALIZE l_azn05 TO NULL
                  SELECT azn05 INTO l_azn05 FROM azn_file WHERE azn01 = l_oga02 #抓取周
                  IF YEAR(l_oga02_old) = YEAR(l_oga02) AND l_azn05_old = l_azn05 THEN
                     LET l_oga02_num = l_oga01_max_o - l_oga01_min_o + 1 + l_oga02_num
                  ELSE 
                     LET l_oga02_num = 0
                  END IF
               ELSE
                  LET l_oga02_num = 0
               END IF 
            WHEN "4"
               LET l_num_len = l_num_len - 6
              #FUN-D30061 Mark&Add Begin ---
              #IF NOT cl_null(l_oga02_old) THEN
              #   LET l_oga02_num = l_oga01_max_o - l_oga01_min_o + 1 + l_oga02_num
              #ELSE
              #   LET l_oga02_num = 0
              #END IF
               LET l_oga02_num = 0
              #FUN-D30061 Mark&Add End -----
         END CASE
         LET l_oga01_min_o = l_oga01_min
         LET l_oga01_max_o = l_oga01_max
         LET l_azn05_old   = l_azn05
         LET l_oga02_old   = l_oga02
            
         INITIALIZE l_num_str TO NULL  #格式字串
         FOR l_cnt = 1 TO l_num_len
            LET l_num_str = l_num_str CLIPPED,'0'   
         END FOR  
         LET l_oga01_str = l_oga01
         LET l_oga01_num = l_oga01_str.subString(l_oga01_str.getLength() - l_num_len + 1,l_oga01_str.getLength())
         LET l_oga01_chr = l_oga01_str.subString(1,l_oga01_str.getLength() - l_num_len)

         #   最大流水号    实际流水号    最小ROWNUM    已排流水号个数
         LET l_oga01_num = l_oga01_num - l_oga01_min + l_oga02_num

         #批次更新oga_temp中的单号
         LET l_upd = "UPDATE oga_temp SET oga01 = '",l_oga01_chr CLIPPED,"'||","substr(to_char","((oga01 + '",l_oga01_num,"'),'",l_num_str,"'),2) ",
                     " WHERE oga02 = '",l_oga02,"' "
         PREPARE salecoupon_upd_oga01_pre FROM l_upd
         EXECUTE salecoupon_upd_oga01_pre
         IF SQLCA.sqlcode THEN
            LET g_success = 'N'
            LET g_errno   = SQLCA.sqlcode
            LET g_msg1    = 'Oper:Upd'||' '||'Table:oga_temp'||' '||'Field:oga01'||' '||'Shop:'||p_azw01
            CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
            ROLLBACK WORK
            CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
            LET g_msg   = g_msg[1,255]
            CALL p200_log(g_trans_no,p_azw01,'Batch Operation','06','TG_SALECOUPON',g_errno,g_msg,'0','N',g_msg1)
            LET g_errno = ''
            LET g_msg   = ''
            LET g_msg1  = ''
            CONTINUE WHILE
         END IF
      END FOREACH

      #更新汇率
     #LET l_sql = "SELECT oga23,oga02 FROM oga_temp "          #FUN-CB0103 Mark
      LET l_sql = "SELECT DISTINCT oga23,oga02 FROM oga_temp " #FUN-CB0103 Add
      PREPARE salecoupon_sel_oga23_pre FROM l_sql
      DECLARE salecoupon_sel_oga23_cs CURSOR FOR salecoupon_sel_oga23_pre
      FOREACH salecoupon_sel_oga23_cs INTO l_oga23,l_oga02
         CALL s_currm(l_oga23,l_oga02,g_oaz.oaz52,p_azw01) RETURNING l_oga24
         UPDATE oga_temp SET oga24 = l_oga24 WHERE oga23 = l_oga23 AND oga02 = l_oga02
      END FOREACH
      
      LET l_ins = "INSERT INTO ogb_temp( ",
                  "                     ogb01, ",           #出貨單號
                  "                     ogb03, ",           #項次    
                  "                     ogb04, ",           #產品編號
                  "                     ogb05, ",           #銷售單位
                  "                     ogb05_fac, ",       #销售/库存汇总单位换算率
                  "                     ogb06, ",           #品名规格
                  "                     ogb08, ",           #出货营运中心编号
                  "                     ogb09, ",           #出货仓库编号
                  "                     ogb091, ",          #儲位
                  "                     ogb092, ",          #批號
                  "                     ogb12, ",           #實際出貨數量
                  "                     ogb13, ",           #原幣單價    
                  "                     ogb14, ",           #原幣未稅金額
                  "                     ogb14t, ",          #原幣含稅金額
                  "                     ogb15, ",           #库存单位
                  "                     ogb15_fac, ",       #销售/库存明细单位换算率
                  "                     ogb16, ",           #數量        
                  "                     ogb17, ",           #多倉儲批出貨否
                  "                     ogb18, ",           #預計出貨數量
                  "                     ogb19, ",           #檢驗否        
                  "                     ogb31, ",           #訂單單號
                  "                     ogb32, ",           #訂單項次
                  "                     ogb37, ",           #基礎單价
                  "                     ogb40, ",           #抽成代號
                  "                     ogb44, ",           #经营方式
                  "                     ogb45, ",           #原扣率  
                  "                     ogb46, ",           #新扣率  
                  "                     ogb47, ",           #分攤折價
                  "                     ogb48, ",           #攤位編號
                  "                     ogb50, ",           #開票性質      
                  "                     ogb51, ",           #已簽退數量    
                  "                     ogb52, ",           #簽退數量      
                  "                     ogb53, ",           #單位一驗退數量
                  "                     ogb54, ",           #單位二驗退數量
                  "                     ogb55, ",           #驗退計價數量  
                  "                     ogb60, ",           #已開發票數量
                  "                     ogb63, ",           #銷退數量    
                  "                     ogb64, ",           #銷退數量
                  "                     ogb916, ",          #計價單位
                  "                     ogb917, ",          #計價數量
                  "                     ogb930, ",          #成本中心
                  "                     ogb1001, ",         #原因碼
                  "                     ogb1005, ",         #作業方式
                  "                     ogb1006, ",         #折扣率
                  "                     ogb1012, ",         #搭贈
                  "                     ogb1014, ",         #保稅已放行否
                  "                     ogbplant, ",        #所屬營運中心
                  "                     ogblegal) "         #所屬法人
      LET l_sel = "SELECT ",
                  "       oga01, ",                       #ogb01        #出貨單號
                  "       item, ",                        #ogb03        #項次    
                  "       lpx32, ",                       #ogb04        #產品編號
                  "       'PCS', ",                       #ogb05        #銷售單位
                  "       1, ",                           #ogb05_fac    #销售/库存汇总单位换算率
                  "       NULL, ",                        #ogb06        #品名规格
                  "       Shop, ",                        #ogb08        #出货营运中心编号
                  "       '",g_rtz07,"', ",               #ogb09        #出货仓库编号
                  "       ' ', ",                         #ogb091       #儲位
                  "       ' ', ",                         #ogb092       #批號
                  "       Qty, ",                         #ogb12        #實際出貨數量
                  "       Amt/Qty, ",                     #ogb13        #原幣單價    
                 #"       Amt/(1+oga211/100), ",          #ogb14        #原幣未稅金額               #FUN-CB0103 Mark
                 #"       ROUND(Amt/(1+oga211/100),",g_azi04,"), ",     #ogb14        #原幣未稅金額 #FUN-CB0103 Add  #FUN-D20096 Mark
                  "       Uamt, ",                        #ogb14        #原幣未稅金額                                #FUN-D20096 Add
                  "       Amt, ",                         #ogb14t       #原幣含稅金額
                  "       'PCS', ",                       #ogb15        #库存单位
                  "       1, ",                           #ogb15_fac    #销售/库存明细单位换算率
                  "       Qty, ",                         #ogb16        #數量        
                  "       'N', ",                         #ogb17        #多倉儲批出貨否
                 #"       0, ",                           #ogb18        #預計出貨數量 #FUN-D10040 Mark
                  "       Qty, ",                         #ogb18        #預計出貨數量 #FUN-D10040 Add
                  "       'N', ",                         #ogb19        #檢驗否        
                  "       NULL, ",                        #ogb31        #訂單單號
                  "       NULL, ",                        #ogb32        #訂單項次
                  "       Amt/Qty, ",                     #ogb37        #基礎單价
                  "       NULL, ",                        #ogb40        #抽成代號
                  "       '1', ",                         #ogb44        #经营方式
                  "       NULL, ",                        #ogb45        #原扣率  
                  "       NULL, ",                        #ogb46        #新扣率  
                  "       Disc, ",                        #ogb47        #分攤折價
                  "       NULL, ",                        #ogb48        #攤位編號
                  "       0, ",                           #ogb50        #開票性質      
                  "       0, ",                           #ogb51        #已簽退數量    
                  "       0, ",                           #ogb52        #簽退數量      
                  "       0, ",                           #ogb53        #單位一驗退數量
                  "       0, ",                           #ogb54        #單位二驗退數量
                  "       0, ",                           #ogb55        #驗退計價數量  
                  "       0, ",                           #ogb60        #已開發票數量
                  "       0, ",                           #ogb63        #銷退數量    
                  "       0, ",                           #ogb64        #銷退數量
                  "       'PCS', ",                       #ogb916       #計價單位
                  "       Qty, ",                         #ogb917       #計價數量
                  "       NULL, ",                        #ogb930       #成本中心
                  "       NULL, ",                        #ogb1001      #原因碼
                  "       '1', ",                         #ogb1005      #作業方式
                  "       100, ",                         #ogb1006      #折扣率
                  "       'N', ",                         #ogb1012      #搭贈
                  "       'N', ",                         #ogb1014      #保稅已放行否
                  "       Shop, ",                        #ogbplant     #所屬營運中心
                  "       '",p_azw02,"' ",                #ogblegal     #所屬法人
                  "  FROM ",g_posdbs,"tg_SaleCoupon_detail",g_db_links," ",
                  "       LEFT OUTER JOIN lpx_file ON lpx01 = Giftctf ",
                  "      ,oga_temp ",
                  " WHERE Shop = '",p_azw01,"' AND Cnfflg = 'Y' AND SaleCouponno = oga98 ",
                  " ORDER BY Item "
      LET l_sql = l_ins CLIPPED," ",l_sel CLIPPED
      PREPARE salecoupon_ins_ogb_temp_pre FROM l_sql
      EXECUTE salecoupon_ins_ogb_temp_pre
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Ins'||' '||'Table:ogb_temp'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','06','tg_SaleCoupon',g_errno,g_msg,'0','N',g_msg1) 
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'tg_SaleCoupon',p_azw01) #将对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF
      
      #抓取不存在ogb的oga   
      LET l_cnt = 0
      LET l_sql = "SELECT count(*) FROM oga_temp WHERE oga01 NOT IN (SELECT ogb01 FROM ogb_temp) "
      PREPARE salecoupon_sel_oga01_pre FROM l_sql
      EXECUTE salecoupon_sel_oga01_pre INTO l_cnt
      IF l_cnt > 0 THEN
         LET g_errno   = 'apc1051' #存在单身无资料的单据
         LET g_msg1    = 'Oper:Chk'||' '||'Table:oga_temp'||' '||'Shop:'||p_azw01
        #CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1) #FUN-CB0103 Mark
         CALL s_errmsg('Batch Operation:','',g_msg1,g_errno,1)       #FUN-CB0103 Add
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','06','TG_SALECOUPON',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
      END IF 
         
      #更新中间库状态为A 
      LET l_upd = "UPDATE ",g_posdbs,"tg_SaleCoupon",g_db_links," ",
                  "   SET Condition2 = 'A' ",
                  " WHERE Shop = '",p_azw01,"' ", 
                  "   AND EXISTS (SELECT 1 ",
                  "                 FROM oga_temp ",
                  "                WHERE oga01 NOT IN (SELECT ogb01 FROM ogb_temp) ",
                  "                  AND oga98 = SaleCouponno) "
      PREPARE salecoupon_upd_tg_salecoupon_flag_oga_pre3 FROM l_upd
      EXECUTE salecoupon_upd_tg_salecoupon_flag_oga_pre3
         
      #删除不存在ogb的oga
      DELETE FROM oga_temp WHERE oga01 NOT IN (SELECT ogb01 FROM ogb_temp)

      #更新品名
      LET l_upd = "UPDATE ogb_temp ",                                 
                  "   SET ogb06 = ",
                  "       (SELECT ima02 FROM ",cl_get_target_table(p_azw01,'ima_file'),
                  "         WHERE ima01 = ogb04) "
      PREPARE salecoupon_upd_ogb06_pre FROM l_upd
      EXECUTE salecoupon_upd_ogb06_pre 
      IF SQLCA.sqlcode THEN             
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Upd'||' '||'Table:ogb_temp'||' '||'Field:ogb06'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255] 
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','06','TG_SALECOUPON',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'tg_SaleCoupon',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF
      
      #更新库存单位
      LET l_upd = "UPDATE ogb_temp ",
                  "   SET ogb15 = ",
                  "       (SELECT ima25 FROM ",cl_get_target_table(p_azw01,'ima_file'),
                  "         WHERE ima01 = ogb04) "
      PREPARE salecoupon_upd_ogb15_pre FROM l_upd
      EXECUTE salecoupon_upd_ogb15_pre
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Upd'||' '||'Table:ogb_temp'||' '||'Field:ogb15'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','06','TG_SALECOUPON',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'tg_SaleCoupon',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF

     #FUN-D10040 Add Begin ---
      LET l_upd = "UPDATE ogb_temp SET ogb05 = ogb15,ogb916 = ogb15 "
      PREPARE salecoupon_upd_ogb05_pre FROM l_upd
      EXECUTE salecoupon_upd_ogb05_pre 
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Upd'||' '||'Table:ogb_temp'||' '||'Field:ogb05'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','06','TG_SALECOUPON',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'tg_SaleCoupon',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF
     #FUN-D10040 Add End -----
      
      #更新经营方式
      LET l_upd = "UPDATE ogb_temp ",
                  "   SET ogb44 = ",
                  "       COALESCE((SELECT COALESCE(rty06,'1') FROM ",cl_get_target_table(p_azw01,'rty_file'),
                  "                  WHERE rty01 = '",p_azw01,"' AND rty02 = ogb04),'1') "
      PREPARE salecoupon_upd_ogb44_pre FROM l_upd
      EXECUTE salecoupon_upd_ogb44_pre
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Upd'||' '||'Table:ogb_temp'||' '||'Field:ogb44'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','06','TG_SALECOUPON',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'tg_SaleCoupon',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF
      
     #如果销售单位和库存单位ima25不同时，抓取单位转换率
      LET l_sql = "UPDATE ogb_temp ",
                  "   SET ogb05_fac = ",
                  "       (SELECT smd06/smd04 ",
                  "          FROM ",cl_get_target_table(p_azw01,'smd_file'),
                  "         WHERE smd01 = ogb04 AND smd02 = ogb05 AND smd03 = ogb15)",
                  " WHERE ogb05 <> ogb15 AND ogb05_fac = 0 "
      PREPARE salecoupon_upd_ogb05_fac_pre1 FROM l_sql  
      EXECUTE salecoupon_upd_ogb05_fac_pre1               
      
      LET l_sql = "UPDATE ogb_temp ",
                  "   SET ogb05_fac = ",
                  "       (SELECT smd04/smd06 ",
                  "          FROM ",cl_get_target_table(p_azw01,'smd_file'),
                  "         WHERE smd01 = ogb04 AND smd03 = ogb05 AND smd02 = ogb15)",
                  " WHERE ogb05 <> ogb15 AND ogb05_fac = 0 "
      PREPARE salecoupon_upd_ogb05_fac_pre2 FROM l_sql
      EXECUTE salecoupon_upd_ogb05_fac_pre2
         
      LET l_sql = "UPDATE ogb_temp ",
                  "   SET ogb05_fac = ",
                  "       (SELECT smc03/smc04 ",
                  "          FROM ",cl_get_target_table(p_azw01,'smc_file'),
                  "         WHERE smc01 = ogb05 AND smc02 = ogb15)",
                  " WHERE ogb05 <> ogb15 AND ogb05_fac = 0 "
      PREPARE salecoupon_upd_ogb05_fac_pre3 FROM l_sql
      EXECUTE salecoupon_upd_ogb05_fac_pre3

      LET l_sql = "UPDATE ogb_temp SET ogb15_fac = ogb05_fac,ogb16 = ogb16 * ogb15_fac WHERE ogb05 <> ogb15 "
      PREPARE salecoupon_upd_ogb15_fac_pre FROM l_sql
      EXECUTE salecoupon_upd_ogb15_fac_pre
      
      #更新ogb_temp中成本中心
      LET l_sql = "UPDATE ogb_temp ",
                  "   SET ogb930 = ",
                  "       (SELECT gem10 FROM ",cl_get_target_table(p_azw01,'gem_file'),
                  "         WHERE EXISTS (SELECT 1 FROM oga_temp ",
                  "                        WHERE gem01 = oga15 ",
                  "                          AND oga01 = ogb01)) "
      PREPARE salecoupon_upd_ogb930_pre FROM l_sql
      EXECUTE salecoupon_upd_ogb930_pre
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Upd'||' '||'Table:ogb_temp'||' '||'Field:ogb930'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','06','TG_SALECOUPON',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'tg_SaleCoupon',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF
      
      #若經營方式為聯營或代銷
      LET l_sql = "UPDATE ogb_temp ",
                  "   SET (ogb45,ogb46) = ",
                  "       (SELECT rtv12,rtv12",
                  "          FROM ",cl_get_target_table(p_azw01,'rtv_file'),",",
                                    cl_get_target_table(p_azw01,'rtu_file'),",",
                                    cl_get_target_table(p_azw01,'rtt_file'),",",
                                    cl_get_target_table(p_azw01,'rty_file'),",oga_temp",
                  "         WHERE rtt01 = rtu04 ",
                  "           AND rtt02 = rtu02 ",
                  "           AND rttplant = rtuplant ",
                  "           AND rtuplant = '",p_azw01,"' ",
                  "           AND rtuconf = 'Y' ",
                  "           AND rtuplant = rtvplant ",
                  "           AND rtu01 = rtv01 ",
                  "           AND rtu02 = rtv02 ",
                  "           AND rty01 = '",p_azw01,"' ",
                  "           AND rty02 = ogb04 AND rtyacti = 'Y'",
                  "           AND rtu09 <= oga02 ",
                  "           AND rtu10 >= oga02 ",
                  "           AND rtu05 = rty05 ",
                  "           AND rtu06 = ogb44 ",
                  "           AND rtv04 = ogb04 ",
                  "           AND oga01 = ogb01 )",
                  " WHERE ogb44 IN ('3','4')"
      PREPARE salecoupon_upd_ogb45_p_pre FROM l_sql
      EXECUTE salecoupon_upd_ogb45_p_pre
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Upd'||' '||'Table:ogb_temp'||' '||'Field:(ogb45/ogb46)'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','06','TG_SALECOUPON',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'tg_SaleCoupon',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF

      LET l_sql = "UPDATE ogb_temp ",
                  "   SET (ogb45,ogb46) = ",
                  "       (SELECT rtt11,rtt11",
                  "          FROM ",cl_get_target_table(p_azw01,'rtt_file'),",",
                                    cl_get_target_table(p_azw01,'rts_file'),",",
                                    cl_get_target_table(p_azw01,'rto_file'),",",
                                    cl_get_target_table(p_azw01,'rty_file'),",oga_temp",
                  "         WHERE rts01 = rtt01 ",
                  "           AND rttplant = rtsplant ",
                  "           AND rts02 = rtt02 ",
                  "           AND rtt04 = ogb04 ",
                  "           AND rto01 = rts04 ",
                  "           AND rtoplant = rtsplant ",
                  "           AND rto05 = rty05 ",
                  "           AND rty01 = '",p_azw01,"' ",
                  "           AND rty02 = ogb04 AND rtyacti = 'Y' ",
                  "           AND rto06 = ogb44 ",
                  "           AND rto08 <= oga02 ",
                  "           AND rto09 >= oga02 ",
                  "           AND rtt15 = 'Y' ",
                  "           AND rtoconf = 'Y' ",
                  "           AND rtsconf = 'Y' ",
                  "           AND rto03 = rts02 ",
                  "           AND rtoplant = '",p_azw01,"' ",
                  "           AND oga01 = ogb01 )",
                  " WHERE ogb44 IN ('3','4')",
                  "   AND ogb45 IS NULL "
      PREPARE salecoupon_upd_ogb45_p_pre1 FROM l_sql
      EXECUTE salecoupon_upd_ogb45_p_pre1
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode 
         LET g_msg1    = 'Oper:Upd'||' '||'Table:ogb_temp'||' '||'Field:(ogb45/ogb46)'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','06','TG_SALECOUPON',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'tg_SaleCoupon',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF
      
     #ins xyz
      CALL p200_cardcoupon_xyz_ins_p("oga_file",p_azw01)
      IF g_success='N' THEN
         ROLLBACK WORK
         CONTINUE WHILE
      END IF 
      
     #ins rxc_file 开始
      CALL p200_rxc_ins_p("rxe_file_2",p_azw01,"tg_SaleCoupon_Detail_Agio")
      IF g_success = 'N' THEN
         ROLLBACK WORK
         CONTINUE WHILE
      END IF 
     
     
      #FUN-D20096---Add---Str
      #ins ogh_file
      LET l_ins = "INSERT INTO ogh_temp( ",
                  "       ogh01, ",                     #出貨單號
                  "       ogh02, ",                     #序號
                  "       ogh03, ",                     #稅別
                  "       ogh04, ",                     #稅率
                  "       ogh05, ",                     #固定稅額
                  "       ogh06, ",                     #含稅否
                  "       ogh07, ",                     #未稅金額
                  "       ogh07t, ",                    #含稅金額
                  "       ogh08, ",                     #稅額
                  "       ogh09, ",                     #留抵稅額
                  "       oghdate, ",                   #最近修改日
                  "       oghgrup, ",                   #資料所有部門
                  "       oghlegal, ",                  #所屬法人
                  "       oghmodu, ",                   #資料修改者
                  "       oghorig, ",                   #資料建立部門
                  "       oghoriu, ",                   #資料建立者
                  "       oghplant, ",                  #所屬營運中心
                  "       oghuser) "                    #資料所有者

      LET l_sel = "SELECT DISTINCT ",
                  "       oga01, ",                     #ogh01    出貨單號
                  "       Item, ",                      #ogh02    序號
                  "       Taxcode, ",                   #ogh03    稅別
                  "       Taxrate, ",                   #ogh04    稅率
                  "       0, ",                         #ogh05    固定稅額
                  "       Incltax, ",                   #ogh06    含稅否
                  "       Uamt, ",                      #ogh07    未稅金額
                  "       Amt, ",                       #ogh07t   含稅金額
                  "       Tax, ",                       #ogh08    稅額
                  "       Acctax, ",                    #ogh09    留抵稅額
                  "       ogadate, ",                   #oghdate  最近修改日
                  "       ogagrup, ",                   #oghgrup  資料所有部門
                  "       ogalegal, ",                  #oghlegal 所屬法人
                  "       ogamodu, ",                   #oghmodu  資料修改者
                  "       ogaorig, ",                   #oghorig  資料建立部門
                  "       ogaoriu, ",                   #oghoriu  資料建立者
                  "       Shop, ",                      #oghplant 所屬營運中心
                  "       ogauser ",                    #oghuser  資料所有者
                  "  FROM ",g_posdbs,"tg_SaleCoupon_Tax",g_db_links,",oga_temp ",
                  " WHERE Shop = '",p_azw01,"' ",
                  "   AND SaleCouponNO = oga98 ",
                  " ORDER BY oga01,Item "
      LET l_sql = l_ins CLIPPED," ",l_sel CLIPPED
      CALL cl_replace_sqldb(l_sql) RETURNING l_sql
      PREPARE salecoupon_ins_ogh_temp_pre FROM l_sql
      EXECUTE salecoupon_ins_ogh_temp_pre
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Ins'||' '||'Table:ogh_temp'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','06','tg_SaleCoupon_Tax',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'tg_SaleCoupon_Tax',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF
      
      
      #ins ogi_file
      LET l_ins = "INSERT INTO ogi_temp( ",
                  "       ogi01, ",                     #出貨單號
                  "       ogi02, ",                     #項次
                  "       ogi03, ",                     #序號
                  "       ogi04, ",                     #稅別
                  "       ogi05, ",                     #稅率
                  "       ogi06, ",                     #固定稅額
                  "       ogi07, ",                     #含稅否
                  "       ogi08, ",                     #未稅金額
                  "       ogi08t, ",                    #含稅金額
                  "       ogi09, ",                     #稅額
                  "       ogidate, ",                   #最近修改日
                  "       ogigrup, ",                   #資料所有部門
                  "       ogilegal, ",                  #所屬法人
                  "       ogimodu, ",                   #資料修改者
                  "       ogiorig, ",                   #資料建立部門
                  "       ogioriu, ",                   #資料建立者
                  "       ogiplant, ",                  #所屬營運中心
                  "       ogiuser) "                    #資料所有者

      LET l_sel = "SELECT DISTINCT ",
                  "       oga01, ",                     #ogi01    出貨單號
                  "       Mitem, ",                     #ogi02    項次
                  "       Item, ",                      #ogi03    序號
                  "       Taxcode, ",                   #ogi04    稅別
                  "       Taxrate, ",                   #ogi05    稅率
                  "       0, ",                         #ogi06    固定稅額
                  "       Incltax, ",                   #ogi07    含稅否
                  "       Uamt, ",                      #ogi08    未稅金額
                  "       Amt, ",                       #ogi08t   含稅金額
                  "       Tax, ",                       #ogi09    稅額
                  "       ogadate, ",                   #ogidate  最近修改日
                  "       ogagrup, ",                   #ogigrup  資料所有部門
                  "       ogalegal, ",                  #ogilegal 所屬法人
                  "       ogamodu, ",                   #ogimodu  資料修改者
                  "       ogaorig, ",                   #ogiorig  資料建立部門
                  "       ogaoriu, ",                   #ogioriu  資料建立者
                  "       Shop, ",                      #ogiplant 所屬營運中心
                  "       ogauser ",                    #ogiuser  資料所有者
                  "  FROM ",g_posdbs,"tg_SaleCoupon_Detail_Tax",g_db_links,",oga_temp ",
                  " WHERE Shop = '",p_azw01,"' ",
                  "   AND SaleCouponNO = oga98 ",
                  " ORDER BY Mitem,Item "
      LET l_sql = l_ins CLIPPED," ",l_sel CLIPPED
      CALL cl_replace_sqldb(l_sql) RETURNING l_sql
      PREPARE salecoupon_ins_ogi_temp_pre FROM l_sql
      EXECUTE salecoupon_ins_ogi_temp_pre
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Ins'||' '||'Table:ogi_file'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','06','tg_SaleCoupon_Detail_Tax',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'tg_SaleCoupon_Detail_Tax',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF
      #FUN-D20096---Add---End
 
      LET l_ins = "INSERT INTO rxe_temp( ",
                  "                     rxe00, ",       #單據別
                  "                     rxe01, ",       #單號
                  "                     rxe02, ",       #項次
                  "                     rxe03, ",       #序
                  "                     rxe04, ",       #券起始編號
                  "                     rxe05, ",       #券結束編號
                  "                     rxe06, ",       #券種編號
                  "                     rxe07, ",       #券面額編號
                  "                     rxe08, ",       #券張數
                  "                     rxe09, ",       #總金額
                  "                     rxelegal, ",    #所屬法人
                  "                     rxeplant) "     #所屬營運中心
      LET l_sel = "SELECT ",
                  "       '02', ",                                #rxe00       #單據別
                  "       oga01, ",                               #rxe01       #單號
                  "       Item, ",                                #rxe02       #項次
                  "       ROW_NUMBER() over(partition by oga01 order by oga01), ",   #rxe03       #序號
                  "       BeginCoupon, ",                         #rxe04       #券起始編號
                  "       EndCoupon, ",                           #rxe05       #券結束編號
                  "       Giftctf, ",                             #rxe06       #券種編號
                  "       lqe03, ",                               #rxe07       #券面額編號
                  "       Qty, ",                                 #rxe08       #券張數
                  "       CouponAmt*Qty, ",                       #rxe09       #總金額
                  "       '",p_azw02,"', ",                       #rxelegal    #所屬法人
                  "       Shop ",                                 #rxeplant    #所屬營運中心
                  "  FROM ",g_posdbs,"tg_SaleCoupon_detail",g_db_links," ",
                  "       LEFT OUTER JOIN lqe_file ON lqe01 = BeginCoupon ",
                  "      ,oga_temp ",
                  " WHERE Shop = '",p_azw01,"' AND Cnfflg = 'Y' AND SaleCouponno = oga98 ",
                  " ORDER BY Item "
      LET l_sql = l_ins CLIPPED," ",l_sel CLIPPED
      PREPARE salecoupon_ins_rxe_temp_pre FROM l_sql
      EXECUTE salecoupon_ins_rxe_temp_pre
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Ins'||' '||'Table:rxe_temp'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','06','tg_SaleCoupon_Detail',g_errno,g_msg,'0','N',g_msg1) 
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'tg_SaleCoupon',p_azw01) #将对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF
           
     #更新庫存
      IF g_success = 'Y' THEN
         CALL s_upimg_p('1','',p_azw01,'')
         IF g_success = 'N' THEN
            ROLLBACK WORK
           #FUN-CB0103 Add Begin ---
            CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
            LET g_msg   = g_msg[1,255]
            CALL p200_log(g_trans_no,p_azw01,'Batch Operation','06','tg_SaleCoupon_Detail',g_errno,g_msg,'0','N',g_msg1)
            LET g_errno = ''
            LET g_msg   = ''
            LET g_msg1  = ''
            CALL p200_upd_posflag_p('2',p_gat01,'tg_SaleCoupon',p_azw01) #将对应中间库的资料Condition2更新为A
           #FUN-CB0103 Add End -----
            CONTINUE WHILE
         END IF
         CALL s_instlf_p('1','',p_azw01)
         IF g_success = 'N' THEN
            ROLLBACK WORK
           #FUN-CB0103 Add Begin ---
            CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
            LET g_msg   = g_msg[1,255]
            CALL p200_log(g_trans_no,p_azw01,'Batch Operation','06','tg_SaleCoupon_Detail',g_errno,g_msg,'0','N',g_msg1)
            LET g_errno = ''
            LET g_msg   = ''
            LET g_msg1  = ''
            CALL p200_upd_posflag_p('2',p_gat01,'tg_SaleCoupon',p_azw01) #将对应中间库的资料Condition2更新为A
           #FUN-CB0103 Add End -----
            CONTINUE WHILE
         END IF
      END IF
      
      #将临时表oga_temp插入到数据库中
      LET l_ins = " INSERT INTO ",cl_get_target_table(p_azw01,'oga_file'),
                  " SELECT * FROM oga_temp " 
      CALL cl_replace_sqldb(l_ins) RETURNING l_ins
      CALL cl_parse_qry_sql(l_ins,p_azw01) RETURNING l_ins
      PREPARE salecoupon_ins_oga_pre FROM l_ins
      EXECUTE salecoupon_ins_oga_pre
      IF SQLCA.sqlcode THEN 
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Ins'||' '||'Table:oga_file'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','06','TG_SALECOUPON',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'tg_SaleCoupon',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF 

      #将临时表ogb_temp插入到数据库中
      LET l_ins = " INSERT INTO ",cl_get_target_table(p_azw01,'ogb_file'),
                  " SELECT * FROM ogb_temp "
      CALL cl_replace_sqldb(l_ins) RETURNING l_ins
      CALL cl_parse_qry_sql(l_ins,p_azw01) RETURNING l_ins
      PREPARE salecoupon_ins_ogb_pre FROM l_ins
      EXECUTE salecoupon_ins_ogb_pre
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Ins'||' '||'Table:ogb_file'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','06','TG_SALECOUPON',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'tg_SaleCoupon',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF

      #FUN-D20096---Add---Str
      #将临时表ogh_temp插入到数据库中
      LET l_ins = " INSERT INTO ",cl_get_target_table(p_azw01,'ogh_file'),
                  " SELECT * FROM ogh_temp "
      CALL cl_replace_sqldb(l_ins) RETURNING l_ins
      CALL cl_parse_qry_sql(l_ins,p_azw01) RETURNING l_ins
      PREPARE salecoupon_ins_ogh_pre FROM l_ins
      EXECUTE salecoupon_ins_ogh_pre
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Ins'||' '||'Table:ogh_file'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','06','tg_SaleCoupon_Tax',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'tg_SaleCoupon_Tax',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF

      #将临时表ogi_temp插入到数据库中
      LET l_ins = " INSERT INTO ",cl_get_target_table(p_azw01,'ogi_file'),
                  " SELECT * FROM ogi_temp "
      CALL cl_replace_sqldb(l_ins) RETURNING l_ins
      CALL cl_parse_qry_sql(l_ins,p_azw01) RETURNING l_ins
      PREPARE salecoupon_ins_ogi_pre FROM l_ins
      EXECUTE salecoupon_ins_ogi_pre
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Ins'||' '||'Table:ogi_file'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','06','tg_SaleCoupon_Detail_Tax',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'tg_SaleCoupon_Detail_Tax',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF
      #FUN-D20096---Add---End

      #将临时表rxe_temp插入到数据库中
      LET l_ins = " INSERT INTO ",cl_get_target_table(p_azw01,'rxe_file'),
                  " SELECT * FROM rxe_temp " 
      CALL cl_replace_sqldb(l_ins) RETURNING l_ins
      CALL cl_parse_qry_sql(l_ins,p_azw01) RETURNING l_ins
      PREPARE salecoupon_ins_rxe_oga_pre FROM l_ins
      EXECUTE salecoupon_ins_rxe_oga_pre
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode 
         LET g_msg1    = 'Oper:Ins'||' '||'Table:rxe_file'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','06','TG_SALECOUPON',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'tg_SaleCoupon',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF

      #将临时表rxx_temp插入到数据库中
      LET l_ins = " INSERT INTO ",cl_get_target_table(p_azw01,'rxx_file'),
                  " SELECT * FROM rxx_temp " 
      CALL cl_replace_sqldb(l_ins) RETURNING l_ins
      CALL cl_parse_qry_sql(l_ins,p_azw01) RETURNING l_ins
      PREPARE salecoupon_ins_rxx_oga_pre FROM l_ins
      EXECUTE salecoupon_ins_rxx_oga_pre
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode 
         LET g_msg1    = 'Oper:Ins'||' '||'Table:rxx_file'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','06','TG_SALECOUPON',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'tg_SaleCoupon',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF

      #将临时表rxy_temp插入到数据库中
      LET l_ins = " INSERT INTO ",cl_get_target_table(p_azw01,'rxy_file'),
                  " SELECT * FROM rxy_temp "
      CALL cl_replace_sqldb(l_ins) RETURNING l_ins
      CALL cl_parse_qry_sql(l_ins,p_azw01) RETURNING l_ins
      PREPARE salecoupon_ins_rxy_oga_pre FROM l_ins
      EXECUTE salecoupon_ins_rxy_oga_pre
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Ins'||' '||'Table:rxy_file'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','06','TG_SALECOUPON',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'tg_SaleCoupon',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF

      #将临时表rxz_temp插入到数据库中
      LET l_ins = " INSERT INTO ",cl_get_target_table(p_azw01,'rxz_file'),
                  " SELECT * FROM rxz_temp "
      CALL cl_replace_sqldb(l_ins) RETURNING l_ins
      CALL cl_parse_qry_sql(l_ins,p_azw01) RETURNING l_ins
      PREPARE salecoupon_ins_rxz_oga_pre FROM l_ins
      EXECUTE salecoupon_ins_rxz_oga_pre
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Ins'||' '||'Table:rxz_file'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','06','TG_SALECOUPON',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'tg_SaleCoupon',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF
      
      CALL p200_upd_posflag_p("1","rxe_file_2","tg_SaleCoupon",p_azw01)
      IF g_success = 'N' THEN
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Upd'||' '||'Table:tg_SaleCoupon'||' '||'Field:Condition2'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','06','TG_SALECOUPON',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'tg_SaleCoupon',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF

      IF g_success = 'Y' THEN
         LET g_sucflag = 1
         COMMIT WORK
      ELSE
         ROLLBACK WORK
      END IF

   END WHILE
   #删除建立的临时表
   DROP TABLE oga_temp
   DROP TABLE ogb_temp
   DROP TABLE ogh_temp   #FUN-D20096 Add
   DROP TABLE ogi_temp   #FUN-D20096 Add
   DROP TABLE rxe_temp
   DROP TABLE rxx_temp
   DROP TABLE rxy_temp
   DROP TABLE rxz_temp
END FUNCTION
#FUN-CA0160 Add End -----

#FUN-CA0160 Add Begin ---
#退券上传
FUNCTION p200_rxe_ins_p_oha(p_gat01,p_azw01)
DEFINE p_gat01       LIKE gat_file.gat01
DEFINE p_azw01       LIKE azw_file.azw01
DEFINE p_azw02       LIKE azw_file.azw02
DEFINE l_ins         STRING
DEFINE l_upd         STRING
DEFINE l_sql         STRING
DEFINE l_sel         STRING
DEFINE l_oha01       LIKE oha_file.oha01
DEFINE l_oha02       LIKE oha_file.oha02
DEFINE l_num_len     LIKE type_file.num10
DEFINE l_num_str     LIKE type_file.chr20
DEFINE l_oha01_str   STRING
DEFINE l_oha01_num   LIKE type_file.chr20
DEFINE l_oha01_chr   LIKE type_file.chr20
DEFINE l_oha02_old   LIKE oha_file.oha02
DEFINE l_oha01_min   LIKE oha_file.oha01
DEFINE l_oha01_max   LIKE oha_file.oha01
DEFINE l_oha01_min_o LIKE oha_file.oha01
DEFINE l_oha01_max_o LIKE oha_file.oha01
DEFINE l_oha02_num   LIKE type_file.num10
DEFINE l_azn05       LIKE azn_file.azn05
DEFINE l_azn05_old   LIKE azn_file.azn05
DEFINE l_upd_num     LIKE type_file.num10
DEFINE l_cnt         LIKE type_file.num5
DEFINE l_oha23       LIKE oha_file.oha23
DEFINE l_oha24       LIKE oha_file.oha24

   #组出过滤条件
   IF NOT cl_null(g_saleno) THEN
      LET g_wc = " SaleCouponno = '",g_saleno,"' "
   ELSE
      CALL p200_g_wc("rxe_file_3") RETURNING g_wc
   END IF
   IF cl_null(g_wc) THEN LET g_wc = " 1=1" END IF

   SELECT azw02 INTO p_azw02 FROM azw_file WHERE azw01 = p_azw01

   #将中间库中符合条件的资料Condition2更新为B
   LET l_upd = "UPDATE ",g_posdbs,"tg_SaleCoupon",g_db_links," ",
               "   SET Condition2 = 'B' ",
               " WHERE Condition2 <> 'Y' AND Type = '1' AND Cnfflg = 'Y' AND Shop = '",p_azw01 CLIPPED,"' AND ",g_wc CLIPPED
   PREPARE salecoupon_upd_tg_salecoupon_oha_pre FROM l_upd
   EXECUTE salecoupon_upd_tg_salecoupon_oha_pre
   IF SQLCA.sqlcode THEN
      LET g_success = 'N'
      LET g_errno   = SQLCA.sqlcode
      LET g_msg1    = 'Oper:Upd'||' '||'Table:tg_SaleCoupon'||' '||'Shop:'||p_azw01
      CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
      ROLLBACK WORK
      CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
      LET g_msg   = g_msg[1,255]
      CALL p200_log(g_trans_no,p_azw01,'Batch Operation','06','TG_SALECOUPON',g_errno,g_msg,'0','N',g_msg1)
      LET g_errno = ''
      LET g_msg   = ''
      LET g_msg1  = ''
      RETURN
   END IF
   
   LET l_upd_num = SQLCA.sqlerrd[3] 
   IF l_upd_num <= 0 THEN RETURN END IF
   IF cl_null(g_sum_limit) OR g_sum_limit = 0 THEN LET g_sum_limit = l_upd_num END IF

   #先删除需要建立的临时表
   DROP TABLE oha_temp
   DROP TABLE ohb_temp
   DROP TABLE ogj_temp    #FUN-D20096 Add
   DROP TABLE ogk_temp    #FUN-D20096 Add
   DROP TABLE rxe_temp
   DROP TABLE rxx_temp
   DROP TABLE rxy_temp
   DROP TABLE rxz_temp

   #建立临时表
   SELECT * FROM oha_file WHERE 1=0 INTO TEMP oha_temp
   SELECT * FROM ohb_file WHERE 1=0 INTO TEMP ohb_temp
   SELECT * FROM ogj_file WHERE 1=0 INTO TEMP ogj_temp    #FUN-D20096 Add
   SELECT * FROM ogk_file WHERE 1=0 INTO TEMP ogk_temp    #FUN-D20096 Add
   SELECT * FROM rxe_file WHERE 1=0 INTO TEMP rxe_temp
   SELECT * FROM rxx_file WHERE 1=0 INTO TEMP rxx_temp
   SELECT * FROM rxy_file WHERE 1=0 INTO TEMP rxy_temp
   SELECT * FROM rxz_file WHERE 1=0 INTO TEMP rxz_temp

   #建立索引

   WHILE l_upd_num > 0
      LET l_upd_num = l_upd_num - g_sum_limit
   
     #清空临时表
      DELETE FROM oha_temp
      DELETE FROM ohb_temp
      DELETE FROM ogj_temp   #FUN-D20096 Add
      DELETE FROM ogk_temp   #FUN-D20096 Add
      DELETE FROM rxe_temp
      DELETE FROM rxx_temp
      DELETE FROM rxy_temp
      DELETE FROM rxz_temp
   
      LET g_success = 'Y'
      BEGIN WORK
      
      LET l_ins = "INSERT INTO oha_temp( ",
                  "                     oha01, ",       #销退单号
                  "                     oha02, ",       #销退日期
                  "                     oha03, ",       #账款客户编号
                  "                     oha032, ",      #账款客户简称
                  "                     oha04, ",       #退货客户编号
                  "                     oha05, ",       #单据别 
                  "                     oha08, ",       #1.内销 2.外销 3.视同外销
                  "                     oha09, ",       #销退处理方式
                  "                     oha14, ",       #人员编号
                  "                     oha15, ",       #部门编号
                  "                     oha16, ",       #出货单号
                  "                     oha21, ",       #税种
                  "                     oha211, ",      #税率
                  "                     oha212, ",      #联数
                  "                     oha213, ",      #含税否
                  "                     oha23, ",       #币种
                  "                     oha24, ",       #汇率
                  "                     oha25, ",       #销售分类一
                  "                     oha31, ",       #价格条件
                  "                     oha42, ",       #是否入库存
                  "                     oha43, ",       #起始三角贸易销退单否
                  "                     oha44, ",       #抛转否
                  "                     oha48, ",       #备注
                  "                     oha50, ",       #原币销退总税前金额
                  "                     oha53, ",       #原币销退应开折让税前金额
                  "                     oha54, ",       #原币销退已开折让税前金额
                  "                     oha55, ",       #状况码
                  "                     oha57, ",       #发票性质
                  "                     oha85, ",       #结算方式
                  "                     oha87, ",       #会员卡号
                  "                     oha88, ",       #顾客姓名
                  "                     oha89, ",       #联系电话
                  "                     oha90, ",       #证件类型
                  "                     oha91, ",       #证件号码  
                  "                     oha94, ",       #POS销售否 Y-是,N-否
                  "                     oha95, ",       #本次积分
                  "                     oha96, ",       #收银机号
                  "                     oha98, ",       #POS单号 
                  "                     oha1015, ",     #调货出货单自动生成否
                  "                     oha1019, ",     #返利退回税前金额
                  "                     ohaconf, ",     #审核否
                  "                     ohapost, ",     #扣账否
                  "                     ohaprsw, ",     #打印次数
                  "                     ohauser, ",     #资料所有者
                  "                     ohagrup, ",     #资料所有部门
                  "                     ohamksg, ",     #签核否
                  "                     ohaplant, ",    #所属营运中心
                  "                     ohalegal, ",    #所属法人
                  "                     ohacond, ",     #审核日期
                  "                     ohaconu, ",     #审核人员
                  "                     ohaoriu, ",     #资料建立者
                  "                     ohaorig, ",     #资料建立部门
                  "                     ohacont, ",     #审核时间
                  "                     ohadate) "      #最近更改日
      LET l_sel = "SELECT ",
                  "       ROW_NUMBER() over(order by Shop,SaleCouponno), ",   #oha01           #销退单号
                  "       CAST (Bdate AS DATE), ",                            #oha02           #销退日期
                  "       rtz06, ",                                           #oha03           #账款客户编号
                  "       occ02, ",                                           #oha032          #账款客户简称
                  "       rtz06, ",                                           #oha04           #退货客户编号
                  "       '1', ",                                             #oha05           #单据别
                  "       '1', ",                                             #oha08           #1.内销 2.外销 3.视同外销
                  "       '1', ",                                             #oha09           #销退处理方式
                  "       ryi02, ",                                           #oha14           #人员编号
                  "       gen03, ",                                           #oha15           #部门编号
                  "       CASE Otype WHEN 0 THEN Ofno ELSE NULL END, ",       #oha16           #出货单号
                  "       occ41, ",                                           #oha21           #税种
                  "       gec04, ",                                           #oha211          #税率
                  "       gec05, ",                                           #oha212          #联数
                  "       gec07, ",                                           #oha213          #含税否
                  "       occ42, ",                                           #oha23           #币种
                  "       NULL, ",                                            #oha24           #汇率
                  "       occ43, ",                                           #oha25           #销售分类一
                  "       occ44, ",                                           #oha31           #价格条件
                  "       'N', ",                                             #oha42           #是否入库存
                  "       'N', ",                                             #oha43           #起始三角贸易销退单否
                  "       'N', ",                                             #oha44           #抛转否
                  "       NULL, ",                                            #oha48           #备注
                  "       Tot_amt, ",                                         #oha50           #原币销退总税前金额
                  "       0, ",                                               #oha53           #原币销退应开折让税前金额
                  "       0, ",                                               #oha54           #原币销退已开折让税前金额
                  "       '1', ",                                             #oha55           #状况码
                  "       '1', ",                                             #oha57           #发票性质
                  "       '1', ",                                             #oha85           #结算方式
                  "       NULL, ",                                            #oha87           #会员卡号
                  "       NULL, ",                                            #oha88           #顾客姓名
                  "       NULL, ",                                            #oha89           #联系电话
                  "       NULL, ",                                            #oha90           #证件类型
                  "       NULL, ",                                            #oha91           #证件号码
                  "       'Y', ",                                             #oha94           #POS销售否 Y-是,N-否
                  "       0, ",                                               #oha95           #本次积分
                  "       Machine, ",                                         #oha96           #收银机号
                  "       SaleCouponno, ",                                    #oha98           #POS单号
                  "       'N', ",                                             #oha1015         #调货出货单自动生成否
                  "       0, ",                                               #oha1019         #返利退回税前金额
                  "       'Y', ",                                             #ohaconf         #审核否
                  "       'Y', ",                                             #ohapost         #扣账否
                  "       0, ",                                               #ohaprsw         #打印次数
                  "       ryi02, ",                                           #ohauser         #资料所有者
                  "       gen03, ",                                           #ohagrup         #资料所有部门
                  "       'N', ",                                             #ohamksg         #签核否
                  "       Shop, ",                                            #ohaplant        #所属营运中心
                  "       '",p_azw01,"', ",                                   #ohalegal        #所属法人
                  "       CAST (Sdate AS DATE), ",                            #ohacond         #审核日期
                  "       ryi02, ",                                           #ohaconu         #审核人员
                  "       ryi02, ",                                           #ohaoriu         #资料建立者 
                  "       gen03, ",                                           #ohaorig         #资料建立部门
                  "       Stime[1,2]||':'||Stime[3,4]||':'||Stime[5,6], ",    #ohacont         #审核时间
                  "       CAST (Sdate AS DATE) ",                             #ohadate         #最近更改日
                  "  FROM ( ",
                  "SELECT * ",
                  "  FROM ",g_posdbs,"tg_SaleCoupon",g_db_links," ",                              
                  " WHERE Shop = '",p_azw01,"' AND Condition2 = 'B' ",                      
                  "   AND Type = '1' AND Cnfflg = 'Y' ",                    
                  " ORDER BY Bdate,SaleCouponno) LEFT OUTER JOIN ",cl_get_target_table(p_azw01,'rtz_file'),
                  "                                           ON rtz01 = Shop ",
                  "                              LEFT OUTER JOIN ",cl_get_target_table(p_azw01,'occ_file'),
                  "                                           ON occ01 = rtz06 ",
                  "                              LEFT OUTER JOIN ",cl_get_target_table(p_azw01,'ryi_file'),
                  "                                           ON ryi01 = Opno ",
                  "                              LEFT OUTER JOIN ",cl_get_target_table(p_azw01,'gen_file'),
                  "                                           ON gen01 = ryi02 ",
                  "                              LEFT OUTER JOIN ",cl_get_target_table(p_azw01,'gec_file'),
                  "                                           ON gec01 = occ41 AND gec011 = '2' ",
                  " WHERE ROWNUM <= ",g_sum_limit," ",
                  " ORDER BY Bdate,SaleCouponno " 
      LET l_sql = l_ins CLIPPED," ",l_sel CLIPPED
      PREPARE salecoupon_ins_oha_temp_pre FROM l_sql
      EXECUTE salecoupon_ins_oha_temp_pre
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Ins'||' '||'Table:oha_temp(SaleCoupon)'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','06','tg_SaleCoupon',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CONTINUE WHILE
      END IF

      #存在售券未上传
      LET l_cnt = 0
      LET l_sql = "SELECT COUNT(*) ",
                  "  FROM ",g_posdbs,"tg_SaleCoupon",g_db_links," ",
                  " WHERE Condition2 <> 'Y' AND type = '0' AND shop = '",p_azw01,"' AND EXISTS (SELECT 1 FROM oha_temp WHERE oha16 = SaleCouponno AND oha16 IS NOT NULL)"
      PREPARE salecoupon_sel_oha_oga_pre FROM l_sql
      EXECUTE salecoupon_sel_oha_oga_pre INTO l_cnt
      IF l_cnt > 0 THEN
         LET g_success = 'N'
         LET g_errno   = 'apc1053' #存在售券未上传
         LET g_msg1    = 'Oper:Chk'||' '||'Table:oha_temp'||' '||'Shop:'||p_azw01
        #CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1) #FUN-CB0103 Mark
         CALL s_errmsg('Batch Operation:','',g_msg1,g_errno,1)       #FUN-CB0103 Add
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','06','TG_SALECOUPON',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
      END IF

      #更新中间库状态为A
      LET l_upd = "UPDATE ",g_posdbs,"tg_SaleCoupon",g_db_links," a ",
                  "   SET a.Condition2 = 'A' ",
                  " WHERE a.Shop = '",p_azw01,"' AND a.Type = '1' ",
                  "   AND a.SaleCouponno IN (SELECT oga98 ",
                  "                            FROM oga_temp ",
                  "                           WHERE EXISTS (SELECT 1 FROM ",g_posdbs,"tg_SaleCoupon",g_db_links," b ",
                  "                                          WHERE b.Condition2 <> 'Y' ",
                  "                                            AND b.Type = '0' AND b.Shop = '",p_azw01,"' ",
                  "                                            AND oha16 = b.SaleCouponno) ",
                  "                             AND oha16 IS NOT NULL) "
      PREPARE salecoupon_upd_tg_salecoupon_flag_oha_pre1 FROM l_upd
      EXECUTE salecoupon_upd_tg_salecoupon_flag_oha_pre1

      #删除来源售券未上传的单据
      LET l_sql = "DELETE FROM oha_temp ",
                  " WHERE EXISTS (SELECT 1 FROM ",g_posdbs,"tg_SaleCoupon",g_db_links," ",
                  "                WHERE Condition2 <> 'Y' ",
                  "                  AND Type = '0' AND Shop = '",p_azw01,"' ",
                  "                  AND oha16 = SaleCouponno) ",
                  "   AND oha16 IS NOT NULL "
      PREPARE salecoupon_del_oha_temp_pre FROM l_sql
      EXECUTE salecoupon_del_oha_temp_pre
      
      #报错单据日期小于关帐日期的资料
      INITIALIZE l_oha02 TO NULL
      SELECT MIN(oha02) INTO l_oha02 FROM oha_temp WHERE oha02 <= g_sma.sma53
      IF NOT cl_null(l_oha02) THEN
         LET g_errno   = 'apc1054' #单据日期小于关帐日期
         LET g_msg1    = 'Oper:Chk'||' '||'Table:oha_temp'||' '||'Field:Min(oha02)'||' '||'Shop:'||p_azw01
        #CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1) #FUN-CB0103 Mark
         CALL s_errmsg('Batch Operation:','',g_msg1,g_errno,1)       #FUN-CB0103 Add
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','06','TG_SALECOUPON',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
      END IF

      #更新中间库状态为A
      LET l_upd = "UPDATE ",g_posdbs,"tg_SaleCoupon",g_db_links," ",
                  "   SET Condition2 = 'A' ",
                  " WHERE Shop = '",p_azw01,"' ",
                  "   AND EXISTS (SELECT 1 ",
                  "                 FROM oha_temp ",
                  "                WHERE oha02 <= '",g_sma.sma53,"' ",
                  "                  AND oha98 = SaleCouponno) "
      PREPARE salecoupon_upd_tg_salecoupon_flag_oha_pre2 FROM l_upd
      EXECUTE salecoupon_upd_tg_salecoupon_flag_oha_pre2

      #删除单据日期小于关帐日期的资料
      DELETE FROM oha_temp WHERE oha02 <= g_sma.sma53
      
      INITIALIZE l_oha02_old,l_oha01_min_o,l_oha01_max_o,l_azn05_old TO NULL
      INITIALIZE l_oha02,l_oha02_num,l_oha01_min,l_oha01_max,l_azn05 TO NULL
      LET l_sql = "SELECT DISTINCT MIN(to_number(oha01)),oha02,MAX(to_number(oha01)) FROM oha_temp GROUP BY oha02 order by oha02"
      PREPARE salecoupon_sel_oha02_pre FROM l_sql
      DECLARE salecoupon_sel_oha02_cs CURSOR FOR salecoupon_sel_oha02_pre
      FOREACH salecoupon_sel_oha02_cs INTO l_oha01_min,l_oha02,l_oha01_max
      
         #自动编号
         LET g_ndate = l_oha02
        #CALL p200_auto_doc(p_gat01,p_azw01) RETURNING l_oha01     #FUN-CC0082 Mark
         CALL p200_auto_doc(p_gat01,p_azw01,'Y') RETURNING l_oha01 #FUN-CC0082 Add
         IF g_success = 'N' THEN
            EXIT WHILE
         END IF
         
         CASE g_ryz05
            WHEN "1"
               LET l_num_len = 8
            WHEN "2"
               LET l_num_len = 9
            WHEN "3"
               LET l_num_len = 10
         END CASE

         CASE g_ryz06
            WHEN "1"
               LET l_num_len = l_num_len
               IF NOT cl_null(l_oha02_old) THEN
                  LET l_oha02_num = l_oha01_max_o - l_oha01_min_o + 1 + l_oha02_num
               ELSE
                  LET l_oha02_num = 0
               END IF
            WHEN "2"
               LET l_num_len = l_num_len - 4
               IF NOT cl_null(l_oha02_old) THEN #若FOREACH之前还有日期
                  IF YEAR(l_oha02_old) = YEAR(l_oha02) AND MONTH(l_oha02_old) = MONTH(l_oha02) THEN
                     LET l_oha02_num = l_oha01_max_o - l_oha01_min_o + 1 + l_oha02_num
                  ELSE
                     LET l_oha02_num = 0
                  END IF
               ELSE
                  LET l_oha02_num = 0
               END IF
            WHEN "3"
               LET l_num_len = l_num_len - 4
               IF NOT cl_null(l_oha02_old) THEN
                  INITIALIZE l_azn05 TO NULL
                  SELECT azn05 INTO l_azn05 FROM azn_file WHERE azn01 = l_oha02
                  IF YEAR(l_oha02_old) = YEAR(l_oha02) AND l_azn05_old = l_azn05 THEN
                     LET l_oha02_num = l_oha01_max_o - l_oha01_min_o + 1 + l_oha02_num
                  ELSE
                     LET l_oha02_num = 0
                  END IF
               ELSE
                  LET l_oha02_num = 0
               END IF
            WHEN "4"
               LET l_num_len = l_num_len - 6
              #FUN-D30061 Mark&Add Begin ---
              #IF NOT cl_null(l_oha02_old) THEN
              #   LET l_oha02_num = l_oha01_max_o - l_oha01_min_o + 1 + l_oha02_num
              #ELSE
              #   LET l_oha02_num = 0
              #END IF
               LET l_oha02_num = 0
              #FUN-D30061 Mark&Add End -----
         END CASE

         LET l_oha01_min_o = l_oha01_min
         LET l_oha01_max_o = l_oha01_max
         LET l_azn05_old   = l_azn05
         LET l_oha02_old   = l_oha02

         INITIALIZE l_num_str TO NULL
         FOR l_cnt = 1 TO l_num_len
            LET l_num_str = l_num_str CLIPPED,'0'
         END FOR
         LET l_oha01_str = l_oha01
         LET l_oha01_num = l_oha01_str.subString(l_oha01_str.getLength() - l_num_len + 1,l_oha01_str.getLength())
         LET l_oha01_chr = l_oha01_str.subString(1,l_oha01_str.getLength() - l_num_len)
         LET l_oha01_num = l_oha01_num - l_oha01_min + l_oha02_num

         #批次更新oha_temp中的单号
         LET l_upd = "UPDATE oha_temp SET oha01 = '",l_oha01_chr CLIPPED,"'||","substr(to_char","((oha01 + '",l_oha01_num,"'),'",l_num_str,"'),2) ",
                     " WHERE oha02 = '",l_oha02,"' "
         PREPARE salecoupon_upd_oha01_pre FROM l_upd
         EXECUTE salecoupon_upd_oha01_pre
         IF SQLCA.sqlcode THEN
            LET g_success = 'N'
            LET g_errno   = SQLCA.sqlcode
            LET g_msg1    = 'Oper:Upd'||' '||'Table:oha_temp'||' '||'Field:oha01'||' '||'Shop:'||p_azw01
            CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
            ROLLBACK WORK
            CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
            LET g_msg   = g_msg[1,255]
            CALL p200_log(g_trans_no,p_azw01,'Batch Operation','06','TG_SALECOUPON',g_errno,g_msg,'0','N',g_msg1)
            LET g_errno = ''
            LET g_msg   = ''
            LET g_msg1  = ''
            CALL p200_upd_posflag_p('2',p_gat01,'tg_SaleCoupon',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
            RETURN
         END IF   
               
      END FOREACH
      
      #更新来源出货单单号
      LET l_sql= "UPDATE oha_temp ",
                 "   SET oha16 = (SELECT oga01 FROM ",cl_get_target_table(p_azw01,'oga_file'),
                 "                 WHERE oga98 = oha16 AND ogaconf = 'Y' AND ROWNUM = 1) ",
                 " WHERE oha16 IS NOT NULL "
      PREPARE salecoupon_upd_oha16_pre FROM l_sql
      EXECUTE salecoupon_upd_oha16_pre
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Upd'||' '||'Table:oha_temp'||' '||'Field:oha16'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','06','TG_SALECOUPON',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'tg_SaleCoupon',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF

      #更新汇率
     #LET l_sql = "SELECT oha23,oha02 FROM oha_temp "          #FUN-CB0103 Mark
      LET l_sql = "SELECT DISTINCT oha23,oha02 FROM oha_temp " #FUN-CB0103 Add
      PREPARE salecoupon_sel_oha23_pre FROM l_sql
      DECLARE salecoupon_sel_oha23_cs CURSOR FOR salecoupon_sel_oha23_pre
      FOREACH salecoupon_sel_oha23_cs INTO l_oha23,l_oha02
         CALL s_currm(l_oha23,l_oha02,g_oaz.oaz52,p_azw01) RETURNING l_oha24 
         UPDATE oha_temp SET oha24 = l_oha24 WHERE oha23 = l_oha23 AND oha02 = l_oha02
         IF SQLCA.sqlcode THEN
            LET g_success = 'N'
            LET g_errno   = SQLCA.sqlcode 
            LET g_msg1    = 'Oper:Upd'||' '||'Table:oha_temp'||' '||'Field:oha24'||' '||'Shop:'||p_azw01
            CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
            ROLLBACK WORK
            CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
            LET g_msg   = g_msg[1,255]
            CALL p200_log(g_trans_no,p_azw01,'Batch Operation','06','TG_SALECOUPON',g_errno,g_msg,'0','N',g_msg1)
            LET g_errno = ''
            LET g_msg   = ''
            LET g_msg1  = ''
            CALL p200_upd_posflag_p('2',p_gat01,'tg_SaleCoupon',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
            CONTINUE WHILE
         END IF
      END FOREACH
      
      #ins ohb_temp开始
      LET l_ins = "INSERT INTO ohb_temp( ",
                  "                     ohb01, ",            #销退单号
                  "                     ohb03, ",            #项次
                  "                     ohb04, ",            #产品编号
                  "                     ohb05, ",            #销售单位
                  "                     ohb05_fac, ",        #销售/库存单位换算率
                  "                     ohb06, ",            #品名规格
                  "                     ohb08, ",            #销退入库营运中心编号
                  "                     ohb09, ",            #销退入库仓库编号
                  "                     ohb12, ",            #数量
                  "                     ohb13, ",            #原币单价
                  "                     ohb14, ",            #原币税前金额
                  "                     ohb14t, ",           #原币含税金额
                  "                     ohb15, ",            #库存明细单位由厂/仓/位/批自动得出
                  "                     ohb15_fac, ",        #销售/库存明细单位换算率
                  "                     ohb16, ",            #数量
                  "                     ohb30, ",            #原出货发票号
                  "                     ohb31, ",            #出货单号
                  "                     ohb32, ",            #出货项次
                  "                     ohb33, ",            #订单单号
                  "                     ohb34, ",            #订单项次
                  "                     ohb37, ",            #基础单价
                  "                     ohb40, ",            #抽成编号
                  "                     ohb60, ",            #已开折让数量
                  "                     ohb61, ",            #检验
                  "                     ohb64, ",            #经营方式
                  "                     ohb65, ",            #原扣率
                  "                     ohb66, ",            #新扣率
                  "                     ohb67, ",            #分摊折价=全部折价字段值的合计
                  "                     ohb68, ",            #有实物否  Y-是,N-否
                  "                     ohb69, ",            #摊位编号
                  "                     ohb70, ",            #商户编号
                  "                     ohb71, ",            #开票性质
                  "                     ohb916, ",           #计价单位
                  "                     ohb917, ",           #计价数量
                  "                     ohb930, ",           #成本中心
                  "                     ohb1004, ",          #搭增
                  "                     ohb1005, ",          #作业方式
                  "                     ohbplant, ",         #所属营运中心
                  "                     ohblegal) "          #所属法人
      LET l_sel = "SELECT ",
                  "       oha01, ",               #ohb01          #销退单号
                  "       Item, ",                #ohb03          #项次
                  "       lpx32, ",               #ohb04          #产品编号
                  "       'PCS', ",               #ohb05          #销售单位 
                  "       1, ",                   #ohb05_fac      #销售/库存单位换算率
                  "       NULL, ",                #ohb06          #品名规格
                  "       Shop, ",                #ohb08          #销退入库营运中心编号
                  "       '",g_rtz07,"', ",       #ohb09          #销退入库仓库编号
                  "       Qty, ",                 #ohb12          #数量
                  "       Amt/Qty, ",             #ohb13          #原币单价
                 #"       Amt/(1+oha211/100), ",  #ohb14          #原币税前金额                    #FUN-CB0103 Mark
                 #"       ROUND(Amt/(1+oha211/100),",g_azi04,"), ",  #ohb14          #原币税前金额 #FUN-CB0103 Add  #FUN-D20096 Mark
                  "       Uamt, ",                #ohb14          #原币税前金额                                     #FUN-D20096 Add
                  "       Amt, ",                 #ohb14t         #原币含税金额
                  "       'PCS', ",               #ohb15          #库存明细单位 
                  "       1, ",                   #ohb15_fac      #销售/库存明细单位换算率
                  "       Qty, ",                 #ohb16          #数量
                  "       NULL, ",                #ohb30          #原出货发票号
                  "       oha16, ",               #ohb31          #出货单号
                  "       NULL, ",                #ohb32          #出货项次
                  "       NULL, ",                #ohb33          #订单单号
                  "       NULL, ",                #ohb34          #订单项次
                  "       Amt/Qty, ",             #ohb37          #基础单价
                  "       NULL, ",                #ohb40          #抽成编号
                  "       0, ",                   #ohb60          #已开折让数量
                  "       'N', ",                 #ohb61          #检验
                  "       '1', ",                 #ohb64          #经营方式
                  "       NULL, ",                #ohb65          #原扣率
                  "       NULL, ",                #ohb66          #新扣率
                  "       Disc, ",                #ohb67          #分摊折价=全部折价字段值的合计
                  "       'N', ",                 #ohb68          #有实物否Y-是,N-否
                  "       NULL, ",                #ohb69          #摊位编号
                  "       NULL, ",                #ohb70          #商户编号
                  "       NULL, ",                #ohb71          #开票性质
                  "       'PCS', ",               #ohb916         #计价单位
                  "       Qty, ",                 #ohb917         #计价数量
                  "       NULL, ",                #ohb930         #成本中心
                  "       'N', ",                 #ohb1004        #搭增
                  "       '1', ",                 #ohb1005        #作业方式
                  "       Shop, ",                #ohbplant       #所属营运中心
                  "       '",p_azw02,"' ",        #ohblegal       #所属法人
                  "  FROM ",g_posdbs,"tg_SaleCoupon_Detail",g_db_links," ",
                  "       LEFT OUTER JOIN lpx_file ON lpx01 = Giftctf ",
                  "      ,oha_temp ",
                  " WHERE Shop = '",p_azw01,"' AND Cnfflg = 'Y' AND SaleCouponno = oha98 ",
                  " ORDER BY Item "
      LET l_sql = l_ins CLIPPED," ",l_sel CLIPPED
      PREPARE salecoupon_ins_ohb_temp_pre FROM l_sql
      EXECUTE salecoupon_ins_ohb_temp_pre
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Ins'||' '||'Table:ohb_temp'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','06','TG_SALECOUPON',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'tg_SaleCoupon',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF

      #抓取不存在ohb的oha      
      LET l_cnt = 0       
      LET l_sql = "SELECT count(*) FROM oha_temp WHERE oha01 NOT IN (SELECT ohb01 FROM ohb_temp) "
      PREPARE salecoupon_sel_oha01_pre FROM l_sql                                   
      EXECUTE salecoupon_sel_oha01_pre INTO l_cnt                                   
      IF l_cnt > 0 THEN   
         LET g_errno   = 'apc1051' #存在单身无资料的单据                 
         LET g_msg1    = 'Oper:Chk'||' '||'Table:oha_temp'||' '||'Shop:'||p_azw01        
        #CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1) #FUN-CB0103 Mark
         CALL s_errmsg('Batch Operation:','',g_msg1,g_errno,1)       #FUN-CB0103 Add
         ROLLBACK WORK    
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg                  
         LET g_msg   = g_msg[1,255]                                      
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','06','TG_SALECOUPON',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = '' 
         LET g_msg   = '' 
         LET g_msg1  = '' 
      END IF      
                  
      #更新中间库状态为A  
      LET l_upd = "UPDATE ",g_posdbs,"tg_SaleCoupon",g_db_links," ",           
                  "   SET Condition2 = 'A' ",                            
                  " WHERE Shop = '",p_azw01,"' ",                        
                  "   AND EXISTS (SELECT 1 ",
                  "                 FROM oha_temp ",
                  "                WHERE oha01 NOT IN (SELECT ohb01 FROM ohb_temp) ",
                  "                  AND oha98 = SaleCouponno) "
      PREPARE salecoupon_upd_tg_salecoupon_flag_oha_pre3 FROM l_upd
      EXECUTE salecoupon_upd_tg_salecoupon_flag_oha_pre3
      
      #删除不存在ohb的oha
      DELETE FROM oha_temp WHERE oha01 NOT IN (SELECT ohb01 FROM ohb_temp)

      #更新品名规格
      LET l_upd = "UPDATE ohb_temp ",
                  "   SET ohb06 = ",
                  "       (SELECT ima02 FROM ",cl_get_target_table(p_azw01,'ima_file'),
                  "         WHERE ima01 = ohb04) "
      PREPARE salecoupon_upd_ohb06_pre FROM l_upd
      EXECUTE salecoupon_upd_ohb06_pre
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode 
         LET g_msg1    = 'Oper:Upd'||' '||'Table:ohb_temp'||' '||'Field:ohb06'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','06','TG_SALECOUPON',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'tg_SaleCoupon',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF

      #更新库存单位
      LET l_upd = "UPDATE ohb_temp ",
                  "   SET ohb15 = ",
                  "       (SELECT ima25 FROM ",cl_get_target_table(p_azw01,'ima_file'),
                  "         WHERE ima01 = ohb04) "
      PREPARE salecoupon_upd_ohb15_pre FROM l_upd
      EXECUTE salecoupon_upd_ohb15_pre
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode 
         LET g_msg1    = 'Oper:Upd'||' '||'Table:ohb_temp'||' '||'Field:oha15'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','06','TG_SALECOUPON',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'tg_SaleCoupon',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF

     #FUN-D10040 Add Begin ---
      LET l_upd = "UPDATE ohb_temp SET ohb05 = ohb15,ohb916 = ohb15 "
      PREPARE salecoupon_upd_ohb05_pre FROM l_upd
      EXECUTE salecoupon_upd_ohb05_pre
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode 
         LET g_msg1    = 'Oper:Upd'||' '||'Table:ohb_temp'||' '||'Field:ohb05'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','06','TG_SALECOUPON',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'tg_SaleCoupon',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF
     #FUN-D10040 Add End -----

      #更新经营方式
      LET l_upd = "UPDATE ohb_temp ",
                  "   SET ohb64 = ",
                  "       COALESCE((SELECT COALESCE(rty06,'1') FROM ",cl_get_target_table(p_azw01,'rty_file'),
                  "                  WHERE rty01 = '",p_azw01,"' AND rty02 = ohb04),'1') "
      PREPARE salecoupon_upd_ohb64_pre FROM l_upd
      EXECUTE salecoupon_upd_ohb64_pre
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Upd'||' '||'Table:ohb_temp'||' '||'Field:ohb64'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','06','TG_SALECOUPON',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'tg_SaleCoupon',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF

      #更新单位换算率(销售单位<>库存单位)
      LET l_sql = "UPDATE ohb_temp ",
                  "   SET ohb05_fac = ",
                  "       (SELECT smd06/smd04 ",
                  "          FROM ",cl_get_target_table(p_azw01,'smd_file'),
                  "         WHERE smd01 = ohb04 AND smd02 = ohb05 AND smd03 = ohb15)",
                  " WHERE ohb05 <> ohb15 AND ohb05_fac = 0 "
      PREPARE salecoupon_upd_ohb05_fac_pre1 FROM l_sql
      EXECUTE salecoupon_upd_ohb05_fac_pre1

      LET l_sql = "UPDATE ohb_temp ",
                  "   SET ohb05_fac = ",
                  "       (SELECT smd04/smd06 ",
                  "          FROM ",cl_get_target_table(p_azw01,'smd_file'),
                  "         WHERE smd01 = ohb04 AND smd03 = ohb05 AND smd02 = ohb15)",
                  " WHERE ohb05 <> ohb15 AND ohb05_fac = 0 "
      PREPARE salecoupon_upd_ohb05_fac_pre2 FROM l_sql
      EXECUTE salecoupon_upd_ohb05_fac_pre2
      
      LET l_sql = "UPDATE ohb_temp ",
                  "   SET ohb05_fac = ", 
                  "       (SELECT smc03/smc04 ",
                  "          FROM ",cl_get_target_table(p_azw01,'smc_file'),
                  "         WHERE smc01 = ohb05 AND smc02 = ohb15)",
                  " WHERE ohb05 <> ohb15 AND ohb05_fac = 0 "
      PREPARE salecoupon_upd_ohb05_fac_pre3 FROM l_sql
      EXECUTE salecoupon_upd_ohb05_fac_pre3
      
      LET l_sql = "UPDATE ohb_temp SET ohb15_fac = ohb05_fac,ohb16 = ohb16 * ohb15_fac WHERE ohb05 <> ohb15 "
      PREPARE salecoupon_upd_ohb15_fac_pre FROM l_sql
      EXECUTE salecoupon_upd_ohb15_fac_pre

      #更新成本中心         
      LET l_sql = "UPDATE ohb_temp ",
                  "   SET ohb930 = ",
                  "       (SELECT gem10 FROM ",cl_get_target_table(p_azw01,'gem_file'),
                  "         WHERE EXISTS (SELECT 1 FROM oha_temp ",
                  "                        WHERE gem01 = oha15 ",
                  "                          AND oha01 = ohb01)) "
      PREPARE salecoupon_upd_ohb930_pre FROM l_sql
      EXECUTE salecoupon_upd_ohb930_pre

      #更新扣率(经营方式为代销或联营)
      LET l_sql = "UPDATE ohb_temp ",
                  "   SET (ohb65,ohb66) = ",
                  "       (SELECT rtv12,rtv12",
                  "          FROM ",cl_get_target_table(p_azw01,'rtv_file'),",",
                                    cl_get_target_table(p_azw01,'rtu_file'),",",
                                    cl_get_target_table(p_azw01,'rtt_file'),",",
                                    cl_get_target_table(p_azw01,'rty_file'),",oha_temp",
                  "         WHERE rtt01 = rtu04 ",
                  "           AND rtt02 = rtu02 ",
                  "           AND rttplant = rtuplant ",
                  "           AND rtuplant = '",p_azw01,"' ",
                  "           AND rtuconf = 'Y' ",
                  "           AND rtuplant = rtvplant ",
                  "           AND rtu01 = rtv01 ",
                  "           AND rtu02 = rtv02 ",
                  "           AND rty01 = '",p_azw01,"' ",
                  "           AND rty02 = ohb04 AND rtyacti = 'Y'",
                  "           AND rtu09 <= oha02 ",
                  "           AND rtu10 >= oha02 ",
                  "           AND rtu05 = rty05 ",
                  "           AND rtu06 = ohb64 ",
                  "           AND rtv04 = ohb04 ",
                  "           AND oha01 = ohb01 )",
                  " WHERE ohb64 IN ('3','4')"
      PREPARE salecoupon_upd_ohb65_p_pre1 FROM l_sql
      EXECUTE salecoupon_upd_ohb65_p_pre1
      
      LET l_sql = "UPDATE ohb_temp ",
                  "   SET (ohb65,ohb66) = ",
                  "       (SELECT rtt11,rtt11",
                  "          FROM ",cl_get_target_table(p_azw01,'rtt_file'),",",
                                    cl_get_target_table(p_azw01,'rts_file'),",",
                                    cl_get_target_table(p_azw01,'rto_file'),",",
                                    cl_get_target_table(p_azw01,'rty_file'),",oha_temp",
                  "         WHERE rts01 = rtt01 ",
                  "           AND rttplant = rtsplant ",
                  "           AND rts02 = rtt02 ",
                  "           AND rtt04 = ohb04 ",
                  "           AND rto01 = rts04 ",
                  "           AND rtoplant = rtsplant ",
                  "           AND rto05 = rty05 ",
                  "           AND rty01 = '",p_azw01,"' ",
                  "           AND rty02 = ohb04 AND rtyacti = 'Y' ",
                  "           AND rto06 = ohb64 ",
                  "           AND rto08 <= oha02 ",
                  "           AND rto09 >= oha02 ", 
                  "           AND rtt15 = 'Y' ", 
                  "           AND rtoconf = 'Y' ",
                  "           AND rtsconf = 'Y' ",
                  "           AND rto03 = rts02 ",
                  "           AND rtoplant = '",p_azw01,"' ",
                  "           AND oha01 = ohb01 )",
                  " WHERE ohb64 IN ('3','4')",
                  "   AND ohb65 IS NULL "
      PREPARE salecoupon_upd_ohb65_p_pre2 FROM l_sql
      EXECUTE salecoupon_upd_ohb65_p_pre2

      #ins xyz
      CALL p200_cardcoupon_xyz_ins_p("oha_file",p_azw01)
      IF g_success='N' THEN
         ROLLBACK WORK
         CONTINUE WHILE
      END IF
         
      #ins rxc_file 开始
      CALL p200_rxc_ins_p("rxe_file_3",p_azw01,"tg_SaleCoupon_Detail_Agio")
      IF g_success = 'N' THEN
         ROLLBACK WORK 
         CONTINUE WHILE
      END IF
      
      
      #FUN-D20096---Add---Str
      #ins ogj_file
      LET l_ins = " INSERT INTO ogj_temp( ",
                  "        ogj01, ",                     #出貨單號
                  "        ogj02, ",                     #序號
                  "        ogj03, ",                     #稅別
                  "        ogj04, ",                     #稅率
                  "        ogj05, ",                     #固定稅額
                  "        ogj06, ",                     #含稅否
                  "        ogj07, ",                     #未稅金額
                  "        ogj07t, ",                    #含稅金額
                  "        ogj08, ",                     #稅額
                  "        ogj09, ",                     #留抵稅額
                  "        ogjdate, ",                   #最近修改日
                  "        ogjgrup, ",                   #資料所有部門
                  "        ogjlegal, ",                  #所屬法人
                  "        ogjmodu, ",                   #資料修改者
                  "        ogjorig, ",                   #資料建立部門
                  "        ogjoriu, ",                   #資料建立者
                  "        ogjplant, ",                  #所屬營運中心
                  "        ogjuser) "                    #資料所有者

      LET l_sel = "SELECT DISTINCT ",
                  "       oha01, ",                      #ogj01    出貨單號
                  "       Item, ",                       #ogj02    序號
                  "       Taxcode, ",                    #ogj03    稅別
                  "       Taxrate, ",                    #ogj04    稅率
                  "       0, ",                          #ogj05    固定稅額
                  "       Incltax, ",                    #ogj06    含稅否
                  "       Uamt, ",                       #ogj07    未稅金額
                  "       Amt, ",                        #ogj07t   含稅金額
                  "       Tax, ",                        #ogj08    稅額
                  "       acctax, ",                     #ogj09    留抵稅額
                  "       ohadate, ",                    #ogjdate  最近修改日
                  "       ohagrup, ",                    #ogjgrup  資料所有部門
                  "       ohalegal, ",                   #ogjlegal 所屬法人
                  "       ohamodu, ",                    #ogjmodu  資料修改者
                  "       ohaorig, ",                    #ogjorig  資料建立部門
                  "       ohaoriu, ",                    #ogjoriu  資料建立者
                  "       Shop, ",                       #ogjplant 所屬營運中心
                  "       ohauser ",                     #ogjuser  資料所有者
                  "  FROM ",g_posdbs,"tg_SaleCoupon_Tax",g_db_links,",oha_temp ",
                  " WHERE Shop = '",p_azw01,"' ",
                  "   AND SaleCouponNO = oha98 ",
                  " ORDER BY Item "
      LET l_sql = l_ins CLIPPED," ",l_sel CLIPPED
      PREPARE salecoupon_ins_ogj_temp_pre FROM l_sql
      EXECUTE salecoupon_ins_ogj_temp_pre
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Ins'||' '||'Table:ogj_file'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','06','tg_SaleCoupon_Tax',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''  
         LET g_msg   = ''  
         LET g_msg1  = ''  
         CALL p200_upd_posflag_p('2',p_gat01,'tg_SaleCoupon_Tax',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF

      #ins ogk_file
      LET l_ins = " INSERT INTO ogk_temp( ",
                  "        ogk01, ",                     #出貨單號
                  "        ogk02, ",                     #項次
                  "        ogk03, ",                     #序號
                  "        ogk04, ",                     #稅別
                  "        ogk05, ",                     #稅率
                  "        ogk06, ",                     #固定稅額
                  "        ogk07, ",                     #含稅否
                  "        ogk08, ",                     #未稅金額
                  "        ogk08t, ",                    #含稅金額
                  "        ogk09, ",                     #稅額
                  "        ogkdate, ",                   #最近修改日
                  "        ogkgrup, ",                   #資料所有部門
                  "        ogklegal, ",                  #所屬法人
                  "        ogkmodu, ",                   #資料修改者
                  "        ogkorig, ",                   #資料建立部門
                  "        ogkoriu, ",                   #資料建立者
                  "        ogkplant, ",                  #所屬營運中心
                  "        ogkuser) "                    #資料所有者

      LET l_sel = "SELECT DISTINCT ",
                  "       oha01, ",                      #ogk01    出貨單號
                  "       Mitem, ",                      #ogk02    項次
                  "       Item, ",                       #ogk03    序號
                  "       Taxcode, ",                    #ogk04    稅別
                  "       Taxrate, ",                    #ogk05    稅率
                  "       0, ",                          #ogk06    固定稅額
                  "       Incltax, ",                    #ogk07    含稅否
                  "       Uamt, ",                       #ogk08    未稅金額
                  "       Amt, ",                        #ogk08t   含稅金額
                  "       Tax, ",                        #ogk09    稅額
                  "       ohadate, ",                    #ogkdate  最近修改日
                  "       ohagrup, ",                    #ogkgrup  資料所有部門
                  "       ohalegal, ",                   #ogklegal 所屬法人
                  "       ohamodu, ",                    #ogkmodu  資料修改者
                  "       ohaorig, ",                    #ogkorig  資料建立部門
                  "       ohaoriu, ",                    #ogkoriu  資料建立者
                  "       Shop, ",                       #ogkplant 所屬營運中心
                  "       ohauser ",                     #ogkuser  資料所有者
                  "  FROM ",g_posdbs,"tg_SaleCoupon_Detail_Tax",g_db_links,",oha_temp ",
                  " WHERE Shop = '",p_azw01,"' ",
                  "   AND SaleCouponNO = oha98 ",
                  " ORDER BY Mitem,Item "
      LET l_sql = l_ins CLIPPED," ",l_sel CLIPPED
      PREPARE salecoupon_ins_ogk_temp_pre FROM l_sql
      EXECUTE salecoupon_ins_ogk_temp_pre
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Ins'||' '||'Table:ogk_file'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','06','tg_SaleCoupon_Detail_Tax',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'tg_SaleCoupon_Detail_Tax',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF
      #FUN-D20096---Add---End      

      #更新庫存   
      IF g_success = 'Y' THEN
         CALL s_upimg_p('2','',p_azw01,'')
         IF g_success = 'N' THEN
           #FUN-CB0103 Add Begin ---
            ROLLBACK WORK
            CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
            LET g_msg   = g_msg[1,255]
            CALL p200_log(g_trans_no,p_azw01,'Batch Operation','06','tg_SaleCoupon_Detail',g_errno,g_msg,'0','N',g_msg1)
            LET g_errno = ''
            LET g_msg   = ''
            LET g_msg1  = ''
            CALL p200_upd_posflag_p('2',p_gat01,'tg_SaleCoupon',p_azw01) #将对应中间库的资料Condition2更新为A
           #FUN-CB0103 Add End -----
            CONTINUE WHILE
         END IF   
         CALL s_instlf_p('2','',p_azw01)
         IF g_success = 'N' THEN
           #FUN-CB0103 Add Begin ---
            ROLLBACK WORK
            CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
            LET g_msg   = g_msg[1,255]
            CALL p200_log(g_trans_no,p_azw01,'Batch Operation','06','tg_SaleCoupon_Detail',g_errno,g_msg,'0','N',g_msg1)
            LET g_errno = ''
            LET g_msg   = ''
            LET g_msg1  = ''
            CALL p200_upd_posflag_p('2',p_gat01,'tg_SaleCoupon',p_azw01) #将对应中间库的资料Condition2更新为A
           #FUN-CB0103 Add End -----
            CONTINUE WHILE
         END IF
      END IF
      
      #ins rxe_temp
      LET l_ins = "INSERT INTO rxe_temp( ",
                  "                     rxe00, ",       #單據別
                  "                     rxe01, ",       #單號
                  "                     rxe02, ",       #項次
                  "                     rxe03, ",       #序
                  "                     rxe04, ",       #券起始編號
                  "                     rxe05, ",       #券結束編號
                  "                     rxe06, ",       #券種編號
                  "                     rxe07, ",       #券面額編號
                  "                     rxe08, ",       #券張數
                  "                     rxe09, ",       #總金額
                  "                     rxelegal, ",    #所屬法人
                  "                     rxeplant) "     #所屬營運中心
      LET l_sel = "SELECT ",
                  "       '03', ",                                #rxe00       #單據別
                  "       oha01, ",                               #rxe01       #單號
                  "       Item, ",                                #rxe02       #項次
                  "       ROW_NUMBER() over(partition by oha01 order by oha01), ",   #rxe03       #序號
                  "       BeginCoupon, ",                         #rxe04       #券起始編號
                  "       EndCoupon, ",                           #rxe05       #券結束編號
                  "       Giftctf, ",                             #rxe06       #券種編號
                  "       lqe03, ",                               #rxe07       #券面額編號
                  "       Qty, ",                                 #rxe08       #券張數
                  "       CouponAmt*Qty, ",                       #rxe09       #總金額
                  "       '",p_azw02,"', ",                       #rxelegal    #所屬法人
                  "       Shop ",                                 #rxeplant    #所屬營運中心
                  "  FROM ",g_posdbs,"tg_SaleCoupon_Detail",g_db_links," ",
                  "       LEFT OUTER JOIN lqe_file ON lqe01 = BeginCoupon ",
                  "      ,oha_temp ",
                  " WHERE Shop = '",p_azw01,"' AND Cnfflg = 'Y' AND SaleCouponno = oha98 ",
                  " ORDER BY Item "
      LET l_sql = l_ins CLIPPED," ",l_sel CLIPPED
      PREPARE salecoupon_ins_rxe_temp_oha_pre FROM l_sql
      EXECUTE salecoupon_ins_rxe_temp_oha_pre
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Ins'||' '||'Table:rxe_temp'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','06','tg_SaleCoupon_Detail',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'tg_SaleCoupon',p_azw01) #将对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF
      
      #将临时表oha_temp插入到数据库中
      LET l_ins = " INSERT INTO ",cl_get_target_table(p_azw01,'oha_file'),
                  " SELECT * FROM oha_temp " 
      CALL cl_replace_sqldb(l_ins) RETURNING l_ins
      CALL cl_parse_qry_sql(l_ins,p_azw01) RETURNING l_ins
      PREPARE salecoupon_ins_oha_pre FROM l_ins
      EXECUTE salecoupon_ins_oha_pre
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Ins'||' '||'Table:oha_file'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','06','TG_SALECOUPON',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''  
         LET g_msg   = ''  
         LET g_msg1  = ''  
         CALL p200_upd_posflag_p('2',p_gat01,'tg_SaleCoupon',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF
      
      #将临时表ohb_temp插入到数据库中
      LET l_ins = " INSERT INTO ",cl_get_target_table(p_azw01,'ohb_file'),
                  " SELECT * FROM ohb_temp "
      CALL cl_replace_sqldb(l_ins) RETURNING l_ins
      CALL cl_parse_qry_sql(l_ins,p_azw01) RETURNING l_ins
      PREPARE salecoupon_ins_ohb_pre FROM l_ins
      EXECUTE salecoupon_ins_ohb_pre
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Ins'||' '||'Table:ohb_file'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','06','TG_SALECOUPON',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'tg_SaleCoupon',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF

      #FUN-D20096-----Add-----Str
      #将临时表ogj_temp插入到数据库中
      LET l_ins = " INSERT INTO ",cl_get_target_table(p_azw01,'ogj_file'),
                  " SELECT * FROM ogj_temp "
      CALL cl_replace_sqldb(l_ins) RETURNING l_ins
      CALL cl_parse_qry_sql(l_ins,p_azw01) RETURNING l_ins
      PREPARE salecoupon_ins_ogj_pre FROM l_ins
      EXECUTE salecoupon_ins_ogj_pre
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Ins'||' '||'Table:ogj_file'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','06','tg_SaleCoupon_Tax',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'tg_SaleCoupon_Tax',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF

      #将临时表ogk_temp插入到数据库中
      LET l_ins = " INSERT INTO ",cl_get_target_table(p_azw01,'ogk_file'),
                  " SELECT * FROM ogk_temp "
      CALL cl_replace_sqldb(l_ins) RETURNING l_ins
      CALL cl_parse_qry_sql(l_ins,p_azw01) RETURNING l_ins
      PREPARE salecoupon_ins_ogk_pre FROM l_ins
      EXECUTE salecoupon_ins_ogk_pre
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Ins'||' '||'Table:ogk_file'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','06','tg_SaleCoupon_Detail_Tax',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'tg_SaleCoupon_Detail_Tax',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF

      #FUN-D20096-----Add-----End      

      #将临时表rxe_temp插入到数据库中
      LET l_ins = " INSERT INTO ",cl_get_target_table(p_azw01,'rxe_file'),
                  " SELECT * FROM rxe_temp "
      CALL cl_replace_sqldb(l_ins) RETURNING l_ins
      CALL cl_parse_qry_sql(l_ins,p_azw01) RETURNING l_ins
      PREPARE salecoupon_ins_rxe_oha_pre FROM l_ins
      EXECUTE salecoupon_ins_rxe_oha_pre
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Ins'||' '||'Table:rxe_file'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','06','TG_SALECOUPON',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'tg_SaleCoupon',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF

      #将临时表rxx_temp插入到数据库中
      LET l_ins = " INSERT INTO ",cl_get_target_table(p_azw01,'rxx_file'),
                  " SELECT * FROM rxx_temp "
      CALL cl_replace_sqldb(l_ins) RETURNING l_ins
      CALL cl_parse_qry_sql(l_ins,p_azw01) RETURNING l_ins
      PREPARE salecoupon_ins_rxx_oha_pre FROM l_ins
      EXECUTE salecoupon_ins_rxx_oha_pre
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Ins'||' '||'Table:rxx_file'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','06','TG_SALECOUPON',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'tg_SaleCoupon',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF
      
      #将临时表rxy_temp插入到数据库中
      LET l_ins = " INSERT INTO ",cl_get_target_table(p_azw01,'rxy_file'),
                  " SELECT * FROM rxy_temp "
      CALL cl_replace_sqldb(l_ins) RETURNING l_ins
      CALL cl_parse_qry_sql(l_ins,p_azw01) RETURNING l_ins
      PREPARE salecoupon_ins_rxy_oha_pre FROM l_ins
      EXECUTE salecoupon_ins_rxy_oha_pre
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Ins'||' '||'Table:rxy_file'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','06','TG_SALECOUPON',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'tg_SaleCoupon',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF

      #将临时表rxz_temp插入到数据库中
      LET l_ins = " INSERT INTO ",cl_get_target_table(p_azw01,'rxz_file'),
                  " SELECT * FROM rxz_temp "
      CALL cl_replace_sqldb(l_ins) RETURNING l_ins
      CALL cl_parse_qry_sql(l_ins,p_azw01) RETURNING l_ins
      PREPARE salecoupon_ins_rxz_oha_pre FROM l_ins
      EXECUTE salecoupon_ins_rxz_oha_pre
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Ins'||' '||'Table:rxz_file'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','06','TG_SALECOUPON',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'tg_SaleCoupon',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF
      
      #更新中间库标志位
      CALL p200_upd_posflag_p("1","rxe_file_3","tg_SaleCoupon",p_azw01)
      IF g_success = 'N' THEN
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Upd'||' '||'Table:tg_SaleCoupon'||' '||'Field:Condition2'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','06','TG_SALECOUPON',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,'tg_SaleCoupon',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
         CONTINUE WHILE
      END IF
      
      IF g_success = 'Y' THEN
         LET g_sucflag = 1
         COMMIT WORK
      ELSE
         ROLLBACK WORK
      END IF
   END WHILE
   #删除建立的临时表
   DROP TABLE oha_temp
   DROP TABLE ohb_temp
   DROP TABLE ogj_temp   #FUN-D20096 Add
   DROP TABLE ogk_temp   #FUN-D20096 Add
   DROP TABLE rxe_temp
   DROP TABLE rxx_temp
   DROP TABLE rxy_temp
   DROP TABLE rxz_temp
END FUNCTION
#FUN-CA0160 Add End -----

#FUN-CA0160 Add Begin ---

# Descriptions...: 发卡/储值/换卡 产生出货单
# Input Parameter: p_flag:   标志位(1-发卡 2-储值 3-换卡)
#                  p_azw01:  营运中心
# Usage..........: CALL p200_prod_oga_p('1',p_azw01)

FUNCTION p200_prod_oga_p(p_flag,p_azw01)
DEFINE p_flag      LIKE type_file.chr1
DEFINE p_azw01     LIKE azw_file.azw01
DEFINE p_gat01     LIKE gat_file.gat01
DEFINE l_ryl05     LIKE ryl_file.ryl05
DEFINE l_ins       STRING
DEFINE l_upd       STRING
DEFINE l_sql       STRING
DEFINE l_sel       STRING
DEFINE l_sel1      STRING
DEFINE l_sel2      STRING
DEFINE l_oga02     LIKE oga_file.oga02
DEFINE l_oga23     LIKE oga_file.oga23
DEFINE l_oga24     LIKE oga_file.oga24
DEFINE l_ogb09     LIKE ogb_file.ogb09
DEFINE l_field     RECORD
       oga01       LIKE type_file.chr100,  #出貨單號      
       oga02       LIKE type_file.chr100,  #單據日期      
       oga14       LIKE type_file.chr100,  #業務人員      
       oga15       LIKE type_file.chr100,  #業務部門      
       oga69       LIKE type_file.chr100,  #輸入日期      
       oga83       LIKE type_file.chr100,  #銷貨營運中心  
       oga84       LIKE type_file.chr100,  #取貨營運中心  
       ogaconu     LIKE type_file.chr100,  #審核人
       ogacond     LIKE type_file.chr100,  #審核日期      
       ogagrup     LIKE type_file.chr100,  #資料所有部門  
       ogalegal    LIKE type_file.chr100,  #所屬法人      
       ogaoriu     LIKE type_file.chr100,  #資料建立者    
       ogaorig     LIKE type_file.chr100,  #資料建立部門  
       ogaplant    LIKE type_file.chr100,  #所屬營運中心  
       ogauser     LIKE type_file.chr100,  #資料所有者
       ogb01       LIKE type_file.chr100,  #出貨單號
       ogb03       LIKE type_file.chr100,  #項次
       ogb08       LIKE type_file.chr100,  #出貨營運中心編號
       ogb13       LIKE type_file.chr100,  #原幣單價
       ogb14       LIKE type_file.chr100,  #原幣未稅金額
       ogb14t      LIKE type_file.chr100,  #原幣含稅金額
       ogb37       LIKE type_file.chr100,  #基礎單價
       ogb47       LIKE type_file.chr100,  #分攤折價
       ogb1001     LIKE type_file.chr100,  #理由碼
       ogbplant    LIKE type_file.chr100,  #所屬營運中心
       ogblegal    LIKE type_file.chr100,  #所屬法人
       rxy01       LIKE type_file.chr100,  #單號
       rxx01       LIKE type_file.chr100,  #單號
       rxz01       LIKE type_file.chr100,  #單號
       rxc01       LIKE type_file.chr100,  #單號
       rxc02       LIKE type_file.chr100,  #項次
       rxc06       LIKE type_file.chr100,  #折價金額
       rxc11       LIKE type_file.chr100,  #是否會員
       rxcplant    LIKE type_file.chr100,  #所屬法人
       rxclegal    LIKE type_file.chr100   #所屬營運中心
                   END RECORD 
DEFINE l_oga_from  STRING
DEFINE l_oga_where STRING
DEFINE l_ogb_from  STRING
DEFINE l_ogb_where STRING
DEFINE l_rxx_from  STRING
DEFINE l_rxx_where STRING
DEFINE l_rxy_from  STRING
DEFINE l_rxy_where STRING
DEFINE l_rxz_from  STRING
DEFINE l_rxz_where STRING
DEFINE l_rxc_from  STRING
DEFINE l_rxc_where STRING
DEFINE l_tablename  STRING     #FUN-D20096 Add
DEFINE l_tablename1 STRING     #FUN-D20096 Add 
DEFINE l_tablename2 STRING     #FUN-D20096 Add 
DEFINE l_ogh_where  STRING     #FUN-D20096 Add

   IF cl_null(p_flag) THEN RETURN END IF 
   IF cl_null(p_azw01) THEN LET p_azw01 = g_plant END IF 

   CASE p_flag
      WHEN '1' #发卡
         LET p_gat01          = "lps_file"
         LET l_ryl05          = "tg_SaleCard"
         LET l_field.oga01    = "lps17"                                                                  #出貨單號
         LET l_field.oga02    = "lps03"                                                                  #單據日期
         LET l_field.oga14    = "lpsuser"                                                                #業務人員
         LET l_field.oga15    = "lpsgrup"                                                                #業務部門
         LET l_field.oga69    = "lps03"                                                                  #輸入日期
         LET l_field.oga83    = "lpsplant"                                                               #銷貨營運中心
         LET l_field.oga84    = "lpsplant"                                                               #取貨營運中心
         LET l_field.ogaconu  = "lps10"                                                                  #審核人
         LET l_field.ogacond  = "lps03"                                                                  #審核日期
         LET l_field.ogagrup  = "lpsgrup"                                                                #資料所有部門
         LET l_field.ogalegal = "lpslegal"                                                               #所屬法人
         LET l_field.ogaoriu  = "lpsuser"                                                                #資料建立者
         LET l_field.ogaorig  = "lpsgrup"                                                                #資料建立部門
         LET l_field.ogaplant = "lpsplant"                                                               #所屬營運中心
         LET l_field.ogauser  = "lpsuser"                                                                #資料所有者
         LET l_oga_from       = "  FROM lps_temp LEFT OUTER JOIN ",cl_get_target_table(p_azw01,'rtz_file'),
                                "                             ON rtz01 = lpsplant ",
                                "                LEFT OUTER JOIN ",cl_get_target_table(p_azw01,'occ_file'),
                                "                             ON occ01 = rtz06 ",
                                "                LEFT OUTER JOIN ",cl_get_target_table(p_azw01,'gec_file'),
                                "                             ON gec01 = occ41 AND gec011 = '2' "
         LET l_oga_where      = " "
         LET l_field.ogb01    = "lps17"                                                                  #出貨單號
         LET l_field.ogb03    = "ROW_NUMBER() over(partition by lps17 order by lps17)"                   #項次
         LET l_field.ogb08    = "lpsplant"                                                               #出貨營運中心編號
         LET l_field.ogb13    = "lpt08"                                                                  #原幣單價
        #FUN-CB0103 Mark&Add Begin ---
        #LET l_field.ogb14    = "CASE gec07 WHEN 'Y' THEN lpt08/(1+gec04/100) WHEN 'N' THEN lpt08 END"   #原幣未稅金額
        #LET l_field.ogb14t   = "CASE gec07 WHEN 'Y' THEN lpt08 WHEN 'N' THEN lpt08*(1+gec04/100) END"   #原幣含稅金額
        #LET l_field.ogb14    = "ROUND(lpt08/(1+gec04/100),",g_azi04,")"                                 #原幣未稅金額    #FUN-D20096 Mark
         LET l_field.ogb14    = "Uamt"                                                                   #原幣未稅金額    #FUN-D20096 Add
         LET l_field.ogb14t   = "lpt08"                                                                  #原幣含稅金額
        #FUN-CB0103 Mark&Add Begin ---
         LET l_field.ogb37    = "lpt08"                                                                  #基礎單價
         LET l_field.ogb47    = "0"                                                                      #分攤折價
         LET l_field.ogb1001  = g_rcj05                                                                  #理由碼
         LET l_field.ogbplant = "lpsplant"                                                               #所屬營運中心
         LET l_field.ogblegal = "lpslegal"                                                               #所屬法人
         LET l_ogb_from       = "  FROM lps_temp LEFT OUTER JOIN ",cl_get_target_table(p_azw01,'rtz_file'),  
                                "                             ON rtz01 = lpsplant ",                     
                                "                LEFT OUTER JOIN ",cl_get_target_table(p_azw01,'occ_file'), 
                                "                             ON occ01 = rtz06 ",                        
                                "                LEFT OUTER JOIN ",cl_get_target_table(p_azw01,'gec_file'), 
                                "                             ON gec01 = occ41 AND gec011 = '2' ",       
                                "                LEFT OUTER JOIN ",g_posdbs,"tg_SaleCard_Detail_Tax",g_db_links,          #FUN-D20096 Add
                                "                             ON Shop = lpsplant AND Item = '1' AND lps18 = SaleCardNO ", #FUN-D20096 Add
                                "      ,lpt_temp "
         LET l_ogb_where      = " WHERE lps01 = lpt01 AND lpt08 >= 0 "
         LET l_field.rxy01    = "lps17"
         LET l_rxy_from       = "  FROM rxy_temp,lps_temp "
         LET l_rxy_where      = " WHERE rxy01 = lps01 "
         LET l_field.rxx01    = "lps17"
         LET l_rxx_from       = "  FROM rxx_temp,lps_temp "
         LET l_rxx_where      = " WHERE rxx01 = lps01 "
         LET l_field.rxz01    = "lps17"
         LET l_rxz_from       = "  FROM rxz_temp,lps_temp "
         LET l_rxz_where      = " WHERE rxz01 = lps01 "
         LET l_field.rxc01    = "ogb01"
         LET l_field.rxc02    = "ogb03"
         LET l_field.rxc06    = "lpt12"
         LET l_field.rxc11    = "CASE WHEN lpt15 IS NOT NULL THEN 'Y' ELSE 'N' END"
         LET l_field.rxclegal = "lptlegal"
         LET l_field.rxcplant = "lptplant"
         LET l_rxc_from       = "  FROM ogb_temp,lps_temp,lpt_temp "
         LET l_rxc_where      = " WHERE ogb01 = lps17 AND lps01 = lpt01 AND ogb47 > 0 AND lpt12 > 0 "
      WHEN '2' #储值
         LET p_gat01          = "lpu_file"
         LET l_ryl05          = "tg_Recharge"
         LET l_field.oga01    = "lpu16"                                                                  #出貨單號
         LET l_field.oga02    = "lpu10"                                                                  #單據日期
         LET l_field.oga14    = "lpuuser"                                                                #業務人員
         LET l_field.oga15    = "lpugrup"                                                                #業務部門
         LET l_field.oga69    = "lpu10"                                                                  #輸入日期
         LET l_field.oga83    = "lpuplant"                                                               #銷貨營運中心
         LET l_field.oga84    = "lpuplant"                                                               #取貨營運中心
         LET l_field.ogaconu  = "lpu09"                                                                  #審核人
         LET l_field.ogacond  = "lpu10"                                                                  #審核日期
         LET l_field.ogagrup  = "lpugrup"                                                                #資料所有部門
         LET l_field.ogalegal = "lpulegal"                                                               #所屬法人
         LET l_field.ogaoriu  = "lpuuser"                                                                #資料建立者
         LET l_field.ogaorig  = "lpugrup"                                                                #資料建立部門
         LET l_field.ogaplant = "lpuplant"                                                               #所屬營運中心
         LET l_field.ogauser  = "lpuuser"                                                                #資料所有者
         LET l_field.ogb01    = "lpu16"                                                                  #出貨單號
         LET l_field.ogb03    = "ROW_NUMBER() over(partition by lpu16 order by lpu16)"                   #項次
         LET l_field.ogb08    = "lpuplant"                                                               #出貨營運中心編號
         LET l_field.ogb13    = "lpu06"                                                                  #原幣單價
        #LET l_field.ogb14    = "lpu06"                                                                  #原幣未稅金額    #FUN-D20096 Mark
         LET l_field.ogb14    = "Uamt"                                                                   #原幣未稅金額    #FUN-D20096 Add
         LET l_field.ogb14t   = "lpu06"                                                                  #原幣含稅金額
         LET l_field.ogb37    = "lpu06+lpu07"                                                            #基礎單價
         LET l_field.ogb47    = "lpu07"                                                                  #分攤折價
         LET l_field.ogb1001  = g_rcj06
         LET l_field.ogbplant = "lpuplant"                                                               #所屬營運中心
         LET l_field.ogblegal = "lpulegal"                                                               #所屬法人
         LET l_oga_from       = "  FROM lpu_temp LEFT OUTER JOIN ",cl_get_target_table(p_azw01,'rtz_file'),
                                "                             ON rtz01 = lpuplant ",
                                "                LEFT OUTER JOIN ",cl_get_target_table(p_azw01,'occ_file'),
                                "                             ON occ01 = rtz06 ",
                                "                LEFT OUTER JOIN ",cl_get_target_table(p_azw01,'gec_file'),
                                "                             ON gec01 = occ41 AND gec011 = '2' "
         LET l_oga_where      = " "
         LET l_ogb_from       = "  FROM lpu_temp LEFT OUTER JOIN ",cl_get_target_table(p_azw01,'rtz_file'),
                                "                             ON rtz01 = lpuplant ",
                                "                LEFT OUTER JOIN ",cl_get_target_table(p_azw01,'occ_file'),
                                "                             ON occ01 = rtz06 ",
                                "                LEFT OUTER JOIN ",cl_get_target_table(p_azw01,'gec_file'),
                                "                             ON gec01 = occ41 AND gec011 = '2' ",                        #FUN-D20096 Add ,
                                "                LEFT OUTER JOIN ",g_posdbs,"tg_Recharge_TaxDetail",g_db_links,           #FUN-D20096 Add
                                "                             ON Shop = lpuplant  AND lpu17 = RechargeNO "                #FUN-D20096 Add
         LET l_ogb_where      = " "
         LET l_field.rxy01    = "lpu16"
         LET l_rxy_from       = "  FROM rxy_temp,lpu_temp "
         LET l_rxy_where      = " WHERE rxy01 = lpu01 "
         LET l_field.rxx01    = "lpu16"
         LET l_rxx_from       = "  FROM rxx_temp,lpu_temp "
         LET l_rxx_where      = " WHERE rxx01 = lpu01 "
         LET l_field.rxz01    = "lpu16"
         LET l_rxz_from       = "  FROM rxz_temp,lpu_temp "
         LET l_rxz_where      = " WHERE rxz01 = lpu01 "
         LET l_field.rxc01    = "ogb01"
         LET l_field.rxc02    = "ogb03"
         LET l_field.rxc06    = "lpu07"
         LET l_field.rxc11    = "'N'"
         LET l_field.rxclegal = "lpulegal"
         LET l_field.rxcplant = "lpuplant"
         LET l_rxc_from       = "  FROM ogb_temp,lpu_temp "
         LET l_rxc_where      = " WHERE ogb01 = lpu16 AND lpu07 > 0 "
      WHEN '3' #换卡
         LET p_gat01          = "lrw_file"
         LET l_ryl05          = "tg_ChangeCard"
         LET l_field.oga01    = "lrw24"                                                                  #出貨單號
         LET l_field.oga02    = "lrw15"                                                                  #單據日期
         LET l_field.oga14    = "lrwuser"                                                                #業務人員
         LET l_field.oga15    = "lrwgrup"                                                                #業務部門
         LET l_field.oga69    = "lrw15"                                                                  #輸入日期
         LET l_field.oga83    = "lrwplant"                                                               #銷貨營運中心
         LET l_field.oga84    = "lrwplant"                                                               #取貨營運中心
         LET l_field.ogaconu  = "lrw17"                                                                  #審核人
         LET l_field.ogacond  = "lrw15"                                                                  #審核日期
         LET l_field.ogagrup  = "lrwgrup"                                                                #資料所有部門
         LET l_field.ogalegal = "lrwlegal"                                                               #所屬法人
         LET l_field.ogaoriu  = "lrwuser"                                                                #資料建立者
         LET l_field.ogaorig  = "lrwgrup"                                                                #資料建立部門
         LET l_field.ogaplant = "lrwplant"                                                               #所屬營運中心
         LET l_field.ogauser  = "lrwuser"                                                                #資料所有者
         LET l_field.ogb01    = "lrw24"                                                                  #出貨單號
         LET l_field.ogb03    = "ROW_NUMBER() over(partition by lrw24 order by lrw24)"                   #項次
         LET l_field.ogb08    = "lrwplant"                                                               #出貨營運中心編號
         LET l_field.ogb13    = "lrw23"                                                                  #原幣單價
        #FUN-CB0103 Mark&Add Begin ---
        #LET l_field.ogb14    = "CASE gec07 WHEN 'Y' THEN lrw23/(1+gec04/100) WHEN 'N' THEN lrw23 END"   #原幣未稅金額
        #LET l_field.ogb14t   = "CASE gec07 WHEN 'Y' THEN lrw23 WHEN 'N' THEN lrw23*(1+gec04/100) END"   #原幣含稅金額
        #LET l_field.ogb14    = "ROUND(lrw23/(1+gec04/100),",g_azi04,")"                                 #原幣未稅金額    #FUN-D20096 Mark
         LET l_field.ogb14    = "Uamt"                                                                   #原幣未稅金額    #FUN-D20096 Add
         LET l_field.ogb14t   = "lrw23"                                                                  #原幣含稅金額
        #FUN-CB0103 Mark&Add Begin ---
         LET l_field.ogb37    = "lrw23"                                                                  #基礎單價
         LET l_field.ogb47    = "0"                                                                      #分攤折價
         LET l_field.ogb1001  = g_rcj08
         LET l_field.ogbplant = "lrwplant"                                                               #所屬營運中心
         LET l_field.ogblegal = "lrwlegal"                                                               #所屬法人
         LET l_oga_from       = "  FROM lrw_temp LEFT OUTER JOIN ",cl_get_target_table(p_azw01,'rtz_file'),
                                "                             ON rtz01 = lrwplant ",
                                "                LEFT OUTER JOIN ",cl_get_target_table(p_azw01,'occ_file'),
                                "                             ON occ01 = rtz06 ",
                                "                LEFT OUTER JOIN ",cl_get_target_table(p_azw01,'gec_file'),
                                "                             ON gec01 = occ41 AND gec011 = '2' "
         LET l_oga_where      = " "
         LET l_ogb_from       = "  FROM lrw_temp LEFT OUTER JOIN ",cl_get_target_table(p_azw01,'rtz_file'),
                                "                             ON rtz01 = lrwplant ",
                                "                LEFT OUTER JOIN ",cl_get_target_table(p_azw01,'occ_file'),
                                "                             ON occ01 = rtz06 ",
                                "                LEFT OUTER JOIN ",cl_get_target_table(p_azw01,'gec_file'),
                                "                             ON gec01 = occ41 AND gec011 = '2' ",                        #FUN-D20096 Add ,
                                "                LEFT OUTER JOIN ",g_posdbs,"tg_ChangeCard_TaxDetail",g_db_links,         #FUN-D20096 Add
                                "                             ON Shop = lrwplant  AND lrw25 = ChangeCardNO "              #FUN-D20096 Add
         LET l_ogb_where      = " "
         LET l_field.rxy01    = "lrw24"
         LET l_rxy_from       = "  FROM rxy_temp,lrw_temp "
         LET l_rxy_where      = " WHERE rxy01 = lrw01 "
         LET l_field.rxx01    = "lrw24"
         LET l_rxx_from       = "  FROM rxx_temp,lrw_temp "
         LET l_rxx_where      = " WHERE rxx01 = lrw01 "
         LET l_field.rxz01    = "lrw24"
         LET l_rxz_from       = "  FROM rxz_temp,lrw_temp "
         LET l_rxz_where      = " WHERE rxz01 = lrw01 "
   END CASE 

   LET l_ins = "INSERT INTO oga_temp( ",
               "                     oga00, ",        #出貨別
               "                     oga01, ",        #出貨單號
               "                     oga02, ",        #出貨日期
               "                     oga03, ",        #账款客户编号
               "                     oga032, ",       #账款客户简称
               "                     oga04, ",        #送货客户编号
               "                     oga06, ",        #修改版本
               "                     oga07, ",        #出貨是否計入未開發票的銷貨待驗收入
               "                     oga08, ",        #1.內銷 2.外銷  3.視同外銷
               "                     oga09, ",        #單據別
               "                     oga14, ",        #業務人員
               "                     oga15, ",        #業務部門
               "                     oga161, ",       #訂金應收比率
               "                     oga162, ",       #出貨應收比率
               "                     oga163, ",       #尾款應收比率
               "                     oga18, ",        #收款客户编号
               "                     oga21, ",        #税种
               "                     oga211, ",       #税率
               "                     oga212, ",       #联数
               "                     oga213, ",       #含税否
               "                     oga23, ",        #币种
               "                     oga24, ",        #汇率
               "                     oga25, ",        #销售分类一
               "                     oga30, ",        #包裝單確認碼
               "                     oga31, ",        #价格条件编号
               "                     oga32, ",        #收款条件编号
               "                     oga50, ",        #原币出货金额
               "                     oga51, ",        #原币出货金额
               "                     oga52, ",        #原幣預收訂金轉銷貨收入金額
               "                     oga53, ",        #原幣應開發票未稅金額
               "                     oga54, ",        #原幣已開發票未稅金額
               "                     oga55, ",        #狀況碼
               "                     oga57, ",        #發票性質
               "                     oga65, ",        #客戶出貨簽收否
               "                     oga69, ",        #輸入日期
               "                     oga83, ",        #銷貨營運中心
               "                     oga84, ",        #取貨營運中心
               "                     oga85, ",        #結算方式
               "                     oga903, ",       #信用查核放行否
               "                     oga94, ",        #POS銷售否 Y-是,N-否
               "                     oga95, ",        #本次積分
               "                     oga1014, ",      #调货销退单所自动产生否
               "                     ogaconu, ",      #審核人
               "                     ogacond, ",      #審核日期
               "                     ogaconf, ",      #確認否/作廢碼
               "                     ogagrup, ",      #資料所有部門
               "                     ogalegal, ",     #所屬法人
               "                     ogaorig, ",      #資料建立部門
               "                     ogaoriu, ",      #資料建立者
               "                     ogaplant, ",     #所屬營運中心
               "                     ogapost, ",      #出貨扣帳否 
               "                     ogaprsw, ",      #列印次數
               "                     ogauser, ",      #資料所有者
               "                     ogamksg, ",      #签核
               "                     ogaslk02) "      #出货类型（现货，期货）

   LET l_sel = "SELECT ",
               "       '1', ",                   #oga00       #出貨別
               "       ",l_field.oga01,", ",     #oga01       #出货单号
               "       ",l_field.oga02,", ",     #oga02       #出貨日期
               "       rtz06, ",                 #oga03       #账款客户编号
               "       occ02, ",                 #oga032      #账款客户简称
               "       rtz06, ",                 #oga04       #送货客户编号
               "       '0', ",                   #oga06       #修改版本
               "       'N', ",                   #oga07       #出貨是否計入未開發票的銷貨待驗收入
               "       '1', ",                   #oga08       #1.內銷 2.外銷  3.視同外銷
               "       '2', ",                   #oga09       #單據別
               "       ",l_field.oga14,", ",     #oga14       #業務人員
               "       ",l_field.oga15,", ",     #oga15       #業務部門
               "       0, ",                     #oga161      #訂金應收比率
               "       100, ",                   #oga162      #出貨應收比率
               "       0, ",                     #oga163      #尾款應收比率
               "       rtz06, ",                 #oga18       #收款客户编号
               "       occ41, ",                 #oga21       #税种        
               "       gec04, ",                 #oga211      #税率        
               "       gec05, ",                 #oga212      #联数        
               "       gec07, ",                 #oga213      #含税否      
               "       occ42, ",                 #oga23       #币种        
               "       NULL, ",                  #oga24       #汇率        
               "       occ43, ",                 #oga25       #销售分类一  
               "       'N', ",                   #oga30       #包裝單確認碼包裝單確認碼
               "       occ44, ",                 #oga31       #价格条件编号
               "       occ45, ",                 #oga32       #收款条件编号
               "       0, ",                     #oga50       #原币出货金额
               "       0, ",                     #oga51       #原币出货金额
               "       0, ",                     #oga52       #原幣預收訂金轉銷貨收入金額
               "       0, ",                     #oga53       #原幣應開發票未稅金額
               "       0, ",                     #oga54       #原幣已開發票未稅金額
               "       '1', ",                   #oga55       #狀況碼
               "       '1', ",                   #oga57       #發票性質
               "       'N', ",                   #oga65       #客戶出貨簽收否
               "       ",l_field.oga69,", ",     #oga69       #輸入日期
               "       ",l_field.oga83,", ",     #oga83       #銷貨營運中心
               "       ",l_field.oga84,", ",     #oga84       #取貨營運中心
               "       '1', ",                   #oga85       #結算方式
               "       'N', ",                   #oga903      #信用查核放行否
               "       'Y', ",                   #oga94       #POS銷售否 Y-是,N-否
               "       '0', ",                   #oga95       #本次積分
               "       'N', ",                   #oga1014     #调货销退单所自动产生否
               "       ",l_field.ogaconu,", ",   #ogaconu     #審核人
               "       ",l_field.ogacond,", ",   #ogacond     #審核日期
               "       'Y', ",                   #ogaconf     #確認否/作廢碼
               "       ",l_field.ogagrup,", ",   #ogagrup     #資料所有部門
               "       ",l_field.ogalegal,", ",  #ogalegal    #所屬法人
               "       ",l_field.ogaorig,", ",   #ogaorig     #資料建立部門
               "       ",l_field.ogaoriu,", ",   #ogaoriu     #資料建立者
               "       ",l_field.ogaplant,", ",  #ogaplant    #所屬營運中心
               "       'Y', ",                   #ogapost     #出貨扣帳否 
               "       0, ",                     #ogaprsw     #列印次數
               "       ",l_field.ogauser,", ",   #ogauser     #資料所有者
               "       'N', ",                   #ogamksg     #签核
               "       '1' "                     #ogaslk02    #出货类型（现货，期货）
   LET l_sql = l_ins CLIPPED," ",l_sel CLIPPED," ",l_oga_from CLIPPED," ",l_oga_where CLIPPED
   PREPARE prodoga_ins_oga_temp_pre FROM l_sql
   EXECUTE prodoga_ins_oga_temp_pre
   IF SQLCA.sqlcode THEN
      LET g_success = 'N'
      LET g_errno   = SQLCA.sqlcode
      LET g_msg1    = 'Oper:Ins(prod oga)'||' '||'Table:oga_temp'||' '||'Shop:'||p_azw01
      CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
      ROLLBACK WORK
      CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
      LET g_msg   = g_msg[1,255]
      CALL p200_log(g_trans_no,p_azw01,'Batch Operation','05',l_ryl05,g_errno,g_msg,'0','N',g_msg1)
      LET g_errno = ''
      LET g_msg   = ''
      LET g_msg1  = ''
      CALL p200_upd_posflag_p('2',p_gat01,l_ryl05,p_azw01) #将对应中间库的资料Condition2更新为A
      RETURN
   END IF
   
   #更新汇率
  #LET l_sql = "SELECT oga23,oga02 FROM oga_temp "          #FUN-CB0103 Mark
   LET l_sql = "SELECT DISTINCT oga23,oga02 FROM oga_temp " #FUN-CB0103 Add
   PREPARE prodoga_sel_oga23_pre FROM l_sql
   DECLARE prodoga_sel_oga23_cs CURSOR FOR prodoga_sel_oga23_pre
   FOREACH prodoga_sel_oga23_cs INTO l_oga23,l_oga02
      CALL s_currm(l_oga23,l_oga02,g_oaz.oaz52,p_azw01) RETURNING l_oga24
      UPDATE oga_temp SET oga24 = l_oga24 WHERE oga23 = l_oga23 AND oga02 = l_oga02
   END FOREACH
   
   LET l_ins = "INSERT INTO ogb_temp( ",
               "                     ogb01, ",           #出貨單號
               "                     ogb03, ",           #項次    
               "                     ogb04, ",           #產品編號
               "                     ogb05, ",           #銷售單位
               "                     ogb05_fac, ",       #销售/库存汇总单位换算率
               "                     ogb06, ",           #品名规格
               "                     ogb08, ",           #出货营运中心编号
               "                     ogb09, ",           #出货仓库编号
               "                     ogb091, ",          #
               "                     ogb092, ",          #
               "                     ogb12, ",           #實際出貨數量
               "                     ogb13, ",           #原幣單價    
               "                     ogb14, ",           #原幣未稅金額
               "                     ogb14t, ",          #原幣含稅金額
               "                     ogb15, ",           #库存单位
               "                     ogb15_fac, ",       #销售/库存明细单位换算率
               "                     ogb16, ",           #數量        
               "                     ogb17, ",           #多倉儲批出貨否
               "                     ogb18, ",           #預計出貨數量
               "                     ogb19, ",           #檢驗否        
               "                     ogb31, ",           #訂單單號
               "                     ogb32, ",           #訂單項次
               "                     ogb37, ",           #基礎單价
               "                     ogb40, ",           #抽成代號
               "                     ogb44, ",           #经营方式
               "                     ogb45, ",           #原扣率  
               "                     ogb46, ",           #新扣率  
               "                     ogb47, ",           #分攤折價
               "                     ogb48, ",           #攤位編號
               "                     ogb50, ",           #開票性質      
               "                     ogb51, ",           #已簽退數量    
               "                     ogb52, ",           #簽退數量      
               "                     ogb53, ",           #單位一驗退數量
               "                     ogb54, ",           #單位二驗退數量
               "                     ogb55, ",           #驗退計價數量  
               "                     ogb60, ",           #已開發票數量
               "                     ogb63, ",           #銷退數量    
               "                     ogb64, ",           #銷退數量
               "                     ogb916, ",          #計價單位
               "                     ogb917, ",          #計價數量
               "                     ogb930, ",          #成本中心
               "                     ogb1001, ",         #原因碼
               "                     ogb1005, ",         #作業方式
               "                     ogb1006, ",         #折扣率
               "                     ogb1012, ",         #搭贈
               "                     ogb1014, ",         #保稅已放行否
               "                     ogbplant, ",        #所屬營運中心
               "                     ogblegal) "         #所屬法人
   LET l_sel1 = "SELECT ",
               "       ",l_field.ogb01,", ",                               #ogb01        #出貨單號
               "       ",l_field.ogb03,", ",                               #ogb03        #項次    
               "       'MISCCARD', ",                                      #ogb04        #產品編號
               "       'PCS', ",                                           #ogb05        #銷售單位
               "       1, ",                                               #ogb05_fac    #销售/库存汇总单位换算率
               "       NULL, ",                                            #ogb06        #品名规格
               "       ",l_field.ogb08,", ",                               #ogb08        #出货营运中心编号
               "       '",g_rtz07,"', ",                                   #ogb09        #出货仓库编号
               "       ' ', ",                                             #ogb091       #
               "       ' ', ",                                             #ogb092       #
               "       1, ",                                               #ogb12        #實際出貨數量
               "       ",l_field.ogb13,", ",                               #ogb13        #原幣單價    
               "       ",l_field.ogb14,", ",                               #ogb14        #原幣未稅金額
               "       ",l_field.ogb14t,", ",                              #ogb14t       #原幣含稅金額
               "       'PCS', ",                                           #ogb15        #库存单位
               "       1, ",                                               #ogb15_fac    #销售/库存明细单位换算率
               "       1, ",                                               #ogb16        #數量        
               "       'N', ",                                             #ogb17        #多倉儲批出貨否
               "       0, ",                                               #ogb18        #預計出貨數量
               "       'N', ",                                             #ogb19        #檢驗否        
               "       NULL, ",                                            #ogb31        #訂單單號
               "       NULL, ",                                            #ogb32        #訂單項次
               "       ",l_field.ogb37,", ",                               #ogb37        #基礎單价
               "       NULL, ",                                            #ogb40        #抽成代號
               "       '1', ",                                             #ogb44        #经营方式
               "       NULL, ",                                            #ogb45        #原扣率  
               "       NULL, ",                                            #ogb46        #新扣率  
               "       ",l_field.ogb37,", ",                               #ogb47        #分攤折價
               "       NULL, ",                                            #ogb48        #攤位編號
               "       0, ",                                               #ogb50        #開票性質      
               "       0, ",                                               #ogb51        #已簽退數量    
               "       0, ",                                               #ogb52        #簽退數量      
               "       0, ",                                               #ogb53        #單位一驗退數量
               "       0, ",                                               #ogb54        #單位二驗退數量
               "       0, ",                                               #ogb55        #驗退計價數量  
               "       0, ",                                               #ogb60        #已開發票數量
               "       0, ",                                               #ogb63        #銷退數量    
               "       0, ",                                               #ogb64        #銷退數量
               "       'PCS', ",                                           #ogb916       #計價單位
               "       1, ",                                               #ogb917       #計價數量
               "       NULL, ",                                            #ogb930       #成本中心
               "       '",l_field.ogb1001,"', ",                           #ogb1001      #原因碼
               "       '1', ",                                             #ogb1005      #作業方式
               "       100, ",                                             #ogb1006      #折扣率
               "       'N', ",                                             #ogb1012      #搭贈
               "       'N', ",                                             #ogb1014      #保稅已放行否
               "       ",l_field.ogbplant,", ",                            #ogbplant     #所屬營運中心
               "       ",l_field.ogblegal," "                              #ogblegal     #所屬法人
               
   LET l_sql = l_ins CLIPPED," ",l_sel1 CLIPPED," ",l_ogb_from CLIPPED," ",l_ogb_where CLIPPED 
   PREPARE prodoga_ins_ogb_temp_pre FROM l_sql
   EXECUTE prodoga_ins_ogb_temp_pre
   IF SQLCA.sqlcode THEN
      LET g_success = 'N'
      LET g_errno   = SQLCA.sqlcode
      LET g_msg1    = 'Oper:Ins(prod oga)'||' '||'Table:ogb_temp'||' '||'Shop:'||p_azw01
      CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
      ROLLBACK WORK
      CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
      LET g_msg   = g_msg[1,255]
      CALL p200_log(g_trans_no,p_azw01,'Batch Operation','05',l_ryl05,g_errno,g_msg,'0','N',g_msg1)
      LET g_errno = ''
      LET g_msg   = ''
      LET g_msg1  = ''
      CALL p200_upd_posflag_p('2',p_gat01,l_ryl05,p_azw01) #将对应中间库的资料Condition2更新为A
      RETURN
   END IF
   
   IF p_flag = '1' THEN 
      LET l_sel2 = "SELECT ",
                  "       lps17, ",                                           #ogb01        #出貨單號
                  "       ROW_NUMBER() over(partition by lps17 order by lps17) ",           #ogb03        #項次    
                  "       + COALESCE((SELECT MAX(ogb03) FROM ogb_temp WHERE ogb01 = lps17),0), ",
                  "       'MISCCARD', ",                                      #ogb04        #產品編號
                  "       'PCS', ",                                           #ogb05        #銷售單位
                  "       1, ",                                               #ogb05_fac    #销售/库存汇总单位换算率
                  "       NULL, ",                                            #ogb06        #品名规格
                  "       lptplant, ",                                        #ogb08        #出货营运中心编号
                  "       '",g_rtz07,"', ",                                   #ogb09        #出货仓库编号
                  "       ' ', ",                                             #ogb091       #储位
                  "       ' ', ",                                             #ogb092       #批号
                  "       1, ",                                               #ogb12        #實際出貨數量
                  "       lpt10-lpt12, ",                                     #ogb13        #原幣單價    
                 #"       lpt10-lpt12, ",                                     #ogb14        #原幣未稅金額     #FUN-D20096 Mark
                  "       Uamt, ",                                            #ogb14        #原幣未稅金額     #FUN-D20096 Add
                  "       lpt10-lpt12, ",                                     #ogb14t       #原幣含稅金額
                  "       'PCS', ",                                           #ogb15        #库存单位
                  "       1, ",                                               #ogb15_fac    #销售/库存明细单位换算率
                  "       1, ",                                               #ogb16        #數量        
                  "       'N', ",                                             #ogb17        #多倉儲批出貨否
                  "       0, ",                                               #ogb18        #預計出貨數量
                  "       'N', ",                                             #ogb19        #檢驗否        
                  "       NULL, ",                                            #ogb31        #訂單單號
                  "       NULL, ",                                            #ogb32        #訂單項次
                  "       lpt10, ",                                           #ogb37        #基礎單价
                  "       NULL, ",                                            #ogb40        #抽成代號
                  "       '1', ",                                             #ogb44        #经营方式
                  "       NULL, ",                                            #ogb45        #原扣率  
                  "       NULL, ",                                            #ogb46        #新扣率  
                  "       lpt12, ",                                           #ogb47        #分攤折價
                  "       NULL, ",                                            #ogb48        #攤位編號
                  "       0, ",                                               #ogb50        #開票性質      
                  "       0, ",                                               #ogb51        #已簽退數量    
                  "       0, ",                                               #ogb52        #簽退數量      
                  "       0, ",                                               #ogb53        #單位一驗退數量
                  "       0, ",                                               #ogb54        #單位二驗退數量
                  "       0, ",                                               #ogb55        #驗退計價數量  
                  "       0, ",                                               #ogb60        #已開發票數量
                  "       0, ",                                               #ogb63        #銷退數量    
                  "       0, ",                                               #ogb64        #銷退數量
                  "       'PCS', ",                                           #ogb916       #計價單位
                  "       1, ",                                               #ogb917       #計價數量
                  "       NULL, ",                                            #ogb930       #成本中心
                  "       '",g_rcj06,"', ",                                   #ogb1001      #原因碼
                  "       '1', ",                                             #ogb1005      #作業方式
                  "       100, ",                                             #ogb1006      #折扣率
                  "       'N', ",                                             #ogb1012      #搭贈
                  "       'N', ",                                             #ogb1014      #保稅已放行否
                  "       lptplant, ",                                        #ogbplant     #所屬營運中心
                  "       lptlegal ",                                         #ogblegal     #所屬法人
                 #FUN-D20096 Add&Mark-------Str
                 #"  FROM lps_temp,lpt_temp ",                                    
                  "  FROM lps_temp ",                                              
                  "  LEFT OUTER JOIN ",g_posdbs,"tg_SaleCard_Detail_Tax",g_db_links,
                  "    ON Shop = lpsplant AND Item = '2' AND lps18 = SaleCardNO ", 
                  ",lpt_temp ",                                                     
                 #FUN-D20096 Add&Mark-------End
                  " WHERE lps01 = lpt01 AND lpt10 >= 0 "
      LET l_sql = l_ins CLIPPED," ",l_sel2 CLIPPED
      PREPARE prodoga_ins_ogb_temp_pre2 FROM l_sql
      EXECUTE prodoga_ins_ogb_temp_pre2
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Ins(prod oga)'||' '||'Table:ogb_temp'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','05',l_ryl05,g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         CALL p200_upd_posflag_p('2',p_gat01,l_ryl05,p_azw01) #将对应中间库的资料Condition2更新为A
         RETURN
      END IF 
   END IF

   #更新单头金额
   LET l_upd = "UPDATE oga_temp ",
               "  SET oga50 = COALESCE((SELECT SUM(ogb14)  FROM ogb_temp WHERE ogb01 = oga01),0), ",
               "      oga51 = COALESCE((SELECT SUM(ogb14t) FROM ogb_temp WHERE ogb01 = oga01),0) "
   PREPARE prodoga_upd_oga50_pre FROM l_upd
   EXECUTE prodoga_upd_oga50_pre
   

   #更新ogb_temp中成本中心
   LET l_upd = "UPDATE ogb_temp ",
               "   SET ogb930 = ",
               "       (SELECT gem10 FROM ",cl_get_target_table(p_azw01,'gem_file'),
               "         WHERE EXISTS (SELECT 1 FROM oga_temp ",
               "                        WHERE gem01 = oga15 ",
               "                          AND oga01 = ogb01)) "
   PREPARE prodoga_upd_ogb930_p FROM l_upd
   EXECUTE prodoga_upd_ogb930_p
   IF SQLCA.sqlcode THEN
      LET g_success = 'N'
      LET g_errno   = SQLCA.sqlcode
      LET g_msg1    = 'Oper:Upd'||' '||'Table:ogb_temp'||' '||'Field:ogb930'||' '||'Shop:'||p_azw01
      CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
      ROLLBACK WORK
      CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
      LET g_msg   = g_msg[1,255]
      CALL p200_log(g_trans_no,p_azw01,'Batch Operation','05',l_ryl05,g_errno,g_msg,'0','N',g_msg1)
      LET g_errno = ''
      LET g_msg   = ''
      LET g_msg1  = ''
      CALL p200_upd_posflag_p('2',p_gat01,l_ryl05,p_azw01) #将对应中间库的资料Condition2更新为A
      RETURN
   END IF
   
  ##ins ogi
  #LET l_ins = "INSERT INTO ogi_temp( ",
  #            "                     ogi01, ",      #出貨單號
  #            "                     ogi02, ",      #項次
  #            "                     ogi03, ",      #序號
  #            "                     ogi04, ",      #稅別
  #            "                     ogi05, ",      #稅率
  #            "                     ogi06, ",      #固定稅額
  #            "                     ogi07, ",      #含稅否
  #            "                     ogi08, ",      #未稅金額
  #            "                     ogi08t, ",     #含稅金額
  #            "                     ogi09, ",      #稅額
  #            "                     ogidate, ",    #最近修改日
  #            "                     ogigrup, ",    #資料所有部門
  #            "                     ogilegal, ",   #所屬法人
  #            "                     ogimodu, ",    #資料修改者
  #            "                     ogiorig, ",    #資料建立部門
  #            "                     ogioriu, ",    #資料建立者
  #            "                     ogiplant, ",   #所屬營運中心
  #            "                     ogiuser) "     #資料所有者
  #LET l_sel = "SELECT ",
  #            "       lps17, ",                                                 #ogi01      #出貨單號
  #            "       ROW_NUMBER() over(order by lps17) ogi02, ",               #ogi02      #項次
  #            "       ROW_NUMBER() over(order by lps17,ogi02), ",               #ogi03      #序號
  #            "       oga21, ",                                                 #ogi04      #稅別
  #            "       oga211, ",                                                #ogi05      #稅率
  #            "       0, ",                                                     #ogi06      #固定稅額
  #            "       oga213, ",                                                #ogi07      #含稅否
  #            "       CASE oga213 WHEN 'Y' THEN 1*lpt08/(1+oga211/100) ",       #ogi08      #未稅金額
  #            "                   WHEN 'N' THEN 1*lpt08 END, ",
  #            "       CASE oga213 WHEN 'Y' THEN 1*lpt08 ",                      #ogi08t     #含稅金額
  #            "                   WHEN 'N' THEN 1*lpt08*(1+oga211/100) END, ",
  #            "       CASE oga213 WHEN 'Y' THEN 1*lpt08*(1-1/(1+oga211/100)) ", #ogi09      #稅額
  #            "                   WHEN 'N' THEN 1*lpt08*oga211/100 END, "
  #            "       ogadate, ",                                               #ogidate    #最近修改日
  #            "       ogagrup, ",                                               #ogigrup    #資料所有部門
  #            "       ogalegal, ",                                              #ogilegal   #所屬法人
  #            "       ogamodu, ",                                               #ogimodu    #資料修改者
  #            "       ogaorig, ",                                               #ogiorig    #資料建立部門
  #            "       ogaoriu, ",                                               #ogioriu    #資料建立者
  #            "       ogaplant, ",                                              #ogiplant   #所屬營運中心
  #            "       ogauser ",                                                #ogiuser    #資料所有者
  #            "  FROM lpt_temp,lpt_temp LEFT OUTER JOIN oga_temp ON oga01 = lps17 ",
  #            " WHERE lpt01 = lps01 AND lpt08 >= 0 "
  #LET l_sql = l_ins CLIPPED," ",l_sel CLIPPED
  #PREPARE prodoga_ins_ogi_temp_pre1 FROM l_sql
  #EXECUTE prodoga_ins_ogi_temp_pre1
   
  
  #逻辑复杂,后续在做 
  ##ins ogh
  #LET l_ins = "INSERT INTO ogh_temp( ",
  #            "                     ogh01, ",      #出貨單號
  #            "                     ogh02, ",      #序號
  #            "                     ogh03, ",      #稅別
  #            "                     ogh04, ",      #稅率
  #            "                     ogh05, ",      #固定稅額
  #            "                     ogh06, ",      #含稅否
  #            "                     ogh07, ",      #未稅金額
  #            "                     ogh07t, ",     #含稅金額
  #            "                     ogh08, ",      #稅額
  #            "                     ogh09, ",      #留抵稅額
  #            "                     oghdate, ",    #最近修改日
  #            "                     oghgrup, ",    #資料所有部門
  #            "                     oghlegal, ",   #所屬法人
  #            "                     oghmodu, ",    #資料修改者
  #            "                     oghorig, ",    #資料建立部門
  #            "                     oghoriu, ",    #資料建立者
  #            "                     oghplant, ",   #所屬營運中心
  #            "                     oghuser) "     #資料所有者
  #LET l_sel = "SELECT ",
  #            "       ogi01, ",                    #ogh01      #出貨單號
  #            "       , ",                         #ogh02      #序號
  #            "       ogi04, ",                    #ogh03      #稅別
  #            "       ogi05, ",                    #ogh04      #稅率
  #            "       ogi06, ",                    #ogh05      #固定稅額
  #            "       ogi07, ",                    #ogh06      #含稅否
  #            "       0, ",                        #ogh07      #未稅金額
  #            "       0, ",                        #ogh07t     #含稅金額
  #            "       COALESCE(SUM(ogi09),0), ",   #ogh08      #稅額
  #            "       ' ', ",                      #ogh09      #留抵稅額
  #            "       ogidate, ",                  #oghdate    #最近修改日
  #            "       ogigrup, ",                  #oghgrup    #資料所有部門
  #            "       ogilegal, ",                 #oghlegal   #所屬法人
  #            "       ogimodu, ",                  #oghmodu    #資料修改者
  #            "       ogiorig, ",                  #oghorig    #資料建立部門
  #            "       ogioriu, ",                  #oghoriu    #資料建立者
  #            "       ogiplant, ",                 #oghplant   #所屬營運中心
  #            "       ogiuser, ",                  #oghuser    #資料所有者
  

   #FUN-D20096---Add---Str
   IF p_flag = '1' THEN
      LET l_tablename = 'tg_SaleCard_Tax'
      LET l_tablename1 = 'tg_SaleCard_Detail_Tax'
      LET l_tablename2 = 'lps_temp'
      LET l_ogh_where = " WHERE Shop = '",p_azw01 CLIPPED,"' ",
                        "   AND lps17 = oga01 AND lps18 = SaleCardNO "
   END IF
   IF p_flag = '2' THEN
      LET l_tablename = 'tg_Recharge_TaxMaster'
      LET l_tablename1 = 'tg_Recharge_TaxDetail'
      LET l_tablename2 = 'lpu_temp'
      LET l_ogh_where = " WHERE Shop = '",p_azw01 CLIPPED,"' ",
                        "   AND lpu16 = oga01 AND lpu17 = RechargeNO "
   END IF
   IF p_flag = '3' THEN
      LET l_tablename = 'tg_ChangeCard_TaxMaster'      
      LET l_tablename1 = 'tg_ChangeCard_TaxDetail'      
      LET l_tablename2 = 'lrw_temp'
      LET l_ogh_where = " WHERE Shop = '",p_azw01 CLIPPED,"' ",
                        "   AND lrw24 = oga01 AND lrw25 = ChangeCardNo "
   END IF
   LET l_ins = "INSERT INTO ogh_temp( ",
               "       ogh01, ",                     #出貨單號
               "       ogh02, ",                     #序號
               "       ogh03, ",                     #稅別
               "       ogh04, ",                     #稅率
               "       ogh05, ",                     #固定稅額
               "       ogh06, ",                     #含稅否
               "       ogh07, ",                     #未稅金額
               "       ogh07t, ",                    #含稅金額
               "       ogh08, ",                     #稅額
               "       ogh09, ",                     #留抵稅額
               "       oghdate, ",                   #最近修改日
               "       oghgrup, ",                   #資料所有部門
               "       oghlegal, ",                  #所屬法人
               "       oghmodu, ",                   #資料修改者
               "       oghorig, ",                   #資料建立部門
               "       oghoriu, ",                   #資料建立者
               "       oghplant, ",                  #所屬營運中心
               "       oghuser) "                    #資料所有者

   LET l_sel = "SELECT DISTINCT ",
               "       oga01, ",                     #ogh01    出貨單號
               "       Item, ",                      #ogh02    序號
               "       Taxcode, ",                   #ogh03    稅別
               "       Taxrate, ",                   #ogh04    稅率
               "       0, ",                         #ogh05    固定稅額
               "       Incltax, ",                   #ogh06    含稅否
               "       Uamt, ",                      #ogh07    未稅金額
               "       Amt, ",                       #ogh07t   含稅金額
               "       Tax, ",                       #ogh08    稅額
               "       acctax, ",                    #ogh09    留抵稅額
               "       ogadate, ",                   #oghdate  最近修改日
               "       ogagrup, ",                   #oghgrup  資料所有部門
               "       ogalegal, ",                  #oghlegal 所屬法人
               "       ogamodu, ",                   #oghmodu  資料修改者
               "       ogaorig, ",                   #oghorig  資料建立部門
               "       ogaoriu, ",                   #oghoriu  資料建立者
               "       Shop, ",                      #oghplant 所屬營運中心
               "       ogauser ",                    #oghuser  資料所有者
               "  FROM ",g_posdbs,l_tablename,g_db_links,",oga_temp,",l_tablename2," ",l_ogh_where CLIPPED," ",
               " ORDER BY oga01,Item "
   LET l_sql = l_ins CLIPPED," ",l_sel CLIPPED
   CALL cl_replace_sqldb(l_sql) RETURNING l_sql
   PREPARE prodoga_ins_ogh_temp_pre FROM l_sql
   EXECUTE prodoga_ins_ogh_temp_pre 
   IF SQLCA.sqlcode THEN
      LET g_success = 'N'
      LET g_errno   = SQLCA.sqlcode
      LET g_msg1    = 'Oper:Ins'||' '||'Table:ogh_temp'||' '||'Shop:'||p_azw01
      CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
      ROLLBACK WORK
      CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
      LET g_msg   = g_msg[1,255]
      CALL p200_log(g_trans_no,p_azw01,'Batch Operation','05',l_tablename,g_errno,g_msg,'0','N',g_msg1)
      LET g_errno = ''
      LET g_msg   = ''
      LET g_msg1  = ''
      CALL p200_upd_posflag_p('2',p_gat01,l_tablename,p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
      RETURN
   END IF


   #ins ogi
   LET l_ins = "INSERT INTO ogi_temp( ",
               "       ogi01, ",                     #出貨單號
               "       ogi02, ",                     #項次
               "       ogi03, ",                     #序號
               "       ogi04, ",                     #稅別
               "       ogi05, ",                     #稅率
               "       ogi06, ",                     #固定稅額
               "       ogi07, ",                     #含稅否
               "       ogi08, ",                     #未稅金額
               "       ogi08t, ",                    #含稅金額
               "       ogi09, ",                     #稅額
               "       ogidate, ",                   #最近修改日
               "       ogigrup, ",                   #資料所有部門
               "       ogilegal, ",                  #所屬法人
               "       ogimodu, ",                   #資料修改者
               "       ogiorig, ",                   #資料建立部門
               "       ogioriu, ",                   #資料建立者
               "       ogiplant, ",                  #所屬營運中心
               "       ogiuser) "                    #資料所有者

   LET l_sel = "SELECT DISTINCT ",
               "       oga01, ",                     #ogi01    出貨單號
               "       Item, ",                      #ogi02    項次
               "       Item, ",                      #ogi03    序號
               "       Taxcode, ",                   #ogi04    稅別
               "       Taxrate, ",                   #ogi05    稅率
               "       0, ",                         #ogi06    固定稅額
               "       Incltax, ",                   #ogi07    含稅否
               "       Uamt, ",                      #ogi08    未稅金額
               "       Amt, ",                       #ogi08t   含稅金額
               "       Tax, ",                       #ogi09    稅額
               "       ogadate, ",                   #ogidate  最近修改日
               "       ogagrup, ",                   #ogigrup  資料所有部門
               "       ogalegal, ",                  #ogilegal 所屬法人
               "       ogamodu, ",                   #ogimodu  資料修改者
               "       ogaorig, ",                   #ogiorig  資料建立部門
               "       ogaoriu, ",                   #ogioriu  資料建立者
               "       Shop, ",                      #ogiplant 所屬營運中心
               "       ogauser ",                    #ogiuser  資料所有者
               "  FROM ",g_posdbs,l_tablename1,g_db_links,",oga_temp,",l_tablename2," ",l_ogh_where CLIPPED," "
   LET l_sql = l_ins CLIPPED," ",l_sel CLIPPED
   CALL cl_replace_sqldb(l_sql) RETURNING l_sql
   PREPARE prodoga_ins_ogi3_temp_pre FROM l_sql
   EXECUTE prodoga_ins_ogi3_temp_pre 
   IF SQLCA.sqlcode THEN
      LET g_success = 'N'
      LET g_errno   = SQLCA.sqlcode
      LET g_msg1    = 'Oper:Ins'||' '||'Table:ogi_file'||' '||'Shop:'||p_azw01
      CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
      ROLLBACK WORK
      CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
      LET g_msg   = g_msg[1,255]
      CALL p200_log(g_trans_no,p_azw01,'Batch Operation','05',l_tablename1,g_errno,g_msg,'0','N',g_msg1)
      LET g_errno = ''
      LET g_msg   = ''
      LET g_msg1  = ''
      CALL p200_upd_posflag_p('2',p_gat01,l_tablename1,p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
      RETURN
   END IF
   #FUN-D20096---Add---End 


   #ins xyz
   LET l_ins = "INSERT INTO rxy_temp( ",
               "                     rxy00, ",     #单据别
               "                     rxy01, ",     #单号
               "                     rxy02, ",     #项次
               "                     rxy03, ",     #款别
               "                     rxy04, ",     #款别类型
               "                     rxy05, ",     #交款金额
               "                     rxy06, ",     #卡号/票号/账号/待抵单号
               "                     rxy07, ",     #刷卡手续费率
               "                     rxy08, ",     #刷卡手续费额
               "                     rxy09, ",     #支票面额
               "                     rxy10, ",     #出票日期
               "                     rxy11, ",     #出票单位
               "                     rxy12, ",     #卡券种类编号
               "                     rxy13, ",     #券面额编号
               "                     rxy14, ",     #券起始编号
               "                     rxy15, ",     #券终止编号
               "                     rxy16, ",     #券数量
               "                     rxy17, ",     #票券溢交款金额
               "                     rxy18, ",     #退款类型
               "                     rxy19, ",     #冲预收款类型
               "                     rxy20, ",     #固定手续费
               "                     rxy21, ",     #交款日期
               "                     rxy22, ",     #交款时间
               "                     rxy23, ",     #抵现积分
               "                     rxy30, ",     #POS款别
               "                     rxy31, ",     #销售单号
               "                     rxy32, ",     #项次
               "                     rxy33, ",     #冲预收否
               "                     rxylegal, ",  #法人别
               "                     rxyplant) "   #所属营运中心
   LET l_sel = "SELECT ",
               "       '02', ",                  #rxy00     #单据别
               "       ",l_field.rxy01,", ",     #rxy01     #单号
               "       rxy02, ",                 #rxy02     #项次
               "       rxy03, ",                 #rxy03     #款别
               "       rxy04, ",                 #rxy04     #款别类型
               "       rxy05, ",                 #rxy05     #交款金额
               "       rxy06, ",                 #rxy06     #卡号/票号/账号/待抵单号
               "       rxy07, ",                 #rxy07     #刷卡手续费率
               "       rxy08, ",                 #rxy08     #刷卡手续费额
               "       rxy09, ",                 #rxy09     #支票面额
               "       rxy10, ",                 #rxy10     #出票日期
               "       rxy11, ",                 #rxy11     #出票单位
               "       rxy12, ",                 #rxy12     #卡券种类编号
               "       rxy13, ",                 #rxy13     #券面额编号
               "       rxy14, ",                 #rxy14     #券起始编号
               "       rxy15, ",                 #rxy15     #券终止编号
               "       rxy16, ",                 #rxy16     #券数量
               "       rxy17, ",                 #rxy17     #票券溢交款金额
               "       rxy18, ",                 #rxy18     #退款类型
               "       rxy19, ",                 #rxy19     #冲预收款类型
               "       rxy20, ",                 #rxy20     #固定手续费
               "       rxy21, ",                 #rxy21     #交款日期
               "       rxy22, ",                 #rxy22     #交款时间
               "       rxy23, ",                 #rxy23     #抵现积分
               "       rxy30, ",                 #rxy30     #POS款别
               "       rxy31, ",                 #rxy31     #销售单号
               "       rxy32, ",                 #rxy32     #项次
               "       rxy33, ",                 #rxy33     #冲预收否
               "       rxylegal, ",              #rxylegal  #法人别
               "       rxyplant "                #rxyplant  #所属营运中心
   LET l_sql = l_ins CLIPPED," ",l_sel CLIPPED," ",l_rxy_from CLIPPED," ",l_rxy_where CLIPPED
   PREPARE prodoga_ins_rxy_temp_pre FROM l_sql
   EXECUTE prodoga_ins_rxy_temp_pre
   IF SQLCA.sqlcode THEN
      LET g_success = 'N'
      LET g_errno   = SQLCA.sqlcode
      LET g_msg1    = 'Oper:Ins(prod oga)'||' '||'Table:rxy_temp'||' '||'Shop:'||p_azw01
      CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
      ROLLBACK WORK
      CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
      LET g_msg   = g_msg[1,255]
      CALL p200_log(g_trans_no,p_azw01,'Batch Operation','05',l_ryl05,g_errno,g_msg,'0','N',g_msg1)
      LET g_errno = ''
      LET g_msg   = ''
      LET g_msg1  = ''
      CALL p200_upd_posflag_p('2',p_gat01,l_ryl05,p_azw01) #将对应中间库的资料Condition2更新为A
      RETURN
   END IF 

   #ins rxx
   LET l_ins = "INSERT INTO rxx_temp( ",
               "                     rxx00, ",       #单据别
               "                     rxx01, ",       #单号
               "                     rxx02, ",       #款别
               "                     rxx03, ",       #款别类型
               "                     rxx04, ",       #交款金额
               "                     rxx05, ",       #溢交款金额
               "                     rxx11, ",       #销售单号
               "                     rxxlegal, ",    #法人别
               "                     rxxplant) "     #所属营运中心
   LET l_sel = "SELECT ",
               "       '02', ",                   #rxx00      #单据别
               "       ",l_field.rxx01,", ",      #rxx01      #单号
               "       rxx02, ",                  #rxx02      #款别
               "       rxx03, ",                  #rxx03      #款别类型
               "       rxx04, ",                  #rxx04      #交款金额
               "       rxx05, ",                  #rxx05      #溢交款金额
               "       rxx11, ",                  #rxx11      #销售单号
               "       rxxlegal, ",               #rxxlegal   #法人别
               "       rxxplant "                 #rxxplant   #所属营运中心
   LET l_sql = l_ins CLIPPED," ",l_sel CLIPPED," ",l_rxx_from CLIPPED," ",l_rxx_where CLIPPED
   PREPARE prodoga_ins_rxx_temp_pre FROM l_sql
   EXECUTE prodoga_ins_rxx_temp_pre
   IF SQLCA.sqlcode THEN
      LET g_success = 'N'
      LET g_errno   = SQLCA.sqlcode
      LET g_msg1    = 'Oper:Ins(prod oga)'||' '||'Table:rxx_temp'||' '||'Shop:'||p_azw01
      CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
      ROLLBACK WORK
      CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
      LET g_msg   = g_msg[1,255]
      CALL p200_log(g_trans_no,p_azw01,'Batch Operation','05',l_ryl05,g_errno,g_msg,'0','N',g_msg1)
      LET g_errno = ''
      LET g_msg   = ''
      LET g_msg1  = ''
      CALL p200_upd_posflag_p('2',p_gat01,l_ryl05,p_azw01) #将对应中间库的资料Condition2更新为A
      RETURN
   END IF 
   
   #ins rxz
   LET l_ins = "INSERT INTO rxz_temp( ",
               "                     rxz00, ",      #单据别
               "                     rxz01, ",      #单号
               "                     rxz02, ",      #款别类型
               "                     rxz03, ",      #刷卡序号
               "                     rxz04, ",      #卡号
               "                     rxz05, ",      #刷卡金额
               "                     rxz06, ",      #刷卡日期
               "                     rxz07, ",      #刷卡时间
               "                     rxz08, ",      #刷卡人员
               "                     rxz09, ",      #刷卡手续费额
               "                     rxz10, ",      #刷卡手续费率
               "                     rxz11, ",      #银行名称
               "                     rxz12, ",      #银行注册否
               "                     rxz13, ",      #状态
               "                     rxz14, ",      #状态说明
               "                     rxz15, ",      #固定手续费
               "                     rxz20, ",      #卡类型
               "                     rxz21, ",      #销售单号
               "                     rxzlegal, ",   #法人别
               "                     rxzplant) "    #所属营运中心
   LET l_sel = "SELECT ",
               "       '02', ",                   #rxz00      #单据别
               "       ",l_field.rxz01,", ",      #rxz01      #单号
               "       rxz02, ",                  #rxz02      #款别类型
               "       rxz03, ",                  #rxz03      #刷卡序号
               "       rxz04, ",                  #rxz04      #卡号
               "       rxz05, ",                  #rxz05      #刷卡金额
               "       rxz06, ",                  #rxz06      #刷卡日期
               "       rxz07, ",                  #rxz07      #刷卡时间
               "       rxz08, ",                  #rxz08      #刷卡人员
               "       rxz09, ",                  #rxz09      #刷卡手续费额
               "       rxz10, ",                  #rxz10      #刷卡手续费率
               "       rxz11, ",                  #rxz11      #银行名称
               "       rxz12, ",                  #rxz12      #银行注册否
               "       rxz13, ",                  #rxz13      #状态
               "       rxz14, ",                  #rxz14      #状态说明
               "       rxz15, ",                  #rxz15      #固定手续费
               "       rxz20, ",                  #rxz20      #卡类型
               "       rxz21, ",                  #rxz21      #销售单号
               "       rxzlegal, ",               #rxzlegal   #法人别
               "       rxzplant "                 #rxzplant   #所属营运中心
   LET l_sql = l_ins CLIPPED," ",l_sel CLIPPED," ",l_rxz_from CLIPPED," ",l_rxz_where CLIPPED
   PREPARE prodoga_ins_rxz_temp_pre FROM l_sql
   EXECUTE prodoga_ins_rxz_temp_pre
   IF SQLCA.sqlcode THEN
      LET g_success = 'N'
      LET g_errno   = SQLCA.sqlcode
      LET g_msg1    = 'Oper:Ins(prod oga)'||' '||'Table:rxz_temp'||' '||'Shop:'||p_azw01
      CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
      ROLLBACK WORK                  
      CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
      LET g_msg   = g_msg[1,255]     
      CALL p200_log(g_trans_no,p_azw01,'Batch Operation','05',l_ryl05,g_errno,g_msg,'0','N',g_msg1)
      LET g_errno = ''               
      LET g_msg   = ''               
      LET g_msg1  = ''               
      CALL p200_upd_posflag_p('2',p_gat01,l_ryl05,p_azw01) #将对应中间库的资料Condition2更新为A
      RETURN
   END IF 

   #ins rxc
   IF p_flag = '1' OR p_flag = '2' THEN 
      LET l_ins = "INSERT INTO rxc_file( ",
                  "                     rxc00, ",      #单据别
                  "                     rxc01, ",      #单号
                  "                     rxc02, ",      #项次
                  "                     rxc03, ",      #折价方式
                  "                     rxc04, ",      #促销单号
                  "                     rxc05, ",      #分类促销单号
                  "                     rxc06, ",      #折价金额
                  "                     rxc07, ",      #厂商促销分摊比例
                  "                     rxc08, ",      #返券促销单号
                  "                     rxc09, ",      #返券金额
                  "                     rxc10, ",      #厂商返券分摊比例
                  "                     rxc11, ",      #是否会员
                  "                     rxc12, ",      #结算营运中心
                  "                     rxc13, ",      #分摊厂商
                  "                     rxc14, ",      #分摊来源单号
                  "                     rxc15, ",      #數量-參加促銷的數量
                  "                     rxclegal, ",   #法人别
                  "                     rxcplant) "    #所属营运中心
      LET l_sel = "SELECT ",
                  "       '02', ",                   #rxc00      #单据别
                  "       ",l_field.rxc01,", ",      #rxc01      #单号
                  "       ",l_field.rxc02,", ",      #rxc02      #项次
                  "       '20', ",                   #rxc03      #折价方式
                  "       ' ', ",                    #rxc04      #促销单号
                  "       NULL, ",                   #rxc05      #分类促销单号
                  "       ",l_field.rxc06,", ",      #rxc06      #折价金额
                  "       0, ",                      #rxc07      #厂商促销分摊比例
                  "       NULL, ",                   #rxc08      #返券促销单号
                  "       0, ",                      #rxc09      #返券金额
                  "       0, ",                      #rxc10      #厂商返券分摊比例
                  "       ",l_field.rxc11,", ",      #rxc11      #是否会员
                  "       NULL, ",                   #rxc12      #结算营运中心
                  "       NULL, ",                   #rxc13      #分摊厂商
                  "       NULL, ",                   #rxc14      #分摊来源单号
                  "       0, ",                      #rxc15      #數量-參加促銷的數量
                  "       ",l_field.rxclegal,", ",   #rxclegal   #法人别
                  "       ",l_field.rxcplant," "     #rxcplant   #所属营运中心
      LET l_sql = l_ins CLIPPED," ",l_sel CLIPPED," ",l_rxc_from CLIPPED," ",l_rxc_where CLIPPED
      PREPARE prodoga_ins_rxc_temp_pre FROM l_sql
      EXECUTE prodoga_ins_rxc_temp_pre
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno   = SQLCA.sqlcode
         LET g_msg1    = 'Oper:Ins(prod oga)'||' '||'Table:rxc_temp'||' '||'Shop:'||p_azw01
         CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
         ROLLBACK WORK                  
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg   = g_msg[1,255]     
         CALL p200_log(g_trans_no,p_azw01,'Batch Operation','05',l_ryl05,g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''               
         LET g_msg   = ''               
         LET g_msg1  = ''               
         CALL p200_upd_posflag_p('2',p_gat01,l_ryl05,p_azw01) #将对应中间库的资料Condition2更新为A
         RETURN
      END IF
   END IF 
END FUNCTION
#FUN-CA0160 Add End -----

#FUN-CA0160 Add Begin ---

# Descriptions...: 退卡 产生销退单
# Input Parameter: p_flag:   标志位(1-退卡)
#                  p_azw01:  营运中心
# Usage..........: CALL p200_prod_oha_p('1',p_azw01)

FUNCTION p200_prod_oha_p(p_flag,p_azw01)
DEFINE p_flag   LIKE type_file.chr1
DEFINE p_azw01  LIKE azw_file.azw01
DEFINE l_oha02  LIKE oha_file.oha02
DEFINE l_oha23  LIKE oha_file.oha23
DEFINE l_oha24  LIKE oha_file.oha24
DEFINE l_gec01  LIKE gec_file.gec01
DEFINE l_gec04  LIKE gec_file.gec04
DEFINE l_gec07  LIKE gec_file.gec07
DEFINE l_ins    STRING
DEFINE l_sel    STRING
DEFINE l_sql    STRING
DEFINE l_upd    STRING

   IF cl_null(p_flag) THEN RETURN END IF 
   IF cl_null(p_azw01) THEN LET p_azw01 = g_plant END IF 
   
   CASE p_flag
      WHEN '1'  #退卡
         
   END CASE
   
   INITIALIZE l_gec01,l_gec04,l_gec07 TO NULL
   SELECT MAX(gec01) INTO l_gec01 FROM gec_file WHERE gec011 = '2' AND gec06 = '3'
   IF cl_null(l_gec01) THEN
      LET g_success = 'N'
      LET g_errno   = 'alm1619'
      LET g_msg1    = 'Oper:Chk'||' '||'Table:gec_file'||' '||'Field:gec01'||' '||'Shop:'||p_azw01
     #CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1) #FUN-CB0103 Mark
      CALL s_errmsg('Batch Operation:','',g_msg1,g_errno,1)       #FUN-CB0103 Add
      ROLLBACK WORK                  
      CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
      LET g_msg   = g_msg[1,255]     
      CALL p200_log(g_trans_no,p_azw01,'Batch Operation','05','tg_SaleCard',g_errno,g_msg,'0','N',g_msg1)
      LET g_errno = ''               
      LET g_msg   = ''               
      LET g_msg1  = ''               
      CALL p200_upd_posflag_p('2','lpv_file','tg_SaleCard',p_azw01) #将对应中间库的资料Condition2更新为A
      RETURN
   END IF
   SELECT gec04,gec07 INTO l_gec04,l_gec07 FROM gec_file WHERE gec01 = l_gec01
   
   LET l_ins = "INSERT INTO oha_temp( ",
               "                     oha01, ",       #销退单号
               "                     oha02, ",       #销退日期
               "                     oha03, ",       #账款客户编号
               "                     oha032, ",      #账款客户简称
               "                     oha04, ",       #退货客户编号
               "                     oha05, ",       #单据别 
               "                     oha08, ",       #1.内销 2.外销 3.视同外销
               "                     oha09, ",       #销退处理方式
               "                     oha14, ",       #人员编号
               "                     oha15, ",       #部门编号
               "                     oha16, ",       #出货单号
               "                     oha21, ",       #税种
               "                     oha211, ",      #税率
               "                     oha212, ",      #联数
               "                     oha213, ",      #含税否
               "                     oha23, ",       #币种
               "                     oha24, ",       #汇率
               "                     oha25, ",       #销售分类一
               "                     oha26, ",       #销售分类二
               "                     oha31, ",       #价格条件
               "                     oha41, ",       #三角貿易銷退單否
               "                     oha42, ",       #是否入库存
               "                     oha43, ",       #起始三角贸易销退单否
               "                     oha44, ",       #抛转否
               "                     oha48, ",       #备注
               "                     oha50, ",       #原币销退总税前金额
               "                     oha53, ",       #原币销退应开折让税前金额
               "                     oha54, ",       #原币销退已开折让税前金额
               "                     oha55, ",       #状况码
               "                     oha57, ",       #发票性质
               "                     oha85, ",       #结算方式
               "                     oha87, ",       #会员卡号
               "                     oha88, ",       #顾客姓名
               "                     oha89, ",       #联系电话
               "                     oha90, ",       #证件类型
               "                     oha91, ",       #证件号码  
               "                     oha94, ",       #POS销售否 Y-是,N-否
               "                     oha95, ",       #本次积分
               "                     oha96, ",       #收银机号
               "                     oha98, ",       #POS单号 
               "                     oha1001, ",     #收款客戶編號
               "                     oha1006, ",     #折扣金額(未稅)
               "                     oha1007, ",     #折扣金額(含稅)
               "                     oha1008, ",     #銷退總含稅金額
               "                     oha1015, ",     #调货出货单自动生成否
               "                     oha1019, ",     #返利退回税前金额
               "                     oha1020, ",     #折扣退回含稅金額
               "                     ohaconf, ",     #审核否
               "                     ohapost, ",     #扣账否
               "                     ohaprsw, ",     #打印次数
               "                     ohauser, ",     #资料所有者
               "                     ohagrup, ",     #资料所有部门
               "                     ohamksg, ",     #签核否
               "                     ohaplant, ",    #所属营运中心
               "                     ohalegal, ",    #所属法人
               "                     ohacond, ",     #审核日期
               "                     ohaconu, ",     #审核人员
               "                     ohaoriu, ",     #资料建立者
               "                     ohaorig, ",     #资料建立部门
               "                     ohacont, ",     #审核时间
               "                     ohadate) "      #最近更改日
   LET l_sel = "SELECT ",
               "       lpv13, ",                #oha01           #销退单号
               "       lpv10, ",                #oha02           #销退日期
               "       rtz06, ",                #oha03           #账款客户编号
               "       occ02, ",                #oha032          #账款客户简称
               "       rtz06, ",                #oha04           #退货客户编号
               "       '1', ",                  #oha05           #单据别
               "       '1', ",                  #oha08           #1.内销 2.外销 3.视同外销
               "       '1', ",                  #oha09           #销退处理方式
               "       lpvuser, ",              #oha14           #人员编号
               "       lpvgrup, ",              #oha15           #部门编号
               "       NULL, ",                 #oha16           #出货单号
               "       occ41, ",                #oha21           #税种
               "       gec04, ",                #oha211          #税率
               "       gec05, ",                #oha212          #联数
               "       gec07, ",                #oha213          #含税否
               "       occ42, ",                #oha23           #币种
               "       NULL, ",                 #oha24           #汇率
               "       occ43, ",                #oha25           #销售分类一
               "       occ43, ",                #oha26           #銷售分類二
               "       occ44, ",                #oha31           #价格条件
               "       'N', ",                  #oha41           #三角貿易銷退單否
               "       'N', ",                  #oha42           #是否入库存
               "       'N', ",                  #oha43           #起始三角贸易销退单否
               "       'N', ",                  #oha44           #抛转否
               "       NULL, ",                 #oha48           #备注
               "       lpv07, ",                #oha50           #原币销退总税前金额
               "       lpv07, ",                #oha53           #原币销退应开折让税前金额
               "       lpv07, ",                #oha54           #原币销退已开折让税前金额
               "       '1', ",                  #oha55           #状况码
               "       '1', ",                  #oha57           #发票性质
               "       '1', ",                  #oha85           #结算方式
               "       NULL, ",                 #oha87           #会员卡号
               "       NULL, ",                 #oha88           #顾客姓名
               "       NULL, ",                 #oha89           #联系电话
               "       NULL, ",                 #oha90           #证件类型
               "       NULL, ",                 #oha91           #证件号码
               "       'Y', ",                  #oha94           #POS销售否 Y-是,N-否
               "       0, ",                    #oha95           #本次积分
               "       NULL, ",                 #oha96           #收银机号
               "       NULL, ",                 #oha98           #POS单号
               "       rtz06, ",                #oha1001         #收款客戶編號
               "       0, ",                    #oha1006         #折扣金額(未稅)
               "       0, ",                    #oha1007         #折扣金額(含稅)
               "       0, ",                    #oha1008         #銷退總含稅金額
               "       'N', ",                  #oha1015         #调货出货单自动生成否
               "       0, ",                    #oha1019         #返利退回税前金额
               "       0, ",                    #oha1020         #折扣退回含稅金額
               "       'Y', ",                  #ohaconf         #审核否
               "       'Y', ",                  #ohapost         #扣账否
               "       0, ",                    #ohaprsw         #打印次数
               "       lpvuser, ",              #ohauser         #资料所有者
               "       lpvgrup, ",              #ohagrup         #资料所有部门
               "       'N', ",                  #ohamksg         #签核否
               "       lpvplant, ",             #ohaplant        #所属营运中心
               "       lpvlegal, ",             #ohalegal        #所属法人
               "       lpv10, ",                #ohacond         #审核日期
               "       lpvuser, ",              #ohaconu         #审核人员
               "       lpvuser, ",              #ohaoriu         #资料建立者 
               "       lpvgrup, ",              #ohaorig         #资料建立部门
               "       NULL, ",                 #ohacont         #审核时间
               "       lpv10  ",                #ohadate         #最近更改日
               "  FROM lpv_temp LEFT OUTER JOIN ",cl_get_target_table(p_azw01,'rtz_file'),
               "                             ON rtz01 = lpvplant ",
               "                LEFT OUTER JOIN ",cl_get_target_table(p_azw01,'occ_file'),
               "                             ON occ01 = rtz06 ",
               "                LEFT OUTER JOIN ",cl_get_target_table(p_azw01,'gec_file'),
               "                             ON gec01 = occ41 AND gec011 = '2' ",
               " ORDER BY lpv13 "
   LET l_sql = l_ins CLIPPED," ",l_sel CLIPPED
   PREPARE prodoha_ins_oha_pre FROM l_sql
   EXECUTE prodoha_ins_oha_pre
   IF SQLCA.sqlcode THEN
      LET g_success = 'N'
      LET g_errno   = SQLCA.sqlcode
      LET g_msg1    = 'Oper:Ins(prod oha)'||' '||'Table:oha_temp'||' '||'Shop:'||p_azw01
      CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
      ROLLBACK WORK                  
      CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
      LET g_msg   = g_msg[1,255]     
      CALL p200_log(g_trans_no,p_azw01,'Batch Operation','05','tg_SaleCard',g_errno,g_msg,'0','N',g_msg1)
      LET g_errno = ''               
      LET g_msg   = ''               
      LET g_msg1  = ''               
      CALL p200_upd_posflag_p('2','lpv_file','tg_SaleCard',p_azw01) #将对应中间库的资料Condition2更新为A
      RETURN
   END IF 
   
   #更新汇率
  #LET l_sql = "SELECT oha23,oha02 FROM oha_temp "          #FUN-CB0103 Mark
   LET l_sql = "SELECT DISTINCT oha23,oha02 FROM oha_temp " #FUN-CB0103 Add
   PREPARE prodoha_sel_oha23_pre FROM l_sql
   DECLARE prodoha_sel_oha23_cs CURSOR FOR prodoha_sel_oha23_pre
   FOREACH prodoha_sel_oha23_cs INTO l_oha23,l_oha02
      CALL s_currm(l_oha23,l_oha02,g_oaz.oaz52,p_azw01) RETURNING l_oha24
      UPDATE oha_temp SET oha24 = l_oha24 WHERE oha23 = l_oha23 AND oha02 = l_oha02
   END FOREACH
   
   LET l_ins = "INSERT INTO ohb_temp( ",
               "                     ohb01, ",            #销退单号
               "                     ohb03, ",            #项次
               "                     ohb04, ",            #产品编号
               "                     ohb05, ",            #销售单位
               "                     ohb05_fac, ",        #销售/库存单位换算率
               "                     ohb06, ",            #品名规格
               "                     ohb08, ",            #销退入库营运中心编号
               "                     ohb09, ",            #销退入库仓库编号
               "                     ohb12, ",            #数量
               "                     ohb13, ",            #原币单价
               "                     ohb14, ",            #原币税前金额
               "                     ohb14t, ",           #原币含税金额
               "                     ohb15, ",            #库存明细单位由厂/仓/位/批自动得出
               "                     ohb15_fac, ",        #销售/库存明细单位换算率
               "                     ohb16, ",            #数量 
               "                     ohb30, ",            #原出货发票号
               "                     ohb31, ",            #出货单号
               "                     ohb32, ",            #出货项次
               "                     ohb33, ",            #订单单号
               "                     ohb34, ",            #订单项次
               "                     ohb37, ",            #基础单价
               "                     ohb40, ",            #抽成编号
               "                     ohb50, ",            #退货理由码
               "                     ohb60, ",            #已开折让数量
               "                     ohb61, ",            #检验
               "                     ohb64, ",            #经营方式 
               "                     ohb65, ",            #原扣率
               "                     ohb66, ",            #新扣率
               "                     ohb67, ",            #分摊折价=全部折价字段值的合计
               "                     ohb68, ",            #有实物否  Y-是,N-否
               "                     ohb69, ",            #摊位编号
               "                     ohb70, ",            #商户编号
               "                     ohb71, ",            #开票性质
               "                     ohb916, ",           #计价单位
               "                     ohb917, ",           #计价数量
               "                     ohb930, ",           #成本中心
               "                     ohb1004, ",          #搭增
               "                     ohb1005, ",          #作业方式
               "                     ohbplant, ",         #所属营运中心
               "                     ohblegal) "          #所属法人
   LET l_sel = "SELECT ",
               "       lpv13, ",                                             #ohb01          #销退单号
               "       ROW_NUMBER() over(partition by lpv13 order by lpv13), ",                #ohb03          #项次
               "       'MISCCARD', ",                                        #ohb04          #产品编号
               "       'PCS', ",                                             #ohb05          #销售单位 
               "       '1', ",                                               #ohb05_fac      #销售/库存单位换算率
               "       NULL, ",                                              #ohb06          #品名规格
               "       lpvplant, ",                                          #ohb08          #销退入库营运中心编号
               "       '",g_rtz07,"', ",                                     #ohb09          #销退入库仓库编号
               "       1, ",                                                 #ohb12          #数量
               "       lpv07, ",                                             #ohb13          #原币单价
              #"       lpv07, ",                                             #ohb14          #原币税前金额    #FUN-D20096 Mark
               "       Uamt, ",                                              #ohb14          #原币税前金额    #FUN-D20096 Add
               "       lpv07, ",                                             #ohb14t         #原币含税金额
               "       'PCS', ",                                             #ohb15          #库存明细单位 
               "       1, ",                                                 #ohb15_fac      #销售/库存明细单位换算率
               "       1, ",                                                 #ohb16          #数量
               "       NULL, ",                                              #ohb30          #原出货发票号
               "       NULL, ",                                              #ohb31          #出货单号
               "       NULL, ",                                              #ohb32          #出货项次
               "       NULL, ",                                              #ohb33          #订单单号
               "       NULL, ",                                              #ohb34          #订单项次
               "       CASE WHEN lpv07 > 0 THEN lpv04 ELSE lpv07 END, ",     #ohb37          #基础单价
               "       NULL, ",                                              #ohb40          #抽成编号
               "       '",g_rcj07,"', ",                                     #ohb50          #退货理由码
               "       0, ",                                                 #ohb60          #已开折让数量
               "       'N', ",                                               #ohb61          #检验
               "       '1', ",                                               #ohb64          #经营方式
               "       100, ",                                               #ohb65          #原扣率
               "       100, ",                                               #ohb66          #新扣率
               "       CASE WHEN lpv07 > 0 THEN lpv04-lpv07 ELSE 0 END, ",   #ohb67          #分摊折价=全部折价字段值的合计
               "       'N', ",                                               #ohb68          #有实物否Y-是,N-否
               "       NULL, ",                                              #ohb69          #摊位编号
               "       NULL, ",                                              #ohb70          #商户编号
               "       NULL, ",                                              #ohb71          #开票性质
               "       'PCS', ",                                             #ohb916         #计价单位
               "       1, ",                                                 #ohb917         #计价数量
               "       NULL, ",                                              #ohb930         #成本中心
               "       'N', ",                                               #ohb1004        #搭增
               "       '1', ",                                               #ohb1005        #作业方式
               "       lpvplant, ",                                          #ohbplant       #所属营运中心
               "       lpvlegal ",                                           #ohblegal       #所属法人
               "  FROM lpv_temp ",
               "  LEFT OUTER JOIN ",g_posdbs,"tg_SaleCard_Detail_Tax",g_db_links,            #FUN-D20096 Add
               "    ON Shop = lpvplant AND lpv15 = SaleCardNO ",                             #FUN-D20096 Add
               " ORDER BY lpv13 "
   LET l_sql = l_ins CLIPPED," ",l_sel CLIPPED
   PREPARE prodoha_ins_ohb_pre FROM l_sql
   EXECUTE prodoha_ins_ohb_pre   
   IF SQLCA.sqlcode THEN         
      LET g_success = 'N'
      LET g_errno   = SQLCA.sqlcode
      LET g_msg1    = 'Oper:Ins(prod oha)'||' '||'Table:ohb_temp'||' '||'Shop:'||p_azw01
      CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
      ROLLBACK WORK                  
      CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
      LET g_msg   = g_msg[1,255]     
      CALL p200_log(g_trans_no,p_azw01,'Batch Operation','05','tg_SaleCard',g_errno,g_msg,'0','N',g_msg1)
      LET g_errno = ''               
      LET g_msg   = ''               
      LET g_msg1  = ''               
      CALL p200_upd_posflag_p('2','lpv_file','tg_SaleCard',p_azw01) #将对应中间库的资料Condition2更新为A
      RETURN
   END IF                        
  


   #FUN-D20096---Add---Str
   #ins ogj_file
   LET l_ins = " INSERT INTO ",cl_get_target_table(p_azw01,'ogj_file'),"(",
               "        ogj01, ",                     #出貨單號
               "        ogj02, ",                     #序號
               "        ogj03, ",                     #稅別
               "        ogj04, ",                     #稅率
               "        ogj05, ",                     #固定稅額
               "        ogj06, ",                     #含稅否
               "        ogj07, ",                     #未稅金額
               "        ogj07t, ",                    #含稅金額
               "        ogj08, ",                     #稅額
               "        ogj09, ",                     #留抵稅額
               "        ogjdate, ",                   #最近修改日
               "        ogjgrup, ",                   #資料所有部門
               "        ogjlegal, ",                  #所屬法人
               "        ogjmodu, ",                   #資料修改者
               "        ogjorig, ",                   #資料建立部門
               "        ogjoriu, ",                   #資料建立者
               "        ogjplant, ",                  #所屬營運中心
               "        ogjuser) "                    #資料所有者

   LET l_sel = "SELECT DISTINCT ",
               "       oha01, ",                      #ogj01    出貨單號
               "       Item, ",                       #ogj02    序號
               "       Taxcode, ",                    #ogj03    稅別
               "       Taxrate, ",                    #ogj04    稅率
               "       0, ",                          #ogj05    固定稅額
               "       Incltax, ",                    #ogj06    含稅否
               "       Uamt, ",                       #ogj07    未稅金額
               "       Amt, ",                        #ogj07t   含稅金額
               "       Tax, ",                        #ogj08    稅額
               "       Acctax, ",                     #ogj09    留抵稅額
               "       ohadate, ",                    #ogjdate  最近修改日
               "       ohagrup, ",                    #ogjgrup  資料所有部門
               "       ohalegal, ",                   #ogjlegal 所屬法人
               "       ohamodu, ",                    #ogjmodu  資料修改者
               "       ohaorig, ",                    #ogjorig  資料建立部門
               "       ohaoriu, ",                    #ogjoriu  資料建立者
               "       Shop, ",                       #ogjplant 所屬營運中心
               "       ohauser ",                     #ogjuser  資料所有者
               "  FROM ",g_posdbs,"tg_SaleCard_Tax",g_db_links,",oha_temp,lpv_temp ",
               " WHERE Shop = '",p_azw01,"' ",
               "   AND lpv15 = SaleCardNO  AND lpv13 = oha01 ",
               " ORDER BY Item "
               
   LET l_sql = l_ins CLIPPED," ",l_sel CLIPPED
   PREPARE prodins_ogj_p_pre FROM l_sql
   EXECUTE prodins_ogj_p_pre
   IF SQLCA.sqlcode THEN
      LET g_success = 'N'
      LET g_errno   = SQLCA.sqlcode
      LET g_msg1    = 'Oper:Ins'||' '||'Table:ogj_file'||' '||'Shop:'||p_azw01
      CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
      ROLLBACK WORK
      CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
      LET g_msg   = g_msg[1,255]
      CALL p200_log(g_trans_no,p_azw01,'Batch Operation','05','tg_SaleCard_Tax',g_errno,g_msg,'0','N',g_msg1)
      LET g_errno = ''  
      LET g_msg   = ''  
      LET g_msg1  = ''  
      CALL p200_upd_posflag_p('2','lpv_file','tg_SaleCard_Tax',p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
      RETURN
   END IF
   #FUN-D20096---Add---End  
                               
   #ins ogk                      
   LET l_ins = "INSERT INTO ",cl_get_target_table(p_azw01,'ogk_file'),"(", 
               "                     ogk01, ",      #銷退單號
               "                     ogk02, ",      #項次
               "                     ogk03, ",      #序號
               "                     ogk04, ",      #稅別
               "                     ogk05, ",      #稅率
               "                     ogk06, ",      #固定稅額
               "                     ogk07, ",      #含稅否
               "                     ogk08, ",      #未稅金額
               "                     ogk08t, ",     #含稅金額
               "                     ogk09, ",      #稅額
               "                     ogkdate, ",    #最近修改日
               "                     ogkgrup, ",    #資料所有部門
               "                     ogklegal, ",   #所屬法人
               "                     ogkmodu, ",    #資料修改者
               "                     ogkorig, ",    #資料建立部門
               "                     ogkoriu, ",    #資料建立者
               "                     ogkplant, ",   #所屬營運中心
               "                     ogkuser) "     #資料所有者
  #FUN-D20096-----Add&Mark-----Str
  #LET l_sel = "SELECT ",        
  #            "       ohb01, ",                                     #ogk01      #銷退單號
  #            "       ohb03, ",                                     #ogk02      #項次
  #            "       ROW_NUMBER() over(partition by ohb01,ohb03 order by ohb01,ohb03), ",   #ogk03      #序號
  #            "       '",l_gec01,"', ",                             #ogk04      #稅別
  #            "       '",l_gec04,"', ",                             #ogk05      #稅率
  #            "       0, ",                                         #ogk06      #固定稅額
  #            "       '",l_gec07,"', ",                             #ogk07      #含稅否
  #            "       ohb12*ohb13, ",                               #ogk08      #未稅金額
  #            "       ohb12*ohb13, ",                               #ogk08t     #含稅金額
  #            "       0, ",                                         #ogk09      #稅額
  #            "       ohadate, ",                                   #ogkdate    #最近修改日
  #            "       ohagrup, ",                                   #ogkgrup    #資料所有部門
  #            "       ohalegal, ",                                  #ogklegal   #所屬法人
  #            "       ohamodu, ",                                   #ogkmodu    #資料修改者
  #            "       ohaorig, ",                                   #ogkorig    #資料建立部門
  #            "       ohaoriu, ",                                   #ogkoriu    #資料建立者
  #            "       ohaplant, ",                                  #ogkplant   #所屬營運中心
  #            "       ohauser ",                                    #ogkuser    #資料所有者
  #            "  FROM ohb_temp LEFT OUTER JOIN oha_temp ON oha01 = ohb01 " 
   LET l_sel = "SELECT DISTINCT ",
               "       oha01, ",                    #ogk01    出貨單號
               "       Item ogk02, ",               #ogk02    項次
               "       Item ogk03, ",               #ogk03    序號
               "       Taxcode, ",                  #ogk04    稅別
               "       Taxrate, ",                  #ogk05    稅率
               "       0, ",                        #ogk06    固定稅額
               "       Incltax, ",                  #ogk07    含稅否
               "       Uamt, ",                     #ogk08    未稅金額
               "       Amt, ",                      #ogk08t   含稅金額
               "       Tax, ",                      #ogk09    稅額
               "       ohadate, ",                  #ogkdate  最近修改日
               "       ohagrup, ",                  #ogkgrup  資料所有部門
               "       ohalegal, ",                 #ogklegal 所屬法人
               "       ohamodu, ",                  #ogkmodu  資料修改者
               "       ohaorig, ",                  #ogkorig  資料建立部門
               "       ohaoriu, ",                  #ogkoriu  資料建立者
               "       Shop, ",                     #ogkplant 所屬營運中心
               "       ohauser ",                   #ogkuser  資料所有者
               "  FROM ",g_posdbs,"tg_SaleCard_Detail_Tax",g_db_links,",oha_temp,lpv_temp ",
               " WHERE Shop = '",p_azw01,"' ",
               "   AND lpv15 = SaleCardNO  AND lpv13 = oha01 ", 
               " ORDER BY ogk03 "
   #FUN-D20096-----Add&Mark-----End
   LET l_sql = l_ins CLIPPED," ",l_sel CLIPPED
   PREPARE prodoha_ins_ogk_pre FROM l_sql
   EXECUTE prodoha_ins_ogk_pre
   IF SQLCA.sqlcode THEN
      LET g_success = 'N'
      LET g_errno   = SQLCA.sqlcode
      LET g_msg1    = 'Oper:Ins(prod oha)'||' '||'Table:ogk_temp'||' '||'Shop:'||p_azw01
      CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
      ROLLBACK WORK
      CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
      LET g_msg   = g_msg[1,255]
     #CALL p200_log(g_trans_no,p_azw01,'Batch Operation','05','tg_SaleCard',g_errno,g_msg,'0','N',g_msg1)              #FUN-D20096 Mark
      CALL p200_log(g_trans_no,p_azw01,'Batch Operation','05','tg_SaleCard_Detail_Tax',g_errno,g_msg,'0','N',g_msg1)   #FUN-D20096 Add
      LET g_errno = ''
      LET g_msg   = ''
      LET g_msg1  = ''
     #CALL p200_upd_posflag_p('2','lpv_file','tg_SaleCard',p_azw01) #将对应中间库的资料Condition2更新为A               #FUN-D20096 Mark
      CALL p200_upd_posflag_p('2','lpv_file','tg_SaleCard_Detail_Tax',p_azw01) #将对应中间库的资料Condition2更新为A    #FUN-D20096 Add
      RETURN
   END IF 
   
   #ins rxc
   LET l_ins = "INSERT INTO rxc_file( ",                                   
               "                     rxc00, ",      #单据别                
               "                     rxc01, ",      #单号                  
               "                     rxc02, ",      #项次
               "                     rxc03, ",      #折价方式
               "                     rxc04, ",      #促销单号
               "                     rxc05, ",      #分类促销单号
               "                     rxc06, ",      #折价金额
               "                     rxc07, ",      #厂商促销分摊比例
               "                     rxc08, ",      #返券促销单号
               "                     rxc09, ",      #返券金额
               "                     rxc10, ",      #厂商返券分摊比例
               "                     rxc11, ",      #是否会员
               "                     rxc12, ",      #结算营运中心
               "                     rxc13, ",      #分摊厂商
               "                     rxc14, ",      #分摊来源单号
               "                     rxc15, ",      #數量-參加促銷的數量
               "                     rxclegal, ",   #法人别
               "                     rxcplant) "    #所属营运中心
   LET l_sel = "SELECT ",
               "       '03', ",                   #rxc00      #单据别
               "       ohb01, ",                  #rxc01      #单号
               "       ohb03, ",                  #rxc02      #项次
               "       '13', ",                   #rxc03      #折价方式
               "       ' ', ",                    #rxc04      #促销单号
               "       NULL, ",                   #rxc05      #分类促销单号
               "       ohb67, ",                  #rxc06      #折价金额
               "       0, ",                      #rxc07      #厂商促销分摊比例
               "       NULL, ",                   #rxc08      #返券促销单号
               "       0, ",                      #rxc09      #返券金额
               "       0, ",                      #rxc10      #厂商返券分摊比例
               "       'N', ",                    #rxc11      #是否会员
               "       NULL, ",                   #rxc12      #结算营运中心
               "       NULL, ",                   #rxc13      #分摊厂商
               "       NULL, ",                   #rxc14      #分摊来源单号
               "       0, ",                      #rxc15      #數量-參加促銷的數量
               "       ohblegal, ",               #rxclegal   #法人别
               "       ohbplant ",                #rxcplant   #所属营运中心
               "  FROM ohb_temp ",
               " WHERE ohb67 > 0 "
   LET l_sql = l_ins CLIPPED," ",l_sel CLIPPED
   PREPARE prodoha_ins_rxc_file_pre FROM l_sql
   EXECUTE prodoha_ins_rxc_file_pre
   IF SQLCA.sqlcode THEN
      LET g_success = 'N'
      LET g_errno   = SQLCA.sqlcode
      LET g_msg1    = 'Oper:Ins(prod oha)'||' '||'Table:rxc_temp'||' '||'Shop:'||p_azw01
      CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
      ROLLBACK WORK
      CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
      LET g_msg   = g_msg[1,255]
      CALL p200_log(g_trans_no,p_azw01,'Batch Operation','05','tg_SaleCard',g_errno,g_msg,'0','N',g_msg1)
      LET g_errno = ''
      LET g_msg   = ''
      LET g_msg1  = ''
      CALL p200_upd_posflag_p('2','lpv_file','tg_SaleCard',p_azw01) #将对应中间库的资料Condition2更新为A
      RETURN
   END IF
   
   #ins rxy
   LET l_ins = "INSERT INTO rxy_temp( ",
               "                     rxy00, ",     #单据别
               "                     rxy01, ",     #单号
               "                     rxy02, ",     #项次
               "                     rxy03, ",     #款别
               "                     rxy04, ",     #款别类型
               "                     rxy05, ",     #交款金额
               "                     rxy06, ",     #卡号/票号/账号/待抵单号
               "                     rxy07, ",     #刷卡手续费率
               "                     rxy08, ",     #刷卡手续费额
               "                     rxy09, ",     #支票面额
               "                     rxy10, ",     #出票日期
               "                     rxy11, ",     #出票单位
               "                     rxy12, ",     #卡券种类编号
               "                     rxy13, ",     #券面额编号
               "                     rxy14, ",     #券起始编号
               "                     rxy15, ",     #券终止编号
               "                     rxy16, ",     #券数量
               "                     rxy17, ",     #票券溢交款金额
               "                     rxy18, ",     #退款类型
               "                     rxy19, ",     #冲预收款类型
               "                     rxy20, ",     #固定手续费
               "                     rxy21, ",     #交款日期
               "                     rxy22, ",     #交款时间
               "                     rxy23, ",     #抵现积分
               "                     rxy30, ",     #POS款别 
               "                     rxy31, ",     #销售单号
               "                     rxy32, ",     #项次
               "                     rxy33, ",     #冲预收否
               "                     rxylegal, ",  #法人别
               "                     rxyplant) "   #所属营运中心
   LET l_sel = "SELECT ",
               "       '03', ",                  #rxy00     #单据别
               "       lpv13, ",                 #rxy01     #单号
               "       rxy02, ",                 #rxy02     #项次
               "       rxy03, ",                 #rxy03     #款别
               "       rxy04, ",                 #rxy04     #款别类型
               "       rxy05, ",                 #rxy05     #交款金额 
               "       rxy06, ",                 #rxy06     #卡号/票号/账号/待抵单号
               "       rxy07, ",                 #rxy07     #刷卡手续费率
               "       rxy08, ",                 #rxy08     #刷卡手续费额
               "       rxy09, ",                 #rxy09     #支票面额
               "       rxy10, ",                 #rxy10     #出票日期
               "       rxy11, ",                 #rxy11     #出票单位
               "       rxy12, ",                 #rxy12     #卡券种类编号
               "       rxy13, ",                 #rxy13     #券面额编号
               "       rxy14, ",                 #rxy14     #券起始编号
               "       rxy15, ",                 #rxy15     #券终止编号
               "       rxy16, ",                 #rxy16     #券数量
               "       rxy17, ",                 #rxy17     #票券溢交款金额
               "       rxy18, ",                 #rxy18     #退款类型
               "       rxy19, ",                 #rxy19     #冲预收款类型
               "       rxy20, ",                 #rxy20     #固定手续费
               "       rxy21, ",                 #rxy21     #交款日期
               "       rxy22, ",                 #rxy22     #交款时间
               "       rxy23, ",                 #rxy23     #抵现积分
               "       rxy30, ",                 #rxy30     #POS款别
               "       rxy31, ",                 #rxy31     #销售单号
               "       rxy32, ",                 #rxy32     #项次
               "       rxy33, ",                 #rxy33     #冲预收否
               "       rxylegal, ",              #rxylegal  #法人别
               "       rxyplant ",               #rxyplant  #所属营运中心
               "  FROM rxy_temp,lpv_temp ",
               " WHERE rxy01 = lpv01 "
   LET l_sql = l_ins CLIPPED," ",l_sel CLIPPED
   PREPARE prodoha_ins_rxy_temp_pre FROM l_sql
   EXECUTE prodoha_ins_rxy_temp_pre
   IF SQLCA.sqlcode THEN
      LET g_success = 'N'
      LET g_errno   = SQLCA.sqlcode
      LET g_msg1    = 'Oper:Ins(prod oha)'||' '||'Table:rxy_temp'||' '||'Shop:'||p_azw01
      CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
      ROLLBACK WORK
      CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
      LET g_msg   = g_msg[1,255]
      CALL p200_log(g_trans_no,p_azw01,'Batch Operation','05','tg_SaleCard',g_errno,g_msg,'0','N',g_msg1)
      LET g_errno = ''
      LET g_msg   = ''
      LET g_msg1  = ''
      CALL p200_upd_posflag_p('2','lpv_file','tg_SaleCard',p_azw01) #将对应中间库的资料Condition2更新为A
      RETURN
   END IF
   
   #ins rxx
   LET l_ins = "INSERT INTO rxx_temp( ",
               "                     rxx00, ",       #单据别
               "                     rxx01, ",       #单号
               "                     rxx02, ",       #款别
               "                     rxx03, ",       #款别类型
               "                     rxx04, ",       #交款金额
               "                     rxx05, ",       #溢交款金额
               "                     rxx11, ",       #销售单号
               "                     rxxlegal, ",    #法人别
               "                     rxxplant) "     #所属营运中心
   LET l_sel = "SELECT ",
               "       '03', ",                   #rxx00      #单据别
               "       lpv13, ",                  #rxx01      #单号
               "       rxx02, ",                  #rxx02      #款别
               "       rxx03, ",                  #rxx03      #款别类型
               "       rxx04, ",                  #rxx04      #交款金额
               "       rxx05, ",                  #rxx05      #溢交款金额
               "       rxx11, ",                  #rxx11      #销售单号
               "       rxxlegal, ",               #rxxlegal   #法人别
               "       rxxplant ",                #rxxplant   #所属营运中心
               "  FROM rxx_temp,lpv_temp ",
               " WHERE rxx01 = lpv01 "
   LET l_sql = l_ins CLIPPED," ",l_sel CLIPPED
   PREPARE prodoha_ins_rxx_temp_pre FROM l_sql   
   EXECUTE prodoha_ins_rxx_temp_pre              
   IF SQLCA.sqlcode THEN
      LET g_success = 'N'
      LET g_errno   = SQLCA.sqlcode
      LET g_msg1    = 'Oper:Ins(prod oha)'||' '||'Table:rxx_temp'||' '||'Shop:'||p_azw01
      CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
      ROLLBACK WORK
      CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
      LET g_msg   = g_msg[1,255]
      CALL p200_log(g_trans_no,p_azw01,'Batch Operation','05','tg_SaleCard',g_errno,g_msg,'0','N',g_msg1)
      LET g_errno = ''
      LET g_msg   = ''
      LET g_msg1  = ''
      CALL p200_upd_posflag_p('2','lpv_file','tg_SaleCard',p_azw01) #将对应中间库的资料Condition2更新为A
      RETURN
   END IF      
   
   #ins rxz   
   LET l_ins = "INSERT INTO rxz_temp( ",         
               "                     rxz00, ",      #单据别 
               "                     rxz01, ",      #单号   
               "                     rxz02, ",      #款别类型
               "                     rxz03, ",      #刷卡序号
               "                     rxz04, ",      #卡号   
               "                     rxz05, ",      #刷卡金额
               "                     rxz06, ",      #刷卡日期
               "                     rxz07, ",      #刷卡时间
               "                     rxz08, ",      #刷卡人员
               "                     rxz09, ",      #刷卡手续费额
               "                     rxz10, ",      #刷卡手续费率
               "                     rxz11, ",      #银行名称
               "                     rxz12, ",      #银行注册否
               "                     rxz13, ",      #状态
               "                     rxz14, ",      #状态说明
               "                     rxz15, ",      #固定手续费
               "                     rxz20, ",      #卡类型
               "                     rxz21, ",      #销售单号
               "                     rxzlegal, ",   #法人别
               "                     rxzplant) "    #所属营运中心
   LET l_sel = "SELECT ",            
               "       '03', ",                   #rxz00      #单据别
               "       lpv13, ",                  #rxz01      #单号
               "       rxz02, ",                  #rxz02      #款别类型
               "       rxz03, ",                  #rxz03      #刷卡序号
               "       rxz04, ",                  #rxz04      #卡号
               "       rxz05, ",                  #rxz05      #刷卡金额
               "       rxz06, ",                  #rxz06      #刷卡日期
               "       rxz07, ",                  #rxz07      #刷卡时间
               "       rxz08, ",                  #rxz08      #刷卡人员
               "       rxz09, ",                  #rxz09      #刷卡手续费额
               "       rxz10, ",                  #rxz10      #刷卡手续费率
               "       rxz11, ",                  #rxz11      #银行名称
               "       rxz12, ",                  #rxz12      #银行注册否
               "       rxz13, ",                  #rxz13      #状态
               "       rxz14, ",                  #rxz14      #状态说明
               "       rxz15, ",                  #rxz15      #固定手续费
               "       rxz20, ",                  #rxz20      #卡类型
               "       rxz21, ",                  #rxz21      #销售单号
               "       rxzlegal, ",               #rxzlegal   #法人别
               "       rxzplant ",                #rxzplant   #所属营运中心
               "  FROM rxz_temp,lpv_temp ",
               " WHERE rxz01 = lpv01 "
   LET l_sql = l_ins CLIPPED," ",l_sel CLIPPED
   PREPARE prodoha_ins_rxz_temp_pre FROM l_sql
   EXECUTE prodoha_ins_rxz_temp_pre
   IF SQLCA.sqlcode THEN
      LET g_success = 'N'
      LET g_errno   = SQLCA.sqlcode
      LET g_msg1    = 'Oper:Ins(prod oha)'||' '||'Table:rxz_temp'||' '||'Shop:'||p_azw01
      CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
      ROLLBACK WORK
      CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
      LET g_msg   = g_msg[1,255]
      CALL p200_log(g_trans_no,p_azw01,'Batch Operation','05','tg_SaleCard',g_errno,g_msg,'0','N',g_msg1)
      LET g_errno = ''
      LET g_msg   = ''
      LET g_msg1  = ''
      CALL p200_upd_posflag_p('2','lpv_file','tg_SaleCard',p_azw01) #将对应中间库的资料Condition2更新为A
      RETURN
   END IF

END FUNCTION
#FUN-CA0160 Add End -----

#FUN-CA0160 Add Begin ---

# Descriptions...: 卡券付款资料上传
# Input Parameter: p_gat01:  上传主表
#                  p_azw01:  营运中心
# Usage..........: CALL p200_cardcoupon_xyz_ins_p('lps_file',p_azw01)

FUNCTION p200_cardcoupon_xyz_ins_p(p_gat01,p_azw01)
DEFINE p_gat01    LIKE gat_file.gat01
DEFINE p_doctype  LIKE rxx_file.rxx00       #單據別
DEFINE p_paytype  LIKE rxx_file.rxx03       #款別類型1收款/-1退款
DEFINE p_azw01    LIKE azw_file.azw01
DEFINE l_ins      STRING
DEFINE l_sel      STRING
DEFINE l_sql      STRING
DEFINE p_sdate    LIKE type_file.chr50
DEFINE p_stime    LIKE type_file.chr50
DEFINE p_rxy12    LIKE type_file.chr50
DEFINE p_num      LIKE type_file.chr1
DEFINE p_rxy06    STRING
DEFINE l_ryl04    LIKE ryl_file.ryl04
DEFINE l_ryl05    LIKE ryl_file.ryl05
DEFINE l_ryk03    LIKE ryk_file.ryk03
DEFINE l_lqe01    LIKE lqe_file.lqe01
DEFINE l_lqe19    LIKE lqe_file.lqe19
DEFINE l_field    RECORD
       rxy01      LIKE type_file.chr100,
       rxyplant   LIKE type_file.chr100,
       rxylegal   LIKE type_file.chr100,
       rxz01      LIKE type_file.chr100,
       rxz08      LIKE type_file.chr100,
       rxzlegal   LIKE type_file.chr100
                  END RECORD
DEFINE l_rxy_from STRING
DEFINE l_rxx_from STRING
DEFINE l_rxz_from STRING
DEFINE l_lqe_from STRING

   LET g_time = TIME                  #CURRENT TIME

   IF p_azw01 IS NULL THEN RETURN END IF
   LET l_sql = ''
   LET l_sel = ''
   LET l_ins = ''

   CASE p_gat01

      WHEN "oga_file"           #售券
         LET p_doctype = '02'
         LET p_paytype = '1'
         LET p_sdate   = "CAST (sdate AS DATE)"
         LET p_stime   = "stime[1,2]||':'||stime[3,4]||':'||stime[5,6]"
         LET l_ryl04   = '05'
         LET l_ryl05   = 'tg_SaleCoupon_Pay'
         LET l_ryk03   = 'tg_SaleCoupon'
         LET l_field.rxy01    = "oga01"      #单号
         LET l_field.rxyplant = "ogaplant"   #所属营运中心
         LET l_field.rxylegal = "ogalegal"   #所属法人
         LET l_field.rxz01    = "oga01"      #单号
         LET l_field.rxz08    = "ogauser"    #刷卡人员
         LET l_field.rxzlegal = "ogalegal"   #所属法人
         LET l_rxy_from = "  FROM ",g_posdbs,"tg_SaleCoupon_pay",g_db_links,",oga_temp ",
                          " WHERE Shop = '",p_azw01,"' ",
                          "   AND Cnfflg ='Y' AND SaleCouponno = oga98 ",
                          " ORDER BY oga01,Item "
         LET l_rxx_from = "  FROM rxy_temp,oga_temp ",
                          " WHERE rxy00 = '",p_doctype,"' AND rxyplant = ogaplant ",
                          "   AND rxy01 = oga01 ",
                          " GROUP BY rxy00,rxy01,rxy03,rxy04,rxylegal,rxyplant "
         LET l_rxz_from = "  FROM ",g_posdbs,"tg_SaleCoupon_pay",g_db_links,",oga_temp ",
                          " WHERE Shop = '",p_azw01,"' ",            
                          "   AND SaleCouponno = oga98 AND Cnfflg = 'Y' ",
                          "   AND Paycodeerp IN ('02','05','06') ",  
                          " ORDER BY oga01,item "

      WHEN "oha_file"           #退券
         LET p_doctype = '03'
         LET p_paytype = '-1'
         LET p_sdate   = "CAST (sdate AS DATE)"
         LET p_stime   = "stime[1,2]||':'||stime[3,4]||':'||stime[5,6]"
         LET l_ryl04   = '05'
         LET l_ryl05   = 'tg_SaleCoupon_Pay'
         LET l_ryk03   = 'tg_SaleCoupon'
         LET l_field.rxy01    = "oha01"      #单号
         LET l_field.rxyplant = "ohaplant"   #所属营运中心
         LET l_field.rxylegal = "ohalegal"   #所属法人
         LET l_field.rxz01    = "oha01"      #单号
         LET l_field.rxz08    = "ohauser"    #刷卡人员
         LET l_field.rxzlegal = "ohalegal"   #所属法人
         LET l_rxy_from = "  FROM ",g_posdbs,"tg_SaleCoupon_pay",g_db_links,",oha_temp ",
                          " WHERE Shop = '",p_azw01,"' ",
                          "   AND Cnfflg ='Y' AND SaleCouponno = oha98 ",
                          " ORDER BY oha01,Item "
         LET l_rxx_from = "  FROM rxy_temp,oha_temp ",
                          " WHERE rxy00 = '",p_doctype,"' AND rxyplant = ohaplant ",
                          "   AND rxy01 = oha01 ",
                          " GROUP BY rxy00,rxy01,rxy03,rxy04,rxylegal,rxyplant "
         LET l_rxz_from = "  FROM ",g_posdbs,"tg_SaleCoupon_pay",g_db_links,",oha_temp ",
                          " WHERE Shop = '",p_azw01,"' ",            
                          "   AND SaleCouponno = oha98 AND Cnfflg = 'Y' ",
                          "   AND Paycodeerp IN ('02','05','06') ",  
                          " ORDER BY oha01,item "
         
      WHEN "lps_file"           #售卡
         LET p_doctype = '20' 
         LET p_paytype = '1' 
         LET p_sdate   = "CAST (sdate AS DATE)" 
         LET p_stime   = "stime[1,2]||':'||stime[3,4]||':'||stime[5,6]"
         LET l_ryl04   = '04'
         LET l_ryl05   = 'tg_SaleCard_Pay'
         LET l_ryk03   = 'tg_SaleCard'
         LET l_field.rxy01    = "lps01"      #单号
         LET l_field.rxyplant = "lpsplant"   #所属营运中心
         LET l_field.rxylegal = "lpslegal"   #所属法人
         LET l_field.rxz01    = "lps01"      #单号
         LET l_field.rxz08    = "lpsuser"    #刷卡人员
         LET l_field.rxzlegal = "lpslegal"   #所属法人
         LET l_rxy_from = "  FROM ",g_posdbs,"tg_SaleCard_pay",g_db_links,",lps_temp ",
                          " WHERE Shop = '",p_azw01,"' ",
                          "   AND Cnfflg ='Y' AND SaleCardno = lps18 ",
                          " ORDER BY lps01,Item "
         LET l_rxx_from = "  FROM rxy_temp,lps_temp ",
                          " WHERE rxy00 = '",p_doctype,"' AND rxyplant = lpsplant ",
                          "   AND rxy01 = lps01 ",
                          " GROUP BY rxy00,rxy01,rxy03,rxy04,rxylegal,rxyplant "
         LET l_rxz_from = "  FROM ",g_posdbs,"tg_SaleCard_pay",g_db_links,",lps_temp ",
                          " WHERE Shop = '",p_azw01,"' ",            
                          "   AND SaleCardno = lps18 AND Cnfflg = 'Y' ",
                          "   AND Paycodeerp IN ('02','05','06') ",  
                          " ORDER BY lps01,item "

      WHEN "lpu_file"           #储值
         LET p_doctype = '21' 
         LET p_paytype = '1' 
         LET p_sdate   = "CAST (sdate AS DATE)" 
         LET p_stime   = "stime[1,2]||':'||stime[3,4]||':'||stime[5,6]"
         LET l_ryl04   = '04'
         LET l_ryl05   = 'tg_Recharge_Pay'
         LET l_ryk03   = 'tg_Recharge'
         LET l_field.rxy01    = "lpu01"      #单号
         LET l_field.rxyplant = "lpuplant"   #所属营运中心
         LET l_field.rxylegal = "lpulegal"   #所属法人
         LET l_field.rxz01    = "lpu01"      #单号
         LET l_field.rxz08    = "lpuuser"    #刷卡人员
         LET l_field.rxzlegal = "lpulegal"   #所属法人
         LET l_rxy_from = "  FROM ",g_posdbs,"tg_Recharge_Pay",g_db_links,",lpu_temp ",
                          " WHERE Shop = '",p_azw01,"' ",
                          "   AND Cnfflg ='Y' AND Rechargeno = lpu17 ",
                          " ORDER BY lpu01,Item "
         LET l_rxx_from = "  FROM rxy_temp,lpu_temp ",
                          " WHERE rxy00 = '",p_doctype,"' AND rxyplant = lpuplant ",
                          "   AND rxy01 = lpu01 ",
                          " GROUP BY rxy00,rxy01,rxy03,rxy04,rxylegal,rxyplant "
         LET l_rxz_from = "  FROM ",g_posdbs,"tg_Recharge_Pay",g_db_links,",lpu_temp ",
                          " WHERE Shop = '",p_azw01,"' ",            
                          "   AND Rechargeno = lpu17 AND Cnfflg = 'Y' ",
                          "   AND Paycodeerp IN ('02','05','06') ",  
                          " ORDER BY lpu01,item "

      WHEN "lpv_file"           #退卡
         LET p_doctype = '22' 
         LET p_paytype = '-1' 
         LET p_sdate   = "CAST (sdate AS DATE)" 
         LET p_stime   = "stime[1,2]||':'||stime[3,4]||':'||stime[5,6]"
         LET l_ryl04   = '04'
         LET l_ryl05   = 'tg_SaleCard_Pay'
         LET l_ryk03   = 'tg_SaleCard'
         LET l_field.rxy01    = "lpv01"      #单号
         LET l_field.rxyplant = "lpvplant"   #所属营运中心
         LET l_field.rxylegal = "lpvlegal"   #所属法人
         LET l_field.rxz01    = "lpv01"      #单号
         LET l_field.rxz08    = "lpvuser"    #刷卡人员
         LET l_field.rxzlegal = "lpvlegal"   #所属法人
         LET l_rxy_from = "  FROM ",g_posdbs,"tg_SaleCard_Pay",g_db_links,",lpv_temp ",
                          " WHERE Shop = '",p_azw01,"' ",
                          "   AND Cnfflg ='Y' AND SaleCardno = lpv15 ",
                          " ORDER BY lpv01,Item "
         LET l_rxx_from = "  FROM rxy_temp,lpv_temp ",
                          " WHERE rxy00 = '",p_doctype,"' AND rxyplant = lpvplant ",
                          "   AND rxy01 = lpv01 ",
                          " GROUP BY rxy00,rxy01,rxy03,rxy04,rxylegal,rxyplant "
         LET l_rxz_from = "  FROM ",g_posdbs,"tg_SaleCard_Pay",g_db_links,",lpv_temp ",
                          " WHERE Shop = '",p_azw01,"' ",            
                          "   AND SaleCardno = lpv15 AND Cnfflg = 'Y' ",
                          "   AND Paycodeerp IN ('02','05','06') ",  
                          " ORDER BY lpv01,item "

      WHEN "lrw_file"           #换卡
         LET p_doctype = '23' #FUN-D10040 Mod
         LET p_paytype = '1' 
         LET p_sdate   = "CAST (sdate AS DATE)" 
         LET p_stime   = "stime[1,2]||':'||stime[3,4]||':'||stime[5,6]"
         LET l_ryl04   = '04'
         LET l_ryl05   = 'tg_ChangeCard_Pay'
         LET l_ryk03   = 'tg_ChangeCard'
         LET l_field.rxy01    = "lrw01"      #单号
         LET l_field.rxyplant = "lrwplant"   #所属营运中心
         LET l_field.rxylegal = "lrwlegal"   #所属法人
         LET l_field.rxz01    = "lrw01"      #单号
         LET l_field.rxz08    = "lrwuser"    #刷卡人员
         LET l_field.rxzlegal = "lrwlegal"   #所属法人
         LET l_rxy_from = "  FROM ",g_posdbs,"tg_ChangeCard_Pay",g_db_links,",lrw_temp ",
                          " WHERE Shop = '",p_azw01,"' ",
                          "   AND Cnfflg ='Y' AND ChangeCardno = lrw25 ",
                          " ORDER BY lrw01,Item "
         LET l_rxx_from = "  FROM rxy_temp,lrw_temp ",
                          " WHERE rxy00 = '",p_doctype,"' AND rxyplant = lrwplant ",
                          "   AND rxy01 = lrw01 ",
                          " GROUP BY rxy00,rxy01,rxy03,rxy04,rxylegal,rxyplant "
         LET l_rxz_from = "  FROM ",g_posdbs,"tg_ChangeCard_Pay",g_db_links,",lrw_temp ",
                          " WHERE Shop = '",p_azw01,"' ",            
                          "   AND ChangeCardno = lrw25 AND Cnfflg = 'Y' ",
                          "   AND Paycodeerp IN ('02','05','06') ",  
                          " ORDER BY lrw01,item "
         
   END CASE
         
   #rxy_file 交款明細表
   LET l_ins = " INSERT INTO rxy_temp( ",    
               " rxy00    ,",                             #單據別
               " rxy01    ,",                             #單號
               " rxy02    ,",                             #項次
               " rxy03    ,",                             #款別
               " rxy04    ,",                             #款別類型
               " rxy05    ,",                             #交款金額
               " rxy06    ,",                             #卡號/票號/帳號
               " rxy07    ,",                             #刷卡手續費率  
               " rxy08    ,",                             #刷卡手續費額
               " rxy09    ,",                             #支票面額
               " rxy10    ,",                             #出票日期
               " rxy11    ,",                             #出票單位
               " rxy12    ,",                             #卡券種類編號
               " rxy13    ,",                             #券面額編號
               " rxy14    ,",                             #券起始編號
               " rxy15    ,",                             #券終止編號
               " rxy16    ,",                             #券數量
               " rxy17    ,",                             #票券溢交款金額
               " rxy18    ,",                             #退款類型
               " rxy19    ,",                             #沖預收款類型
               " rxy20    ,",                             #固定手續費
               " rxy21    ,",                             #交款日期
               " rxy22    ,",                             #交款時間
               " rxy30    ,",                             #POS款別
               " rxy31    ,",                             #銷售單號
               " rxylegal ,",                             #所屬法人
               " rxyplant ,",                             #所屬營運中心
               " rxy33    ,",                             #冲预收否
               " rxy23    )"                              #抵現積分


   LET l_sel = " SELECT DISTINCT ",
               " '",p_doctype,"', ",                                                          #rxy00    單據別
               " ",l_field.rxy01,", ",                                                        #rxy01    單號
               " item, ",                                                                     #rxy02    項次
               " paycodeerp, ",                                                               #rxy03    款別
               " '",p_paytype,"', ",                                                          #rxy04    款別類型
               " pay-extra-changed, ",                                                        #rxy05    交款金額
               " paysernum, ",                                                                #rxy06    卡號/票號/帳號
               " '0', ",                                                                      #rxy07    刷卡手續費率
               " '0', ",                                                                      #rxy08    刷卡手續費額
               " CASE paycodeerp WHEN CAST('03' AS NVARCHAR2(20)) THEN pay ELSE null END CASE, ",              #rxy09    支票面額 
               " '', ",                                                                       #rxy10    出票日期
               " '', ",                                                                       #rxy11    出票單位
               " cttype, ",                                                                   #rxy12    卡券種類編號
               " CASE paycodeerp WHEN CAST('04' AS NVARCHAR2(20)) THEN pay ELSE null END CASE, ",              #rxy13    券面額編號
               " CASE paycodeerp WHEN CAST('04' AS NVARCHAR2(20)) THEN paysernum ELSE null END CASE, ", #rxy14    券起始編號
               " CASE paycodeerp WHEN CAST('04' AS NVARCHAR2(20)) THEN paysernum ELSE null END CASE, ", #rxy15    券終止編號
               " CASE paycodeerp WHEN CAST('04' AS NVARCHAR2(20)) THEN '1' ELSE '0' END CASE,",    #rxy16    券數量
               " extra, ",                                                                    #rxy17    票券溢交款金額
               " CASE paycodeerp WHEN CAST('02' AS NVARCHAR2(20)) THEN 'T' WHEN CAST('03' AS NVARCHAR2(20)) THEN 'T' ELSE '' END CASE ,",   #rxy18    退款類型
               " CASE paycodeerp WHEN CAST('07' AS NVARCHAR2(20)) THEN '1' ELSE '' END CASE   ,",  #rxy19    沖預收款類型 
               " '0', ",                                                                      #rxy20    固定手續費
               " ",p_sdate,", ",                                                              #rxy21    交款日期
               " ",p_stime,", ",                                                              #rxy22    交款時間
               " paycode, ",                                                                  #rxy30    POS款別
               " '', ",                                                                       #rxy31    銷售單號
               " ",l_field.rxylegal," ,",                                                     #rxylegal 所屬法人
               " shop, ",                                                                     #rxyplant 所屬營運中心
               " 'N', ",                                                                      #rxy33    冲预收否
               " descore "                                                                    #rxy23    抵現積分
               
   LET l_sql = l_ins CLIPPED," ",l_sel CLIPPED,l_rxy_from CLIPPED
   PREPARE cardcoupon_ins_rxy_temp_pre FROM l_sql
   EXECUTE cardcoupon_ins_rxy_temp_pre
   IF SQLCA.sqlcode THEN  
      LET g_success = 'N'
      LET g_errno   = SQLCA.sqlcode
      LET g_msg1    = 'Oper:Ins'||' '||'Table:rxy_temp'||' '||'Shop:'||p_azw01
      CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)                             
      ROLLBACK WORK
      CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg                                          
      LET g_msg   = g_msg[1,255]                                                              
      CALL p200_log(g_trans_no,p_azw01,'Batch Operation',l_ryl04,l_ryl05,g_errno,g_msg,'0','N',g_msg1)
      LET g_errno = ''
      LET g_msg   = ''
      LET g_msg1  = ''
      CALL p200_upd_posflag_p('2',p_gat01,l_ryk03,p_azw01) #将oga_temp对应中间库的资料Condition2更新为A 
      RETURN   
   END IF
   CASE p_gat01
      WHEN "oga_file"
         LET l_sql = "UPDATE ",cl_get_target_table(p_azw01,'lqe_file'),
                     #"   SET (lqe17,lqe18,lqe19) = ",                #FUN-D10040 mark
                     "   SET (lqe17,lqe24,lqe25) = ",                 #FUN-D10040 add
                     "       (SELECT '4',ogaplant,oga02 FROM ",g_posdbs,"tg_SaleCoupon_Pay",g_db_links,",oga_temp",
                     "         WHERE Shop = ogaplant AND SaleCouponno = oga98 AND lqe01 = Paysernum AND Paycodeerp = '04') ",
                     " WHERE EXISTS (SELECT 1 FROM ",g_posdbs,"tg_SaleCoupon_Pay",g_db_links,",oga_temp",
                     "                WHERE Paysernum = lqe01 ",
                     "                  AND Shop = ogaplant AND SaleCouponno = oga98 ",
                     "                  AND Paycodeerp = '04' AND isverification = 'N') "
      WHEN "oha_file"
         LET l_sql = "UPDATE ",cl_get_target_table(p_azw01,'lqe_file'),
                     #"   SET (lqe17,lqe18,lqe19) = ",                #FUN-D10040 mark
                     "   SET (lqe17,lqe24,lqe25) = ",                 #FUN-D10040 add
                     "       (SELECT '4',ohaplant,oha02 FROM ",g_posdbs,"tg_SaleCoupon_Pay",g_db_links,",oha_temp",
                     "         WHERE Shop = ohaplant AND SaleCouponno = oha98 AND lqe01 = Paysernum AND Paycodeerp = '04') ",
                     " WHERE EXISTS (SELECT 1 FROM ",g_posdbs,"tg_SaleCoupon_Pay",g_db_links,",oha_temp",
                     "                WHERE Paysernum = lqe01 ",
                     "                  AND Shop = ohaplant AND SaleCouponno = oha98 ",
                     "                  AND Paycodeerp = '04' AND isverification = 'N') "
      WHEN "lps_file"
         LET l_sql = "UPDATE ",cl_get_target_table(p_azw01,'lqe_file'),
                     #"   SET (lqe17,lqe18,lqe19) = ",                #FUN-D10040 mark
                     "   SET (lqe17,lqe24,lqe25) = ",                 #FUN-D10040 add
                     "       (SELECT '4',lpsplant,lps03 FROM ",g_posdbs,"tg_SaleCard_Pay",g_db_links,",lps_temp",
                     "         WHERE Shop = lpsplant AND SaleCardno = lps18 AND lqe01 = Paysernum AND Paycodeerp = '04') ",
                     " WHERE EXISTS (SELECT 1 FROM ",g_posdbs,"tg_SaleCard_Pay",g_db_links,",lps_temp",
                     "                WHERE Paysernum = lqe01 ",
                     "                  AND Shop = lpsplant AND SaleCardno = lps18 ",
                     "                  AND Paycodeerp = '04' AND isverification = 'N') "
      WHEN "lpu_file"
         LET l_sql = "UPDATE ",cl_get_target_table(p_azw01,'lqe_file'),
                     #"   SET (lqe17,lqe18,lqe19) = ",                #FUN-D10040 mark
                     "   SET (lqe17,lqe24,lqe25) = ",                 #FUN-D10040 add
                     "       (SELECT '4',lpuplant,lpu10 FROM ",g_posdbs,"tg_Recharge_Pay",g_db_links,",lpu_temp",
                     "         WHERE Shop = lpuplant AND Rechargeno = lpu17 AND lqe01 = Paysernum AND Paycodeerp = '04') ",
                     " WHERE EXISTS (SELECT 1 FROM ",g_posdbs,"tg_Recharge_Pay",g_db_links,",lpu_temp",
                     "                WHERE Paysernum = lqe01 ",
                     "                  AND Shop = lpuplant AND Rechargeno = lpu17 ",
                     "                  AND Paycodeerp = '04' AND isverification = 'N') "
      WHEN "lpv_file"
         LET l_sql = "UPDATE ",cl_get_target_table(p_azw01,'lqe_file'),
                     #"   SET (lqe17,lqe18,lqe19) = ",                #FUN-D10040 mark
                     "   SET (lqe17,lqe24,lqe25) = ",                 #FUN-D10040 add
                     "       (SELECT '4',lpvplant,lpv10 FROM ",g_posdbs,"tg_SaleCard_Pay",g_db_links,",lpv_temp",
                     "         WHERE Shop = lpvplant AND SaleCardno = lpv15 AND lqe01 = Paysernum AND Paycodeerp = '04') ",
                     " WHERE EXISTS (SELECT 1 FROM ",g_posdbs,"tg_SaleCard_Pay",g_db_links,",lpv_temp",
                     "                WHERE Paysernum = lqe01 ",
                     "                  AND Shop = lpvplant AND SaleCardno = lpv15 ",
                     "                  AND Paycodeerp = '04' AND isverification = 'N') "
      WHEN "lrw_file"
         LET l_sql = "UPDATE ",cl_get_target_table(p_azw01,'lqe_file'),
                     #"   SET (lqe17,lqe18,lqe19) = ",                #FUN-D10040 mark
                     "   SET (lqe17,lqe24,lqe25) = ",                 #FUN-D10040 add
                     "       (SELECT '4',lrwplant,lrw15 FROM ",g_posdbs,"tg_ChangeCard_Pay",g_db_links,",lrw_temp",
                     "         WHERE Shop = lrwplant AND ChangeCardno = lrw25 AND lqe01 = Paysernum AND Paycodeerp = '04') ",
                     " WHERE EXISTS (SELECT 1 FROM ",g_posdbs,"tg_ChangeCard_Pay",g_db_links,",lrw_temp",
                     "                WHERE Paysernum = lqe01 ",
                     "                  AND Shop = lrwplant AND ChangeCardno = lrw25 ",
                     "                  AND Paycodeerp = '04' AND isverification = 'N') "
   END CASE
   
   CALL cl_replace_sqldb(l_sql) RETURNING l_sql
   CALL cl_parse_qry_sql(l_sql,p_azw01) RETURNING l_sql
   PREPARE cardcoupon_upd_lqe_p_pre FROM l_sql
   EXECUTE cardcoupon_upd_lqe_p_pre
   IF SQLCA.sqlcode THEN
      LET g_success = 'N'
      LET g_errno   = SQLCA.sqlcode
      #LET g_msg1    = 'Oper:Upd'||' '||'Table:lqe_file'||' '||'Field:(lqe17/lqe18/lae19)'||' '||'Shop:'||p_azw01   #FUN-D10040 mark
      LET g_msg1    = 'Oper:Upd'||' '||'Table:lqe_file'||' '||'Field:(lqe17/lqe24/lqe25)'||' '||'Shop:'||p_azw01    #FUN-D10040 add
      CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
      ROLLBACK WORK
      CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
      LET g_msg   = g_msg[1,255]
      CALL p200_log(g_trans_no,p_azw01,'Batch Operation',l_ryl04,l_ryl05,g_errno,g_msg,'0','N',g_msg1)
      LET g_errno = ''    
      LET g_msg   = ''    
      LET g_msg1  = ''
      CALL p200_upd_posflag_p('2',p_gat01,l_ryk03,p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
      RETURN
   END IF
  
   #rxx_file  交款匯總表
   LET l_ins = " INSERT INTO rxx_temp( ",
               " rxx00   ,",                        #單據別
               " rxx01   ,",                        #單號
               " rxx02   ,",                        #款別
               " rxx03   ,",                        #款別類型
               " rxx04   ,",                        #交款金額
               " rxx05   ,",                        #溢交款金額
               " rxx11   ,",                        #銷售單號
               " rxxlegal,",                        #法人別    
               " rxxplant)"                         #機構別
   
   LET l_sel = " SELECT DISTINCT ",
               " rxy00 ,",                        #單據別
               " rxy01 ,",                        #單號
               " rxy03 ,",                        #款別 
               " rxy04 ,",                        #款別類型
               " SUM(rxy05) ,",                   #交款金額   
               " SUM(COALESCE(rxy17,0)) ,",       #溢交款金額
               " ''  ,",                          #銷售單號
               " rxylegal,",                      #法人別
               " rxyplant "                       #機構別
      
   LET l_sql = l_ins CLIPPED," ",l_sel CLIPPED," ",l_rxx_from CLIPPED
   CALL cl_replace_sqldb(l_sql) RETURNING l_sql
   CALL cl_parse_qry_sql(l_sql,p_azw01) RETURNING l_sql
   PREPARE cardcoupon_ins_rxx_temp_pre FROM l_sql
   EXECUTE cardcoupon_ins_rxx_temp_pre
   IF SQLCA.sqlcode THEN
      LET g_success = 'N'
      LET g_errno   = SQLCA.sqlcode
      LET g_msg1    = 'Oper:Ins'||' '||'Table:rxx_temp'||' '||'Shop:'||p_azw01
      CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
      ROLLBACK WORK
      CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
      LET g_msg   = g_msg[1,255]
      CALL p200_log(g_trans_no,p_azw01,'Batch Operation',l_ryl04,l_ryl05,g_errno,g_msg,'0','N',g_msg1)
      LET g_errno = ''
      LET g_msg   = ''
      LET g_msg1  = ''
      CALL p200_upd_posflag_p('2',p_gat01,l_ryk03,p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
      RETURN
   END IF

   #rxz_file 刷卡明細表
   LET l_ins = " INSERT INTO rxz_temp( ",
               " rxz00   ,",                              #單據別
               " rxz01   ,",                              #單號
               " rxz02   ,",                              #款別類型
               " rxz03   ,",                              #刷卡序號
               " rxz04   ,",                              #卡號
               " rxz05   ,",                              #刷卡金額
               " rxz06   ,",                              #刷卡日期
               " rxz07   ,",                              #刷卡時間
               " rxz08   ,",                              #刷卡人員
               " rxz09   ,",                              #刷卡手續費額
               " rxz10   ,",                              #刷卡手續費率
               " rxz11   ,",                              #銀行名稱
               " rxz12   ,",                              #銀行注冊否
               " rxz13   ,",                              #狀態
               " rxz14   ,",                              #狀態說明
               " rxz15   ,",                              #固定手續費
               " rxz20   ,",                              #卡類型
               " rxz21   ,",                              #銷售單號
               " rxzlegal,",                              #法人別
               " rxzplant)"                               #機構別

   LET l_sel = " SELECT DISTINCT ",
               " '",p_doctype,"'   ,",                    #rxz00    單據別
               " ",l_field.rxz01," ,",                    #rxz01    單號
               " '",p_paytype,"'   ,",                    #rxz02    款別類型
               " item, ",                                 #rxz03    刷卡序號
               " paysernum, ",                            #rxz04    卡號
               " pay, ",                                  #rxz05    刷卡金額
               " ",p_sdate,",",                           #rxz06    刷卡日期
               " ",p_stime,",",                           #rxz07    刷卡時間
               " ",l_field.rxz08,", ",                    #rxz08    刷卡人員
               " '0', ",                                  #rxz09    刷卡手續費額
               " '0', ",                                  #rxz10    刷卡手續費率
               " '', ",                                   #rxz11    銀行名稱
               " 'N', ",                                  #rxz12    銀行注冊否
               " '1', ",                                  #rxz13    狀態
               " '', ",                                   #rxz14    狀態說明
               " '0', ",                                  #rxz15    固定手續費
               " CASE paycodeerp ",
               "   WHEN CAST('02' AS NVARCHAR2(20)) THEN '2' ",
               "   WHEN CAST('05' AS NVARCHAR2(20)) THEN '5' ",
               "   WHEN CAST('06' AS NVARCHAR2(20)) THEN '6' END, ",    #rxz20    卡類型
               " '', ",                                   #rxz21    銷售單號
               " ",l_field.rxzlegal,", ",                 #rxzlegal 所屬法人
               " shop "                                   #rxzplant 所屬營運中心
               
   LET l_sql = l_ins CLIPPED," ",l_sel CLIPPED," ",l_rxz_from CLIPPED
   CALL cl_replace_sqldb(l_sql) RETURNING l_sql
   CALL cl_parse_qry_sql(l_sql,p_azw01) RETURNING l_sql   
   PREPARE cardcoupon_ins_rxz_temp_pre FROM l_sql                         
   EXECUTE cardcoupon_ins_rxz_temp_pre                               
   IF SQLCA.sqlcode THEN 
      LET g_success = 'N'
      LET g_errno   = SQLCA.sqlcode                       
      LET g_msg1    = 'Oper:Ins'||' '||'Table:rxz_temp'||' '||'Shop:'||p_azw01
      CALL s_errmsg('Batch Operation:','',g_msg1,SQLCA.sqlcode,1)
      ROLLBACK WORK
      CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg      
      LET g_msg   = g_msg[1,255]                          
      CALL p200_log(g_trans_no,p_azw01,'Batch Operation',l_ryl04,l_ryl05,g_errno,g_msg,'0','N',g_msg1)
      LET g_errno = ''
      LET g_msg   = ''
      LET g_msg1  = '' 
      CALL p200_upd_posflag_p('2',p_gat01,l_ryk03,p_azw01) #将oga_temp对应中间库的资料Condition2更新为A
   END IF
END FUNCTION
#FUN-CA0160 Add End -----

#FUN-CC0082 Add Begin ---
#出货单代收款
FUNCTION p200_ins_rxf_oga(p_azw01)
DEFINE p_azw01     LIKE azw_file.azw01
DEFINE p_azw02     LIKE azw_file.azw02
DEFINE l_rxf       RECORD LIKE rxf_file.*
DEFINE l_ruo       RECORD LIKE ruo_file.*
DEFINE l_rup       RECORD LIKE rup_file.*
DEFINE l_sel       STRING
DEFINE l_ins       STRING
DEFINE l_sql       STRING
DEFINE l_upd       STRING
DEFINE l_imd20     LIKE imd_file.imd20
DEFINE l_azw02     LIKE azw_file.azw02
DEFINE l_rxg07_sum LIKE rxg_file.rxg07
DEFINE l_rxg01     LIKE rxg_file.rxg01
DEFINE l_rxg13     LIKE rxg_file.rxg13
DEFINE l_rxg12     LIKE rxg_file.rxg12
DEFINE l_flag      LIKE type_file.chr1
DEFINE l_oga       RECORD LIKE oga_file.*
DEFINE l_ogb       DYNAMIC ARRAY OF RECORD LIKE ogb_file.*
DEFINE l_rvu       RECORD LIKE rvu_file.*
DEFINE l_rvv       DYNAMIC ARRAY OF RECORD LIKE rvv_file.*
DEFINE l_ruo01     LIKE ruo_file.ruo01
DEFINE l_ruoplant  LIKE ruo_file.ruoplant
DEFINE l_time      LIKE type_file.chr8
DEFINE l_time1     LIKE type_file.chr30
DEFINE l_sma53     LIKE sma_file.sma53 #FUN-D10023 Add

   IF NOT cl_null(g_saleno) THEN
      LET g_wc = " saleno = '",g_saleno,"' "
   ELSE
      CALL p200_g_wc("oga_file") RETURNING g_wc
   END IF
   IF cl_null(g_wc) THEN LET g_wc = " 1=1" END IF
   
   SELECT azw02 INTO p_azw02 FROM azw_file WHERE azw01 = p_azw01

   LET l_sql = "SELECT ",
               "       '1', ",                                             #rxf00            #单据类型
               "       NULL, ",                                            #rxf01            #代收/退款单号
               "       CAST(Bdate AS DATE), ",                             #rxf02            #单据日期
               "       OrderShop, ",                                       #rxf03            #订货营运中心
               "       NULL, ",                                            #rxf04            #出货单号/销退单号
               "       Tot_amt, ",                                         #rxf05            #订单总额
               "       Pay_amt, ",                                         #rxf06            #订金金额
               "       Tot_amt-Pay_amt, ",                                 #rxf07            #应收金额
               "       Tot_amt-Pay_amt, ",                                 #rxf08            #已收金额
               "       ryi02, ",                                           #rxf09            #代收人员
               "       gen03, ",                                           #rxf10            #部门编号
               "       Saleno, ",                                          #rxf11            #POS单号
               "       NULL, ",                                            #rxf12            #账款编号
               "       NULL, ",                                            #rxf13            #备注
               "       'Y', ",                                             #rxfacti          #资料有效码
              #"       CAST(Bdate AS DATE), ",                             #rxfcond          #审核日期 #FUN-D10144 Mark
               "       CAST(Sdate AS DATE), ",                             #rxfcond          #审核日期 #FUN-D10144 Add
               "       'Y', ",                                             #rxfconf          #审核码
               "       Stime[1,2]||':'||Stime[3,4]||':'||Stime[5,6], ",    #rxfcont          #审核时间
               "       ryi02, ",                                           #rxfconu          #审核人员
              #"       CAST(Bdate AS DATE), ",                             #rxfcrat          #资料创建日 #FUN-D10144 Mark
               "       CAST(Sdate AS DATE), ",                             #rxfcrat          #资料创建日 #FUN-D10144 Add
              #"       CAST(Bdate AS DATE), ",                             #rxfdate          #最近更改日 #FUN-D10144 Mark
               "       CAST(Sdate AS DATE), ",                             #rxfdate          #最近更改日 #FUN-D10144 Add
               "       gen03, ",                                           #rxfgrup          #资料所有群
               "       '",p_azw02,"', ",                                   #rxflegal         #所属法人
               "       ryi02, ",                                           #rxfmodu          #资料更改者
               "       gen03, ",                                           #rxforig          #资料建立部门
               "       ryi02, ",                                           #rxforiu          #资料建立者
               "       Shop, ",                                            #rxfplant         #所属营运中心
               "       ryi02 ",                                            #rxfuser          #资料所有者
               "  FROM ",g_posdbs,"td_Sale",g_db_links," LEFT OUTER JOIN ",cl_get_target_table(p_azw01,'ryi_file')," ",
               "                                                      ON ryi01 = Opno ",
               "                                         LEFT OUTER JOIN ",cl_get_target_table(p_azw01,'gen_file')," ",
               "                                                      ON gen01 = ryi02 ",
               " WHERE OrderShop IS NOT NULL AND OrderShop <> Shop AND Shop = '",p_azw01,"' ",
               "   AND Condition1 = 'A' AND Condition2 = 'Y' AND Type = '0' AND Cnfflg = 'Y' AND ",g_wc CLIPPED,
               " ORDER BY Bdate,Saleno "
   PREPARE sel_rxf_temp_oga_pre FROM l_sql
   DECLARE sel_rxf_temp_oga_cs CURSOR WITH HOLD FOR sel_rxf_temp_oga_pre
   FOREACH sel_rxf_temp_oga_cs INTO l_rxf.*
      
      LET g_success = 'Y' #成功標誌初始化                                                
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'                                                             
         LET g_errno = SQLCA.sqlcode
         LET g_showmsg = 'SEL TD_SALE INTO RXF'||' '||'SHOP:'||p_azw01||' '||'SALENO:'||l_rxf.rxf11
         CALL s_errmsg('oga98',l_rxf.rxf11,g_showmsg,SQLCA.sqlcode,1)                    
         LET g_msg1 = 'TD_SALE '||'SEL '||p_azw01||' '||l_rxf.rxf11                             
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,l_rxf.rxf11,'02','td_Sale',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         LET g_showmsg = ''
         INITIALIZE l_rxf.* TO NULL 
         CONTINUE FOREACH
      END IF

     #FUN-D10023 Add Begin ---
     #检查关账日期
      IF l_rxf.rxf02 <= g_sma.sma53 THEN
         LET g_success = 'N'                                    
         LET g_errno = 'mfg9999'
         LET g_showmsg = 'Chk rxf02'||' '||'SHOP:'||p_azw01||' '||'SALENO:'||l_rxf.rxf11
         CALL s_errmsg('oga98',l_rxf.rxf11,g_showmsg,g_errno,1)                        
         LET g_msg1 = 'rxf_file '||'Chk '||p_azw01||' '||l_rxf.rxf11                             
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg                    
         LET g_msg = g_msg[1,255] 
         CALL p200_log(g_trans_no,p_azw01,l_rxf.rxf11,'02','td_Sale',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         LET g_showmsg = ''
         INITIALIZE l_rxf.* TO NULL                                        
         CONTINUE FOREACH
      END IF

      LET l_sql = "SELECT sma53 FROM ",cl_get_target_table(l_rxf.rxf03,'sma_file')," WHERE sma00 = '0' "
      PREPARE sel_sma53_pre FROM l_sql
      EXECUTE sel_sma53_pre INTO l_sma53
      IF l_rxf.rxf02 <= l_sma53 THEN
         LET g_success = 'N'                                               
         LET g_errno = 'mfg9999'
         LET g_showmsg = 'Chk rxf02'||' '||'SHOP:'||l_rxf.rxf03
         CALL s_errmsg('oga98',l_rxf.rxf11,g_showmsg,g_errno,1)                              
         LET g_msg1 = 'rxf_file '||'Chk '||p_azw01||' '||l_rxf.rxf11                              
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg                    
         LET g_msg = g_msg[1,255] 
         CALL p200_log(g_trans_no,p_azw01,l_rxf.rxf11,'02','td_Sale',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         LET g_showmsg = ''
         INITIALIZE l_rxf.* TO NULL                                        
         CONTINUE FOREACH                                             
      END IF   

     #FUN-D10023 Add End -----
      
      CALL p200_log_check(p_azw01,l_rxf.rxf11)
      
      CALL p810_temp('1')
      BEGIN WORK

      IF g_bgjob = "N" THEN
         MESSAGE "rxf_file  SHOP:",p_azw01,"  SALENO:",l_rxf.rxf11,"  BEGIN:",TIME(CURRENT)
         CALL ui.Interface.refresh()
      END IF
      
      LET g_ndate = l_rxf.rxf02
      CALL p200_auto_doc("rxf_file",p_azw01,'Y') RETURNING l_rxf.rxf01
      IF g_success ='N' THEN
         INITIALIZE l_rxf.* TO NULL
         CONTINUE FOREACH
      END IF
      
      LET l_sql = "SELECT oga01 FROM ",cl_get_target_table(l_rxf.rxf03,'oga_file')," WHERE oga98 = '",l_rxf.rxf11,"' AND ROWNUM = 1 "
      PREPARE sel_rxf04_pre FROM l_sql
      EXECUTE sel_rxf04_pre INTO l_rxf.rxf04

      LET l_ins = "INSERT INTO ",cl_get_target_table(p_azw01,'rxf_file'),"( ",
                  "            rxf00, ",                 #单据类型
                  "            rxf01, ",                 #代收/退款单号
                  "            rxf02, ",                 #单据日期
                  "            rxf03, ",                 #订货营运中心
                  "            rxf04, ",                 #出货单号/销退单号
                  "            rxf05, ",                 #订单总额
                  "            rxf06, ",                 #订金金额
                  "            rxf07, ",                 #应收金额
                  "            rxf08, ",                 #已收金额
                  "            rxf09, ",                 #代收人员
                  "            rxf10, ",                 #部门编号
                  "            rxf11, ",                 #POS单号
                  "            rxf12, ",                 #账款编号
                  "            rxf13, ",                 #备注
                  "            rxfacti, ",               #资料有效码
                  "            rxfcond, ",               #审核日期
                  "            rxfconf, ",               #审核码
                  "            rxfcont, ",               #审核时间
                  "            rxfconu, ",               #审核人员
                  "            rxfcrat, ",               #资料创建日
                  "            rxfdate, ",               #最近更改日
                  "            rxfgrup, ",               #资料所有群
                  "            rxflegal, ",              #所属法人
                  "            rxfmodu, ",               #资料更改者
                  "            rxforig, ",               #资料建立部门
                  "            rxforiu, ",               #资料建立者
                  "            rxfplant, ",              #所属营运中心
                  "            rxfuser) ",               #资料所有者
                  "     VALUES(?,?,?,?,?,  ?,?,?,?,?, ", #1 ~10
                  "            ?,?,?,?,?,  ?,?,?,?,?, ", #11~20
                  "            ?,?,?,?,?,  ?,?,?)"       #21~28
      CALL cl_replace_sqldb(l_ins) RETURNING l_ins
      CALL cl_parse_qry_sql(l_ins,p_azw01) RETURNING l_ins
      PREPARE ins_rxf_pre FROM l_ins
      EXECUTE ins_rxf_pre USING l_rxf.rxf00,              #单据类型
                                l_rxf.rxf01,              #代收/退款单号
                                l_rxf.rxf02,              #单据日期
                                l_rxf.rxf03,              #订货营运中心
                                l_rxf.rxf04,              #出货单号/销退单号
                                l_rxf.rxf05,              #订单总额
                                l_rxf.rxf06,              #订金金额
                                l_rxf.rxf07,              #应收金额
                                l_rxf.rxf08,              #已收金额
                                l_rxf.rxf09,              #代收人员
                                l_rxf.rxf10,              #部门编号
                                l_rxf.rxf11,              #POS单号
                                l_rxf.rxf12,              #账款编号
                                l_rxf.rxf13,              #备注
                                l_rxf.rxfacti,            #资料有效码
                                l_rxf.rxfcond,            #审核日期
                                l_rxf.rxfconf,            #审核码
                                l_rxf.rxfcont,            #审核时间
                                l_rxf.rxfconu,            #审核人员
                                l_rxf.rxfcrat,            #资料创建日
                                l_rxf.rxfdate,            #最近更改日
                                l_rxf.rxfgrup,            #资料所有群
                                l_rxf.rxflegal,           #所属法人
                                l_rxf.rxfmodu,            #资料更改者
                                l_rxf.rxforig,            #资料建立部门
                                l_rxf.rxforiu,            #资料建立者
                                l_rxf.rxfplant,           #所属营运中心
                                l_rxf.rxfuser             #资料所有者
      IF SQLCA.sqlcode OR SQLCA.sqlerrd[3]=0 THEN
         LET g_success = 'N'
         LET g_errno = SQLCA.sqlcode
         LET g_showmsg = 'INS rxf_file'||' '||'SHOP:'||p_azw01||' '||'SALENO:'||l_rxf.rxf11
         CALL s_errmsg('rxf01',l_rxf.rxf01,g_showmsg,SQLCA.sqlcode,1)
         LET g_msg1 = 'rxf_file'||'INS'||p_azw01||l_rxf.rxf11
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,l_rxf.rxf11,'02','TD_SALE',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         LET g_showmsg = '' 
         INITIALIZE l_rxf.* TO NULL 
         CONTINUE FOREACH
      END IF

      #写付款信息 rxy/rxx/rxz 单据别12.代收
      #ins rxy
      LET l_ins = "INSERT INTO ",cl_get_target_table(p_azw01,'rxy_file'),"( ",
                  "            rxy00, ",       #單據別
                  "            rxy01, ",       #單號
                  "            rxy02, ",       #項次
                  "            rxy03, ",       #款別
                  "            rxy04, ",       #款別類型
                  "            rxy05, ",       #交款金額
                  "            rxy06, ",       #卡號/票號/帳號/待抵單號
                  "            rxy07, ",       #刷卡手續費率
                  "            rxy08, ",       #刷卡手續費額
                  "            rxy09, ",       #支票面額
                  "            rxy10, ",       #出票日期
                  "            rxy11, ",       #出票單位
                  "            rxy12, ",       #卡券種類編號
                  "            rxy13, ",       #券面額編號
                  "            rxy14, ",       #券起始編號
                  "            rxy15, ",       #券終止編號
                  "            rxy16, ",       #券數量
                  "            rxy17, ",       #票券溢交款金額
                  "            rxy18, ",       #退款類型
                  "            rxy19, ",       #沖預收款類型
                  "            rxy20, ",       #固定手續費
                  "            rxy21, ",       #交款日期
                  "            rxy22, ",       #交款時間
                  "            rxy23, ",       #抵現積分
                  "            rxy30, ",       #POS款別
                  "            rxy31, ",       #銷售單號
                  "            rxy32, ",       #項次
                  "            rxy33, ",       #沖預收否
                  "            rxy34, ",       #代收款營運中心
                  "            rxylegal, ",    #所屬法人
                  "            rxyplant) "     #所屬營運中心
      LET l_sel = "SELECT ",
                  "       '12', ",                    #rxy00       #單據別
                  "       '",l_rxf.rxf01,"', ",       #rxy01       #單號
                  "       rxy02, ",                   #rxy02       #項次
                  "       rxy03, ",                   #rxy03       #款別
                  "       rxy04, ",                   #rxy04       #款別類型
                  "       rxy05, ",                   #rxy05       #交款金額
                  "       rxy06, ",                   #rxy06       #卡號/票號/帳號/待抵單號
                  "       rxy07, ",                   #rxy07       #刷卡手續費率
                  "       rxy08, ",                   #rxy08       #刷卡手續費額
                  "       rxy09, ",                   #rxy09       #支票面額
                  "       rxy10, ",                   #rxy10       #出票日期
                  "       rxy11, ",                   #rxy11       #出票單位
                  "       rxy12, ",                   #rxy12       #卡券種類編號
                  "       rxy13, ",                   #rxy13       #券面額編號
                  "       rxy14, ",                   #rxy14       #券起始編號
                  "       rxy15, ",                   #rxy15       #券終止編號
                  "       rxy16, ",                   #rxy16       #券數量
                  "       rxy17, ",                   #rxy17       #票券溢交款金額
                  "       rxy18, ",                   #rxy18       #退款類型
                  "       rxy19, ",                   #rxy19       #沖預收款類型
                  "       rxy20, ",                   #rxy20       #固定手續費
                  "       rxy21, ",                   #rxy21       #交款日期
                  "       rxy22, ",                   #rxy22       #交款時間
                  "       rxy23, ",                   #rxy23       #抵現積分
                  "       rxy30, ",                   #rxy30       #POS款別
                  "       rxy31, ",                   #rxy31       #銷售單號
                  "       rxy32, ",                   #rxy32       #項次
                  "       rxy33, ",                   #rxy33       #沖預收否
                  "       '",l_rxf.rxf03,"', ",       #rxy34       #代收款營運中心
                  "       '",l_rxf.rxflegal,"', ",    #rxylegal    #所屬法人
                  "       '",l_rxf.rxfplant,"' ",     #rxyplant    #所屬營運中心
                  "  FROM ",cl_get_target_table(l_rxf.rxf03,'rxy_file'),
                  " WHERE rxy33 <> 'Y' ", #
                  "   AND rxy01 = (SELECT oga01 FROM ",cl_get_target_table(l_rxf.rxf03,'oga_file'),
                  "                 WHERE oga98 = '",l_rxf.rxf11,"' AND ROWNUM = 1) "
      LET l_sql = l_ins CLIPPED," ",l_sel CLIPPED
      PREPARE ins_rxy_rxf_pre FROM l_sql
      EXECUTE ins_rxy_rxf_pre
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno = SQLCA.sqlcode
         LET g_showmsg = 'INS rxy_file'||' '||'SHOP:'||p_azw01||' '||'SALENO:'||l_rxf.rxf11
         CALL s_errmsg('rxy01',l_rxf.rxf01,g_showmsg,SQLCA.sqlcode,1)
         LET g_msg1 = 'rxy_file'||'INS'||p_azw01||l_rxf.rxf11
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,l_rxf.rxf11,'02','TD_SALE',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         LET g_showmsg = '' 
         INITIALIZE l_rxf.* TO NULL
         CONTINUE FOREACH
      END IF

      #ins rxx
      LET l_ins = "INSERT INTO ",cl_get_target_table(p_azw01,'rxx_file'),"( ",
                  "            rxx00, ",       #单据别
                  "            rxx01, ",       #单号
                  "            rxx02, ",       #款别
                  "            rxx03, ",       #款别类型
                  "            rxx04, ",       #交款金额
                  "            rxx05, ",       #溢交款金额
                  "            rxx11, ",       #销售单号
                  "            rxxlegal, ",    #法人别
                  "            rxxplant) "     #所属营运中心
      LET l_sel = "SELECT ",
                  "       '12', ",                     #rxx00       #单据别
                  "       '",l_rxf.rxf01,"', ",        #rxx01       #单号
                  "       rxx02, ",                    #rxx02       #款别
                  "       rxx03, ",                    #rxx03       #款别类型
                  "       rxx04, ",                    #rxx04       #交款金额
                  "       rxx05, ",                    #rxx05       #溢交款金额
                  "       rxx11, ",                    #rxx11       #销售单号
                  "       '",l_rxf.rxflegal,"', ",     #rxxlegal    #法人别
                  "       '",l_rxf.rxfplant,"' ",      #rxxplant    #所属营运中心
                  "  FROM ",cl_get_target_table(l_rxf.rxf03,'rxx_file'),
                  " WHERE rxx02 <> '07' ",
                  "   AND rxx01 = (SELECT oga01 FROM ",cl_get_target_table(l_rxf.rxf03,'oga_file'),
                  "                 WHERE oga98 = '",l_rxf.rxf11,"' AND ROWNUM = 1) "
      LET l_sql = l_ins CLIPPED," ",l_sel CLIPPED
      PREPARE ins_rxx_rxf_pre FROM l_sql
      EXECUTE ins_rxx_rxf_pre
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno = SQLCA.sqlcode
         LET g_showmsg = 'INS rxx_file'||' '||'SHOP:'||p_azw01||' '||'SALENO:'||l_rxf.rxf11
         CALL s_errmsg('rxx01',l_rxf.rxf01,g_showmsg,SQLCA.sqlcode,1)
         LET g_msg1 = 'rxx_file'||'INS'||p_azw01||l_rxf.rxf11
         ROLLBACK WORK
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,l_rxf.rxf11,'02','TD_SALE',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         LET g_showmsg = ''
         INITIALIZE l_rxf.* TO NULL
         CONTINUE FOREACH
      END IF

      #ins rxz
     #LET l_ins = "INSERT INTO ",cl_get_target_table(p_azw01,'rxz_file'),"( ",
     #            "            rxz00, ",       #单据别
     #            "            rxz01, ",       #单号
     #            "            rxz02, ",       #款别类型
     #            "            rxz03, ",       #刷卡序号
     #            "            rxz04, ",       #卡号
     #            "            rxz05, ",       #刷卡金额
     #            "            rxz06, ",       #刷卡日期
     #            "            rxz07, ",       #刷卡时间
     #            "            rxz08, ",       #刷卡人员
     #            "            rxz09, ",       #刷卡手续费额
     #            "            rxz10, ",       #刷卡手续费率
     #            "            rxz11, ",       #银行名称
     #            "            rxz12, ",       #银行注册否
     #            "            rxz13, ",       #状态
     #            "            rxz14, ",       #状态说明
     #            "            rxz15, ",       #固定手续费
     #            "            rxz20, ",       #卡类型
     #            "            rxz21, ",       #销售单号
     #            "            rxzlegal, ",    #法人别
     #            "            rxzplant) "     #所属营运中心
     #LET l_sel = "SELECT ",
     #            "       '12', ",                     #rxz00       #单据别
     #            "       '",l_rxf.rxf01,"', ",        #rxz01       #单号
     #            "       rxz02, ",                    #rxz02       #款别类型
     #            "       rxz03, ",                    #rxz03       #刷卡序号
     #            "       rxz04, ",                    #rxz04       #卡号
     #            "       rxz05, ",                    #rxz05       #刷卡金额
     #            "       rxz06, ",                    #rxz06       #刷卡日期
     #            "       rxz07, ",                    #rxz07       #刷卡时间
     #            "       rxz08, ",                    #rxz08       #刷卡人员
     #            "       rxz09, ",                    #rxz09       #刷卡手续费额
     #            "       rxz10, ",                    #rxz10       #刷卡手续费率
     #            "       rxz11, ",                    #rxz11       #银行名称
     #            "       rxz12, ",                    #rxz12       #银行注册否
     #            "       rxz13, ",                    #rxz13       #状态
     #            "       rxz14, ",                    #rxz14       #状态说明
     #            "       rxz15, ",                    #rxz15       #固定手续费
     #            "       rxz20, ",                    #rxz20       #卡类型
     #            "       rxz21, ",                    #rxz21       #销售单号
     #            "       '",l_rxf.rxflegal,"', ",     #rxzlegal    #法人别
     #            "       '",l_rxf.rxfplant,"' ",      #rxzplant    #所属营运中心I
     #            "  FROM ",cl_get_target_table(l_rxf.rxf03,'rxz_file'),", ",
     #            "       ",cl_get_target_table(l_rxf.rxf03,'rxy_file'),
     #            " WHERE rxy00 = rxz00 AND rxy01 = rxz01 AND rxz04 = rxy06 AND rxy03 IN ('02','05','06') ",
     #            "   AND rxy33 <> 'Y' ",
     #            "   AND rxz01 = (SELECT oga01 FROM ",cl_get_target_table(l_rxf.rxf03,'oga_file'),
     #            "                 WHERE oga98 = '",l_rxf.rxf11,"' AND ROWNUM = 1) "
     #LET l_sql = l_ins CLIPPED," ",l_sel CLIPPED
     #PREPARE ins_rxz_rxf_pre FROM l_sql
     #EXECUTE ins_rxz_rxf_pre 
     #IF SQLCA.sqlcode THEN
     #   LET g_success = 'N'
     #   LET g_errno = SQLCA.sqlcode
     #   LET g_showmsg = 'INS rxz_file'||' '||'SHOP:'||p_azw01||' '||'SALENO:'||l_rxf.rxf11
     #   CALL s_errmsg('rxz01',l_rxf.rxf01,g_showmsg,SQLCA.sqlcode,1)
     #   LET g_msg1 = 'rxz_file'||'INS'||p_azw01||l_rxf.rxf11
     #   ROLLBACK WORK
     #   CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
     #   LET g_msg = g_msg[1,255]
     #   CALL p200_log(g_trans_no,p_azw01,l_rxf.rxf11,'02','TD_SALE',g_errno,g_msg,'0','N',g_msg1)
     #   LET g_errno = ''
     #   LET g_msg   = ''
     #   LET g_msg1  = ''
     #   LET g_showmsg = ''
     #   INITIALIZE l_rxf.* TO NULL
     #   CONTINUE FOREACH
     #END IF
      
      #写代管库存明细
      LET l_ins = "INSERT INTO ",cl_get_target_table(p_azw01,'rxg_file'),"( ",
                  "            rxg01, ",                 #產品編號
                  "            rxg02, ",                 #單據日期
                  "            rxg03, ",                 #執行日期
                  "            rxg04, ",                 #異動狀況
                  "            rxg05, ",                 #異動單號
                  "            rxg06, ",                 #異動項次
                  "            rxg07, ",                 #數量
                  "            rxg08, ",                 #單位
                  "            rxg09, ",                 #倉庫
                  "            rxg10, ",                 #儲位
                  "            rxg11, ",                 #批號
                  "            rxg12, ",                 #訂單編號
                  "            rxg13, ",                 #訂單項次
                  "            rxg14, ",                 #配送單號
                  "            rxg15, ",                 #配送單項次
                  "            rxg16, ",                 #配送中心
                  "            rxg17, ",                 #訂貨營運中心
                  "            rxg18, ",                 #取貨營運中心
                  "            rxglegal, ",              #所屬法人
                  "            rxgplant) "               #所屬營運中心
      LET l_sel = "SELECT ",
                  "       ogb04, ",                 #rxg01       #產品編號
                  "       '",l_rxf.rxf02,"', ",     #rxg02       #單據日期
                  "       '",g_today,"', ",         #rxg03       #執行日期
                  "       '2', ",                   #rxg04       #異動狀況
                  "       '",l_rxf.rxf01,"', ",     #rxg05       #異動單號
                  "       ogb03, ",                 #rxg06       #異動項次
                  "       (-1)*ogb12, ",            #rxg07       #數量
                  "       ogb05, ",                 #rxg08       #單位
                  "       '",g_rtz07,"', ",         #rxg09       #倉庫
                  "       ' ', ",                   #rxg10       #儲位
                  "       ' ', ",                   #rxg11       #批號
                  "       oga16, ",                 #rxg12       #訂單編號
                  "       ogb32, ",                 #rxg13       #訂單項次
                  "       NULL, ",                  #rxg14       #配送單號
                  "       NULL, ",                  #rxg15       #配送單項次
                  "       NULL, ",                  #rxg16       #配送中心
                  "       '",l_rxf.rxf03,"', ",     #rxg17       #訂貨營運中心
                  "       oga84, ",                 #rxg18       #取貨營運中心
                  "       azw02, ",                 #rxglegal    #所屬法人
                  "       oga84 ",                  #rxgplant    #所屬營運中心
                  "  FROM ",cl_get_target_table(l_rxf.rxf03,'ogb_file'),", ",
                  "       ",cl_get_target_table(l_rxf.rxf03,'oga_file'),
                  "  LEFT OUTER JOIN ",cl_get_target_table(l_rxf.rxf03,'azw_file')," ON azw01 = oga84 ",
                  " WHERE oga01 = ogb01 AND oga01 = '",l_rxf.rxf04,"' "
      LET l_sql = l_ins CLIPPED," ",l_sel CLIPPED
      PREPARE ins_rxg_pre2 FROM l_sql
      EXECUTE ins_rxg_pre2
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno = SQLCA.sqlcode
         LET g_showmsg = 'INS rxg_file'||' '||'SHOP:'||p_azw01||' '||'SALENO:'||l_rxf.rxf11
         CALL s_errmsg('Saleno',l_rxf.rxf11,g_showmsg,SQLCA.sqlcode,1)
         ROLLBACK WORK
         LET g_msg1 = 'rxg_file '||'INS '||p_azw01||' '||l_rxf.rxf11
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,l_rxf.rxf11,'02','td_Sale',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         LET g_showmsg = ''
         CONTINUE FOREACH 
      END IF
   
      #更新中间Condition1为Y
      LET l_upd = "UPDATE ",g_posdbs,"td_Sale",g_db_links," ",
                  "   SET Condition1 = 'Y' ",
                  " WHERE Shop = '",p_azw01,"' ",
                  "   AND Saleno = '",l_rxf.rxf11,"' ",
                  "   AND Condition1 = 'A' "
      PREPARE upd_condition1_oga_pre FROM l_upd
      EXECUTE upd_condition1_oga_pre
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         LET g_errno = SQLCA.sqlcode
         LET g_showmsg = 'UPD Condition1'||' '||'SHOP:'||p_azw01||' '||'SALENO:'||l_rxf.rxf11
         CALL s_errmsg('Saleno',l_rxf.rxf11,g_showmsg,SQLCA.sqlcode,1)
         ROLLBACK WORK
         LET g_msg1 = 'td_Sale'||'UPD Condition1'||p_azw01||l_rxf.rxf11
         CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
         LET g_msg = g_msg[1,255]
         CALL p200_log(g_trans_no,p_azw01,l_rxf.rxf11,'02','td_Sale',g_errno,g_msg,'0','N',g_msg1)
         LET g_errno = ''
         LET g_msg   = ''
         LET g_msg1  = ''
         LET g_showmsg = ''
         CONTINUE FOREACH 
      END IF
      
      LET l_rxg07_sum = 0
      LET l_sql = "SELECT DISTINCT rxg12 FROM ",cl_get_target_table(p_azw01,'rxg_file'),
                  " WHERE rxg05 = '",l_rxf.rxf01,"' "
      PREPARE sel_rxg12_pre FROM l_sql
      EXECUTE sel_rxg12_pre INTO l_rxg12
      
      LET l_sql = "SELECT SUM(rxg07) FROM ",cl_get_target_table(p_azw01,'rxg_file'),
                  " WHERE rxg12 = '",l_rxg12,"' AND rxgplant = '",p_azw01,"' "
      PREPARE sel_rxg07_sum_pre FROM l_sql
      EXECUTE sel_rxg07_sum_pre INTO l_rxg07_sum
      IF l_rxg07_sum <> 0 THEN #代管库存总数量不为0时产生调拨单
         #产生调拨单
         LET g_ndate = l_rxf.rxf02
         CALL p200_auto_doc('ruo_file',p_azw01,'N') RETURNING l_ruo.ruo01
         IF g_success = 'N' THEN
            CONTINUE FOREACH
         END IF
         
         SELECT azw02 INTO l_azw02 FROM azw_file WHERE azw01 = l_rxf.rxf03
         IF l_azw02 = p_azw02 THEN
            LET l_ruo.ruo901 = 'N'
            LET l_ruo.ruo904 = ''  #多交贸易流转代码
            LET l_ruo.ruo99  = ''  #多交贸易流程序号
         ELSE 
            LET l_ruo.ruo901 = 'Y'
            LET l_ruo.ruo904 = ''  #多交贸易流转代码
            LET l_time1 = CURRENT YEAR TO FRACTION(4)
            LET l_ruo.ruo99  = l_rxf.rxf03,'-',l_time1[1,4],l_time1[6,7],l_time1[9,10],l_time1[12,13],l_time1[15,16],l_time1[18,19],l_time1[21,23]  #多交贸易流程序号
         END IF
         
        ##在途仓管理 
        #IF g_sma.sma142 = 'Y' THEN   #在途管理
        #   IF g_sma.sma143 = '1' THEN
        #      LET l_imd20 = p_azw01
        #   ELSE
        #      LET l_imd20 = l_rxf.rxf03
        #   END IF
        #   LET l_sql = "SELECT imd01 FROM ",cl_get_target_table(l_imd20,'imd_file'),
        #               " WHERE imd10 = 'W' AND imd22 = 'Y' ",
        #               "   AND imd20 = '",l_imd20,"'"
        #   CALL cl_replace_sqldb(l_sql) RETURNING l_sql
        #   CALL cl_parse_qry_sql(l_sql,l_imd20) RETURNING l_sql
        #   PREPARE sel_ruo14_pre FROM l_sql
        #   EXECUTE sel_ruo14_pre INTO l_ruo.ruo14
        #ELSE
        #   LET l_ruo.ruo14 = NULL
        #END IF
         
        #LET l_ruo.ruo01    =                    #產品調撥單號
        #LET l_ruo.ruo011   =                    #對應調撥單號
         LET l_ruo.ruo02    = '9'                #來源類型
         LET l_ruo.ruo03    = l_rxf.rxf04        #來源單號
         LET l_ruo.ruo04    = p_azw01            #撥出營運中心
         LET l_ruo.ruo05    = l_rxf.rxf03        #撥入營運中心
         LET l_ruo.ruo06    = ''                 #nouse
         LET l_ruo.ruo07    = l_rxf.rxf02        #調撥日期
         LET l_ruo.ruo08    = l_rxf.rxf09        #調撥人員
         LET l_ruo.ruo09    = ''                 #備注
         LET l_ruo.ruo10    = ''                 #撥出審核日期
         LET l_ruo.ruo10t   = ''                 #撥出審核時間
         LET l_ruo.ruo11    = ''                 #撥出審核人員
         LET l_ruo.ruo12    = ''                 #撥入審核日期
         LET l_ruo.ruo12t   = ''                 #撥入審核時間
         LET l_ruo.ruo13    = ''                 #撥入審核人員
         LET l_ruo.ruo14    = ''                 #在途倉庫
         LET l_ruo.ruo15    = 'N'                #當前營運中心過帳否
        #LET l_ruo.ruo901   =                    #多角貿易否
        #LET l_ruo.ruo904   =                    #多角貿易流程代碼
        #LET l_ruo.ruo99    =                    #多角貿易流轉序號
         LET l_ruo.ruoacti  = 'Y'                #資料有效碼
         LET l_ruo.ruoconf  = '0'                #審核碼
        #LET l_ruo.ruocrat  = l_rxf.rxf02        #資料創建日 #FUN-D10144 Mark
         LET l_ruo.ruocrat  = l_rxf.rxfdate      #資料創建日 #FUN-D10144 Add 
        #LET l_ruo.ruodate  = l_rxf.rxf02        #最近修改日 #FUN-D10144 Mark
         LET l_ruo.ruodate  = l_rxf.rxfdate      #最近修改日 #FUN-D10144 Add
         LET l_ruo.ruogrup  = l_rxf.rxfgrup      #資料所有部門
         LET l_ruo.ruolegal = p_azw02            #所屬法人
         LET l_ruo.ruomodu  = l_rxf.rxf09        #資料修改者
         LET l_ruo.ruoplant = p_azw01            #所屬營運中心
         LET l_ruo.ruouser  = l_rxf.rxf09        #資料所有者
         LET l_ruo.ruopos   = 'N'                #已傳POS否
         LET l_ruo.ruooriu  = l_rxf.rxf09        #資料建立者
         LET l_ruo.ruoorig  = l_rxf.rxfgrup      #資料建立部門
         
         LET l_sql = "INSERT INTO ",cl_get_target_table(p_azw01,'ruo_file'),"( ",
                     "            ruo01, ",       #產品調撥單號
                     "            ruo011, ",      #對應調撥單號
                     "            ruo02, ",       #來源類型
                     "            ruo03, ",       #來源單號
                     "            ruo04, ",       #撥出營運中心
                     "            ruo05, ",       #撥入營運中心
                     "            ruo06, ",       #nouse
                     "            ruo07, ",       #調撥日期
                     "            ruo08, ",       #調撥人員
                     "            ruo09, ",       #備注
                     "            ruo10, ",       #撥出審核日期
                     "            ruo10t, ",      #撥出審核時間
                     "            ruo11, ",       #撥出審核人員
                     "            ruo12, ",       #撥入審核日期
                     "            ruo12t, ",      #撥入審核時間
                     "            ruo13, ",       #撥入審核人員
                     "            ruo14, ",       #在途倉庫
                     "            ruo15, ",       #當前營運中心過帳否
                     "            ruo901, ",      #多角貿易否
                     "            ruo904, ",      #多角貿易流程代碼
                     "            ruo99, ",       #多角貿易流轉序號
                     "            ruoacti, ",     #資料有效碼
                     "            ruoconf, ",     #審核碼
                     "            ruocrat, ",     #資料創建日
                     "            ruodate, ",     #最近修改日
                     "            ruogrup, ",     #資料所有部門
                     "            ruolegal, ",    #所屬法人
                     "            ruomodu, ",     #資料修改者
                     "            ruoplant, ",    #所屬營運中心
                     "            ruouser, ",     #資料所有者
                     "            ruopos, ",      #已傳POS否(1.新增未下傳2.修改
                     "            ruooriu, ",     #資料建立者
                     "            ruoorig) ",     #資料建立部門
                     "     VALUES(?,?,?,?,?,  ?,?,?,?,?, ",   #1 ~10
                     "            ?,?,?,?,?,  ?,?,?,?,?, ",   #11~20
                     "            ?,?,?,?,?,  ?,?,?,?,?, ",   #21~30
                     "            ?,?,?) "                    #31~33
         PREPARE ins_ruo_pre1 FROM l_sql
         EXECUTE ins_ruo_pre1 USING l_ruo.ruo01,       #產品調撥單號
                                   l_ruo.ruo011,      #對應調撥單號
                                   l_ruo.ruo02,       #來源類型
                                   l_ruo.ruo03,       #來源單號
                                   l_ruo.ruo04,       #撥出營運中心
                                   l_ruo.ruo05,       #撥入營運中心
                                   l_ruo.ruo06,       #nouse
                                   l_ruo.ruo07,       #調撥日期
                                   l_ruo.ruo08,       #調撥人員
                                   l_ruo.ruo09,       #備注
                                   l_ruo.ruo10,       #撥出審核日期
                                   l_ruo.ruo10t,      #撥出審核時間
                                   l_ruo.ruo11,       #撥出審核人員
                                   l_ruo.ruo12,       #撥入審核日期
                                   l_ruo.ruo12t,      #撥入審核時間
                                   l_ruo.ruo13,       #撥入審核人員
                                   l_ruo.ruo14,       #在途倉庫
                                   l_ruo.ruo15,       #當前營運中心過帳否
                                   l_ruo.ruo901,      #多角貿易否
                                   l_ruo.ruo904,      #多角貿易流程代碼
                                   l_ruo.ruo99,       #多角貿易流轉序號
                                   l_ruo.ruoacti,     #資料有效碼
                                   l_ruo.ruoconf,     #審核碼
                                   l_ruo.ruocrat,     #資料創建日
                                   l_ruo.ruodate,     #最近修改日
                                   l_ruo.ruogrup,     #資料所有部門
                                   l_ruo.ruolegal,    #所屬法人
                                   l_ruo.ruomodu,     #資料修改者
                                   l_ruo.ruoplant,    #所屬營運中心
                                   l_ruo.ruouser,     #資料所有者
                                   l_ruo.ruopos,      #已傳POS否
                                   l_ruo.ruooriu,     #資料建立者
                                   l_ruo.ruoorig      #資料建立部門
         IF SQLCA.sqlcode OR SQLCA.sqlerrd[3] = 0 THEN 
            LET g_success = 'N'
            LET g_errno = SQLCA.sqlcode
            LET g_showmsg = 'INS ruo_file'||' '||'SHOP:'||p_azw01||' '||'SALENO:'||l_rxf.rxf11
            CALL s_errmsg('Saleno',l_rxf.rxf11,g_showmsg,SQLCA.sqlcode,1)
            ROLLBACK WORK
            LET g_msg1 = 'ruo_file '||'INS '||p_azw01||' '||l_rxf.rxf11
            CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
            LET g_msg = g_msg[1,255]
            CALL p200_log(g_trans_no,p_azw01,l_rxf.rxf11,'02','td_Sale',g_errno,g_msg,'0','N',g_msg1)
            LET g_errno = ''
            LET g_msg   = ''
            LET g_msg1  = ''
            LET g_showmsg = ''
            CONTINUE FOREACH 
         END IF
         
         LET l_rxg07_sum = 0
         LET l_sql = "SELECT rxg13,rxg01,SUM(rxg07) FROM ",cl_get_target_table(p_azw01,'rxg_file'),
                     " WHERE rxg12 = '",l_rxg12,"' AND rxgplant = '",p_azw01,"' ",
                     " GROUP BY rxg13,rxg01 ",
                     " ORDER BY rxg13 "
         PREPARE sel_rxg13_rxg07_pre FROM l_sql
         DECLARE sel_rxg13_rxg07_cs CURSOR WITH HOLD FOR sel_rxg13_rxg07_pre
         FOREACH sel_rxg13_rxg07_cs INTO l_rxg13,l_rxg01,l_rxg07_sum
            IF l_rxg07_sum <> 0 THEN
               LET l_rup.rup01    = l_ruo.ruo01            #產品調撥單號
              #LET l_rup.rup02    = ''                     #項次
               LET l_rup.rup03    = l_rxg01                #產品代碼
              #LET l_rup.rup04    = ima25                  #庫存單位
              #LET l_rup.rup05    = COALESCE(rty06,'1')    #經營方式
               LET l_rup.rup06    = ''                     #產品條碼
              #LET l_rup.rup07    = ima44                  #調撥單位
              #LET l_rup.rup08    = ''                     #單位換算率
               LET l_rup.rup09    = g_rtz07                #撥出倉庫
               LET l_rup.rup10    = ' '                    #撥出儲位
               LET l_rup.rup11    = ' '                    #撥出批號
               LET l_rup.rup12    = ABS(l_rxg07_sum)       #撥出數量
              #LET l_rup.rup13    = g_rtz07_2              #撥入倉庫
               LET l_rup.rup14    = ' '                    #撥入儲位
               LET l_rup.rup15    = ' '                    #撥入批號
               LET l_rup.rup16    = ABS(l_rxg07_sum)       #撥入數量
               LET l_rup.rup17    = l_rxg13                #來源項次
               LET l_rup.rup18    = 'N'                    #結案否
               LET l_rup.rup19    = ''                     #預調撥量
               LET l_rup.rup20s   = ''                     #料件編號
               LET l_rup.rup21s   = ''                     #項次
               LET l_rup.rup22    = p_azw01                #收貨營運中心
               LET l_rup.ruplegal = p_azw02                #所屬法人
               LET l_rup.rupplant = p_azw01                #所屬營運中心
               
               #项次(rup02)
               LET l_sql = "SELECT MAX(rup02)+1 FROM ",cl_get_target_table(p_azw01,'rup_file'),
                           " WHERE rup01 = '",l_ruo.ruo01 CLIPPED,"' "
               PREPARE sel_rup02_pre FROM l_sql
               EXECUTE sel_rup02_pre INTO l_rup.rup02 
               IF cl_null(l_rup.rup02) OR l_rup.rup02 = 0 THEN LET l_rup.rup02 = 1 END IF
               
               #库存单位/调拨单位(rup04/rup07)
               LET l_sql = "SELECT ima25,ima44 FROM ",cl_get_target_table(p_azw01,'ima_file'),
                           " WHERE ima01 = '",l_rxg01 CLIPPED,"' "
               PREPARE sel_rup04_rup07_pre FROM l_sql
               EXECUTE sel_rup04_rup07_pre INTO l_rup.rup04,l_rup.rup07
               
               #单位转换率(rup08)
               CALL s_umfchk('',l_rup.rup04,l_rup.rup07) RETURNING l_flag,l_rup.rup08
               
               #经营方式(rup05)
               LET l_sql = "SELECT COALESCE(rty06,'1') FROM ",cl_get_target_table(l_ruo.ruo05,'rty_file'),
                           " WHERE rty01 = '",l_ruo.ruo05 CLIPPED,"' AND rty02 = '",l_rxg01 CLIPPED,"' "
               PREPARE sel_rup05_pre FROM l_sql
               EXECUTE sel_rup05_pre INTO l_rup.rup05
               IF cl_null(l_rup.rup05) THEN LET l_rup.rup05 = '1' END IF
               
               #拨入仓库(rup13)
               CALL s_get_coststore(l_ruo.ruo05,l_rup.rup03) RETURNING l_rup.rup13
               
               LET l_sql = "INSERT INTO ",cl_get_target_table(p_azw01,'rup_file'),"( ",
                           "            rup01, ",       #產品調撥單號
                           "            rup02, ",       #項次
                           "            rup03, ",       #產品代碼
                           "            rup04, ",       #庫存單位
                           "            rup05, ",       #經營方式
                           "            rup06, ",       #產品條碼
                           "            rup07, ",       #調撥單位
                           "            rup08, ",       #單位換算率
                           "            rup09, ",       #撥出倉庫
                           "            rup10, ",       #撥出儲位
                           "            rup11, ",       #撥出批號
                           "            rup12, ",       #撥出數量
                           "            rup13, ",       #撥入倉庫
                           "            rup14, ",       #撥入儲位
                           "            rup15, ",       #撥入批號
                           "            rup16, ",       #撥入數量
                           "            rup17, ",       #來源項次
                           "            rup18, ",       #結案否
                           "            rup19, ",       #預調撥量
                           "            rup20s, ",      #料件編號
                           "            rup21s, ",      #項次
                           "            rup22, ",       #收貨營運中心
                           "            ruplegal, ",    #所屬法人
                           "            rupplant) ",    #所屬營運中心
                           "     VALUES(?,?,?,?,?,  ?,?,?,?,?, ",  #1 ~10
                           "            ?,?,?,?,?,  ?,?,?,?,?, ",  #11~20
                           "            ?,?,?,?) "                 #21~24
               PREPARE ins_rup_pre1 FROM l_sql
               EXECUTE ins_rup_pre1 USING l_rup.rup01,       #產品調撥單號
                                         l_rup.rup02,       #項次
                                         l_rup.rup03,       #產品代碼
                                         l_rup.rup04,       #庫存單位
                                         l_rup.rup05,       #經營方式
                                         l_rup.rup06,       #產品條碼
                                         l_rup.rup07,       #調撥單位
                                         l_rup.rup08,       #單位換算率
                                         l_rup.rup09,       #撥出倉庫
                                         l_rup.rup10,       #撥出儲位
                                         l_rup.rup11,       #撥出批號
                                         l_rup.rup12,       #撥出數量
                                         l_rup.rup13,       #撥入倉庫
                                         l_rup.rup14,       #撥入儲位
                                         l_rup.rup15,       #撥入批號
                                         l_rup.rup16,       #撥入數量
                                         l_rup.rup17,       #來源項次
                                         l_rup.rup18,       #結案否
                                         l_rup.rup19,       #預調撥量
                                         l_rup.rup20s,      #料件編號
                                         l_rup.rup21s,      #項次
                                         l_rup.rup22,       #收貨營運中心
                                         l_rup.ruplegal,    #所屬法人
                                         l_rup.rupplant     #所屬營運中心               
               IF SQLCA.sqlcode OR SQLCA.sqlerrd[3] = 0 THEN
                  LET g_success = 'N'
                  LET g_errno = SQLCA.sqlcode
                  LET g_showmsg = 'INS rup_file'||' '||'SHOP:'||p_azw01||' '||'SALENO:'||l_rxf.rxf11
                  CALL s_errmsg('Saleno',l_rxf.rxf11,g_showmsg,SQLCA.sqlcode,1)
                  ROLLBACK WORK
                  LET g_msg1 = 'rup_file '||'INS '||p_azw01||' '||l_rxf.rxf11
                  CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
                  LET g_msg = g_msg[1,255]
                  CALL p200_log(g_trans_no,p_azw01,l_rxf.rxf11,'02','td_Sale',g_errno,g_msg,'0','N',g_msg1)
                  LET g_errno = ''
                  LET g_msg   = ''
                  LET g_msg1  = ''
                  LET g_showmsg = ''
                  EXIT FOREACH
               END IF

               IF g_success = 'N' THEN
                  EXIT FOREACH
               END IF
            END IF
         END FOREACH

         IF g_success = 'Y' THEN
            #调拨单自动审核
            IF l_ruo.ruo901 = 'N' THEN
               #拨出审核
               LET g_sma.sma142 = 'N' #调拨启用在途
               CALL p810_out_yes(l_ruo.ruo01,l_ruo.ruoplant,'N')
               LET l_sql =  "SELECT ruo01,ruoplant FROM ",cl_get_target_table(l_ruo.ruo05,'ruo_file'),
                            " WHERE ruo011 = ? AND ruoplant = ? "
               CALL cl_replace_sqldb(l_sql) RETURNING l_sql
               CALL cl_parse_qry_sql(l_sql, l_ruo.ruo05) RETURNING l_sql
               PREPARE ruo_sel FROM l_sql
               EXECUTE ruo_sel USING l_ruo.ruo01,l_ruo.ruo05 INTO l_ruo01,l_ruoplant
               #拨入审核
              #CALL p810_in_yes(l_ruo01,l_ruoplant,'N')
            ELSE
              ##如果是多角调拨则产生对应的单据
               INITIALIZE g_oga.* TO NULL
               CALL g_ogb.clear()
               INITIALIZE g_rvu.* TO NULL
               CALL g_rvv.clear()

               CALL p200_auto_doc('ruo_file',l_ruo.ruo05,'N') RETURNING l_ruo.ruo011
               IF g_success = 'Y' THEN

                  LET l_time = TIME
                  LET l_sql = "UPDATE ",cl_get_target_table(p_azw01,'ruo_file'),
                              "   SET ruo011 = '",l_ruo.ruo011,"', ",
                              "       ruoconf = '3', ",
                              "       ruo10   = '",g_today,"', ",
                              "       ruo10t  = '",l_time,"', ",
                              "       ruo11   = '",g_user,"', ",
                              "       ruo12   = '",g_today,"', ",
                              "       ruo12t  = '",l_time,"', ",
                              "       ruo13   = '",g_user,"', ",
                              "       ruo15   = 'Y' ",
                              " WHERE ruo01  = '",l_ruo.ruo01,"' "
                  PREPARE upd_ruo011_pre FROM l_sql
                  EXECUTE upd_ruo011_pre
                  IF SQLCA.sqlcode THEN
                     LET g_success = 'N'
                     LET g_errno = SQLCA.sqlcode
                     LET g_showmsg = 'UPD ruo_file'||' '||'SHOP:'||p_azw01||' '||'SALENO:'||l_rxf.rxf11
                     CALL s_errmsg('Saleno',l_rxf.rxf11,g_showmsg,SQLCA.sqlcode,1)
                     ROLLBACK WORK         
                     LET g_msg1 = 'ruo_file '||'UPD '||p_azw01||' '||l_rxf.rxf11
                     CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg 
                     LET g_msg = g_msg[1,255]
                     CALL p200_log(g_trans_no,p_azw01,l_rxf.rxf11,'02','td_Sale',g_errno,g_msg,'0','N',g_msg1)
                     LET g_errno = ''      
                     LET g_msg   = ''      
                     LET g_msg1  = ''      
                     LET g_showmsg = ''    
                  END IF

                  LET l_sql = "UPDATE ",cl_get_target_table(p_azw01,'rup_file'),
                              "   SET rup18 = 'Y' ",
                              " WHERE rup01 = '",l_ruo.ruo01,"' "
                  PREPARE upd_rup01_pre FROM l_sql 
                  EXECUTE upd_rup01_pre
                  IF SQLCA.sqlcode THEN
                     LET g_success = 'N'   
                     LET g_errno = SQLCA.sqlcode
                     LET g_showmsg = 'UPD rup_file'||' '||'SHOP:'||p_azw01||' '||'SALENO:'||l_rxf.rxf11
                     CALL s_errmsg('Saleno',l_rxf.rxf11,g_showmsg,SQLCA.sqlcode,1)
                     ROLLBACK WORK         
                     LET g_msg1 = 'rup_file '||'UPD '||p_azw01||' '||l_rxf.rxf11
                     CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg 
                     LET g_msg = g_msg[1,255]
                     CALL p200_log(g_trans_no,p_azw01,l_rxf.rxf11,'02','td_Sale',g_errno,g_msg,'0','N',g_msg1)
                     LET g_errno = ''      
                     LET g_msg   = ''      
                     LET g_msg1  = ''      
                     LET g_showmsg = ''
                  END IF

                  LET l_sql = "INSERT INTO ",cl_get_target_table(l_ruo.ruo05,'ruo_file'),"( ",
                              "            ruo01, ",       #產品調撥單號
                              "            ruo011, ",      #對應調撥單號
                              "            ruo02, ",       #來源類型
                              "            ruo03, ",       #來源單號
                              "            ruo04, ",       #撥出營運中心
                              "            ruo05, ",       #撥入營運中心
                              "            ruo06, ",       #nouse
                              "            ruo07, ",       #調撥日期
                              "            ruo08, ",       #調撥人員
                              "            ruo09, ",       #備注
                              "            ruo10, ",       #撥出審核日期
                              "            ruo10t, ",      #撥出審核時間
                              "            ruo11, ",       #撥出審核人員
                              "            ruo12, ",       #撥入審核日期
                              "            ruo12t, ",      #撥入審核時間
                              "            ruo13, ",       #撥入審核人員
                              "            ruo14, ",       #在途倉庫
                              "            ruo15, ",       #當前營運中心過帳否
                              "            ruo901, ",      #多角貿易否
                              "            ruo904, ",      #多角貿易流程代碼
                              "            ruo99, ",       #多角貿易流轉序號
                              "            ruoacti, ",     #資料有效碼
                              "            ruoconf, ",     #審核碼
                              "            ruocrat, ",     #資料創建日
                              "            ruodate, ",     #最近修改日
                              "            ruogrup, ",     #資料所有部門
                              "            ruolegal, ",    #所屬法人
                              "            ruomodu, ",     #資料修改者
                              "            ruoplant, ",    #所屬營運中心
                              "            ruouser, ",     #資料所有者
                              "            ruopos, ",      #已傳POS否(1.新增未下傳2.修改
                              "            ruooriu, ",     #資料建立者
                              "            ruoorig) ",     #資料建立部門
                              "SELECT ",
                              "       ruo011, ",               #ruo01       #產品調撥單號
                              "       ruo01, ",                #ruo011      #對應調撥單號
                              "       ruo02, ",                #ruo02       #來源類型
                              "       ruo03, ",                #ruo03       #來源單號
                              "       ruo04, ",                #ruo04       #撥出營運中心
                              "       ruo05, ",                #ruo05       #撥入營運中心
                              "       ruo06, ",                #ruo06       #nouse
                              "       ruo07, ",                #ruo07       #調撥日期
                              "       ruo08, ",                #ruo08       #調撥人員
                              "       ruo09, ",                #ruo09       #備注
                              "       ruo10, ",                #ruo10       #撥出審核日期
                              "       ruo10t, ",               #ruo10t      #撥出審核時間
                              "       ruo11, ",                #ruo11       #撥出審核人員
                              "       ruo12, ",                #ruo12       #撥入審核日期
                              "       ruo12t, ",               #ruo12t      #撥入審核時間
                              "       ruo13, ",                #ruo13       #撥入審核人員
                              "       ruo14, ",                #ruo14       #在途倉庫
                              "       ruo15, ",                #ruo15       #當前營運中心過帳否
                              "       ruo901, ",               #ruo901      #多角貿易否
                              "       ruo904, ",               #ruo904      #多角貿易流程代碼
                              "       ruo99, ",                #ruo99       #多角貿易流轉序號
                              "       ruoacti, ",              #ruoacti     #資料有效碼
                              "       ruoconf, ",              #ruoconf     #審核碼
                              "       ruocrat, ",              #ruocrat     #資料創建日
                              "       ruodate, ",              #ruodate     #最近修改日
                              "       ruogrup, ",              #ruogrup     #資料所有部門
                              "       '",l_azw02,"', ",        #ruolegal    #所屬法人
                              "       ruomodu, ",              #ruomodu     #資料修改者
                              "       '",l_ruo.ruo05,"', ",    #ruoplant    #所屬營運中心
                              "       ruouser, ",              #ruouser     #資料所有者
                              "       ruopos, ",               #ruopos      #已傳POS否(1.新增未下傳2.修改
                              "       ruooriu, ",              #ruooriu     #資料建立者
                              "       ruoorig  ",              #ruoorig     #資料建立部門
                              "  FROM ",cl_get_target_table(p_azw01,'ruo_file'),
                              " WHERE ruo01 = '",l_ruo.ruo01,"' AND ruoplant = '",p_azw01,"' "
                  PREPARE ins_ruo_pre2 FROM l_sql
                  EXECUTE ins_ruo_pre2
                  IF SQLCA.sqlcode THEN
                     LET g_success = 'N'   
                     LET g_errno = SQLCA.sqlcode
                     LET g_showmsg = 'INS ruo_file'||' '||'SHOP:'||p_azw01||' '||'SALENO:'||l_rxf.rxf11
                     CALL s_errmsg('Saleno',l_rxf.rxf11,g_showmsg,SQLCA.sqlcode,1)
                     ROLLBACK WORK         
                     LET g_msg1 = 'ruo_file '||'INS '||p_azw01||' '||l_rxf.rxf11
                     CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg 
                     LET g_msg = g_msg[1,255]
                     CALL p200_log(g_trans_no,p_azw01,l_rxf.rxf11,'02','td_Sale',g_errno,g_msg,'0','N',g_msg1)
                     LET g_errno = ''      
                     LET g_msg   = ''      
                     LET g_msg1  = ''      
                     LET g_showmsg = ''
                  END IF

                  LET l_sql = "INSERT INTO ",cl_get_target_table(l_ruo.ruo05,'rup_file'),"( ",
                              "            rup01, ",       #產品調撥單號
                              "            rup02, ",       #項次
                              "            rup03, ",       #產品代碼
                              "            rup04, ",       #庫存單位
                              "            rup05, ",       #經營方式
                              "            rup06, ",       #產品條碼
                              "            rup07, ",       #調撥單位
                              "            rup08, ",       #單位換算率
                              "            rup09, ",       #撥出倉庫
                              "            rup10, ",       #撥出儲位
                              "            rup11, ",       #撥出批號
                              "            rup12, ",       #撥出數量
                              "            rup13, ",       #撥入倉庫
                              "            rup14, ",       #撥入儲位
                              "            rup15, ",       #撥入批號
                              "            rup16, ",       #撥入數量
                              "            rup17, ",       #來源項次
                              "            rup18, ",       #結案否
                              "            rup19, ",       #預調撥量
                              "            rup20s, ",      #料件編號
                              "            rup21s, ",      #項次
                              "            rup22, ",       #收貨營運中心
                              "            ruplegal, ",    #所屬法人
                              "            rupplant) ",    #所屬營運中心
                              "SELECT ",
                              "       '",l_ruo.ruo011,"', ",      #rup01        #產品調撥單號
                              "       rup02, ",                   #rup02        #項次
                              "       rup03, ",                   #rup03        #產品代碼
                              "       rup04, ",                   #rup04        #庫存單位
                              "       rup05, ",                   #rup05        #經營方式
                              "       rup06, ",                   #rup06        #產品條碼
                              "       rup07, ",                   #rup07        #調撥單位
                              "       rup08, ",                   #rup08        #單位換算率
                              "       rup09, ",                   #rup09        #撥出倉庫
                              "       rup10, ",                   #rup10        #撥出儲位
                              "       rup11, ",                   #rup11        #撥出批號
                              "       rup12, ",                   #rup12        #撥出數量
                              "       rup13, ",                   #rup13        #撥入倉庫
                              "       rup14, ",                   #rup14        #撥入儲位
                              "       rup15, ",                   #rup15        #撥入批號
                              "       rup16, ",                   #rup16        #撥入數量
                              "       rup17, ",                   #rup17        #來源項次
                              "       rup18, ",                   #rup18        #結案否
                              "       rup19, ",                   #rup19        #預調撥量
                              "       rup20s, ",                  #rup20s       #料件編號
                              "       rup21s, ",                  #rup21s       #項次
                              "       rup22, ",                   #rup22        #收貨營運中心
                              "       '",l_azw02,"', ",           #ruplegal     #所屬法人
                              "       '",l_ruo.ruo05,"'  ",       #rupplant     #所屬營運中心 
                              "  FROM ",cl_get_target_table(p_azw01,'rup_file'),
                              " WHERE rup01 = '",l_ruo.ruo01,"' AND rupplant = '",p_azw01,"' "
                  PREPARE ins_rup_pre2 FROM l_sql
                  EXECUTE ins_rup_pre2
                  IF SQLCA.sqlcode THEN
                     LET g_success = 'N'   
                     LET g_errno = SQLCA.sqlcode
                     LET g_showmsg = 'INS rup_file'||' '||'SHOP:'||p_azw01||' '||'SALENO:'||l_rxf.rxf11
                     CALL s_errmsg('Saleno',l_rxf.rxf11,g_showmsg,SQLCA.sqlcode,1)
                     ROLLBACK WORK         
                     LET g_msg1 = 'rup_file '||'INS '||p_azw01||' '||l_rxf.rxf11
                     CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg 
                     LET g_msg = g_msg[1,255]
                     CALL p200_log(g_trans_no,p_azw01,l_rxf.rxf11,'02','td_Sale',g_errno,g_msg,'0','N',g_msg1)
                     LET g_errno = ''      
                     LET g_msg   = ''      
                     LET g_msg1  = ''      
                     LET g_showmsg = ''
                  END IF

                  CALL p200_oga_rvu_default(l_ruo.*)
                  IF g_success = 'N' THEN
                     LET g_msg1 = 'oga_file/rvu_file '||'Get Default '||p_azw01||' '||l_rxf.rxf11
                     CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
                     LET g_msg = g_msg[1,255]
                     CALL p200_log(g_trans_no,p_azw01,l_rxf.rxf11,'02','td_Sale',g_errno,g_msg,'0','N',g_msg1)
                     LET g_errno = ''
                     LET g_msg   = ''
                     LET g_msg1  = ''
                     LET g_showmsg = ''
                  END IF

                  #产生出货单
                  CALL s_insoga(g_oga.*,g_ogb)
                  IF g_success = 'N' THEN
                     ROLLBACK WORK         
                     LET g_msg1 = 'oga_file/ogb_file '||'INS '||p_azw01||' '||l_rxf.rxf11
                     CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
                     LET g_msg = g_msg[1,255]
                     CALL p200_log(g_trans_no,p_azw01,l_rxf.rxf11,'02','td_Sale',g_errno,g_msg,'0','N',g_msg1)
                     LET g_errno = ''
                     LET g_msg   = ''
                     LET g_msg1  = ''
                     LET g_showmsg = ''
                  END IF

                  #产生入库单
                  CALL s_insrvu(g_rvu.*,g_rvv)
                  IF g_success = 'N' THEN
                     ROLLBACK WORK         
                     LET g_msg1 = 'rvu_file/rvv_file '||'INS '||p_azw01||' '||l_rxf.rxf11
                     CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
                     LET g_msg = g_msg[1,255]
                     CALL p200_log(g_trans_no,p_azw01,l_rxf.rxf11,'02','td_Sale',g_errno,g_msg,'0','N',g_msg1)
                     LET g_errno = ''
                     LET g_msg   = ''
                     LET g_msg1  = ''
                     LET g_showmsg = ''
                  END IF

                  #出货单过账
                  CALL s_oga_post(l_ruo.ruoplant,g_oga.oga01)
                  IF g_success = 'N' THEN
                     ROLLBACK WORK         
                     LET g_msg1 = 'oga_file '||'POST '||p_azw01||' '||l_rxf.rxf11
                     CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
                     LET g_msg = g_msg[1,255]
                     CALL p200_log(g_trans_no,p_azw01,l_rxf.rxf11,'02','td_Sale',g_errno,g_msg,'0','N',g_msg1)
                     LET g_errno = ''
                     LET g_msg   = ''
                     LET g_msg1  = ''
                     LET g_showmsg = ''
                  END IF

                  #入库单过账
                  CALL s_rvu_post(l_ruo.ruo05,g_rvu.rvu01)
                  IF g_success = 'N' THEN
                     ROLLBACK WORK         
                     LET g_msg1 = 'rvu_file '||'POST '||p_azw01||' '||l_rxf.rxf11
                     CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
                     LET g_msg = g_msg[1,255]
                     CALL p200_log(g_trans_no,p_azw01,l_rxf.rxf11,'02','td_Sale',g_errno,g_msg,'0','N',g_msg1)
                     LET g_errno = ''
                     LET g_msg   = ''
                     LET g_msg1  = ''
                     LET g_showmsg = ''
                  END IF

                  #ins_rxg
                  LET l_sql = "SELECT * FROM ",cl_get_target_table(l_ruo.ruo05,'ruo_file'),
                              " WHERE ruo01 = '",l_ruo.ruo011,"' ",
                              "   AND ruoplant = '",l_ruo.ruo05,"' "
                  PREPARE sel_ruo_ruo05_pre FROM l_sql
                  EXECUTE sel_ruo_ruo05_pre INTO l_ruo.*
                  CALL t256_sub_ins_rxg(l_ruo.*)
                  IF g_success = 'N' THEN
                     ROLLBACK WORK         
                     LET g_msg1 = 'rxg_file '||'INS '||p_azw01||' '||l_rxf.rxf11
                     CALL cl_getmsg(g_errno,g_lang) RETURNING g_msg
                     LET g_msg = g_msg[1,255]
                     CALL p200_log(g_trans_no,p_azw01,l_rxf.rxf11,'02','td_Sale',g_errno,g_msg,'0','N',g_msg1)
                     LET g_errno = ''
                     LET g_msg   = ''
                     LET g_msg1  = ''
                     LET g_showmsg = ''
                  END IF
               END IF
            END IF
         END IF
      END IF 
      
      IF g_success = 'Y' THEN
         LET g_sucflag = 1
         COMMIT WORK
         CALL p810_temp('2')
      ELSE
         ROLLBACK WORK
         INITIALIZE l_rxf.* TO NULL
         CALL p810_temp('2')
         CONTINUE FOREACH
      END IF
      
      INITIALIZE l_rxf.*,l_ruo.* TO NULL 
   END FOREACH
END FUNCTION 
#FUN-CC0082 Add End -----

FUNCTION p200_oga_rvu_default(p_ruo)
DEFINE p_ruo     RECORD LIKE ruo_file.*
DEFINE p_rup     RECORD LIKE rup_file.*
DEFINE l_cnt     LIKE type_file.num10
DEFINE l_sql     STRING
DEFINE l_ima25   LIKE ima_file.ima25
DEFINE l_flag    LIKE type_file.chr1
DEFINE l_success LIKE type_file.chr1

   IF g_success = 'N' THEN RETURN END IF

   LET g_ndate = p_ruo.ruo07
   CALL p200_auto_doc("rvu_file",p_ruo.ruo05,'N') RETURNING g_rvu.rvu01
   IF g_success = 'N' THEN RETURN END IF
   CALL p200_auto_doc("oga_file",p_ruo.ruoplant,'N') RETURNING g_oga.oga01
   IF g_success = 'N' THEN RETURN END IF
   
   #出货单单头
   LET g_oga.oga00    = '1'              #出貨別
  #LET g_oga.oga01    = ''               #出貨單號
   LET g_oga.oga011   = NULL             #出貨通知單號
   LET g_oga.oga02    = p_ruo.ruo07      #出貨日期
   LET g_oga.oga021   = p_ruo.ruo07      #結關日期
   LET g_oga.oga022   = NULL             #裝船日期
   LET g_oga.oga03    = p_ruo.ruo05      #帳款客戶編號
  #LET g_oga.oga032   = occ02            #帳款客戶簡稱
  #LET g_oga.oga033   = occ11            #帳款客戶稅號
   LET g_oga.oga04    = p_ruo.ruo05      #送貨客戶編號
   LET g_oga.oga044   = NULL             #送貨地址碼
  #LET g_oga.oga05    = occ08            #發票別
   LET g_oga.oga06    = NULL             #更改版本
   LET g_oga.oga07    = 'N'              #出貨是否計入未開發票的銷貨待驗收入
   LET g_oga.oga08    = '2'              #1.內銷 2.外銷  3.視同外銷
   LET g_oga.oga09    = '6'              #單據別
   LET g_oga.oga10    = NULL             #帳單編號
   LET g_oga.oga11    = NULL             #應收款日
   LET g_oga.oga12    = NULL             #容許票據到期日
   LET g_oga.oga13    = NULL             #科目分類碼
   LET g_oga.oga14    = p_ruo.ruouser    #人員編號
   LET g_oga.oga15    = p_ruo.ruogrup    #部門編號
   LET g_oga.oga16    = NULL             #訂單單號
   LET g_oga.oga161   = 0                #訂金應收比率
   LET g_oga.oga162   = 100              #出貨應收比率
   LET g_oga.oga163   = 0                #尾款應收比率
   LET g_oga.oga17    = NULL             #排貨模擬順序
   LET g_oga.oga18    = p_ruo.ruo05      #收款客戶編號
   LET g_oga.oga19    = NULL             #待抵帳款-預收單號
   LET g_oga.oga20    = 'Y'              #分錄底稿是否可重新生成
  #LET g_oga.oga21    = occ41            #稅種
  #LET g_oga.oga211   = gec04            #稅率
  #LET g_oga.oga212   = gec05            #聯數
  #LET g_oga.oga213   = gec07            #含稅否
  #LET g_oga.oga23    = occ42            #幣種
  #LET g_oga.oga24    = 1                #匯率 #CALL s_currm(oga23,oga02,g_oaz.oaz52,p_azw01)
  #LET g_oga.oga25    = occ43            #銷售分類一
   LET g_oga.oga26    = NULL             #銷售分類二
   LET g_oga.oga27    = NULL             #Invoice No.
   LET g_oga.oga28    = 'N'              #立帳時採用訂單匯率
   LET g_oga.oga29    = NULL             #信用額度餘額
   LET g_oga.oga30    = 'N'              #包裝單審核碼
  #LET g_oga.oga31    = occ44            #價格條件編號
  #LET g_oga.oga32    = occ45            #收款條件編號
   LET g_oga.oga33    = NULL             #其它條件
   LET g_oga.oga34    = NULL             #佣金率
   LET g_oga.oga35    = NULL             #外銷方式
   LET g_oga.oga36    = NULL             #非經海關証明文件名稱
   LET g_oga.oga37    = NULL             #非經海關証明文件號碼
   LET g_oga.oga38    = NULL             #出口報單類型
   LET g_oga.oga39    = NULL             #出口報單號碼
   LET g_oga.oga40    = NULL             #NOTIFY
   LET g_oga.oga41    = NULL             #起運地
   LET g_oga.oga42    = NULL             #到達地
   LET g_oga.oga43    = NULL             #交運方式
   LET g_oga.oga44    = NULL             #嘜頭編號
   LET g_oga.oga45    = NULL             #聯絡人
   LET g_oga.oga46    = NULL             #項目編號
   LET g_oga.oga47    = NULL             #船名/車號
   LET g_oga.oga48    = NULL             #航次
   LET g_oga.oga49    = NULL             #卸貨港
   LET g_oga.oga50    = 0                #原幣出貨金額
   LET g_oga.oga501   = 0                #本幣出貨金額
   LET g_oga.oga51    = 0                #原幣出貨金額
   LET g_oga.oga511   = 0                #本幣出貨金額
   LET g_oga.oga52    = 0                #原幣預收訂金轉銷貨收入金額
   LET g_oga.oga53    = 0                #原幣應開發票稅前金額
   LET g_oga.oga54    = 0                #原幣已開發票稅前金額
   LET g_oga.oga55    = '1'              #狀況碼
   LET g_oga.oga56    = NULL             #簽收單號
   LET g_oga.oga57    = '1'              #發票性質
   LET g_oga.oga65    = 'N'              #客戶出貨簽收否
   LET g_oga.oga66    = NULL             #出貨簽收在途/驗退倉庫
   LET g_oga.oga67    = NULL             #出貨簽收在途/驗退庫位
   LET g_oga.oga68    = NULL             #No Use
  #LET g_oga.oga69    = p_ruo.ruo07      #錄入日期 #FUN-D10144 Mark
   LET g_oga.oga69    = p_ruo.ruodate    #錄入日期 #FUN-D10144 Add
   LET g_oga.oga70    = NULL             #調撥單號
   LET g_oga.oga71    = NULL             #申報統編
   LET g_oga.oga83    = p_ruo.ruoplant   #銷貨機構
   LET g_oga.oga84    = p_ruo.ruoplant   #取貨機構
   LET g_oga.oga85    = '2'              #結算方式
   LET g_oga.oga86    = NULL             #客層代碼
   LET g_oga.oga87    = NULL             #會員卡號
   LET g_oga.oga88    = NULL             #顧客姓名
   LET g_oga.oga89    = NULL             #聯系電話
   LET g_oga.oga90    = NULL             #證件類型
   LET g_oga.oga91    = NULL             #證件號碼
   LET g_oga.oga92    = NULL             #贈品發放單號
   LET g_oga.oga93    = NULL             #返券發放單號
   LET g_oga.oga94    = 'N'              #POS銷售否 Y-是,N-否
   LET g_oga.oga95    = 0                #本次積分  #carrier
   LET g_oga.oga96    = NULL             #收銀機號
   LET g_oga.oga97    = NULL             #交易序號
   LET g_oga.oga98    = NULL             #POS單號
   LET g_oga.oga99    = p_ruo.ruo99      #多角貿易流程序號
   LET g_oga.oga901   = 'N'              #post to abx system flag
   LET g_oga.oga902   = NULL             #信用超限留置代碼
   LET g_oga.oga903   = 'Y'              #信用檢查放行否
   LET g_oga.oga904   = NULL             #No Use
   LET g_oga.oga905   = 'N'              #已轉三角貿易出貨單否
   LET g_oga.oga906   = 'Y'              #起始出貨單否
   LET g_oga.oga907   = NULL             #憑証號碼
   LET g_oga.oga908   = NULL             #L/C NO
   LET g_oga.oga909   = 'Y'              #三角貿易否
   LET g_oga.oga910   = NULL             #境外倉庫
   LET g_oga.oga911   = NULL             #境外庫位
   LET g_oga.oga912   = NULL             #保稅異動原因代碼
   LET g_oga.oga913   = NULL             #保稅報單日期
   LET g_oga.oga914   = NULL             #入庫單號
   LET g_oga.ogaconf  = 'Y'              #審核否/作廢碼
   LET g_oga.ogacond  = p_ruo.ruo10      #確認日期
   LET g_oga.ogacont  = p_ruo.ruo10t     #確認時間
   LET g_oga.ogaconu  = p_ruo.ruouser    #確認人員
   LET g_oga.ogapost  = 'N'              #出貨扣帳否
   LET g_oga.ogaprsw  = 0                #打印次數
   LET g_oga.ogauser  = p_ruo.ruouser    #資料所有者
   LET g_oga.ogagrup  = p_ruo.ruogrup    #資料所有部門
   LET g_oga.ogamodu  = NULL             #資料更改者
  #LET g_oga.ogadate  = p_ruo.ruo07      #最近更改日 #FUN-D10144 Mark
   LET g_oga.ogadate  = p_ruo.ruodate    #最近更改日 #FUN-D10144 Add
   LET g_oga.ogamksg  = 'N'              #簽核
   LET g_oga.oga1001  = p_ruo.ruo05      #收款客戶編號
   LET g_oga.oga1002  = NULL             #債權代碼
   LET g_oga.oga1003  = NULL             #業績歸屬方
   LET g_oga.oga1004  = NULL             #調貨客戶
   LET g_oga.oga1005  = NULL             #是否計算業績
   LET g_oga.oga1006  = 0                #折扣金額(稅前)
   LET g_oga.oga1007  = 0                #折扣金額(含稅)
   LET g_oga.oga1008  = 0                #出貨總含稅金額
   LET g_oga.oga1009  = NULL             #客戶所屬渠道
   LET g_oga.oga1010  = NULL             #客戶所屬方
   LET g_oga.oga1011  = NULL             #開票客戶 
   LET g_oga.oga1012  = NULL             #銷退單單號
   LET g_oga.oga1013  = 'N'              #已打印提單否
   LET g_oga.oga1014  = 'N'              #調貨銷退單所自動生成否
   LET g_oga.oga1015  = NULL             #導物流狀況碼
   LET g_oga.oga1016  = NULL             #代送商
   LET g_oga.ogaspc   = NULL             #SPC拋轉碼 0/1/2 
   LET g_oga.ogaud01  = NULL             #自訂欄位-Textedit
   LET g_oga.ogaud02  = NULL             #自訂欄位-文字
   LET g_oga.ogaud03  = NULL             #自訂欄位-文字 
   LET g_oga.ogaud04  = NULL             #自訂欄位-文字
   LET g_oga.ogaud05  = NULL             #自訂欄位-文字
   LET g_oga.ogaud06  = NULL             #自訂欄位-文字
   LET g_oga.ogaud07  = NULL             #自訂欄位-數值
   LET g_oga.ogaud08  = NULL             #自訂欄位-數值
   LET g_oga.ogaud09  = NULL             #自訂欄位-數值
   LET g_oga.ogaud10  = NULL             #自訂欄位-整數
   LET g_oga.ogaud11  = NULL             #自訂欄位-整數
   LET g_oga.ogaud12  = NULL             #自訂欄位-整數
   LET g_oga.ogaud13  = NULL             #自訂欄位-日期
   LET g_oga.ogaud14  = NULL             #自訂欄位-日期
   LET g_oga.ogaud15  = NULL             #自訂欄位-日期
   LET g_oga.ogaplant = p_ruo.ruoplant   #所屬工廠  #出货端的工厂  #carrier
   LET g_oga.ogalegal = p_ruo.ruolegal   #所屬法人  #出货端的工厂  #carrier
  #LET g_oga.ogacond  = p_ruo.ruo07      #審核日期 #FUN-D10144 Mark
   LET g_oga.ogacond  = p_ruo.ruodate    #審核日期 #FUN-D10144 Add
   LET g_oga.ogaconu  = p_ruo.ruouser    #審核人員
   LET g_oga.ogaoriu  = p_ruo.ruouser    #資料建立者
   LET g_oga.ogaorig  = p_ruo.ruogrup    #資料建立部門

   LET l_sql = "SELECT DISTINCT occ02,occ09,occ41,occ42,occ43,occ44, ",
               "                occ45,occ46,occ47,occ48,occ49 ",
               "  FROM ",cl_get_target_table(p_ruo.ruoplant,'occ_file'),
               " WHERE occ01 = '",g_oga.oga03,"' "
   CALL cl_replace_sqldb(l_sql) RETURNING l_sql
   CALL cl_parse_qry_sql(l_sql,p_ruo.ruoplant) RETURNING l_sql
   PREPARE sel_occ_oga_pre2 FROM l_sql
   EXECUTE sel_occ_oga_pre2 INTO g_oga.oga032,g_oga.oga04,g_oga.oga21,g_oga.oga23,
                                 g_oga.oga25,g_oga.oga31,g_oga.oga32,g_oga.oga33,
                                 g_oga.oga43,g_oga.oga41,g_oga.oga42

   LET l_sql="SELECT DISTINCT gec04,gec05,gec07",
             "  FROM ",cl_get_target_table(p_ruo.ruoplant,'gec_file'),
             " WHERE gec01 = '",g_oga.oga21,"'",
             "   AND gec011 = '2'"
   CALL cl_replace_sqldb(l_sql) RETURNING l_sql
   CALL cl_parse_qry_sql(l_sql,p_ruo.ruoplant) RETURNING l_sql
   PREPARE sel_gec_oga_pre2 FROM l_sql
   EXECUTE sel_gec_oga_pre2 INTO g_oga.oga211,g_oga.oga212,g_oga.oga213

   IF cl_null(g_oga.oga211) THEN LET g_oga.oga211 = 0 END IF
   CALL s_currm(g_oga.oga23,g_oga.oga02,g_oaz.oaz52,p_ruo.ruoplant) RETURNING g_oga.oga24 #匯率
   
   #入库单单头
   LET g_rvu.rvu00    = '1'              #異動類別
  #LET g_rvu.rvu01    = ''               #入庫單號/退貨單號
   LET g_rvu.rvu02    = NULL             #收貨單號
   LET g_rvu.rvu03    = p_ruo.ruo07      #異動日期
   LET g_rvu.rvu04    = p_ruo.ruoplant   #廠商編號
   LET l_sql = "SELECT pmc03 FROM ",cl_get_target_table(p_ruo.ruo05,'pmc_file')," WHERE pmc01 = '",p_ruo.ruoplant,"' "
   PREPARE sel_rvu05_pre FROM l_sql
   EXECUTE sel_rvu05_pre INTO g_rvu.rvu05 #廠商簡稱
   LET g_rvu.rvu06    = p_ruo.ruogrup    #採購部門
   LET g_rvu.rvu07    = p_ruo.ruouser    #人員
   LET g_rvu.rvu08    = 'TAP'            #採購性質
   LET g_rvu.rvu09    = NULL             #取回日期
   LET g_rvu.rvu10    = NULL             #開立折讓單否
   LET g_rvu.rvu11    = NULL             #折讓單日期
   LET g_rvu.rvu12    = NULL             #稅率
   LET g_rvu.rvu13    = NULL             #折讓單未稅金額
   LET g_rvu.rvu14    = NULL             #折讓單稅額
   LET g_rvu.rvu15    = NULL             #折讓原發票號
   LET g_rvu.rvu17    = '1'              #簽核狀況
   LET g_rvu.rvu20    = 'Y'              #多角貿易拋轉否
   LET g_rvu.rvu21    = '1'              #經營方式
   LET g_rvu.rvu22    = p_ruo.ruo05      #採購營運中心
   LET g_rvu.rvu27    = '1'              #虛擬類型
   LET g_rvu.rvu99    = p_ruo.ruo99      #多角流程序號
   LET g_rvu.rvu900   = '1'              #狀況碼
   LET g_rvu.rvupos   = '1'              #已傳POS否
   LET g_rvu.rvuconf  = 'Y'              #確認碼
   LET g_rvu.rvucond  = p_ruo.ruo10      #確認日期
   LET g_rvu.rvucont  = p_ruo.ruo10t     #確認時間
   LET g_rvu.rvuconu  = p_ruo.ruouser    #確認人員
   LET g_rvu.rvuacti  = 'Y'              #資料有效碼
   LET g_rvu.rvumksg  = 'N'              #是否簽核
   LET g_rvu.rvuuser  = p_ruo.ruouser    #資料所有者
   LET g_rvu.rvugrup  = p_ruo.ruogrup    #資料所有部門
   LET g_rvu.rvumodu  = NULL             #資料修改者
   LET g_rvu.rvudate  = NULL             #資料修改日
   LET g_rvu.rvuplant = p_ruo.ruo05      #所屬營運中心
   LET l_sql = "SELECT azw02 FROM ",cl_get_target_table(p_ruo.ruo05,'azw_file')," WHERE azw01 = '",p_ruo.ruo05,"' "
   PREPARE sel_rvulegal_pre FROM l_sql
   EXECUTE sel_rvulegal_pre INTO g_rvu.rvulegal    #所屬法人
   LET g_rvu.rvuoriu  = p_ruo.ruouser    #資料建立者
   LET g_rvu.rvuorig  = p_ruo.ruogrup    #資料建立部門
   LET g_rvu.rvuud01  = NULL             #自訂欄位-Textedit
   LET g_rvu.rvuud02  = NULL             #自訂欄位-文字
   LET g_rvu.rvuud03  = NULL             #自訂欄位-文字
   LET g_rvu.rvuud04  = NULL             #自訂欄位-文字
   LET g_rvu.rvuud05  = NULL             #自訂欄位-文字
   LET g_rvu.rvuud06  = NULL             #自訂欄位-文字
   LET g_rvu.rvuud07  = NULL             #自訂欄位-數值
   LET g_rvu.rvuud08  = NULL             #自訂欄位-數值
   LET g_rvu.rvuud09  = NULL             #自訂欄位-數值
   LET g_rvu.rvuud10  = NULL             #自訂欄位-整數
   LET g_rvu.rvuud11  = NULL             #自訂欄位-整數
   LET g_rvu.rvuud12  = NULL             #自訂欄位-整數
   LET g_rvu.rvuud13  = NULL             #自訂欄位-日期
   LET g_rvu.rvuud14  = NULL             #自訂欄位-日期
   LET g_rvu.rvuud15  = NULL             #自訂欄位-日期
   
   LET l_cnt = 1
   INITIALIZE p_rup.* TO NULL
   LET l_sql = "SELECT * FROM ",cl_get_target_table(p_ruo.ruoplant,'rup_file'),
               " WHERE rup01 = '",p_ruo.ruo01 CLIPPED,"' ",
               " ORDER BY rup02 "
   PREPARE sep_rup_pre FROM l_sql
   DECLARE sep_rup_cs CURSOR FOR sep_rup_pre
   FOREACH sep_rup_cs INTO p_rup.*
   
      #新增入库单单身
      LET g_rvv[l_cnt].rvv01  = g_rvu.rvu01                                      #入庫單號
      LET g_rvv[l_cnt].rvv02  = p_rup.rup02                                      #項次
      LET g_rvv[l_cnt].rvv03  = '1'                                              #異動類別
      LET g_rvv[l_cnt].rvv04  = NULL                                             #驗收單號
      LET g_rvv[l_cnt].rvv05  = NULL                                             #項次
      LET g_rvv[l_cnt].rvv06  = p_ruo.ruoplant                                   #廠商編號
      LET g_rvv[l_cnt].rvv09  = p_ruo.ruo07                                      #異動日期
      LET g_rvv[l_cnt].rvv10  = '4'                                              #取價類型
      LET g_rvv[l_cnt].rvv17  = p_rup.rup16                                      #數量
      LET g_rvv[l_cnt].rvv22  = NULL                                             #發票編號
      LET g_rvv[l_cnt].rvv23  = 0                                                #已請款匹配量
      LET g_rvv[l_cnt].rvv88  = 0                                                #暫估數量
      LET g_rvv[l_cnt].rvv25  = 'N'                                              #樣品否
      LET g_rvv[l_cnt].rvv31  = p_rup.rup03                                      #料件編號  
     #LET g_rvv[l_cnt].rvv031 = ima02                                            #品名规格
      LET g_rvv[l_cnt].rvv32  = p_rup.rup13                                      #倉庫
      LET g_rvv[l_cnt].rvv33  = p_rup.rup14                                      #儲
      LET g_rvv[l_cnt].rvv34  = p_rup.rup15                                      #批
      LET g_rvv[l_cnt].rvv35  = p_rup.rup07                                      #單位
      LET g_rvv[l_cnt].rvv17  = s_digqty(g_rvv[l_cnt].rvv17,g_rvv[l_cnt].rvv35)
      LET g_rvv[l_cnt].rvv36  = NULL                                             #採購單號
      LET g_rvv[l_cnt].rvv37  = NULL                                             #採購序號
      LET g_rvv[l_cnt].rvv80  = NULL                                             #單位一                  
      LET g_rvv[l_cnt].rvv81  = NULL                                             #單位一換算率(與採購單位)
      LET g_rvv[l_cnt].rvv82  = NULL                                             #單位一數量              
      LET g_rvv[l_cnt].rvv83  = NULL                                             #單位二                  
      LET g_rvv[l_cnt].rvv84  = NULL                                             #單位二換算率(與採購單位)
      LET g_rvv[l_cnt].rvv85  = NULL                                             #單位二數量              
      LET g_rvv[l_cnt].rvv86  = p_rup.rup07                                      #計價單位                
      LET g_rvv[l_cnt].rvv87  = p_rup.rup12                                      #計價數量                
      LET g_rvv[l_cnt].rvv89  = 'N'                                              #VMI退貨否
      LET g_rvv[l_cnt].rvv930 = p_ruo.ruoplant                                   #採購成本中心 
      LET g_rvv[l_cnt].rvvplant  = g_rvu.rvuplant                                #所屬營運中心
      LET g_rvv[l_cnt].rvvlegal  = g_rvu.rvulegal                                #所屬法人

      INITIALIZE l_ima25 TO NULL
      LET l_sql = "SELECT ima02,ima25 FROM ",cl_get_target_table(p_ruo.ruoplant,'ima_file')," WHERE ima01 = '",p_rup.rup03,"' "
      PREPARE oga_rvu_default_sel_ima_pre FROM l_sql
      EXECUTE oga_rvu_default_sel_ima_pre INTO g_rvv[l_cnt].rvv031,l_ima25
      
      #单位转换率
      IF l_ima25 = g_rvv[l_cnt].rvv35 THEN
         LET g_rvv[l_cnt].rvv35_fac = 1
      ELSE
         CALL s_umfchkm(g_rvv[l_cnt].rvv31,g_rvv[l_cnt].rvv35,l_ima25,p_ruo.ruoplant)
              RETURNING l_flag,g_rvv[l_cnt].rvv35_fac
         IF l_flag THEN
            CALL cl_err('','mfg3075',1)
            LET g_success = 'N'
            RETURN
         END IF
      END IF 
      
      #取价
      #未税单价
      CALL s_trade_price(p_ruo.ruoplant,p_ruo.ruo05,p_ruo.ruoplant,p_rup.rup03,p_rup.rup07) RETURNING l_success,g_rvv[l_cnt].rvv38
      IF l_success = 'N' OR cl_null(g_rvv[l_cnt].rvv38) THEN
         SELECT rtg05 INTO g_rvv[l_cnt].rvv38 
           FROM rtg_file 
          WHERE rtg03 = p_rup.rup03 AND rtg04 = p_rup.rup07 AND rtg01 = (SELECT rtz05 FROM rtz_file WHERE rtz01 = p_azw01)
         IF cl_null(g_rvv[l_cnt].rvv38 ) THEN 
            LET g_rvv[l_cnt].rvv38 = 0
         END IF
      END IF
      
      #含税单价
      LET g_rvv[l_cnt].rvv38t = g_rvv[l_cnt].rvv38*(1+g_oga.oga211/100)
      CALL cl_digcut(g_rvv[l_cnt].rvv38,g_azi03) RETURNING g_rvv[l_cnt].rvv38
      CALL cl_digcut(g_rvv[l_cnt].rvv38t,g_azi03) RETURNING g_rvv[l_cnt].rvv38t
      
      LET g_rvv[l_cnt].rvv39 = g_rvv[l_cnt].rvv38 * g_rvv[l_cnt].rvv87   #金額  
      LET g_rvv[l_cnt].rvv39t= g_rvv[l_cnt].rvv38t * g_rvv[l_cnt].rvv87
      CALL cl_digcut(g_rvv[l_cnt].rvv39,g_azi04) RETURNING g_rvv[l_cnt].rvv39
      CALL cl_digcut(g_rvv[l_cnt].rvv39t,g_azi04) RETURNING g_rvv[l_cnt].rvv39t

      #新增出货单单身
      LET g_ogb[l_cnt].ogb01   = g_oga.oga01                                      #出貨單號
      LET g_ogb[l_cnt].ogb03   = p_rup.rup02                                      #項次
      LET g_ogb[l_cnt].ogb04   = p_rup.rup03                                      #產品編號
      LET g_ogb[l_cnt].ogb05   = p_rup.rup07                                      #銷售單位
      LET g_ogb[l_cnt].ogb05_fac = g_rvv[l_cnt].rvv35_fac                         #銷售/庫存彙總單位換算率
      LET g_ogb[l_cnt].ogb06   = g_rvv[l_cnt].rvv031                              #品名規格
      LET g_ogb[l_cnt].ogb07   = NULL                                             #額外品名編號
      LET g_ogb[l_cnt].ogb08   = NULL                                             #出貨營運中心編號
      LET g_ogb[l_cnt].ogb09   = p_rup.rup09                                      #出貨倉庫編號
      LET g_ogb[l_cnt].ogb091  = p_rup.rup10                                      #出貨儲位編號
      LET g_ogb[l_cnt].ogb092  = p_rup.rup11                                      #出貨批號
      LET g_ogb[l_cnt].ogb11   = NULL                                             #客戶產品編號
      LET g_ogb[l_cnt].ogb12   = p_rup.rup12                                      #實際出貨數量
      LET g_ogb[l_cnt].ogb13   = g_rvv[l_cnt].rvv38t                              #原幣單價
      LET g_ogb[l_cnt].ogb14   = g_rvv[l_cnt].rvv39                               #原幣未稅金額
      LET g_ogb[l_cnt].ogb14t  = g_rvv[l_cnt].rvv39t                              #原幣含稅金額
      IF cl_null(g_ogb[l_cnt].ogb13)  THEN LET g_ogb[l_cnt].ogb13 = 0 END IF
      IF cl_null(g_ogb[l_cnt].ogb14)  THEN LET g_ogb[l_cnt].ogb14 = 0 END IF
      IF cl_null(g_ogb[l_cnt].ogb14t) THEN LET g_ogb[l_cnt].ogb14t= 0 END IF
      
      LET g_sql = " SELECT img09 FROM ",cl_get_target_table(p_ruo.ruoplant,'img_file'),
                  "  WHERE img01 = '",g_ogb[l_cnt].ogb04,"' ",
                  "    AND img02 = '",g_ogb[l_cnt].ogb09,"' ",
                  "    AND img03 = '",g_ogb[l_cnt].ogb091,"' ",
                  "    AND img04 = '",g_ogb[l_cnt].ogb092,"' "
      PREPARE img_pre FROM g_sql
      EXECUTE img_pre INTO g_ogb[l_cnt].ogb15                                     #庫存明細單位由廠/倉/儲/批自動得出
      LET g_ogb[l_cnt].ogb15_fac = g_rvv[l_cnt].rvv35_fac                         #銷售/庫存明細單位換算率
      LET g_ogb[l_cnt].ogb16   = g_ogb[l_cnt].ogb12*g_ogb[l_cnt].ogb15_fac        #數量
      LET g_ogb[l_cnt].ogb16   = s_digqty(g_ogb[l_cnt].ogb16,g_ogb[l_cnt].ogb15)  #
      LET g_ogb[l_cnt].ogb17   = 'N'                                              #多倉儲批出貨否
      LET g_ogb[l_cnt].ogb18   = g_ogb[l_cnt].ogb12                               #預計出貨數量
      LET g_ogb[l_cnt].ogb19   = 'N'                                              #檢驗否
      LET g_ogb[l_cnt].ogb20   = NULL                                             #No Use
      LET g_ogb[l_cnt].ogb21   = NULL                                             #No Use
      LET g_ogb[l_cnt].ogb22   = NULL                                             #No Use
      LET g_ogb[l_cnt].ogb31   = NULL                                             #訂單單號
      LET g_ogb[l_cnt].ogb32   = NULL                                             #訂單項次
      LET g_ogb[l_cnt].ogb37   = g_ogb[l_cnt].ogb13                               #基礎單價
      LET g_ogb[l_cnt].ogb60   = 0                                                #已開發票數量
      LET g_ogb[l_cnt].ogb63   = 0                                                #銷退數量
      LET g_ogb[l_cnt].ogb64   = 0                                                #銷退數量
      LET g_ogb[l_cnt].ogb901  = NULL                                             #No Use
      LET g_ogb[l_cnt].ogb902  = NULL                                             #No Use
      LET g_ogb[l_cnt].ogb903  = NULL                                             #No Use
      LET g_ogb[l_cnt].ogb904  = NULL                                             #No Use
      LET g_ogb[l_cnt].ogb905  = NULL                                             #No Use
      LET g_ogb[l_cnt].ogb906  = NULL                                             #No Use
      LET g_ogb[l_cnt].ogb907  = NULL                                             #No Use
      LET g_ogb[l_cnt].ogb908  = NULL                                             #手冊編號
      LET g_ogb[l_cnt].ogb909  = NULL                                             #No Use
      LET g_ogb[l_cnt].ogb910  = NULL                                             #單位一
      LET g_ogb[l_cnt].ogb911  = NULL                                             #單位一換算率(與銷售單位)
      LET g_ogb[l_cnt].ogb912  = NULL                                             #單位一數量
      LET g_ogb[l_cnt].ogb913  = NULL                                             #單位二
      LET g_ogb[l_cnt].ogb914  = NULL                                             #單位二換算率(與銷售單位)
      LET g_ogb[l_cnt].ogb915  = NULL                                             #單位二數量
      LET g_ogb[l_cnt].ogb916  = p_rup.rup07                                      #計價單位
      LET g_ogb[l_cnt].ogb917  = p_rup.rup12                                      #計價數量*/
      LET g_ogb[l_cnt].ogb65   = NULL                                             #驗退理由碼
      LET g_ogb[l_cnt].ogb1001 = NULL                                             #原因碼
      LET g_ogb[l_cnt].ogb1002 = NULL                                             #訂價代號
      LET g_ogb[l_cnt].ogb1005 = '1'                                              #作業方式
      LET g_ogb[l_cnt].ogb1007 = NULL                                             #現金折扣單號
      LET g_ogb[l_cnt].ogb1008 = NULL                                             #稅別
      LET g_ogb[l_cnt].ogb1009 = NULL                                             #稅率
      LET g_ogb[l_cnt].ogb1010 = NULL                                             #含稅否
      LET g_ogb[l_cnt].ogb1011 = NULL                                             #非直營KAB
      LET g_ogb[l_cnt].ogb1003 = p_ruo.ruo07                                      #預計出貨日期
      LET g_ogb[l_cnt].ogb1004 = NULL                                             #提案代號
      LET g_ogb[l_cnt].ogb1006 = 100                                              #折扣率
      LET g_ogb[l_cnt].ogb1012 = 'N'                                              #搭贈
      LET g_ogb[l_cnt].ogb930  = p_ruo.ruoplant                                   #成本中心 
      LET g_ogb[l_cnt].ogb1013 = 0                                                #已開發票未稅金額 
      LET g_ogb[l_cnt].ogb1014 = NULL                                             #保稅已放行否
      LET g_ogb[l_cnt].ogb41   = NULL                                             #專案代號
      LET g_ogb[l_cnt].ogb42   = NULL                                             #WBS編號 
      LET g_ogb[l_cnt].ogb43   = NULL                                             #活動代號
      LET g_ogb[l_cnt].ogb931  = NULL                                             #包裝編號
      LET g_ogb[l_cnt].ogb932  = NULL                                             #包裝數量
      LET g_ogb[l_cnt].ogbud01 = NULL                                             #自訂欄位-Textedit
      LET g_ogb[l_cnt].ogbud02 = NULL                                             #自訂欄位-文字
      LET g_ogb[l_cnt].ogbud03 = NULL                                             #自訂欄位-文字
      LET g_ogb[l_cnt].ogbud04 = NULL                                             #自訂欄位-文字
      LET g_ogb[l_cnt].ogbud05 = NULL                                             #自訂欄位-文字
      LET g_ogb[l_cnt].ogbud06 = NULL                                             #自訂欄位-文字
      LET g_ogb[l_cnt].ogbud07 = NULL                                             #自訂欄位-數值
      LET g_ogb[l_cnt].ogbud08 = NULL                                             #自訂欄位-數值
      LET g_ogb[l_cnt].ogbud09 = NULL                                             #自訂欄位-數值
      LET g_ogb[l_cnt].ogbud10 = NULL                                             #自訂欄位-整數
      LET g_ogb[l_cnt].ogbud11 = NULL                                             #自訂欄位-整數
      LET g_ogb[l_cnt].ogbud12 = NULL                                             #自訂欄位-整數
      LET g_ogb[l_cnt].ogbud13 = NULL                                             #自訂欄位-日期
      LET g_ogb[l_cnt].ogbud14 = NULL                                             #自訂欄位-日期
      LET g_ogb[l_cnt].ogbud15 = NULL                                             #自訂欄位-日期
      LET g_ogb[l_cnt].ogbplant= p_ruo.ruoplant                                   #所屬工廠
      LET g_ogb[l_cnt].ogblegal= p_ruo.ruolegal                                   #所屬法人
      LET g_ogb[l_cnt].ogb44   = '1'                                              #經營方式
      LET g_ogb[l_cnt].ogb45   = NULL                                             #原扣率
      LET g_ogb[l_cnt].ogb46   = NULL                                             #新扣率
      LET g_ogb[l_cnt].ogb47   = 0                                                #分攤折價=全部折價字段值的和
      
      IF cl_null(g_ogb[l_cnt].ogb50) THEN
        LET g_ogb[l_cnt].ogb50 = 0
      END IF
      IF cl_null(g_ogb[l_cnt].ogb51) THEN
        LET g_ogb[l_cnt].ogb51 = 0
      END IF
      IF cl_null(g_ogb[l_cnt].ogb52) THEN
        LET g_ogb[l_cnt].ogb52 = 0
      END IF
      IF cl_null(g_ogb[l_cnt].ogb53) THEN
        LET g_ogb[l_cnt].ogb53 = 0
      END IF
      IF cl_null(g_ogb[l_cnt].ogb54) THEN
        LET g_ogb[l_cnt].ogb54 = 0
      END IF
      IF cl_null(g_ogb[l_cnt].ogb55) THEN
        LET g_ogb[l_cnt].ogb55 = 0
      END IF
      
      LET l_cnt = l_cnt + 1
   
   END FOREACH
   CALL g_ogb.deleteElement(l_cnt)
   CALL g_rvv.deleteElement(l_cnt)

END FUNCTION

#FUN-C50090
